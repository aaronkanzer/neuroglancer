(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function rx(i,e){const t=i.length;let n=0;for(let s=0;s<t;++s)e(i[s],s,i)&&(i[n]=i[s],++n);i.length=n}function CP(i,e){if(i.length===e)return i;const t=new i.constructor(e);return t.set(i),t}function qp(i,e,t,n){const s=i.length/e,r=i.length*t*n,o=new i.constructor(r),l=i.length*n,c=e,u=e*n;for(let h=0;h<s;++h)for(let g=0;g<e;++g){const v=i[h*e+g],y=h*u+g;for(let b=0;b<t;++b)for(let w=0;w<n;++w)o[b*l+w*c+y]=v}return o}function xP(i,e,t,n=0,s=i.length){for(;n<s;){const r=n+s-1>>1,o=t(e,i[r]);if(o>0)n=r+1;else if(o<0)s=r;else return r}return~n}function EP(i,e,t){let n=e-i;for(;n>0;){const s=Math.floor(n/2),r=i+s;t(r)?n=s:(i=r+1,n-=s+1)}return i}function TP(i,e){const t=[];for(let n=0,s=i.length;n<s;++n)i[n]===e&&t.push(n);return t}function De(i,e){const t=i.length;if(e.length!==t)return!1;for(let n=0;n<t;++n)if(i[n]!==e[n])return!1;return!0}function Kp(i,e,t=(n,s)=>n===s){const n=i.length;if(e.length!==n)return!1;for(let s=0;s<n;++s)if(!t(i[s],e[s]))return!1;return!0}function kP(i,e,t){const n=[];if(t===e){for(let s=0;s<i;++s)n[s]=s;return n}n[t]=e;for(let s=0,r=0;s<i;){if(s===e){++s;continue}r===t&&++r,n[r++]=s++}return n}function G0(i,e,t){for(let n=0,s=t.length;n<s;++n){const r=t[n];r!==-1&&(i[n]=e[r])}return i}function yr(i){const e=[];for(let t=0,n=i.length;t<n;++t){const s=i[t];for(let r=0,o=s.length;r<o;++r){let l=e[r];l===void 0&&(l=e[r]=[]),l.push(s[r])}}return e}function LP(i,e){const t=[];let n=0;for(let r=0,o=e.length;r<o;++r){const{retainCount:l,deleteCount:c,insertCount:u}=e[r];l!==0&&(t.push(i.slice(n,n+l)),n+=l),n+=c,u!==0&&t.push(new Array(u))}const s=i.length;return n!==s&&t.push(i.slice(n)),new Array(0).concat(...t)}function DP(i,e,t){const n=[];let s=0,r=0;const o=i.length,l=e.length;for(;s<o;){let c=0;for(;s<o&&r<l&&t(i[s],e[r]);)++c,++s,++r;c!==0&&n.push({retainCount:c,deleteCount:0,insertCount:0});let u=0;for(;s<o&&(r===l||!t(i[s],e[r]));)++u,++s;u!==0&&n.push({retainCount:0,deleteCount:u,insertCount:0})}return r!==l&&n.push({retainCount:0,deleteCount:0,insertCount:l-r}),n}function IP(i,e,t,n,s,r){let o=0,l=0;if(i!==0&&e!==0)for(;;){const c=t(o,l);if(c<0){if(n(o),++o===i)break}else if(c>0){if(s(l),++l===e)break}else if(r(o,l),++o,++l,o===i||l===e)break}for(;o<i;)n(o),++o;for(;l<e;)s(l),++l}var PP=typeof global=="object"&&global&&global.Object===Object&&global,AP=typeof self=="object"&&self&&self.Object===Object&&self,ox=PP||AP||Function("return this")(),iu=ox.Symbol,ax=Object.prototype,RP=ax.hasOwnProperty,NP=ax.toString,Tl=iu?iu.toStringTag:void 0;function MP(i){var e=RP.call(i,Tl),t=i[Tl];try{i[Tl]=void 0;var n=!0}catch{}var s=NP.call(i);return n&&(e?i[Tl]=t:delete i[Tl]),s}var OP=Object.prototype,_P=OP.toString;function VP(i){return _P.call(i)}var BP="[object Null]",FP="[object Undefined]",$0=iu?iu.toStringTag:void 0;function UP(i){return i==null?i===void 0?FP:BP:$0&&$0 in Object(i)?MP(i):VP(i)}function zP(i){return i!=null&&typeof i=="object"}var GP="[object Symbol]";function $P(i){return typeof i=="symbol"||zP(i)&&UP(i)==GP}var WP=/\s/;function HP(i){for(var e=i.length;e--&&WP.test(i.charAt(e)););return e}var JP=/^\s+/;function jP(i){return i&&i.slice(0,HP(i)+1).replace(JP,"")}function su(i){var e=typeof i;return i!=null&&(e=="object"||e=="function")}var W0=NaN,YP=/^[-+]0x[0-9a-f]+$/i,qP=/^0b[01]+$/i,KP=/^0o[0-7]+$/i,XP=parseInt;function H0(i){if(typeof i=="number")return i;if($P(i))return W0;if(su(i)){var e=typeof i.valueOf=="function"?i.valueOf():i;i=su(e)?e+"":e}if(typeof i!="string")return i===0?i:+i;i=jP(i);var t=qP.test(i);return t||KP.test(i)?XP(i.slice(2),t?2:8):YP.test(i)?W0:+i}var rp=function(){return ox.Date.now()},QP="Expected a function",ZP=Math.max,eA=Math.min;function ze(i,e,t){var n,s,r,o,l,c,u=0,h=!1,g=!1,v=!0;if(typeof i!="function")throw new TypeError(QP);e=H0(e)||0,su(t)&&(h=!!t.leading,g="maxWait"in t,r=g?ZP(H0(t.maxWait)||0,e):r,v="trailing"in t?!!t.trailing:v);function y(I){var P=n,O=s;return n=s=void 0,u=I,o=i.apply(O,P),o}function b(I){return u=I,l=setTimeout(E,e),h?y(I):o}function w(I){var P=I-c,O=I-u,_=e-P;return g?eA(_,r-O):_}function C(I){var P=I-c,O=I-u;return c===void 0||P>=e||P<0||g&&O>=r}function E(){var I=rp();if(C(I))return k(I);l=setTimeout(E,w(I))}function k(I){return l=void 0,v&&n?y(I):(n=s=void 0,o)}function D(){l!==void 0&&clearTimeout(l),u=0,n=c=s=l=void 0}function A(){return l===void 0?o:k(rp())}function N(){var I=rp(),P=C(I);if(n=arguments,s=this,c=I,P){if(l===void 0)return b(c);if(g)return clearTimeout(l),l=setTimeout(E,e),y(c)}return l===void 0&&(l=setTimeout(E,e)),o}return N.cancel=D,N.flush=A,N}var tA="Expected a function";function oh(i,e,t){var n=!0,s=!0;if(typeof i!="function")throw new TypeError(tA);return su(t)&&(n="leading"in t?!!t.leading:n,s="trailing"in t?!!t.trailing:s),ze(i,e,{leading:n,maxWait:e,trailing:s})}function lx(i){typeof i=="object"?i.dispose():i()}function la(i){for(let e=i.length;e>0;--e)lx(i[e-1])}function ti(i,e,t,n){return i.addEventListener(e,t,n),()=>i.removeEventListener(e,t,n)}class K{constructor(){this.refCount=1}addRef(){return++this.refCount,this}dispose(){--this.refCount===0&&this.refCountReachedZero()}refCountReachedZero(){this.disposed();const{disposers:e}=this;e!==void 0&&(la(e),this.disposers=void 0),this.wasDisposed=!0}disposed(){}registerDisposer(e){const{disposers:t}=this;return t==null?this.disposers=[e]:t.push(e),e}unregisterDisposer(e){const{disposers:t}=this;if(t!=null){const n=t.indexOf(e);n!==-1&&t.splice(n,1)}return e}registerEventListener(e,t,n,s){this.registerDisposer(ti(e,t,n,s))}registerCancellable(e){return this.registerDisposer(()=>{e.cancel()}),e}}class cx extends K{constructor(e){super(),this.value=e}}function dx(i){return()=>{if(i!==void 0){const e=i;i=void 0,lx(e)}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ze{constructor(){this.handlers=new Set,this.count=0;const e=this;this.dispatch=function(){++e.count,e.handlers.forEach(t=>{t.apply(this,arguments)})}}add(e){return this.handlers.add(e),()=>this.remove(e)}remove(e){return this.handlers.delete(e)}dispose(){this.handlers=void 0}}class ue extends Ze{}const ux={count:0,add(i){return()=>{}},remove(i){return!1}};class Ne{constructor(e){this.value_=e,this.changed=new ue}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}}class bt extends Ne{constructor(e,t,n=e){super(e),this.validator=t,this.defaultValue=n}toJSON(){const{value_:e}=this;if(e!==this.defaultValue)return this.value_}reset(){this.value=this.defaultValue}restoreState(e){if(e!==void 0){const{validator:t}=this;try{this.value=t(e);return}catch{}}this.value=this.defaultValue}}class hx extends K{constructor(e,t){super(),this.changed=new ue,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){return this.f(...this.ws.map(e=>e.value))}}function J0(i,...e){return new hx(i,e)}class nA extends K{constructor(e,t){super(),this.changed=new ue,this.valueGeneration=-1,this.f=e,this.ws=t;for(const n of t)this.registerDisposer(n.changed.add(this.changed.dispatch))}get value(){const e=this.changed.count;return e!==this.valueGeneration&&(this.value_=this.f(...this.ws.map(t=>t.value)),this.valueGeneration=e),this.value_}}function ni(i,...e){return new nA(i,e)}class fx extends K{constructor(e,t=(n,s)=>n===s){super(),this.changed=new Ze,this.value=e.value,this.registerDisposer(e.changed.add(()=>{const n=e.value;t(this.value,n)||(this.value=n,this.changed.dispatch())}))}}function Ht(i,e,t){const n=new hx(i,e),s=new fx(n,t);return s.registerDisposer(n),s}class px extends K{constructor(e){super(),this.changed=new ue;const t=e(this),n=Object.keys(t),s=()=>{const r=Array.isArray(t)?[]:{};for(const o of n)r[o]=t[o].value;this.value=r,this.changed.dispatch()};s();for(const r of n){const o=t[r];this.registerDisposer(o.changed.add(()=>s()))}}}class Xp{constructor(e){this.changed=new Ze,e===void 0?this.values=new Set:this.values=new Set(e)}add(e){const{values:t}=this;return t.has(e)||(t.add(e),this.changed.dispatch(e,!0)),this}delete(e){const{values:t}=this;return t.delete(e)?(this.changed.dispatch(e,!1),!0):!1}has(e){return this.values.has(e)}get size(){return this.values.size}[Symbol.iterator](){return this.values[Symbol.iterator]()}clear(){const{values:e}=this;e.size>0&&(e.clear(),this.changed.dispatch(null,!1))}}function Ti(i,...e){const t=e.map(c=>c.value),n=e.length;let s=new K,r=i(s,...t);const o=ze(()=>{let c=!1;for(let u=0;u<n;++u){const g=e[u].value;t[u]!==g&&(t[u]=g,c=!0)}c&&(s.dispose(),s=new K,r=i(s,...t))},0),l=e.map(c=>c.changed.add(o));return{flush(){o.flush()},dispose(){o.cancel(),la(l),s.dispose()},get value(){return o.flush(),r}}}function ca(i,...e){const t=e.map(c=>c.value),n=e.length;let s=new K,r=i(s,...t);const o=()=>{let c=!1;for(let u=0;u<n;++u){const g=e[u].value;t[u]!==g&&(t[u]=g,c=!0)}c&&(s.dispose(),s=new K,r=i(s,...t))},l=e.map(c=>c.changed.add(o));return{dispose(){la(l),s.dispose()},get value(){return r}}}function ar(i){return{changed:ux,value:i}}function ys(i,e){return i(e.value),e.changed.add(()=>i(e.value))}class Hd{constructor(e,t){this.outer=e,this.getInner=t,this.changed=new ue,this.update=()=>{const{disposer:n,outer:s}=this;n!==void 0&&n();const r=this.inner=this.getInner(s.value);this.disposer=r.changed.add(this.changed.dispatch),this.changed.dispatch()},e.changed.add(this.update),this.update()}dispose(){this.outer.changed.remove(this.update),this.disposer()}get value(){return this.inner.value}set value(e){this.inner.value=e}}class Wo extends Hd{reset(){this.inner.reset()}restoreState(e){this.inner.restoreState(e)}toJSON(){return this.inner.toJSON()}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pd=new Float32Array(1);function iA(i){Pd[0]=i,i=Pd[0];for(let e=1;e<21;++e){const t=i.toPrecision(e);if(Pd[0]=parseFloat(t),Pd[0]===i)return t}return i.toString()}var Jd=1e-6,en=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,e=arguments.length;e--;)i+=arguments[e]*arguments[e];return Math.sqrt(i)});function Dc(){var i=new en(9);return en!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[5]=0,i[6]=0,i[7]=0),i[0]=1,i[4]=1,i[8]=1,i}function sA(i,e){if(i===e){var t=e[1],n=e[2],s=e[5];i[1]=e[3],i[2]=e[6],i[3]=t,i[5]=e[7],i[6]=n,i[7]=s}else i[0]=e[0],i[1]=e[3],i[2]=e[6],i[3]=e[1],i[4]=e[4],i[5]=e[7],i[6]=e[2],i[7]=e[5],i[8]=e[8];return i}function rA(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=h*o-l*u,v=-h*r+l*c,y=u*r-o*c,b=t*g+n*v+s*y;return b?(b=1/b,i[0]=g*b,i[1]=(-h*n+s*u)*b,i[2]=(l*n-s*o)*b,i[3]=v*b,i[4]=(h*t-s*c)*b,i[5]=(-l*t+s*r)*b,i[6]=y*b,i[7]=(-u*t+n*c)*b,i[8]=(o*t-n*r)*b,i):null}function zm(i){var e=i[0],t=i[1],n=i[2],s=i[3],r=i[4],o=i[5],l=i[6],c=i[7],u=i[8];return e*(u*r-o*c)+t*(-u*s+o*l)+n*(c*s-r*l)}function gx(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=t+t,l=n+n,c=s+s,u=t*o,h=n*o,g=n*l,v=s*o,y=s*l,b=s*c,w=r*o,C=r*l,E=r*c;return i[0]=1-g-b,i[3]=h-E,i[6]=v+C,i[1]=h+E,i[4]=1-u-b,i[7]=y-w,i[2]=v-C,i[5]=y+w,i[8]=1-u-g,i}function Ve(){var i=new en(16);return en!=Float32Array&&(i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0),i[0]=1,i[5]=1,i[10]=1,i[15]=1,i}function oA(i){var e=new en(16);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],e}function ru(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function mx(i){return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function Gm(i,e){if(i===e){var t=e[1],n=e[2],s=e[3],r=e[6],o=e[7],l=e[11];i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=t,i[6]=e[9],i[7]=e[13],i[8]=n,i[9]=r,i[11]=e[14],i[12]=s,i[13]=o,i[14]=l}else i[0]=e[0],i[1]=e[4],i[2]=e[8],i[3]=e[12],i[4]=e[1],i[5]=e[5],i[6]=e[9],i[7]=e[13],i[8]=e[2],i[9]=e[6],i[10]=e[10],i[11]=e[14],i[12]=e[3],i[13]=e[7],i[14]=e[11],i[15]=e[15];return i}function ur(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],b=e[12],w=e[13],C=e[14],E=e[15],k=t*l-n*o,D=t*c-s*o,A=t*u-r*o,N=n*c-s*l,I=n*u-r*l,P=s*u-r*c,O=h*w-g*b,_=h*C-v*b,W=h*E-y*b,U=g*C-v*w,j=g*E-y*w,B=v*E-y*C,H=k*B-D*j+A*U+N*W-I*_+P*O;return H?(H=1/H,i[0]=(l*B-c*j+u*U)*H,i[1]=(s*j-n*B-r*U)*H,i[2]=(w*P-C*I+E*N)*H,i[3]=(v*I-g*P-y*N)*H,i[4]=(c*W-o*B-u*_)*H,i[5]=(t*B-s*W+r*_)*H,i[6]=(C*A-b*P-E*D)*H,i[7]=(h*P-v*A+y*D)*H,i[8]=(o*j-l*W+u*O)*H,i[9]=(n*W-t*j-r*O)*H,i[10]=(b*I-w*A+E*k)*H,i[11]=(g*A-h*I-y*k)*H,i[12]=(l*_-o*U-c*O)*H,i[13]=(t*U-n*_+s*O)*H,i[14]=(w*D-b*N-C*k)*H,i[15]=(h*N-g*D+v*k)*H,i):null}function zt(i,e,t){var n=e[0],s=e[1],r=e[2],o=e[3],l=e[4],c=e[5],u=e[6],h=e[7],g=e[8],v=e[9],y=e[10],b=e[11],w=e[12],C=e[13],E=e[14],k=e[15],D=t[0],A=t[1],N=t[2],I=t[3];return i[0]=D*n+A*l+N*g+I*w,i[1]=D*s+A*c+N*v+I*C,i[2]=D*r+A*u+N*y+I*E,i[3]=D*o+A*h+N*b+I*k,D=t[4],A=t[5],N=t[6],I=t[7],i[4]=D*n+A*l+N*g+I*w,i[5]=D*s+A*c+N*v+I*C,i[6]=D*r+A*u+N*y+I*E,i[7]=D*o+A*h+N*b+I*k,D=t[8],A=t[9],N=t[10],I=t[11],i[8]=D*n+A*l+N*g+I*w,i[9]=D*s+A*c+N*v+I*C,i[10]=D*r+A*u+N*y+I*E,i[11]=D*o+A*h+N*b+I*k,D=t[12],A=t[13],N=t[14],I=t[15],i[12]=D*n+A*l+N*g+I*w,i[13]=D*s+A*c+N*v+I*C,i[14]=D*r+A*u+N*y+I*E,i[15]=D*o+A*h+N*b+I*k,i}function aA(i,e,t){var n=t[0],s=t[1],r=t[2],o,l,c,u,h,g,v,y,b,w,C,E;return e===i?(i[12]=e[0]*n+e[4]*s+e[8]*r+e[12],i[13]=e[1]*n+e[5]*s+e[9]*r+e[13],i[14]=e[2]*n+e[6]*s+e[10]*r+e[14],i[15]=e[3]*n+e[7]*s+e[11]*r+e[15]):(o=e[0],l=e[1],c=e[2],u=e[3],h=e[4],g=e[5],v=e[6],y=e[7],b=e[8],w=e[9],C=e[10],E=e[11],i[0]=o,i[1]=l,i[2]=c,i[3]=u,i[4]=h,i[5]=g,i[6]=v,i[7]=y,i[8]=b,i[9]=w,i[10]=C,i[11]=E,i[12]=o*n+h*s+b*r+e[12],i[13]=l*n+g*s+w*r+e[13],i[14]=c*n+v*s+C*r+e[14],i[15]=u*n+y*s+E*r+e[15]),i}function lA(i,e,t){var n=t[0],s=t[1],r=t[2];return i[0]=e[0]*n,i[1]=e[1]*n,i[2]=e[2]*n,i[3]=e[3]*n,i[4]=e[4]*s,i[5]=e[5]*s,i[6]=e[6]*s,i[7]=e[7]*s,i[8]=e[8]*r,i[9]=e[9]*r,i[10]=e[10]*r,i[11]=e[11]*r,i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15],i}function cA(i,e,t,n){var s=e[0],r=e[1],o=e[2],l=e[3],c=s+s,u=r+r,h=o+o,g=s*c,v=s*u,y=s*h,b=r*u,w=r*h,C=o*h,E=l*c,k=l*u,D=l*h,A=n[0],N=n[1],I=n[2];return i[0]=(1-(b+C))*A,i[1]=(v+D)*A,i[2]=(y-k)*A,i[3]=0,i[4]=(v-D)*N,i[5]=(1-(g+C))*N,i[6]=(w+E)*N,i[7]=0,i[8]=(y+k)*I,i[9]=(w-E)*I,i[10]=(1-(g+b))*I,i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}function dA(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=t+t,l=n+n,c=s+s,u=t*o,h=n*o,g=n*l,v=s*o,y=s*l,b=s*c,w=r*o,C=r*l,E=r*c;return i[0]=1-g-b,i[1]=h+E,i[2]=v-C,i[3]=0,i[4]=h-E,i[5]=1-u-b,i[6]=y+w,i[7]=0,i[8]=v+C,i[9]=y-w,i[10]=1-u-g,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function uA(i,e,t,n,s){var r=1/Math.tan(e/2),o;return i[0]=r/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=r,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,s!=null&&s!==1/0?(o=1/(n-s),i[10]=(s+n)*o,i[14]=2*s*n*o):(i[10]=-1,i[14]=-2*n),i}function vx(i,e,t,n,s,r,o){var l=1/(e-t),c=1/(n-s),u=1/(r-o);return i[0]=-2*l,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-2*c,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=2*u,i[11]=0,i[12]=(e+t)*l,i[13]=(s+n)*c,i[14]=(o+r)*u,i[15]=1,i}function we(){var i=new en(3);return en!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i}function Qp(i){var e=new en(3);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e}function hA(i){var e=i[0],t=i[1],n=i[2];return Math.hypot(e,t,n)}function Et(i,e,t){var n=new en(3);return n[0]=i,n[1]=e,n[2]=t,n}function fA(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i}function Zp(i,e,t,n){return i[0]=e,i[1]=t,i[2]=n,i}function pA(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i}function gA(i,e,t){return i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i}function mA(i,e,t){return i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i}function vA(i,e,t){return i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i}function ah(i,e,t){return i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i}function ou(i,e){var t=e[0],n=e[1],s=e[2],r=t*t+n*n+s*s;return r>0&&(r=1/Math.sqrt(r)),i[0]=e[0]*r,i[1]=e[1]*r,i[2]=e[2]*r,i}function $m(i,e){return i[0]*e[0]+i[1]*e[1]+i[2]*e[2]}function op(i,e,t){var n=e[0],s=e[1],r=e[2],o=t[0],l=t[1],c=t[2];return i[0]=s*c-r*l,i[1]=r*o-n*c,i[2]=n*l-s*o,i}function qn(i,e,t){var n=e[0],s=e[1],r=e[2],o=t[3]*n+t[7]*s+t[11]*r+t[15];return o=o||1,i[0]=(t[0]*n+t[4]*s+t[8]*r+t[12])/o,i[1]=(t[1]*n+t[5]*s+t[9]*r+t[13])/o,i[2]=(t[2]*n+t[6]*s+t[10]*r+t[14])/o,i}function ta(i,e,t){var n=t[0],s=t[1],r=t[2],o=t[3],l=e[0],c=e[1],u=e[2],h=s*u-r*c,g=r*l-n*u,v=n*c-s*l,y=s*v-r*g,b=r*h-n*v,w=n*g-s*h,C=o*2;return h*=C,g*=C,v*=C,y*=2,b*=2,w*=2,i[0]=l+h+y,i[1]=c+g+b,i[2]=u+v+w,i}function eg(i,e){var t=i[0],n=i[1],s=i[2],r=e[0],o=e[1],l=e[2];return Math.abs(t-r)<=Jd*Math.max(1,Math.abs(t),Math.abs(r))&&Math.abs(n-o)<=Jd*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-l)<=Jd*Math.max(1,Math.abs(s),Math.abs(l))}var yA=hA;(function(){var i=we();return function(e,t,n,s,r,o){var l,c;for(t||(t=3),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],r(i,i,o),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2];return e}})();function lh(){var i=new en(4);return en!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0,i[3]=0),i}function SA(i){var e=new en(4);return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e}function so(i,e,t,n){var s=new en(4);return s[0]=i,s[1]=e,s[2]=t,s[3]=n,s}function bA(i,e){return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i}function wA(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=t*t+n*n+s*s+r*r;return o>0&&(o=1/Math.sqrt(o)),i[0]=t*o,i[1]=n*o,i[2]=s*o,i[3]=r*o,i}(function(){var i=lh();return function(e,t,n,s,r,o){var l,c;for(t||(t=4),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],i[2]=e[l+2],i[3]=e[l+3],r(i,i,o),e[l]=i[0],e[l+1]=i[1],e[l+2]=i[2],e[l+3]=i[3];return e}})();function Cn(){var i=new en(4);return en!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0),i[3]=1,i}function j0(i){return i[0]=0,i[1]=0,i[2]=0,i[3]=1,i}function tg(i,e,t){t=t*.5;var n=Math.sin(t);return i[0]=n*e[0],i[1]=n*e[1],i[2]=n*e[2],i[3]=Math.cos(t),i}function lr(i,e,t){var n=e[0],s=e[1],r=e[2],o=e[3],l=t[0],c=t[1],u=t[2],h=t[3];return i[0]=n*h+o*l+s*u-r*c,i[1]=s*h+o*c+r*l-n*u,i[2]=r*h+o*u+n*c-s*l,i[3]=o*h-n*l-s*c-r*u,i}function CA(i,e,t){t*=.5;var n=e[0],s=e[1],r=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return i[0]=n*c+o*l,i[1]=s*c+r*l,i[2]=r*c-s*l,i[3]=o*c-n*l,i}function xA(i,e,t){t*=.5;var n=e[0],s=e[1],r=e[2],o=e[3],l=Math.sin(t),c=Math.cos(t);return i[0]=n*c-r*l,i[1]=s*c+o*l,i[2]=r*c+n*l,i[3]=o*c-s*l,i}function ap(i,e,t,n){var s=e[0],r=e[1],o=e[2],l=e[3],c=t[0],u=t[1],h=t[2],g=t[3],v,y,b,w,C;return y=s*c+r*u+o*h+l*g,y<0&&(y=-y,c=-c,u=-u,h=-h,g=-g),1-y>Jd?(v=Math.acos(y),b=Math.sin(v),w=Math.sin((1-n)*v)/b,C=Math.sin(n*v)/b):(w=1-n,C=n),i[0]=w*s+C*c,i[1]=w*r+C*u,i[2]=w*o+C*h,i[3]=w*l+C*g,i}function au(i,e){var t=e[0],n=e[1],s=e[2],r=e[3],o=t*t+n*n+s*s+r*r,l=o?1/o:0;return i[0]=-t*l,i[1]=-n*l,i[2]=-s*l,i[3]=r*l,i}function yx(i,e){var t=e[0]+e[4]+e[8],n;if(t>0)n=Math.sqrt(t+1),i[3]=.5*n,n=.5/n,i[0]=(e[5]-e[7])*n,i[1]=(e[6]-e[2])*n,i[2]=(e[1]-e[3])*n;else{var s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);var r=(s+1)%3,o=(s+2)%3;n=Math.sqrt(e[s*3+s]-e[r*3+r]-e[o*3+o]+1),i[s]=.5*n,n=.5/n,i[3]=(e[r*3+o]-e[o*3+r])*n,i[r]=(e[r*3+s]+e[s*3+r])*n,i[o]=(e[o*3+s]+e[s*3+o])*n}return i}var EA=bA,Wl=wA;(function(){var i=we(),e=Et(1,0,0),t=Et(0,1,0);return function(n,s,r){var o=$m(s,r);return o<-.999999?(op(i,e,s),yA(i)<1e-6&&op(i,t,s),ou(i,i),tg(n,i,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(op(i,s,r),n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=1+o,Wl(n,n))}})();(function(){var i=Cn(),e=Cn();return function(t,n,s,r,o,l){return ap(i,n,o,l),ap(e,s,r,l),ap(t,i,e,2*l*(1-l)),t}})();(function(){var i=Dc();return function(e,t,n,s){return i[0]=n[0],i[3]=n[1],i[6]=n[2],i[1]=s[0],i[4]=s[1],i[7]=s[2],i[2]=-t[0],i[5]=-t[1],i[8]=-t[2],Wl(e,yx(e,i))}})();function Wm(){var i=new en(2);return en!=Float32Array&&(i[0]=0,i[1]=0),i}function TA(i,e,t){return i[0]=e,i[1]=t,i}function kA(i,e,t){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i}(function(){var i=Wm();return function(e,t,n,s,r,o){var l,c;for(t||(t=2),n||(n=0),s?c=Math.min(s*t+n,e.length):c=e.length,l=n;l<c;l+=t)i[0]=e[l],i[1]=e[l+1],r(i,i,o),e[l]=i[0],e[l+1]=i[1];return e}})();const Sx=Ve(),LA=["x","y","z"],Ui=[Et(1,0,0),Et(0,1,0),Et(0,0,1)];Et(0,0,0);const ng=so(0,0,0,0),bx=Et(1,1,1);Et(1/0,1/0,1/0);Cn();function ig(i){return i[0]*i[1]*i[2]}function sg(i){return`${i[0]},${i[1]},${i[2]}`}function DA(i,e,t){const n=e[0],s=e[1],r=e[2];return i[0]=t[0]*n+t[4]*s+t[8]*r,i[1]=t[1]*n+t[5]*s+t[9]*r,i[2]=t[2]*n+t[6]*s+t[10]*r,i}function wx(i,e,t){const n=e[0],s=e[1],r=e[2];return i[0]=t[0]*n+t[1]*s+t[2]*r,i[1]=t[4]*n+t[5]*s+t[6]*r,i[2]=t[8]*n+t[9]*s+t[10]*r,i}function IA(i,e,t){const n=t.length;let s=0;for(let o=0;o<n;++o)s+=(i[o]-e[o])**2;let r=0;for(let o=0;o<n;++o){const l=i[o];r-=(l-t[o])*(e[o]-l)}return r/Math.max(s,1e-6)}function PA(i,e,t,n){const s=i.length;let r=IA(e,t,n);r=Math.max(0,Math.min(1,r));for(let o=0;o<s;++o){const l=e[o];i[o]=l+r*(t[o]-l)}return i}function ch(i,e){const t=e[0],n=e[1],s=e[2],r=e[4],o=e[5],l=e[6],c=e[8],u=e[9],h=e[10];return i[0]=t,i[1]=n,i[2]=s,i[3]=r,i[4]=o,i[5]=l,i[6]=c,i[7]=u,i[8]=h,i}function lu(i,e){const t=e[0],n=e[1],s=e[2],r=e[3],o=e[4],l=e[5],c=e[6],u=e[7],h=e[8],g=e[9],v=e[10],y=e[11],b=e[12],w=e[13],C=e[14],E=e[15];i[0]=r+t,i[1]=u+o,i[2]=y+h,i[3]=E+b,i[4]=r-t,i[5]=u-o,i[6]=y-h,i[7]=E-b,i[8]=r+n,i[9]=u+l,i[10]=y+g,i[11]=E+w,i[12]=r-n,i[13]=u-l,i[14]=y-g,i[15]=E-w;const k=r+s,D=u+c,A=y+v,N=E+C,I=r-s,P=u-c,O=y-v,_=E-C,W=Math.sqrt(k**2+D**2+A**2);i[16]=k/W,i[17]=D/W,i[18]=A/W,i[19]=N/W;const U=Math.sqrt(I**2+P**2+O**2);return i[20]=I/U,i[21]=P/U,i[22]=O/U,i[23]=_/U,i}function Cx(i,e,t,n,s,r,o){for(let l=0;l<6;++l){const c=o[l*4],u=o[l*4+1],h=o[l*4+2],g=o[l*4+3];if(Math.max(c*i,c*n)+Math.max(u*e,u*s)+Math.max(h*t,h*r)+g<0)return!1}return!0}function AA(i,e,t,n,s,r,o){for(let l=0;l<4;++l){const c=o[l*4],u=o[l*4+1],h=o[l*4+2],g=o[l*4+3];if(Math.max(c*i,c*n)+Math.max(u*e,u*s)+Math.max(h*t,h*r)+g<0)return!1}{const c=o[20],u=o[5*4+1],h=o[5*4+2],g=o[5*4+3],v=Math.max(c*i,c*n)+Math.max(u*e,u*s)+Math.max(h*t,h*r),y=Math.min(c*i,c*n)+Math.min(u*e,u*s)+Math.min(h*t,h*r),b=Math.abs(g)*1e-6;if(y>-g+b||v<-g-b)return!1}return!0}function dh(i,e,t,n=!1){const s=t.length,r=[],o=n?1:e+1,l=n?e+1:1;for(let c=0;c<s;++c){const u=t[c];for(let h=0;h<e;++h)i[h*o+u*l]!==0&&(r[h]=!0)}return TP(r,!0)}function xx(i,e,t){for(let n=0;n<3;++n){const s=t[n];for(let r=0;r<3;++r)i[n+r*3]=s*e[n+r*3]}return i}function RA(i){if(i[15]===1){const o=2/Math.abs(i[10]),l=2/Math.abs(i[0]),c=2/Math.abs(i[5]);return l*c*o}const e=i[10],n=2*i[14]/(2*e-2),s=(e-1)*n/(e+1);return 4/(i[0]*i[5])/3*(Math.abs(s)**3-Math.abs(n)**3)}function Ex(i){if(i[15]===1)return 2/Math.abs(i[10]);const e=i[10],n=2*i[14]/(2*e-2),s=(e-1)*n/(e+1);return Math.abs(s-n)}function NA(i){return i[2]=0,i[6]=0,i[10]=0,i[14]=0,i}const Ho=we();function MA(i,e){e[0]=e[1]=e[2]=Number.POSITIVE_INFINITY,e[3]=e[4]=e[5]=Number.NEGATIVE_INFINITY;for(let t=0;t<8;++t){Ho[0]=2*(t&1)-1,Ho[1]=2*(t>>>1&1)-1,Ho[2]=2*(t>>>2&1)-1,qn(Ho,Ho,i);for(let n=0;n<3;++n){const s=Ho[n];e[n]=Math.min(e[n],s),e[n+3]=Math.max(e[n+3],s)}}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Tx(i){return("0"+i.toString(16)).slice(-2)}function OA(i){return Array.prototype.map.call(i,Tx).join("")}function _A(i){if(!/^(?:[0-9a-fA-F]{2})*$/.test(i))throw new Error("Invalid hex-encoded string");const e=i.length/2,t=new Uint8Array(e);for(let n=0;n<e;++n)t[n]=parseInt(i.substr(n*2,2),16);return t}function VA(i){const e=/^rgba\(([0-9]+), ([0-9]+), ([0-9]+), (0(?:\.[0-9]+)?)\)$/;{const n=i.match(e);if(n!==null)return[parseInt(n[1],10),parseInt(n[2],10),parseInt(n[3],10),parseFloat(n[4])]}const t=/^#([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/;{const n=i.match(t);if(n!==null)return[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16),1]}throw new Error(`Invalid serialized color: ${JSON.stringify(i)}.`)}function kx(i){try{if(typeof i!="string")throw new Error(`Expected string, but received ${JSON.stringify(i)}.`);const e=document.createElement("canvas").getContext("2d");e.fillStyle=i;const t=VA(e.fillStyle);return so(t[0]/255,t[1]/255,t[2]/255,t[3])}catch(e){throw new Error(`Failed to parse color specification: ${e.message}`)}}function Ra(i){return kx(i).subarray(0,3)}function da(i){const e=i[3]===void 0?3:4;let t=0;for(let n=0;n<e;n++)t=(t<<8>>>0)+Math.min(255,Math.max(0,Math.round(i[e-1-n]*255)));return t}function na(i){return Et((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255)}function Hm(i){return so((i>>>0&255)/255,(i>>>8&255)/255,(i>>>16&255)/255,(i>>>24&255)/255)}function Pn(i){if(i[3]===void 0||i[3]===1){let t="#";for(let n=0;n<3;++n)t+=Tx(Math.min(255,Math.max(0,Math.round(i[n]*255))));return t}let e="rgba(";for(let t=0;t<3;++t)t!==0&&(e+=", "),e+=Math.min(255,Math.max(0,Math.round(i[t]*255)));return e+=`, ${iA(i[3])})`,e}function lp(i){return i<=.03928?i/12.92:((i+.055)/1.055)**2.4}function BA(i){const[e,t,n]=i;return .2126*lp(e)+.7152*lp(t)+.0722*lp(n)}function rg(i){return BA(i)<=.179}class cu extends Ne{constructor(e){super(Qp(e)),this.defaultValue=e}toString(){return Pn(this.value)}toJSON(){if(!eg(this.value,this.defaultValue))return Pn(this.value)}reset(){this.value=Qp(this.defaultValue)}restoreState(e){if(e===void 0){this.reset();return}const{value:t}=this,n=Ra(e);eg(t,n)||(this.value=n)}}class FA extends Ne{constructor(){super(void 0)}toJSON(){const{value:e}=this;if(e!==void 0)return Pn(e)}reset(){this.value=void 0}restoreState(e){if(e===void 0){this.reset();return}const{value:t}=this,n=Ra(e);(t===void 0||!eg(t,n))&&(this.value=n)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var J=(i=>(i[i.UINT8=0]="UINT8",i[i.INT8=1]="INT8",i[i.UINT16=2]="UINT16",i[i.INT16=3]="INT16",i[i.UINT32=4]="UINT32",i[i.INT32=5]="INT32",i[i.UINT64=6]="UINT64",i[i.FLOAT32=7]="FLOAT32",i))(J||{});const Jm={0:!1,1:!0,2:!1,3:!0,4:!1,5:!0,6:!1,7:void 0},Hl={0:1,1:1,2:2,3:2,4:4,5:4,6:8,7:4},Lx={0:Uint8Array,1:Int8Array,2:Uint16Array,3:Int16Array,4:Uint32Array,5:Int32Array,6:Uint32Array,7:Float32Array},UA={0:1,1:1,2:1,3:1,4:1,5:1,6:2,7:1};/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var _n=(i=>(i[i.LITTLE=0]="LITTLE",i[i.BIG=1]="BIG",i))(_n||{});function zA(){const i=Uint16Array.of(4386);return new Uint8Array(i.buffer)[0]===17?1:0}const Na=zA();function xn(i){const e=typeof i;if(e==="number"||e==="string"){const t=parseFloat(""+i);if(!Number.isNaN(t))return t}throw new Error(`Expected floating-point number, but received: ${JSON.stringify(i)}.`)}function Xe(i){const e=xn(i);if(Number.isFinite(e))return e;throw new Error(`Expected finite floating-point number, but received: ${e}.`)}function Dx(i){const e=xn(i);if(Number.isFinite(e)&&e>=0)return e;throw new Error(`Expected finite non-negative floating-point number, but received: ${e}.`)}function wt(i){const e=Xe(i);if(e>0)return e;throw new Error(`Expected positive finite floating-point number, but received: ${e}.`)}function GA(i,e){return t=>{const n=xn(t);if(n>=i&&n<=e)return n;throw new Error(`Expected floating-point number in range [${i}, ${e}], but received: ${n}.`)}}function du(i,e,t=xn){ee(e),i[0]=i[1]=i[2]=0;for(const n of Object.keys(e))switch(n){case"x":i[0]=t(e[n]);break;case"y":i[1]=t(e[n]);break;case"z":i[2]=t(e[n]);break;default:throw new Error(`Expected object to have keys ['x', 'y', 'z'], but received: ${JSON.stringify(e)}.`)}return i}function jd(i,e){const t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes");for(let n=0;n<t;++n)if(!Number.isFinite(parseFloat(e[n])))throw new Error("Non-finite value.");for(let n=0;n<t;++n)i[n]=parseFloat(e[n]);return i}function Y0(i,e){const t=i.length;if(!Array.isArray(e)||e.length!==t)throw new Error("Incompatible sizes.");for(let n=0;n<t;++n){const s=parseInt(e[n],void 0);if(!Number.isInteger(s))throw new Error("Non-integer value.")}for(let n=0;n<t;++n)i[n]=parseInt(e[n],void 0);return i}function Qn(i){if(typeof i=="object"){if(i===null)return"null";if(Array.isArray(i)){let r="[";const o=i.length;let l=0;if(l<o)for(r+=Qn(i[l]);++l<o;)r+=",",r+=Qn(i[l]);return r+="]",r}let e="{";const t=Object.keys(i).sort();let n=0;const s=t.length;if(n<s){let r=t[n];for(e+=JSON.stringify(r),e+=":",e+=Qn(i[r]);++n<s;)e+=",",r=t[n],e+=JSON.stringify(r),e+=":",e+=Qn(i[r])}return e+="}",e}return JSON.stringify(i)}const Ix=/('(?:[^'\\]|(?:\\.))*')/,Px=/("(?:[^"\\]|(?:\\.))*")/,$A=new RegExp(`${Ix.source}|${Px.source}`),WA=new RegExp(`${Px.source}|${Ix.source}`),HA=/^((?:[^"'\\]|(?:\\[^']))*)("|\\')/,JA=/^((?:[^"'\\]|(?:\\.))*)'/;function jA(i,e,t,n){if(i.length>=2&&i.charAt(0)===e&&i.charAt(i.length-1)===e){let s=i.substr(1,i.length-2),r=t;for(;s.length>0;){const o=s.match(n);if(o===null){r+=s;break}r+=o[1],o[2]===t?(r+="\\",r+=t):r+=e,s=s.substr(o.index+o[0].length)}return r+=t,r}return i}function YA(i,e,t){const n=/[&_,]/g;let s,r,o;t==='"'?(s="'",r=HA,o=$A):(s='"',r=JA,o=WA);let l="";for(;i.length>0;){const c=i.match(o);let u,h;if(c===null)u=i,i="",h="";else{u=i.substr(0,c.index),i=i.substr(c.index+c[0].length);const g=c[1];g!==void 0?h=jA(g,s,t,r):h=c[2]}l+=u.replace(n,e),l+=h}return l}function qA(i){return YA(i,",",'"')}function og(i){return JSON.parse(qA(i))}function Gi(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${JSON.stringify(i)}.`);if(e!==void 0&&i.length!==e)throw new Error(`Expected array of length ${e}, but received: ${JSON.stringify(i)}.`);return i}function Ee(i,e){if(!Array.isArray(i))throw new Error(`Expected array, but received: ${JSON.stringify(i)}.`);return i.map(e)}function _e(i,e,t){const n=i.length;if(!Array.isArray(e)||e.length!==n)throw new Error(`Expected length ${n} array, but received: ${JSON.stringify(e)}.`);for(let s=0;s<n;++s)i[s]=t(e[s],s);return i}function ee(i){if(typeof i!="object"||i==null||Array.isArray(i))throw new Error(`Expected JSON object, but received: ${JSON.stringify(i)}.`);return i}function Je(i){const e=parseInt(i,10);if(!Number.isInteger(e))throw new Error(`Expected integer, but received: ${JSON.stringify(i)}.`);return e}function ht(i){const e=Je(i);if(e<=0)throw new Error(`Expected positive integer, but received: ${e}.`);return e}function KA(i){const e=Je(i);if(e<0)throw new Error(`Expected non-negative integer, but received: ${e}.`);return e}function Ax(i,e){const t=e.get(i);if(t===void 0)throw new Error(`Expected one of ${JSON.stringify(Array.from(e.keys()))}, but received: ${JSON.stringify(i)}.`);return t}function ie(i){if(typeof i!="string")throw new Error(`Expected string, but received: ${JSON.stringify(i)}.`);return i}function cn(i){if(i!==void 0)return ie(i)}function Ci(i){if(i!==void 0)return Je(i)}function Rx(i){if(i!==void 0){if(typeof i=="boolean")return i;if(i==="true")return!0;if(i==="false")return!1;throw new Error(`Expected string or boolean but received: ${JSON.stringify(i)}`)}}function z(i,e,t){const n=Object.prototype.hasOwnProperty.call(i,e)?i[e]:void 0;try{return t(n)}catch(s){throw new Error(`Error parsing ${JSON.stringify(e)} property: ${s.message}`)}}function oe(i,e,t,n){return z(i,e,s=>s===void 0?n:t(s))}function Jl(i,e){ee(i);const t=new Map;for(const n of Object.keys(i))try{t.set(n,e(i[n]))}catch(s){throw new Error(`Error parsing value associated with key ${JSON.stringify(n)}: ${s.message}`)}return t}function Nx(i){if(typeof i!="number"||!Number.isFinite(i)||i<0||i>1)throw new Error(`Expected floating point number in [0,1], but received: ${JSON.stringify(i)}.`);return i}function Ma(i){if(i==="")return{};if(i.startsWith("{"))return og(i);const e={},t=i.split(/[&;]/);for(const n of t){const s=n.match(/^([^=&;]+)=([^&;]*)$/);if(s===null)throw new Error(`Invalid query string part: ${JSON.stringify(n)}.`);e[s[1]]=decodeURIComponent(s[2])}return e}function XA(i){if(i===void 0)return"";const e=Object.keys(i);return e.length===0?"":e.some(t=>typeof i[t]!="string")?JSON.stringify(i):e.map(t=>`${encodeURIComponent(t)}=${encodeURIComponent(i[t])}`).join("&")}function ft(i,e,t=/^[a-zA-Z]/){if(typeof i=="string"&&i.match(t)!==null){const n=i.toUpperCase();if(Object.prototype.hasOwnProperty.call(e,n))return e[n]}throw new Error(`Invalid enum value: ${JSON.stringify(i)}.`)}function Mx(i){return _e(we(),i,Xe)}function QA(i){return _e(we(),i,wt)}function ZA(i){return _e(we(),i,ht)}function Zn(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${JSON.stringify(i)}.`);for(const e of i)if(typeof e!="string")throw new Error(`Expected string, received: ${JSON.stringify(e)}.`);return i}function eR(i){if(!Array.isArray(i))throw new Error(`Expected array, received: ${JSON.stringify(i)}.`);for(const e of i)if(!Number.isInteger(e))throw new Error(`Expected integer, received: ${JSON.stringify(e)}.`);return i}function Ss(i){if(typeof i!="boolean")throw new Error(`Expected boolean, received: ${JSON.stringify(i)}`);return i}function Oa(i){for(const e in i)return i}function Ol(i,e){if(i!==e)throw new Error(`Expected ${JSON.stringify(e)}, but received: ${JSON.stringify(i)}`);return e}function uu(i,e){if(i===void 0){const t=new Array(e);return t.fill(null),t}return _e(new Array(e),i,t=>{if(t!==null&&typeof t!="string")throw new Error(`Expected string or null, but received: ${JSON.stringify(name)}`);return t})}const q0=2**-1074,ag=new Float64Array(1),Qs=new Uint32Array(ag.buffer);function tR(i,e){if(Number.isNaN(i)||Number.isNaN(e))return NaN;if(i===e)return e;if(i===0)return e<0?-q0:q0;ag[0]=i;const t=Na===_n.LITTLE?0:1,n=1-t;return e>i==i>0?Qs[t]===4294967295?(Qs[t]=0,Qs[n]+=1):Qs[t]+=1:Qs[t]===0?(Qs[t]=4294967295,Qs[n]-=1):Qs[t]-=1,ag[0]}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cp=new Uint32Array(2),kl=4294967296,lg=[];for(let i=2;i<=36;++i){const e=Math.floor(32/Math.log2(i)),t=i**e;let n=`^[0-${String.fromCharCode(48+Math.min(9,i-1))}`;i>10&&(n+=`a-${String.fromCharCode(97+i-11)}`,n+=`A-${String.fromCharCode(65+i-11)}`);const s=Math.ceil(64/Math.log2(i));n+=`]{1,${s}}$`;const r=new RegExp(n);lg[i]={lowDigits:e,lowBase:t,pattern:r}}function K0(i,e){i>>>=0,e>>>=0;const t=i&65535,n=i>>>16,s=e&65535,r=e>>>16;let l=(t*s>>>16)+n*s,c=l>>>16;l=(l&65535)+t*r,c+=l>>>16;let u=c>>>16;return c=(c&65535)+n*r,u+=c>>>16,((u&65535)<<16|c&65535)>>>0}const wn=class wn{constructor(e=0,t=0){this.low=e,this.high=t}clone(){return new wn(this.low,this.high)}assign(e){this.low=e.low,this.high=e.high}toString(e=10){let t=this.low,n=this.high;if(n===0)return t.toString(e);n*=kl;const{lowBase:s,lowDigits:r}=lg[e],o=n%s;n=Math.floor(n/s),t+=o,n+=Math.floor(t/s),t=t%s;const l=t.toString(e);return n.toString(e)+"0".repeat(r-l.length)+l}static less(e,t){return e.high<t.high||e.high===t.high&&e.low<t.low}static compare(e,t){return e.high-t.high||e.low-t.low}static equal(e,t){return e.low===t.low&&e.high===t.high}static min(e,t){return wn.less(e,t)?e:t}static max(e,t){return wn.less(e,t)?t:e}static random(){return crypto.getRandomValues(cp),new wn(cp[0],cp[1])}tryParseString(e,t=10){const{lowDigits:n,lowBase:s,pattern:r}=lg[t];if(!r.test(e))return!1;if(e.length<=n)return this.low=parseInt(e,t),this.high=0,!0;const o=e.length-n,l=parseInt(e.substr(o),t),c=parseInt(e.substr(0,o),t);let u,h;if(s===kl)u=c,h=l;else{const g=Math.imul(c,s)>>>0;u=K0(c,s)+(Math.imul(Math.floor(c/kl),s)>>>0),h=l+g,h>=kl&&(++u,h-=kl)}return h>>>0!==h||u>>>0!==u?!1:(this.low=h,this.high=u,!0)}parseString(e,t=10){if(!this.tryParseString(e,t))throw new Error(`Failed to parse string as uint64 value: ${JSON.stringify(e)}.`);return this}static parseString(e,t=10){return new wn().parseString(e,t)}valid(){const{low:e,high:t}=this;return e>>>0===e&&t>>>0===t}toJSON(){return this.toString()}static lshift(e,t,n){const{low:s,high:r}=t;return n===0?(e.low=s,e.high=r):n<32?(e.low=s<<n,e.high=r<<n|s>>>32-n):(e.low=0,e.high=s<<n-32),e}static rshift(e,t,n){const{low:s,high:r}=t;return n===0?(e.low=s,e.high=r):n<32?(e.low=s>>>n|r<<32-n,e.high=r>>>n):(e.low=r>>>n-32,e.high=0),e}static or(e,t,n){return e.low=t.low|n.low,e.high=t.high|n.high,e}static xor(e,t,n){return e.low=t.low^n.low,e.high=t.high^n.high,e}static and(e,t,n){return e.low=t.low&n.low,e.high=t.high&n.high,e}static add(e,t,n){const s=t.low+n.low;let r=t.high+n.high;const o=s>>>0;return o!==s&&(r+=1),e.low=o,e.high=r>>>0,e}static addUint32(e,t,n){const s=t.low+n;let r=t.high;const o=s>>>0;return o!==s&&(r+=1),e.low=o,e.high=r>>>0,e}static decrement(e,t){let{low:n,high:s}=t;return n===0&&(s-=1),e.low=n-1>>>0,e.high=s>>>0,e}static increment(e,t){let{low:n,high:s}=t;return n===4294967295&&(s+=1),e.low=n+1>>>0,e.high=s>>>0,e}static subtract(e,t,n){const s=t.low-n.low;let r=t.high-n.high;const o=s>>>0;return o!==s&&(r-=1),e.low=o,e.high=r>>>0,e}static absDifference(e,t,n){return wn.less(t,n)?wn.subtract(e,n,t):wn.subtract(e,t,n)}static multiplyUint32(e,t,n){const{low:s,high:r}=t;return e.low=Math.imul(s,n)>>>0,e.high=Math.imul(r,n)+K0(s,n)>>>0,e}static lowMask(e,t){return t===0?e.high=e.low=0:t<=32?(e.high=0,e.low=4294967295>>>32-t):(e.high=4294967295>>>t-32,e.low=4294967295),e}toNumber(){return this.low+this.high*4294967296}setFromNumber(e){e=Math.round(e),e<0?this.low=this.high=0:e>=18446744073709552e3?this.low=this.high=4294967295:(this.low=e%4294967296,this.high=Math.floor(e/4294967296))}static fromNumber(e){const t=new wn;return t.setFromNumber(e),t}};wn.ZERO=new wn(0,0),wn.ONE=new wn(1,0);let X=wn;const ki={[J.UINT8]:[0,255],[J.INT8]:[-128,127],[J.UINT16]:[0,65535],[J.INT16]:[-32768,32767],[J.UINT32]:[0,4294967295],[J.INT32]:[-2147483648,2147483647],[J.UINT64]:[X.ZERO,new X(4294967295,4294967295)],[J.FLOAT32]:[0,1]};function Hn(i,e){if(typeof e=="number"){const o=i[0],l=i[1];return(e-o)/(l-o)}const t=i[0],n=i[1];let s;X.compare(e,t)<0?s=-X.subtract(Mn,t,e).toNumber():s=X.subtract(Mn,e,t).toNumber();let r=X.absDifference(Mn,n,t).toNumber();return X.compare(t,n)>0&&(r*=-1),s/r}function ds(i,e,t){if(typeof i[0]=="number"){const l=i[0],c=i[1];let u=l*(1-t)+c*t;if(e!==J.FLOAT32){const h=ki[e];u=Math.round(u),u=Math.max(h[0],u),u=Math.min(h[1],u)}return u}let n=i[0],s=i[1];X.compare(n,s)>0&&([n,s]=[s,n],t=1-t);const r=X.subtract(Mn,s,n).toNumber(),o=new X;return t<=0?(Mn.setFromNumber(r*-t),X.subtract(o,n,X.min(Mn,n))):t>=1?(Mn.setFromNumber(r*(t-1)),X.add(o,s,Mn),X.less(o,s)&&(o.low=o.high=4294967295)):(Mn.setFromNumber(r*t),X.add(o,n,Mn),X.less(o,n)&&(o.low=o.high=4294967295)),o}function jr(i,e){return typeof e=="number"?Math.min(Math.max(i[0],e),i[1]):X.min(X.max(i[0],e),i[1])}function _l(i,e){return[jr(i,e[0]),jr(i,e[1])]}function jm(i){if(ii(i[0],i[1])<=0)return i;throw new Error(`Invalid interval: [${i[0]}, ${i[1]}]`)}function Ox(i){return ii(i[0],i[1])<=0?i:[i[1],i[0]]}function ii(i,e){return typeof i=="number"?i-e:X.compare(i,e)}const Mn=new X,nR=new X;function iR(i,e){return typeof e=="number"?Math.abs(e-i[0])<Math.abs(e-i[1])?0:1:X.less(X.absDifference(Mn,i[0],e),X.absDifference(nR,i[1],e))?0:1}function Ic(i,e){let t;switch(typeof e!="string"?t=""+e:t=e,i){case J.UINT64:return X.parseString(t);case J.FLOAT32:{const n=parseFloat(t);if(!Number.isFinite(n))throw new Error(`Invalid float32 value: ${JSON.stringify(t)}`);return n}default:{const n=parseInt(t),s=ki[i];if(!Number.isInteger(n)||n<s[0]||n>s[1])throw new Error(`Invalid ${J[i].toLowerCase()} value: ${JSON.stringify(t)}`);return n}}}function sR(i){if(typeof i=="number")return i;if(typeof i=="string"){const e=new X,t=Number(i);if(e.tryParseString(i))return t.toString()===e.toString()?t:e;if(!Number.isFinite(t))throw new Error(`Invalid value: ${JSON.stringify(i)}`);return t}throw new Error(`Invalid value: ${JSON.stringify(i)}`)}function ua(i,e){return _e(new Array(2),i,t=>Ic(e,t))}function X0(i){return _e(new Array(2),i,e=>sR(e))}function us(i,e,t){return i===J.UINT64?X.equal(e[0],t[0])&&X.equal(e[1],t[1]):e[0]===t[0]&&e[1]===t[1]}function hu(i,e,t=ki[e]){if(!us(e,i,t))return e===J.UINT64?[i[0].toString(),i[1].toString()]:i}function fu(i,e,t){switch(i){case J.FLOAT32:return tR(e,t*(1/0));case J.UINT64:{const n=e;return t===-1?n.low===0&&n.high===0?n:X.decrement(new X,n):n.low===4294967295&&n.high===4294967295?n:X.increment(new X,n)}default:{const n=ki[i];return Math.max(n[0],Math.min(n[1],e+t))}}}function rR(i,e){switch(i){case J.FLOAT32:return 0;case J.UINT64:return .5/X.absDifference(Mn,e[0],e[1]).toNumber();default:return .5/Math.abs(e[0]-e[1])}}function pu(i,e){switch(i){case J.FLOAT32:return 1;case J.UINT64:{const t=X.absDifference(Mn,e[0],e[1]).toNumber();return t/(t+1)}default:{const t=Math.abs(e[0]-e[1]);return t/(t+1)}}}function gu(i,e){if(i===void 0)return ki[e];let[t,n]=i;if(e===J.UINT64)return typeof t=="number"&&(t=X.fromNumber(t)),typeof n=="number"&&(n=X.fromNumber(n)),[t,n];if(typeof t!="number"&&(t=t.toNumber()),typeof n!="number"&&(n=n.toNumber()),e!==J.FLOAT32){t=Math.round(t),n=Math.round(n);const s=ki[e];Number.isFinite(t)?t=Math.min(Math.max(s[0],t),s[1]):t=s[0],Number.isFinite(n)?n=Math.min(Math.max(s[0],n),s[1]):n=s[1]}return[t,n]}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Yr(i=128){const e=Math.ceil(i/32),t=new Uint32Array(e);crypto.getRandomValues(t);let n="";for(let s=0;s<e;++s)n+=("00000000"+t[s].toString(16)).slice(-8);return n}function oR(i){const e=new Uint8Array(i.buffer,i.byteOffset,i.byteLength),t=65536;for(let n=0,s=e.length;n<s;n+=t)crypto.getRandomValues(e.subarray(n,Math.min(s,n+t)));return i}function Q0(){const i=new Uint32Array(1);return crypto.getRandomValues(i),i[0]}class cg extends K{constructor(e){super(),this.id=e,this.changed=new ue}}var st=(i=>(i[i.POINT=0]="POINT",i[i.LINE=1]="LINE",i[i.AXIS_ALIGNED_BOUNDING_BOX=2]="AXIS_ALIGNED_BOUNDING_BOX",i[i.ELLIPSOID=3]="ELLIPSOID",i))(st||{});const gs=[0,1,2,3],dg={float32:J.FLOAT32,uint32:J.UINT32,int32:J.INT32,uint16:J.UINT16,int16:J.INT16,uint8:J.UINT8,int8:J.INT8,rgb:void 0,rgba:void 0},hr={rgb:{serializedBytes(){return 3},alignment(){return 1},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, true);dv.setUint8(${e} + 2, ${i} >>> 16);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, true) | (dv.getUint8(${e} + 2) << 16);`},deserializeJson(i){return da(Ra(i))},serializeJson(i){return Pn(na(i))}},rgba:{serializedBytes(){return 4},alignment(){return 1},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, true);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, true);`},deserializeJson(i){return da(kx(i))},serializeJson(i){return Pn(Hm(i))}},float32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setFloat32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getFloat32(${e}, isLittleEndian);`},deserializeJson(i){return xn(i)},serializeJson(i){return i}},uint32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setUint32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint32(${e}, isLittleEndian);`},deserializeJson(i){return Je(i)},serializeJson(i){return i}},int32:{serializedBytes(){return 4},alignment(){return 4},serializeCode(i,e){return`dv.setInt32(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt32(${e}, isLittleEndian);`},deserializeJson(i){return Je(i)},serializeJson(i){return i}},uint16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setUint16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getUint16(${e}, isLittleEndian);`},deserializeJson(i){return Je(i)},serializeJson(i){return i}},int16:{serializedBytes(){return 2},alignment(){return 2},serializeCode(i,e){return`dv.setInt16(${e}, ${i}, isLittleEndian);`},deserializeCode(i,e){return`${i} = dv.getInt16(${e}, isLittleEndian);`},deserializeJson(i){return Je(i)},serializeJson(i){return i}},uint8:{serializedBytes(){return 1},alignment(){return 1},serializeCode(i,e){return`dv.setUint8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getUint8(${e});`},deserializeJson(i){return Je(i)},serializeJson(i){return i}},int8:{serializedBytes(){return 2},alignment(){return 1},serializeCode(i,e){return`dv.setInt8(${e}, ${i});`},deserializeCode(i,e){return`${i} = dv.getInt8(${e});`},deserializeJson(i){return Je(i)},serializeJson(i){return i}}},aR=255;function _x(i,e,t){let n=0;const s=t.length,r=new Array(s),o=[];for(let v=0;v<s;++v)r[v]=v;const l=v=>hr[t[v].type].alignment(i);r.sort((v,y)=>l(y)-l(v));let c=0;const u=new Array(s);let h=e;const g=()=>{h+=(4-h%4)%4,n+=h,o[c]=h,h=0,++c};for(let v=0;v<s;++v){const y=r[v],b=t[y],w=hr[b.type],C=w.serializedBytes(i),E=w.alignment(i),k=(E-h%E)%E,A=h+k+C;A+(4-A%4)%4<=aR?h+=k:g(),u[y]={offset:h,group:c},h+=C}return g(),{serializedBytes:n,offsets:u,propertyGroupBytes:o}}class Vx{constructor(e,t,n){if(this.rank=e,this.firstGroupInitialOffset=t,this.propertySpecs=n,n.length===0){this.serializedBytes=t,this.serialize=this.deserialize=()=>{},this.propertyGroupBytes=[t];return}const{serializedBytes:s,offsets:r,propertyGroupBytes:o}=_x(e,t,n);this.propertyGroupBytes=o;let l="let groupOffset0 = offset;";for(let g=1;g<o.length;++g)l+=`let groupOffset${g} = groupOffset${g-1} + ${o[g-1]}*annotationCount;`;for(let g=0;g<o.length;++g)l+=`groupOffset${g} += ${o[g]}*annotationIndex;`;let c=l,u=l;const h=n.length;for(let g=0;g<h;++g){const{group:v,offset:y}=r[g],b=n[g],w=hr[b.type],C=`properties[${g}]`,E=`groupOffset${v} + ${y}`;c+=w.serializeCode(C,E,e),u+=w.deserializeCode(C,E,e)}this.serializedBytes=s,this.serialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",c),this.deserialize=new Function("dv","offset","annotationIndex","annotationCount","isLittleEndian","properties",u)}}function Ym(i,e){const t=[];for(const n of gs){const s=In[n];t[n]=new Vx(i,s.serializedBytes(i),e)}return t}function Bx(i,e){const t=i.type==="float32"?e.toPrecision(6):e.toString(),{enumValues:n,enumLabels:s}=i;if(n!==void 0){const r=n.indexOf(e);if(r!==-1)return`${s[r]} (${t})`}return t}function lR(i,e){switch(i.type){case"rgb":return Pn(na(e));case"rgba":return Pn(Hm(e));default:return Bx(i,e)}}function cR(i){const e=ie(i);if(e.match(/^[a-z][a-zA-Z0-9_]*$/)===null)throw new Error(`Invalid property identifier: ${JSON.stringify(i)}`);return e}function dR(i){if(ie(i),!Object.prototype.hasOwnProperty.call(hr,i))throw new Error("Unsupported property type: $JSON.stringify(obj)}");return i}function uR(i){const e=new Set;for(const t of i){if(e.has(t.identifier))throw new Error(`Duplicate property identifier: ${t.identifier}`);e.add(t.identifier)}}function hR(i){ee(i);const e=z(i,"id",cR),t=z(i,"type",dR),n=oe(i,"description",ie),s=oe(i,"default",l=>hr[t].deserializeJson(l),0);let r,o;switch(t){case"rgb":case"rgba":break;default:{const l=J[t.toUpperCase()];r=oe(i,"enum_values",c=>Ee(c,u=>Ic(l,u))),r!==void 0&&(o=z(i,"enum_labels",c=>_e(new Array(r.length),c,ie)))}}return{type:t,identifier:e,description:n,default:s,enumValues:r,enumLabels:o}}function fR(i){const e=i.default;return{id:i.identifier,description:i.description,type:i.type,default:e===0?void 0:hr[i.type].serializeJson(e)}}function pR(i){if(!(i===void 0||i.length===0))return i.map(fR)}function Fx(i){if(i===void 0)return[];const e=Ee(i,hR);return uR(e),e}function ug(i,e,t,n,s){for(let r=0;r<n;++r)i.setFloat32(e,s[r],t),e+=4;return e}function dp(i,e,t,n,s,r){return e=ug(i,e,t,n,s),e=ug(i,e,t,n,r),e}function hg(i,e,t,n,s){for(let r=0;r<n;++r)s[r]=i.getFloat32(e,t),e+=4;return e}function up(i,e,t,n,s,r){return e=hg(i,e,t,n,s),e=hg(i,e,t,n,r),e}const In={1:{icon:"ꕹ",description:"Line",toJSON(i){return{pointA:Array.from(i.pointA),pointB:Array.from(i.pointB)}},restoreState(i,e,t){i.pointA=z(e,"pointA",n=>_e(new Float32Array(t),n,Xe)),i.pointB=z(e,"pointB",n=>_e(new Float32Array(t),n,Xe))},serializedBytes(i){return 2*4*i},serialize(i,e,t,n,s){dp(i,e,t,n,s.pointA,s.pointB)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return up(i,e,t,n,r,o),{type:1,pointA:r,pointB:o,id:s,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},0:{icon:"⚬",description:"Point",toJSON:i=>({point:Array.from(i.point)}),restoreState:(i,e,t)=>{i.point=z(e,"point",n=>_e(new Float32Array(t),n,Xe))},serializedBytes:i=>i*4,serialize:(i,e,t,n,s)=>{ug(i,e,t,n,s.point)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n);return hg(i,e,t,n,r),{type:0,point:r,id:s,properties:[]}},visitGeometry(i,e){e(i.point,!1)}},2:{icon:"❑",description:"Bounding Box",toJSON:i=>({pointA:Array.from(i.pointA),pointB:Array.from(i.pointB)}),restoreState:(i,e,t)=>{i.pointA=z(e,"pointA",n=>_e(new Float32Array(t),n,Xe)),i.pointB=z(e,"pointB",n=>_e(new Float32Array(t),n,Xe))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,s){dp(i,e,t,n,s.pointA,s.pointB)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return up(i,e,t,n,r,o),{type:2,pointA:r,pointB:o,id:s,properties:[]}},visitGeometry(i,e){e(i.pointA,!1),e(i.pointB,!1)}},3:{icon:"◎",description:"Ellipsoid",toJSON:i=>({center:Array.from(i.center),radii:Array.from(i.radii)}),restoreState:(i,e,t)=>{i.center=z(e,"center",n=>_e(new Float32Array(t),n,Xe)),i.radii=z(e,"radii",n=>_e(new Float32Array(t),n,Dx))},serializedBytes:i=>2*4*i,serialize(i,e,t,n,s){dp(i,e,t,n,s.center,s.radii)},deserialize:(i,e,t,n,s)=>{const r=new Float32Array(n),o=new Float32Array(n);return up(i,e,t,n,r,o),{type:3,center:r,radii:o,id:s,properties:[]}},visitGeometry(i,e){e(i.center,!1),e(i.radii,!0)}}};function fg(i,e){const t=In[i.type].toJSON(i,e.rank);t.type=st[i.type].toLowerCase(),t.id=i.id,t.description=i.description||void 0;const{relatedSegments:n}=i;if(n!=null&&n.some(s=>s.length!==0)&&(t.segments=n.map(s=>s.map(r=>r.toString()))),e.properties.length!==0){const s=e.properties;t.props=i.properties.map((r,o)=>hr[s[o].type].serializeJson(r))}return t}function gR(i,e,t=!1){ee(i);const n=z(i,"type",c=>ft(c,st)),s=z(i,"id",t?cn:ie)||qm(),r=z(i,"segments",c=>{if(c===void 0)return e.relationships.map(()=>[]);const u=Gi(c);return u.length===0?e.relationships.map(()=>[]):e.relationships.length===1&&!Array.isArray(u[0])?[Ee(u,h=>X.parseString(h))]:Ee(Gi(c,e.relationships.length),h=>Ee(h,g=>X.parseString(g)))}),o=z(i,"props",c=>{const u=e.properties;return c===void 0?u.map(h=>h.default):Ee(Gi(c,e.properties.length),(h,g)=>hr[u[g].type].deserializeJson(h))}),l={id:s,description:z(i,"description",cn),relatedSegments:r,properties:o,type:n};return In[n].restoreState(l,i,e.rank),l}class ha extends K{constructor(e,t=[],n=[]){super(),this.relationships=t,this.properties=n,this.annotationMap=new Map,this.changed=new ue,this.readonly=!1,this.childAdded=new Ze,this.childUpdated=new Ze,this.childCommitted=new Ze,this.childDeleted=new Ze,this.pending=new Set,this.references=new Map,this.rank_=e,this.annotationPropertySerializers=Ym(e,n)}get rank(){return this.rank_}hasNonSerializedProperties(){return!0}add(e,t=!0){if(this.ensureUpdated(),!e.id)e.id=qm();else if(this.annotationMap.has(e.id))throw new Error(`Annotation id already exists: ${JSON.stringify(e.id)}.`);return this.annotationMap.set(e.id,e),t||this.pending.add(e.id),this.changed.dispatch(),this.childAdded.dispatch(e),t&&this.childCommitted.dispatch(e.id),this.getReference(e.id)}commit(e){this.ensureUpdated();const t=e.id;this.pending.delete(t),this.changed.dispatch(),this.childCommitted.dispatch(t)}update(e,t){if(this.ensureUpdated(),e.value===null)throw new Error("Annotation already deleted.");e.value=t,this.annotationMap.set(t.id,t),e.changed.dispatch(),this.changed.dispatch(),this.childUpdated.dispatch(t)}[Symbol.iterator](){return this.ensureUpdated(),this.annotationMap.values()}get(e){return this.ensureUpdated(),this.annotationMap.get(e)}delete(e){e.value!==null&&(e.value=null,this.annotationMap.delete(e.id),this.pending.delete(e.id),e.changed.dispatch(),this.changed.dispatch(),this.childDeleted.dispatch(e.id))}getReference(e){let t=this.references.get(e);return t!==void 0?t.addRef():(t=new cg(e),t.value=this.annotationMap.get(e)||null,this.references.set(e,t),t.registerDisposer(()=>{this.references.delete(e)}),t)}ensureUpdated(){}toJSON(){this.ensureUpdated();const e=[],{pending:t}=this;for(const n of this)t.has(n.id)||e.push(fg(n,this));return e}clear(){this.annotationMap.clear(),this.pending.clear(),this.changed.dispatch()}restoreState(e){this.ensureUpdated();const{annotationMap:t}=this;t.clear(),this.pending.clear(),e!==void 0&&Ee(e,n=>{const s=gR(n,this);t.set(s.id,s)});for(const n of this.references.values()){const{id:s}=n,r=t.get(s);n.value=r||null,n.changed.dispatch()}this.changed.dispatch()}reset(){this.clear()}}class Ux extends ha{constructor(e,t,n){super(e.value.sourceRank,n,t),this.watchableTransform=e,this.curCoordinateTransform=e.value,this.registerDisposer(e.changed.add(()=>this.ensureUpdated()))}get rank(){return this.ensureUpdated(),this.rank_}ensureUpdated(){const e=this.watchableTransform.value,{curCoordinateTransform:t}=this;if(e===t)return;this.curCoordinateTransform=e;const n=e.sourceRank,s=t.sourceRank;if(s===n&&(t.inputSpace===e.inputSpace||De(t.inputSpace.ids.slice(0,n),e.inputSpace.ids.slice(0,n))))return;const{ids:r}=e.inputSpace,o=t.inputSpace.ids,l=[];for(let u=0;u<n;++u){let h=o.indexOf(r[u]);h>=s&&(h=-1),l.push(h)}const c=u=>{const h=new Float32Array(n);for(let g=0;g<n;++g){const v=l[g];h[g]=v===-1?0:u[g]}return h};for(const u of this.annotationMap.values())switch(u.type){case 0:u.point=c(u.point);break;case 1:case 2:u.pointA=c(u.pointA),u.pointB=c(u.pointB);break;case 3:u.center=c(u.center),u.radii=c(u.radii);break}this.rank_!==n&&(this.rank_=n,this.annotationPropertySerializers=Ym(this.rank_,this.properties)),this.changed.dispatch()}}const mR="Data Bounds";function qm(){return Yr(160)}function vR(i){return{type:2,id:"data-bounds",description:mR,pointA:new Float32Array(i.lowerBounds),pointB:new Float32Array(i.upperBounds),properties:[]}}function Yi(i){const e=new ha(i.lowerBounds.length);return e.readonly=!0,e.add(vR(i)),e}function yR(i,e){let t=0;const n=[];for(const u of gs){const g=e[u].serializedBytes;n[u]=t;const y=i[u].length;t+=g*y}const s=[],r=[],o=new ArrayBuffer(t),l=new DataView(o),c=Na===_n.LITTLE;for(const u of gs){const h=e[u],{rank:g}=h,v=h.serialize,y=i[u];s[u]=y.map(k=>k.id),r[u]=new Map(y.map((k,D)=>[k.id,D]));const w=In[u].serialize,C=n[u],E=h.propertyGroupBytes[0];for(let k=0,D=y.length;k<D;++k){const A=y[k];w(l,C+k*E,c,g,A),v(l,C,k,D,c,A.properties)}}return{data:new Uint8Array(o),typeToIds:s,typeToOffset:n,typeToIdMaps:r}}class SR{constructor(e){this.propertySerializers=e,this.annotations=[[],[],[],[]]}add(e){this.annotations[e.type].push(e)}serialize(){return yR(this.annotations,this.propertySerializers)}}function zx(i){if(i==null)return i;const{relatedSegments:e}=i;if(e!==void 0)for(let t=0,n=e.length;t<n;++t){const s=e[t];s!==void 0&&(e[t]=s.map(r=>new X(r.low,r.high)))}return i}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ro(i,e,t,n,s,r,o,l,c){for(let u=0;u<o;++u)for(let h=0;h<c;++h){let g=0;for(let v=0;v<l;++v)g+=t[u+n*v]*s[v+r*h];i[u+e*h]=g}return i}function bR(i,e,t){for(let n=0;n<t;++n){const s=e*n;i.fill(0,s,s+t),i[s+n]=1}return i}function ai(i,e,t=e){return bR(new i(e*t),e,Math.min(e,t))}function pg(i,e,t=!0){const n=e.length,s=t?n+1:n,r=new i(s*(n+1));t&&(r[r.length-1]=1);for(let o=0;o<n;++o)r[(s+1)*o]=e[o];return r}function wR(i,e,t=!0){const n=e.length,s=t?n+1:n,r=ai(i,s,n+1);for(let o=0;o<n;++o)r[s*n+o]=e[o];return r}function CR(i,e,t){for(let n=0;n<t;++n)for(let s=0;s<t;++s)if(i[n*e+s]!==(n===s?1:0))return!1;return!0}function Km(i,e,t,n,s,r){for(let o=0;o<r;++o){const l=o*n,c=o*e;for(let u=0;u<s;++u)i[c+u]=t[l+u]}return i}function Xm(i,e,t,n){Km(i,e+1,t,n+1,n,n);for(let s=0;s<n;++s)i[(e+1)*e+s]=t[(n+1)*n+s];i[i.length-1]=1;for(let s=n;s<e;++s)i[(e+1)*s+s]=1;return i}let $n;function xR(i,e,t){let n=1;($n===void 0||$n.length<t)&&($n=new Uint32Array(t));for(let s=0;s<t;++s)$n[s]=s;for(let s=0;s<t;++s){const r=e*s;let o=s;{let u=Math.abs(i[r+s]);for(let h=s+1;h<t;++h){const g=Math.abs(i[r+h]);g>u&&(u=g,o=h)}}if(s!==o){n*=-1;for(let u=0;u<t;++u){const h=e*u,g=i[h+s];i[h+s]=i[h+o],i[h+o]=g}{const u=$n[s];$n[s]=$n[o],$n[o]=u}}const l=i[r+s],c=1/l;n*=l;for(let u=0;u<t;++u)i[e*u+s]*=c;i[r+s]=c;for(let u=0;u<t;++u){if(u===s)continue;const h=-i[e*s+u];for(let g=0;g<t;++g){const v=e*g;i[v+u]+=h*i[v+s]}i[e*s+u]=h*c}}for(let s=0;s<t;++s){let r=$n[s];for(;r!==s;){const o=e*s,l=e*r;for(let u=0;u<t;++u){const h=o+u,g=l+u,v=i[h];i[h]=i[g],i[g]=v}const c=$n[s]=$n[r];$n[r]=r,r=c}}return n}function Qm(i,e,t,n,s){return Km(i,e,t,n,s,s),xR(i,e,s)}function ER(i,e,t,n,s,r){for(let o=0;o<r;++o){const l=e*o,c=n*o;for(let u=0;u<s;++u)if(i[l+u]!==t[c+u])return!1}return!0}function ps(i,e,t,n,s){for(let r=0;r<s;++r){let o=e[t*s+r];for(let l=0;l<s;++l)o+=e[t*l+r]*n[l];i[r]=o}return i}function Gx(i,e,t,n,s){for(let r=0;r<s;++r){let o=0;for(let l=0;l<s;++l)o+=e[t*l+r]*n[l];i[r]=o}return i}function TR(i,e,t,n,s,r){const o=s.length;for(let l=0;l<o;++l){const c=s[l];for(let u=0;u<r;++u)i[u*e+l]=t[u*n+c]}return i}const Yd=[{prefix:"Y",exponent:24,longPrefix:"yotta"},{prefix:"Z",exponent:21,longPrefix:"zetta"},{prefix:"E",exponent:18,longPrefix:"exa"},{prefix:"P",exponent:15,longPrefix:"peta"},{prefix:"T",exponent:12,longPrefix:"tera"},{prefix:"G",exponent:9,longPrefix:"giga"},{prefix:"M",exponent:6,longPrefix:"mega"},{prefix:"k",exponent:3,longPrefix:"kilo"},{prefix:"",exponent:0,longPrefix:""},{prefix:"m",exponent:-3,longPrefix:"milli"},{prefix:"µ",exponent:-6,longPrefix:"micro"},{prefix:"n",exponent:-9,longPrefix:"nano"},{prefix:"p",exponent:-12,longPrefix:"pico"},{prefix:"f",exponent:-15,longPrefix:"femto"},{prefix:"a",exponent:-18,longPrefix:"atto"},{prefix:"z",exponent:-21,longPrefix:"zepto"},{prefix:"y",exponent:-24,longPrefix:"yocto"}],Zm=[...Yd,{prefix:"h",exponent:2,longPrefix:"hecto"},{prefix:"da",exponent:1,longPrefix:"deca"},{prefix:"d",exponent:-1,longPrefix:"deci"},{prefix:"c",exponent:-2,longPrefix:"centi"}],kR=[{prefix:"u",exponent:-6},...Zm],Pc=new Map;Pc.set("",{unit:"",exponent:0});const LR=new Map;for(const{prefix:i,exponent:e}of kR){LR.set(e,i);for(const t of["m","s","Hz","rad/s"])Pc.set(`${i}${t}`,{unit:t,exponent:e})}function $x(i){const e=Math.log10(i),t=Yd.length,n=EP(0,t,s=>Yd[s].exponent<=e);return Yd[Math.min(n,t-1)]}function Wx(i,e,t={}){const{precision:n=6,elide1:s=!0}=t;let r=i,o="";if(e!==""){const c=$x(i);o=c.prefix,r=ev(i,-c.exponent)}if(s&&r===1)return{scale:"",unit:e,prefix:o};let l;if(n!==0){r<1||r>=1e3?l=r.toPrecision(n):l=r.toFixed(n);const c=l.indexOf("e");let u,h;c!==-1?(u=l.substring(0,c),h=l.substring(c)):(u=l,h="");const g=u.match(/.*\.(?:[0-9]*[1-9])?(0+)$/);g!==null&&(u=u.substring(0,u.length-g[1].length),u.endsWith(".")&&(u=u.substring(0,u.length-1)),l=u+h)}else l=r.toString();return{scale:l,unit:e,prefix:o}}function qr(i,e,t){const{scale:n,unit:s,prefix:r}=Wx(i,e,t);return`${n}${r}${s}`}function jl(i){if(i==="")return{scale:1,unit:""};const e=i.match(/^((?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)?([µa-zA-Z]+)?$/);if(e===null)return;const t=e[1];let n=t===void 0?1:Number(t);if(Number.isNaN(n))return;let s="";if(e[2]!==void 0){const r=Pc.get(e[2]);if(r===void 0)return;s=r.unit,r.exponent>0?n*=10**r.exponent:n/=10**-r.exponent}if(!(n<=0||!Number.isFinite(n)))return{scale:n,unit:s}}function Z0(i){const e=Pc.get(i);if(e===void 0)throw new Error(`Invalid unit: ${JSON.stringify(i)}`);return e}function ev(i,e){return e>=0?i*10**e:i/10**-e}function Hx(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]+t[s];return i}function gg(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]-t[s];return i}function DR(i,e,t,n){const s=i.length;for(let r=0;r<s;++r)i[r]=e[r]+t[r]*n;return i}function IR(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=e[s]*t;return i}function tv(i){let e=1;for(let t=0,n=i.length;t<n;++t)e*=i[t];return e}function PR(i,e,t){const n=i.length;for(let s=0;s<n;++s)i[s]=Math.min(e[s],t[s]);return i}const fa=new Float32Array(0),Jx=new Float64Array(0);let AR=0;function Qo(){return++AR}function RR(i,e){return De(i.lowerBounds,e.lowerBounds)&&De(i.upperBounds,e.upperBounds)}function NR(i,e){return i===void 0?e===void 0:e===void 0?!1:i.explicit===e.explicit&&De(i.coordinates,e.coordinates)&&De(i.labels,e.labels)}function MR(i,e){const t=new Map;for(let n=0,s=i.length;n<s;++n)t.set(i[n],e[n]);return i=Array.from(t.keys()),i.sort((n,s)=>n-s),e=Array.from(i,n=>t.get(n)),{coordinates:i,labels:e}}function jx(i){if(i.length===1)return i[0];const e=new Map;let t=!1;for(const r of i){r.explicit&&(t=!0);const{coordinates:o,labels:l}=r;for(let c=0,u=o.length;c<u;++c)e.set(o[c],l[c])}const n=Array.from(e.keys());n.sort((r,o)=>r-o);const s=Array.from(n,r=>e.get(r));return{explicit:t,coordinates:n,labels:s}}function eb(i){if(i=i.filter(e=>e!==void 0),i.length!==0)return jx(i)}function OR(i,e){return De(i.transform,e.transform)&&RR(i.box,e.box)}function mu(i,e){return i.valid===e.valid&&i.rank===e.rank&&De(i.names,e.names)&&De(i.ids,e.ids)&&De(i.timestamps,e.timestamps)&&De(i.units,e.units)&&De(i.scales,e.scales)&&Kp(i.boundingBoxes,e.boundingBoxes,OR)&&Kp(i.coordinateArrays,e.coordinateArrays,NR)}function Ue(i){const{names:e,units:t,scales:n}=i,{valid:s=!0,rank:r=e.length,timestamps:o=e.map(()=>Number.NEGATIVE_INFINITY),ids:l=e.map((g,v)=>-v),boundingBoxes:c=[]}=i,{coordinateArrays:u=new Array(r)}=i,{bounds:h=UR(c,r)}=i;return{valid:s,rank:r,names:e,timestamps:o,ids:l,units:t,scales:n,boundingBoxes:c,bounds:h,coordinateArrays:u}}const bs=Ue({valid:!1,names:[],units:[],scales:Jx,boundingBoxes:[]}),pa=Ue({valid:!0,names:[],units:[],scales:Jx,boundingBoxes:[]});function _R(i){const[e,t]=Gi(i,2),n=wt(e),s=ie(t),r=Pc.get(s);if(r===void 0)throw new Error(`Invalid unit: ${JSON.stringify(s)}`);return{unit:r.unit,scale:ev(n,r.exponent)}}function vu(i,e=!1){if(i===void 0)return bs;ee(i);const t=rv(Object.keys(i),e),n=t.length,s=new Array(n),r=new Float64Array(n),o=new Array(n);for(let l=0;l<n;++l)z(i,t[l],c=>{if(Array.isArray(c)){const{unit:u,scale:h}=_R(c);s[l]=u,r[l]=h}else{ee(c);const u=z(c,"coordinates",eR),h=z(c,"labels",Zn),g=u.length;if(g!==h.length)throw new Error(`Length of coordinates array (${g}) does not match length of labels array (${h.length})`);s[l]="",r[l]=1,o[l]={explicit:!0,...MR(u,h)}}});return Ue({valid:!1,names:t,units:s,scales:r,coordinateArrays:o})}function mg(i){const{rank:e}=i;if(e===0)return;const{names:t,units:n,scales:s,coordinateArrays:r}=i,o={};for(let l=0;l<e;++l){const c=t[l],u=r[l];u!=null&&u.explicit?o[c]={coordinates:Array.from(u.coordinates),labels:u.labels}:o[c]=[s[l],n[l]]}return o}class nv extends Ne{constructor(){super(bs)}toJSON(){return mg(this.value)}reset(){this.value=bs}restoreState(e){this.value=vu(e)}}function VR(i,e,t){return i.voxelCenterAtIntegerCoordinates[e]?t=Math.round(t):t=Math.floor(t)+.5,t}function Yx(i,e){let t=i.lowerBounds[e],n=i.upperBounds[e];return i.voxelCenterAtIntegerCoordinates[e]&&(t+=.5,n+=.5),[t,n]}function BR(i,e,t){const n=i.upperBounds[e];Number.isFinite(n)&&(t=Math.min(t,n-1));const s=i.lowerBounds[e];return Number.isFinite(s)&&(t=Math.max(t,s)),t}function vg(i,e,t){return t=BR(i,e,t),VR(i,e,t)}function qx(i,e){let t=(i+e)/2;return Number.isFinite(t)||(t=Math.min(Math.max(0,i),e)),t}function FR(i,e){const{lowerBounds:t,upperBounds:n}=e,s=i.length;for(let r=0;r<s;++r)i[r]=qx(t[r],n[r]);return i}function qi(i){const e=i.lowerBounds.length;return{box:i,transform:ai(Float64Array,e,e+1)}}function Kx(i,e,t){const{box:{lowerBounds:n,upperBounds:s},transform:r}=i,o=n.length,l=t,c=r[l*o+e];let u=c,h=c,g=!1;for(let v=0;v<o;++v){const y=r[l*v+e];if(y===0)continue;const b=y*n[v],w=y*s[v];u+=Math.min(b,w),h+=Math.max(b,w),g=!0}if(g)return{lower:u,upper:h}}function UR(i,e){const t=new Float64Array(e),n=new Float64Array(e);t.fill(Number.NEGATIVE_INFINITY),n.fill(Number.POSITIVE_INFINITY);const s=new Array(e);s.fill(0);const r=new Array(e);r.fill(0);for(const l of i)for(let c=0;c<e;++c){const u=Kx(l,c,e);if(u===void 0)continue;const{lower:h,upper:g}=u;if(Number.isFinite(h)&&Number.isFinite(g)){const v=Math.floor(h),y=Math.floor(g);v===h&&y===g?++r[c]:h-v===.5&&g-y===.5&&++s[c]}t[c]=t[c]===Number.NEGATIVE_INFINITY?h:Math.min(t[c],h),n[c]=n[c]===Number.POSITIVE_INFINITY?g:Math.max(n[c],g)}const o=r.map((l,c)=>s[c]>0&&l===0);return{lowerBounds:t,upperBounds:n,voxelCenterAtIntegerCoordinates:o}}function zR(i,e,t){const{transform:n,box:s}=i,r=t.length,o=s.lowerBounds.length,l=new Float64Array((o+1)*e);for(let c=0;c<r;++c){const u=t[c];if(u!==-1)for(let h=0;h<=o;++h)l[h*e+u]=n[h*r+c]}return{transform:l,box:s}}function Xx(i,e){const t={lowerBounds:Float64Array.of(0),upperBounds:Float64Array.of(1)},n=new Float64Array(2*i);return n[e]=1,{transform:n,box:t}}function Qx(i,e,t){if(e===t)return i;const{box:n}=i,s=n.lowerBounds.length,r=new Float64Array((s+1)*t);return Km(r,t,i.transform,e,e,s+1),{box:n,transform:r}}function GR(i,e){const{rank:t,sourceRank:n}=i;if(t!==e.rank||n!==e.sourceRank)return!1;const{inputSpace:s}=i,{inputSpace:r}=e;return!De(r.scales,s.scales)||!De(r.units,s.units)||!De(e.outputSpace.names,i.outputSpace.names)?!1:t1(i.transform,t,i.outputSpace.scales,e.transform,t,e.outputSpace.scales)}function Jt(i){return{rank:i.rank,sourceRank:i.rank,inputSpace:i,outputSpace:i,transform:ai(Float64Array,i.rank+1)}}function $R(i,e,t,n){const{transform:s,box:r}=i,o=i.box.lowerBounds.length,l=n.length,c=new Float64Array((o+1)*l);for(let u=0;u<l;++u){const h=n[u];for(let v=0;v<o;++v){let y=0;for(let b=0;b<l;++b){const w=t[b];y+=e[(l+1)*b+u]*s[l*v+b]*(w/h)}c[l*v+u]=y}let g=e[(l+1)*l+u];for(let v=0;v<l;++v){const y=t[v];g+=e[(l+1)*v+u]*s[l*o+v]*(y/h)}c[o*l+u]=g}return{transform:c,box:r}}function Zx(i,e,t){return i.boundingBoxes.map(n=>$R(n,e,i.scales,t))}function yg(i,e,t){const n=Ue({valid:i.valid,rank:t.rank,ids:t.ids,names:t.names,timestamps:t.timestamps,scales:t.scales,units:t.units,boundingBoxes:Zx(i,e,t.scales),coordinateArrays:t.coordinateArrays});return mu(n,t)?t:n}function iv(i,e=!1){if(e){const t=Number(i);if(Number.isInteger(t)&&t>=0)return!0}return i.match(/^[a-zA-Z][a-zA-Z_0-9]*['^]?$/)!==null}function uh(i,e=!1){const t=new Set;for(const n of i){if(!iv(n,e)||t.has(n))return!1;t.add(n)}return!0}function sv(i){const e=i.length,t=new Array(e);t.fill(!0);for(let n=0;n<e;++n){const s=i[n];if(!iv(s)){t[n]=!1;continue}const r=i.indexOf(s,n+1);r!==-1&&(t[n]=!1,t[r]=!1)}return t}function Vl(i){return i.endsWith("'")}function e1(i){return i.endsWith("'")||i.endsWith("^")}function WR(i){return i.endsWith("^")}function HR(i){return!e1(i)}function JR(i,e,t){const n=new Float64Array(i),s=e.length,r=(s+1)*s;for(let o=0;o<s;++o)n[r+o]*=e[o]/t[o];return n}function t1(i,e,t,n,s,r){if(!ER(i,e+1,n,s+1,e,e))return!1;for(let o=0;o<e;++o){const l=i[(e+1)*e+o],c=n[(s+1)*s+o];if(l*(t[o]/r[o])!==c)return!1}for(let o=e;o<s;++o)if(n[(s+1)*s+o]!==0)return!1;for(let o=e;o<s;++o){for(let l=0;l<e;++l)if(n[(s+1)*l+o]!==0)return!1;for(let l=0;l<s;++l){const c=n[(s+1)*o+l];if(o===l){if(c!==1)return!1}else if(c!==0)return!1}}return!0}function jR(i,e){if(!e.includes(i))return i;const[,t,n]=i.match(/^([^']*)('?)$/);for(let s=0;;++s){const r=`${t}${s}${n}`;if(!e.includes(r))return r}}function YR(i,e){const{inputSpace:t,transform:n}=i,{ids:s,rank:r}=t,{rank:o,names:l,units:c,scales:u}=e,h=new Array(r);h.fill(!0);const g=[],v=e.ids.map((H,V)=>{const re=s.indexOf(H);return re!==-1?h[re]=!1:g.push(V),re}),{outputSpace:y}=i,{names:b,units:w,scales:C,ids:E,timestamps:k,coordinateArrays:D}=y,A=h,N=[],I=[],P=new Float64Array(o),O=[],_=[],W=new Array(o);let U=0;const j=new Float64Array((o+1)**2);j[j.length-1]=1;for(let H=0;H<r;++H)if(!A[H]){N[U]=b[H],O[U]=E[H],I[U]=w[H],P[U]=C[H],_[U]=k[H],W[U]=D[H];for(let V=0;V<o;++V){const re=v[V];re!==-1&&(j[V*(o+1)+U]=n[re*(r+1)+H])}j[o*(o+1)+U]=n[r*(r+1)+H],++U}for(const H of g)O[U]=Qo(),N[U]=jR(l[H],N),P[U]=u[H],I[U]=c[H],j[H*(o+1)+U]=1,++U;const B=Ue({valid:e.valid,rank:o,names:N,ids:O,timestamps:_,units:I,scales:P,boundingBoxes:Zx(e,j,P),coordinateArrays:W});return{rank:o,sourceRank:i.sourceRank,inputSpace:e,outputSpace:B,transform:j}}function tb(i){const e=yg(i.inputSpace,i.transform,i.outputSpace);return e===i.outputSpace?i:{rank:i.rank,sourceRank:i.sourceRank,inputSpace:i.inputSpace,transform:i.transform,outputSpace:e}}class nb{constructor(e,t=!1){this.mutableSourceRank=t,this.value_=void 0,this.changed=new ue,this.inputSpaceChanged=new ue,this.defaultTransform=tb(e);const n=this;this.outputSpace={changed:n.changed,get value(){return n.value.outputSpace},set value(s){const{value:r}=n;if(mu(r.outputSpace,s)||r.rank!==s.rank)return;const o=JR(r.transform,r.outputSpace.scales,s.scales);n.value_={sourceRank:r.sourceRank,rank:r.rank,inputSpace:r.inputSpace,outputSpace:yg(r.inputSpace,o,s),transform:o},n.changed.dispatch()}},this.inputSpace={changed:n.inputSpaceChanged,get value(){return n.value.inputSpace},set value(s){const{value:r}=n;mu(r.inputSpace,s)||(n.value_=YR(r,s),n.inputSpaceChanged.dispatch(),n.changed.dispatch())}}}set value(e){const t=this.value;e!==t&&(this.value_=tb(e),e.inputSpace!==t.inputSpace&&this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get value(){let{value_:e}=this;return e===void 0&&(e=this.value_=this.defaultTransform),e}reset(){this.value_!==this.defaultTransform&&(this.value_=this.defaultTransform,this.inputSpaceChanged.dispatch(),this.changed.dispatch())}get defaultInputSpace(){return this.defaultTransform.inputSpace}get spec(){const{value:e}=this,{rank:t,transform:n,inputSpace:s,outputSpace:r,sourceRank:o}=e,{defaultTransform:l,mutableSourceRank:c}=this,{inputSpace:u,rank:h,transform:g,outputSpace:v}=l,{units:y,scales:b}=s,w=o===t&&De(b,c?r.scales:u.scales)&&De(y,c?r.units:u.units),C=t1(g,h,v.scales,n,t,r.scales),E=De(v.names,r.names);if(!(C&&E&&w))return{sourceRank:o,transform:C?void 0:n,outputSpace:e.outputSpace,inputSpace:w?void 0:s}}set transform(e){const{value:t}=this,{inputSpace:n}=t;this.value_={rank:t.rank,sourceRank:t.sourceRank,inputSpace:n,transform:e,outputSpace:yg(n,e,t.outputSpace)},this.changed.dispatch()}set spec(e){if(e===void 0){this.reset();return}if(this.mutableSourceRank){const U=e.inputSpace||e.outputSpace,j=U.rank,B=Ue({rank:j,names:U.names.map((H,V)=>`${V}`),units:U.units,scales:U.scales,coordinateArrays:U.coordinateArrays});this.value={rank:j,transform:e.transform||ai(Float64Array,j+1),sourceRank:e.sourceRank,outputSpace:e.outputSpace,inputSpace:B};return}const{inputSpace:t,sourceRank:n,outputSpace:s,transform:r,rank:o}=this.defaultTransform,{inputSpace:l,sourceRank:c,outputSpace:u,transform:h}=e,g=e.outputSpace.rank,v=t.names,y=l!==void 0?l.names:v,b=new Array(n);for(let U=0;U<n;++U){let j=y.indexOf(v[U]);j>=c&&(j=-1),b[U]=j}const w=g-c+n;for(let U=c;U<g;++U)b[n+U-c]=U;const C=new Float64Array(w),E=new Array(w),k=[];for(let U=0;U<n;++U){const j=b[U];j===-1||l===void 0?(C[U]=t.scales[U],k[U]=t.units[U],E[U]=t.coordinateArrays[U]):(C[U]=l.scales[j],k[U]=l.units[j],E[U]=eb([t.coordinateArrays[U],l.coordinateArrays[j]]))}const D=l||u,A=v.slice(0,n),N=s.names.slice(0,n),I=s.coordinateArrays.slice(0,n),P=new Float64Array(w),O=[];for(let U=0;U<w;++U){const j=b[U];j===-1?(P[U]=s.scales[U],O[U]=s.units[U],I[U]=s.coordinateArrays[U]):(N[U]=u.names[j],O[U]=u.units[j],P[U]=u.scales[j],I[U]=u.coordinateArrays[j])}if(!uh(N)){this.reset();return}for(let U=n;U<w;++U){const j=U-n+c;C[U]=D.scales[j],k[U]=D.units[j],A[U]=`${U}`}const _=new Float64Array((w+1)**2);_[_.length-1]=1;for(let U=0;U<w;++U){const j=b[U];let B;j===-1||h===void 0?U>=n?B=0:B=r[o*(o+1)+U]*(s.scales[U]/P[U]):B=h[g*(g+1)+j],_[w*(w+1)+U]=B;for(let H=0;H<w;++H){const V=b[H];let re;j===-1!=(V===-1)?re=0:j===-1||h===void 0?j>=n||V>=n?re=j===V?1:0:re=r[H*(o+1)+U]:re=h[V*(g+1)+j],_[H*(w+1)+U]=re}}const W=t.boundingBoxes.map(U=>Qx(U,o,w));for(let U=n;U<w;++U)W.push(Xx(w,U));for(let U=0;U<w;++U){if(_[w*(w+1)+U]!==0)continue;let B;for(let V=0;V<w;++V){const re=_[V*(w+1)+U];if(re!==0)if(re===1)if(B===void 0)B=V;else{B=null;break}else{B=null;break}}if(B==null)continue;let H=E[B];H!==void 0&&(H.explicit&&(H={...H,explicit:!1}),I[U]=eb([H,I[U]]))}this.value={rank:w,transform:_,sourceRank:n,outputSpace:Ue({rank:w,names:N,scales:P,units:O,coordinateArrays:I}),inputSpace:Ue({rank:w,names:A,scales:C,units:k,coordinateArrays:E,boundingBoxes:W})}}toJSON(){return s1(this.spec)}restoreState(e){this.spec=i1(e)}}function qR(i,e=!1){const t=ie(i);if(!iv(t,e))throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return t}function rv(i,e=!1){const t=Ee(i,n=>qR(n,e));if(!uh(t,e))throw new Error(`Invalid dimensions: ${JSON.stringify(t)}`);return t}class ov{constructor(e,t){this.combined=e,this.bindings=new Set,this.retainCount=0,this.prevCombined=this.combined.value,this.dimensionRefCounts=new Map,this.handleCombinedChanged=()=>{this.combined.value!==this.prevCombined&&this.update()},this.includeDimensionPredicate_=t}getRenameValidity(e){const t=this.combined.value.names,n=sv(e),s=e.length;for(let r=0;r<s;++r){if(!n[r])continue;const o=e[r];if(t.includes(o))continue;let l=!0;for(const c of this.bindings)if(c.space.value.names.includes(o)){l=!1;break}n[r]=l}return n}get includeDimensionPredicate(){return this.includeDimensionPredicate_}set includeDimensionPredicate(e){this.includeDimensionPredicate_=e,this.update()}update(){const{combined:e,bindings:t}=this,n=this.retainCount>0?1:0;if(t.size===0&&!n){e.value=bs;return}const s=this.includeDimensionPredicate_,r=e.value;let o=Array.from(r.names),l=Array.from(r.units),c=Array.from(r.scales),u=Array.from(r.ids),h=Array.from(r.timestamps),g=r.names.map(()=>n?1:0);const v=[];let y=!1;for(const N of t){const{space:{value:I},prevValue:P,mappedDimensionIds:O}=N;y=y||I.valid;const{names:_,units:W,scales:U,ids:j,timestamps:B}=I,H=[],V=[];v.push(V),N.mappedDimensionIds=H,N.prevValue=I;const re=_.length;for(let se=0;se<re;++se){const ve=_[se];if(!s(ve))continue;if(P!==void 0){const We=j[se],tt=P.ids.indexOf(We);if(tt!==-1){const rt=O[tt];if(rt!==void 0){const nt=u.indexOf(rt);if(nt!==-1){H[se]=rt,++g[nt],V[se]=nt;const Ge=B[se];Ge!==void 0&&!(Ge<=h[nt])&&(o[nt]=ve,c[nt]=U[se],l[nt]=W[se],h[nt]=Ge);continue}}}}let me=o.indexOf(ve);if(me!==-1){H[se]=u[me],++g[me],V[se]=me;continue}me=o.length,V[se]=me,g[me]=1+n,o[me]=ve,l[me]=W[se],c[me]=U[se],h[me]=B[se];const Ie=Qo();u[me]=Ie,H[se]=Ie}}const{dimensionRefCounts:b}=this;b.clear();let w=0,C=o.length;for(const N of t){const{space:{value:I}}=N,P=v[w++],{rank:O}=I,_=Array.from(I.names),W=Array.from(I.timestamps),U=Float64Array.from(I.scales),j=Array.from(I.units);for(let B=0;B<O;++B){const H=P[B];H!==void 0&&(j[B]=l[H],U[B]=c[H],W[B]=h[H],_[B]=o[H])}for(const B of _){let H=b.get(B);H===void 0?H=1:++H,b.set(B,H)}if(!De(j,I.units)||!De(U,I.scales)||!De(_,I.names)||!De(W,I.timestamps)){const B=Ue({valid:I.valid,ids:I.ids,scales:U,units:j,names:_,timestamps:W,boundingBoxes:I.boundingBoxes,coordinateArrays:I.coordinateArrays});N.prevValue=B,N.space.value=B}}{for(let I=0;I<C;++I)s(o[I])||(g[I]=0);const N=(I,P)=>g[P]!==0;o=o.filter(N),l=l.filter(N),c=c.filter(N),u=u.filter(N),h=h.filter(N),g=g.filter(N),C=o.length}const E=[],k=new Array(C);for(let N=0,I=r.rank;N<I;++N){const P=r.coordinateArrays[N];if(!(P!=null&&P.explicit))continue;const O=u.indexOf(r.ids[N]);O!==-1&&(k[O]=[P])}for(const N of t){const{space:{value:I}}=N,{rank:P,boundingBoxes:O,coordinateArrays:_}=I,W=I.names.map(U=>o.indexOf(U));for(const U of O)E.push(zR(U,C,W));for(let U=0;U<P;++U){const j=_[U];if(j===void 0)continue;const B=W[U],H=k[B];H===void 0?k[B]=[j]:H.push(j)}}const D=new Array(C);for(let N=0;N<C;++N){const I=k[N];I!==void 0&&(D[N]=jx(I))}const A=Ue({valid:y,ids:u,names:o,units:l,scales:new Float64Array(c),boundingBoxes:E,coordinateArrays:D});if(n)for(let N=0;N<C;++N)--g[N];mu(r,A)||(this.prevCombined=A,e.value=A)}retain(){return++this.retainCount,()=>{--this.retainCount===0&&this.update()}}bind(e){const t={space:e,mappedDimensionIds:[],prevValue:void 0},{bindings:n}=this;n.size===0&&this.combined.changed.add(this.handleCombinedChanged),n.add(t);const s=e.changed.add(()=>{e.value!==t.prevValue&&this.update()}),r=()=>{s();const{bindings:o}=this;o.delete(t),o.size===0&&this.combined.changed.remove(this.handleCombinedChanged),this.update()};return this.update(),r}}function n1(i,e,t,n,s){const r=s.length,o=new i((r+1)**2);o[o.length-1]=1;for(let l=0;l<r;++l){const c=n[l];o[(r+1)*r+l]=e[(t+1)*t+c];for(let u=0;u<r;++u){const h=s[u];o[(r+1)*u+l]=e[(t+1)*h+c]}}return o}function KR(i){if(i===void 0)return;const e=new Float64Array(16);if(Array.isArray(i))if(i.length===16)for(let t=0;t<4;++t)for(let n=0;n<4;++n)e[t*4+n]=Xe(i[n*4+t]);else{Gi(i,4);for(let t=0;t<4;++t){const n=Gi(i[t],4);for(let s=0;s<4;++s)e[s*4+t]=Xe(n[s])}}else{ee(i);const t=Cn(),n=we(),s=Et(1,1,1);oe(i,"rotation",o=>{jd(t,o),Wl(t,t)}),oe(i,"translation",o=>{jd(n,o)}),oe(i,"scale",o=>{jd(s,o)});const r=Ve();cA(r,t,n,s),e.set(r)}return{sourceRank:3,transform:e,outputSpace:Ue({valid:!0,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)}),inputSpace:void 0}}function i1(i){if(i===void 0)return;const e=ee(i),t=z(e,"outputDimensions",vu),n=t.rank,s=z(e,"sourceRank",l=>{if(l===void 0)return n;if(!Number.isInteger(l)||l<0||l>n)throw new Error(`Expected integer in range [0, ${n}] but received: ${JSON.stringify(l)}`);return l}),r=oe(e,"inputDimensions",l=>{const c=vu(l,!0);if(c.rank!==n)throw new Error(`Expected rank of ${n}, but received rank of: ${c.rank}`);return c});return{transform:oe(e,"matrix",l=>{const c=new Float64Array((n+1)**2),u=Gi(l,n);c[c.length-1]=1;for(let h=0;h<n;++h)try{const g=Gi(u[h],n+1);for(let v=0;v<=n;++v)c[(n+1)*v+h]=Xe(g[v])}catch(g){throw new Error(`Error in row ${h}: ${g.message}`)}return c}),outputSpace:t,inputSpace:r,sourceRank:s}}function s1(i){if(i===void 0)return;const{transform:e,outputSpace:t,inputSpace:n,sourceRank:s}=i;let r;const o=t.rank;if(e!==void 0){r=[];for(let l=0;l<o;++l){const c=[];r[l]=c;for(let u=0;u<=o;++u)c[u]=e[(o+1)*u+l]}}return{sourceRank:s===o?void 0:s,matrix:r,outputDimensions:mg(t),inputDimensions:n===void 0?void 0:mg(n)}}function XR(i,e,t){const{box:n,transform:s}=i,r=i.box.lowerBounds.length,o=e.length,l=new Float64Array((r+1)*o);if(TR(l,o,s,t,e,r+1),!l.every(c=>c===0))return{transform:l,box:n}}function Sg(i,e){const{ids:t,names:n,scales:s,units:r,timestamps:o,coordinateArrays:l}=i;return Ue({rank:e.length,valid:i.valid,ids:e.map(c=>t[c]),names:e.map(c=>n[c]),timestamps:e.map(c=>o[c]),scales:Float64Array.from(e,c=>s[c]),units:e.map(c=>r[c]),coordinateArrays:e.map(c=>l[c]),boundingBoxes:i.boundingBoxes.map(c=>XR(c,e,i.rank)).filter(c=>c!==void 0)})}function r1(i,e,t){return e===t?i:Sg(i,kP(i.rank,t,e))}function ib(i,e){const{transform:t,rank:n}=i,s=dh(t,n,[e]);if(s.length!==1)return;const[r]=s,o=Math.abs(t[(n+1)*r+e]),{inputSpace:l}=i;return{scale:l.scales[r]*o,unit:l.units[r]}}function sb(i,e){const{scales:t,units:n}=i.defaultInputSpace;return e<t.length?{scale:t[e],unit:n[e]}:void 0}function QR(i){const{rank:e}=i,{bounds:{lowerBounds:t,upperBounds:n}}=i;if(t.some(l=>l!==0))throw new Error("Lower bounds of channel coordinate space must all be 0");if(n.some(l=>!Number.isInteger(l)||l<=0||l>=2**32))throw new Error("Upper bounds of channel coordinate space must all be positive integers");const s=new Uint32Array(n),r=tv(s),o=new Uint32Array(r*e);for(let l=0;l<r;++l){let c=l;for(let u=0;u<e;++u){const h=c%s[u];c=(c-h)/s[u],o[l*e+u]=h}}return{channelCoordinateSpace:i,shape:s,numChannels:r,coordinates:o}}function hp(i,e,t,n,s,r){const{scales:o}=t,{scales:l,rank:c}=s,u=e+1;for(let h=0;h<c;++h){const g=r[h];if(g===-1)continue;const v=l[h];for(let y=0;y<e;++y){const b=n[y],w=o[b];i[u*y+g]*=w/v}}}function ZR(i,e,t,n,s=pa){const{inputSpace:r,rank:o,sourceRank:l,outputSpace:c,transform:u}=t,{names:h}=r,{names:g}=c;let v;if(n!==void 0)v=Array.from(n.modelSubspaceDimensionIndices);else{v=[];for(let B=0;B<l;++B)v[B]=B}const y=v.length;for(let B=l;B<o;++B)v.push(B);const b=dh(t.transform,o,v,!0),w=v.length,C=v.map(B=>h[B]||`${B}`),E=b.map(B=>g[B]);if(w!==b.length)return{error:"Rank mismatch between model subspace dimensions ("+C.join(", ")+") and corresponding layer/global dimensions ("+E.join(", ")+")"};let k=n1(Float32Array,u,o,b,v);const D=b.map(B=>g[B]),A=e.names.map(B=>D.indexOf(B)),N=i.names.map(B=>D.indexOf(B));hp(k,w,r,v,i,N),hp(k,w,r,v,e,A);const I=s.names.map(B=>D.indexOf(B));hp(k,w,r,v,s,I);const P=[],O=s.rank;if(n!==void 0){let{subsourceToModelSubspaceTransform:B}=n;y!==w&&(B=Xm(new Float32Array((w+1)**2),w,B,y)),k=ro(new Float32Array((w+1)**2),w+1,k,w+1,B,w+1,w+1,w+1,w+1)}const _=new Uint32Array(O),{lowerBounds:W,upperBounds:U,voxelCenterAtIntegerCoordinates:j}=s.bounds;for(let B=0;B<O;++B){let H=W[B],V=U[B];if(j[B]&&(H+=.5,V+=.5),H!==0||!Number.isInteger(V)||V<=0||V>=2**32)return{error:`Channel dimension ${s.names[B]} must have lower bound of 0 and positive integer upper bound; current bounds are [${H}, ${V}]`};_[B]=V;const re=I[B];let se=-1;if(re!==-1)for(let ve=0;ve<w;++ve){const me=k[re+ve*(w+1)];if(me!==0){if(me!==1||se!==-1)return{error:`Channel dimension ${E[re]} must map to a single source dimension`};se=ve}}P[B]=se}return{rank:w,unpaddedRank:y,modelDimensionNames:C,layerDimensionNames:E,localToRenderLayerDimensions:A,globalToRenderLayerDimensions:N,channelToRenderLayerDimensions:I,modelToRenderLayerTransform:k,channelToModelDimensions:P,channelSpaceShape:_}}function eN(i,e){return i===e?!0:i.error!==void 0||e.error!==void 0?!1:De(i.modelDimensionNames,e.modelDimensionNames)&&De(i.layerDimensionNames,e.layerDimensionNames)&&De(i.globalToRenderLayerDimensions,e.globalToRenderLayerDimensions)&&De(i.localToRenderLayerDimensions,e.localToRenderLayerDimensions)&&De(i.channelToRenderLayerDimensions,e.channelToRenderLayerDimensions)&&De(i.modelToRenderLayerTransform,e.modelToRenderLayerTransform)&&De(i.channelSpaceShape,e.channelSpaceShape)}function o1(i,e,t,n,s){return Ht((r,o,l,c)=>ZR(r,o,l,n,c),[i,e,t,s===void 0?ar(void 0):s],eN)}function tN(i,e,t,n){const{globalToRenderLayerDimensions:s}=t;for(let r=0;r<3;++r){let o=0;const l=n[r];if(l!==-1){const c=s[l];c!==-1&&(o=e[c])}i[r]=o}}function nN(i,e,t,n){const{globalToRenderLayerDimensions:s}=t;for(let r=0;r<3;++r){const o=n[r];if(o!==-1){const l=s[o];l!==-1&&(i[l]=e[r])}}}function hh(i,e){const t=i.rank,n=i.unpaddedRank;let s;n!==t&&e!==void 0&&(e=Xm(new Float32Array((t+1)**2),t,e,n)),e!==void 0?(s=new Float32Array((t+1)*(t+1)),ro(s,t+1,i.modelToRenderLayerTransform,t+1,e,t+1,t+1,t+1,t+1)):s=i.modelToRenderLayerTransform;const r=new Float32Array((t+1)*(t+1)),o=Qm(r,t+1,s,t+1,t+1);if(o===0)throw new Error("Transform is singular");const{globalToRenderLayerDimensions:l,localToRenderLayerDimensions:c,channelToRenderLayerDimensions:u}=i,h=l.length,g=c.length,v=h+g,y=new Float32Array((v+1)*t);for(let N=0;N<t;++N){for(let I=0;I<h;++I){const P=l[I];P!==-1&&(y[N+I*t]=r[N+P*(t+1)])}for(let I=0;I<g;++I){const P=c[I];P!==-1&&(y[N+(h+I)*t]=r[N+P*(t+1)])}y[N+v*t]=r[N+t*(t+1)]}const b=u.length,w=new Array(b),C=[];for(let N=0;N<b;++N){const I=u[N];let P=-1;if(I!==-1){for(let O=0;O<t;++O){const _=s[I+O*(t+1)];if(_!==0){if(_!==1||P!==-1)throw new Error(`Channel dimension ${i.layerDimensionNames[I]} must map with stride 1 to a single data chunk dimensions`);P=O}}if(P!==-1){const O=s[I+t*(t+1)];if(O!==0&&O!==-.5)throw new Error(`Channel dimension ${i.layerDimensionNames[I]} must have an offset of 0 in the chunk coordinate space; current offset is ${O}`);C.push(P)}}w[N]=P}const{channelSpaceShape:E}=i,k=tv(E),D=C.length,A=new Uint32Array(k*D);for(let N=0;N<k;++N){let I=N,P=0;for(let O=0;O<b;++O){const _=I%E[O];I=(I-_)/E[O],w[O]!==-1&&(A[N*D+P]=_,++P)}}return{layerRank:t,modelTransform:i,chunkToLayerTransform:s,layerToChunkTransform:r,chunkToLayerTransformDet:o,combinedGlobalLocalRank:v,combinedGlobalLocalToChunkTransform:y,channelToChunkDimensionIndices:w,chunkChannelDimensionIndices:C,numChannels:k,chunkChannelCoordinates:A,channelSpaceShape:E}}function a1(i,e){const{globalToRenderLayerDimensions:t}=i,n=[],s=[];for(let r=0;r<3;++r){const o=e[r];if(o===-1)continue;const l=t[o];s.push(l),l!==-1&&n.push(l)}for(let r=s.length;r<3;++r)s[r]=-1;return{layerDisplayDimensionIndices:n,displayToLayerDimensionIndices:s}}function l1(i,e){const{chunkToLayerTransform:t,modelTransform:n}=i,s=n.rank,{layerDisplayDimensionIndices:r,displayToLayerDimensionIndices:o}=e,l=r.length,c=dh(t,s,r);if(c.length!==l){const{modelDimensionNames:g,layerDimensionNames:v}=n;throw new Error(`Rank mismatch between displayed layer dimensions (${Array.from(r,y=>v[y]).join(", ")}) and corresponding chunk dimensions (${Array.from(c,y=>g[y]).join(", ")})`)}const u=Ve();for(let g=0;g<3;++g){const v=o[g];if(v!==-1){for(let y=0;y<l;++y){const b=c[y];u[y*4+g]=t[b*(s+1)+v]}u[12+g]=t[s*(s+1)+v]}}const h=Ve();ur(h,u);for(let g=c.length;g<3;++g)c[g]=-1;return{modelTransform:i.modelTransform,chunkTransform:i,displaySubspaceModelMatrix:u,displaySubspaceInvModelMatrix:h,chunkDisplayDimensionIndices:c,numChunkDisplayDims:l}}function ga(i,e,t,n,s){const r=e.length,o=t.length,l=i.length;let c=!0;for(let u=0;u<n;++u){let h=u,g=0;for(let v=0;v<r;++v)g+=s[h+v*n]*e[v];h+=r*n;for(let v=0;v<o;++v)g+=s[h+v*n]*t[v];g+=s[h+o*n],u<l?i[u]=g:(g<0||g>=1)&&(c=!1)}return c}function iN(i,e,t){i.fill(0),i[15]=1;let n=!0;const{displayDimensionIndices:s}=e,{globalToRenderLayerDimensions:r,modelToRenderLayerTransform:o}=t,l=t.rank;for(let c=0;c<3;++c){const u=s[c];if(u===-1){n=!1;continue}const h=r[u];if(h===-1){n=!1;continue}i[c+12]=o[h+l*(l+1)];for(let g=0;g<3;++g)i[c+4*g]=o[h+(l+1)*g]}if(!n){const{globalDimensionNames:c}=e,u=Array.from(s.filter(h=>h!==-1),h=>c[h]).join(", ");throw new Error(`Transform from model dimensions (${t.modelDimensionNames.join(", ")}) to display dimensions (${u}) does not have full rank`)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var je=(i=>(i[i.GPU_MEMORY=0]="GPU_MEMORY",i[i.SYSTEM_MEMORY=1]="SYSTEM_MEMORY",i[i.SYSTEM_MEMORY_WORKER=2]="SYSTEM_MEMORY_WORKER",i[i.DOWNLOADING=3]="DOWNLOADING",i[i.QUEUED=4]="QUEUED",i[i.NEW=5]="NEW",i[i.FAILED=6]="FAILED",i[i.EXPIRED=7]="EXPIRED",i))(je||{});const c1=8;var tr=(i=>(i[i.FIRST_TIER=0]="FIRST_TIER",i[i.FIRST_ORDERED_TIER=0]="FIRST_ORDERED_TIER",i[i.VISIBLE=0]="VISIBLE",i[i.PREFETCH=1]="PREFETCH",i[i.LAST_ORDERED_TIER=1]="LAST_ORDERED_TIER",i[i.RECENT=2]="RECENT",i[i.LAST_TIER=2]="LAST_TIER",i))(tr||{});const d1=3;var bg=(i=>(i[i.totalTime=0]="totalTime",i[i.totalChunks=1]="totalChunks",i))(bg||{}),nr=(i=>(i[i.numChunks=0]="numChunks",i[i.systemMemoryBytes=1]="systemMemoryBytes",i[i.gpuMemoryBytes=2]="gpuMemoryBytes",i))(nr||{});const ir=3;function Or(i,e){return i*d1+e}function rb(i){return c1*d1*ir+i}const sN="ChunkQueueManager",rN="ChunkManager",oN="ChunkSource.invalidate",aN="ChunkQueueManager.requestChunkStatistics",lN="ChunkManager.chunkLayerStatistics";class fh{constructor(){this.numVisibleChunksNeeded=0,this.numVisibleChunksAvailable=0,this.numPrefetchChunksNeeded=0,this.numPrefetchChunksAvailable=0}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function et(i){let e=-1;return Object.assign(()=>{e===-1&&(e=requestAnimationFrame(()=>{e=-1,i()}))},{flush:()=>{e!==-1&&(e=-1,i())},cancel:()=>{e!==-1&&(cancelAnimationFrame(e),e=-1)}})}class u1{constructor(){this.map=new Map}get(e,t){const{map:n}=this;let s=n.get(e);return s===void 0?(s=t(),s.registerDisposer(()=>{n.delete(e)}),n.set(e,s)):s.addRef(),s}}class h1 extends u1{get(e,t){return typeof e!="string"&&(e=Qn(e)),super.get(e,t)}getUncounted(e,t){return this.get(e,()=>new cx(t())).value}}function cN(i){const e={antialias:!1,stencil:!0},t=i.getContext("webgl2",e);if(t==null)throw new Error("WebGL not supported.");t.memoize=new u1,t.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),t.max3dTextureSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.maxTextureImageUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.tempTextureUnit=t.maxTextureImageUnits-1;for(const n of["EXT_color_buffer_float"])if(!t.getExtension(n))throw new Error(`${n} extension not available`);for(const n of["EXT_float_blend"])t.getExtension(n);return t}class av{constructor(){this.width=0,this.height=0,this.logicalWidth=0,this.logicalHeight=0,this.visibleLeftFraction=0,this.visibleTopFraction=0,this.visibleWidthFraction=0,this.visibleHeightFraction=0}}function f1(i,e){const t=1/i.visibleWidthFraction,n=1/i.visibleHeightFraction,s=-1-(-1+2*i.visibleLeftFraction)*t;let r=-1-(-1+2*i.visibleTopFraction)*n;r=-r,e[0]=e[0]*t+e[3]*s,e[4]=e[4]*t+e[7]*s,e[8]=e[8]*t+e[11]*s,e[12]=e[12]*t+e[15]*s,e[1]=e[1]*n+e[3]*r,e[5]=e[5]*n+e[7]*r,e[9]=e[9]*n+e[11]*r,e[13]=e[13]*n+e[15]*r}function p1(i,e){return i.width===e.width&&i.height===e.height&&i.logicalWidth===e.logicalWidth&&i.logicalHeight===e.logicalHeight&&i.visibleLeftFraction===e.visibleLeftFraction&&i.visibleTopFraction===e.visibleTopFraction}class g1 extends K{constructor(e,t,n){super(),this.context=e,this.element=t,this.visibility=n,this.boundsGeneration=-1,this.canvasRelativeClippedLeft=0,this.canvasRelativeClippedTop=0,this.canvasRelativeLogicalLeft=0,this.canvasRelativeLogicalTop=0,this.renderViewport=new av,this.monitorState={},this.gl=e.gl,e.addPanel(this)}scheduleRedraw(){this.visible&&this.context.scheduleRedraw()}ensureBoundsUpdated(){const{context:e}=this;e.ensureBoundsUpdated();const{boundsGeneration:t}=e;if(t===this.boundsGeneration)return;this.boundsGeneration=t;const{element:n}=this,s=n.getBoundingClientRect();e.ensureMonitorPanel(n,this.monitorState,s);const r=e.container,o=e.canvasRect,{canvas:l}=e,{width:c,height:u}=l,h=c/o.width,g=u/o.height,v=o.left,y=o.top,b=this.canvasRelativeLogicalLeft=Math.round((s.left-v)*h+n.clientLeft),w=this.canvasRelativeLogicalTop=Math.round((s.top-y)*g+n.clientTop),C=n.clientWidth,E=n.clientHeight,k=b+C,D=w+E;let A=w,N=b,I=k,P=D;for(let U=n.parentElement;U!==null&&U!==r;U=U.parentElement){const j=U.getBoundingClientRect();j.x===0&&j.y===0&&j.width===0&&j.height===0||(N=Math.max(N,(j.left-v)*h),A=Math.max(A,(j.top-y)*g),I=Math.min(I,(j.right-v)*h),P=Math.min(P,(j.bottom-y)*g))}A=this.canvasRelativeClippedTop=Math.round(Math.max(A,0)),N=this.canvasRelativeClippedLeft=Math.round(Math.max(N,0)),I=Math.round(Math.min(I,c)),P=Math.round(Math.min(P,u));const O=this.renderViewport,_=O.width=Math.max(0,I-N),W=O.height=Math.max(0,P-A);O.logicalWidth=C,O.logicalHeight=E,O.visibleLeftFraction=(N-b)/C,O.visibleTopFraction=(A-w)/E,O.visibleWidthFraction=_/C,O.visibleHeightFraction=W/E}setGLClippedViewport(){const{gl:e,canvasRelativeClippedTop:t,canvasRelativeClippedLeft:n,renderViewport:{width:s,height:r}}=this,o=t+r;e.enable(WebGL2RenderingContext.SCISSOR_TEST);const l=this.context.canvas.height-o;e.viewport(n,l,s,r),e.scissor(n,l,s,r)}setGLLogicalViewport(){const{gl:e,renderViewport:{width:t,height:n,logicalWidth:s,logicalHeight:r}}=this,o=this.context.canvas.height;e.enable(WebGL2RenderingContext.SCISSOR_TEST),e.viewport(this.canvasRelativeLogicalLeft,o-(this.canvasRelativeLogicalTop+r),s,r),e.scissor(this.canvasRelativeClippedLeft,o-(this.canvasRelativeClippedTop+n),t,n)}disposed(){this.context.unmonitorPanel(this.element,this.monitorState),this.context.removePanel(this),super.disposed()}get visible(){return this.visibility.visible}getDepthArray(){}get shouldDraw(){if(!this.visible)return!1;const{element:e}=this;return!(e.clientWidth===0||e.clientHeight===0||e.offsetWidth===0||e.offsetHeight===0)}get drawOrder(){return 0}}class m1 extends g1{constructor(e,t,n){super(e,t,n),this.canvas=document.createElement("canvas"),this.canvasRenderingContext=this.canvas.getContext("2d");const{canvas:s}=this;t.appendChild(s),t.style.position="relative",s.style.position="absolute",s.style.left="0",s.style.right="0",s.style.top="0",s.style.bottom="0"}draw(){this.drawIndirect();const{renderViewport:e,canvas:t}=this,{logicalWidth:n,logicalHeight:s}=e;t.width=n,t.height=s;const{canvasRenderingContext:r}=this;r==null||r.drawImage(this.context.canvas,this.canvasRelativeLogicalLeft,this.canvasRelativeLogicalTop,n,s,0,0,n,s)}}class dN extends bt{constructor(){super(Float64Array.of(0,0,1,1),e=>_e(new Float64Array(4),e,Nx))}toJSON(){const{value:e}=this,[t,n,s,r]=e;if(!(t===0&&n===0&&s===1&&r===1))return Array.from(e)}}class uN extends K{constructor(e){super(),this.container=e,this.canvas=document.createElement("canvas"),this.updateStarted=new ue,this.updateFinished=new ue,this.changed=this.updateFinished,this.panels=new Set,this.resizeGeneration=0,this.boundsGeneration=-1,this.orderedPanels=[],this.frameNumber=0,this.resizeCallback=()=>{++this.resizeGeneration,this.scheduleRedraw()},this.resizeObserver=new ResizeObserver(this.resizeCallback),this.scheduleRedraw=this.registerCancellable(et(()=>this.draw()));const{canvas:t,resizeObserver:n}=this;e.style.position="relative",t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width="100%",t.style.height="100%",t.style.zIndex="0",n.observe(t),e.appendChild(t),this.registerEventListener(t,"webglcontextlost",s=>{console.log(`Lost WebGL context: ${s.statusMessage}`),s.preventDefault()}),this.registerEventListener(t,"webglcontextrestored",()=>{console.log("WebGL context restored"),window.location.reload()}),this.gl=cN(t)}ensureMonitorPanel(e,t,n){var h;t.addedToResizeObserver||(this.resizeObserver.observe(e),t.addedToResizeObserver=!0);const s=this.rootRect,r=s.top-n.top,o=s.left-n.left,l=n.right-s.right,c=n.bottom-s.bottom,u=`${r}px ${l}px ${c}px ${o}px`;t.intersectionObserverMargin!==u&&(t.intersectionObserverMargin=u,(h=t.intersectionObserver)==null||h.disconnect(),(t.intersectionObserver=new IntersectionObserver(this.resizeCallback,{root:this.container,rootMargin:u,threshold:[.99,1]})).observe(e))}unmonitorPanel(e,t){var n;t.addedToResizeObserver&&this.resizeObserver.unobserve(e),(n=t.intersectionObserver)==null||n.disconnect()}applyWindowedViewportToElement(e,t){const[n,s,r,o]=t,l=1/r,c=1/o;e.style.position="absolute",e.style.top=`${-c*s*100}%`,e.style.left=`${-l*n*100}%`,e.style.width=`${l*100}%`,e.style.height=`${c*100}%`,++this.resizeGeneration,this.scheduleRedraw()}isReady(){for(const e of this.panels)if(e.visible&&!e.isReady())return!1;return!0}makeCanvasOverlayElement(){const e=document.createElement("div");return e.style.position="absolute",e.style.top="0px",e.style.left="0px",e.style.width="100%",e.style.height="100%",e.style.zIndex="2",this.container.appendChild(e),e}disposed(){this.orderedPanels.length=0,this.resizeObserver.disconnect()}addPanel(e){this.panels.add(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}removePanel(e){this.panels.delete(e),this.orderedPanels.length=0,++this.resizeGeneration,this.scheduleRedraw()}ensureBoundsUpdated(){const{resizeGeneration:e}=this;if(this.boundsGeneration===e)return;const{canvas:t}=this;t.width=t.offsetWidth,t.height=t.offsetHeight,this.canvasRect=t.getBoundingClientRect(),this.rootRect=this.container.getBoundingClientRect(),this.boundsGeneration=e}draw(){++this.frameNumber,this.updateStarted.dispatch();const e=this.gl;this.ensureBoundsUpdated(),this.gl.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const{orderedPanels:t,panels:n}=this;t.length!==n.size&&(t.push(...n),t.sort((s,r)=>s.drawOrder-r.drawOrder));for(const s of t){if(!s.shouldDraw)continue;s.ensureBoundsUpdated();const{renderViewport:r}=s;r.width===0||r.height===0||s.draw()}e.disable(e.SCISSOR_TEST),this.gl.clearColor(1,1,1,1),this.gl.colorMask(!1,!1,!1,!0),e.clear(e.COLOR_BUFFER_BIT),this.gl.colorMask(!0,!0,!0,!0),this.updateFinished.dispatch()}getDepthArray(){const{width:e,height:t}=this.canvas,n=new Float32Array(e*t);for(const s of this.panels){if(!s.shouldDraw)continue;const r=s.getDepthArray();if(r===void 0)continue;const{canvasRelativeClippedTop:o,canvasRelativeClippedLeft:l,renderViewport:{width:c,height:u}}=s;for(let h=0;h<u;++h){const g=(u-1-h)*c;n.set(r.subarray(g,g+c),(o+h)*c+l)}}return n}}class v1 extends av{constructor(){super(...arguments),this.globalPosition=fa,this.projectionMat=Ve(),this.viewMatrix=Ve(),this.invViewMatrix=Ve(),this.viewProjectionMat=Ve(),this.invViewProjectionMat=Ve()}}function hN(i,e){return i.displayDimensionRenderInfo===e.displayDimensionRenderInfo&&p1(i,e)&&De(i.globalPosition,e.globalPosition)&&De(i.projectionMat,e.projectionMat)&&De(i.viewMatrix,e.viewMatrix)}function y1(i){const{viewMatrix:e,viewProjectionMat:t}=i;ur(e,i.invViewMatrix),zt(t,i.projectionMat,e),ur(i.invViewProjectionMat,t)}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fN="rendered_view.addLayer",pN="rendered_view.removeLayer",gN="SharedProjectionParameters",mN="SharedProjectionParameters.changed";var ws=(i=>(i[i.info=0]="info",i[i.warning=1]="warning",i[i.error=2]="error",i))(ws||{});class oo{constructor(){this.changed=new ue,this.messages=[],this.children=[]}addMessage(e){this.messages.push(e),this.changed.dispatch()}clearMessages(){const{messages:e}=this;e.length!==0&&(e.length=0,this.changed.dispatch())}isEmpty(){return this.messages.length===0&&!this.children.some(e=>!e.isEmpty())}addChild(e){return this.children.push(e),e.changed.add(this.changed.dispatch),e.isEmpty()||this.changed.dispatch(),()=>{const{children:t}=this;t.splice(t.indexOf(e),1),e.changed.remove(this.changed.dispatch),e.isEmpty()||this.changed.dispatch()}}*[Symbol.iterator](){yield*this.messages;for(const e of this.children)yield*e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vN extends Error{constructor(){super(...arguments),this.name="CancellationError",this.message="CANCELED"}toString(){return"CANCELED"}}const Hi=new vN;function yN(i){if(i.isCanceled===!0)throw Hi}const wg=()=>{},pt={isCanceled:!1,add:()=>wg,remove:wg};class Sr{cancel(){const{handlers:e}=this;if(e!==null&&(this.handlers=null,e!==void 0))for(const t of e)t()}get isCanceled(){return this.handlers===null}add(e){let{handlers:t}=this;return t===null?(e(),wg):(t===void 0&&(t=this.handlers=new Set),t.add(e),()=>{this.remove(e)})}remove(e){const{handlers:t}=this;t!=null&&t.delete(e)}}class SN extends Sr{constructor(){super(...arguments),this.consumers=new Set}addConsumer(e=pt){const{consumers:t}=this;t.has(e)||e.isCanceled||(t.add(e),e.add(()=>{t.delete(e),t.size===0&&this.cancel()}))}}function bN(i,e){return new Promise((t,n)=>{if(i===pt){e(t,n,pt);return}const s=new Sr,r=i.add(()=>{s.cancel()});e(o=>{r(),t(o)},o=>{r(),n(o)},s)})}const S1=!(typeof Window<"u"&&self instanceof Window),Cg="rpc.promise.response",b1="rpc.promise.cancel",w1=new Map;function Rt(i,e){w1.set(i,e)}class wN extends Error{constructor(e,t){super(t),this.name=e,this.message=t}}function C1(i,e){Rt(i,function(t){const n=t.id,s=new Sr,r=e.call(this,t,s);this.set(n,{promise:r,cancellationToken:s}),r.then(({value:o,transfers:l})=>{this.delete(n),this.invoke(Cg,{id:n,value:o},l)},o=>{this.delete(n),this.invoke(Cg,{id:n,error:o.message,errorName:o.name})})})}Rt(b1,function(i){const e=i.id,t=this.get(e);if(t!==void 0){const{cancellationToken:n}=t;n.cancel()}});Rt(Cg,function(i){const e=i.id,{resolve:t,reject:n}=this.get(e);this.delete(e),Object.prototype.hasOwnProperty.call(i,"value")?t(i.value):i.errorName===Hi.name?n(Hi):n(new wN(i.errorName,i.error))});const CN=S1?-1:0;class xN{constructor(e){this.target=e,this.objects=new Map,this.nextId=CN,e.onmessage=t=>{const n=t.data;w1.get(n.functionName).call(this,n)}}get numObjects(){return this.objects.size}set(e,t){this.objects.set(e,t)}delete(e){this.objects.delete(e)}get(e){return this.objects.get(e)}getRef(e){const t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}getOptionalRef(e){if(e===void 0)return;const t=e.id,n=this.get(t);return n.referencedGeneration=e.gen,n.addRef(),n}invoke(e,t,n){t.functionName=e,this.target.postMessage(t,n)}promiseInvoke(e,t,n=pt,s){return bN(n,(r,o,l)=>{const c=t.id=this.newId();this.set(c,{resolve:r,reject:o}),this.invoke(e,t,s),l.add(()=>{this.invoke(b1,{id:c})})})}newId(){return S1?this.nextId--:this.nextId++}}class Ii extends K{constructor(){super(...arguments),this.rpc=null,this.rpcId=null}initializeSharedObject(e,t=e.newId()){this.rpc=e,this.rpcId=t,this.isOwner=!1,e.set(t,this)}initializeCounterpart(e,t={}){this.initializeSharedObject(e),this.unreferencedGeneration=0,this.referencedGeneration=0,this.isOwner=!0,t.id=this.rpcId,t.type=this.RPC_TYPE_ID,e.invoke("SharedObject.new",t)}dispose(){super.dispose()}addCounterpartRef(){return{id:this.rpcId,gen:++this.referencedGeneration}}refCountReachedZero(){this.isOwner===!0?this.referencedGeneration===this.unreferencedGeneration&&this.ownerDispose():this.isOwner===!1?this.rpc.invoke("SharedObject.refCountReachedZero",{id:this.rpcId,gen:this.referencedGeneration}):super.refCountReachedZero()}ownerDispose(){const{rpc:e,rpcId:t}=this;super.refCountReachedZero(),e.delete(t),e.invoke("SharedObject.dispose",{id:t})}counterpartRefCountReachedZero(e){this.unreferencedGeneration=e,this.refCount===0&&e===this.referencedGeneration&&this.ownerDispose()}}function EN(i,e,t={}){e!=null&&i.initializeSharedObject(e,t.id)}class ph extends Ii{constructor(e,t={}){super(),EN(this,e,t)}}Rt("SharedObject.dispose",function(i){const e=this.get(i.id);if(e.refCount!==0)throw new Error("Attempted to dispose object with non-zero reference count.");e.disposed(),this.delete(e.rpcId),e.rpcId=null,e.rpc=null});Rt("SharedObject.refCountReachedZero",function(i){const e=this.get(i.id),t=i.gen;e.counterpartRefCountReachedZero(t)});const x1=new Map;function li(i){return e=>{e.prototype.RPC_TYPE_ID=i}}function gh(i){return e=>{if(i!==void 0)e.prototype.RPC_TYPE_ID=i;else if(i=e.prototype.RPC_TYPE_ID,i===void 0)throw new Error("RPC_TYPE_ID should have already been defined");x1.set(i,e)}}Rt("SharedObject.new",function(i){const e=this,t=i.type,n=x1.get(t),s=new n(e,i);--s.refCount});var TN=Object.defineProperty,kN=Object.getOwnPropertyDescriptor,LN=(i,e,t,n)=>{for(var s=n>1?void 0:n?kN(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&TN(e,t,s),s};const E1="SharedWatchableValue.changed";let Tt=class extends ph{constructor(i,e={}){super(i,e),this.updatingValue_=!1,i!==void 0&&(this.base=new Ne(e.value),this.setupChangedHandler())}initializeCounterpart(i,e={}){e.value=this.value,super.initializeCounterpart(i,e)}setupChangedHandler(){this.registerDisposer(this.base.changed.add(()=>{if(this.updatingValue_)this.updatingValue_=!1;else{const{rpc:i}=this;i!==null&&i.invoke(E1,{id:this.rpcId,value:this.value})}}))}static makeFromExisting(i,e){const t=new Tt;return t.base=e,t.setupChangedHandler(),t.initializeCounterpart(i),t}static make(i,e){return Tt.makeFromExisting(i,new Ne(e))}get value(){return this.base.value}set value(i){this.base.value=i}get changed(){return this.base.changed}};Tt=LN([gh("SharedWatchableValue")],Tt);Rt(E1,function(i){const e=this.get(i.id);e.updatingValue_=!0,e.base.value=i.value,e.updatingValue_=!1});const eh=class eh extends Ne{constructor(e=Number.NEGATIVE_INFINITY){super(e)}get visible(){return this.value===Number.POSITIVE_INFINITY}get ignored(){return this.value===Number.NEGATIVE_INFINITY}};eh.VISIBLE=Number.POSITIVE_INFINITY,eh.IGNORED=Number.NEGATIVE_INFINITY;let Pt=eh;class Yl extends Pt{constructor(){super(...arguments),this.contributors=new Map}add(e){const{contributors:t}=this,n=e.changed.add(()=>{this.update()}),s=()=>{t.delete(s),n(),this.update()};return t.set(s,e),this.update(),s}update(){let e=Number.NEGATIVE_INFINITY;for(const t of this.contributors.values())e=Math.max(e,t.value);this.value=e}}function Ac(i){return class extends i{constructor(){super(...arguments),this.visibility=new Yl}initializeCounterpart(e,t={}){t.visibility=this.registerDisposer(Tt.makeFromExisting(e,this.visibility)).rpcId,super.initializeCounterpart(e,t)}}}var DN=Object.defineProperty,IN=Object.getOwnPropertyDescriptor,PN=(i,e,t,n)=>{for(var s=n>1?void 0:n?IN(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&DN(e,t,s),s},fr=(i=>(i[i.DATA=0]="DATA",i[i.ANNOTATION=1]="ANNOTATION",i[i.DEFAULT_ANNOTATION=2]="DEFAULT_ANNOTATION",i))(fr||{});function AN(){return new Xp([0,1,2])}class T1 extends K{constructor(){super(...arguments),this.role=0,this.messages=new oo,this.layerChanged=new ue,this.redrawNeeded=new ue,this.layerChunkProgressInfo=new fh}handleAction(e){}getValueAt(e){}transformPickedValue(e){return e.pickedValue}updateMouseState(e,t,n,s){}}class k1 extends T1{constructor(){super(...arguments),this.visibility=new Yl}attach(e){}}function ql(i,e,t){let{state:n}=t;if(n===void 0||n.transform!==i||n.displayDimensionRenderInfo!==e){if(t.messages.clearMessages(),n=t.state={transform:i,displayDimensionRenderInfo:e,modelTransform:void 0},i.error!==void 0){t.messages.addMessage({severity:ws.error,message:i.error});return}try{const s=Ve();iN(s,e,i),n.modelTransform=s}catch(s){t.messages.addMessage({severity:ws.error,message:s.message})}}return n.modelTransform}class L1 extends K{constructor(e){super(),this.renderViewport=new av,this.changed=new Ze;const{parametersConstructor:t=v1,navigationState:n,update:s,isEqual:r=hN}=e;this.oldValue_=new t,this.value_=new t;const o=()=>{const{oldValue_:c,value_:u}=this;c.displayDimensionRenderInfo=n.displayDimensionRenderInfo.value,Object.assign(c,this.renderViewport);let{globalPosition:h}=c;const g=n.position.value,v=g.length;h.length!==v&&(c.globalPosition=h=new Float32Array(v)),h.set(g),s(c,n),!r(c,u)&&(this.value_=c,this.oldValue_=u,this.changed.dispatch(u,c))},l=this.update=this.registerCancellable(ze(o,0));this.registerDisposer(n.changed.add(l)),o()}setViewport(e){p1(e,this.renderViewport)||(Object.assign(this.renderViewport,e),this.update())}get value(){return this.update.flush(),this.value_}}let yu=class extends Ii{constructor(i,e,t=10){super(),this.base=e,this.updateInterval=t,this.prevDisplayDimensionRenderInfo=void 0,this.update=this.registerCancellable(ze((n,s)=>{let r;if(s.displayDimensionRenderInfo!==this.prevDisplayDimensionRenderInfo)r=s,this.prevDisplayDimensionRenderInfo=s.displayDimensionRenderInfo;else{const{displayDimensionRenderInfo:o,...l}=s;r=l}this.rpc.invoke(mN,{id:this.rpcId,value:r})},this.updateInterval)),this.initializeCounterpart(i,{value:e.value}),this.registerDisposer(e.changed.add(this.update))}flush(){this.update.flush()}};yu=PN([li(gN)],yu);class ut{constructor(e,t=e){this.value_=e,this.defaultValue=t,this.changed=new ue}get value(){return this.value_}set value(e){e!==this.value_&&(this.value_=e,this.changed.dispatch())}toggle(){this.value=!this.value}toJSON(){const{value_:e}=this;if(e!==this.defaultValue)return this.value_}restoreState(e){if(e===!0||e===!1){this.value=e;return}this.value=this.defaultValue}reset(){this.value=this.defaultValue}}class Es extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("input");const{element:n}=this;n.type="checkbox";const s=()=>{const r=this.model.value;this.element.checked=r,(t.enableTitle!==void 0||t.disableTitle!==void 0)&&(this.element.title=(r?t.enableTitle:t.disableTitle)??"")};this.registerDisposer(e.changed.add(s)),s(),this.registerEventListener(n,"change",function(r){e.value=this.checked}),n.addEventListener("mousedown",r=>{r.preventDefault()})}disposed(){const{element:e}=this,{parentElement:t}=e;t&&t.removeChild(e),super.disposed()}}class Wn extends K{constructor(e,t){super(),this.model=e,this.element=t,this.initialDisplay=this.element.style.display,this.updateVisibility(),this.registerDisposer(e.changed.add(this.registerCancellable(ze(()=>this.updateVisibility(),0))))}updateVisibility(){this.element.style.display=this.model.value?this.initialDisplay:"none"}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function mh(i){try{return i()}catch(e){return{error:e.message}}}function lv(i){if(i.error!==void 0)throw new Error(i.error);return i}class cv extends K{constructor(e,t){if(super(),this.register=e,this.changed=new ue,this.disposerMap=new Map,t===void 0)this.map=new Map;else{const n=this.map=new Map(t),{disposerMap:s}=this;for(const[r,o]of n){const l=new K;s.set(r,l),e(l,o,r)}}}get value(){return this.map}set(e,t){const{map:n,disposerMap:s}=this;let r=s.get(e);return r!==void 0&&r.dispose(),r=new K,s.set(e,r),n.set(e,t),this.register(r,t,e),this.changed.dispatch(),this}delete(e){const{map:t,disposerMap:n}=this,s=n.get(e);return s!==void 0?(s.dispose(),n.delete(e),t.delete(e),this.changed.dispatch(),!0):!1}get(e){return this.map.get(e)}has(e){return this.map.has(e)}get size(){return this.map.size}[Symbol.iterator](){return this.map[Symbol.iterator]()}clear(){const{map:e,disposerMap:t}=this;if(e.size>0){for(const n of t.values())n.dispose();e.clear(),t.clear(),this.changed.dispatch()}}values(){return this.map.values()}keys(){return this.map.keys()}disposed(){const{map:e,disposerMap:t}=this;for(const n of t.values())n.dispose();e.clear(),t.clear(),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const ob=Symbol("objectId");let RN=0;function jt(i){if(i instanceof Object){let e=i[ob];return e===void 0&&(e=i[ob]=RN++),`o${e}`}return""+JSON.stringify(i)}var D1=(i=>(i[i.VERTEX=WebGL2RenderingContext.VERTEX_SHADER]="VERTEX",i[i.FRAGMENT=WebGL2RenderingContext.FRAGMENT_SHADER]="FRAGMENT",i))(D1||{});function NN(i){i=i.replace("\0","");const e=[];for(let t of i.split(`
`)){let n=t.match(/^ERROR:\s*(\d+):(\d+)\s*(.+)$/);n!==null?e.push({message:n[3].trim(),file:parseInt(n[1],10),line:parseInt(n[2],10)}):(n=t.match(/^ERROR:\s*(.+)$/),n!==null?e.push({message:n[1]}):(t=t.trim(),t&&e.push({message:t})))}return e}class MN extends Error{constructor(e,t,n,s){const r=`Error compiling ${D1[e].toLowerCase()} shader: ${n}`;super(r),this.name="ShaderCompilationError",this.log=n,this.message=r,this.shaderType=e,this.source=t,this.errorMessages=s}}class ON extends Error{constructor(e,t,n){const s=`Error linking shader: ${n}`;super(s),this.name="ShaderLinkError",this.log=n,this.message=s,this.vertexSource=e,this.fragmentSource=t}}function ab(i,e,t){const n=i.createShader(t);if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS)){const s=i.getShaderInfoLog(n)||"";throw new MN(t,e,s,NN(s))}return n}class _N extends K{constructor(e,t,n,s,r,o){super(),this.gl=e,this.vertexSource=t,this.fragmentSource=n,this.attributes=new Map,this.uniforms=new Map,this.vertexShaderInputBinders={};const l=this.vertexShader=ab(e,t,e.VERTEX_SHADER),c=this.fragmentShader=ab(e,n,e.FRAGMENT_SHADER),u=e.createProgram();if(e.attachShader(u,l),e.attachShader(u,c),e.linkProgram(u),!e.getProgramParameter(u,e.LINK_STATUS)){const v=e.getProgramInfoLog(u)||"";throw new ON(t,n,v)}this.program=u;const{uniforms:h,attributes:g}=this;if(s)for(const v of s)h.set(v,e.getUniformLocation(u,v));if(r)for(const v of r)g.set(v,e.getAttribLocation(u,v))}uniform(e){return this.uniforms.get(e)}attribute(e){return this.attributes.get(e)}textureUnit(e){return this.textureUnits.get(e)}bind(){this.gl.useProgram(this.program)}disposed(){const{gl:e}=this;e.deleteShader(this.vertexShader),this.vertexShader=void 0,e.deleteShader(this.fragmentShader),this.fragmentShader=void 0,e.deleteProgram(this.program),this.program=void 0,this.gl=void 0,this.attributes=void 0,this.uniforms=void 0}}function VN(i,e,t,n,s){i.drawArraysInstanced(e,t,n,s)}class lb{constructor(){this.code="",this.parts=new Set}add(e){if(!this.parts.has(e))switch(this.parts.add(e),typeof e){case"string":this.code+=e;break;case"function":this.add(e());break;default:if(Array.isArray(e))for(const t of e)this.add(t);else throw console.log("Invalid code type",e),new Error("Invalid code type")}}toString(){return this.code}}const Kl={sampler2D:WebGL2RenderingContext.TEXTURE_2D,isampler2D:WebGL2RenderingContext.TEXTURE_2D,usampler2D:WebGL2RenderingContext.TEXTURE_2D,sampler3D:WebGL2RenderingContext.TEXTURE_3D,isampler3D:WebGL2RenderingContext.TEXTURE_3D,usampler3D:WebGL2RenderingContext.TEXTURE_3D};class pr{constructor(e){this.gl=e,this.nextSymbolID=0,this.nextTextureUnit=0,this.uniformsCode="",this.attributesCode="",this.varyingsCodeVS="",this.varyingsCodeFS="",this.fragmentExtensionsSet=new Set,this.fragmentExtensions="",this.vertexCode=new lb,this.vertexMain="",this.fragmentCode=new lb,this.outputBufferCode="",this.fragmentMain="",this.required=new Set,this.uniforms=new Array,this.attributes=new Array,this.initializers=[],this.textureUnits=new Map,this.vertexDebugOutputs=[]}addVertexPositionDebugOutput(){this.vertexDebugOutputs.push({typeName:"vec4",name:"gl_Position"})}addVertexDebugOutput(e,t){this.addVarying(e,t),this.vertexDebugOutputs.push({typeName:e,name:t})}allocateTextureUnit(e,t=1){if(this.textureUnits.has(e))throw new Error("Duplicate texture unit symbol: "+e.toString());const n=this.nextTextureUnit;return this.nextTextureUnit+=t,this.textureUnits.set(e,n),n}addTextureSampler(e,t,n,s){const r=this.allocateTextureUnit(n,s);return this.addUniform(`highp ${e}`,t,s),this.addInitializer(o=>{if(s){const l=new Int32Array(s);for(let c=0;c<s;++c)l[c]=c+r;o.gl.uniform1iv(o.uniform(t),l)}else o.gl.uniform1i(o.uniform(t),r)}),r}symbol(e){return e+this.nextSymbolID++}addAttribute(e,t,n){return this.attributes.push(t),n!==void 0&&(this.attributesCode+=`layout(location = ${n})`),this.attributesCode+=`in ${e} ${t};
`,t}addVarying(e,t,n=""){this.varyingsCodeVS+=`${n} out ${e} ${t};
`,this.varyingsCodeFS+=`${n} in ${e} ${t};
`}addOutputBuffer(e,t,n){n!==null&&(this.outputBufferCode+=`layout(location = ${n}) `),this.outputBufferCode+=`out ${e} ${t};
`}addUniform(e,t,n){return this.uniforms.push(t),n!=null?this.uniformsCode+=`uniform ${e} ${t}[${n}];
`:this.uniformsCode+=`uniform ${e} ${t};
`,t}addFragmentExtension(e){this.fragmentExtensionsSet.has(e)||(this.fragmentExtensionsSet.add(e),this.fragmentExtensions+=`#extension ${e} : require
`)}addVertexCode(e){this.vertexCode.add(e)}addFragmentCode(e){this.fragmentCode.add(e)}setVertexMain(e){this.vertexMain=e}addVertexMain(e){this.vertexMain=(this.vertexMain||"")+e}setFragmentMain(e){this.fragmentMain=`void main() {
${e}
}
`}setFragmentMainFunction(e){this.fragmentMain=e}addInitializer(e){this.initializers.push(e)}require(e){this.required.has(e)||(this.required.add(e),e(this))}build(){const e=`#version 300 es
precision highp float;
precision highp int;
${this.uniformsCode}
${this.attributesCode}
${this.varyingsCodeVS}
${this.vertexCode}
void main() {
${this.vertexMain}
}
`,t=`#version 300 es
${this.fragmentExtensions}
precision highp float;
precision highp int;
${this.uniformsCode}
${this.varyingsCodeFS}
${this.outputBufferCode}
${this.fragmentCode}
${this.fragmentMain}
`,n=new _N(this.gl,e,t,this.uniforms,this.attributes,this.vertexDebugOutputs);n.textureUnits=this.textureUnits;const{initializers:s}=this;if(s.length>0){n.bind();for(const r of s)r(n)}return n}}function Rc(){return new Ne(void 0)}function vh(i){return new bt(i,ie)}function dv(i,e,t){const n=new Map,{parameters:s,fallbackParameters:r,shaderError:o,encodeParameters:l=C=>C,extraParameters:c=ar(void 0),encodeExtraParameters:u=C=>C,getContextKey:h,defineShader:g}=t;o!==void 0&&(o.value=void 0);const{encodeContext:v=h}=t,y=Qn(t.memoizeKey);function b(C,E,k){const D=JSON.stringify({id:y,context:v(C),parameters:l(E),extraParameters:u(k)});return e.memoize.get(D,()=>{const A=new pr(e);return g(A,C,E,k),A.build()})}function w(C){const E=h(C);let k=n.get(E);k===void 0&&(k={parametersGeneration:-1,extraParametersGeneration:-1,shader:null,fallback:!1,parameters:s.value,extraParameters:c.value},n.set(E,k));const D=s.changed.count,A=c.changed.count;if(D===k.parametersGeneration&&A===k.extraParametersGeneration)return k;const N=k.parameters=s.value,I=k.extraParameters=c.value,P=k.shader;k.parametersGeneration=D,k.extraParametersGeneration=A;let O=null;try{O=b(C,N,I),k.fallback=!1,r!==void 0&&(r.value=N),o!==void 0&&(o.value=null)}catch(_){if(o!==void 0&&(o.value=_),r!==void 0)try{const W=r.value;O=b(C,W,I),k.parameters=W,k.fallback=!0}catch{}}return P!==null&&P.dispose(),k.shader=O,k}return i.registerDisposer(()=>{for(const C of n.values()){const{shader:E}=C;E!==null&&E.dispose()}}),w}function Kr(i,e,t){return dv(i,e,{...t,getContextKey:n=>n,encodeContext:n=>jt(n),defineShader:(n,s,r,o)=>(n.require(s),t.defineShader(n,r,o))})}function ma(i,e=1,t=0){return`
#line ${t} ${e}
`+i}class dn{constructor(e,t=WebGL2RenderingContext.ARRAY_BUFFER){this.gl=e,this.bufferType=t,this.gl=e,this.buffer=e.createBuffer()}bind(){this.gl.bindBuffer(this.bufferType,this.buffer)}bindToVertexAttrib(e,t,n=WebGL2RenderingContext.FLOAT,s=!1,r=0,o=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribPointer(e,t,n,s,r,o)}bindToVertexAttribI(e,t,n=WebGL2RenderingContext.UNSIGNED_INT,s=0,r=0){this.bind(),this.gl.enableVertexAttribArray(e),this.gl.vertexAttribIPointer(e,t,n,s,r)}setData(e,t=WebGL2RenderingContext.STATIC_DRAW){const n=this.gl;this.bind(),n.bufferData(this.bufferType,e,t)}dispose(){this.gl.deleteBuffer(this.buffer),this.buffer=void 0,this.gl=void 0}static fromData(e,t,n,s){const r=new dn(e,n);return r.setData(t,s),r}}function Xl(i,e,t,...n){return i.memoize.get(Qn({id:"getMemoizedBuffer",getter:jt(t),args:n}),()=>{const s=new cx(dn.fromData(i,t(...n),e,WebGL2RenderingContext.STATIC_DRAW));return s.registerDisposer(s.value),s})}function BN(i=-1,e=-1,t=1,n=1,s=1,r=1){return qp(new Float32Array([i,e,i,n,t,n,t,e]),2,s,r)}function Ql(i,e=-1,t=-1,n=1,s=1,r=1,o=1){return Xl(i,WebGL2RenderingContext.ARRAY_BUFFER,BN,e,t,n,s,r,o).value}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function va(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE)}function FN(i){i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.NEAREST),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_3D,WebGL2RenderingContext.TEXTURE_WRAP_R,WebGL2RenderingContext.CLAMP_TO_EDGE)}function UN(i,e,t,n,s=WebGL2RenderingContext.RGBA8,r=WebGL2RenderingContext.RGBA,o=WebGL2RenderingContext.UNSIGNED_BYTE){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),va(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,s,t,n,0,r,o,null),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function zN(i,e,t){i.activeTexture(WebGL2RenderingContext.TEXTURE0+i.tempTextureUnit),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MIN_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_MAG_FILTER,WebGL2RenderingContext.LINEAR),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_S,WebGL2RenderingContext.CLAMP_TO_EDGE),i.texParameteri(WebGL2RenderingContext.TEXTURE_2D,WebGL2RenderingContext.TEXTURE_WRAP_T,WebGL2RenderingContext.CLAMP_TO_EDGE),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,1),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,4),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE,t),i.pixelStorei(WebGL2RenderingContext.UNPACK_FLIP_Y_WEBGL,0),i.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}function I1(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain("v4f_fragColor = getValue0();")}function GN(i,e=I1,t=1){return i.memoize.get(`elementWiseTextureShader:${t}:${jt(e)}`,()=>{const n=new pr(i);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler",t),n.addInitializer(s=>{const r=[];for(let o=0;o<t;++o)r[o]=o;i.uniform1iv(s.uniform("uSampler"),r)});for(let s=0;s<t;++s)n.addFragmentCode(`
vec4 getValue${s}() {
  return texture(uSampler[${s}], vTexCoord);
}
`);return n.addUniform("mat4","uProjectionMatrix"),n.require(e),n.addAttribute("vec4","aVertexPosition"),n.addAttribute("vec2","aTexCoord"),n.setVertexMain("vTexCoord = aTexCoord; gl_Position = uProjectionMatrix * aVertexPosition;"),n.build()})}function $N(i){return i.memoize.get("trivialColorShader",()=>{const e=new pr(i);return e.addVarying("vec4","vColor"),e.addOutputBuffer("vec4","v4f_fragColor",null),e.setFragmentMain("v4f_fragColor = vColor;"),e.addAttribute("vec4","aVertexPosition"),e.addAttribute("vec4","aColor"),e.addUniform("mat4","uProjectionMatrix"),e.setVertexMain("vColor = aColor; gl_Position = uProjectionMatrix * aVertexPosition;"),e.build()})}class P1 extends K{constructor(){super(...arguments),this.width=Number.NaN,this.height=Number.NaN}hasSize(e,t){return this.width===e&&this.height===t}resize(e,t){this.hasSize(e,t)||(this.width=e,this.height=t,this.performResize())}}class WN extends P1{constructor(e,t){super(),this.gl=e,this.internalformat=t,this.renderbuffer=null,this.renderbuffer=e.createRenderbuffer()}performResize(){const{gl:e}=this;e.bindRenderbuffer(e.RENDERBUFFER,this.renderbuffer),e.renderbufferStorage(e.RENDERBUFFER,this.internalformat,this.width,this.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}disposed(){this.gl.deleteRenderbuffer(this.renderbuffer)}attachToFramebuffer(e){const{gl:t}=this;t.framebufferRenderbuffer(t.FRAMEBUFFER,e,t.RENDERBUFFER,this.renderbuffer)}}class HN extends WN{constructor(e,t=!1){super(e,t?e.DEPTH_STENCIL:e.DEPTH_COMPONENT16),this.gl=e,this.includeStencilBuffer=t}attachToFramebuffer(){const{gl:e}=this;super.attachToFramebuffer(this.includeStencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT)}}class JN extends HN{constructor(e){super(e,!0)}}class jN extends K{constructor(e){super(),this.gl=e,this.framebuffer=this.gl.createFramebuffer()}disposed(){const{gl:e}=this;e.deleteFramebuffer(this.framebuffer)}bind(){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer)}unbind(){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null)}}class Hr extends P1{constructor(e,t,n,s){super(),this.gl=e,this.internalFormat=t,this.format=n,this.dataType=s,this.texture=e.createTexture()}performResize(){UN(this.gl,this.texture,this.width,this.height,this.internalFormat,this.format,this.dataType)}disposed(){this.gl.deleteTexture(this.texture)}attachToFramebuffer(e){const{gl:t}=this;t.framebufferTexture2D(t.FRAMEBUFFER,e,t.TEXTURE_2D,this.texture,0)}}class YN extends Hr{constructor(e,t=WebGL2RenderingContext.DEPTH_COMPONENT16,n=WebGL2RenderingContext.DEPTH_COMPONENT,s=WebGL2RenderingContext.UNSIGNED_SHORT){super(e,t,n,s)}attachToFramebuffer(){super.attachToFramebuffer(this.format===WebGL2RenderingContext.DEPTH_COMPONENT?WebGL2RenderingContext.DEPTH_ATTACHMENT:WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT)}}function Su(i,e,t=WebGL2RenderingContext.RGBA8,n=WebGL2RenderingContext.RGBA,s=WebGL2RenderingContext.UNSIGNED_BYTE){const r=new Array;for(let o=0;o<e;++o)r[o]=new Hr(i,t,n,s);return r}class ya extends K{constructor(e,t){super(),this.gl=e,this.width=Number.NaN,this.height=Number.NaN,this.fullAttachmentList=new Array,this.attachmentVerified=!1,this.singleAttachmentList=[this.gl.COLOR_ATTACHMENT0];const{framebuffer:n=new jN(e),colorBuffers:s,depthBuffer:r}=t;this.framebuffer=this.registerDisposer(n),this.colorBuffers=s,this.depthBuffer=r,r!==void 0&&this.registerDisposer(r);const{fullAttachmentList:o}=this;s.forEach((l,c)=>{this.registerDisposer(l),o[c]=e.COLOR_ATTACHMENT0+c})}hasSize(e,t){return this.width===e&&this.height===t}bind(e,t){this.width=e,this.height=t,this.framebuffer.bind();const{gl:n,depthBuffer:s}=this;s!==void 0?(s.resize(e,t),s.attachToFramebuffer()):n.framebufferRenderbuffer(WebGL2RenderingContext.FRAMEBUFFER,WebGL2RenderingContext.DEPTH_STENCIL_ATTACHMENT,WebGL2RenderingContext.RENDERBUFFER,null),this.colorBuffers.forEach((r,o)=>{r.resize(e,t),r.attachToFramebuffer(n.COLOR_ATTACHMENT0+o)}),n.drawBuffers(this.fullAttachmentList),this.verifyAttachment(),n.viewport(0,0,e,t)}bindSingle(e){const{gl:t}=this;this.framebuffer.bind(),e!==0&&t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0),t.bindTexture(t.TEXTURE_2D,null),this.colorBuffers[e].attachToFramebuffer(t.COLOR_ATTACHMENT0),t.drawBuffers(this.singleAttachmentList)}unbind(){this.framebuffer.unbind()}readPixelFloat32IntoBuffer(e,t,n,s,r=1,o=1){const{gl:l}=this;try{this.bindSingle(e),l.readPixels(t,n,r,o,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,s)}finally{this.framebuffer.unbind()}}verifyAttachment(){if(this.attachmentVerified)return;const{gl:e}=this,t=e.checkFramebufferStatus(e.FRAMEBUFFER);if(t!==e.FRAMEBUFFER_COMPLETE)throw new Error(`Framebuffer configuration not supported: ${t}`);this.attachmentVerified=!0}}class Sa extends K{constructor(e,t){super(),this.gl=e,this.shader=t,this.copyVertexPositionsBuffer=Ql(this.gl),this.copyTexCoordsBuffer=Ql(this.gl,0,0,1,1),this.registerDisposer(t)}draw(...e){const{gl:t,shader:n}=this;n.bind();const s=e.length;for(let l=0;l<s;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,e[l]);t.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,Sx);const r=n.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(r,2);const o=n.attribute("aTexCoord");this.copyTexCoordsBuffer.bindToVertexAttrib(o,2),t.drawArrays(t.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(r),t.disableVertexAttribArray(o);for(let l=0;l<s;++l)t.activeTexture(t.TEXTURE0+l),t.bindTexture(t.TEXTURE_2D,null)}static get(e,t=I1,n=1){return e.memoize.get(`OffscreenCopyHelper:${n}:${jt(t)}`,()=>new Sa(e,GN(e,t,n)))}}const qN=`
float mixLinear(float x, float y, float a) { return mix(x, y, a); }
`,KN=`
vec3 hueToRgb(float hue) {
  float hue6 = hue * 6.0;
  float r = abs(hue6 - 3.0) - 1.0;
  float g = 2.0 - abs(hue6 - 2.0);
  float b = 2.0 - abs(hue6 - 4.0);
  return clamp(vec3(r, g, b), 0.0, 1.0);
}
vec3 hsvToRgb(vec3 c) {
  vec3 hueRgb = hueToRgb(c.x);
  return c.z * ((hueRgb - 1.0) * c.y + 1.0);
}
`,kt=`
struct uint64_t {
  highp uvec2 value;
};
struct uint64x2_t {
  highp uvec4 value;
};
uint64_t mixLinear(uint64_t x, uint64_t y, float a) {
  return x;
}
uint64_t toUint64(uint64_t x) { return x; }
`,XN=[kt,`
uint64_t unpackUint64leFromUint32(highp uvec2 x) {
  uint64_t result;
  result.value = x;
  return result;
}
uint64x2_t unpackUint64leFromUint32(highp uvec4 x) {
  uint64x2_t result;
  result.value = x;
  return result;
}
`],A1=[kt,`
bool equals(uint64_t a, uint64_t b) {
  return a.value == b.value;
}
`],yh=[kt,`
bool compareLessThan(uint64_t a, uint64_t b) {
  return (a.value[1] < b.value[1])||
         (a.value[1] == b.value[1] && a.value[0] < b.value[0]);
}
`],R1=[kt,`
uint64_t subtract(uint64_t a, uint64_t b) {
  if (a.value[0] < b.value[0]) {
    --a.value[1];
  }
  a.value -= b.value;
  return a;
}
`],QN=[kt,`
uint64_t add(uint64_t a, uint64_t b) {
  a.value[0] += b.value[0];
  if (a.value[0] < b.value[0]) {
    ++a.value[1];
  }
  a.value[1] += b.value[1];
  return a;
}
`],ZN=[QN,yh,`
uint64_t addSaturate(uint64_t a, uint64_t b) {
  a = add(a, b);
  if (compareLessThan(a, b)) {
    a.value = uvec2(0xffffffffu, 0xffffffffu);
  }
  return a;
}
`],eM=[R1,yh,`
uint64_t subtractSaturate(uint64_t a, uint64_t b) {
  b = subtract(a, b);
  if (compareLessThan(a, b)) {
    b.value = uvec2(0u, 0u);
  }
  return b;
}
`],N1=[kt,`
uint64_t shiftRight(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(a.value[1] >> (shift - 32), 0u));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2((a.value[0] >> shift) | (a.value[1] << (32 - shift)), a.value[1] >> shift));
  }
}
`],tM=[kt,`
uint64_t shiftLeft(uint64_t a, int shift) {
  if (shift >= 32) {
    return uint64_t(uvec2(0u, a.value[0] << (shift - 32)));
  } else if (shift == 0) {
    return a;
  } else {
    return uint64_t(uvec2(a.value[0] << shift, (a.value[1] << shift) | (a.value[0] >> (32 - shift))));
  }
}
`],M1=[kt,`
struct uint8_t {
  highp uint value;
};
struct uint8x2_t {
  highp uvec2 value;
};
struct uint8x3_t {
  highp uvec3 value;
};
struct uint8x4_t {
  highp uvec4 value;
};
uint8_t mixLinear(uint8_t x, uint8_t y, highp float a) {
  return uint8_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint8_t x) { return x.value; }
highp float toNormalized(uint8_t x) { return float(x.value) / 255.0; }
highp uvec2 toRaw(uint8x2_t x) { return x.value; }
highp vec2 toNormalized(uint8x2_t x) { return vec2(x.value) / 255.0; }
highp uvec3 toRaw(uint8x3_t x) { return x.value; }
vec3 toNormalized(uint8x3_t x) { return vec3(x.value) / 255.0; }
highp uvec4 toRaw(uint8x4_t x) { return x.value; }
vec4 toNormalized(uint8x4_t x) { return vec4(x.value) / 255.0; }
uint64_t toUint64(uint8_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint8_t uint8FromFloat(highp float x) {
  return uint8_t(uint(clamp(x, 0.0, 255.0)));
}
`],O1=[kt,`
struct int8_t {
  highp int value;
};
struct int8x2_t {
  highp ivec2 value;
};
struct int8x3_t {
  highp ivec3 value;
};
struct int8x4_t {
  highp ivec4 value;
};
int8_t mixLinear(int8_t x, int8_t y, highp float a) {
  return int8_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int8_t x) { return x.value; }
highp ivec2 toRaw(int8x2_t x) { return x.value; }
highp ivec3 toRaw(int8x3_t x) { return x.value; }
highp ivec4 toRaw(int8x4_t x) { return x.value; }
uint64_t toUint64(int8_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int8_t int8FromFloat(highp float x) {
  return int8_t(int(clamp(x, -128.0, 127.0)));
}
`],uv=`
highp float toRaw(highp float x) { return x; }
highp float toNormalized(highp float x) { return x; }
vec2 toRaw(vec2 x) { return x; }
vec2 toNormalized(vec2 x) { return x; }
vec3 toRaw(vec3 x) { return x; }
vec3 toNormalized(vec3 x) { return x; }
vec4 toRaw(vec4 x) { return x; }
vec4 toNormalized(vec4 x) { return x; }
`,_1=[kt,`
struct uint16_t {
  highp uint value;
};
struct uint16x2_t {
  highp uvec2 value;
};
uint16_t mixLinear(uint16_t x, uint16_t y, highp float a) {
  return uint16_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp uint toRaw(uint16_t x) { return x.value; }
highp float toNormalized(uint16_t x) { return float(toRaw(x)) / 65535.0; }
highp uvec2 toRaw(uint16x2_t x) { return x.value; }
highp vec2 toNormalized(uint16x2_t x) { return vec2(toRaw(x)) / 65535.0; }
uint64_t toUint64(uint16_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint16_t uint16FromFloat(highp float x) {
  return uint16_t(uint(clamp(x, 0.0, 65535.0)));
}
`],V1=[kt,`
struct int16_t {
  highp int value;
};
struct int16x2_t {
  highp ivec2 value;
};
int16_t mixLinear(int16_t x, int16_t y, highp float a) {
  return int16_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int16_t x) { return x.value; }
highp ivec2 toRaw(int16x2_t x) { return x.value; }
uint64_t toUint64(int16_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int16_t int16FromFloat(highp float x) {
  return int16_t(int(clamp(x, -32768.0, 32767.0)));
}
`],Sh=[kt,`
struct uint32_t {
  highp uint value;
};
uint32_t mixLinear(uint32_t x, uint32_t y, highp float a) {
  return uint32_t(uint(round(mix(float(x.value), float(y.value), a))));
}
highp float toNormalized(uint32_t x) { return float(x.value) / 4294967295.0; }
highp uint toRaw(uint32_t x) { return x.value; }
uint64_t toUint64(uint32_t x) {
  uint64_t result;
  result.value[0] = x.value;
  result.value[1] = 0u;
  return result;
}
uint32_t uint32FromFloat(highp float x) {
  return uint32_t(uint(clamp(x, 0.0, 4294967295.0)));
}
`],B1=[kt,`
struct int32_t {
  highp int value;
};
int32_t mixLinear(int32_t x, int32_t y, highp float a) {
  return int32_t(int(round(mix(float(x.value), float(y.value), a))));
}
highp int toRaw(int32_t x) { return x.value; }
uint64_t toUint64(int32_t x) {
  uint64_t result;
  result.value[0] = uint(x.value);
  result.value[1] = uint(x.value >> 31);
  return result;
}
int32_t int32FromFloat(highp float x) {
  return int32_t(int(clamp(x, 2147483648.0, 2147483647.0)));
}
`],nM=`
highp int getFortranOrderIndex(ivec3 subscripts, ivec3 size) {
  return subscripts.x + size.x * (subscripts.y + size.y * subscripts.z);
}
`,iM=`
highp uint log2Exact(highp uint i) {
  highp uint r;
  r = uint((i & 0xAAAAAAAAu) != 0u);
  r |= uint((i & 0xFFFF0000u) != 0u) << 4;
  r |= uint((i & 0xFF00FF00u) != 0u) << 3;
  r |= uint((i & 0xF0F0F0F0u) != 0u) << 2;
  r |= uint((i & 0xCCCCCCCCu) != 0u) << 1;
  return r;
}
`,sM=`
bool clipLineToDepthRange(inout highp vec4 a, inout highp vec4 b) {
  highp float tmin = 0.0, tmax = 1.0;
  highp float k1 = b.w - a.w + a.z - b.z;
  highp float k2 = a.w - b.w + a.z - b.z;
  highp float q1 = (a.z - a.w) / k1;
  highp float q2 = (a.z + a.w) / k2;
  if (k1 > 0.0) tmin = max(tmin, q1);
  else if (k1 < 0.0) tmax = min(tmax, q1);
  if (k2 > 0.0) tmax = min(tmax, q2);
  else if (k2 < 0.0) tmin = max(tmin, q2);
  if (tmin <= tmax) {
    highp vec4 tempA = a;
    highp vec4 tempB = b;
    a = mix(tempA, tempB, tmin);
    b = mix(tempA, tempB, tmax);
    return true;
  }
  return false;
}
`,rM=`
highp float simpleFloatHash(highp vec2 co) {
    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);
}
`,oM=`
highp uint shiftLeftSaturate(highp uint x, int shiftAmount) {
  highp uint result = x << shiftAmount;
  if ((result >> shiftAmount) != x) return 0xffffffffu;
  return result;
}
`,hv=`
highp uint addSaturate(highp uint x, highp uint y) {
  highp uint result = x + y;
  if (result < x) return 0xffffffffu;
  return result;
}
`,aM=`
highp uint subtractSaturate(highp uint x, highp uint y) {
  highp uint result = x - y;
  if (result > x) return 0u;
  return result;
}
`,lM=[hv,`
highp int addSaturate(highp int x, highp uint y) {
  if (x >= 0) {
    return int(min(addSaturate(y, uint(x)), 0x7fffffffu));
  } else if (y >= uint(-x)) {
    return int(min(y - uint(-x), 0x7fffffffu));
  } else {
    return -int(min(uint(-x) - y, 0x80000000u));
  }
}
`],cM=[hv,`
highp int subtractSaturate(highp int x, highp uint y) {
  if (x < 0) {
    return -int(min(addSaturate(uint(-x), uint(y)), 0x80000000u));
  } else if (uint(x) >= y) {
    return x - int(y);
  } else {
    return -int(min(y - uint(x), 0x80000000u));
  }
}
`];function $t(i,e=1){switch(i){case J.FLOAT32:if(e===1)return"float";if(e>1&&e<=4)return`vec${e}`;break;case J.UINT8:case J.INT8:case J.UINT16:case J.INT16:case J.UINT32:case J.INT32:case J.UINT64:{const t=Jm[i]?"":"u",n=Hl[i]*8;if(e===1)return`${t}int${n}_t`;if(e>1&&e*n<=32)return`${t}int${n}x${e}_t`;break}}throw new Error(`No shader type for ${J[i]}[${e}].`)}const _a={[J.UINT8]:M1,[J.INT8]:O1,[J.UINT16]:_1,[J.INT16]:V1,[J.UINT32]:Sh,[J.INT32]:B1,[J.UINT64]:kt,[J.FLOAT32]:uv};function dM(i,e){return e===1?i:i==="float"?`vec${e}`:`${i[0]}vec${e}`}const uM={[WebGL2RenderingContext.UNSIGNED_BYTE]:1,[WebGL2RenderingContext.BYTE]:1,[WebGL2RenderingContext.UNSIGNED_SHORT]:2,[WebGL2RenderingContext.SHORT]:2,[WebGL2RenderingContext.FLOAT]:4,[WebGL2RenderingContext.INT]:4,[WebGL2RenderingContext.UNSIGNED_INT]:4};function bh(i,e,t,n,s,r,o=1){let l=0,c=r*o;for(;c>0;){const g=Math.min(4,c),v=dM(e,g);c-=g,i.addAttribute("highp "+v,`a${s}${l}`),++l}c=r*o;let u="";for(let g=0;g<o;++g){u+=`highp ${e}[${r}] get${s}${g}() {
  highp ${e}[${r}] result;
`;for(let v=0;v<r;++v){const y=g*r+v,b=Math.floor(y/4),w=y%4;u+=`  result[${v}] = a${s}${b}`,(w!==0||y!==c-1)&&(u+=`[${w}]`),u+=`;
`}u+=`  return result;
`,u+=`}
`}i.addVertexCode(u);const h=uM[t];i.addInitializer(g=>{const v=[];for(let y=0;y<l;++y)v[y]=g.attribute(`a${s}${y}`);g.vertexShaderInputBinders[s]={enable(y){const{gl:b}=g;for(let w=0;w<l;++w){const C=v[w];b.enableVertexAttribArray(C),b.vertexAttribDivisor(C,y)}},disable(){const{gl:y}=g;for(let b=0;b<l;++b){const w=v[b];y.vertexAttribDivisor(w,0),y.disableVertexAttribArray(w)}},bind(y,b){const{gl:w}=g;for(let C=0;C<l;++C){const E=v[C],k=Math.min(4,c-4*C);e==="float"?w.vertexAttribPointer(E,k,t,n,y,b):w.vertexAttribIPointer(E,Math.min(4,c-4*C),t,y,b),b+=h*k}}}})}class F1 extends K{constructor(e,t,n,s=new Yl){super(),this.channels=e,this.properties=t,this.bounds=n,this.visibility=s,this.framebuffers=[],this.producerVisibility=new Yl,this.frameNumber=-1}getFramebuffers(e){const{framebuffers:t}=this,n=this.bounds.value.length;for(;t.length<n;){const s=new ya(e,{colorBuffers:Su(e,1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)});t.push(s)}return t}get visibleHistograms(){return this.visibility.visible?this.bounds.value.length:0}disposed(){for(const e of this.framebuffers)e.dispose();this.framebuffers.length=0}}const cb=Symbol("histogramDataSamplerTextureUnit"),db=Symbol("histogramDepthTextureUnit"),fp=4096,hM=2**14;class fv extends K{constructor(e){super(),this.gl=e,this.shader=this.registerDisposer((()=>{const t=new pr(this.gl);return t.addOutputBuffer("vec4","outputValue",0),t.addAttribute("float","aInput1"),t.addTextureSampler("sampler2D","uDataSampler",cb),t.addTextureSampler("sampler2D","uDepthSampler",db),t.addVertexCode(rM),t.setVertexMain(`
float uRandomSeed = 0.0;
vec2 p = vec2(simpleFloatHash(vec2(aInput1 + float(gl_VertexID), uRandomSeed + float(gl_InstanceID))),
              simpleFloatHash(vec2(aInput1 + float(gl_VertexID) + 10.0, 5.0 + uRandomSeed + float(gl_InstanceID))));
float dataValue = texture(uDataSampler, p).x;
float stencilValue = texture(uDepthSampler, p).x;
if (stencilValue == 1.0) {
  gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
} else {
  gl_Position = vec4(2.0 * (dataValue * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
}
gl_PointSize = 1.0;
`),t.setFragmentMain(`
outputValue = vec4(1.0, 1.0, 1.0, 1.0);
`),t.build()})()),this.inputIndexBuffer=this.registerDisposer(Xl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>new Uint8Array(fp)))}static get(e){return e.memoize.get("textureHistogramGeneration",()=>new fv(e))}compute(e,t,n,s,r){const{gl:o}=this,{shader:l}=this,c=s.getFramebuffers(o);l.bind(),o.enable(WebGL2RenderingContext.BLEND),o.disable(WebGL2RenderingContext.SCISSOR_TEST),o.disable(WebGL2RenderingContext.DEPTH_TEST),o.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE),this.inputIndexBuffer.value.bindToVertexAttrib(l.attribute("aInput1"),1,WebGL2RenderingContext.UNSIGNED_BYTE,!0);const u=l.textureUnit(cb),h=l.textureUnit(db);o.activeTexture(WebGL2RenderingContext.TEXTURE0+h),o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,t),va(o),o.activeTexture(WebGL2RenderingContext.TEXTURE0+u);const g=s.frameNumber;s.frameNumber=r;for(let v=0;v<e;++v)o.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n[v].texture),va(o),c[v].bind(256,1),r!==g&&(o.clearColor(0,0,0,0),o.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),o.drawArraysInstanced(WebGL2RenderingContext.POINTS,0,fp,hM/fp);o.disable(WebGL2RenderingContext.BLEND)}}const pv={[J.UINT8]:"vec2",[J.INT8]:"vec2",[J.UINT16]:"vec2",[J.INT16]:"vec2",[J.FLOAT32]:"vec2",[J.UINT32]:"Uint32LerpParameters",[J.INT32]:"Int32LerpParameters",[J.UINT64]:"Uint64LerpParameters"},Nc={[J.UINT8]:"",[J.INT8]:"",[J.UINT16]:"",[J.INT16]:"",[J.FLOAT32]:"",[J.UINT32]:`
struct Uint32LerpParameters {
  uint offset;
  int shift;
  float multiplier;
};
`,[J.INT32]:`
struct Int32LerpParameters {
  int offset;
  int shift;
  float multiplier;
};
`,[J.UINT64]:[kt,`
struct Uint64LerpParameters {
  uint64_t offset;
  int shift;
  float multiplier;
};
`]},U1=`
float computeInvlerp(float inputValue, vec2 p) {
  float outputValue = inputValue;
  outputValue = (outputValue - p[0]) * p[1];
  return outputValue;
}
`;function Ad(i){const t=`
float computeInvlerp(${$t(i)} inputValue, vec2 p) {
  return computeInvlerp(float(toRaw(inputValue)), p);
}
`;return[_a[i],U1,t]}function ub(i){const e=$t(i),t=i===J.INT32?"int":"uint",n=pv[i];return[_a[i],Nc[i],`
float computeInvlerp(${t} v, ${n} p) {
  uint x;
  if (v >= p.offset) {
    x = uint(v - p.offset);
  } else {
    x = uint(p.offset - v);
    p.multiplier = -p.multiplier;
  }
  x >>= p.shift;
  return float(x) * p.multiplier;
}
float computeInvlerp(${e} inputValue, ${n} p) {
  return computeInvlerp(toRaw(inputValue), p);
}
`]}const fM={[J.UINT8]:Ad(J.UINT8),[J.INT8]:Ad(J.INT8),[J.UINT16]:Ad(J.UINT16),[J.INT16]:Ad(J.INT16),[J.FLOAT32]:U1,[J.UINT32]:ub(J.UINT32),[J.INT32]:ub(J.INT32),[J.UINT64]:[kt,yh,R1,N1,Nc[J.UINT64],`
float computeInvlerp(uint64_t inputValue, Uint64LerpParameters p) {
  if (compareLessThan(inputValue, p.offset)) {
    inputValue = subtract(p.offset, inputValue);
    p.multiplier = -p.multiplier;
  } else {
    inputValue = subtract(inputValue, p.offset);
  }
  uint shifted = shiftRight(inputValue, p.shift).value[0];
  return float(shifted) * p.multiplier;
}
`]};function Ll(i){let t=`
${$t(i)} computeLerp(float inputValue, vec2 p) {
  inputValue = inputValue / p[1] + p[0];
`;return i===J.FLOAT32?t+=`return inputValue;
`:t+=`return ${J[i].toLowerCase()}FromFloat(round(inputValue));
`,t+=`
}
`,[_a[i],t]}function hb(i){const e=$t(i),t=pv[i];return[_a[i],Nc[i],oM,i===J.UINT32?hv:lM,i===J.UINT32?aM:cM,`
${e} computeLerp(float inputValue, ${t} p) {
  inputValue = inputValue / p.multiplier;
  uint x = uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0));
  uint xShifted = shiftLeftSaturate(x, p.shift);
  if (inputValue >= 0.0) {
    return ${e}(addSaturate(p.offset, xShifted));
  } else {
    return ${e}(subtractSaturate(p.offset, xShifted));
  }
}
`]}const pM={[J.UINT8]:Ll(J.UINT8),[J.INT8]:Ll(J.INT8),[J.UINT16]:Ll(J.UINT16),[J.INT16]:Ll(J.INT16),[J.FLOAT32]:Ll(J.FLOAT32),[J.UINT32]:hb(J.UINT32),[J.INT32]:hb(J.INT32),[J.UINT64]:[kt,yh,A1,ZN,eM,N1,tM,Nc[J.UINT64],`
uint64_t computeLerp(float inputValue, Uint64LerpParameters p) {
  inputValue = inputValue / p.multiplier;
  uint64_t x = uint64_t(uvec2(uint(clamp(round(abs(inputValue)), 0.0, 4294967295.0)), 0u));
  uint64_t shifted = shiftLeft(x, p.shift);
  if (!equals(shiftRight(shifted, p.shift), x)) {
    return uint64_t(uvec2(0xffffffffu, 0xffffffffu));
  }
  if (inputValue >= 0.0) {
    return addSaturate(p.offset, shifted);
  } else {
    return subtractSaturate(p.offset, shifted);
  }
}
`]};function z1(i,e,t){const n=`uLerpParams_${e}`,s=`uLerpBounds_${e}`,r=`uLerpScalar_${e}`;let o="";switch(t){case J.INT8:case J.UINT8:case J.INT16:case J.UINT16:case J.FLOAT32:i.addUniform("vec2",n);break;case J.INT32:case J.UINT32:{const l=pv[t];i.addUniform(`${t===J.INT32?"i":"u"}vec2`,s),i.addUniform("float",r),o+=`
#define ${n} ${l}(${s}[0], int(${s}[1]), ${r})
`;break}case J.UINT64:{i.addUniform("uvec3",s),i.addUniform("float",r),o+=`
#define ${n} Uint64LerpParameters(uint64_t(${s}.xy), int(${s}[2]), ${r})
`;break}}return[Nc[t],o]}function bu(i,e,t,n=!1){const s=$t(t);let r=`
float ${e}(${s} inputValue) {
  float v = computeInvlerp(inputValue, uLerpParams_${e});
  ${n?"v = clamp(v, 0.0, 1.0);":""}
  return v;
}
`;if(t!==J.UINT64&&t!==J.FLOAT32){const o=Jm[t]?"int":"uint";r+=`
float ${e}(${o} inputValue) {
  return ${e}(${s}(inputValue));
}
`}return[_a[t],z1(i,e,t),fM[t],r]}function gM(i,e,t){return[_a[t],z1(i,e,t),pM[t],`
${$t(t)} ${e}(float inputValue) {
  return computeLerp(inputValue, uLerpParams_${e});
}
`]}const _r=new X;function Zl(i,e,t,n){const{gl:s}=i;switch(t){case J.INT8:case J.UINT8:case J.INT16:case J.UINT16:case J.FLOAT32:s.uniform2f(i.uniform(`uLerpParams_${e}`),n[0],1/(n[1]-n[0]));break;case J.INT32:case J.UINT32:{const r=n[0],o=n[1]-r,l=Math.max(0,Math.ceil(Math.log2(Math.abs(o)))-24),c=2**l/o,u=i.uniform(`uLerpBounds_${e}`);t===J.UINT32?s.uniform2ui(u,r,l):s.uniform2i(u,r,l),s.uniform1f(i.uniform(`uLerpScalar_${e}`),c);break}case J.UINT64:{const r=n[0],o=n[1];X.absDifference(_r,o,r);const l=_r.high>0?32+Math.ceil(Math.log2(_r.high)):Math.ceil(Math.log2(_r.low)),c=Math.max(0,l-24);X.rshift(_r,_r,c);let u=1/_r.low;X.compare(r,o)>0&&(u*=-1);const h=i.uniform(`uLerpBounds_${e}`);s.uniform3ui(h,r.low,r.high,c),s.uniform1f(i.uniform(`uLerpScalar_${e}`),u)}}}function mM(i){const e=/\/\/.*?$|\/\*(?:.|\n)*?\*\/|'(?:\\.|[^\\'])*'|"(?:\\.|[^\\"])*"/gm;return i.replace(e,t=>t.startsWith("/")?t.replace(/[^\s]/g," "):t)}function vM(i){const e=/^(?:-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?|"(?:\\.|[^\\"])*"|true|false|:|\s+|,|\[|\]|\{|\})/;let t=0;const n=i;e:for(;i.length;){const s=i.match(e);if(s===null)break;const r=s[0];switch(r.charAt(0)){case"[":case"{":++t;break;case"]":case"}":if(--t<0)return-1;break;case",":if(t===0)break e;break;default:if(t===0){i=i.substring(r.length);break e}break}i=i.substring(r.length)}return t!==0?-1:n.length-i.length}function yM(i){const e=[],t=new Map;if(i===void 0)return{errors:e,parameters:t};const n=/^([_a-z][_a-zA-Z0-9]*)[ \t]*=/;for(;i=i.trim(),i.length!==0;){const s=i.match(n);if(s===null){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}const r=s[1];i=i.substring(s[0].length);const o=vM(i);if(o<=0){e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ...");break}let l;try{l=JSON.parse(i.substring(0,o))}catch{e.push(`Invalid #uicontrol parameter value for ${r}: ${l}`);break}t.has(r)?e.push(`Duplicate #uicontrol parameter: ${r}`):t.set(r,l),i=i.substring(o),i=i.trim(),i.length>0&&!i.startsWith(",")&&e.push("Invalid #uicontrol parameter syntax, expected: <param>=<value>, ..."),i=i.substring(1)}return{parameters:t,errors:e}}function SM(i,e){let t,n,s,r;const o=[];i!=="float"&&i!=="uint"&&i!=="int"&&o.push("type must be float, int, or uint");for(const[l,c]of e){const u=()=>{if(typeof c!="number"){o.push(`Expected ${l} argument to be a number`);return}return(i==="int"||i==="uint")&&(Number.isInteger(c)||o.push(`Expected ${l} argument to be an integer`),i==="uint"&&c<0&&o.push(`Expected ${l} argument to be an unsigned integer`)),c};l==="min"?t=u():l==="max"?n=u():l==="default"?r=u():l==="step"?s=u():o.push(`Invalid parameter: ${l}`)}return t===void 0&&o.push("min must be specified"),n===void 0&&o.push("max must be specified"),t!==void 0&&n!==void 0&&(t>n&&o.push("min must be less than max"),s===void 0&&(i==="float"?s=(n-t)/100:s=1),r!==void 0?(r<t||r>n)&&o.push("default must be within valid range"):i==="float"?r=(t+n)/2:r=t),o.length>0?{errors:o}:{control:{type:"slider",valueType:i,min:t,max:n,step:s,default:r},errors:void 0}}function bM(i,e){let t=!1;const n=[];i!=="bool"&&n.push("type must be bool");for(const[s,r]of e)if(s==="default"){if(typeof r!="boolean"){n.push(`Expected ${s} argument to be a boolean`);continue}t=r}else n.push(`Invalid parameter: ${s}`);return n.length>0?{errors:n}:{control:{type:"checkbox",valueType:i,default:t},errors:void 0}}function wM(i,e){let t="white";const n=[];i!=="vec3"&&n.push("type must be vec3");for(const[s,r]of e)s==="default"?typeof r!="string"?n.push("Expected default argument to be a string"):t=r:n.push(`Invalid parameter: ${s}`);return n.length>0?{errors:n}:{control:{type:"color",valueType:i,defaultString:t,default:Ra(t)},errors:void 0}}function G1(i,e){typeof i=="number"&&(i=[i]);const t=new Array(e);return _e(t,i,n=>{if(!Number.isInteger(n)||n<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(n)}`);return n}),t}function CM(i,e,t){const{imageData:n,properties:s}=t;if(n!==void 0)return xM(i,e,n);if(s!==void 0)return EM(i,e,s);const r=[];return r.push("invlerp control not supported"),{errors:r}}function xM(i,e,t){const n=[];i!=="invlerp"&&n.push("type must be invlerp");let s=new Array(t.channelRank).fill(0);const{dataType:r}=t;let o=!0,l=ki[r],c;for(const[u,h]of e)try{switch(u){case"range":{l=ua(h,r);break}case"window":{c=jm(ua(h,r));break}case"clamp":{typeof h!="boolean"?n.push(`Invalid clamp value: ${JSON.stringify(h)}`):o=h;break}case"channel":{s=G1(h,s.length);break}default:n.push(`Invalid parameter: ${u}`);break}}catch(g){n.push(`Invalid ${u} value: ${g.message}`)}return n.length>0?{errors:n}:{control:{type:"imageInvlerp",dataType:r,clamp:o,default:{range:l,window:c??Ox(l),channel:s}},errors:void 0}}function EM(i,e,t){const n=[];i!=="invlerp"&&n.push("type must be invlerp");let s=!0,r,o,l;for(const[u,h]of e)try{switch(u){case"range":{r=X0(h);break}case"window":{o=X0(h);break}case"clamp":{typeof h!="boolean"?n.push(`Invalid clamp value: ${JSON.stringify(h)}`):s=h;break}case"property":{const g=ie(h);if(!t.has(g))throw new Error(`Property not defined: ${JSON.stringify(l)}`);l=g;break}default:n.push(`Invalid parameter: ${u}`);break}}catch(g){n.push(`Invalid ${u} value: ${g.message}`)}if(n.length>0)return{errors:n};if(l===void 0)for(const u of t.keys()){l=u;break}const c=t.get(l);return r!==void 0&&(r=gu(r,c)),o!==void 0&&(o=gu(o,c)),{control:{type:"propertyInvlerp",clamp:s,properties:t,default:{range:r,window:o,property:l,dataType:c}},errors:void 0}}const TM=new Map([["slider",SM],["color",wM],["invlerp",CM],["checkbox",bM]]);function Mc(i,e={}){i=mM(i);const t=/^[ \t]*#[ \t]*uicontrol[ \t]+(.*)$/gm,n=/^([_a-zA-Z][_a-zA-Z0-9]*)[ \t]+([a-z][a-zA-Z0-9_]*)(?:[ \t]+([a-z]+))?[ \t]*(?:\([ \t]*(.*)\)[ \t]*)?/,s=[],r=new Map,o=i.replace(t,(l,c,u)=>{const h=c.match(n),g=()=>Math.max(0,i.substring(0,u).split(`
`).length-1);if(h===null)return s.push({line:g(),message:"Invalid #uicontrol syntax, expected: #uicontrol <type> <name> <control>(<param>=<value>, ...)"}),"";const v=h[1],y=h[2],b=h[3]??v,w=h[4],{parameters:C,errors:E}=yM(w);for(const A of E)s.push({line:g(),message:A});if(r.has(y)&&s.push({line:g(),message:`Duplicate definition for control ${y}`}),E.length>0)return"";const k=TM.get(b);if(k===void 0)return s.push({line:g(),message:`Invalid control type ${b}`}),"";const D=k(v,C,e);if(D.errors!==void 0){for(const A of D.errors)s.push({line:g(),message:A});return""}return r.set(y,D.control),""});return{source:i,code:o,errors:s,controls:r}}function $1(i){return`u_shaderControl_${i}`}function ba(i,e){const{builderValues:t}=i;for(const[n,s]of i.parseResult.controls){const r=$1(n),o=t[n];switch(s.type){case"imageInvlerp":{const l=[bu(e,r,s.dataType,s.clamp),`
float ${r}() {
  return ${r}(getDataValue(${o.channel.join(",")}));
}
`];e.addFragmentCode(l),e.addFragmentCode(`#define ${n} ${r}
`);break}case"propertyInvlerp":{const l=o.property,c=s.properties.get(l),u=[bu(e,r,c,s.clamp),`
float ${r}() {
  return ${r}(prop_${l}());
}
`];e.addVertexCode(u),e.addVertexCode(`#define ${n} ${r}
`);break}case"checkbox":{const l=`#define ${n} ${o.value}
`;e.addFragmentCode(l),e.addVertexCode(l);break}default:{e.addUniform(`highp ${s.valueType}`,r),e.addVertexCode(`#define ${n} ${r}
`),e.addFragmentCode(`#define ${n} ${r}
`);break}}}}function kM(i){const e={};for(const[t,n]of i)e[t]=n;return e}function LM(i,e){return e instanceof Map?Array.from(e.entries()):e}function fb(i){if(i!==void 0)return JSON.stringify(kM(i),LM)}class DM{constructor(){this.changed=new ue,this.controls=void 0}get value(){return this.controls}set value(e){fb(e)!==fb(this.controls)&&(this.controls=e,this.changed.dispatch())}}function IM(i,e,t){return i===void 0?t:(ee(i),{range:oe(i,"range",n=>ua(n,e),t.range),window:oe(i,"window",n=>jm(ua(n,e)),t.window),channel:oe(i,"channel",n=>G1(n,t.channel.length),t.channel)})}class PM extends bt{constructor(e,t){super(t,n=>IM(n,e,t)),this.dataType=e,this.defaultValue=t}toJSON(){const{value:{range:e,window:t,channel:n},dataType:s,defaultValue:r}=this,o=hu(e,s,r.range),l=hu(t,s,r.window),c=De(r.channel,n)?void 0:n;if(!(o===void 0&&l===void 0&&c===void 0))return{range:o,window:l,channel:c}}}function AM(i,e,t){if(i===void 0)return t;ee(i);const n=oe(i,"property",r=>{if(r=ie(r),!e.has(r))throw new Error(`Invalid value: ${JSON.stringify(r)}`);return r},t.property),s=e.get(n);return{property:n,dataType:s,range:oe(i,"range",r=>ua(r,s),t.range),window:oe(i,"window",r=>jm(ua(r,s)),t.window)}}class RM extends bt{constructor(e,t){super(t,n=>AM(n,e,t)),this.properties=e,this.defaultValue=t}toJSON(){const{value:{range:e,window:t,property:n,dataType:s},defaultValue:r}=this,o=ki[s],l=hu(e??o,s,r.range??o),c=hu(t??o,s,r.window??o),u=n===r.property?void 0:n;if(!(l===void 0&&c===void 0&&u===void 0))return{range:l,window:c,property:u}}}function W1(i){switch(i.type){case"slider":return{trackable:new bt(i.default,e=>{let t;if(i.valueType==="float"?t=Xe(e):t=Je(e),t<i.min||t>i.max)throw new Error(`${JSON.stringify(e)} is outside valid range [${i.min}, ${i.max}]`);return t}),getBuilderValue:()=>null};case"color":return{trackable:new cu(i.default),getBuilderValue:()=>null};case"imageInvlerp":return{trackable:new PM(i.dataType,i.default),getBuilderValue:e=>({channel:e.channel,dataType:i.dataType})};case"propertyInvlerp":return{trackable:new RM(i.properties,i.default),getBuilderValue:e=>({property:e.property,dataType:e.dataType})};case"checkbox":return{trackable:new ut(i.default),getBuilderValue:e=>({value:e})}}}function H1(i,e){return JSON.stringify(i)+"\0"+e.source}function wh(i){const e={},t=[];for(const[n,s]of i.controls){const{trackable:r,getBuilderValue:o}=W1(s),l=o(r.value);e[n]=l,s.type==="propertyInvlerp"&&t.push(l.property)}return{builderValues:e,parseResult:i,key:H1(e,i),referencedProperties:t}}class Ch extends K{constructor(e,t=ar({}),n){super(),this.fragmentMain=e,this.dataContext=t,this.channelCoordinateSpaceCombiner=n,this.changed=new ue,this.controls=new DM,this.fragmentMainGeneration=-1,this.dataContextGeneration=-1,this.parseErrors_=[],this.processedFragmentMain_="",this.controlsGeneration=-1,this.parseResultChanged=new ue,this.state_=new Map,this.unparsedJson=void 0,this.registerDisposer(e.changed.add(()=>this.handleFragmentMainChanged())),this.registerDisposer(this.controls.changed.add(()=>this.handleControlsChanged())),this.registerDisposer(this.dataContext.changed.add(()=>this.handleFragmentMainChanged())),this.handleFragmentMainChanged();const s=this;this.parseErrors={changed:this.parseResultChanged,get value(){return s.handleFragmentMainChanged(),s.parseErrors_}},this.processedFragmentMain={changed:this.parseResultChanged,get value(){return s.handleFragmentMainChanged(),s.processedFragmentMain_}},this.parseResult={changed:this.parseResultChanged,get value(){return s.parseResult_}},this.builderState=Ht((c,u)=>{const h={},g=[];for(const[v,{control:y,trackable:b,getBuilderValue:w}]of u){const C=w(b.value);h[v]=C,y.type==="propertyInvlerp"&&g.push(C.property)}return{key:H1(h,c),parseResult:c,builderValues:h,referencedProperties:g}},[this.parseResult,this],(c,u)=>c.key===u.key);const r=Ht(c=>{const u=[];for(const{control:h,trackable:g}of c.values())h.type==="imageInvlerp"&&u.push({channel:g.value.channel});return u},[this],(c,u)=>Kp(c,u,(h,g)=>De(h.channel,g.channel))),o=Ht(c=>{const u=[];for(const{control:h,trackable:g}of c.values())h.type==="propertyInvlerp"&&u.push(g.value.property);return u},[this],De),l=ni(c=>{const u=[];for(const{control:h,trackable:g}of c.values())if(h.type==="imageInvlerp")u.push(g.value.window);else if(h.type==="propertyInvlerp"){const{dataType:v,range:y,window:b}=g.value;u.push(b??y??ki[v])}return u},this);this.histogramSpecifications=this.registerDisposer(new F1(r,o,l))}handleFragmentMainChanged(){const e=this.fragmentMain.changed.count,t=this.dataContext.changed.count;if(e===this.fragmentMainGeneration&&t===this.dataContextGeneration)return;this.fragmentMainGeneration=e,this.dataContextGeneration=t;const n=this.dataContext.value;if(n===null)this.parseResult_={source:"",code:"",controls:new Map,errors:[{line:0,message:"Loading"}]},this.parseErrors_=[],this.processedFragmentMain_="",this.controls.value=void 0;else{const s=this.parseResult_=Mc(this.fragmentMain.value,n);this.parseErrors_=s.errors,this.processedFragmentMain_=s.code,s.errors.length===0&&(this.controls.value=s.controls)}this.parseResultChanged.dispatch()}handleControlsChanged(){const e=this.controls.changed.count;if(e===this.controlsGeneration)return;this.controlsGeneration=e;const t=this.controls.value;if(t===void 0)return;let n=!1;const{state_:s,unparsedJson:r}=this;for(const[o,l]of s)t.get(o)===void 0&&(l.trackable.changed.remove(this.changed.dispatch),s.delete(o),n=!0);for(const[o,l]of t){let c=s.get(o);if(c!==void 0&&JSON.stringify(c.control)!==JSON.stringify(l)&&(c.trackable.changed.remove(this.changed.dispatch),c=void 0),c===void 0){const{trackable:u,getBuilderValue:h}=W1(l);c={control:l,trackable:u,getBuilderValue:h},c.trackable.changed.add(this.changed.dispatch),s.set(o,c),n=!0}if(r!==void 0&&Object.prototype.hasOwnProperty.call(r,o)){n=!0;try{c.trackable.restoreState(r[o])}catch{}}}r!==void 0&&(n=!0),this.unparsedJson=void 0,n&&this.changed.dispatch()}get state(){return this.controls.changed.count!==this.controlsGeneration&&this.handleControlsChanged(),this.state_}get value(){return this.state}restoreState(e){if(e===void 0)return;const{state:t}=this;if(ee(e),this.controls.value===void 0){this.unparsedJson=e,this.changed.dispatch();return}for(const[s,r]of t){const{trackable:o}=r;if(o.reset(),Object.prototype.hasOwnProperty.call(e,s))try{o.restoreState(e[s])}catch{}}this.unparsedJson=void 0}reset(){for(const e of this.state.values())e.trackable.reset();this.unparsedJson!==void 0&&(this.unparsedJson=void 0,this.changed.dispatch())}toJSON(){const{state:e}=this,{unparsedJson:t}=this;if(t!==void 0)return t;const n={};let s=!0;for(const[r,o]of e){const l=o.trackable.toJSON();l!==void 0&&(n[r]=l,s=!1)}if(!s)return n}}function pb(i,e,t,n,s){const r=$1(t),o=e.uniform(r);switch(n.type){case"slider":switch(n.valueType){case"int":case"uint":i.uniform1i(o,s);break;case"float":i.uniform1f(o,s)}break;case"color":i.uniform3fv(o,s);break;case"imageInvlerp":Zl(e,r,n.dataType,s.range);break;case"propertyInvlerp":{const{dataType:l}=s;Zl(e,r,l,s.range??ki[l]);break}}}function Xr(i,e,t,n){const{state:s}=t;if(t.controls.value===n)for(const[r,o]of s)pb(i,e,r,o.control,o.trackable.value);else for(const[r,o]of n){const l=s.get(r),c=l!==void 0&&JSON.stringify(l.control)===JSON.stringify(o)?l.trackable.value:o.default;pb(i,e,r,o,c)}}class NM extends Ne{}class MM extends cv{constructor(){super((e,{showMatches:t,segmentationState:n})=>{e.registerDisposer(t.changed.add(this.changed.dispatch)),e.registerDisposer(n.changed.add(this.changed.dispatch)),e.registerDisposer(Ti((s,r)=>{if(r==null)return;const{segmentationGroupState:o}=r;s.registerDisposer(o.changed.add(this.changed.dispatch)),s.registerDisposer(Ti((l,c)=>{const{visibleSegments:u}=c;let h=u.size===0;l.registerDisposer(u.changed.add(()=>{const g=u.size===0;g!==h&&(h=g,this.changed.dispatch())}))},o))},n))})}get(e){let t=super.get(e);return t===void 0&&(t={segmentationState:new Ne(void 0),showMatches:new ut(!1)},super.set(e,t)),t}}const gb=`
void main() {
  setColor(defaultColor());
}
`;class J1 extends K{constructor(){super(...arguments),this.annotationProperties=new Ne(void 0),this.shader=vh(gb),this.shaderControls=new Ch(this.shader,ni(e=>{const t=new Map;if(e===void 0)return null;for(const n of e){const s=dg[n.type];s!==void 0&&t.set(n.identifier,s)}return{properties:t}},this.annotationProperties)),this.fallbackShaderControls=new Ne(wh(Mc(gb))),this.shaderError=Rc(),this.color=new cu(Et(1,1,0)),this.relationshipStates=this.registerDisposer(new MM),this.ignoreNullSegmentFilter=new ut(!0),this.disablePicking=new Ne(!1),this.displayUnfiltered=ni((e,t)=>{for(const n of e.values())if(n.showMatches.value){if(!t)return!1;const s=n.segmentationState.value;if(s!=null&&s.segmentationGroupState.value.visibleSegments.size>0)return!1}return!0},this.relationshipStates,this.ignoreNullSegmentFilter),this.hoverState=new NM(void 0)}}class wu extends K{constructor(e){super();const{transform:t,localPosition:n,source:s,role:r=fr.ANNOTATION}=e;this.transform=t,this.localPosition=n,this.source=this.registerDisposer(s),this.role=r,this.displayState=e.displayState,this.chunkTransform=this.registerDisposer(ni(o=>mh(()=>hh(lv(o))),this.transform)),this.dataSource=e.dataSource,this.subsourceId=e.subsourceId,this.subsourceIndex=e.subsourceIndex,this.subsubsourceId=e.subsubsourceId}get sourceIndex(){const{dataSource:e}=this;return e.layer.dataSources.indexOf(e)}}class xh{constructor(e,t,n){this.size=Qp(e),this.transform=oA(t),this.finiteRank=n;const s=Ve(),r=Qm(s,4,t,4,4);if(r===0)throw new Error("Transform is singular");this.invTransform=s,this.detTransform=r}toObject(){return{size:this.size,transform:this.transform,finiteRank:this.finiteRank}}static fromObject(e){return new xh(e.size,e.transform,e.finiteRank)}globalToLocalSpatial(e,t){return qn(e,t,this.invTransform)}localSpatialVectorToGlobal(e,t){return DA(e,t,this.transform)}globalToLocalNormal(e,t){return wx(e,t,this.transform)}}const OM=Ve();function _M(i,e){let t=0,n=Math.abs(i.detTransform);const{transform:s,size:r}=i;for(let o=0;o<3;++o){let l=0;for(let u=0;u<3;++u)l+=e[u*4+2]*s[4*o+u];const c=r[o];t+=Math.abs(l)*c,n*=c}return n/t}function j1(i,e,t){const{curPositionInChunks:n,fixedPositionWithinChunk:s}=i,{nonDisplayLowerClipBound:r,nonDisplayUpperClipBound:o}=i,{rank:l,chunkDataSize:c}=i.source.spec;if(!ga(n,e,t,i.layerRank,i.fixedLayerToChunkTransform))return!1;for(let u=0;u<l;++u){const h=n[u];if(h<r[u]||h>=o[u])return!1;const g=c[u],v=n[u]=Math.floor(h/g);s[u]=h-v*g}return!0}function VM(i,e){const t=e.length;let n=0;if(t>1){let s=0;for(let r=0;r<t;++r){const o=e[r],{chunkLayout:l}=o,c=_M(l,i);c>s&&(s=c,n=r)}}return n}const Jo=new xh(we(),Ve(),0);class BM extends v1{constructor(){super(...arguments),this.viewportNormalInGlobalCoordinates=we(),this.viewportNormalInCanonicalCoordinates=we(),this.centerDataPosition=we(),this.pixelSize=0}}function FM(i,e){if(i.displayDimensionRenderInfo!==e.displayDimensionRenderInfo||i.pixelSize!==e.pixelSize)return!0;const{viewMatrix:t}=i,{viewMatrix:n}=e;for(let s=0;s<12;++s)if(t[s]!==n[s])return!0;return!1}class UM extends Ii{constructor(e){super(),this.projectionParameters=e,this.visibleLayers=new Map,this.visibleSourcesStale=!0,this.registerDisposer(e.changed.add((t,n)=>{FM(t,n)&&this.invalidateVisibleSources(),this.invalidateVisibleChunks()}))}invalidateVisibleSources(){this.visibleSourcesStale=!0}invalidateVisibleChunks(){}updateVisibleSources(){if(!this.visibleSourcesStale)return;this.visibleSourcesStale=!1;const e=this.projectionParameters.value.displayDimensionRenderInfo,{visibleLayers:t}=this;for(const[n,{allSources:s,visibleSources:r,displayDimensionRenderInfo:o}]of t){if(r.length=0,o!==e||s.length===0)continue;const l=VM(this.projectionParameters.value.viewMatrix,s.map(u=>u[0])),c=s[l];for(const u of n.filterVisibleSources(this,c))r.push(u);r.reverse()}}}const zM=18;function Cu(i){let{rank:e,upperVoxelBound:t,maxVoxelsPerChunkLog2:n=zM,chunkToViewTransform:s,displayRank:r,minBlockSize:o,maxBlockSize:l}=i;const{lowerVoxelBound:c=new Uint32Array(e)}=i,u=new Float32Array(e);for(let y=0;y<e;++y){let b=0;for(let w=0;w<r;++w){const C=s[y*r+w];b+=C*C}u[y]=Math.sqrt(b)}const h=new Uint32Array(e);o!==void 0?h.set(o):h.fill(1);const g=new Array(e);for(let y=0;y<e;++y){let b=Number.POSITIVE_INFINITY;u[y]===0?b=h[y]:(t!==void 0&&(b=2**Math.floor(Math.log2(t[y]-c[y]))),l!==void 0&&(b=Math.min(b,l[y]))),g[y]=b}function v(){let y=1/0,b=-1;for(let w=0;w<e;++w){if(h[w]>=g[w])continue;const C=h[w]*u[w];C<y&&(y=C,b=w)}return b}n-=Math.log2(tv(h));for(let y=0;y<n;++y){const b=v();if(b===-1)break;h[b]*=2}return h}function GM(i){const e=[],{displayRank:t,chunkToViewTransform:n,rank:s}=i;if(t>3)throw new Error("Unsupported view transform");if(t<3)return[Cu(i)];for(let r=0;r<3;++r){const o=(r+2)%3,l=new Float32Array(n);for(let c=0;c<s;++c)l[c*t+o]=0;e[r]=Cu({...i,chunkToViewTransform:l})}return e}var Y1=(i=>(i[i.ISOTROPIC=0]="ISOTROPIC",i[i.FLAT=1]="FLAT",i))(Y1||{});function $M(i){if(i.chunkDataSizes!==void 0)return i.chunkDataSizes;const{chunkLayoutPreference:e=0}=i;switch(e){case 0:return[Cu(i)];case 1:return GM(i)}}function Eh(i){const{rank:e,chunkDataSize:t,upperVoxelBound:n}=i,{lowerVoxelBound:s=new Float32Array(e)}=i,r=new Float32Array(e),o=new Float32Array(e);for(let l=0;l<e;++l)r[l]=Math.floor(s[l]/t[l]),o[l]=Math.floor((n[l]-1)/t[l]+1);return{rank:e,chunkDataSize:t,lowerChunkBound:r,upperChunkBound:o,lowerVoxelBound:s,upperVoxelBound:n}}function*WM(i,e,t){const n=i.projectionParameters.value.pixelSize*1.1,s=t[0].effectiveVoxelSize,r=e.renderScaleTarget.value,o=h=>{const g=n*r;for(let v=0;v<3;++v){const y=h[v];if(y>g&&y>1.01*s[v])return!0}return!1},l=(h,g)=>{const v=n*r;for(let y=0;y<3;++y){const b=h[y],w=g[y];if(Math.abs(v-b)<Math.abs(v-w)&&b<1.01*w)return!0}return!1};let c=t.length-1,u;for(;;){const h=t[c];if(u!==void 0&&!l(h.effectiveVoxelSize,u)||(yield h,c===0||!o(h.effectiveVoxelSize)))break;u=h.effectiveVoxelSize,--c}}const HM="SliceView",JM="sliceview/RenderLayer",jM="SliceView.addVisibleLayer",YM="SliceView.removeVisibleLayer",qM="ChunkManager.requestChunk",gv=new Float32Array(3),mv=new Float32Array(3),q1=Ve(),K1=new Float32Array(24);function X1(i,e,t,n){const s=gv,r=mv,{lowerChunkDisplayBound:o,upperChunkDisplayBound:l}=e;for(let g=0;g<3;++g)s[g]=Math.max(s[g],o[g]),r[g]=Math.min(r[g],l[g]);const{curPositionInChunks:c,chunkDisplayDimensionIndices:u}=e;function h(){if(!n(s[0],s[1],s[2],r[0],r[1],r[2],i))return;let g=0,v=Math.max(0,r[0]-s[0]),y=v;for(let E=1;E<3;++E){const k=Math.max(0,r[E]-s[E]);y*=k,k>v&&(v=k,g=E)}if(y===0)return;if(y===1){c[u[0]]=s[0],c[u[1]]=s[1],c[u[2]]=s[2],t(s,i);return}const b=s[g],w=r[g],C=Math.floor(.5*(b+w));r[g]=C,h(),r[g]=w,s[g]=C,h(),s[g]=b}h()}function Q1(i,e,t,n){if(!j1(t,i.globalPosition,e))return;const{size:s}=t.chunkLayout,r=zt(q1,i.viewProjectionMat,t.chunkLayout.transform);for(let u=0;u<3;++u){const h=s[u];for(let g=0;g<4;++g)r[4*u+g]*=h}const o=K1;lu(o,r);const l=gv,c=mv;l.fill(Number.NEGATIVE_INFINITY),c.fill(Number.POSITIVE_INFINITY),X1(o,t,n,Cx)}function KM(i,e,t,n,s){if(!j1(t,i.globalPosition,e))return;const{size:r}=n,o=zt(q1,i.viewProjectionMat,n.transform);for(let v=0;v<3;++v){const y=r[v];for(let b=0;b<4;++b)o[4*v+b]*=y}const l=OM;ur(l,o);const c=gv,u=mv,h=.001;for(let v=0;v<3;++v){const y=l[12+v]+h/r[v],b=Math.abs(l[v]),w=Math.abs(l[4+v]);c[v]=Math.floor(y-b-w),u[v]=Math.floor(y+b+w+1)}const g=K1;for(let v=0;v<3;++v){const y=o[4*v],b=o[4*v+1],w=o[4*v+2];g[v]=y,g[4+v]=-y,g[8+v]=+b,g[12+v]=-b,g[16+v]=+w,g[20+v]=-w}{const y=o[12],b=o[4*3+1],w=o[4*3+2];g[3]=1+y,g[7]=1-y,g[11]=1+b,g[15]=1-b,g[19]=w,g[23]=-w}X1(g,t,s,AA)}function vv(i,e){const{finiteRank:t}=e;if(t===3)return e;Jo.finiteRank=t,fA(Jo.size,e.size);const n=ru(Jo.transform,e.transform),s=ru(Jo.invTransform,e.invTransform);Jo.detTransform=e.detTransform;const{invViewMatrix:r,width:o,height:l}=i,c=Ex(i.projectionMat);for(let u=t;u<3;++u){const h=r[12+u];let g=h,v=h;const y=Math.abs(r[u]*o);g-=y,v+=y;const b=Math.abs(r[u+4]*l);g-=b,v+=b;const w=Math.abs(r[u+8]*c);g-=w,v+=w;const C=Math.max(1,v-g);n[12+u]=g,n[5*u]=C}return ur(s,n),Jo}const XM="annotation.MetadataChunkSource",QM="annotation.GeometryChunkSource",ZM="annotation.SubsetGeometryChunkSource",e2="annotation.reference.add",t2="annotation.reference.delete",n2="annotation.commit",i2="annotation.commit",s2="annotation/SpatiallyIndexedRenderLayer",r2="annotation/PerspectiveRenderLayer:updateSources",o2="annotation/RenderLayer",a2="annotation/RenderLayer.updateSegmentation",l2=Dc();function mb(i,e,t,n,s,r){const{displayDimensionRenderInfo:o,viewMatrix:l,projectionMat:c,width:u,height:h}=i,{voxelPhysicalScales:g}=o,v=Math.abs(zm(ch(l2,l))),y=ig(g),b=RA(c)/v*y;if(n.length===0)return;const w=n[0];let C=Math.abs(w.chunkLayout.detTransform)*y;const{lowerClipDisplayBound:E,upperClipDisplayBound:k}=w;for(let O=0;O<3;++O)C*=k[O]-E[O];const D=Math.min(C,b),A=u*h,I=A/t**2/D;let P=0;for(let O=n.length-1;O>=0&&P<I;--O){const _=n[O],W=_.source.spec,{chunkLayout:U}=_,j=ig(U.size)*Math.abs(U.detTransform)*y,{limit:B,rank:H}=W,{nonDisplayLowerClipBound:V,nonDisplayUpperClipBound:re}=_;let se=1;for(let Ge=0;Ge<H;++Ge){const Te=re[Ge]-V[Ge];Number.isFinite(Te)&&(se/=Te)}const ve=B*se/j;let me=!0;const Ie=P+ve,We=(1/Ie)**(1/3),tt=Math.sqrt(A/(Ie*D)),rt=(I-P)*j/se,nt=Math.min(1,rt/W.limit);Q1(i,e,_,()=>{me&&(s(_,O),me=!1),r(_,O,nt,We,tt)}),P=Ie}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const wa=`vec3 colormapJet(float x) {
  vec3 result;
  result.r = x < 0.89 ? ((x - 0.35) / 0.31) : (1.0 - (x - 0.89) / 0.11 * 0.5);
  result.g = x < 0.64 ? ((x - 0.125) * 4.0) : (1.0 - (x - 0.64) / 0.27);
  result.b = x < 0.34 ? (0.5 + x * 0.5 / 0.11) : (1.0 - (x - 0.34) / 0.31);
  return clamp(result, 0.0, 1.0);
}
vec3 colormapCubehelix(float x) {
  float xclamp = clamp(x, 0.0, 1.0);
  float angle = 2.0 * 3.1415926 * (4.0 / 3.0 + xclamp);
  float amp = xclamp * (1.0 - xclamp) / 2.0;
  vec3 result;
  float cosangle = cos(angle);
  float sinangle = sin(angle);
  result.r = -0.14861 * cosangle + 1.78277 * sinangle;
  result.g = -0.29227 * cosangle + -0.90649 * sinangle;
  result.b = 1.97294 * cosangle;
  result = clamp(xclamp + amp * result, 0.0, 1.0);
  return result;
}
`;function Z1(i,e){return{defineShader(t,n){const s=`prop_${n}`,r=`a_${s}`;t.addAttribute(`${i}`,r),t.addVertexCode(`${i} ${s}() { return ${r}; }`),t.addInitializer(o=>{const l=o.attribute(r),{gl:c}=o;o.vertexShaderInputBinders[s]=l===-1?{enable(){},disable(){},bind(){}}:{enable(u){c.enableVertexAttribArray(l),c.vertexAttribDivisor(l,u)},disable(){c.vertexAttribDivisor(l,0),c.disableVertexAttribArray(l)},bind(u,h){e(c,l,u,h)}}})}}}function pp(i,e,t,n){return Z1(i,(s,r,o,l)=>{s.vertexAttribPointer(r,e,t,n,o,l)})}function jo(i,e,t){return Z1(i,(n,s,r,o)=>{n.vertexAttribIPointer(s,e,t,r,o)})}const eE={rgb:pp("highp vec3",3,WebGL2RenderingContext.UNSIGNED_BYTE,!0),rgba:pp("highp vec4",4,WebGL2RenderingContext.UNSIGNED_BYTE,!0),float32:pp("highp float",1,WebGL2RenderingContext.FLOAT,!1),uint32:jo("highp uint",1,WebGL2RenderingContext.UNSIGNED_INT),int32:jo("highp int",1,WebGL2RenderingContext.INT),uint16:jo("highp uint",1,WebGL2RenderingContext.UNSIGNED_SHORT),int16:jo("highp int",1,WebGL2RenderingContext.SHORT),uint8:jo("highp uint",1,WebGL2RenderingContext.UNSIGNED_BYTE),int8:jo("highp int",1,WebGL2RenderingContext.BYTE)};class c2 extends K{constructor(e,t,n,s){super(),this.gl=e,this.annotationType=t,this.rank=n,this.properties=s;const r=this.serializedGeometryBytesPerAnnotation=In[t].serializedBytes(n),{offsets:o,serializedBytes:l,propertyGroupBytes:c}=_x(n,r,s);this.serializedBytesPerAnnotation=l,this.propertyOffsets=o,this.propertyGroupBytes=c,this.geometryDataStride=c[0];const u=this.propertyGroupCumulativeBytes=new Array(c.length);u[0]=0;for(let h=1;h<c.length;++h)u[h]=u[h-1]+c[h-1]}defineProperties(e,t){const{properties:n,rank:s}=this;for(const c of t){const u=n[c];eE[u.type].defineShader(e,u.identifier,s)}const{propertyOffsets:r}=this,{propertyGroupBytes:o,propertyGroupCumulativeBytes:l}=this;e.addInitializer(c=>{const u=t.map(g=>c.vertexShaderInputBinders[`prop_${n[g].identifier}`]),h=u.length;c.vertexShaderInputBinders.properties={enable(g){for(let v=0;v<h;++v)u[v].enable(g)},bind(g,v){for(let y=0;y<h;++y){const{group:b,offset:w}=r[t[y]];u[y].bind(o[b],v+w+l[b]*g)}},disable(){for(let g=0;g<h;++g)u[g].disable()}}})}}class Th extends c2{constructor(e,t,n,s,r,o,l){super(e,t,n,s),this.shaderControlState=r,this.fallbackShaderParameters=o,this.shaderError=l,this.histogramShaders=new Map}getDependentShader(e,t){return Kr(this,this.gl,{memoizeKey:{t:"annotation",targetIsSliceView:this.targetIsSliceView,type:this.annotationType,subType:e,properties:this.properties,rank:this.rank},fallbackParameters:this.fallbackShaderParameters,parameters:this.shaderControlState.builderState,shaderError:this.shaderError,defineShader:(n,s)=>{const{rank:r,properties:o}=this,l=[],c=s.referencedProperties,u=s.parseResult.code;for(let g=0,v=o.length;g<v;++g){const y=o[g],b=`prop_${y.identifier}`;!c.includes(y.identifier)&&!u.match(new RegExp(`\\b${b}\\b`))||l.push(g)}this.defineProperties(n,l),n.addUniform("highp vec3","uColor"),n.addUniform("highp uint","uSelectedIndex"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec3","uSubspaceMatrix",r),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp float","uModelClipBounds",r*2),n.addUniform("highp uint","uPickID"),n.addVarying("highp uint","vPickID","flat"),n.addVertexCode(wa),n.addVertexCode(`
vec3 defaultColor() { return uColor; }
highp uint getPickBaseOffset() { return uint(gl_InstanceID) * ${this.pickIdsPerInstance}u; }
`),n.addFragmentCode(`
void emitAnnotation(vec4 color) {
  emit(color, vPickID);
}
`);const h=`
float getSubspaceClipCoefficient(float modelPoint[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float d = abs(modelPoint[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}
`;n.addVertexCode(h),n.addFragmentCode(h),n.addVertexCode(`
vec3 projectModelVectorToSubspace(float modelPoint[${this.rank}]) {
  vec3 result = vec3(0.0, 0.0, 0.0);
  for (int i = 0; i < ${r}; ++i) {
    result += uSubspaceMatrix[i] * modelPoint[i];
  }
  return result;
}

float getMaxEndpointSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float dA = abs(modelPointA[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    float dB = abs(modelPointB[i] - uModelClipBounds[i]) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - min(dA, dB));
  }
  return coefficient;
}

float getMaxSubspaceClipCoefficient(float modelPointA[${this.rank}],  float modelPointB[${this.rank}]) {
  float coefficient = 1.0;
  for (int i = 0; i < ${r}; ++i) {
    float a = modelPointA[i];
    float b = modelPointB[i];
    float c = uModelClipBounds[i];
    float x = clamp(c, min(a, b), max(a, b));
    float d = abs(x - c) * uModelClipBounds[${r} + i];
    coefficient *= max(0.0, 1.0 - d);
  }
  return coefficient;
}

`),ba(s,n),n.addVertexCode(`
const bool PROJECTION_VIEW = ${!this.targetIsSliceView};
bool ng_discardValue;
#define discard ng_discard()
void ng_discard() {
  ng_discardValue = true;
}
void setLineColor(vec4 startColor, vec4 endColor);
void setLineWidth(float width);

void setEndpointMarkerColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor);
void setEndpointMarkerSize(float startSize, float endSize);
void setEndpointMarkerBorderWidth(float startSize, float endSize);

void setPointMarkerColor(vec4 color);
void setPointMarkerColor(vec3 color) { setPointMarkerColor(vec4(color, 1.0)); }
void setPointMarkerBorderColor(vec4 color);
void setPointMarkerSize(float size);
void setPointMarkerBorderWidth(float size);
void setPointMarkerBorderColor(vec3 color) { setPointMarkerBorderColor(vec4(color, 1.0)); }

void setEllipsoidFillColor(vec4 color);

void setBoundingBoxBorderColor(vec4 color);
void setBoundingBoxBorderWidth(float size);
void setBoundingBoxFillColor(vec4 color);

void setEndpointMarkerColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerBorderColor(vec3 startColor, vec3 endColor) {
  setEndpointMarkerBorderColor(vec4(startColor, 1.0), vec4(endColor, 1.0));
}
void setEndpointMarkerColor(vec3 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerColor(vec4 color) { setEndpointMarkerColor(color, color); }
void setEndpointMarkerBorderColor(vec3 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerBorderColor(vec4 color) { setEndpointMarkerBorderColor(color, color); }
void setEndpointMarkerSize(float size) { setEndpointMarkerSize(size, size); }
void setEndpointMarkerBorderWidth(float size) { setEndpointMarkerBorderWidth(size, size); }
void setLineColor(vec4 color) { setLineColor(color, color); }
void setLineColor(vec3 color) { setLineColor(vec4(color, 1.0)); }
void setLineColor(vec3 startColor, vec3 endColor) { setLineColor(vec4(startColor, 1.0), vec4(endColor, 1.0)); }
void setColor(vec4 color) {
  setPointMarkerColor(color);
  setLineColor(color);
  setEndpointMarkerColor(color);
  setBoundingBoxBorderColor(color);
  setEllipsoidFillColor(vec4(color.rgb, color.a * (PROJECTION_VIEW ? 1.0 : 0.5)));
}
void setEllipsoidFillColor(vec3 color) { setEllipsoidFillColor(vec4(color, 1.0)); }

void setBoundingBoxFillColor(vec3 color) { setBoundingBoxFillColor(vec4(color, 1.0)); }
void setBoundingBoxBorderColor(vec3 color) { setBoundingBoxBorderColor(vec4(color, 1.0)); }

void setColor(vec3 color) { setColor(vec4(color, 1.0)); }
void userMain();
`);for(const[g,v]of yv)g!==this.annotationType&&v.defineShaderNoOpSetters(n);t(n),n.addVertexCode(`
#define main userMain
`+ma(s.parseResult.code)+`
#undef main
`)}})}setPartIndex(e,...t){let n=`
void setPartIndex(${t.map((s,r)=>`highp uint partIndex${r}`).join()}) {
  highp uint pickID = uPickID;
  highp uint pickBaseOffset = getPickBaseOffset();
${t.map((s,r)=>`highp uint pickOffset${r} = pickBaseOffset + partIndex${r};`).join(`
`)}
`;return t.length===0&&(n+=`
  highp uint pickOffset0 = pickBaseOffset;
`),n+=`
  vPickID = pickID + pickOffset0;
  highp uint selectedIndex = uSelectedIndex;
if (selectedIndex == pickBaseOffset${t.map((s,r)=>` || selectedIndex == pickOffset${r}`).join("")}) {
    vColor = vec4(mix(vColor.rgb, vec3(1.0, 1.0, 1.0), 0.75), vColor.a);
  }
}
`,e.addVertexCode(n),`setPartIndex(${t.join()})`}get invokeUserMain(){return`
ng_discardValue = false;
userMain();
if (ng_discardValue) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
`}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}enable(e,t,n){const{shader:s,parameters:r}=e(t.renderContext.emitter);if(s===null)return;s.bind();const{gl:o}=this,{renderContext:l}=t,{annotationLayer:c}=t;if(Xr(o,s,this.shaderControlState,r.parseResult.controls),o.uniform3fv(s.uniform("uSubspaceMatrix"),t.subspaceMatrix),o.uniform1fv(s.uniform("uModelClipBounds"),t.modelClipBounds),o.uniformMatrix4fv(s.uniform("uModelViewProjection"),!1,t.modelViewProjectionMatrix),l.emitPickID&&o.uniform1ui(s.uniform("uPickID"),t.basePickId),l.emitColor){const h=c.state.displayState.color.value;o.uniform3f(s.uniform("uColor"),h[0],h[1],h[2]),o.uniform1ui(s.uniform("uSelectedIndex"),t.selectedIndex)}const u=s.vertexShaderInputBinders.properties;u.enable(1),o.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),u.bind(t.count,t.bufferOffset),n(s),u.disable()}getHistogramShader(e){const{histogramShaders:t}=this;let n=t.get(e);if(n===void 0){const{gl:s}=this;n=s.memoize.get(JSON.stringify({t:"propertyHistogramGenerator",propertyType:e}),()=>{const r=new pr(s);return this.defineHistogramShader(r,e),r.build()}),t.set(e,n)}return n}defineHistogramShader(e,t){eE[t].defineShader(e,"histogram",0),e.addOutputBuffer("vec4","out_histogram",0);const s="invlerpForHistogram",r=dg[t];e.addVertexCode(bu(e,s,r,!1)),e.setVertexMain(`
float x = invlerpForHistogram(prop_histogram());
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
gl_Position = vec4(2.0 * (x * 255.0 + 0.5) / 256.0 - 1.0, 0.0, 0.0, 1.0);
gl_PointSize = 1.0;
`),e.setFragmentMain("out_histogram = vec4(1.0, 1.0, 1.0, 1.0);")}computeHistograms(e,t){const{histogramSpecifications:n}=this.shaderControlState,s=n.properties.value,r=s.length,{properties:o}=this,l=o.length,{propertyOffsets:c}=this,{propertyGroupBytes:u,propertyGroupCumulativeBytes:h}=this,{gl:g}=this;g.enable(WebGL2RenderingContext.BLEND),g.disable(WebGL2RenderingContext.SCISSOR_TEST),g.disable(WebGL2RenderingContext.DEPTH_TEST),g.blendFunc(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE);const v=n.getFramebuffers(g),y=n.frameNumber;n.frameNumber=t,g.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,e.buffer.buffer);for(let b=0;b<r;++b){const w=s[b];for(let C=0;C<l;++C){const E=o[C];if(E.identifier!==w)continue;const k=E.type,D=dg[k],A=this.getHistogramShader(k);A.bind();const N=A.vertexShaderInputBinders.prop_histogram;N.enable(0);const{group:I,offset:P}=c[C];Zl(A,"invlerpForHistogram",D,n.bounds.value[b]),N.bind(u[I],e.bufferOffset+P+h[I]*e.count),v[b].bind(256,1),t!==y&&(g.clearColor(0,0,0,0),g.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT)),g.drawArrays(WebGL2RenderingContext.POINTS,0,e.count),N.disable();break}}g.disable(WebGL2RenderingContext.BLEND)}}const yv=new Map;function kh(i,e){yv.set(i,e)}function Bl(i){return yv.get(i)}var d2=Object.defineProperty,u2=Object.getOwnPropertyDescriptor,Sv=(i,e,t,n)=>{for(var s=n>1?void 0:n?u2(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&d2(e,t,s),s};class Ts{constructor(e){this.source=e,this.state=je.SYSTEM_MEMORY}get gl(){return this.source.gl}copyToGPU(e){this.state=je.GPU_MEMORY}freeGPUMemory(e){this.state=je.SYSTEM_MEMORY}}function vb(i){if(typeof i!="number"||i<0)throw new Error(`Expected non-negative number as limit, but received: ${JSON.stringify(i)}`);return i}class Rd{constructor({defaultItemLimit:e=Number.POSITIVE_INFINITY,defaultSizeLimit:t=Number.POSITIVE_INFINITY}={}){this.sizeLimit=new bt(t,vb),this.itemLimit=new bt(e,vb)}}let xg=class extends Ii{constructor(i,e,t,n){super(),this.gl=e,this.frameNumberCounter=t,this.capacities=n,this.visibleChunksChanged=new ue,this.pendingChunkUpdates=null,this.pendingChunkUpdatesTail=null,this.chunkUpdateDeadline=null,this.chunkUpdateDelay=30,this.enablePrefetch=new ut(!0,!0);const s=r=>({itemLimit:this.registerDisposer(Tt.makeFromExisting(i,r.itemLimit)).rpcId,sizeLimit:this.registerDisposer(Tt.makeFromExisting(i,r.sizeLimit)).rpcId});this.initializeCounterpart(i,{gpuMemoryCapacity:s(n.gpuMemory),systemMemoryCapacity:s(n.systemMemory),downloadCapacity:s(n.download),computeCapacity:s(n.compute),enablePrefetch:this.registerDisposer(Tt.makeFromExisting(i,this.enablePrefetch)).rpcId})}scheduleChunkUpdate(){const i=this.chunkUpdateDeadline;let e;i===null||Date.now()<i?e=0:e=this.chunkUpdateDelay,setTimeout(this.processPendingChunkUpdates.bind(this),e)}processPendingChunkUpdates(i=!1){let e=this.chunkUpdateDeadline;!i&&e===null&&(e=Date.now()+30);let t=!1,n=0;for(;;){if(!i&&Date.now()>e){this.chunkUpdateDeadline=null,setTimeout(()=>this.processPendingChunkUpdates(),this.chunkUpdateDelay);break}const s=this.pendingChunkUpdates;if(s==null)break;try{this.applyChunkUpdate(s)&&(t=!0)}finally{if(++n,(this.pendingChunkUpdates=s.nextUpdate)==null){this.pendingChunkUpdatesTail=null;break}}}return t&&this.visibleChunksChanged.dispatch(),n}handleFetch_(i,e){const{resolve:t,reject:n,cancellationToken:s}=e.promise;if(s.isCanceled){n(Hi);return}const r=e.key,o=i.chunks.get(r);if(!o){n(new Error(`No chunk found at ${r} for source ${i.constructor.name}`));return}const l=o.data;if(!l){n(new Error(`At ${r} for source ${i.constructor.name}: chunk has no data`));return}t({value:l})}applyChunkUpdate(i){let e=!1;const{rpc:t}=this,n=t.get(i.source);if(n!==void 0){if(i.promise!==void 0)this.handleFetch_(n,i);else if(i.id===void 0){for(const s of n.chunks.keys())n.deleteChunk(s);e=!0}else{const s=i.state;if(s===je.EXPIRED)n.deleteChunk(i.id);else{let r;const o=i.id;i.new?(r=n.getChunk(i),n.addChunk(o,r)):r=n.chunks.get(o);const l=r.state;if(s!==l)switch(s){case je.GPU_MEMORY:r.copyToGPU(this.gl),e=!0;break;case je.SYSTEM_MEMORY:l===je.GPU_MEMORY&&r.freeGPUMemory(this.gl);break;default:throw new Error(`INTERNAL ERROR: Invalid chunk state: ${je[s]}`)}if(s<=je.SYSTEM_MEMORY){const{chunkRequesters:c}=n;if(c!==void 0){const u=c.get(o);if(u!==void 0)for(const h of u)h(r)}}}}return e}}flushPendingChunkUpdates(){return this.processPendingChunkUpdates(!0)}async getStatistics(){const i=this.rpc,e=await i.promiseInvoke(aN,{queue:this.rpcId}),t=new Map;for(const[n,s]of e){const r=i.get(n);r!==void 0&&t.set(r,s)}return t}};xg=Sv([li(sN)],xg);function tE(i,e){const t=i.get(e.source),n=t.chunkManager.chunkQueueManager;if(t.immediateChunkUpdates){n.applyChunkUpdate(e)&&n.visibleChunksChanged.dispatch();return}const s=n.pendingChunkUpdatesTail;s==null?(n.pendingChunkUpdates=e,n.pendingChunkUpdatesTail=e,n.scheduleChunkUpdate()):(s.nextUpdate=e,n.pendingChunkUpdatesTail=e)}Rt("Chunk.update",function(i){tE(this,i)});C1("Chunk.retrieve",function(i,e){return new Promise((t,n)=>{i.promise={resolve:t,reject:n,cancellationToken:e},tE(this,i)})});Rt(lN,function(i){const e=this.get(i.id);for(const t of e.prevStatisticsLayers)t.numVisibleChunksNeeded=0,t.numVisibleChunksAvailable=0,t.numPrefetchChunksNeeded=0,t.numPrefetchChunksAvailable=0;e.prevStatisticsLayers.length=0;for(const t of i.layers){const n=this.get(t.id);if(n===void 0)continue;const s=n.layerChunkProgressInfo;s.numVisibleChunksAvailable=t.numVisibleChunksAvailable,s.numVisibleChunksNeeded=t.numVisibleChunksNeeded,s.numPrefetchChunksAvailable=t.numPrefetchChunksAvailable,s.numPrefetchChunksNeeded=t.numPrefetchChunksNeeded,e.prevStatisticsLayers.push(s)}e.layerChunkStatisticsUpdated.dispatch()});let Eg=class extends Ii{constructor(i){super(),this.chunkQueueManager=i,this.memoize=new h1,this.prevStatisticsLayers=[],this.layerChunkStatisticsUpdated=new ue,this.registerDisposer(i.addRef()),this.initializeCounterpart(i.rpc,{chunkQueueManager:i.rpcId})}get gl(){return this.chunkQueueManager.gl}getChunkSource(i,e){const t=i.encodeOptions(e);t.constructorId=jt(i);const n=Qn(t);return this.memoize.get(n,()=>{const s=new i(this,e);return s.initializeCounterpart(this.rpc,{}),s.key=t,s})}};Eg=Sv([li(rN)],Eg);class ri extends Ii{constructor(e,t={}){super(),this.chunkManager=e,this.chunks=new Map,this.immediateChunkUpdates=!1}initializeCounterpart(e,t){t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}get gl(){return this.chunkManager.chunkQueueManager.gl}deleteChunk(e){const t=this.chunks.get(e);t.state===je.GPU_MEMORY&&t.freeGPUMemory(this.gl),this.chunks.delete(e)}addChunk(e,t){this.chunks.set(e,t)}getChunk(e){throw new Error("Not implemented.")}invalidateCache(){this.rpc.invoke(oN,{id:this.rpcId})}static encodeOptions(e){return{}}}function at(i,e){let t=class extends i{constructor(...n){super(...n);const s=n[1];this.parameters=s.parameters}initializeCounterpart(n,s){s.parameters=this.parameters,super.initializeCounterpart(n,s)}static encodeOptions(n){return Object.assign({parameters:n.parameters},i.encodeOptions(n))}};return t=Sv([li(e.RPC_ID)],t),t}class Oc extends Ii{constructor(e){super(),this.layerChunkProgressInfo=e}}var An=(i=>(i[i.MIN_REPRESENTATIVE=0]="MIN_REPRESENTATIVE",i[i.MAX_REPRESENTATIVE=1]="MAX_REPRESENTATIVE",i[i.REPRESENTATIVE_EXCLUDED=2]="REPRESENTATIVE_EXCLUDED",i[i.NONREPRESENTATIVE_EXCLUDED=4]="NONREPRESENTATIVE_EXCLUDED",i))(An||{});function qd(i){return!(i.high>>>31)}const yb=new X(4294967295,4294967295),nE=["visibleSegments","segmentEquivalences","temporaryVisibleSegments","temporarySegmentEquivalences","useTemporaryVisibleSegments","useTemporarySegmentEquivalences"];function h2(i,e,t){i.registerDisposer(e.visibleSegments.changed.add(t)),i.registerDisposer(e.segmentEquivalences.changed.add(t))}function f2(i,e,t){i.registerDisposer(e.temporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.temporarySegmentEquivalences.changed.add(t)),i.registerDisposer(e.useTemporaryVisibleSegments.changed.add(t)),i.registerDisposer(e.useTemporarySegmentEquivalences.changed.add(t))}function $i(i){return`${i.low},${i.high}`}function p2(i){return!!(i.high>>>31)}function iE(i){return i.useTemporaryVisibleSegments.value?i.temporaryVisibleSegments:i.visibleSegments}function g2(i){return i.useTemporarySegmentEquivalences.value?i.temporarySegmentEquivalences:i.segmentEquivalences}function Ca(i,e){const t=iE(i),n=g2(i),s=n.disjointSets.visibleSegmentEquivalencePolicy.value;for(const r of t.unsafeKeys())if(s&An.NONREPRESENTATIVE_EXCLUDED){const o=n.get(r);e(r,o)}else{if(!n.disjointSets.isMinElement(r))continue;for(const o of n.setElements(r))s&An.REPRESENTATIVE_EXCLUDED&&s&An.MAX_REPRESENTATIVE&&p2(o)||e(o,r)}}const xt=40,_c=.5,xa=-4;function Kd(i,e=xa){return(Math.log2(i)-e)/_c}function m2(i,e=xa){return 2**(i*_c+e)}function Qr(i,e=2**xa,t){t===void 0&&(t=2**Math.round(_c*xt+xa)-1);const n=GA(e,t);return new bt(i,n)}class Ea{constructor(e=xa){this.visibility=new Yl,this.changed=new ue,this.frameNumber=-1,this.spatialScales=new Map,this.numHistogramRows=1,this.value=new Uint32Array(xt*this.numHistogramRows*2),this.fakeChunkCount=0,this.logScaleOrigin=e}begin(e){e!==this.frameNumber&&(this.value.fill(0),this.frameNumber=e,this.spatialScales.clear(),this.fakeChunkCount=0,this.changed.dispatch())}add(e,t,n,s,r=!1){let{spatialScales:o,numHistogramRows:l,value:c}=this,u=o.get(e);if(u===void 0&&(u=o.size,o.set(e,u)),u>=l){this.numHistogramRows=l*=2;const g=new Uint32Array(l*xt*2);g.set(c),this.value=c=g}const h=u*xt*2+Math.min(Math.max(0,Math.round(Kd(t,this.logScaleOrigin))),xt-1);c[h]+=n,c[h+xt]+=s,r&&(this.fakeChunkCount=this.fakeChunkCount+s)}}class bv extends T1{constructor(e,t,n){super(),this.chunkManager=e,this.multiscaleSource=t,this.rpcId=null,this.rpcTransfer={},this.visibleSources=new Map,this.visibleSourcesList_=[];const{renderScaleTarget:s=Qr(1)}=n;this.renderScaleTarget=s,this.renderScaleHistogram=n.renderScaleHistogram,this.transform=n.transform,this.localPosition=n.localPosition,this.rpcTransfer=n.rpcTransfer||{},this.dataHistogramSpecifications=this.registerDisposer(n.dataHistogramSpecifications??new F1(ar([]),ar([]),ar([]))),this.registerDisposer(this.dataHistogramSpecifications.visibility.changed.add(this.redrawNeeded.dispatch))}getDataHistogramCount(){return this.dataHistogramSpecifications.visibleHistograms}getSources(e){return this.multiscaleSource.getSources(e)}addSource(e,t){const{visibleSources:n}=this,s=n.get(e);s!==void 0?(++s.refCount,s.chunkTransform=t):(n.set(e,{source:e,refCount:1,chunkTransform:t}),this.visibleSourcesList_.length=0)}removeSource(e){const{visibleSources:t}=this,n=t.get(e);n.refCount!==1?--n.refCount:(t.delete(e),this.visibleSourcesList_.length=0)}get visibleSourcesList(){const{visibleSources:e,visibleSourcesList_:t}=this;if(t.length===0&&e.size!==0){for(const n of e.values())t.push(n);t.sort((n,s)=>n.chunkTransform.chunkToLayerTransformDet-s.chunkTransform.chunkToLayerTransformDet)}return t}initializeCounterpart(){const e=this.registerDisposer(new Oc(this.layerChunkProgressInfo)),t=this.chunkManager.rpc;e.RPC_TYPE_ID=this.RPC_TYPE_ID,e.initializeCounterpart(t,{localPosition:this.registerDisposer(Tt.makeFromExisting(t,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Tt.makeFromExisting(t,this.renderScaleTarget)).rpcId,...this.rpcTransfer}),this.rpcId=e.rpcId}get gl(){return this.chunkManager.chunkQueueManager.gl}setGLBlendMode(e,t){t>0?(e.enable(WebGL2RenderingContext.BLEND),e.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA)):e.disable(WebGL2RenderingContext.BLEND)}filterVisibleSources(e,t){return WM(e,this,t)}}bv.prototype.RPC_TYPE_ID=JM;class Zr extends k1{draw(e,t){}isReady(e,t){return!0}}var v2=Object.defineProperty,y2=Object.getOwnPropertyDescriptor,S2=(i,e,t,n)=>{for(var s=n>1?void 0:n?y2(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&v2(e,t,s),s};class b2 extends UM{}const w2=Ac(b2);function C2(i){return{source:i.source.addCounterpartRef(),effectiveVoxelSize:i.effectiveVoxelSize,layerRank:i.layerRank,nonDisplayLowerClipBound:i.nonDisplayLowerClipBound,nonDisplayUpperClipBound:i.nonDisplayUpperClipBound,lowerClipBound:i.lowerClipBound,upperClipBound:i.upperClipBound,lowerClipDisplayBound:i.lowerClipDisplayBound,upperClipDisplayBound:i.upperClipDisplayBound,chunkDisplayDimensionIndices:i.chunkDisplayDimensionIndices,lowerChunkDisplayBound:i.lowerChunkDisplayBound,upperChunkDisplayBound:i.upperChunkDisplayBound,fixedLayerToChunkTransform:i.fixedLayerToChunkTransform,combinedGlobalLocalToChunkTransform:i.combinedGlobalLocalToChunkTransform,chunkLayout:i.chunkLayout.toObject()}}function Lh(i){return i.map(e=>e.map(C2))}function gp(i,e){for(const t of e)for(const{source:n}of t)i.removeSource(n),n.dispose()}let xu=class extends w2{constructor(i,e,t,n){super(new L1({parametersConstructor:BM,navigationState:t,update:(o,l)=>{const{invViewMatrix:c,centerDataPosition:u}=o;l.toMat4(c);const{canonicalVoxelFactors:h,voxelPhysicalScales:g}=o.displayDimensionRenderInfo;for(let A=0;A<3;++A)u[A]=c[12+A];const{logicalWidth:v,logicalHeight:y,projectionMat:b,viewportNormalInGlobalCoordinates:w,viewportNormalInCanonicalCoordinates:C}=o,{relativeDepthRange:E}=l;vx(b,-v/2,v/2,y/2,-y/2,-E,E),f1(o,b),y1(o);const{viewMatrix:k}=o;for(let A=0;A<3;++A){const N=w[A]=k[A*4+2];C[A]=N/h[A]}ou(w,w),ou(C,C);let D=0;for(let A=0;A<3;++A){const N=g[A],I=c[A];D+=(N*I)**2}D=Math.sqrt(D),o.pixelSize=D}})),this.chunkManager=i,this.layerManager=e,this.navigationState=t,this.wireFrame=n,this.gl=this.chunkManager.gl,this.viewChanged=new ue,this.renderingStale=!0,this.visibleChunksStale=!0,this.visibleLayerList=new Array,this.offscreenFramebuffer=this.registerDisposer(new ya(this.gl,{colorBuffers:Su(this.gl,1),depthBuffer:new YN(this.gl)})),this.histogramInputTextures=[],this.offscreenFramebuffersWithHistograms=[this.offscreenFramebuffer],this.histogramGenerator=fv.get(this.gl),this.updateVisibleLayers=this.registerCancellable(ze(()=>{this.updateVisibleLayersNow()},0)),this.registerDisposer(t),this.registerDisposer(this.projectionParameters),this.registerDisposer(this.projectionParameters.changed.add((o,l)=>{o.displayDimensionRenderInfo!==l.displayDimensionRenderInfo&&this.updateVisibleLayers()}));const s=this.chunkManager.rpc,r=this.sharedProjectionParameters=this.registerDisposer(new yu(s,this.projectionParameters));this.initializeCounterpart(s,{chunkManager:i.rpcId,projectionParameters:r.rpcId}),this.registerDisposer(e.layersChanged.add(()=>{this.updateVisibleLayers()})),this.wireFrame.changed.add(this.viewChanged.dispatch),this.viewChanged.add(()=>{this.renderingStale=!0}),this.registerDisposer(i.chunkQueueManager.visibleChunksChanged.add(this.viewChanged.dispatch)),this.updateVisibleLayers()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}computeHistograms(i,e){this.histogramGenerator.compute(i,this.offscreenFramebuffer.depthBuffer.texture,this.histogramInputTextures,e,this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber)}flushBackendProjectionParameters(){this.sharedProjectionParameters.flush()}forEachVisibleChunk(i,e,t){KM(this.projectionParameters.value,i.renderLayer.localPosition.value,i,e,()=>{t(i.curPositionInChunks.join())})}isReady(){if(!this.navigationState.valid)return!1;this.updateVisibleLayers.flush(),this.updateVisibleSources();let i=0,e=0;for(const{visibleSources:t}of this.visibleLayers.values())for(const n of t){const s=vv(this.projectionParameters.value,n.chunkLayout),{source:r}=n,{chunks:o}=r;this.forEachVisibleChunk(n,s,l=>{const c=o.get(l);++e,c&&c.state===je.GPU_MEMORY&&++i})}return i===e}invalidateVisibleSources(){super.invalidateVisibleSources(),this.viewChanged.dispatch()}bindVisibleRenderLayer(i,e){e.push(i.localPosition.changed.add(()=>this.invalidateVisibleChunks())),e.push(i.redrawNeeded.add(this.viewChanged.dispatch)),e.push(i.transform.changed.add(this.updateVisibleLayers)),e.push(i.renderScaleTarget.changed.add(()=>this.invalidateVisibleSources()));const{renderScaleHistogram:t}=i;t!==void 0&&e.push(t.visibility.add(this.visibility)),e.push(i.dataHistogramSpecifications.producerVisibility.add(this.visibility))}updateVisibleLayersNow(){if(this.wasDisposed||!this.navigationState.valid)return!1;const i=Date.now(),{visibleLayers:e,visibleLayerList:t}=this,{displayDimensionRenderInfo:n}=this.projectionParameters.value,s=this.rpc,r={id:this.rpcId};let o=!1;t.length=0;for(const l of this.layerManager.readyRenderLayers())if(l instanceof bv){t.push(l);let c=e.get(l);if(c===void 0){const u=[],h=new oo;c={messages:h,allSources:this.getTransformedSources(l,h),transformGeneration:l.transform.changed.count,visibleSources:[],disposers:u,lastSeenGeneration:i,displayDimensionRenderInfo:n},u.push(l.messages.addChild(c.messages)),e.set(l.addRef(),c),this.bindVisibleRenderLayer(l,u)}else{c.lastSeenGeneration=i;const u=l.transform.changed.count;if(c.transformGeneration===u&&c.displayDimensionRenderInfo===n)continue;const h=c.allSources;c.allSources=this.getTransformedSources(l,c.messages),gp(l,h),c.visibleSources.length=0,c.displayDimensionRenderInfo=n,c.transformGeneration=u}r.layerId=l.rpcId,r.sources=Lh(c.allSources),this.flushBackendProjectionParameters(),s.invoke(jM,r),o=!0}for(const[l,c]of e)c.lastSeenGeneration!==i&&(r.layerId=l.rpcId,s.invoke(YM,r),e.delete(l),gp(l,c.allSources),la(c.disposers),l.dispose(),o=!0);return o&&(this.visibleSourcesStale=!0),this.viewChanged.dispatch(),o}invalidateVisibleChunks(){super.invalidateVisibleChunks(),this.viewChanged.dispatch()}get valid(){return this.navigationState.valid}getOffscreenFramebufferWithHistograms(i){const{offscreenFramebuffersWithHistograms:e}=this;let t=e[i];if(t===void 0){const{gl:n,histogramInputTextures:s,offscreenFramebuffer:r}=this;s.length<i&&s.push(...Su(n,i-s.length,WebGL2RenderingContext.R8,WebGL2RenderingContext.RED));const o=[r.colorBuffers[0].addRef()];for(let l=0;l<i;++l)o.push(s[l].addRef());t=this.registerDisposer(new ya(n,{colorBuffers:o,depthBuffer:r.depthBuffer.addRef()})),e[i]=t}return t}updateRendering(){const i=this.projectionParameters.value,{width:e,height:t}=i;if(!this.renderingStale||!this.valid||e===0||t===0)return;this.renderingStale=!1,this.updateVisibleLayers.flush(),this.updateVisibleSources();const{gl:n,offscreenFramebuffer:s}=this;s.bind(e,t),n.disable(n.SCISSOR_TEST),n.clearColor(0,0,0,0),n.colorMask(!0,!0,!0,!0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);let r=0;const o=this.wireFrame.value,l={sliceView:this,projectionParameters:i,wireFrame:o};for(const c of this.visibleLayerList){const u=o?0:c.getDataHistogramCount();this.getOffscreenFramebufferWithHistograms(u).bind(e,t);for(let g=0;g<u;++g)n.clearBufferfv(WebGL2RenderingContext.COLOR,1+g,ng);n.enable(WebGL2RenderingContext.DEPTH_TEST),n.depthFunc(WebGL2RenderingContext.LESS),n.clearDepth(1),n.clear(WebGL2RenderingContext.DEPTH_BUFFER_BIT),c.setGLBlendMode(n,r),c.draw(l),++r}n.disable(WebGL2RenderingContext.BLEND),n.disable(WebGL2RenderingContext.DEPTH_TEST),s.unbind()}disposed(){for(const[i,e]of this.visibleLayers)gp(i,e.allSources),la(e.disposers),i.dispose();this.visibleLayers.clear(),this.visibleLayerList.length=0}getTransformedSources(i,e){const t=Dh(this.projectionParameters.value.displayDimensionRenderInfo,i.transform.value,n=>i.getSources(n),e,i);for(const n of t)for(const s of n)i.addSource(s.source,s.chunkTransform);return t}};xu=S2([li(HM)],xu);class Vc extends ri{constructor(e,t){super(e,t),this.spec=t.spec}static encodeSpec(e){return{chunkDataSize:Array.from(e.chunkDataSize),lowerVoxelBound:Array.from(e.lowerVoxelBound),upperVoxelBound:Array.from(e.upperVoxelBound)}}static encodeOptions(e){const t=ri.encodeOptions(e);return t.spec=Vc.encodeSpec(e.spec),t}initializeCounterpart(e,t){t.spec=this.spec,super.initializeCounterpart(e,t)}async fetchChunk(e,t,n=pt){const s=e.join(),r=this.chunks.get(s);if(r!==void 0&&r.state<=je.SYSTEM_MEMORY)return t(r);this.addRef();let{chunkRequesters:o}=this;o===void 0&&(o=this.chunkRequesters=new Map);let l,c=o.get(s);c===void 0&&(c=[],o.set(s,c));const u=new Promise(h=>{l=g=>h(t(g)),c.push(l)});try{return await this.rpc.promiseInvoke(qM,{source:this.rpcId,chunkGridPosition:e},n),await u}finally{const h=c.indexOf(l);c.splice(h,1),c.length===0&&o.delete(s),o.size===0&&(this.chunkRequesters=void 0),this.dispose()}}}class sE extends Ts{constructor(e,t){super(e),this.chunkGridPosition=t.chunkGridPosition,this.state=je.SYSTEM_MEMORY}}let rE=class oE extends K{constructor(e,t){super(),this.gl=e,this.copyVertexPositionsBuffer=Ql(this.gl),this.textureCoordinateAdjustment=new Float32Array(4);const n=new pr(e);n.addVarying("vec2","vTexCoord"),n.addUniform("sampler2D","uSampler"),n.addInitializer(s=>{e.uniform1i(s.uniform("uSampler"),0)}),n.addUniform("vec4","uColorFactor"),n.addUniform("vec4","uBackgroundColor"),n.addUniform("mat4","uProjectionMatrix"),n.addUniform("vec4","uTextureCoordinateAdjustment"),n.require(t),n.setFragmentMain(`
vec4 sampledColor = texture(uSampler, vTexCoord);
if (sampledColor.a == 0.0) {
  sampledColor = uBackgroundColor;
}
emit(sampledColor * uColorFactor, 0u);
`),n.addAttribute("vec4","aVertexPosition"),n.setVertexMain(`
vTexCoord = uTextureCoordinateAdjustment.xy + 0.5 * (aVertexPosition.xy + 1.0) * uTextureCoordinateAdjustment.zw;
gl_Position = uProjectionMatrix * aVertexPosition;
`),this.shader=this.registerDisposer(n.build())}draw(e,t,n,s,r,o,l,c){const{gl:u,shader:h,textureCoordinateAdjustment:g}=this;g[0]=r,g[1]=o,g[2]=l-r,g[3]=c-o,h.bind(),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,e),u.disable(WebGL2RenderingContext.BLEND),u.uniformMatrix4fv(h.uniform("uProjectionMatrix"),!1,t),u.uniform4fv(h.uniform("uColorFactor"),n),u.uniform4fv(h.uniform("uBackgroundColor"),s),u.uniform4fv(h.uniform("uTextureCoordinateAdjustment"),g);const v=h.attribute("aVertexPosition");this.copyVertexPositionsBuffer.bindToVertexAttrib(v,2),u.drawArrays(u.TRIANGLE_FAN,0,4),u.disableVertexAttribArray(v),u.bindTexture(u.TEXTURE_2D,null)}static get(e,t){return e.memoize.get(`sliceview/SliceViewRenderHelper:${jt(t)}`,()=>new oE(e,t))}};class x2{constructor(e){this.chunkManager=e}}function Dh(i,e,t,n,s){n.clearMessages();const r=E=>(n.addMessage({severity:ws.error,message:E}),[]);if(e.error!==void 0)return r(e.error);const o=e.rank,l=e.unpaddedRank,{displayDimensionIndices:c,displayRank:u,canonicalVoxelFactors:h}=i,g=a1(e,c),{displayToLayerDimensionIndices:v}=g,y=new Float32Array(u*l),{modelToRenderLayerTransform:b}=e;for(let E=0;E<u;++E){const k=v[E];if(k===-1)continue;const D=h[E];for(let A=0;A<l;++A)y[u*A+E]=b[(o+1)*A+k]*D}const w=t({displayRank:u,multiscaleToViewTransform:y,modelChannelDimensionIndices:e.channelToRenderLayerDimensions}),{voxelPhysicalScales:C}=i;try{const E=k=>{const{chunkSource:D}=k,{spec:A}=D,{lowerClipBound:N=A.lowerVoxelBound,upperClipBound:I=A.upperVoxelBound}=k,P=hh(e,k.chunkToMultiscaleTransform),{chunkDataSize:O}=A,{channelToChunkDimensionIndices:_}=P,W=new Float32Array(l),U=new Float32Array(l);W.set(N),U.set(I);const j=_.length,{channelSpaceShape:B}=e;for(let ge=0;ge<j;++ge){const Ce=_[ge];if(Ce===-1)continue;const ot=B[ge];if(O[Ce]!==ot)throw new Error("Channel dimension "+e.layerDimensionNames[e.channelToRenderLayerDimensions[ge]]+` has extent ${ot} but corresponding chunk dimension has extent ${O[Ce]}`);W[Ce]=Number.NEGATIVE_INFINITY,U[Ce]=Number.POSITIVE_INFINITY}const H=l1(P,g),V=we(),re=we(),se=we(),ve=we(),me=we(),{numChunkDisplayDims:Ie,chunkDisplayDimensionIndices:We}=H,{combinedGlobalLocalToChunkTransform:tt,layerRank:rt,combinedGlobalLocalRank:nt}=P,Ge=new Float32Array(tt);for(let ge=0;ge<Ie;++ge){const Ce=We[ge];for(let ot=0;ot<=nt;++ot)Ge[Ce+ot*rt]=0;Ce<l?(me[ge]=A.chunkDataSize[Ce],V[ge]=A.lowerChunkBound[Ce],re[ge]=A.upperChunkBound[Ce],se[ge]=N[Ce],ve[ge]=I[Ce],W[Ce]=Number.NEGATIVE_INFINITY,U[Ce]=Number.POSITIVE_INFINITY):(me[ge]=1,V[ge]=0,re[ge]=1,se[ge]=0,ve[ge]=1)}me.fill(1,Ie),V.fill(0,Ie),re.fill(1,Ie),se.fill(0,Ie),ve.fill(1,Ie);const Te=new xh(me,H.displaySubspaceModelMatrix,Ie),Se=Te.localSpatialVectorToGlobal(we(),bx);for(let ge=0;ge<u;++ge)Se[ge]=Math.abs(Se[ge]*C[ge]);return Se.fill(1,u),{layerRank:rt,lowerClipBound:N,upperClipBound:I,nonDisplayLowerClipBound:W,nonDisplayUpperClipBound:U,renderLayer:s,source:D,lowerChunkDisplayBound:V,upperChunkDisplayBound:re,lowerClipDisplayBound:se,upperClipDisplayBound:ve,effectiveVoxelSize:Se,chunkLayout:Te,chunkDisplayDimensionIndices:We,fixedLayerToChunkTransform:Ge,curPositionInChunks:new Float32Array(l),combinedGlobalLocalToChunkTransform:P.combinedGlobalLocalToChunkTransform,fixedPositionWithinChunk:new Uint32Array(l),chunkTransform:P,chunkDisplayTransform:H}};return w.map(k=>k.map(D=>E(D)))}catch(E){for(const N of w)for(const{chunkSource:I}of N)I.dispose();const{globalDimensionNames:k}=i,A=`Cannot render (${Array.from(i.displayDimensionIndices.filter(N=>N!==-1),N=>k[N]).join(", ")}) cross section: ${E.message}`;return r(A)}}let Vr=null;const E2=200;class Pe{constructor(e=!1){if(Vr===null){Vr=document.createElement("ul"),Vr.id="statusContainer";const n=document.getElementById("neuroglancer-container");n?n.appendChild(Vr):document.body.appendChild(Vr)}const t=document.createElement("li");this.element=t,e===!0&&(e=E2),e!==!1?(this.setVisible(!1),this.timer=window.setTimeout(this.setVisible.bind(this,!0),e)):this.timer=null,Vr.appendChild(t)}dispose(){Vr.removeChild(this.element),this.element=void 0,this.timer!==null&&clearTimeout(this.timer)}setText(e,t){this.element.textContent=e,t&&this.setVisible(!0)}setHTML(e,t){this.element.innerHTML=e,t&&this.setVisible(!0)}setVisible(e){this.timer!==null&&(clearTimeout(this.timer),this.timer=null),this.element.style.display=e?"block":"none"}static forPromise(e,t){const n=new Pe(t.delay);n.setText(t.initialMessage);const s=n.dispose.bind(n);return e.then(s,r=>{let o;r instanceof Error?o=r.message:o=""+r;const{errorPrefix:l=""}=t;n.setErrorMessage(l+o),n.setVisible(!0)}),e}setErrorMessage(e){this.element.textContent=e+" ";const t=document.createElement("button");t.textContent="Dismiss",t.addEventListener("click",()=>{this.dispose()}),this.element.appendChild(t)}static showMessage(e){const t=new Pe;return t.element.textContent=e,t.setVisible(!0),t}static showTemporaryMessage(e,t=2e3){const n=Pe.showMessage(e);return window.setTimeout(()=>n.dispose(),t),n}}var T2=Object.defineProperty,k2=Object.getOwnPropertyDescriptor,wv=(i,e,t,n)=>{for(var s=n>1?void 0:n?k2(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&T2(e,t,s),s};function aE(i){let e=0;const{typeToIds:t}=i;for(const n of gs)e+=Bl(n).pickIdsPerInstance*t[n].length;return e}class lE{constructor(e){this.bufferValid=!1,this.numPickIds=0,this.serializedAnnotations={data:e.data,typeToIds:e.typeToIds,typeToOffset:e.typeToOffset,typeToIdMaps:e.typeToIdMaps}}freeGPUMemory(e){const{buffer:t}=this;t!==void 0&&(t.dispose(),this.bufferValid=!1,this.buffer=void 0)}}class L2 extends Ts{constructor(e,t){super(e),t.data!==void 0&&(this.data=new lE(t))}freeGPUMemory(e){super.freeGPUMemory(e);const{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}class cE extends sE{constructor(e,t){super(e,t),t.data!==void 0&&(this.data=new lE(t))}freeGPUMemory(e){super.freeGPUMemory(e);const{data:t}=this;t!==void 0&&t.freeGPUMemory(e)}dispose(){this.data=void 0}}let Eu=class extends Vc{constructor(i,e){super(i,e),this.immediateChunkUpdates=!0,(this.parent=e.parent).spatiallyIndexedSources.add(this);const{rank:n,chunkDataSize:s}=this.spec,r=this.multiscaleToChunkTransform=new Float32Array((n+1)**2);Qm(r,n+1,this.spec.chunkToMultiscaleTransform,n+1,n+1);for(let o=0;o<n;++o)for(let l=0;l<n+1;++l)r[(n+1)*l+o]/=s[o]}disposed(){this.parent.spatiallyIndexedSources.delete(this),super.disposed()}initializeCounterpart(i,e){e.parent=this.parent.rpcId,super.initializeCounterpart(i,e)}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new cE(this,i)}};Eu=wv([li(QM)],Eu);let Tg=class extends ri{constructor(i,e,t){super(i,{}),this.parent=e,this.relationshipIndex=t,this.immediateChunkUpdates=!0}addChunk(i,e){super.addChunk(i,e)}getChunk(i){return new L2(this,i)}};Tg=wv([li(ZM)],Tg);class D2 extends Ts{constructor(e,t){super(e),this.annotation=zx(t.annotation)}}let kg=class extends ri{constructor(i,e){super(i),this.parent=e}getChunk(i){return new D2(this,i)}addChunk(i,e){super.addChunk(i,e);const{references:t}=this.parent,n=t.get(i);n!==void 0&&(n.value=e.annotation,n.changed.dispatch())}deleteChunk(i){const{references:e}=this.parent,t=e.get(i);t!==void 0&&(t.value=void 0,t.changed.dispatch())}};kg=wv([li(XM)],kg);function dE(i,e,t,n){const s=new Uint8Array(i.data.length+n);for(const r of gs){if(r===t)continue;const o=i.typeToOffset[r];let l=o;r>t&&(l+=n,i.typeToOffset[r]=l),s.set(i.data.subarray(o,o+i.typeToIds[r].length*e[r].serializedBytes),l)}return s}function Lg(i,e,t,n,s,r,o,l){const c=i.typeToOffset[t];let u=c,h=c;const{propertyGroupBytes:g}=e[t],v=g.length,y=i.typeToIds[t].length;for(let b=0;b<v;++b){const w=g[b];n.set(i.data.subarray(u+s*w,u+r*w),h+o*w),u+=w*y,h+=w*l}}function Nd(i,e,t){const n=e.type,{rank:s}=t[n],{serializedAnnotations:r}=i,o=r.typeToIds[n],l=r.typeToIdMaps[n],c=In[n],u=t[n].serializedBytes;let h=l.get(e.id);if(h===void 0){h=l.size,l.set(e.id,h);const w=dE(r,t,n,u);Lg(r,t,n,w,0,h,0,h+1),o.push(e.id),r.data=w}const g=r.typeToOffset[n],v=new DataView(r.data.buffer,r.data.byteOffset,r.data.byteLength),y=Na===_n.LITTLE,b=t[n];c.serialize(v,g+b.propertyGroupBytes[0]*h,y,s,e),b.serialize(v,g,h,o.length,y,e.properties),i.bufferValid=!1}function Md(i,e,t,n){const{serializedAnnotations:s}=i,r=s.typeToIdMaps[e],o=r.get(t);if(o===void 0)return!1;const l=s.typeToIds[e],c=n[e].serializedBytes,u=dE(s,n,e,-c);Lg(s,n,e,u,0,o,0,l.length-1),Lg(s,n,e,u,o+1,l.length,o,l.length-1),l.splice(o,1),r.delete(t);for(let h=o,g=l.length;h<g;++h)r.set(l[h],h);return s.data=u,i.bufferValid=!1,!0}function I2(){const i=[],e=[],t=[];for(const n of gs)i[n]=[],e[n]=0,t[n]=new Map;return new cE(void 0,{data:new Uint8Array(0),numPickIds:0,typeToOffset:e,typeToIds:i,typeToIdMaps:t})}class Bc extends Ii{constructor(e,t){super(),this.chunkManager=e,this.metadataChunkSource=this.registerDisposer(new kg(this.chunkManager,this)),this.spatiallyIndexedSources=new Set,this.temporary=I2(),this.references=new Map,this.localUpdates=new Map,this.numCommitsInProgress=0,this.changed=new ue,this.readonly=!1,this.rank=t.rank,this.properties=t.properties,this.annotationPropertySerializers=Ym(this.rank,this.properties);const n=this.segmentFilteredSources=[],{relationships:s}=t;this.relationships=s;for(let r=0,o=s.length;r<o;++r)n.push(this.registerDisposer(new Tg(e,this,r)))}hasNonSerializedProperties(){return this.relationships.length>0}getSources(e){throw new Error("not implemented")}initializeCounterpart(e,t){this.metadataChunkSource.initializeCounterpart(e,{});for(const n of this.segmentFilteredSources)n.initializeCounterpart(e,{});t.segmentFilteredSource=this.segmentFilteredSources.map(n=>n.addCounterpartRef()),t.metadataChunkSource=this.metadataChunkSource.addCounterpartRef(),t.chunkManager=this.chunkManager.rpcId,super.initializeCounterpart(e,t)}add(e,t=!0){e.id=qm();const n=new cg(e.id);return n.value=e,this.references.set(n.id,n),n.registerDisposer(()=>{this.references.delete(n.id)}),this.applyLocalUpdate(n,!1,t,e),n}applyLocalUpdate(e,t,n,s){const{localUpdates:r}=this,{id:o}=e;let l=this.localUpdates.get(o);const c=e.value;if(c==null)throw new Error("Cannot create local update from null annotation");if(l===void 0?(l={type:c.type,reference:e.addRef(),existingAnnotation:t?c:void 0,pendingCommit:void 0,commitInProgress:void 0},r.set(o,l),this.forEachPossibleChunk(c,u=>{const{data:h}=u;if(h===void 0)return;const g=c.type;Md(h,g,o,this.annotationPropertySerializers)}),s!==null&&Nd(this.temporary.data,s,this.annotationPropertySerializers)):(s===null?Md(this.temporary.data,c.type,c.id,this.annotationPropertySerializers):Nd(this.temporary.data,s,this.annotationPropertySerializers),e.value=s),n)if(l.commitInProgress!==void 0)l.pendingCommit=s;else{if(s===null&&l.existingAnnotation===void 0){r.delete(o),l.reference.dispose();return}this.sendCommitRequest(l,s)}this.notifyChanged(e.id,s||void 0)}sendCommitRequest(e,t){this.updateCommitsInProgress(1),e.commitInProgress=t,this.rpc.invoke(n2,{id:this.rpcId,annotationId:e.existingAnnotation&&e.reference.id,newAnnotation:t})}delete(e){this.applyLocalUpdate(e,!0,!0,null)}update(e,t){this.applyLocalUpdate(e,!0,!1,t)}notifyChanged(e,t){const n=this.references.get(e),s=this.metadataChunkSource.chunks.get(e);s!==void 0&&(s.annotation=t||null),n!==void 0&&(n.value=t||null,n.changed.dispatch()),this.chunkManager.chunkQueueManager.visibleChunksChanged.dispatch()}commit(e){this.applyLocalUpdate(e,!0,!0,e.value)}getReference(e){let t=this.references.get(e);if(t!==void 0)return t.addRef();t=new cg(e),this.references.set(e,t),this.rpc.invoke(e2,{id:this.rpcId,annotation:e}),t.registerDisposer(()=>{this.references.delete(e),this.rpc.invoke(t2,{id:this.rpcId,annotation:e})});const n=this.metadataChunkSource.chunks.get(e);return n!==void 0&&(t.value=n.annotation),t}forEachPossibleChunk(e,t){const{relatedSegments:n}=e;if(n!==void 0){const c=n.length,{segmentFilteredSources:u}=this;for(let h=0;h<c;++h){const g=n[h];if(g===void 0)return;const v=u[h];for(const y of g){const b=v.chunks.get($i(y));b!==void 0&&t(b)}}}const{rank:s}=this,r=new Float32Array(s),o=new Float32Array(s),l=new Float32Array(s);for(const c of this.spatiallyIndexedSources){switch(e.type){case st.POINT:ps(r,c.multiscaleToChunkTransform,s+1,e.point,s),o.set(r);break;case st.LINE:case st.AXIS_ALIGNED_BOUNDING_BOX:ps(r,c.multiscaleToChunkTransform,s+1,e.pointA,s),ps(o,c.multiscaleToChunkTransform,s+1,e.pointB,s);break;case st.ELLIPSOID:ps(r,c.multiscaleToChunkTransform,s+1,e.center,s),Gx(o,c.multiscaleToChunkTransform,s+1,e.radii,s);for(let g=0;g<s;++g){const v=r[g],y=o[g];r[g]=v-y,o[g]=v+y}break}let u=1;for(let g=0;g<s;++g){const v=r[g],y=o[g],b=Math.min(v,y),w=Math.max(v,y);r[g]=Math.ceil(b-1),o[g]=Math.floor(w+1),u*=o[g]-r[g]}const{chunks:h}=c;for(let g=0;g<u;++g){let v=g;for(let b=0;b<s;++b){const w=r[b],E=o[b]-w,k=l[b]=v%E;v=(v-k)/E}const y=h.get(l.join());y!==void 0&&t(y)}}}static encodeOptions(e){return{}}handleSuccessfulUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid successful update notification");if(this.updateCommitsInProgress(-1),t!==null&&n.reference.id!==t.id){if(n.commitInProgress===null)throw new Error("Received invalid successful update notification");n.reference.id=t.id,this.references.delete(e),this.references.set(t.id,n.reference),this.localUpdates.delete(e),this.localUpdates.set(t.id,n),n.reference.value!==null&&(n.reference.value.id=t.id,Md(this.temporary.data,n.type,e,this.annotationPropertySerializers),Nd(this.temporary.data,n.reference.value,this.annotationPropertySerializers)),n.reference.changed.dispatch()}n.existingAnnotation=t||void 0,n.commitInProgress=void 0;let{pendingCommit:s}=n;n.pendingCommit=void 0,t===null&&(s=void 0),s!==void 0?(s!==null&&(s.id=t.id),this.sendCommitRequest(n,s)):this.revertLocalUpdate(n)}disposed(){const{commitStatus:e}=this;e!==void 0&&e.dispose()}updateCommitsInProgress(e){this.numCommitsInProgress+=e,this.numCommitsInProgress===0?this.commitStatus!==void 0&&(this.commitStatus.dispose(),this.commitStatus=void 0):this.commitStatus===void 0&&(this.commitStatus=new Pe(!0)).setText("Commiting annotations")}handleFailedUpdate(e,t){const n=this.localUpdates.get(e);if(n===void 0||n.commitInProgress===void 0)throw new Error("Received invalid update notification");new Pe().setErrorMessage(`Error commiting annotation update: ${t}`),this.revertLocalUpdate(n),this.updateCommitsInProgress(-1)}revertLocalUpdate(e){Md(this.temporary.data,e.type,e.reference.id,this.annotationPropertySerializers);const{existingAnnotation:t}=e;t!==void 0&&this.forEachPossibleChunk(t,r=>{const{data:o}=r;o!==void 0&&Nd(o,t,this.annotationPropertySerializers)});const{reference:n}=e,{id:s}=n;n.value=t||null,n.changed.dispatch(),n.dispose(),this.localUpdates.delete(s)}*[Symbol.iterator](){}}Rt(i2,function(i){const e=this.get(i.id),t=i.annotationId,n=i.error;if(n!==void 0)e.handleFailedUpdate(t,n);else{const s=zx(i.newAnnotation);e.handleSuccessfulUpdate(t,s)}});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fc(i,e){return i<e?-1:i>e?1:0}const uE={offset:0,completions:[]};function br(i,e){return e.offset+=i,e}function mp(i,e){const t=[];for(const n of e)n.startsWith(i)&&t.push({value:n});return t.sort((n,s)=>Fc(n.value,s.value)),t}function On(i,e,t,n){const s=[];for(const r of e){const o=t(r);o.startsWith(i)&&s.push({value:o,description:n(r)})}return s.sort((r,o)=>Fc(r.value,o.value)),s}async function P2(i,e,t){if(i.startsWith("{"))return uE;const s=i.match(/^(?:(.*)[&;])?([^&;]*)$/)[2],r=i.length-s.length,o=s.indexOf("=");if(o===-1){const l=await e(s);return{offset:l.offset+r,completions:l.completions.map(c=>({...c,value:`${c.value}=`}))}}return br(r+o+1,await t(s.substring(0,o),s.substring(o+1)))}async function hE(i,e){return P2(i,async t=>{const n=[];for(const s of e){const r=s.key;r.value.startsWith(t)&&n.push(r)}return{offset:0,completions:n}},async(t,n)=>{for(const s of e)if(s.key.value===t)return{offset:0,completions:s.values.filter(r=>r.value.startsWith(n))};return uE})}class Cv extends Error{constructor(e){super(`Redirected to: ${e}`),this.redirectTarget=e}}function fE(i,e){e===void 0&&(i.indexOf("/")===-1?e=":":e="/");const t=i.lastIndexOf(e);return t===-1?0:t+1}function A2(i,e){const t=fE(i,e);return i.substring(t)}var Ta=(i=>(i[i.annotations=0]="annotations",i[i.equivalences=1]="equivalences",i))(Ta||{});function pE(){return{url:"",transform:void 0,enableDefaultSubsources:!0,subsources:new Map}}class Bn extends K{normalizeUrl(e){return e.url}convertLegacyUrl(e){return e.url}async completeUrl(e){throw null}}const gE="local://annotations",Dg="local://equivalences";class R2 extends Bn{get description(){return"Local in-memory"}async get(e){switch(e.url){case gE:{const{transform:t}=e;let n;if(t===void 0){const s=e.globalCoordinateSpace.value,{rank:r,names:o,scales:l,units:c}=s,u=Ue({rank:r,scales:l,units:c,names:o.map((g,v)=>`${v}`)}),h=Ue({rank:r,scales:l,units:c,names:o});n={rank:r,sourceRank:r,inputSpace:u,outputSpace:h,transform:ai(Float64Array,r+1)}}else n=Jt(pa);return{modelTransform:n,canChangeModelSpaceRank:!0,subsources:[{id:"default",default:!0,subsource:{local:0}}]}}case Dg:return{modelTransform:Jt(pa),canChangeModelSpaceRank:!1,subsources:[{id:"default",default:!0,subsource:{local:1}}]}}throw new Error("Invalid local data source URL")}async completeUrl(e){return{offset:0,completions:On(e.providerUrl,[{value:"annotations",description:"Annotations stored in the JSON state"},{value:"equivalences",description:"Segmentation equivalence graph stored in the JSON state"}],t=>t.value,t=>t.description)}}}const Sb=/^(?:([a-zA-Z][a-zA-Z0-9-+_]*):\/\/)?(.*)$/;class N2 extends K{constructor(e){super(),this.credentialsManager=e,this.dataSources=new Map([["local",new R2]])}register(e,t){this.dataSources.set(e,this.registerDisposer(t))}getProvider(e){const t=e.match(Sb);if(t===null||t[1]===void 0)throw new Error('Data source URL must have the form "<protocol>://<path>".');const[,n,s]=t,r=this.dataSources.get(n);if(r===void 0)throw new Error(`Unsupported data source: ${JSON.stringify(n)}.`);return[r,s,n]}async get(e){const t=new Set,{cancellationToken:n=pt}=e;let s=e.url;for(;;){const[r,o,l]=this.getProvider(e.url);t.add(e.url);try{return r.get({...e,url:s,providerProtocol:l,providerUrl:o,registry:this,cancellationToken:n,credentialsManager:this.credentialsManager})}catch(c){if(c instanceof Cv){const u=c.redirectTarget;if(t.has(u))throw Error(`Layer source redirection contains loop: ${JSON.stringify(Array.from(t))}`);if(t.size>=10)throw Error(`Too many layer source redirections: ${JSON.stringify(Array.from(t))}`);s=u;continue}throw c}}}convertLegacyUrl(e){try{const[t,n,s]=this.getProvider(e.url);return t.convertLegacyUrl({...e,providerUrl:n,providerProtocol:s,registry:this})}catch{return e.url}}normalizeUrl(e){try{const[t,n,s]=this.getProvider(e.url);return t.normalizeUrl({...e,providerUrl:n,providerProtocol:s,registry:this})}catch{return e.url}}async completeUrl(e){const{url:t,cancellationToken:n=pt}=e,s=t.match(Sb),r=s[1];if(r===void 0)return Promise.resolve({offset:0,completions:On(t,this.dataSources,([l])=>`${l}://`,([,l])=>l.description)});const o=this.dataSources.get(r);if(o!==void 0){const l=await o.completeUrl({registry:this,url:t,providerUrl:s[2],chunkManager:e.chunkManager,cancellationToken:n,credentialsManager:this.credentialsManager});return br(r.length+3,l)}throw null}suggestLayerName(e){let[t,n]=this.getProvider(e);n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=t.suggestLayerName;return s!==void 0?s(n):A2(n)}findSourceGroup(e){const[t,n,s]=this.getProvider(e);return(t.findSourceGroup||fE)(n)+s.length+3}}function M2(i){return typeof i=="boolean"?{enabled:i}:(ee(i),{enabled:oe(i,"enabled",Ss)})}function Fl(i,e=void 0){return typeof i=="string"?{url:i,transform:e,enableDefaultSubsources:!0,subsources:new Map}:(ee(i),{url:z(i,"url",ie),transform:z(i,"transform",i1)||e,enableDefaultSubsources:oe(i,"enableDefaultSubsources",Ss,!0),subsources:oe(i,"subsources",t=>Jl(t,M2),new Map),state:oe(i,"state",ee)})}function O2(i){return i.enabled}function bb(i){const e=s1(i.transform),t={};let n=!0;for(const[s,r]of i.subsources){const o=O2(r);o!==void 0&&(t[s]=o,n=!1)}return e===void 0&&n&&i.enableDefaultSubsources===!0&&i.state===void 0?i.url:{url:i.url,transform:e,subsources:n?void 0:t,enableDefaultSubsources:i.enableDefaultSubsources===!0?void 0:!1,state:i.state}}class _2{constructor(e,t,n,s,r){this.loadedDataSource=e,this.subsourceEntry=t,this.subsourceSpec=n,this.subsourceIndex=s,this.activated=void 0,this.guardValues=[],this.messages=new oo,this.isActiveChanged=new ue;let o;n===void 0||n.enabled===void 0?o=t.default&&r:o=n.enabled;const l=e.dataSource.modelTransform.sourceRank;let{modelSubspaceDimensionIndices:c}=t;if(c===void 0){c=new Array(l);for(let h=0;h<l;++h)c[h]=h}const{subsourceToModelSubspaceTransform:u=ai(Float32Array,c.length+1)}=t;this.enabled=o,this.subsourceToModelSubspaceTransform=u,this.modelSubspaceDimensionIndices=c,this.isActiveChanged.add(e.activatedSubsourcesChanged.dispatch)}activate(e,...t){if(this.messages.clearMessages(),this.activated!==void 0){if(De(t,this.guardValues))return;this.activated.dispose()}this.guardValues=t;const n=this.activated=new K;e(n),this.isActiveChanged.dispatch()}deactivate(e){this.messages.clearMessages(),this.messages.addMessage({severity:ws.error,message:e});const{activated:t}=this;t!==void 0&&(this.activated=void 0,t.dispose(),this.isActiveChanged.dispatch())}addRenderLayer(e){const t=this.activated;t.registerDisposer(this.loadedDataSource.layer.addRenderLayer(e)),t.registerDisposer(this.messages.addChild(e.messages))}getRenderLayerTransform(e){const t=this.activated,{layer:n,transform:s}=this.loadedDataSource;return t.registerDisposer(o1(n.manager.root.coordinateSpace,n.localPosition.coordinateSpace,s,this,e))}}class xv extends K{constructor(e,t,n){super(),this.layerDataSource=e,this.dataSource=t,this.error=void 0,this.enabledSubsourcesChanged=new ue,this.activatedSubsourcesChanged=new ue,this.messages=new oo,t.canChangeModelSpaceRank?(this.transform=new nb(Jt(Ue({rank:0,scales:new Float64Array(0),units:[],names:[]})),!0),this.transform.value=t.modelTransform):this.transform=new nb(t.modelTransform),n.transform!==void 0&&(this.transform.spec=n.transform);const s=n.subsources;this.enableDefaultSubsources=n.enableDefaultSubsources,this.subsources=t.subsources.map((r,o)=>new _2(this,r,s.get(r.id),o,this.enableDefaultSubsources))}get enabledSubsources(){return this.subsources.filter(e=>e.enabled)}get layer(){return this.layerDataSource.layer}disposed(){for(const e of this.subsources){const{activated:t}=e;t!==void 0&&(e.activated=void 0,t.dispose())}}}class V2 extends K{constructor(e,t=void 0){super(),this.layer=e,this.changed=new ue,this.messages=new oo,this.loadState_=void 0,this.specGeneration=-1,this.refCounted_=void 0,this.registerDisposer(this.changed.add(e.dataSourcesChanged.dispatch)),this.registerDisposer(e.messages.addChild(this.messages)),t===void 0?this.spec_=pE():this.spec=t}get spec(){const{loadState:e}=this;if(e!==void 0&&e.error===void 0){const t=this.changed.count;t!==this.specGeneration&&(this.specGeneration=t,this.spec_={url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,n=>{const s=e.enableDefaultSubsources&&n.subsourceEntry.default;return[n.subsourceEntry.id,{enabled:n.enabled!==s?n.enabled:void 0}]})),state:this.spec.state})}return this.spec_}get loadState(){return this.loadState_}set spec(e){const{layer:t}=this;if(this.messages.clearMessages(),e.url.length===0){if(t.dataSources.length!==1){const c=t.dataSources.indexOf(this);if(c!==-1){t.dataSources.splice(c,1),t.dataSourcesChanged.dispatch(),this.dispose();return}}this.spec_=e,this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.refCounted_=void 0,this.loadState_=void 0,this.changed.dispatch());return}const n=new K,s=n.registerDisposer(dx(t.markLoading()));this.refCounted_!==void 0&&(this.refCounted_.dispose(),this.loadState_=void 0),this.refCounted_=n,this.spec_=e;const r=t.manager.chunkManager,o=t.manager.dataSourceProviderRegistry,l=new Sr;this.messages.addMessage({severity:ws.info,message:"Loading data source"}),o.get({chunkManager:r,url:e.url,cancellationToken:l,globalCoordinateSpace:t.manager.root.coordinateSpace,transform:e.transform,state:e.state}).then(c=>{if(n.wasDisposed)return;this.messages.clearMessages();const u=n.registerDisposer(new xv(this,c,e));u.registerDisposer(t.addCoordinateSpace(u.transform.outputSpace)),u.registerDisposer(u.transform.changed.add(this.changed.dispatch)),this.loadState_=u,u.registerDisposer(u.enabledSubsourcesChanged.add(this.changed.dispatch)),this.changed.dispatch(),c.state&&n.registerDisposer(c.state.changed.add(()=>{var h;this.spec.state=(h=c.state)==null?void 0:h.toJSON(),t.specificationChanged.dispatch()})),s()}).catch(c=>{this.wasDisposed||(this.loadState_={error:c},this.messages.clearMessages(),this.messages.addMessage({severity:ws.error,message:c.message}),this.changed.dispatch())}),n.registerDisposer(()=>{l.cancel()}),this.changed.dispatch()}disposed(){const e=this.refCounted_;e!==void 0&&e.dispose()}toJSON(){const{loadState:e}=this;return e===void 0||e.error!==void 0?bb(this.spec):bb({url:this.spec.url,transform:e.transform.spec,enableDefaultSubsources:e.enableDefaultSubsources,subsources:new Map(Array.from(e.subsources,t=>{const n=e.enableDefaultSubsources&&t.subsourceEntry.default;return[t.subsourceEntry.id,{enabled:t.enabled!==n?t.enabled:void 0}]})),state:this.spec.state})}}function ln(i,e,t){oe(i,e,n=>t.restoreState(n))}class Ih extends K{constructor(){super(...arguments),this.children=new Map,this.changed=new ue}add(e,t){const{children:n}=this;if(n.has(e))throw new Error(`Key ${JSON.stringify(e)} already registered.`);return this.children.set(e,t),t.changed.add(this.changed.dispatch),this.changed.dispatch(),()=>{this.remove(e)}}remove(e){const{children:t}=this;if(t.has(e))throw new Error(`Key ${JSON.stringify(e)} not registered.`);const n=t.get(e);this.children.delete(e),n.changed.remove(this.changed.dispatch),this.changed.dispatch()}disposed(){const{changed:e}=this;for(const t of this.children.values())t.changed.remove(e.dispatch);this.children=void 0,super.disposed()}toJSON(){const e=this.baseJSON();for(const[t,n]of this.children)e[t]=n.toJSON();return e}baseJSON(){return{}}reset(){for(const e of this.children.values())e.reset()}restoreState(e){ee(e);for(const[t,n]of this.children)try{if(Object.prototype.hasOwnProperty.call(e,t)){const s=e[t];if(s===void 0)continue;n.restoreState(s)}}catch(s){throw new Error(`Error restoring property ${JSON.stringify(t)}: ${s.message}`)}}}const wb=new WeakMap;function Ph(i){let e=wb.get(i);const t=i.changed.count;if(e!==void 0&&e.generation===t)return e;let n;if(i instanceof Ih){n=i.baseJSON();for(const[s,r]of i.children)n[s]=Ph(r).value}else n=i.toJSON();return e===void 0?(e={generation:t,value:n},wb.set(i,e)):(e.generation=t,e.value=n),e}class Uc{constructor(e,t,n=t){this.enumType=e,this.value_=t,this.defaultValue=n,this.changed=new ue}set value(e){this.value_!==e&&(this.value_=e,this.changed.dispatch())}get value(){return this.value_}reset(){this.value=this.defaultValue}restoreState(e){this.value=ft(e,this.enumType)}toJSON(){if(this.value_!==this.defaultValue)return this.enumType[this.value_].toLowerCase()}}var Ah=(i=>(i[i.LINKED=0]="LINKED",i[i.RELATIVE=1]="RELATIVE",i[i.UNLINKED=2]="UNLINKED",i))(Ah||{});class B2 extends Uc{constructor(e=0){super(Ah,e)}}const Od=we(),mE=Cn();function zc(i,e,t,n){let s=!1,r;i.registerDisposer(e);const o=()=>{switch(s=!0,t.value){case 2:if(n.isValid(i))break;case 0:n.assign(i,e);break;case 1:n.add(i,e,r);break}s=!1},l=()=>{if(!s)switch(t.value){case 2:break;case 0:n.assign(e,i);break;case 1:n.subtract(e,i,r);break}};let c=2;const u=()=>{const h=t.value;if(h!==c)switch(h){case 2:r=void 0;break;case 0:r=void 0,n.assign(i,e);break;case 1:r=n.difference(i,e);break}c=h,i.changed.dispatch()};return i.registerDisposer(i.changed.add(l)),i.registerDisposer(e.changed.add(o)),i.registerDisposer(t.changed.add(u)),u(),i}function vE(i,e,t,n){return zc(i,e,t,n)}class $r extends K{constructor(e){super(),this.coordinateSpace=e,this.coordinates_=fa,this.changed=new ue,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()}))}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.coordinates_}reset(){this.curCoordinateSpace=void 0,this.coordinates_=fa,this.changed.dispatch()}set value(e){const{curCoordinateSpace:t}=this;if(t===void 0||!t.valid||t.rank!==e.length)return;const{coordinates_:n}=this;n.set(e),this.changed.dispatch()}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const{rank:n}=e;if(!e.valid)return;if(t===void 0||!t.valid){let{coordinates_:h}=this;if(!(h!==void 0&&h.length===n)){h=this.coordinates_=new Float32Array(n),FR(h,e.bounds);const{voxelCenterAtIntegerCoordinates:g}=e.bounds;for(let v=0;v<n;++v)g[v]?h[v]=Math.round(h[v]):h[v]=Math.floor(h[v])+.5}this.changed.dispatch();return}const s=new Float32Array(n),r=this.coordinates_,{ids:o,scales:l}=e,{ids:c,scales:u}=t;for(let h=0;h<n;++h){const g=o[h],v=c.indexOf(g);v===-1?s[h]=qx(e.bounds.lowerBounds[h],e.bounds.upperBounds[h]):s[h]=r[v]*(u[v]/l[h])}this.coordinates_=s,this.changed.dispatch()}toJSON(){if(!this.valid&&this.coordinates_.length===0)return;this.handleCoordinateSpaceChanged();const{value:e}=this;if(e.length!==0)return Array.from(e)}restoreState(e){if(e===void 0){this.reset();return}this.curCoordinateSpace=void 0,this.coordinates_=Float32Array.from(Ee(e,Xe)),this.handleCoordinateSpaceChanged(),this.changed.dispatch()}snapToVoxel(){this.handleCoordinateSpaceChanged();const{bounds:{voxelCenterAtIntegerCoordinates:e}}=this.coordinateSpace.value,{coordinates_:t}=this,n=t.length;for(let s=0;s<n;++s)e[s]?t[s]=Math.round(t[s]):t[s]=Math.floor(t[s])+.5;this.changed.dispatch()}assign(e){e.handleCoordinateSpaceChanged();const{curCoordinateSpace:t,coordinates_:n}=e;this.curCoordinateSpace=t,this.coordinates_=Float32Array.from(n),this.changed.dispatch()}static getOffset(e,t){const n=e.coordinates_,s=t.coordinates_;if(n.length===s.length)return gg(new Float32Array(n.length),n,s)}static addOffset(e,t,n,s=1){e.handleCoordinateSpaceChanged();const{value:r}=t;n!==void 0&&r.length===n.length&&(DR(e.value,r,n,s),e.changed.dispatch())}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){e.reset()},restoreState(t){if(t===void 0||Array.isArray(t)){e.restoreState(t);return}ee(t),ln(t,"voxelCoordinates",e)}}}}var ms=(i=>(i[i.STOP=0]="STOP",i[i.LOOP=1]="LOOP",i[i.REVERSE=2]="REVERSE",i))(ms||{});const yE=10;class vp{constructor(){this.velocity=yE,this.atBoundary=2,this.paused=!0}}function F2(i,e){return i.velocity===e.velocity&&i.atBoundary===e.atBoundary&&i.paused===e.paused}function U2(i){return ee(i),{velocity:oe(i,"velocity",Xe,yE),atBoundary:oe(i,"atBoundary",e=>ft(e,ms),0),paused:oe(i,"paused",Ss,!0)}}function z2(i){const{velocity:e,atBoundary:t,paused:n}=i;return{velocity:e,atBoundary:t===0?void 0:ms[t].toLowerCase(),paused:n?void 0:!1}}class Ev extends K{constructor(e){var t;super(),this.coordinateSpace=e,this.changed=new ue,this.registerDisposer(e.changed.add(()=>{this.handleCoordinateSpaceChanged()})),this.curCoordinateSpace=e.value,this.velocities_=new Array(((t=this.curCoordinateSpace)==null?void 0:t.rank)??0)}get valid(){return this.coordinateSpace.value.valid}get value(){return this.handleCoordinateSpaceChanged(),this.velocities_}set value(e){const{curCoordinateSpace:t}=this;t===void 0||t.rank!==e.length||(this.velocities_=e,this.changed.dispatch())}get(e){var r;const t=(r=this.coordinateSpace.value)==null?void 0:r.ids;if(t===void 0)return;const n=t.indexOf(e);return n===-1?void 0:this.value[n]}dimensionVelocity(e,t){const n=new ue;let s=-1;const r=()=>{var h;const u=(h=this.coordinateSpace.value)==null?void 0:h.ids;u===void 0?s=-1:(s===-1||u[s]!==t)&&(s=u.indexOf(t))},o=()=>{if(r(),s!==-1)return this.value[s]},l=u=>{if(r(),s===-1)return;const h=this.value;h[s]!==u&&(h[s]=u,this.changed.dispatch())},c=o();return e.registerDisposer(this.changed.add(()=>{o()!==c&&n.dispatch()})),{get value(){return o()},set value(u){l(u)},changed:n}}modifyDimension(e,t){var c;const n=(c=this.coordinateSpace.value)==null?void 0:c.ids;if(n===void 0)return;const s=n.indexOf(e);if(s===-1)return;const r=this.value,o=r[s],l=t(o);o!==l&&(r[s]=l,this.changed.dispatch())}togglePlayback(e,t=void 0){this.modifyDimension(e,(n=new vp)=>({...n,paused:t??!n.paused}))}playbackEnabled(e){const t=this;return{changed:this.changed,get value(){return t.get(e)!==void 0},set value(n){t.modifyDimension(e,s=>n?s??new vp:void 0)}}}multiplyVelocity(e,t){this.modifyDimension(e,(n=new vp)=>{let s=Math.round(n.velocity*t);return s===0&&(s=Math.sign(n.velocity)||1),{...n,velocity:s}})}handleCoordinateSpaceChanged(){const e=this.coordinateSpace.value,t=this.curCoordinateSpace;if(e===t)return;this.curCoordinateSpace=e;const{rank:n}=e;if(!e.valid)return;if(t===void 0){let{velocities_:c}=this;c.length===n||(c=new Array(n)),this.changed.dispatch();return}const s=new Array(n),r=this.velocities_,{ids:o}=e,{ids:l}=t;for(let c=0;c<n;++c){const u=o[c],h=l.indexOf(u);h!==-1&&(s[c]=r[h])}this.velocities_=s,this.changed.dispatch()}toJSON(){this.handleCoordinateSpaceChanged();const{velocities_:e,curCoordinateSpace:t}=this;if(!(t!=null&&t.valid)||!e.some(o=>o!==void 0))return;const n={},{names:s,rank:r}=t;for(let o=0;o<r;++o){const l=e[o];l!==void 0&&(n[s[o]]=z2(l))}return n}reset(){var e;this.handleCoordinateSpaceChanged(),this.velocities_=new Array(((e=this.curCoordinateSpace)==null?void 0:e.rank)??0)}restoreState(e){if(e===void 0){this.reset();return}ee(e);const t=this.curCoordinateSpace=this.coordinateSpace.value;if(this.velocities_=new Array((t==null?void 0:t.rank)??0),t===void 0)throw new Error("Must specify dimensions in order to specify velocities");const n=this.velocities_=new Array((t==null?void 0:t.rank)??0),{names:s}=t;for(const r of Object.keys(e)){const o=s.indexOf(r);if(o===-1)throw new Error(`Invalid dimension name: ${JSON.stringify(r)}`);n[o]=z(e,r,U2)}this.changed.dispatch()}assign(e){const t=e.value,n=this.value,s=n.length;let r=!1;for(let o=0;o<s;++o){const l=t[o],c=n[o];l!==c&&((c===void 0||l===void 0||!F2(c,l))&&(r=!0),n[o]=l)}r&&this.changed.dispatch()}}class G2 extends K{constructor(e,t){super(),this.peer=e,this.positionLink=t,this.changed=new ue,this.velocity=this.registerDisposer(new Ev(this.peer.coordinateSpace)),this.registerDisposer(e),this.velocity.changed.add(()=>{this.positionLink.value===2?this.changed.dispatch():this.peer.assign(this.velocity)});const n=()=>{this.positionLink.value!==2&&this.velocity.assign(this.peer)};this.registerDisposer(e.changed.add(n)),n()}toJSON(){if(this.positionLink.value===2)return this.velocity.toJSON()}reset(){this.positionLink.value===2&&this.velocity.reset()}restoreState(e){this.positionLink.value===2&&this.velocity.restoreState(e)}copyToPeer(){this.positionLink.value===2&&this.peer.assign(this.velocity)}}class Tv extends K{constructor(e,t,n){super(),this.display=e,this.position=t,this.velocity=n,this.dimensionStates=new Map,this.lastUpdateGeneration=0,this.handleVelocityChanged(),this.registerDisposer(n.changed.add(()=>this.handleVelocityChanged()))}disposed(){var e;(e=this.unregisterUpdateStartedCallback)==null||e.call(this),super.disposed()}handleVelocityChanged(){var c;const{dimensionStates:e}=this,t=((c=this.position.coordinateSpace.value)==null?void 0:c.ids)??[],n=t.length,s=this.velocity.value,r=++this.lastUpdateGeneration,o=this.position.value,l=Date.now();for(let u=0;u<n;++u){const h=s[u];if(h===void 0||h.velocity===0||h.paused)continue;const g=t[u],v=e.get(g);v===void 0?e.set(g,{prevTime:l,dimensionIndex:u,prevCoordinate:o[u],generation:r}):(v.generation=r,v.dimensionIndex=u)}for(const[u,h]of e)h.generation!==r&&e.delete(u);if(e.size===0){const{unregisterUpdateStartedCallback:u}=this;u!==void 0&&(u(),this.unregisterUpdateStartedCallback=void 0)}else this.unregisterUpdateStartedCallback===void 0&&(this.unregisterUpdateStartedCallback=this.display.updateStarted.add(()=>this.updateStarted()),this.display.scheduleRedraw())}updateStarted(){const e=this.position.coordinateSpace.value;if(e===void 0)return;const t=e.ids,n=this.position.value;let s=!1,r=!1;const o=Date.now(),l=this.velocity.value,{bounds:{lowerBounds:c,upperBounds:u}}=e;for(const[h,g]of this.dimensionStates){const{dimensionIndex:v}=g;if(t[v]!==h)continue;const y=l[v];if(Math.floor(n[v])!==Math.floor(g.prevCoordinate)){(y==null?void 0:y.paused)===!1&&(l[v]={...y,paused:!0},r=!0);continue}const b=o-g.prevTime,w=(y==null?void 0:y.velocity)??0,C=b*w/1e3;if(C===0)continue;let E=n[v]+C;const k=c[v],D=Math.ceil(u[v]-1),A=C>0?D:k,N=C>0?k:D,I=Math.sign(C);if(Number.isFinite(A)&&E*I>=A*I)switch(y.atBoundary){case 1:if(Number.isFinite(N)){E=N;break}case 0:l[v]={...y,paused:!0},r=!0,E=A;break;case 2:l[v]={...y,velocity:-w},r=!0,E=A;break}n[v]=E,g.prevCoordinate=n[v],g.prevTime=o,s=!0}s&&this.position.changed.dispatch(),r&&this.velocity.changed.dispatch(),this.display.scheduleRedraw()}}function SE(i,e,t){if(t===void 0||Object.keys(t).length===0){i.value=0;return}ee(t),i.value=2,z(t,"value",n=>{n!==void 0&&e.restoreState(n)}),z(t,"link",n=>i.restoreState(n))}class Gc{constructor(e,t=new B2){this.peer=e,this.link=t}get changed(){return this.value.changed}toJSON(){const{link:e}=this;if(e.value!==0)return{link:e.toJSON(),value:this.getValueJson()}}getValueJson(){return this.value.toJSON()}reset(){this.link.value=0}restoreState(e){SE(this.link,this.value,e)}copyToPeer(){this.link.value!==0&&(this.link.value=2,this.peer.assign(this.value),this.link.value=0)}}class bE extends Gc{}class wE extends Gc{constructor(){super(...arguments),this.value=zc(new $r(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:e=>e.valid,difference:$r.getOffset,add:$r.addOffset,subtract:(e,t,n)=>{$r.addOffset(e,t,n,-1)}})}}function $2(i){return i[0]===0&&i[1]===0&&i[2]===0&&i[3]===1}class ka extends K{constructor(e){super(),this.changed=new ue,e==null&&(e=Cn()),this.orientation=e}toJSON(){const{orientation:e}=this;if(Wl(this.orientation,this.orientation),!$2(e))return Array.prototype.slice.call(this.orientation)}restoreState(e){try{jd(this.orientation,e),Wl(this.orientation,this.orientation)}catch{j0(this.orientation)}this.changed.dispatch()}reset(){j0(this.orientation),this.changed.dispatch()}snap(){const e=Dc();gx(e,this.orientation);const t=[!1,!1,!1];for(let n=0;n<3;++n){let s=0,r=0;for(let o=0;o<3;++o){const l=e[n*3+o];e[n*3+o]=0,!t[o]&&Math.abs(l)>Math.abs(s)&&(s=l,r=o)}e[n*3+r]=Math.sign(s),t[r]=!0}yx(this.orientation,e),this.changed.dispatch()}static makeRelative(e,t){const n=new ka(lr(Cn(),e.orientation,t));let s=!1;n.registerDisposer(e.changed.add(()=>{s||(r=!0,lr(n.orientation,e.orientation,t),n.changed.dispatch(),r=!1)}));let r=!1;const o=au(Cn(),t);return n.registerDisposer(n.changed.add(()=>{r||(s=!0,lr(e.orientation,n.orientation,o),e.changed.dispatch(),s=!1)})),n}assign(e){EA(this.orientation,e.orientation),this.changed.dispatch()}}class Ig extends Gc{constructor(){super(...arguments),this.value=zc(new ka,this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0,difference:(e,t)=>{const n=Cn();return lr(n,au(n,t.orientation),e.orientation)},add:(e,t,n)=>{lr(e.orientation,t.orientation,n),e.changed.dispatch()},subtract:(e,t,n)=>{lr(e.orientation,t.orientation,au(mE,n)),e.changed.dispatch()}})}}class CE extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new ue,this.curCoordinateSpace=bs,this.value_={factors:new Float64Array(0)},this.registerDisposer(e.changed.add(()=>this.update())),this.update()}get value(){return this.update()}reset(){this.value_={factors:new Float64Array(0)},this.curCoordinateSpace=bs,this.changed.dispatch()}toJSON(){const e={};let t=!1;const{value:n}=this,{factors:s}=n,{names:r,rank:o}=this.curCoordinateSpace;for(let l=0;l<o;++l){const c=s[l];c!==1&&(e[r[l]]=c,t=!0)}if(t)return e}restoreState(e){const{coordinateSpace:{value:t}}=this,{names:n,rank:s}=t,r=new Float64Array(s);if(r.fill(-1),e!==void 0){const o=ee(e);for(let l=0;l<s;++l)r[l]=z(o,n[l],c=>c===void 0?1:wt(c))}this.value_={factors:r},this.curCoordinateSpace=t,this.changed.dispatch()}setFactors(e){const{coordinateSpace:{value:t}}=this;e.length===t.rank&&(this.value_={factors:e},this.curCoordinateSpace=t,this.changed.dispatch())}update(){const{coordinateSpace:{value:e}}=this;let t=this.value_;const{curCoordinateSpace:n}=this;if(n===e)return t;const{ids:s}=n,{ids:r,rank:o}=e,l=t.factors,c=new Float64Array(o);c.fill(1);for(let u=0;u<o;++u){const h=r[u],g=s.indexOf(h);g!==-1&&(c[u]=l[g])}return De(c,l)||(t=this.value_={factors:c},this.curCoordinateSpace=e,this.changed.dispatch()),t}assign(e){this.setFactors(e.value.factors)}}function Cb(i,e,t,n,s){if(t===n)return e;const{ids:r}=t,{rank:o,ids:l}=n,c=new i(o);for(let u=0;u<o;++u){const h=l[u],g=r.indexOf(h);c[u]=g===-1?s(u):e[g]}return c}class W2 extends Gc{constructor(){super(...arguments),this.value=zc(new CE(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),difference:(e,t)=>{const{factors:n}=e.value,s=e.coordinateSpace.value,r=t.value.factors;return{coordinateSpace:s,offsets:gg(new Float64Array(n.length),n,r)}},add:(e,t,n)=>{const s=Cb(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(Hx(new Float64Array(s.length),s,t.value.factors))},subtract:(e,t,n)=>{const s=Cb(Float64Array,n.offsets,n.coordinateSpace,e.coordinateSpace.value,()=>0);e.setFactors(gg(new Float64Array(s.length),t.value.factors,s))},isValid:()=>!0})}}function xb(i,e,t){const{rank:n,names:s,units:r}=i,{displayRank:o,displayDimensionIndices:l}=e,c=new Float64Array(3),u=new Float64Array(3);let h;const{factors:g}=t,v=new Array(3),y=new Float64Array(3);if(c.fill(1),u.fill(1),y.fill(1),v.fill(""),o===0)h=1;else{h=Number.POSITIVE_INFINITY;const{scales:b}=i;for(let w=0;w<o;++w){const C=l[w],E=u[w]=g[C]*b[C];h=Math.min(h,E),v[w]=r[C],y[w]=b[C]}for(let w=0;w<o;++w)c[w]=u[w]/h}return{globalRank:n,globalDimensionNames:s,displayRank:o,displayDimensionIndices:l,displayDimensionUnits:v,displayDimensionScales:y,canonicalVoxelFactors:c,voxelPhysicalScales:u,canonicalVoxelPhysicalSize:h}}function H2(i,e){return De(i.globalDimensionNames,e.globalDimensionNames)&&De(i.displayDimensionIndices,e.displayDimensionIndices)&&De(i.canonicalVoxelFactors,e.canonicalVoxelFactors)&&De(i.voxelPhysicalScales,e.voxelPhysicalScales)&&i.canonicalVoxelPhysicalSize===e.canonicalVoxelPhysicalSize&&De(i.displayDimensionUnits,e.displayDimensionUnits)&&De(i.displayDimensionScales,e.displayDimensionScales)}class xE extends K{constructor(e,t){super(),this.relativeDisplayScales=e,this.displayDimensions=t,this.changed=new ue,this.curRelativeDisplayScales=this.relativeDisplayScales.value,this.curDisplayDimensions=this.displayDimensions.value,this.curCoordinateSpace=this.relativeDisplayScales.coordinateSpace.value,this.value_=xb(this.curCoordinateSpace,this.curDisplayDimensions,this.curRelativeDisplayScales),this.registerDisposer(e),this.registerDisposer(t);const n=()=>{this.value};this.registerDisposer(e.changed.add(n)),this.registerDisposer(t.changed.add(n))}get value(){const{relativeDisplayScales:{value:e,coordinateSpace:{value:t}},displayDimensions:{value:n},curRelativeDisplayScales:s,curDisplayDimensions:r,curCoordinateSpace:o}=this;let l=this.value_;if(s!==e||r!==n||o!==t){this.curRelativeDisplayScales=e,this.curDisplayDimensions=n,this.curCoordinateSpace=t;const c=xb(t,n,e);H2(l,c)||(this.value_=l=c,this.changed.dispatch())}return l}}class EE extends K{constructor(e){super(),this.coordinateSpace=e,this.changed=new ue,this.default_=!0,this.value_=void 0,this.registerDisposer(this.coordinateSpace.changed.add(this.changed.dispatch)),this.update()}get value(){return this.update(),this.value_}update(){const{coordinateSpace:{value:e}}=this,t=this.value_;if(t!==void 0&&t.coordinateSpace===e)return;if(t===void 0||this.default_){this.setToDefault(e);return}const n=new Int32Array(3),{ids:s}=t.coordinateSpace,{ids:r}=e,o=t.displayDimensionIndices,l=t.displayRank;let c=0;for(let u=0;u<l;++u){const h=r.indexOf(s[o[u]]);h!==-1&&(n[c]=h,++c)}if(n.fill(-1,c),c===0){this.default_=!0,this.setToDefault(e);return}this.assignValue(e,c,n),this.changed.dispatch()}setToDefault(e){const t=Math.min(e.rank,3),n=new Int32Array(3);n.fill(-1);for(let s=0;s<t;++s)n[s]=s;this.assignValue(e,t,n)}assignValue(e,t,n){this.value_={coordinateSpace:e,displayRank:t,displayDimensionIndices:n},this.changed.dispatch()}reset(){this.default_=!0,this.value_=void 0,this.changed.dispatch()}restoreState(e){if(e===void 0){this.reset();return}const t=rv(e);if(t.length>3)throw new Error("Number of spatial dimensions must be <= 3");const{coordinateSpace:{value:n}}=this,s=new Int32Array(3);s.fill(-1);const{names:r}=n;let o=0;for(const l of t){const c=r.indexOf(l);c!==-1&&(s[o++]=c)}if(o===0){this.reset();return}this.default_=!1,this.assignValue(n,o,s)}get default(){return this.update(),this.default_}set default(e){this.default_!==e&&(e?(this.default_=!0,this.setToDefault(this.coordinateSpace.value)):(this.default_=!1,this.changed.dispatch()))}setDimensionIndices(e,t){this.default_=!1,this.assignValue(this.coordinateSpace.value,e,t)}toJSON(){if(this.default_)return;const{value:e}=this,t=[],{displayRank:n,displayDimensionIndices:s,coordinateSpace:{names:r}}=e;if(n!==0){for(let o=0;o<n;++o)t[o]=r[s[o]];return t}}assign(e){if(e.default)this.default=!0;else{const{displayRank:t,displayDimensionIndices:n}=e.value;this.setDimensionIndices(t,n)}}}class J2 extends bE{constructor(){super(...arguments),this.value=vE(new EE(this.peer.coordinateSpace),this.peer,this.link,{assign:(e,t)=>e.assign(t),isValid:()=>!0})}}class La extends K{constructor(e,t,n){super(),this.position=e,this.displayDimensionRenderInfo=t,this.orientation=n,this.changed=new ue,this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t),this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(n.changed.add(this.changed.dispatch)),this.registerDisposer(t.changed.add(this.changed.dispatch))}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}get valid(){return this.position.valid}reset(){this.position.reset(),this.orientation.reset(),this.displayDimensions.reset()}updateDisplayPosition(e,t=Od){const{coordinateSpace:{value:n},value:s}=this.position,{displayDimensionIndices:r,displayRank:o}=this.displayDimensions.value;if(n===void 0)return!1;t.fill(0);for(let l=0;l<o;++l){const c=r[l];t[l]=s[c]}if(e(t)!==!1){for(let l=0;l<o;++l){const c=r[l];s[c]=t[l]}return this.position.changed.dispatch(),!0}return!1}toMat4(e,t){dA(e,this.orientation.orientation);const{value:n}=this.position,{canonicalVoxelFactors:s,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value;for(let o=0;o<3;++o){const l=r[o],c=t/s[o];e[o]*=c,e[4+o]*=c,e[8+o]*=c,e[12+o]=n[l]||0}}toMat3(e,t){gx(e,this.orientation.orientation);const{canonicalVoxelFactors:n,displayRank:s}=this.displayDimensionRenderInfo.value;for(let r=0;r<s;++r){const o=t/n[r];e[r]*=o,e[3+r]*=o,e[6+r]*=o}}snap(){this.orientation.snap(),this.position.snapToVoxel(),this.changed.dispatch()}translateDimensionRelative(e,t){if(!this.valid)return;const{position:n}=this,{value:s}=n,{bounds:r}=n.coordinateSpace.value;s[e]=vg(r,e,s[e]+t),n.changed.dispatch()}translateVoxelsRelative(e){if(!this.valid)return;const t=ta(Od,e,this.orientation.orientation),{position:n}=this,{value:s}=n,{displayDimensionIndices:r,displayRank:o}=this.displayDimensions.value,{bounds:l}=n.coordinateSpace.value;for(let c=0;c<o;++c){const u=r[c],h=t[c];h!==0&&(s[u]=vg(l,u,s[u]+h))}this.position.changed.dispatch()}rotateRelative(e,t){const n=Cn();tg(n,e,t);const s=this.orientation.orientation;lr(s,s,n),this.orientation.changed.dispatch()}rotateAbsolute(e,t,n){const{coordinateSpace:{value:s},value:r}=this.position;if(s===void 0)return;const{relativeDisplayScales:{value:{factors:o}},displayDimensions:{value:{displayDimensionIndices:l,displayRank:c}}}=this,{scales:u}=s,h=Cn();tg(h,e,t);const g=this.orientation.orientation,v=Od;Od.fill(0);for(let b=0;b<c;++b){const w=l[b],C=n[w]-r[w];v[b]=C*u[w]*o[w]}const y=au(mE,g);ta(v,v,y),lr(g,h,g),ta(v,v,g);for(let b=0;b<c;++b){const w=l[b];r[w]=n[w]-v[b]/(u[w]*o[w])}this.position.changed.dispatch(),this.orientation.changed.dispatch()}translateNonDisplayDimension(e,t){if(!this.valid)return;const{displayDimensionIndices:n}=this.displayDimensions.value,{position:s}=this,r=s.coordinateSpace.value.rank;for(let o=0;o<r;++o)if(n.indexOf(o)===-1&&e--===0){this.translateDimensionRelative(o,t);return}}}class Pg extends Gc{constructor(e,t){super(e),this.value=(()=>{const n=new e.constructor(t),s=(u,h)=>{u.assign(h)},r=(u,h)=>u.value/h.value*(u.canonicalVoxelPhysicalSize/h.canonicalVoxelPhysicalSize),o=(u,h,g)=>{u.setPhysicalScale(h.value*g,h.canonicalVoxelPhysicalSize)},l=(u,h,g)=>{u.setPhysicalScale(h.value/g,h.canonicalVoxelPhysicalSize)},c=u=>u.coordinateSpaceValue.valid&&u.canonicalVoxelPhysicalSize!==0;return zc(n,this.peer,this.link,{assign:s,isValid:c,difference:r,add:o,subtract:l}),n})()}}function ec(i){return{changed:i.changed,toJSON(){return i.toJSON()},restoreState(e){SE(i.link,i.value.legacyJsonView,e)},reset(){i.reset()}}}class TE extends K{constructor(e){super(),this.displayDimensionRenderInfo=e,this.changed=new ue,this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.registerDisposer(e),this.registerDisposer(e.changed.add(()=>this.handleCoordinateSpaceChanged())),this.registerDisposer(e.relativeDisplayScales.coordinateSpace.changed.add(()=>this.handleCoordinateSpaceChanged())),this.handleCoordinateSpaceChanged()}get value(){return this.handleCoordinateSpaceChanged(),this.value_}set value(e){const{canonicalVoxelPhysicalSize:t}=this;Object.is(e,this.value_)&&t===this.curCanonicalVoxelPhysicalSize||(this.curCanonicalVoxelPhysicalSize=t,this.legacyValue_=Number.NaN,this.value_=e,this.changed.dispatch())}get canonicalVoxelPhysicalSize(){return this.displayDimensionRenderInfo.value.canonicalVoxelPhysicalSize}get coordinateSpaceValue(){return this.displayDimensionRenderInfo.relativeDisplayScales.coordinateSpace.value}set legacyValue(e){Object.is(e,this.legacyValue_)||(this.value_=Number.NaN,this.legacyValue_=e,this.curCanonicalVoxelPhysicalSize=0,this.changed.dispatch())}get legacyValue(){return this.legacyValue_}handleCoordinateSpaceChanged(){const{value_:e}=this,{displayDimensionRenderInfo:{value:{canonicalVoxelPhysicalSize:t},relativeDisplayScales:{coordinateSpace:{value:n}}}}=this,{curCanonicalVoxelPhysicalSize:s}=this;if(!(!Number.isNaN(e)&&t===s)){if(!Number.isNaN(e)){s!==0&&(this.value_=e*(s/t),this.curCanonicalVoxelPhysicalSize=t,this.changed.dispatch());return}!n.valid||t===0||(this.curCanonicalVoxelPhysicalSize=t,this.value_=this.getDefaultValue(),this.changed.dispatch())}}toJSON(){const{value:e}=this;return Number.isNaN(e)?void 0:e}restoreState(e){this.curCanonicalVoxelPhysicalSize=0,this.legacyValue_=Number.NaN,e===void 0?this.value_=Number.NaN:this.value_=wt(e),this.changed.dispatch()}reset(){this.curCanonicalVoxelPhysicalSize=0,this.value_=Number.NaN,this.legacyValue_=Number.NaN,this.changed.dispatch()}get legacyJsonView(){const e=this;return{changed:e.changed,toJSON(){return e.toJSON()},reset(){return e.reset()},restoreState(t){e.legacyValue=wt(t)}}}setPhysicalScale(e,t){const n=this.curCanonicalVoxelPhysicalSize=this.canonicalVoxelPhysicalSize;this.value=e*(t/n)}assign(e){const{legacyValue:t}=e;Number.isNaN(t)?this.setPhysicalScale(e.value,e.canonicalVoxelPhysicalSize):this.legacyValue=t}}class j2 extends TE{getDefaultValue(){const{legacyValue_:e}=this;if(Number.isNaN(e))return 1;const{canonicalVoxelPhysicalSize:t}=this;return this.legacyValue_*1e-9/t}}class Y2 extends TE{getDefaultValue(){const{legacyValue_:e}=this;if(!Number.isNaN(e)){this.legacyValue_=Number.NaN;const{canonicalVoxelPhysicalSize:l}=this;return 2*100*Math.tan(Math.PI/8)*1e-9*e/l}const{coordinateSpaceValue:{bounds:{lowerBounds:t,upperBounds:n}}}=this,{canonicalVoxelFactors:s,displayDimensionIndices:r}=this.displayDimensionRenderInfo.value;let o=s.reduce((l,c,u)=>{const h=r[u],g=(n[h]-t[h])*c;return Math.max(l,g)},0);return Number.isFinite(o)?o=2**Math.ceil(Math.log2(o)):o=1024,o}}class Ag extends K{constructor(e,t){super(),this.defaultValue=e,this.displayDimensionRenderInfo=t,this.changed=new ue,this.value_=e,this.canonicalVoxelPhysicalSize=t.value.canonicalVoxelPhysicalSize,this.registerDisposer(t.changed.add(()=>{this.value}))}get value(){let{value_:e}=this;if(e>0){const{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value,n=this.canonicalVoxelPhysicalSize;t!==n&&(this.canonicalVoxelPhysicalSize=t,e=this.value_=e=n/t,this.changed.dispatch())}return e}set value(e){if(e===this.value)return;this.value_=e;const{canonicalVoxelPhysicalSize:t}=this.displayDimensionRenderInfo.value;this.canonicalVoxelPhysicalSize=t,this.changed.dispatch()}toJSON(){const{value:e}=this;if(e!==this.defaultValue)return e}reset(){this.value=this.defaultValue}restoreState(e){typeof e!="number"||!Number.isFinite(e)||e===0?this.value=this.defaultValue:this.value=e}setValueAbsolute(e,t){if(e>0){const{canonicalVoxelPhysicalSize:n}=this.displayDimensionRenderInfo.value;e=e*(t/n)}this.value=e}assign(e){this.setValueAbsolute(e.value,e.canonicalVoxelPhysicalSize)}}class Eb extends bE{constructor(e,t){super(e),this.value=vE(new Ag(e.defaultValue,t),this.peer,this.link,{assign:(n,s)=>n.assign(s),isValid:()=>!0})}}class Da extends K{constructor(e,t,n){super(),this.pose=e,this.zoomFactor=t,this.depthRange=n,this.changed=new ue,this.registerDisposer(e),this.registerDisposer(t),this.registerDisposer(n),this.registerDisposer(this.pose.changed.add(this.changed.dispatch)),this.registerDisposer(this.zoomFactor.changed.add(this.changed.dispatch)),this.registerDisposer(this.depthRange.changed.add(this.changed.dispatch))}get coordinateSpace(){return this.pose.position.coordinateSpace}reset(){this.pose.reset(),this.zoomFactor.reset()}get position(){return this.pose.position}get displayDimensions(){return this.pose.displayDimensions}get relativeDisplayScales(){return this.pose.relativeDisplayScales}get displayDimensionRenderInfo(){return this.pose.displayDimensionRenderInfo}toMat4(e){this.pose.toMat4(e,this.zoomFactor.value)}toMat3(e){this.pose.toMat3(e,this.zoomFactor.value)}get relativeDepthRange(){let e=this.depthRange.value;return e>0?e/=this.zoomFactor.value:e*=-1,e}get valid(){return this.pose.valid&&!Number.isNaN(this.zoomFactor.value)}zoomBy(e){this.zoomFactor.value*=e}}const q2=300,K2=100,ao={side:"right",col:0,row:1/0,flex:1,size:q2,minSize:K2,visible:!1};class wr{constructor(e=ao,t=e){this.defaultValue=e,this.value=t,this.changed=new Ze,this.locationChanged=new Ze,this.locationChanged.add(this.changed.dispatch);const n=this;this.watchableVisible={get value(){return n.visible},set value(s){n.visible=s},changed:n.locationChanged}}toJSON(e=this.defaultValue){const t={},{value:n}=this;for(const s in n)n[s]!==e[s]&&(t[s]=n[s]);return t}get visible(){return this.value.visible}set visible(e){const{value:t}=this;t.visible!==e&&(this.value={...t,visible:e},this.locationChanged.dispatch())}reset(){this.value!==this.defaultValue&&(this.value=this.defaultValue,this.locationChanged.dispatch())}restoreState(e,t=this.defaultValue){if(e===void 0)return;ee(e);const n={side:oe(e,"side",s=>{if(s!=="left"&&s!=="right"&&s!=="top"&&s!=="bottom")throw new Error(`Expected "left", "right", "top", or "bottom", but received: ${JSON.stringify(s)}`);return s},t.side),col:oe(e,"col",Xe,t.col),row:oe(e,"row",Xe,t.row),flex:oe(e,"flex",Xe,t.flex),size:oe(e,"size",ht,t.size),visible:oe(e,"visible",Ss,t.visible),minSize:t.minSize};this.value=n,this.locationChanged.dispatch()}}const _d="tab",Tb="tabs",kb="panels",X2={...ao,row:0},kE={...ao,visible:!0,row:0};class tc extends K{constructor(e){super(),this.panels=e,this.layer=this.panels.layer,this.location=new wr(kE),this.tabsChanged=new Ze,this.selectedTab=new Ne(void 0),this.tabs=[]}initialize(){const{panels:e}=this;this.tabsChanged.add(e.specificationChanged.dispatch),this.selectedTab.changed.add(e.specificationChanged.dispatch),this.location.changed.add(()=>{var r;e.specificationChanged.dispatch();const{layer:t}=this,{selectedLayer:n}=t.manager.root;if(((r=n.layer)==null?void 0:r.layer)!==t||this!==t.panels.panels[0])return;const s=this.location.value;n.location.value!==s&&(n.location.value=s,n.location.locationChanged.dispatch())}),this.location.locationChanged.add(()=>{this.location.visible||this!==this.panels.panels[0]&&this.panels.removePanel(this)});for(const t of this.tabs){const{hidden:n}=this.layer.tabs.options.get(t);n&&this.registerDisposer(n.changed.add(()=>{this.panels.updateTabs(),this.tabsChanged.dispatch()}))}}normalizeTabs(){const{tabs:e}=this;if(e.length===0){this.selectedTab.value=void 0;return}const t=this.layer.tabs.options,n=o=>t.get(o).order??0;e.sort((o,l)=>n(o)-n(l));const{selectedTab:s}=this,r=s.value;(r===void 0||!e.includes(r))&&(s.value=e[0])}pin(){var r;const{layer:e}=this,{selectedLayer:t}=e.manager.root;if(((r=t.layer)==null?void 0:r.layer)!==e||this!==e.panels.panels[0]||this.tabs.length===0)return;const{panels:n}=this,s=e.registerDisposer(new tc(n));n.panels.splice(0,1,s),n.panels.push(this),n.updateTabs(),s.initialize(),t.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}unpin(){var l;const{panels:e}=this,t=e.panels.indexOf(this);if(t===-1||t===0)return;const{layer:n}=this,{selectedLayer:s}=n.manager.root,r=(l=s.layer)==null?void 0:l.layer;s.visible&&r!=null&&r!==n&&r.panels.panels[0].pin(),e.panels.splice(t,1);const[o]=e.panels.splice(0,1,this);if(this.explicitTabs===void 0)n.unregisterDisposer(o);else{e.panels.push(o);for(let c=1,u=e.panels.length;c<u;++c){const h=e.panels[c];h.explicitTabs===void 0&&(h.explicitTabs=new Set(h.tabs))}}this.explicitTabs=void 0,e.updateTabs(),s.layer=n.managedLayer,s.location.value=this.location.value,s.location.locationChanged.dispatch(),s.layerManager.layersChanged.dispatch(),this.panels.specificationChanged.dispatch()}splitOffTab(e,t){if(!this.tabs.includes(e))return;const{panels:n}=this;{const{explicitTabs:o}=this;o!==void 0&&o.delete(e)}const{layer:s}=this,r=s.registerDisposer(new tc(n));r.location.value=t,r.explicitTabs=new Set([e]),n.panels.splice(1,0,r),n.updateTabs(),r.initialize(),s.manager.root.layerManager.layersChanged.dispatch(),n.specificationChanged.dispatch()}moveTabTo(e,t){if(!this.tabs.includes(e))return;{const{explicitTabs:s}=this;s!==void 0&&s.delete(e)}{const{explicitTabs:s}=t;s!==void 0&&s.add(e)}const{panels:n}=this;n.updateTabs(),t.selectedTab.value=e,n.specificationChanged.dispatch()}mergeInto(e){const{explicitTabs:t}=e;if(t!==void 0)for(const s of this.tabs)t.add(s);const{panels:n}=this;n.removePanel(this)}}class Q2{constructor(e){this.layer=e,this.specificationChanged=new Ze,this.updating=!1,this.panels=[e.registerDisposer(new tc(this))]}restoreState(e){const{panels:t}=this;t[0].selectedTab.value=oe(e,_d,ie);const{layer:n}=this,{tabs:s}=n,r=new Set(s.options.keys());oe(e,kb,o=>Ee(o,l=>{ee(l);const c=new tc(this);c.location.restoreState(l),c.location.visible&&(c.selectedTab.value=oe(l,_d,ie),c.explicitTabs=oe(l,Tb,u=>{const h=new Set;for(const g of Zn(u))r.has(g)&&(r.delete(g),h.add(g));return h}),c.explicitTabs===void 0?(c.tabs=Array.from(r),r.clear()):c.tabs=Array.from(c.explicitTabs),c.tabs.length!==0&&(c.normalizeTabs(),n.registerDisposer(c),c.initialize(),t.push(c)))})),t[0].tabs=Array.from(r),t[0].normalizeTabs(),this.panels[0].initialize()}removePanel(e){if(this.updating)return;const t=this.panels.indexOf(e);this.panels.splice(t,1),this.layer.unregisterDisposer(e),this.updateTabs()}updateTabs(){var o;const{layer:e}=this,{tabs:t}=e,n=new Set(t.options.keys()),{panels:s}=this;this.updating=!0;const r=l=>{const c=l.tabs;if(l.explicitTabs===void 0)l.tabs=Array.from(n),n.clear();else{l.tabs=Array.from(l.explicitTabs);for(const u of l.tabs)n.delete(u)}De(c,l.tabs)||(l.normalizeTabs(),l.tabsChanged.dispatch())};for(let l=1;l<s.length;){const c=s[l];if(c.location.visible&&(r(c),c.tabs.length!==0)){++l;continue}s.splice(l,1),e.unregisterDisposer(c)}if(r(s[0]),s[0].tabs.length===0){const{selectedLayer:l}=this.layer.manager.root;((o=l.layer)==null?void 0:o.layer)===this.layer&&(l.location.visible=!1)}this.updating=!1}toJSON(){const{panels:e}=this,t={};if(t[_d]=e[0].selectedTab.value,e.length>1){const n=[];for(let s=1,r=e.length;s<r;++s){const o=e[s],l=o.location.toJSON()??{};l[_d]=o.selectedTab.value;const{explicitTabs:c}=o;c!==void 0&&(l[Tb]=Array.from(c)),n.push(l)}t[kb]=n}return t}}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Z2{constructor(e){if(this.parents=new Array,this.parentPriorities=new Array,this.bindings=new Map,e!==void 0){this.parents.push(...e.parents),this.parentPriorities.push(...e.parentPriorities);for(const[t,n]of e.bindings)this.bindings.set(t,n)}}addParent(e,t){const{parents:n,parentPriorities:s}=this;let r=0;const{length:o}=n;for(;r<o&&t<s[r];)++r;return n.splice(r,0,e),s.splice(r,0,t),()=>{this.removeParent(e)}}removeParent(e){const t=this.parents.indexOf(e);if(t===-1)throw new Error("Attempt to remove non-existent parent map.");this.parents.splice(t,1),this.parentPriorities.splice(t,1)}set(e,t){this.bindings.set(e,t)}delete(e){this.bindings.delete(e)}clear(){this.bindings.clear(),this.parents.length=0,this.parentPriorities.length=0}get(e){const{parents:t,parentPriorities:n}=this,s=n.length;let r=0,o;for(;r<s&&n[r]>0;++r)if(o=t[r].get(e),o!==void 0)return o;if(o=this.bindings.get(e),o!==void 0)return o;for(;r<s;++r)if(o=t[r].get(e),o!==void 0)return o}*getAll(e){const{parents:t,parentPriorities:n}=this,s=n.length,r=0;let o;for(;r<s&&n[r]>0;)o=t[r].get(e),o!==void 0&&(yield o);for(o=this.bindings.get(e),o!==void 0&&(yield o);r<s;)o=t[r].get(e),o!==void 0&&(yield o)}*entries(){const{parents:e,parentPriorities:t}=this,n=t.length;let s=0;for(;s<n&&t[s]>0;++s)yield*e[s].entries();for(yield*this.bindings.entries();s<n;++s)yield*e[s].entries()}}var LE=(i=>(i[i.CONTROL=1]="CONTROL",i[i.ALT=2]="ALT",i[i.META=4]="META",i[i.SHIFT=8]="SHIFT",i))(LE||{});function kv(i){return(i.ctrlKey?1:0)|(i.altKey?2:0)|(i.metaKey?4:0)|(i.shiftKey?8:0)}function Rg(i,e){let t="";return e&1&&(t+="control+"),e&2&&(t+="alt+"),e&4&&(t+="meta+"),e&8&&(t+="shift+"),t+=i,t}function eO(i,e,t){let n="";return e&1&&(n+="control+"),t&1&&(n+="control?+"),e&2&&(n+="alt+"),t&2&&(n+="alt?+"),e&4&&(n+="meta+"),t&4&&(n+="meta?+"),e&8&&(n+="shift+"),t&8&&(n+="shift?+"),n+=i,n}function Lb(i){const e=i.indexOf(":");let t;if(e!==-1&&(t=i.substring(0,e),t!=="at"&&t!=="bubble"))throw new Error(`Invalid event phase: ${JSON.stringify(t)}`);const n=i.substring(e+1).split("+");let s,r=0,o=0;e:for(const l of n)switch(l){case"control":r|=1;break;case"control?":o|=1;break;case"alt":r|=2;break;case"alt?":o|=2;break;case"meta":r|=4;break;case"meta?":o|=4;break;case"shift":r|=8;break;case"shift?":o|=8;break;default:if(s===void 0)s=l;else{s=void 0;break e}}if(s===void 0||r&o)throw new Error(`Invalid event identifier: ${JSON.stringify(i)}`);return{phase:t,keyName:s,modifiers:r,optionalModifiers:o}}function*tO(i,e,t){t===0&&(yield Rg(i,e));for(let n=0;n<16;++n)(n&(e|t))===n&&(n&e)===e&&(yield Rg(i,n))}function*Db(i){const{phase:e}=i,t=tO(i.keyName,i.modifiers,i.optionalModifiers);if(e===void 0)for(const n of t)yield`at:${n}`,yield`bubble:${n}`;else for(const n of t)yield`${e}:${n}`}function nO(i,e){const t=eO(i.keyName,i.modifiers,i.optionalModifiers);return typeof e=="string"?{action:e,originalEventIdentifier:t}:{...e,originalEventIdentifier:t}}function iO(i){return i=i.replace(/^(?:at|bubble|capture)|(?:(?:shift|control|alt|meta)\?\+)/g,""),i}class He extends Z2{static fromObject(e,t={}){const n=new He;if(n.label=t.label,t.parents!==void 0)for(const[s,r]of t.parents)n.addParent(s,r);for(const s of Object.keys(e))n.set(s,e[s]);return n}setFromObject(e){for(const t of Object.keys(e))this.set(t,e[t])}set(e,t){const n=Lb(e),s=nO(n,t);for(const r of Db(n))super.set(r,s)}delete(e){for(const t of Db(Lb(e)))super.delete(t)}describe(){const e=[],t=new Map;for(const[,s]of this.entries())t.set(s.originalEventIdentifier,s.action);const n=new Map;for(const[s,r]of t){let o=n.get(r);o===void 0&&(o=[],n.set(r,o)),o.push(iO(s))}for(const[s,r]of n){const o=r.length===1?r[0]:`{${r.join(",")}}`;e.push(`${o}→${s}`)}return e.join(", ")}}function DE(i,e,t){if(t===void 0)return;t.stopPropagation!==!1&&i.stopPropagation();const n=new CustomEvent("action:"+t.action,{bubbles:!0,detail:e,cancelable:!0}),s=!i.target.dispatchEvent(n);(t.preventDefault!==!1||s)&&i.preventDefault()}const Rh=[];Rh[Event.AT_TARGET]="at";Rh[Event.CAPTURING_PHASE]="capture";Rh[Event.BUBBLING_PHASE]="bubble";function IE(i,e,t,n,s){const r=Rh[t]+":"+i,o=s.get(r);DE(e,n,o)}function PE(i,e,t,n){IE(Rg(i,kv(e)),e,e.eventPhase,t,n)}function fe(i,e,t,n){return ti(i,`action:${e}`,t,n)}const sO=/^[A-Z]$/;class Ib extends K{constructor(e,t){super(),this.tool=e,this.inputEventMapBinder=t}bindAction(e,t){this.registerDisposer(fe(window,e,t))}bindInputEventMap(e){this.inputEventMapBinder(e,this)}cancel(){const{globalBinder:e}=this.tool;this===e.activeTool_&&e.deactivate_()}}class Tu extends K{constructor(e,t=!1){super(),this.localBinder=e,this.toggle=t,this.changed=new Ze,this.keyBinding=void 0}get context(){return this.localBinder.context}get globalBinder(){return this.localBinder.globalBinder}unbind(){const{keyBinding:e}=this;e!==void 0&&this.localBinder.set(e,void 0)}}class Va extends Tu{constructor(e,t=!1){super(e.toolBinder,t),this.layer=e}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}}class AE extends K{constructor(e){super(),this.layer=e,this.changed=new Ze}get context(){return this.layer}get mouseState(){return this.layer.manager.root.layerSelectedValues.mouseState}deactivate(){}unbind(){const{layer:e}=this;e.tool.value===this&&(e.tool.value=void 0)}}function Pb(i,e){var r;if(e===void 0)return;typeof e=="string"&&(e={type:e}),ee(e);const t=z(e,"type",ie);let n=i,s;for(;;){if(n=Object.getPrototypeOf(n),n===null)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);if(s=(r=Ng.get(n))==null?void 0:r.get(t),s!==void 0)break}return s(i,e)}function rO(i,e){if(e===void 0)return;typeof e=="string"&&(e={type:e}),ee(e);const t=z(e,"type",ie),n=RE.get(t);if(n===void 0)throw new Error(`Invalid tool type: ${JSON.stringify(e)}.`);return n(i,e)}const RE=new Map,Ng=new Map;function $c(i,e){RE.set(i,e)}function Ji(i,e,t){const{prototype:n}=i;let s=Ng.get(n);s===void 0&&(s=new Map,Ng.set(n,s)),s.set(e,t)}class oO extends K{constructor(e){super(),this.layer=e,this.changed=new Ze}get value(){return this.value_}set value(e){e!==this.value_&&(this.unregister(),e!==void 0&&(e.changed.add(this.changed.dispatch),this.value_=e),this.changed.dispatch())}unregister(){const e=this.value_;e!==void 0&&(e.changed.remove(this.changed.dispatch),e.dispose(),this.value_=void 0)}disposed(){this.unregister(),super.disposed()}restoreState(e){this.value=rO(this.layer,e)}reset(){this.value=void 0}toJSON(){const e=this.value_;if(e!==void 0)return e.toJSON()}}class aO extends K{constructor(e){super(),this.inputEventMapBinder=e,this.bindings=new Map,this.changed=new Ze,this.debounceDeactivate=this.registerCancellable(ze(()=>{this.deactivate_(),this.reactivateQueuedTool()},100))}get(e){return this.bindings.get(e)}set(e,t){const{bindings:n}=this,s=n.get(e);if(s!==void 0){s.keyBinding=void 0,n.delete(e);const r=s.localBinder;r.bindings.delete(e),r.jsonToKey.delete(JSON.stringify(s.toJSON())),this.destroyTool(s),r.changed.dispatch()}if(t!==void 0){const r=t.localBinder,o=JSON.stringify(t.toJSON()),l=r.jsonToKey.get(o);if(l!==void 0){const c=r.bindings.get(l);c.keyBinding=void 0,n.delete(l),r.bindings.delete(l),r.jsonToKey.delete(o),this.destroyTool(c)}r.bindings.set(e,t),t.keyBinding=e,r.jsonToKey.set(o,e),n.set(e,t),r.changed.dispatch()}this.changed.dispatch()}activate(e){const t=this.get(e);if(t===void 0){this.deactivate_();return}this.debounceDeactivate.cancel();const n=this.activeTool_;if(t===(n==null?void 0:n.tool)){t.toggle&&this.deactivate_();return}n!==void 0&&(n.tool.toggle&&!t.toggle&&(this.queuedTool=n.tool),this.deactivate_());const s=new Ib(t,this.inputEventMapBinder);if(this.activeTool_=s,!t.toggle){const r=`Key${e}`;s.registerEventListener(window,"keydown",o=>{o.stopPropagation(),o.preventDefault()}),s.registerEventListener(window,"keyup",o=>{o.code===r&&this.debounceDeactivate()}),s.registerEventListener(window,"blur",()=>{this.debounceDeactivate()})}return t.activate(s),t}reactivateQueuedTool(){if(this.queuedTool){const e=new Ib(this.queuedTool,this.inputEventMapBinder);this.activeTool_=e,this.queuedTool.activate(e),this.queuedTool=void 0}}destroyTool(e){var t;this.queuedTool===e&&(this.queuedTool=void 0),((t=this.activeTool_)==null?void 0:t.tool)===e&&this.deactivate_(),e.dispose()}disposed(){this.deactivate_(),super.disposed()}deactivate_(){this.debounceDeactivate.cancel();const e=this.activeTool_;e!==void 0&&(this.activeTool_=void 0,e.dispose())}}class Lv extends K{constructor(e,t){super(),this.context=e,this.globalBinder=t,this.bindings=new Map,this.jsonToKey=new Map,this.changed=new Ze}disposed(){this.clear(),super.disposed()}get(e){return this.bindings.get(e)}set(e,t){this.globalBinder.set(e,t)}setJson(e,t){const n=Pb(this.context,t);n!==void 0&&this.set(e,n)}removeJsonString(e){const t=this.jsonToKey.get(e);t!==void 0&&this.set(t,void 0)}toJSON(){const{bindings:e}=this;if(e.size===0)return;const t={};for(const[n,s]of e)t[n]=s.toJSON();return t}clear(){const{globalBinder:e,bindings:t}=this;if(t.size!==0){for(const[n,s]of t)s.keyBinding=void 0,e.bindings.delete(n),e.destroyTool(s);t.clear(),this.jsonToKey.clear(),e.changed.dispatch(),this.changed.dispatch()}}reset(){this.clear()}restoreState(e){if(e!==void 0){ee(e);for(const[t,n]of Object.entries(e)){if(!t.match(sO))throw new Error(`Invalid tool key: ${JSON.stringify(t)}`);const s=Pb(this.context,n);if(s===void 0)return;this.set(t,s)}}}}class NE extends K{constructor(e,t){super(),this.localBinder=e,this.toolJson=t,this.element=document.createElement("div"),this.toolJsonString=JSON.stringify(this.toolJson);const{element:n}=this;n.classList.add("neuroglancer-tool-key-binding"),this.registerDisposer(e.changed.add(this.registerCancellable(et(()=>this.updateView())))),this.updateView(),n.title="click → bind key, dbclick → unbind",n.addEventListener("dblclick",()=>{this.localBinder.removeJsonString(this.toolJsonString)}),ME(this,n,s=>this.localBinder.setJson(s,this.toolJson))}updateView(){const{localBinder:e}=this,t=e.jsonToKey.get(this.toolJsonString);this.element.textContent=t??" "}}function ME(i,e,t){let n;e.addEventListener("mousedown",s=>{if(s.button!==0||n!==void 0)return;s.preventDefault(),s.stopPropagation(),n=new K,i.registerDisposer(n),n.registerDisposer(new Pe(!1)).setText("Press A-Z to bind key"),n.registerEventListener(window,"keydown",o=>{const{code:l}=o,c=l.match(/^Key([A-Z])$/);if(c===null)return;o.stopPropagation(),o.preventDefault();const u=c[1];t(u)},{capture:!0}),n.registerEventListener(window,"mouseup",o=>{o.button!==0||n===void 0||(o.preventDefault(),o.stopPropagation(),i.unregisterDisposer(n),n.dispose(),n=void 0)})}),e.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation()})}function ia(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-tool-button"),n.appendChild(i.registerDisposer(new NE(e,t.toolJson)).element);const s=document.createElement("div");s.classList.add("neuroglancer-tool-button-label");const r=t.label;return r!==void 0&&(s.textContent=r),t.title&&(s.title=t.title),n.appendChild(s),n}function OE(i){const e=i.registerDisposer(new Pe(!1));e.element.classList.add("neuroglancer-tool-status");const t=document.createElement("div");t.classList.add("neuroglancer-tool-status-content"),e.element.appendChild(t);const{inputEventMapBinder:n}=i;return i.inputEventMapBinder=(s,r)=>{const o=document.createElement("div");o.textContent=s.describe(),o.classList.add("neuroglancer-tool-status-bindings"),e.element.appendChild(o),n(s,r)},{message:e,content:t}}function Ba(i){const{message:e,content:t}=OE(i),n=document.createElement("div");n.classList.add("neuroglancer-tool-status-header");const s=document.createElement("div");s.classList.add("neuroglancer-tool-status-header-container"),s.appendChild(n),t.appendChild(s);const r=document.createElement("div");return r.classList.add("neuroglancer-tool-status-body"),t.appendChild(r),{message:e,body:r,header:n}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lO(i,e){i.remove(e)}function cO(i,e){i.add(e)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fe(i){for(;;){const e=i.firstChild;if(!e)break;i.removeChild(e)}}function gt(i){const{parentElement:e}=i;return e?(e.removeChild(i),!0):!1}function Dn(i,e=Math.max(1,i.value.length)){const t=`${e}ch`;i.style.width!==t&&(i.style.width="0px",i.offsetWidth,i.style.width=t)}function si(i,e){let t=i.firstElementChild;for(const n of e)n!==t&&i.insertBefore(n,t),t=n.nextElementSibling;for(;t!==null;){const n=t.nextElementSibling;i.removeChild(t),t=n}}function Dv(i){return i instanceof HTMLElement?!!(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement||i.isContentEditable):!1}function dO(i){const e=i.cloneNode(!0);return e.style.position="absolute",document.body.appendChild(e),e.getBoundingClientRect()}class ci extends K{constructor(e=new Pt(Pt.VISIBLE)){super(),this.visibility=e,this.element=document.createElement("div");const{element:t}=this;t.classList.add("neuroglancer-tab-content")}get visible(){return this.visibility.visible}disposed(){gt(this.element),super.disposed()}}class uO extends K{constructor(){super(...arguments),this.changed=new ue,this.options=new Map,this.optionsChanged=new ue,this.selectedValue=void 0,this.defaultValue=void 0,this.ready_=!0}get value(){const{selectedValue:e}=this;return e!==void 0?e:this.defaultValue}set default(e){this.defaultValue!==e&&(this.defaultValue=e,this.changed.dispatch())}get default(){return this.defaultValue}set value(e){e!==void 0&&this.ready_&&!this.options.has(e)&&(e=void 0);const{selectedValue:t}=this;t!==e&&(this.selectedValue=e,this.changed.dispatch())}get validValue(){const e=this.selectedValue;return e===void 0||!this.options.has(e)?this.defaultValue:e}add(e,t){const{options:n}=this;if(n.has(e))throw new Error(`Option already defined: ${JSON.stringify(e)}.`);n.set(e,t),this.optionsChanged.dispatch(),this.defaultValue===void 0&&(this.default=e)}remove(e){const{options:t}=this;if(!t.has(e))throw new Error(`Option is not defined: ${JSON.stringify(e)}.`);t.delete(e),this.optionsChanged.dispatch()}toJSON(){const{value:e,defaultValue:t}=this;if(e!==t)return e}reset(){this.value=void 0}get ready(){return this.ready_}set ready(e){e!==this.ready_&&(this.ready_=e,e&&(this.value=this.value),this.changed.dispatch())}restoreState(e){typeof e!="string"&&(e=void 0),this.value=e}}class hO extends K{constructor(e,t,n=new Pt(Pt.VISIBLE),s=!1){super(),this.getter=e,this.selected=t,this.visibility=n,this.invalidateByDefault=s,this.element=document.createElement("div"),this.tabs=new Map,this.tabVisibilityChanged=new Ze,this.debouncedUpdateSelectedTab=this.registerCancellable(et(()=>this.updateSelectedTab()));const{element:r}=this;r.className="neuroglancer-stack-view",this.registerDisposer(n.changed.add(this.debouncedUpdateSelectedTab)),this.registerDisposer(t.changed.add(this.debouncedUpdateSelectedTab)),this.updateSelectedTab()}get visible(){return this.visibility.visible}flush(){this.debouncedUpdateSelectedTab.flush()}invalidate(e){const{tabs:t}=this,n=t.get(e);n!==void 0&&(n.dispose(),t.delete(e),e===this.displayedTab&&(this.displayedTab=void 0,this.debouncedUpdateSelectedTab()))}hideTab(e){const t=this.tabs.get(e);t!==void 0&&(t.visibility.value=Pt.IGNORED,t.element.style.display="none"),this.tabVisibilityChanged.dispatch(e,!1)}showTab(e){const{tabs:t}=this;let n=t.get(e);n===void 0&&(n=this.getter(e),this.element.appendChild(n.element),t.set(e,n)),n.element.style.display="",n.visibility.value=Pt.VISIBLE,this.tabVisibilityChanged.dispatch(e,!0)}updateSelectedTab(){const{displayedTab:e}=this,t=this.visible?this.selected.value:void 0;t===e&&(t===void 0||this.tabs.has(t))||(e!==void 0&&this.hideTab(e),this.invalidateByDefault&&this.invalidateAll(),this.displayedTab=t,t!==void 0&&this.showTab(t))}invalidateAll(e=void 0){const{tabs:t}=this;for(const[n,s]of t)e!=null&&e(n)||(t.delete(n),s.dispose());this.debouncedUpdateSelectedTab()}disposed(){this.invalidateAll(),gt(this.element),super.disposed()}}class fO extends uO{}function pO(i,e){const t="neuroglancer-selected-tab-label";e?i.classList.add(t):i.classList.remove(t)}class gO extends K{constructor(e,t=new Pt(Pt.VISIBLE)){super(),this.visibility=t,this.element=document.createElement("div"),this.tabBar=document.createElement("div"),this.tabLabels=new Map,this.tabsGeneration=-1,this.debouncedUpdateView=this.registerCancellable(et(()=>this.updateTabs())),this.tabs=e.tabs,this.selectedTab=e.selectedTab,this.handleTabElement=e.handleTabElement;const{element:n,tabBar:s}=this;n.className="neuroglancer-tab-view",s.className="neuroglancer-tab-view-bar",n.appendChild(s),this.registerDisposer(t.changed.add(this.debouncedUpdateView));const r=this.stack=this.registerDisposer(new hO(e.makeTab,e.selectedTab,this.visibility));n.appendChild(r.element),this.registerDisposer(e.tabs.changed.add(this.debouncedUpdateView));let o=this.selectedTab.value;this.registerDisposer(e.selectedTab.changed.add(()=>{const c=this.tabs.value.find(({id:u})=>u===o);c!=null&&c.hidden?(this.tabs.changed.count++,this.debouncedUpdateView()):this.updateTabLabelStyles(),o=this.selectedTab.value})),this.updateTabs()}get visible(){return this.visibility.visible}updateTabLabelStyles(){const e=this.selectedTab.value;for(const[t,n]of this.tabLabels)pO(n,t===e)}updateTabs(){this.tabsGeneration!==this.tabs.changed.count&&(this.destroyTabs(),this.visible&&this.makeTabs())}destroyTabs(){if(this.tabsGeneration!==-1){if(this.tabLabels.clear(),!this.visible)this.stack.invalidateAll();else{const e=this.tabs.value;this.stack.invalidateAll(t=>e.find(({id:n})=>n===t)!==void 0)}Fe(this.tabBar),this.tabsGeneration=-1}}makeTabs(){const{tabBar:e,tabLabels:t,handleTabElement:n}=this;for(const{id:s,label:r,hidden:o}of this.tabs.value){if(o&&s!==this.selectedTab.value)continue;const l=document.createElement("div");l.classList.add("neuroglancer-tab-label"),l.textContent=r,l.addEventListener("click",()=>{this.selectedTab.value=s}),n!==void 0&&n(s,l),t.set(s,l),e.appendChild(l)}this.updateTabLabelStyles(),this.tabsGeneration=this.tabs.changed.count}disposed(){Fe(this.tabBar),this.tabLabels.clear(),gt(this.element),super.disposed()}}const Ab="tool",Rb="toolBindings",yp="localPosition",Nb="localVelocity",Mb="localDimensions",Ob="source",mO="transform",_b="pick";class vO{constructor(){this.callbacks=[]}defer(e){this.callbacks.push(e)}}const _E=[],Py=class Py extends K{constructor(e){super(),this.managedLayer=e,this.pick=new ut(!0,!0),this.messages=new oo,this.layersChanged=new ue,this.readyStateChanged=new ue,this.specificationChanged=new ue,this.renderLayers=new Array,this.loadingCounter=1,this.tabs=this.registerDisposer(new fO),this.panels=new Q2(this),this.tool=this.registerDisposer(new oO(this)),this.toolBinder=this.registerDisposer(new Lv(this,this.manager.root.toolBinder)),this.dataSourcesChanged=new ue,this.dataSources=[],this.localCoordinateSpaceCombiner.includeDimensionPredicate=e1,this.tabs.changed.add(this.specificationChanged.dispatch),this.panels.specificationChanged.add(this.specificationChanged.dispatch),this.tool.changed.add(this.specificationChanged.dispatch),this.toolBinder.changed.add(this.specificationChanged.dispatch),this.localPosition.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.specificationChanged.dispatch),this.pick.changed.add(this.layersChanged.dispatch),this.dataSourcesChanged.add(this.specificationChanged.dispatch),this.dataSourcesChanged.add(()=>this.updateDataSubsourceActivations()),this.messages.changed.add(this.layersChanged.dispatch);for(const t of _E)this.tabs.add(t.id,{label:t.label,order:t.order,getter:()=>t.getter(this)})}get localPosition(){return this.managedLayer.localPosition}get localVelocity(){return this.managedLayer.localVelocity}get localCoordinateSpaceCombiner(){return this.managedLayer.localCoordinateSpaceCombiner}get localCoordinateSpace(){return this.managedLayer.localCoordinateSpace}get type(){return this.constructor.type}initializeSelectionState(e){e.generation=-1,e.localPositionValid=!1,e.localPosition=fa,e.localCoordinateSpace=void 0,e.annotationId=void 0,e.annotationType=void 0,e.annotationBuffer=void 0,e.annotationIndex=void 0,e.annotationCount=void 0,e.annotationSourceIndex=void 0,e.annotationSubsource=void 0,e.annotationPartIndex=void 0,e.value=void 0}resetSelectionState(e){e.localPositionValid=!1,e.annotationId=void 0,e.value=void 0}selectionStateFromJson(e,t){const n=e.localCoordinateSpace=this.localCoordinateSpace.value,{rank:s}=n;if(s!==0){const o=oe(t,yp,l=>_e(new Float32Array(s),l,Xe));o===void 0?e.localPositionValid=!1:(e.localPositionValid=!0,e.localPosition=o)}(e.annotationId=oe(t,"annotationId",ie))!==void 0&&(e.annotationSourceIndex=oe(t,"annotationSource",Je,0),e.annotationPartIndex=oe(t,"annotationPart",Je),e.annotationSubsource=oe(t,"annotationSubsource",ie)),e.value=t.value}displaySelectionState(e,t,n){return!1}selectionStateToJson(e,t){const n={};if(e.localPositionValid){const{localPosition:s}=e;s.length>0&&(n.localPosition=Array.from(s))}return e.annotationId!==void 0&&(n.annotationId=e.annotationId,n.annotationPart=e.annotationPartIndex,n.annotationSource=e.annotationSourceIndex,n.annotationSubsource=e.annotationSubsource),e.value!=null&&(n.value=e.value),n}captureSelectionState(e,t){e.localCoordinateSpace=this.localCoordinateSpace.value;const n=this.localPosition.value,{localPosition:s}=e;s.length!==n.length?e.localPosition=n.slice():s.set(n),e.localPositionValid=!0,e.value=this.getValueAt(t.position,t)}copySelectionState(e,t){e.generation=t.generation,e.localPositionValid=t.localPositionValid,e.localCoordinateSpace=t.localCoordinateSpace;const n=t.localPosition,{localPosition:s}=e;s.length!==n.length?e.localPosition=n.slice():e.localPosition.set(n),e.annotationId=t.annotationId,e.annotationType=t.annotationType,e.annotationBuffer=t.annotationBuffer,e.annotationIndex=t.annotationIndex,e.annotationCount=t.annotationCount,e.annotationSourceIndex=t.annotationSourceIndex,e.annotationSubsource=t.annotationSubsource,e.annotationPartIndex=t.annotationPartIndex,e.value=t.value}get isReady(){return this.loadingCounter===0}get manager(){return this.managedLayer.manager}canAddDataSource(){return!0}addDataSource(e){const t=new V2(this,e);return this.dataSources.push(t),this.dataSourcesChanged.dispatch(),t}activateDataSubsources(e){}updateDataSubsourceActivations(){function*e(){for(const t of this.dataSources){const{loadState:n}=t;if(!(n===void 0||n.error!==void 0))for(const s of n.subsources)if(s.enabled)yield s;else{const{activated:r}=s;s.messages.clearMessages(),r!==void 0&&(r.dispose(),s.activated=void 0,n.activatedSubsourcesChanged.dispatch())}}}this.activateDataSubsources(e.call(this))}decrementLoadingCounter(){--this.loadingCounter===0&&this.readyStateChanged.dispatch()}markLoading(){const e=this.localCoordinateSpaceCombiner.retain(),t=this.manager.root.coordinateSpaceCombiner.retain();return++this.loadingCounter===1&&this.readyStateChanged.dispatch(),()=>{e(),t(),this.decrementLoadingCounter()}}addCoordinateSpace(e){const t=this.manager.root.coordinateSpaceCombiner.bind(e),n=this.localCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}initializationDone(){const e=this.selectionState={};this.initializeSelectionState(e),this.decrementLoadingCounter()}getLegacyDataSourceSpecifications(e,t,n,s){return e===void 0?[]:[Fl(e,n)]}getDataSourceSpecifications(e){let t,n=z(e,Ob,r=>Array.isArray(r)?r.map(o=>Fl(o)):typeof r=="object"?[Fl(r)]:(t=r,[]));const s=z(e,mO,KR);return n.push(...this.getLegacyDataSourceSpecifications(t,e,s,n)),n=n.filter(r=>r.url),n.length===0&&n.push(pE()),n}restoreState(e){this.tool.restoreState(e[Ab]),this.panels.restoreState(e),this.localCoordinateSpace.restoreState(e[Mb]),this.localPosition.restoreState(e[yp]),this.localVelocity.restoreState(e[Nb]),this.toolBinder.restoreState(e[Rb]),this.constructor.supportsPickOption&&this.pick.restoreState(e[_b]);for(const t of this.getDataSourceSpecifications(e))this.addDataSource(t)}addRenderLayer(e){this.renderLayers.push(e);const{layersChanged:t}=this;return e.layerChanged.add(t.dispatch),e.userLayer=this,t.dispatch(),()=>this.removeRenderLayer(e)}removeRenderLayer(e){const{renderLayers:t,layersChanged:n}=this,s=t.indexOf(e);if(s===-1)throw new Error("Attempted to remove invalid RenderLayer");t.splice(s,1),e.layerChanged.remove(n.dispatch),e.userLayer=void 0,e.dispose(),n.dispatch()}disposed(){const{layersChanged:e}=this;la(this.dataSources);for(const t of this.renderLayers)t.layerChanged.remove(e.dispatch),t.dispose();this.renderLayers.length=0,super.disposed()}getValueAt(e,t){let n;const{renderLayers:s}=this,{pickedRenderLayer:r}=t;if(r!==null&&s.indexOf(r)!==-1&&(n=r.transformPickedValue(t),n=this.transformPickedValue(n),n!=null))return n;for(const o of s)if(n=o.getValueAt(e),n!=null)break;return this.transformPickedValue(n)}transformPickedValue(e){return e}toJSON(){return{type:this.type,[Ob]:yO(this.dataSources),[Ab]:this.tool.toJSON(),[Rb]:this.toolBinder.toJSON(),[Mb]:this.localCoordinateSpace.toJSON(),[yp]:this.localPosition.toJSON(),[Nb]:this.localVelocity.toJSON(),[_b]:this.pick.toJSON(),...this.panels.toJSON()}}handleAction(e,t){}selectedValueToJson(e){return e}selectedValueFromJson(e){return e}setLayerPosition(e,t){const{globalPosition:n}=this.manager.root,{localPosition:s}=this;G0(n.value,t,e.globalToRenderLayerDimensions),G0(s.value,t,e.localToRenderLayerDimensions),s.changed.dispatch(),n.changed.dispatch()}};Py.supportsPickOption=!1;let Li=Py;function yO(i){if(i.length!==0)return i.length===1?i[0].toJSON():i.map(e=>e.toJSON())}class Iv extends K{constructor(e,t){super(),this.manager=t,this.localCoordinateSpace=new nv,this.localCoordinateSpaceCombiner=new ov(this.localCoordinateSpace,Vl),this.localPosition=this.registerDisposer(new $r(this.localCoordinateSpace)),this.localVelocity=this.registerDisposer(new Ev(this.localCoordinateSpace)),this.nonArchivedLayerIndex=-1,this.readyStateChanged=new ue,this.layerChanged=new ue,this.specificationChanged=new ue,this.containers=new Set,this.layer_=null,this.visible=!0,this.archived=!1,this.name_=e,this.registerDisposer(new Tv(this.manager.root.display,this.localPosition,this.localVelocity))}get layer(){return this.layer_}set layer(e){const t=this.layer_;if(t!=null&&(this.unregisterUserLayer(),t.dispose()),this.layer_=e,e!=null){const n=[e.layersChanged.add(this.layerChanged.dispatch),e.readyStateChanged.add(this.readyStateChanged.dispatch),e.specificationChanged.add(this.specificationChanged.dispatch)];this.unregisterUserLayer=()=>{n.forEach(s=>s())},this.readyStateChanged.dispatch(),this.layerChanged.dispatch()}}isReady(){const{layer:e}=this;return e==null?void 0:e.isReady}get name(){return this.name_}set name(e){e!==this.name_&&(this.name_=e,this.layerChanged.dispatch())}get supportsPickOption(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption}get pickEnabled(){const e=this.layer;return e!==null&&e.constructor.supportsPickOption&&e.pick.value}set pickEnabled(e){const t=this.layer;t!==null&&t.constructor.supportsPickOption&&(t.pick.value=e)}toJSON(){const e=this.layer;if(e===null)return;const t=e.toJSON();return t.name=this.name,this.visible||(this.archived?t.archived=!0:t.visible=!1),t}setVisible(e){if(e!==this.visible){if(e&&this.archived){this.visible=!0,this.setArchived(!1);return}this.visible=e,this.layerChanged.dispatch()}}setArchived(e){if(this.archived!==e){if(e===!0){this.visible=!1,this.archived=!0;for(const{layerManager:t}of this.manager.root.subsets)t.has(this)&&t.removeManagedLayer(this)}else{for(const{layerManager:t}of this.manager.root.subsets)t.has(this)||t.addManagedLayer(this.addRef());this.archived=!1}this.layerChanged.dispatch()}}disposed(){this.layer=null,super.disposed()}}class VE extends K{constructor(){super(),this.managedLayers=new Array,this.layerSet=new Set,this.layersChanged=new ue,this.readyStateChanged=new ue,this.specificationChanged=new ue,this.boundPositions=new WeakSet,this.numDirectUsers=0,this.nonArchivedLayerIndexGeneration=-1,this.renderLayerToManagedLayerMapGeneration=-1,this.renderLayerToManagedLayerMap_=new Map,this.scheduleRemoveLayersWithSingleRef=this.registerCancellable(ze(()=>this.removeLayersWithSingleRef(),0)),this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef)}updateNonArchivedLayerIndices(){const e=this.layersChanged.count;if(e===this.nonArchivedLayerIndexGeneration)return;this.nonArchivedLayerIndexGeneration=e;let t=0;for(const n of this.managedLayers)n.archived||(n.nonArchivedLayerIndex=t++);for(const n of this.managedLayers)n.archived&&(n.nonArchivedLayerIndex=t++)}getLayerByNonArchivedIndex(e){let t=0;for(const n of this.managedLayers)if(!n.archived){if(t===e)return n;++t}}get renderLayerToManagedLayerMap(){const e=this.layersChanged.count,t=this.renderLayerToManagedLayerMap_;if(this.renderLayerToManagedLayerMapGeneration!==e){this.renderLayerToManagedLayerMapGeneration=e,t.clear();for(const n of this.managedLayers){const s=n.layer;if(s!==null)for(const r of s.renderLayers)t.set(r,n)}}return t}filter(e){let t=!1;this.managedLayers=this.managedLayers.filter(n=>e(n)?!0:(this.unbindManagedLayer(n),this.layerSet.delete(n),t=!0,!1)),t&&this.layersChanged.dispatch()}removeLayersWithSingleRef(){this.numDirectUsers>0||this.filter(e=>e.refCount!==1||e.archived)}updateSignalBindings(e,t){t(e.layerChanged,this.layersChanged.dispatch),t(e.readyStateChanged,this.readyStateChanged.dispatch),t(e.specificationChanged,this.specificationChanged.dispatch)}useDirectly(){return++this.numDirectUsers===1&&this.layersChanged.remove(this.scheduleRemoveLayersWithSingleRef),()=>{--this.numDirectUsers===0&&(this.layersChanged.add(this.scheduleRemoveLayersWithSingleRef),this.scheduleRemoveLayersWithSingleRef())}}addManagedLayer(e,t){return this.updateSignalBindings(e,cO),this.layerSet.add(e),e.containers.add(this),t===void 0&&(t=this.managedLayers.length),this.managedLayers.splice(t,0,e),this.layersChanged.dispatch(),this.readyStateChanged.dispatch(),e}*readyRenderLayers(){for(const e of this.managedLayers)!e.visible||!e.layer||(yield*e.layer.renderLayers)}unbindManagedLayer(e){this.updateSignalBindings(e,lO),e.containers.delete(this),e.manager.rootLayers.layersChanged.dispatch(),e.dispose()}clear(){for(const e of this.managedLayers)this.unbindManagedLayer(e);this.managedLayers.length=0,this.layerSet.clear(),this.layersChanged.dispatch()}remove(e){const t=this.managedLayers[e];this.unbindManagedLayer(t),this.managedLayers.splice(e,1),this.layerSet.delete(t),this.layersChanged.dispatch()}removeManagedLayer(e){const t=this.managedLayers.indexOf(e);if(t===-1)throw new Error("Internal error: invalid managed layer.");this.remove(t)}reorderManagedLayer(e,t){const n=this.managedLayers.length;if(e===t||e<0||e>=n||t<0||t>=n)return;const[s]=this.managedLayers.splice(e,1);this.managedLayers.splice(t,0,s),this.layersChanged.dispatch()}disposed(){this.clear(),super.disposed()}getLayerByName(e){return this.managedLayers.find(t=>t.name===e)}getUniqueLayerName(e){let t=e,n=0;for(;this.getLayerByName(t)!==void 0;)t=e+ ++n;return t}has(e){return this.layerSet.has(e)}get renderLayers(){const e=this;return{*[Symbol.iterator](){for(const t of e.managedLayers)if(t.layer!==null)for(const n of t.layer.renderLayers)yield n}}}get visibleRenderLayers(){const e=this;return{*[Symbol.iterator](){for(const t of e.managedLayers)if(!(t.layer===null||!t.visible))for(const n of t.layer.renderLayers)yield n}}}invokeAction(e){const t=new vO;for(const n of this.managedLayers){if(n.layer===null||!n.visible)continue;const s=n.layer;s.handleAction(e,t);for(const r of s.renderLayers)r.handleAction(e)}for(const n of t.callbacks)n()}}class SO{constructor(){this.changed=new ue,this.coordinateSpace=bs,this.position=fa,this.unsnappedPosition=fa,this.active=!1,this.displayDimensions=void 0,this.pickedRenderLayer=null,this.pickedValue=new X(0,0),this.pickedOffset=0,this.pickedAnnotationLayer=void 0,this.pickedAnnotationId=void 0,this.pickedAnnotationBuffer=void 0,this.pickedAnnotationBufferBaseOffset=void 0,this.pickedAnnotationIndex=void 0,this.pickedAnnotationCount=void 0,this.pickedAnnotationType=void 0,this.forcerFunction=void 0}removeForcer(e){e===this.forcerFunction&&(this.forcerFunction=void 0,this.setActive(!1))}setForcer(e){this.forcerFunction=e,e===void 0&&this.setActive(!1)}updateUnconditionally(){const{forcerFunction:e}=this;return e===void 0?!1:(e(),this.active)}setActive(e){(this.active!==e||e===!0)&&(this.active=e,this.changed.dispatch())}}class bO extends K{constructor(e,t){super(),this.layerManager=e,this.mouseState=t,this.changed=new ue,this.needsUpdate=!0,this.registerDisposer(t.changed.add(()=>{this.handleChange()})),this.registerDisposer(e.layersChanged.add(()=>{this.handleLayerChange()}))}handleLayerChange(){this.mouseState.active&&this.handleChange()}handleChange(){this.needsUpdate=!0,this.changed.dispatch()}update(){if(!this.needsUpdate)return;this.needsUpdate=!1;const e=this.mouseState,t=this.changed.count;if(e.active)for(const n of this.layerManager.managedLayers){const s=n.layer;if(n.visible&&s!==null){const{selectionState:r}=s;s.resetSelectionState(r),r.generation=t,s.captureSelectionState(r,e)}}}get(e){this.update();const{selectionState:t}=e;if(t.generation===this.changed.count)return t}toJSON(){this.update();const e={};for(const t of this.layerManager.managedLayers){const n=t.layer;if(n){const s=this.get(n);s!==void 0&&(e[t.name]=n.selectionStateToJson(s,!0))}}return e}}const Vb=10,Mg={...ao,minSize:150,row:1},Bb={...Mg,visible:!0};class wO extends K{constructor(e,t){super(),this.coordinateSpace=e,this.layerSelectedValues=t,this.changed=new ue,this.history=[],this.historyIndex=0,this.location=new wr(Mg),this.pin=new Ne(!0),this.registerDisposer(Ti((n,s)=>{s||(this.capture(!0),n.registerDisposer(t.changed.add(n.registerCancellable(oh(()=>this.capture(!0),100,{leading:!0,trailing:!0})))))},this.pin)),this.pin.changed.add(this.changed.dispatch),this.location.changed.add(this.changed.dispatch)}get value(){return this.value_}goBack(){const e=this.pin.value?this.historyIndex:this.history.length;e>0&&(this.historyIndex=e-1,this.value_=this.history[e-1],this.pin.value=!0,this.changed.dispatch())}canGoBack(){return(this.pin.value?this.historyIndex:this.history.length)>0}canGoForward(){return this.pin.value?this.historyIndex+1<this.history.length:!1}goForward(){if(!this.pin.value)return;const e=this.historyIndex;e+1<this.history.length&&(this.historyIndex=e+1,this.value_=this.history[e+1],this.changed.dispatch())}set value(e){if(e!==this.value_){if(this.value_=e,e!==void 0&&this.pin.value){const{history:t}=this;t.length=Math.min(t.length,this.historyIndex+1),t.push(e),t.length>Vb&&t.splice(0,t.length-Vb),this.historyIndex=t.length-1}this.changed.dispatch()}}captureSingleLayerState(e,t,n=!0){if(n===!1&&(!this.location.visible||this.pin.value))return;const s={};e.initializeSelectionState(s),t(s)&&(this.location.visible=!0,n===!0?this.pin.value=!0:n==="toggle"&&(this.pin.value=!this.pin.value),this.value={layers:[{layer:e,state:s}],coordinateSpace:this.coordinateSpace.value,position:void 0})}reset(){this.location.reset(),this.pin.value=!1,this.value=void 0}toJSON(){const{value:e}=this;let t;if(this.location.visible){if(t=this.location.toJSON(Bb),this.pin.value&&e!==void 0){const n={};for(const s of e.layers){const{layer:r}=s;let o=r.selectionStateToJson(s.state,!1);Object.keys(o).length===0&&(o=void 0),n[s.layer.managedLayer.name]=o}e.position!==void 0&&(t.position=Array.from(e.position)),t.layers=n}}else t=this.location.toJSON(Mg),t=Oa(t),t!==void 0&&(t.visible=!1);return t}select(){const{pin:e}=this;this.location.visible=!0,e.value=!e.value,e.value&&this.capture()}capture(e=!1){const t=CO(this.layerSelectedValues);e&&t===void 0||(this.value=t)}restoreState(e){if(e===void 0){this.pin.value=!0,this.value=void 0;return}if(e===null){this.pin.value=!1,this.location.visible=!0,this.value=void 0;return}ee(e),this.location.restoreState(e,Bb);const t=this.coordinateSpace.value,n=oe(e,"position",r=>_e(new Float32Array(t.rank),r,Xe)),s=[];oe(e,"layers",r=>{ee(r);const{layerManager:o}=this.layerSelectedValues;for(const[l,c]of Object.entries(r)){const u=o.getLayerByName(l);if(u===void 0)return;const h=u.layer;if(h===null)return;ee(c);const g={};h.initializeSelectionState(g),h.selectionStateFromJson(g,c),s.push({layer:h,state:g})}}),this.pin.value=s.length>0||n!==void 0,this.value={position:n,coordinateSpace:t,layers:s}}}function CO(i){const{mouseState:e}=i;if(!e.active)return;const t=[];for(const n of i.layerManager.managedLayers){const s=n.layer;if(s===null)continue;const r=i.get(s);if(r===void 0)continue;const o={};s.initializeSelectionState(o),s.copySelectionState(o,r),t.push({layer:s,state:o})}return{position:e.position.slice(),coordinateSpace:e.coordinateSpace,layers:t}}class xO extends K{constructor(e){super(),this.view=e,this.messages=new oo,this.seenGeneration=-1,this.state=void 0}}let EO=0;class TO extends K{constructor(e,t,n,s,r,o){super(),this.layerManager=e,this.renderLayerType=t,this.view=n,this.roles=s,this.layerAdded=r,this.visibility=o,this.visibleLayers_=new Map,this.debouncedUpdateVisibleLayers=this.registerCancellable(ze(()=>this.updateVisibleLayers(),0)),this.registerDisposer(e.layersChanged.add(this.debouncedUpdateVisibleLayers)),this.registerDisposer(s.changed.add(this.debouncedUpdateVisibleLayers)),this.updateVisibleLayers()}disposed(){this.visibleLayers.forEach(e=>e.dispose()),this.visibleLayers.clear(),super.disposed()}updateVisibleLayers(){const e=++EO,{visibleLayers_:t,renderLayerType:n,layerAdded:s,roles:r}=this;for(const o of this.layerManager.readyRenderLayers())if(o instanceof n&&r.has(o.role)){const l=o;let c=t.get(l);c===void 0&&(c=new xO(this.view),c.registerDisposer(l.messages.addChild(c.messages)),c.registerDisposer(l.addRef()),c.registerDisposer(l.visibility.add(this.visibility)),t.set(l,c),s(l,c),l.attach(c)),c.seenGeneration=e}for(const[o,l]of t)l.seenGeneration!==e&&(t.delete(o),l.dispose())}get visibleLayers(){return this.debouncedUpdateVisibleLayers.flush(),this.visibleLayers_}}function BE(i,e,t,n,s){return n.registerDisposer(new TO(i,e,n,t,(r,o)=>{o.registerDisposer(r.redrawNeeded.add(()=>n.scheduleRedraw()));const{backend:l}=r;l&&(l.rpc.invoke(fN,{layer:l.rpcId,view:n.rpcId}),o.registerDisposer(()=>l.rpc.invoke(pN,{layer:l.rpcId,view:n.rpcId}))),s!==void 0&&s(r,o),n.scheduleRedraw(),o.registerDisposer(()=>n.scheduleRedraw())},n.visibility))}class kO extends K{constructor(e){super(),this.layerManager=e,this.changed=new ue,this.location=new wr(X2),this.registerDisposer(e),this.location.changed.add(()=>{var n;this.changed.dispatch();const t=((n=this.layer)==null?void 0:n.layer)??void 0;if(t!==void 0){const s=this.location.value;if(s.visible){const r=t.panels.panels[0];r.location.value!==s&&(r.location.value=s,r.location.locationChanged.dispatch())}}})}get layer(){return this.layer_}get visible(){return this.location.visible}toggle(e){this.layer===e&&this.visible?this.visible=!1:(this.layer=e,this.visible=!0)}set visible(e){let t=this.layer_;if(e===!0&&t===void 0){const{managedLayers:n}=this.layerManager;n.length>0?t=this.layer=n[0]:e=!1}if(e===!0&&t!==void 0){const n=t.layer;(n===null||n.panels.panels[0].tabs.length===0)&&(e=!1)}this.visible!==e&&(this.location.visible=e,!e&&t!==void 0&&this.maybeDeleteNewLayer(t),this.changed.dispatch())}maybeDeleteNewLayer(e){if(e.wasDisposed)return;const t=e.layer;t!==null&&t instanceof Cs&&(t.dataSources.some(n=>n.spec.url.length!==0)||Fa(e))}set layer(e){if(e===this.layer_)return;const t=this.layer_;if(t!==void 0&&(this.existingLayerDisposer(),this.existingLayerDisposer=void 0,this.maybeDeleteNewLayer(t)),this.layer_=e,e!==void 0){const n=()=>{this.layer_=void 0,this.visible=!1,this.existingLayerDisposer=void 0,this.changed.dispatch()};e.registerDisposer(n);const s=e.specificationChanged.add(()=>{this.changed.dispatch()});this.existingLayerDisposer=()=>{const r=e.layer;if(r!==null){const o=r.tool.value;o!==void 0&&o.deactivate()}e.unregisterDisposer(n),s()}}else this.location.visible=!1;this.changed.dispatch()}toJSON(){const e=this.location.toJSON();return this.layer!==void 0&&(e.layer=this.layer.name),Oa(e)}restoreState(e){if(e===void 0){this.reset();return}ee(e),this.location.restoreState(e);const t=z(e,"layer",cn),n=t!==void 0?this.layerManager.getLayerByName(t):void 0;n===void 0&&(this.visible=!1),this.layer=n}reset(){this.location.reset(),this.layer=void 0}}class LO extends K{constructor(e,t){super(),this.layerManager=e,this.filter=t,this.changed=new ue,this.validate=ze(()=>{const{layerName_:n}=this;if(n!==void 0){const s=this.layerManager.getLayerByName(n);s!==void 0&&this.filter(s)?(this.layer_=s,this.changed.dispatch()):(this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch())}},0),this.registerDisposer(e),this.registerDisposer(e.specificationChanged.add(()=>{const{layer_:n}=this;if(n!==void 0)if(!this.layerManager.layerSet.has(n)||!this.filter(n))this.layer_=void 0,this.layerName_=void 0,this.changed.dispatch();else{const{name:s}=n;s!==this.layerName_&&(this.layerName_=s,this.changed.dispatch())}}))}get layer(){return this.layer_}get layerName(){return this.layerName_}set layer(e){this.layer_!==e&&(e!==void 0&&this.layerManager.layerSet.has(e)&&this.filter(e)?(this.layer_=e,this.layerName_=e.name):(this.layer_=void 0,this.layerName_=void 0),this.changed.dispatch())}set layerName(e){e!==this.layerName_&&(this.layer_=void 0,this.layerName_=e,this.changed.dispatch(),this.validate())}restoreState(e){const t=cn(e);this.layerName=t}toJSON(){const{layer_:e}=this;return e!==void 0?e.name:this.layerName_}reset(){this.layerName_=void 0,this.layer_=void 0,this.changed.dispatch()}}class Fb extends K{constructor(e,t,n,s){super(),this.layerManager=e,this.layer=t,this.predicate=n,this.getGroup=s,this.linkedLayers_=new Set,this.changed=new ue,this.linkedLayersChanged=new ue,this.root_=t;const r=this;this.root={get value(){return r.root_},changed:r.changed}}get linkedLayers(){return this.linkedLayers_}get rootGroup(){return this.getGroup(this.root.value)}reset(){this.isolate()}restoreState(e){if(e===void 0)return;const t=ie(e);this.linkByName(t)}toJSON(){const{root:{value:e}}=this;if(e!==this.layer)return e.managedLayer.name}isolate(e=!0){const{getGroup:t,layer:n,root_:s}=this;if(s===n){const{linkedLayers_:o}=this;if(o.size!==0){for(const l of o){const c=t(l);c.root_=l,c.changed.dispatch()}o.clear(),this.linkedLayersChanged.dispatch()}return}const r=t(s);r.linkedLayers_.delete(n),r.linkedLayersChanged.dispatch(),this.root_=n,e&&this.changed.dispatch()}linkByName(e){const{layer:t}=this,{managedLayer:n}=t,{layerManager:s}=this,r=s.getLayerByName(e);if(r===void 0||r===n)return;const o=r.layer;o!==null&&this.predicate(o)&&this.linkToLayer(o)}linkToLayer(e){if(e===this.layer||this.root_===e)return;this.root_!==this.layer&&this.isolate(!1);const{getGroup:t}=this,n=t(e).root_;if(n===this.layer)return;const s=t(n);s.linkedLayers_.add(this.layer),s.linkedLayersChanged.dispatch(),this.root_=n,this.changed.dispatch()}disposed(){this.isolate(!1)}}function FE(i,e){const t=oe(e,"type",ie,"auto");i.archived=oe(e,"archived",Ss,!1),i.archived?i.visible=!1:i.visible=oe(e,"visible",Ss,!0);const n=ku.get(t)||Cs;return i.layer=new n(i),e}function UE(i,e){try{const t=i.layer;if(t===null)return;t.restoreState(e),t.initializationDone()}catch(t){throw Fa(i),t}}function zE(i,e){try{ee(e),FE(i,e),UE(i,e)}catch(t){throw Fa(i),t}}function DO(i,e){try{zE(i,e)}catch(t){new Pe().setErrorMessage(t instanceof Error?t.message:""+t)}}function GE(i,e,t){const n=new Iv(e,i);return zE(n,t),n}class $E extends K{constructor(){super(...arguments),this.changed=new ue}}class IO extends $E{constructor(e,t,n,s,r,o,l,c,u){super(),this.display=e,this.dataSourceProviderRegistry=t,this.layerManager=n,this.chunkManager=s,this.selectionState=r,this.selectedLayer=o,this.coordinateSpace=l,this.globalPosition=c,this.toolBinder=u,this.coordinateSpaceCombiner=new ov(this.coordinateSpace,HR),this.subsets=new Set,this.layerSelectedValues=this.selectionState.layerSelectedValues,this.registerDisposer(n.layersChanged.add(this.changed.dispatch)),this.registerDisposer(n.specificationChanged.add(this.changed.dispatch))}get rpc(){return this.chunkManager.rpc}get root(){return this}reset(){this.layerManager.clear()}restoreState(e){this.layerManager.clear();let t;Array.isArray(e)?t=e:(ee(e),t=Object.entries(e).map(([s,r])=>typeof r=="string"?{name:s,source:r}:(ee(r),{...r,name:s})));const n=[];for(const s of t){ee(s);const r=this.layerManager.getUniqueLayerName(z(s,"name",ie)),o=new Iv(r,this);try{FE(o,s),this.layerManager.addManagedLayer(o),n.push({managedLayer:o,spec:s})}catch(l){o.dispose(),new Pe().setErrorMessage(`Error creating layer ${JSON.stringify(r)}: `+(l instanceof Error)?l.message:""+l)}}for(const{managedLayer:s,spec:r}of n)try{UE(s,r)}catch(o){new Pe().setErrorMessage(`Error creating layer ${JSON.stringify(name)}: `+(o instanceof Error)?o.message:""+o)}}add(e,t){this.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.layerManager.getUniqueLayerName(e.name)),this.layerManager.addManagedLayer(e,t)}toJSON(){const e=[];let t=0;for(const n of this.layerManager.managedLayers){const s=n.toJSON();s!=null&&(e.push(s),++t)}if(t!==0)return e}get rootLayers(){return this.layerManager}}class WE extends $E{constructor(e){super(),this.master=e,this.changed=new ue,this.layerManager=this.registerDisposer(new VE),this.registerDisposer(e);const{layerManager:t}=this;this.registerDisposer(t.layersChanged.add(this.changed.dispatch)),this.registerDisposer(t.specificationChanged.add(this.changed.dispatch)),e.subsets.add(this)}get rpc(){return this.master.rpc}get dataSourceProviderRegistry(){return this.master.dataSourceProviderRegistry}get chunkManager(){return this.master.chunkManager}get layerSelectedValues(){return this.master.layerSelectedValues}get root(){return this.master}disposed(){super.disposed(),this.master.subsets.delete(this)}reset(){this.layerManager.clear()}restoreState(e){const t=this.master.layerManager,n=[];for(const s of new Set(Ee(e,ie))){const r=t.getLayerByName(s);if(r===void 0)throw new Error(`Undefined layer referenced in subset specification: ${JSON.stringify(s)}`);r.archived||n.push(r)}this.layerManager.clear();for(const s of n)this.layerManager.addManagedLayer(s.addRef())}toJSON(){return this.layerManager.managedLayers.map(e=>e.name)}add(e,t){this.master.layerManager.managedLayers.indexOf(e)===-1&&(e.name=this.master.layerManager.getUniqueLayerName(e.name),this.master.layerManager.addManagedLayer(e.addRef())),this.layerManager.addManagedLayer(e,t)}get rootLayers(){return this.master.rootLayers}}const ku=new Map,Pv=new Map,HE=[i=>{const{volume:e}=i;if(e===void 0)return;const t=Pv.get(e.volumeType);if(t!==void 0)return{layerConstructor:t,priority:0}}];function lo(i,e=i.type){ku.set(e,i)}function Nh(i){HE.push(i)}function JE(i,e){Pv.set(i,e)}function Av(i,e){const t=i.layer;if(t===null)return;const n=t.toJSON(),s=new e(i);s.restoreState(n),s.initializationDone(),i.layer=s}function jE(i,e){return e!==i.name?(e=i.manager.root.layerManager.getUniqueLayerName(e),i.name=e,i.layerChanged.dispatch(),!0):!1}function Fa(i){if(!i.wasDisposed)for(const e of i.containers)e.removeManagedLayer(i)}function Og(i,e){return i===void 0?e:e===void 0?i:i.priority<e.priority?e:i}function PO(i){let e;for(const n of HE)e=Og(e,n(i));const{volume:t}=i;if(t!==void 0){const n=Pv.get(t.volumeType);n!==void 0&&(e=Og(e,{layerConstructor:n,priority:0}))}return e}function YE(i){let e;for(const t of i){const{subsourceEntry:n}=t,{subsource:s}=n;e=Og(e,PO(s))}return e}const th=class th extends Li{activateDataSubsources(e){var t;this.detectedLayerConstructor=(t=YE(e))==null?void 0:t.layerConstructor}};th.type="new",th.typeAbbreviation="new";let Cs=th;const nh=class nh extends Li{activateDataSubsources(e){var n;const t=(n=YE(e))==null?void 0:n.layerConstructor;t!==void 0&&Av(this.managedLayer,t)}};nh.type="auto",nh.typeAbbreviation="auto";let _g=nh;function qE(i,e){const t=GE(i,"new layer",{type:"new"});i.add(t),e.layer=t,e.visible=!0}lo(Cs);lo(_g);const Vg="selectedAlpha",Bg="notSelectedAlpha",Fg="objectAlpha",Ug="saturation",zg="hoverHighlight",Gg="hideSegmentZero",$g="baseSegmentColoring",Wg="ignoreNullVisibleSet",AO="mesh",RO="skeletons",Sp="segments",Lu="equivalences",Hg="colorSeed",Ub="segmentColors",Jg="meshRenderScale",jg="crossSectionRenderScale",Du="skeletonRendering",NO="skeletonShader",zb="segmentQuery",Yg="meshSilhouetteRendering",Gb="linkedSegmentationGroup",$b="linkedSegmentationColorGroup",qg="segmentDefaultColor",Wb="anchorSegment",KE="skeletonShaderControl";class MO extends K{constructor(e){super(),this.redraw=e}}class Vn extends K{constructor(e,t,n=new Pt(Pt.VISIBLE)){super(),this.model=e,this.render=t,this.visibility=n,this.element=document.createElement("div"),this.generation=-1,this.currentViewDisposer=void 0,this.debouncedUpdateView=this.registerCancellable(et(()=>this.updateView())),this.debouncedForceUpdateView=()=>{this.generation=-1,this.debouncedUpdateView()},this.element.style.display="contents",this.registerDisposer(e.changed.add(this.debouncedUpdateView)),this.registerDisposer(n.changed.add(()=>{this.visible&&this.debouncedUpdateView()})),this.updateView()}get visible(){return this.visibility.visible}updateView(){if(!this.visible)return;const{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.disposeCurrentView();const n=this.currentViewDisposer=new MO(this.debouncedForceUpdateView);this.render(e.value,this.element,n),this.generation=t}disposeCurrentView(){const{currentViewDisposer:e}=this;e!==void 0&&e.dispose(),Fe(this.element)}disposed(){this.disposeCurrentView(),super.disposed()}}function XE(i,e,t,n){const s=document.createElement("label");s.classList.add("neuroglancer-layer-control-container");const r=document.createElement("div");r.classList.add("neuroglancer-layer-control-label-container");const o=document.createElement("div");o.classList.add("neuroglancer-layer-control-label"),r.appendChild(o);const l=document.createElement("div");l.classList.add("neuroglancer-layer-control-label-text-container"),l.appendChild(document.createTextNode(t.label)),o.appendChild(l),t.title&&(o.title=t.title),s.appendChild(r);const{control:c,controlElement:u}=t.makeControl(e,i,{labelContainer:r,labelTextContainer:l,display:e.manager.root.display,visibility:n});return u.classList.add("neuroglancer-layer-control-control"),s.appendChild(u),{controlContainer:s,label:o,labelContainer:r,labelTextContainer:l,control:c}}class QE extends Va{constructor(e,t){super(e),this.options=t}activate(e){const{options:t}=this,{layer:n}=this,{isValid:s}=t;if(s!==void 0&&!s(n).value)return;const{header:r,body:o}=Ba(e),{controlContainer:l,control:c,labelContainer:u}=XE(e,n,t,new Pt(Pt.VISIBLE));r.appendChild(u),o.appendChild(l),t.activateTool(e,c)}get description(){const{options:e}=this;return e.toolDescription??e.label}toJSON(){return this.options.toolJson}}function Hb(i,e,t,n){const{controlContainer:s,label:r}=XE(i,e,t,n);return s.classList.add("neuroglancer-layer-options-control-container"),r.prepend(i.registerDisposer(new NE(e.toolBinder,t.toolJson)).element),s}function Rv(i,e,t,n){const{isValid:s}=n;return s===void 0?Hb(i,e,n,t):i.registerDisposer(new Vn(s(e),(r,o,l)=>{r&&o.appendChild(Hb(l,e,n,t))},t)).element}function ZE(i,e){const{toolJson:t}=e,n=typeof t=="string"?t:t.type;Ji(i,n,s=>new QE(s,e))}function Zo(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new Es(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{t.model.value=!t.model.value}}}class Mh extends K{constructor(e){super(),this.model=e,this.element=document.createElement("select"),this.valueIndexMap=new Map;const{element:t,valueIndexMap:n}=this;let s=0;for(const r of Object.keys(e.enumType))if(Number.isNaN(Number(r))){const o=document.createElement("option");o.textContent=o.value=r.toLowerCase(),t.appendChild(o),n.set(e.enumType[r],s),++s}this.registerDisposer(e.changed.add(()=>this.updateView())),this.registerEventListener(t,"change",()=>this.updateModel()),this.registerEventListener(t,"wheel",r=>{r.preventDefault(),r.stopPropagation(),this.adjustViaWheel(r)}),this.updateView()}adjustViaWheel(e){const{element:t}=this,{deltaY:n}=e;n>0?(t.selectedIndex=(t.options.length+t.selectedIndex-1)%t.options.length,this.updateModel()):n<0&&(t.selectedIndex=(t.options.length+t.selectedIndex+1)%t.options.length,this.updateModel())}updateView(){const{element:e}=this;e.selectedIndex=this.valueIndexMap.get(this.model.value)}updateModel(){this.model.restoreState(this.element.value)}}const OO=He.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function eT(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new Mh(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(OO),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(n.detail)})}}}class _O extends K{constructor(e,{min:t=0,max:n=1,step:s=.01}={}){super(),this.value=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input"),this.numericInputElement=document.createElement("input");const{element:r,inputElement:o,numericInputElement:l}=this;r.className="range-slider";const c=h=>{h.min=""+t,h.max=""+n,h.step=""+s,h.valueAsNumber=this.value.value,this.registerEventListener(h,"change",()=>this.inputValueChanged(h)),this.registerEventListener(h,"input",()=>this.inputValueChanged(h)),this.registerEventListener(h,"wheel",g=>{this.adjustViaWheel(h,g)})};o.type="range",c(o),l.type="number";const u=Math.max(t.toString().length,n.toString().length,Math.min(n,t+s).toString().length,Math.max(t,n-s).toString().length);l.style.width=u+2+"ch",c(l),r.appendChild(o),r.appendChild(l),e.changed.add(()=>{this.inputElement.valueAsNumber=this.value.value,this.numericInputElement.valueAsNumber=this.value.value})}inputValueChanged(e){this.value.value=e.valueAsNumber}adjustViaWheel(e,t){const n=this.inputElement,{deltaY:s}=t;s>0?(n.stepUp(),this.inputValueChanged(e)):s<0&&(n.stepDown(),this.inputValueChanged(e))}disposed(){gt(this.element),super.disposed()}}const VO=He.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"}});function hs(i){return{makeControl:(e,t)=>{const{value:n,options:s}=i(e),r=t.registerDisposer(new _O(n,s));return{control:r,controlElement:r.element}},activateTool:(e,t)=>{e.bindInputEventMap(VO),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustViaWheel(t.inputElement,n.detail)})}}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Iu(i,e,t,n){e*=6;const s=Math.floor(e),r=e-s,o=n*(1-t),l=n*(1-t*r),c=n*(1-t*(1-r));switch(s%6){case 0:i[0]=n,i[1]=c,i[2]=o;break;case 1:i[0]=l,i[1]=n,i[2]=o;break;case 2:i[0]=o,i[1]=n,i[2]=c;break;case 3:i[0]=o,i[1]=l,i[2]=n;break;case 4:i[0]=c,i[1]=o,i[2]=n;break;case 5:i[0]=n,i[1]=o,i[2]=l;break}return i}function BO(i,e,t,n){const s=Math.max(Math.max(e,t),n),r=Math.min(Math.min(e,t),n);if(i[2]=s,r===s)i[0]=0,i[1]=0;else{const o=s-r;i[1]=o/s,e===s?i[0]=(t-n)/o:t===s?i[0]=2+(n-e)/o:i[0]=4+(e-t)/o,i[0]/=6,i[0]<0&&(i[0]+=1),i[0]>1&&(i[0]-=1)}return i}class ji extends K{constructor(e,t,n){super(),this.target=e,this.eventMap=t,this.shouldIgnore=void 0,this.registerEventListener(e,"wheel",s=>{n!==void 0&&n(s),this.dispatch("wheel",s)}),this.registerEventListener(e,"click",s=>{n!==void 0&&n(s),this.dispatch(`click${s.button}`,s)}),this.registerEventListener(e,"dblclick",s=>{n!==void 0&&n(s),this.dispatch(`dblclick${s.button}`,s)}),this.registerEventListener(e,"mousedown",s=>{n!==void 0&&n(s);let r=s.button;r===2&&(s.buttons&3)===1&&(r=0),this.dispatch(`mousedown${r}`,s)}),this.registerEventListener(e,"mouseup",s=>{n!==void 0&&n(s),this.dispatch(`mouseup${s.button}`,s)})}dispatch(e,t){var n;(n=this.shouldIgnore)!=null&&n.call(this,t)||PE(e,t,t,this.eventMap)}}/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function tT(i,e){let t="";for(let n=0;n<=e&&(t=i.toFixed(n),parseFloat(t)!==i);++n);return t}const FO=200,Jb=He.fromObject({mousedown0:{action:"set"},wheel:{action:"adjust-via-wheel"},dblclick0:{action:"reset"}});function UO(i){if(i<1||i>1024){const e=Math.log2(i)|0,t=i/2**e;return`${tT(t,1)}p${e}`}return Math.round(i)+""}class Pu extends K{constructor(e,t){super(),this.histogram=e,this.target=t,this.label=document.createElement("div"),this.element=document.createElement("div"),this.canvas=document.createElement("canvas"),this.legend=document.createElement("div"),this.legendRenderScale=document.createElement("div"),this.legendSpatialScale=document.createElement("div"),this.legendChunks=document.createElement("div"),this.logScaleOrigin=xa,this.unitOfTarget="px",this.ctx=this.canvas.getContext("2d"),this.hoverTarget=new Ne(void 0),this.throttledUpdateView=this.registerCancellable(oh(()=>this.debouncedUpdateView(),FO,{leading:!0,trailing:!0})),this.debouncedUpdateView=this.registerCancellable(ze(()=>this.updateView(),0));const{canvas:n,label:s,element:r,legend:o,legendRenderScale:l,legendSpatialScale:c,legendChunks:u}=this;s.className="neuroglancer-render-scale-widget-prompt",r.className="neuroglancer-render-scale-widget",r.title=Jb.describe(),o.className="neuroglancer-render-scale-widget-legend",r.appendChild(s),r.appendChild(n),r.appendChild(o),l.title="Target resolution of data in screen pixels",u.title="Number of chunks rendered",o.appendChild(l),o.appendChild(u),o.appendChild(c),this.registerDisposer(e.changed.add(this.throttledUpdateView)),this.registerDisposer(e.visibility.changed.add(this.debouncedUpdateView)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(new ji(n,Jb)),this.registerDisposer(t.changed.add(this.debouncedUpdateView)),this.registerDisposer(this.hoverTarget.changed.add(this.debouncedUpdateView));const h=v=>{const y=v.offsetX/n.width*xt;return m2(y,this.logScaleOrigin)};this.registerEventListener(n,"pointermove",v=>{this.hoverTarget.value=[h(v),v.offsetY]}),this.registerEventListener(n,"pointerleave",()=>{this.hoverTarget.value=void 0}),this.registerDisposer(fe(n,"set",v=>{this.target.value=h(v.detail)})),this.registerDisposer(fe(n,"adjust-via-wheel",v=>{this.adjustViaWheel(v.detail)})),this.registerDisposer(fe(n,"reset",v=>{this.reset(),v.preventDefault()}));const g=new ResizeObserver(()=>this.debouncedUpdateView());g.observe(n),this.registerDisposer(()=>g.disconnect()),this.updateView()}adjustViaWheel(e){const t=this.getWheelMoveValue(e);if(t===0)return;this.hoverTarget.value=void 0;const n=Math.round(this.logScaleOrigin+xt*_c),s=jr([2**this.logScaleOrigin,2**(n-1)],this.target.value*2**Math.sign(t));this.target.value=s,e.preventDefault()}getWheelMoveValue(e){return e.deltaY}reset(){this.hoverTarget.value=void 0,this.target.reset()}updateView(){const{ctx:e}=this,{canvas:t}=this,n=t.width=t.offsetWidth,s=t.height=t.offsetHeight,r=this.target.value,o=this.hoverTarget.value;{const{legendRenderScale:I}=this,P=o===void 0?r:o[0],O=UO(P);I.textContent=O+" "+this.unitOfTarget}function l(I){return I*n/xt}e.clearRect(0,0,n,s);const{histogram:c}=this,{value:u,spatialScales:h}=c;c.visibility.visible||u.fill(0);const g=Array.from(h.keys());g.sort();const v=we();let y=1;const b=h.size;let w=0,C=0;for(let I=0;I<xt;++I){let P=0;for(let O=0;O<b;++O){const _=O*xt*2+I,W=u[_],U=u[_+xt];w+=W,C+=U,P+=W+U}y=Math.max(P,y)}C-=c.fakeChunkCount;const k=s/Math.log(1+y);function D(I){return s-Math.log(1+I)*k}let A;if(o!==void 0){const I=Math.floor(Kd(o[0],this.logScaleOrigin));if(I>=0&&I<xt){let P=0;const O=o[1];for(let _=b-1;_>=0;--_){const W=g[_],j=2*h.get(W)*xt+I,B=u[j]+u[j+xt];if(B===0)continue;const H=Math.round(D(P));if(P+=B,Math.round(D(P))<=O&&O<=H){A=W;break}}}}if(A!==void 0){w=0,C=0;const P=2*h.get(A)*xt;for(let O=0;O<xt;++O){const _=P+O;w+=u[_],C+=u[_+xt]}Number.isFinite(A)?this.legendSpatialScale.textContent=qr(A,"m",{precision:2,elide1:!1}):this.legendSpatialScale.textContent="unknown"}else this.legendSpatialScale.textContent="";this.legendChunks.textContent=`${w}/${w+C}`;const N=g.map(I=>{const P=I===A?.5:1;let O;Number.isFinite(I)?O=(Math.log2(I)*.1%1+1)%1:O=0,Iu(v,O,P,1);const _=Pn(v);Iu(v,O,P,.5);const W=Pn(v);return[_,W]});for(let I=0;I<xt;++I){let P=0;for(let O=b-1;O>=0;--O){const _=g[O],U=h.get(_)*xt*2+I,j=u[U],B=u[U+xt],H=j+B;if(H===0)continue;const V=Math.round(l(I)),re=Math.round(l(I+1)),se=Math.round(D(P));P+=H;const ve=Math.round(D(P)),me=(j*ve+B*se)/H;e.fillStyle=N[O][1],e.fillRect(V,ve,re-V,me-ve),e.fillStyle=N[O][0],e.fillRect(V,me,re-V,se-me)}}{const I=r;e.fillStyle="#fff";const P=l(Kd(I,this.logScaleOrigin));e.fillRect(Math.floor(P),0,1,s)}if(o!==void 0){const I=o[0];e.fillStyle="#888";const P=l(Kd(I,this.logScaleOrigin));e.fillRect(Math.floor(P),0,1,s)}}}class zO extends Pu{constructor(){super(...arguments),this.unitOfTarget="samples",this.logScaleOrigin=1}getWheelMoveValue(e){return-e.deltaY}}const GO=He.fromObject({"at:shift+wheel":{action:"adjust-via-wheel"},"at:shift+dblclick0":{action:"reset"}});function Au(i,e=Pu){return{makeControl:(t,n)=>{const{histogram:s,target:r}=i(t),o=n.registerDisposer(new e(s,r));return{control:o,controlElement:o.element}},activateTool:(t,n)=>{t.bindInputEventMap(GO),t.bindAction("adjust-via-wheel",s=>{s.stopPropagation(),s.preventDefault(),n.adjustViaWheel(s.detail)}),t.bindAction("reset",s=>{s.stopPropagation(),s.preventDefault(),n.reset()})}}}const $O=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="rotateIconTitle">
    <title id="rotateIconTitle">Rotate</title>    
    <path d="M22 12l-3 3-3-3"/>
    <path d="M2 12l3-3 3 3"/>
    <path d="M19.016 14v-1.95A7.05 7.05 0 0 0 8 6.22"/>
    <path d="M16.016 17.845A7.05 7.05 0 0 1 5 12.015V10"/>
    <path stroke-linecap="round" d="M5 10V9"/>
    <path stroke-linecap="round" d="M19 15v-1"/>
</svg>`;function $e(i){const{title:e,onClick:t,href:n}=i;let s;n!==void 0?(s=document.createElement("a"),s.href=n,s.target="_blank"):s=document.createElement("div"),e!==void 0&&(s.title=e),t!==void 0&&s.addEventListener("click",t);const{svg:r}=i;return s.className="neuroglancer-icon",r!==void 0&&(s.innerHTML=r),i.text!==void 0&&s.appendChild(document.createTextNode(i.text)),s}class Nv extends K{constructor(e,t=()=>Et(1,0,0)){super(),this.model=e,this.getDefaultColor=t,this.element=document.createElement("input");const{element:n}=this;n.classList.add("neuroglancer-color-widget"),n.type="color",n.addEventListener("change",()=>this.updateModel()),n.addEventListener("input",()=>this.updateModel()),n.addEventListener("wheel",s=>{s.stopPropagation(),s.preventDefault(),this.adjustHueViaWheel(s)}),this.registerDisposer(e.changed.add(()=>this.updateView())),this.updateView()}getRGB(){return this.model.value??this.getDefaultColor()}updateView(){this.element.value=Pn(this.getRGB())}updateModel(){this.model.value=Ra(this.element.value)}adjustHueViaWheel(e){const t=this.getRGB(),n=we();BO(n,t[0],t[1],t[2]);const{deltaY:s}=e;let r=Math.round(n[0]*256);r+=s>0?1:s<0?-1:0,r=(r+256)%256,n[0]=r/256,Iu(n,n[0],n[1],n[2]),this.model.value=n}}const WO=He.fromObject({"at:shift+wheel":{action:"adjust-hue-via-wheel"}});function nT(i){return{makeControl:(e,t)=>{const n=i(e),s=t.registerDisposer(new Nv(n));return{control:s,controlElement:s.element}},activateTool:(e,t)=>{e.bindInputEventMap(WO),e.bindAction("adjust-via-wheel",n=>{n.stopPropagation(),n.preventDefault(),t.adjustHueViaWheel(n.detail)})}}}class iT extends K{constructor(e){super(),this.model=e,this.element=document.createElement("input"),this.registerDisposer(e.changed.add(()=>this.updateView()));const{element:t}=this;t.type="text",this.registerEventListener(t,"change",()=>this.updateModel()),this.updateView()}disposed(){gt(this.element)}updateView(){this.element.value=(this.model.value??"")+""}updateModel(){try{this.model.restoreState(this.element.value)}catch{}this.updateView()}}function Ru(i,e){e?i.displayState.segmentDefaultColor.value=Et(1,0,0):i.displayState.segmentDefaultColor.value=void 0}function HO(){const i=e=>{e.displayState.segmentationColorGroupState.value.segmentColorHash.randomize()};return{makeControl:(e,t,{labelTextContainer:n})=>{const s=document.createElement("input");s.type="radio",s.addEventListener("change",()=>{Ru(e,!s.checked)}),n.prepend(s);const r=document.createElement("div");r.classList.add("neuroglancer-segmentation-color-seed-control");const o=t.registerDisposer(new iT(e.displayState.segmentColorHash));r.appendChild(o.element);const l=$e({svg:$O,title:"Randomize",onClick:()=>i(e)});return r.appendChild(l),t.registerDisposer(ys(c=>{const u=c===void 0;r.style.visibility=u?"":"hidden",s.checked=u},e.displayState.segmentDefaultColor)),{controlElement:r,control:o}},activateTool:e=>{const{layer:t}=e.tool;Ru(t,!1),i(t)}}}function JO(){const i=nT(e=>e.displayState.segmentDefaultColor);return{...i,makeControl:(e,t,n)=>{const s=i.makeControl(e,t,n),{controlElement:r}=s,o=document.createElement("input");return o.type="radio",o.addEventListener("change",()=>{Ru(e,o.checked),o.checked&&r.click()}),n.labelTextContainer.prepend(o),t.registerDisposer(ys(l=>{const c=l!==void 0;r.style.visibility=c?"":"hidden",o.checked=c},e.displayState.segmentDefaultColor)),s},activateTool:(e,t)=>{Ru(e.tool.layer,!0),i.activateTool(e,t)}}}const sT=[{label:"Color seed",title:"Color segments based on a hash of their id",toolJson:Hg,...HO()},{label:"Fixed color",title:"Use a fixed color for all segments without an explicitly-specified color",toolJson:qg,...JO()},{label:"Saturation",toolJson:Ug,title:"Saturation of segment colors",...hs(i=>({value:i.displayState.saturation}))},{label:"Opacity (on)",toolJson:Vg,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are selected",...hs(i=>({value:i.displayState.selectedAlpha}))},{label:"Opacity (off)",toolJson:Bg,isValid:i=>i.has2dLayer,title:"Opacity in cross-section views of segments that are not selected",...hs(i=>({value:i.displayState.notSelectedAlpha}))},{label:"Resolution (slice)",toolJson:jg,isValid:i=>i.has2dLayer,...Au(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))},{label:"Resolution (mesh)",toolJson:Jg,isValid:i=>i.has3dLayer,...Au(i=>({histogram:i.displayState.renderScaleHistogram,target:i.displayState.renderScaleTarget}))},{label:"Opacity (3d)",toolJson:Fg,isValid:i=>i.has3dLayer,title:"Opacity of meshes and skeletons",...hs(i=>({value:i.displayState.objectAlpha}))},{label:"Silhouette (3d)",toolJson:Yg,isValid:i=>i.has3dLayer,title:"Set to a non-zero value to increase transparency of object faces perpendicular to view direction",...hs(i=>({value:i.displayState.silhouetteRendering,options:{min:0,max:jO,step:.1}}))},{label:"Hide segment ID 0",toolJson:Gg,title:"Disallow selection and display of segment id 0",...Zo(i=>i.displayState.hideSegmentZero)},{label:"Base segment coloring",toolJson:$g,title:"Color base segments individually",...Zo(i=>i.displayState.baseSegmentColoring)},{label:"Show all by default",title:"Show all segments if none are selected",toolJson:Wg,...Zo(i=>i.displayState.ignoreNullVisibleSet)},{label:"Highlight on hover",toolJson:zg,title:"Highlight the segment under the mouse pointer",...Zo(i=>i.displayState.hoverHighlight)},...jb("2d"),...jb("3d")],jO=10;function jb(i){return[{label:`Skeleton mode (${i})`,toolJson:`${Du}.mode${i}`,isValid:e=>e.hasSkeletonsLayer,...eT(e=>e.displayState.skeletonRenderingOptions[`params${i}`].mode)},{label:`Line width (${i})`,toolJson:`${Du}.lineWidth${i}`,isValid:e=>e.hasSkeletonsLayer,toolDescription:`Skeleton line width (${i})`,title:`Skeleton line width (${i})`,...hs(e=>({value:e.displayState.skeletonRenderingOptions[`params${i}`].lineWidth,options:{min:1,max:40,step:1}}))}]}function YO(i){for(const e of sT)ZE(i,e)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const qO="mesh/MeshLayer",KO="mesh/MultiscaleMeshLayer",XO="mesh/FragmentSource",QO="mesh/MultiscaleFragmentSource";var cr=(i=>(i[i.float32=0]="float32",i[i.uint10=1]="uint10",i[i.uint16=2]="uint16",i))(cr||{});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ZO(i,e,t){return i&1|e<<1&2|t<<2&4}function e_(i,e,t,n,s,r,o){const{octree:l,lodScales:c,chunkGridSpatialOrigin:u,chunkShape:h}=i,g=c.length-1,v=e[0],y=e[4],b=e[8],w=e[1],C=e[5],E=e[9],k=e[3],D=e[7],A=e[11],N=e[15],I=k>0?0:1,P=D>0?0:1,O=A>0?0:1,_=t[4*4],W=t[4*4+1],U=t[4*4+2],j=t[4*4+3];function B(Se,ge,Ce){return k*Se+D*ge+A*Ce+N}function H(Se,ge,Ce,ot,Ae,Nt){return B(Se+I*(ot-Se),ge+P*(Ae-ge),Ce+O*(Nt-Ce))}const V=B(-j*_,-j*W,-j*U),re=i.clipLowerBound[0],se=i.clipLowerBound[1],ve=i.clipLowerBound[2],me=i.clipUpperBound[0],Ie=i.clipUpperBound[1],We=i.clipUpperBound[2],tt=Math.sqrt((v*s)**2+(w*r)**2),rt=Math.sqrt((y*s)**2+(C*r)**2),nt=Math.sqrt((b*s)**2+(E*r)**2),Ge=Math.max(tt,rt,nt);function Te(Se,ge,Ce){const ot=1<<Se,Ae=ge*5,Nt=l[Ae],Ri=l[Ae+1],hn=l[Ae+2],Fn=l[Ae+3],nn=l[Ae+4];let sn=Nt*ot*h[0]+u[0],fn=Ri*ot*h[1]+u[1],ui=hn*ot*h[2]+u[2],Oe=sn+ot*h[0],Un=fn+ot*h[1],Ns=ui+ot*h[2];if(sn=Math.max(sn,re),fn=Math.max(fn,se),ui=Math.max(ui,ve),Oe=Math.min(Oe,me),Un=Math.min(Un,Ie),Ns=Math.min(Ns,We),Cx(sn,fn,ui,Oe,Un,Ns,t)){const Ms=Math.max(V,H(sn,fn,ui,Oe,Un,Ns))/Ge;if(Ce===0||Ms*n<Ce){const Ni=c[Se];if(Ni!==0&&o(Se,ge,Ni/Ms,nn>>>31),Se>0&&(Ni===0||Ms*n<Ni)){const Cr=Ni===0?Ce:Ni,hi=(nn&2147483647)>>>0;for(let Os=Fn;Os<hi;++Os)Te(Se-1,Os,Cr)}}}}Te(g,l.length/5-1,0)}function Yb(i,e,t,n,s,r,o,l){const{lodScales:c}=i;let u=0;for(;u+1<c.length&&c[u+1]!==0;)++u;const h=3,g=[];let v=0,y=0;function b(E,k){for(;;){if(v===0)return;const D=v-1,A=u-D,N=g[D*h],I=A===0?1:8,P=g[D*h+1],O=g[D*h+2];if(E===v){const _=k&I-1;y!==_&&N!==-1&&l(A,N,y,_,O),y=_+1;return}y!==I&&N!==-1&&l(A,N,y,I,O),y=P+1,--v}}let w=0;const{octree:C}=i;e_(i,e,t,n,s,r,(E,k,D,A)=>{if(!A&&!o(E,k,D)){w=Math.max(E,w);return}if(E<w)return;w=0;const N=k*5,I=C[N],P=C[N+1],O=C[N+2],_=ZO(I,P,O),W=u-E;b(W,_);const U=W*h;g[U]=A?-1:k,g[U+1]=_,g[U+2]=D,y=0,v=W+1}),b(0,0)}function rT(i,e,t){return`${i}/${e}:${t}`}class co extends k1{draw(e,t){}isReady(e,t){return!0}get transparentPickEnabled(){return!0}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const t_=3432918353,n_=461845907;function Nu(i,e){return e>>>=0,i>>>=0,e=Math.imul(e,t_)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,n_)>>>0,i=(i^e)>>>0,i=(i<<13|i>>>19)>>>0,i=i*5+3864292196>>>0,i}const Kg=3,i_=.8;let as=0,ls=0,qb=0,Kb=0;class nc{constructor(e=nc.generateHashSeeds(Kg)){this.hashSeeds=e,this.loadFactor=i_,this.size=0,this.emptyLow=4294967295,this.emptyHigh=4294967295,this.maxRehashAttempts=5,this.maxAttempts=5,this.generation=0,this.mungedEmptyKey=-1;let t=8;for(;t<2*e.length;)t*=2;this.allocate(t)}updateHashFunctions(e){this.hashSeeds=nc.generateHashSeeds(e),this.mungedEmptyKey=-1}tableWithMungedEmptyKey(e){const t=this.hashSeeds.length,n=new Array(t);for(let c=0;c<t;++c)n[c]=this.getHash(c,this.emptyLow,this.emptyHigh);let{mungedEmptyKey:s}=this;if(s===-1)e:for(;;){s=Math.random()*16777216>>>0;for(let c=0;c<t;++c){const u=this.getHash(c,s,s);for(let h=0;h<t;++h)if(n[h]===u)continue e}this.mungedEmptyKey=s;break}const{table:r,emptyLow:o,emptyHigh:l}=this;for(let c=0;c<t;++c){const u=n[c];r[u]===o&&r[u+1]===l&&(r[u]=s,r[u+1]=s)}try{e(r)}finally{for(let c=0;c<t;++c){const u=n[c];r[u]===s&&r[u+1]===s&&(r[u]=o,r[u+1]=l)}}}static generateHashSeeds(e=Kg){return oR(new Uint32Array(e))}getHash(e,t,n){let s=this.hashSeeds[e];return s=Nu(s,t),s=Nu(s,n),this.entryStride*(s&this.tableSize-1)}*keys(){const{emptyLow:e,emptyHigh:t,entryStride:n}=this,{table:s}=this;for(let r=0,o=s.length;r<o;r+=n){const l=s[r],c=s[r+1];(l!==e||c!==t)&&(yield new X(l,c))}}*unsafeKeys(e=new X){const{emptyLow:t,emptyHigh:n,entryStride:s}=this,{table:r}=this;for(let o=0,l=r.length;o<l;o+=s){const c=r[o],u=r[o+1];(c!==t||u!==n)&&(e.low=c,e.high=u,yield e)}}indexOfPair(e,t){const{table:n,emptyLow:s,emptyHigh:r}=this;if(e===s&&t===r)return-1;for(let o=0,l=this.hashSeeds.length;o<l;++o){const c=this.getHash(o,e,t);if(n[c]===e&&n[c+1]===t)return c}return-1}indexOf(e){return this.indexOfPair(e.low,e.high)}chooseAnotherEmptyKey(){const{emptyLow:e,emptyHigh:t,table:n,entryStride:s}=this;let r,o;for(;r=Math.random()*4294967296>>>0,o=Math.random()*4294967296>>>0,!(!(r===e&&o===t)&&!this.hasPair(r,o)););this.emptyLow=r,this.emptyHigh=o;for(let l=0,c=n.length;l<c;l+=s)n[l]===e&&n[l+1]===t&&(n[l]=r,n[l+1]=o)}has(e){return this.indexOf(e)!==-1}hasPair(e,t){return this.indexOfPair(e,t)!==-1}delete(e){const t=this.indexOf(e);if(t!==-1){const{table:n}=this;return n[t]=this.emptyLow,n[t+1]=this.emptyHigh,++this.generation,this.size--,!0}return!1}clearTable(){const{table:e,entryStride:t,emptyLow:n,emptyHigh:s}=this,r=e.length;for(let o=0;o<r;o+=t)e[o]=n,e[o+1]=s}clear(){return this.size===0?!1:(this.size=0,++this.generation,this.clearTable(),!0)}reserve(e){return e>this.capacity?(this.backupPending(),this.grow(e),this.restorePending(),!0):!1}swapPending(e,t){const n=as,s=ls;this.storePending(e,t),e[t]=n,e[t+1]=s}storePending(e,t){as=e[t],ls=e[t+1]}backupPending(){qb=as,Kb=ls}restorePending(){as=qb,ls=Kb}tryToInsert(){let e=0;const{emptyLow:t,emptyHigh:n,maxAttempts:s,table:r}=this,o=this.hashSeeds.length;let l=Math.floor(Math.random()*o);for(;;){const c=this.getHash(l,as,ls);if(this.swapPending(r,c),as===t&&ls===n)return!0;if(++e===s)break;l=(l+Math.floor(Math.random()*(o-1))+1)%o}return!1}allocate(e){this.tableSize=e;const{entryStride:t}=this;this.table=new Uint32Array(e*t),this.maxAttempts=e,this.clearTable(),this.capacity=e*this.loadFactor,this.mungedEmptyKey=-1}rehash(e,t){this.allocate(t),this.updateHashFunctions(this.hashSeeds.length);const{emptyLow:n,emptyHigh:s,entryStride:r}=this;for(let o=0,l=e.length;o<l;o+=r){const c=e[o],u=e[o+1];if((c!==n||u!==s)&&(this.storePending(e,o),!this.tryToInsert()))return!1}return!0}grow(e){const t=this.table;let{tableSize:n}=this;for(;n<e;)n*=2;for(;;){for(let s=0;s<this.maxRehashAttempts;++s)if(this.rehash(t,n))return;n*=2}}insertInternal(){for(++this.generation,as===this.emptyLow&&ls===this.emptyHigh&&this.chooseAnotherEmptyKey(),++this.size>this.capacity&&(this.backupPending(),this.grow(this.tableSize*2),this.restorePending());!this.tryToInsert();)this.backupPending(),this.grow(this.tableSize),this.restorePending()}}class oT extends nc{add(e){const{low:t,high:n}=e;return this.hasPair(t,n)?!1:(as=t,ls=n,this.insertInternal(),!0)}[Symbol.iterator](){return this.unsafeKeys()}}oT.prototype.entryStride=2;let Dl=0,Il=0,Xb=0,Qb=0;class Mv extends nc{set(e,t){const{low:n,high:s}=e;return this.hasPair(n,s)?!1:(as=n,ls=s,Dl=t.low,Il=t.high,this.insertInternal(),!0)}get(e,t){const n=this.indexOf(e);if(n===-1)return!1;const{table:s}=this;return t.low=s[n+2],t.high=s[n+3],!0}swapPending(e,t){const n=Dl,s=Il;super.swapPending(e,t),e[t+2]=n,e[t+3]=s}storePending(e,t){super.storePending(e,t),Dl=e[t+2],Il=e[t+3]}backupPending(){super.backupPending(),Xb=Dl,Qb=Il}restorePending(){super.restorePending(),Dl=Xb,Il=Qb}[Symbol.iterator](){return this.unsafeEntries()}*entries(){const{emptyLow:e,emptyHigh:t,entryStride:n}=this,{table:s}=this;for(let r=0,o=s.length;r<o;r+=n){const l=s[r],c=s[r+1];if(l!==e||c!==t){const u=new X(l,c),h=new X(s[r+2],s[r+3]);yield[u,h]}}}*unsafeEntries(e=[new X,new X]){const{emptyLow:t,emptyHigh:n,entryStride:s}=this,{table:r}=this,[o,l]=e;for(let c=0,u=r.length;c<u;c+=s){const h=r[c],g=r[c+1];(h!==t||g!==n)&&(o.low=h,o.high=g,l.low=r[c+2],l.high=r[c+3],yield e)}}}Mv.prototype.entryStride=4;class Ua{}const Br=[-1,WebGL2RenderingContext.RED_INTEGER,WebGL2RenderingContext.RG_INTEGER,WebGL2RenderingContext.RGB_INTEGER,WebGL2RenderingContext.RGBA_INTEGER],s_=[-1,WebGL2RenderingContext.RED,WebGL2RenderingContext.RG,WebGL2RenderingContext.RGB,WebGL2RenderingContext.RGBA],Vd=["","r","rg","rgb","rgba"],r_=[-1,WebGL2RenderingContext.R8UI,WebGL2RenderingContext.RG8UI,WebGL2RenderingContext.RGB8UI,WebGL2RenderingContext.RGBA8UI],o_=[-1,WebGL2RenderingContext.R8I,WebGL2RenderingContext.RG8I,WebGL2RenderingContext.RGB8I,WebGL2RenderingContext.RGBA8I],a_=[-1,WebGL2RenderingContext.R16UI,WebGL2RenderingContext.RG16UI,WebGL2RenderingContext.RGB16UI,WebGL2RenderingContext.RGBA16UI],l_=[-1,WebGL2RenderingContext.R16I,WebGL2RenderingContext.RG16I,WebGL2RenderingContext.RGB16I,WebGL2RenderingContext.RGBA16I],Zb=[-1,WebGL2RenderingContext.R32UI,WebGL2RenderingContext.RG32UI,WebGL2RenderingContext.RGB32UI,WebGL2RenderingContext.RGBA32UI],c_=[-1,WebGL2RenderingContext.R32I,WebGL2RenderingContext.RG32I,WebGL2RenderingContext.RGB32I,WebGL2RenderingContext.RGBA32I],d_=[-1,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RG32F,WebGL2RenderingContext.RGB32F,WebGL2RenderingContext.RGBA32F];function Oh(i){return i===J.FLOAT32?"":Jm[i]?"i":"u"}function uo(i,e,t=1){switch(e){case J.UINT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=r_[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.UNSIGNED_BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint8Array,i.samplerPrefix="u",i;case J.INT8:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=o_[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.BYTE,i.arrayElementsPerTexel=t,i.arrayConstructor=Int8Array,i.samplerPrefix="i",i;case J.UINT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=a_[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.UNSIGNED_SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Uint16Array,i.samplerPrefix="u",i;case J.INT16:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=l_[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.SHORT,i.arrayElementsPerTexel=t,i.arrayConstructor=Int16Array,i.samplerPrefix="i",i;case J.UINT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=Zb[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case J.INT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=c_[t],i.textureFormat=Br[t],i.texelType=WebGL2RenderingContext.INT,i.arrayElementsPerTexel=1,i.arrayConstructor=Int32Array,i.samplerPrefix="i",i;case J.UINT64:if(t<1||t>2)break;return i.texelsPerElement=1,i.textureInternalFormat=Zb[t*2],i.textureFormat=Br[t*2],i.texelType=WebGL2RenderingContext.UNSIGNED_INT,i.arrayElementsPerTexel=2*t,i.arrayConstructor=Uint32Array,i.samplerPrefix="u",i;case J.FLOAT32:if(t<1||t>4)break;return i.texelsPerElement=1,i.textureInternalFormat=d_[t],i.textureFormat=s_[t],i.texelType=WebGL2RenderingContext.FLOAT,i.arrayElementsPerTexel=t,i.arrayConstructor=Float32Array,i.samplerPrefix="",i}throw new Error(`No supported texture format for ${J[e]}[${t}].`)}function _h(i,e,t){const{arrayConstructor:n,arrayElementsPerTexel:s,textureInternalFormat:r,textureFormat:o,texelsPerElement:l}=e,{maxTextureSize:c}=i,u=t.length/s;if(u*l>c*c)throw new Error("Number of elements exceeds maximum texture size: "+l+" * "+u);const h=Math.ceil(u/c),g=Math.ceil(Math.log2(h)),v=(1<<g)*l,y=Math.ceil(u/(1<<g)),b=v*y*s;t.constructor!==n&&(t=new n(t.buffer,t.byteOffset,t.byteLength/n.BYTES_PER_ELEMENT));const w=CP(t,b);i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),va(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,r,v,y,0,o,e.texelType,w)}function u_(i,e,t,n,s){const{arrayConstructor:r,textureInternalFormat:o,textureFormat:l,texelsPerElement:c}=e;t.constructor!==r&&(t=new r(t.buffer,t.byteOffset,t.byteLength/r.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),va(i),i.texImage2D(WebGL2RenderingContext.TEXTURE_2D,0,o,n*c,s,0,l,e.texelType,t)}function h_(i,e,t,n,s,r){const{arrayConstructor:o,textureInternalFormat:l,textureFormat:c,texelsPerElement:u}=e;t.constructor!==o&&(t=new o(t.buffer,t.byteOffset,t.byteLength/o.BYTES_PER_ELEMENT)),i.pixelStorei(WebGL2RenderingContext.UNPACK_ALIGNMENT,1),FN(i),i.texImage3D(WebGL2RenderingContext.TEXTURE_3D,0,l,n*u,s,r,0,c,e.texelType,t)}function f_(i){switch(i){case J.UINT8:return M1;case J.INT8:return O1;case J.UINT16:return _1;case J.INT16:return V1;case J.UINT32:return Sh;case J.INT32:return B1;case J.UINT64:return kt;case J.FLOAT32:return uv}}function aT(i,e,t,n,s,r){const o=$t(s,r),l=[f_(s)];let c=`
${o} ${i}(${n} index) {
`;switch(s){case J.UINT8:case J.UINT16:case J.UINT32:c+=`
  ${o} result;
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Vd[r]};
  return result;
`;break;case J.INT8:case J.INT16:case J.INT32:c+=`
  ${o} result;
  highp ivec4 temp;
  ${e}(${t}, index, temp);
  result.value = temp.${Vd[r]};
  return result;
`;break;case J.UINT64:l.push(XN),c+=`
  highp uvec4 temp;
  ${e}(${t}, index, temp);
  return unpackUint64leFromUint32(temp.${Vd[r*2]});
`;break;case J.FLOAT32:l.push(uv),c+=`
  highp vec4 temp;
  ${e}(${t}, index, temp);
  return temp.${Vd[r]};
`;break}return c+=`
}
`,l.push(c),l}class Vh{constructor(e){this.key=e,this.readTextureValue=`readTextureValue_${this.key}`}defineShader(e){}getReadTextureValueCode(e,t){let n=`
void ${this.readTextureValue}(highp ${t}sampler2D sampler, highp uint index`;for(let s=0;s<e;++s)n+=`, out ${t}vec4 output${s}`;n+=`) {
  highp int width = textureSize(sampler, 0).x / ${e};
  highp uint log2width = log2Exact(uint(width));
  highp int y = int(index >> log2width);
  highp int x = int((index - (uint(y) << log2width)) * ${e}u);
`;for(let s=0;s<e;++s)n+=`
  output${s} = texelFetch(sampler, ivec2(x + ${s}, y), 0);
`;return n+=`
}
`,[iM,n]}getAccessor(e,t,n,s=1){const r=Oh(n);return[this.getReadTextureValueCode(1,r),...aT(e,this.readTextureValue,t,"highp uint",n,s)]}}class p_{constructor(e,t){this.key=e,this.textureDims=t,this.readTextureValue=`readTextureValue_${this.key}`}getReadTextureValueCode(e,t){const{textureDims:n}=this;let s=`
void ${this.readTextureValue}(highp ${t}sampler${this.textureDims}D sampler, highp ivec${n} p`;for(let r=0;r<e;++r)s+=`, out ${t}vec4 output${r}`;s+=`) {
`;for(let r=0;r<e;++r)s+=`
  output${r} = texelFetch(sampler, ivec${n}(p.x * ${e} + ${r}, p.y
                                         ${n===3?", p.z":""}), 0);
`;return s+=`
}
`,s}getAccessor(e,t,n,s=1){const r=Oh(n);return[this.getReadTextureValueCode(1,r),...aT(e,this.readTextureValue,t,`highp ivec${this.textureDims}`,n,s)]}}const lT=[kt,`
highp uint hashCombine(highp uint state, highp uint value) {
  value *= 0xcc9e2d51u;
  value = (value << 15u) | (value >> 17u);
  value *= 0x1b873593u;
  state ^= value;
  state = (state << 13u) | (state >> 19u);
  state = (state * 5u) + 0xe6546b64u;
  return state;
}
highp uint hashCombine(highp uint state, uint64_t x) {
  state = hashCombine(state, x.value[0]);
  return hashCombine(state, x.value[1]);
}
`],g_=uo(new Ua,J.UINT64,1);class Gr extends K{constructor(e,t){super(),this.gl=e,this.hashTable=t,this.generation=-1,this.texture=null,this.texture=e.createTexture()}copyToGPU(){const{hashTable:e}=this,{generation:t}=e;if(this.generation===t)return;const{gl:n,texture:s}=this;this.generation=t,n.activeTexture(WebGL2RenderingContext.TEXTURE0+n.tempTextureUnit),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,s),e.tableWithMungedEmptyKey(r=>{_h(this.gl,g_,r)}),n.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}disposed(){const{gl:e}=this;e.deleteTexture(this.texture),this.texture=null,this.gl=void 0,this.hashTable=void 0,super.disposed()}static get(e,t){return e.memoize.get(t,()=>new Gr(e,t))}}class cT{constructor(e,t=Kg){this.prefix=e,this.numAlternatives=t,this.textureUnitSymbol=Symbol.for(`gpuhashtable:${this.prefix}`),this.accessHelper=new Vh(`gpuhashtable_${this.prefix}`),this.samplerName=this.prefix+"_sampler",this.hashSeedsName=this.prefix+"_seeds",this.hashKeyMask=this.prefix+"_keyMask",this.readTable=this.prefix+"_readTable"}defineShader(e){const{hashSeedsName:t,samplerName:n,numAlternatives:s,hashKeyMask:r}=this;e.addUniform("highp uint",t,s),e.addUniform("highp uint",r),e.addTextureSampler("usampler2D",n,this.textureUnitSymbol),e.addFragmentCode(lT),e.addFragmentCode(kt),e.addFragmentCode(A1),this.accessHelper.defineShader(e),e.addFragmentCode(this.accessHelper.getAccessor(this.readTable,this.samplerName,J.UINT64,1));let o="";o+=`
bool ${this.hasFunctionName}(uint64_t x) {
`;for(let l=0;l<s;++l)o+=`
  {
    uint h = hashCombine(${t}[${l}], x) & ${r};
    uint64_t key = ${this.readTable}(h);
    if (equals(key, x)) {
      return true;
    }
  }
`;o+=`
  return false;
}
`,e.addFragmentCode(o)}get hasFunctionName(){return`${this.prefix}_has`}enable(e,t,n){n.copyToGPU();const s=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+s),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,n.texture),e.uniform1ui(t.uniform(this.hashKeyMask),n.hashTable.tableSize-1),e.uniform1uiv(t.uniform(this.hashSeedsName),n.hashTable.hashSeeds)}disable(e,t){const n=t.textureUnit(this.textureUnitSymbol);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}}class dT extends cT{defineShader(e){super.defineShader(e);const{numAlternatives:t,hashSeedsName:n,hashKeyMask:s}=this;let r=`
bool ${this.getFunctionName}(uint64_t x, out uint64_t value) {
`;for(let o=0;o<t;++o)r+=`
  {
    uint h = hashCombine(${n}[${o}], x) & ${s};
    uint64_t key = ${this.readTable}(h * 2u);
    if (equals(key, x)) {
      value = ${this.readTable}(h * 2u + 1u);
      return true;
    }
  }
`;r+=`
  return false;
}
`,e.addFragmentCode(r)}get getFunctionName(){return`${this.prefix}_get`}}const ew=2;class m_{constructor(e){this.prefix=e,this.seedName=this.prefix+"_seed"}defineShader(e){const{seedName:t}=this;e.addUniform("highp uint",t),e.addFragmentCode(kt),e.addFragmentCode(lT),e.addFragmentCode(KN);let n=`
vec3 ${this.prefix}(uint64_t x) {
  uint h = hashCombine(${t}, x);
  vec${ew} v;
`;for(let s=0;s<ew;++s)n+=`
  v[${s}] = float(h & 0xFFu) / 255.0;
  h >>= 8u;
`;n+=`
  vec3 hsv = vec3(v.x, 0.5 + v.y * 0.5, 1.0);
  return hsvToRgb(hsv);
}
`,e.addFragmentCode(n)}enable(e,t,n){e.uniform1ui(t.uniform(this.seedName),n)}}const tw=new Float32Array(3);function uT(i){return`rgb(${i[0]*100}%,${i[1]*100}%,${i[2]*100}%)`}class Ov{constructor(e=Q0()){this.hashSeed=e,this.changed=new ue}static getDefault(){return new Ov(0)}get value(){return this.hashSeed}set value(e){e!==this.hashSeed&&(this.hashSeed=e,this.changed.dispatch())}compute(e,t){let n=Nu(this.hashSeed,t.low);n=Nu(n,t.high);const s=(n&255)/255,r=(n>>8&255)/255;return Iu(e,s,.5+.5*r,1),e}computeCssColor(e){return this.compute(tw,e),uT(tw)}randomize(){this.hashSeed=Q0(),this.changed.dispatch()}toString(){return`new SegmentColorHash(${this.hashSeed})`}toJSON(){return this.hashSeed===0?void 0:this.hashSeed}reset(){this.restoreState(0)}restoreState(e){const t=e>>>0;t!==this.hashSeed&&(this.hashSeed=t,this.changed.dispatch())}}class v_{constructor(e){this.prefix=e,this.hashMapShaderManager=new dT("segmentStatedColorHash")}defineShader(e){this.hashMapShaderManager.defineShader(e);const t=`
bool ${this.getFunctionName}(uint64_t x, out vec4 value) {
  uint64_t uint64Value;
  if (${this.hashMapShaderManager.getFunctionName}(x, uint64Value)) {
    uint uintValue = uint64Value.value[0];
    value.r = float((uintValue & 0x0000ffu))       / 255.0;
    value.g = float((uintValue & 0x00ff00u) >>  8) / 255.0;
    value.b = float((uintValue & 0xff0000u) >> 16) / 255.0;
    value.a = float((uintValue & 0xff000000u) >> 24) / 255.0;
    return true;
  }
  return false;
}
`;e.addFragmentCode(t)}get getFunctionName(){return`${this.prefix}_get`}enable(e,t,n){this.hashMapShaderManager.enable(e,t,n)}disable(e,t){this.hashMapShaderManager.disable(e,t)}}const hT=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowLeftIconTitle">
    <title id="arrowLeftIconTitle">Arrow Left</title>    
    <path d="M9 6l-6 6 6 6"/>
    <path d="M21 12H4"/>
    <path stroke-linecap="round" d="M3 12h1"/>
</svg>`,fT=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowRightIconTitle">
    <title id="arrowRightIconTitle">Arrow Right</title>    
    <path d="M15 18l6-6-6-6"/>
    <path d="M3 12h17"/>
    <path stroke-linecap="round" d="M21 12h-1"/>
</svg>`;let bp;function y_(){if(bp===void 0){const i=new He;i.set("keyl","recolor"),i.set("keyx","clear-segments"),i.set("keys","toggle-show-slices"),i.set("keyb","toggle-scale-bar"),i.set("keyv","toggle-default-annotations"),i.set("keya","toggle-axis-lines"),i.set("keyo","toggle-orthographic-projection");for(let e=1;e<=9;++e)i.set("digit"+e,"toggle-layer-"+e),i.set("control+digit"+e,"select-layer-"+e),i.set("alt+digit"+e,"toggle-pick-layer-"+e);for(let e=0;e<26;++e){const t=String.fromCharCode(97+e),n=String.fromCharCode(65+e);i.set(`alt?+control?+shift+key${t}`,`tool-${n}`)}i.set("keyn","add-layer"),i.set("keyh","help"),i.set("space","toggle-layout"),i.set("shift+space","toggle-layout-alternative"),i.set("backslash","toggle-show-statistics"),bp=i}return bp}let wp;function ic(){return wp===void 0&&(wp=He.fromObject({"control+mousedown2":"select-position"})),wp}let Cp;function S_(){return Cp===void 0&&(Cp=He.fromObject({click0:"pin-annotation",mousedown2:"move-to-annotation"},{parents:[[ic(),0]]})),Cp}let xp;function pT(){return xp===void 0&&(xp=He.fromObject({arrowleft:"x-",arrowright:"x+",arrowup:"y-",arrowdown:"y+",comma:"z-",period:"z+",bracketleft:"t-",bracketright:"t+",keyz:"snap","control+equal":"zoom-in","alt+equal":"depth-range-decrease","control+shift+equal":"zoom-in","alt+shift+equal":"depth-range-decrease","control+minus":"zoom-out","alt+minus":"depth-range-increase",keyr:"rotate-relative-z-",keye:"rotate-relative-z+","shift+arrowdown":"rotate-relative-x-","shift+arrowup":"rotate-relative-x+","shift+arrowleft":"rotate-relative-y-","shift+arrowright":"rotate-relative-y+","control+wheel":{action:"zoom-via-wheel",preventDefault:!0},"alt+wheel":{action:"adjust-depth-range-via-wheel",preventDefault:!0},"at:wheel":{action:"z+1-via-wheel",preventDefault:!0},"at:shift+wheel":{action:"z+10-via-wheel",preventDefault:!0},"at:dblclick0":"select","at:shift+dblclick0":"star","at:control+mousedown0":"annotate","at:mousedown2":"move-to-mouse-position","at:alt+mousedown0":"move-annotation","at:control+alt+mousedown2":"delete-annotation","at:touchpinch":"zoom-via-touchpinch","at:touchrotate":"rotate-in-plane-via-touchrotate","at:touchtranslate2":"translate-in-plane-via-touchtranslate","at:touchhold1":"move-to-mouse-position","at:touchtap1x2":"select","at:touchtap2x3":"snap"},{label:"All Data Panels",parents:[[ic(),0]]})),xp}let Ep;function b_(){return Ep===void 0&&(Ep=He.fromObject({"at:mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"rotate-out-of-plane-via-touchtranslate"},{parents:[[pT(),Number.NEGATIVE_INFINITY]]})),Ep}let Tp;function w_(){return Tp===void 0&&(Tp=He.fromObject({"at:mousedown0":{action:"translate-via-mouse-drag",stopPropagation:!0},"at:shift+mousedown0":{action:"rotate-via-mouse-drag",stopPropagation:!0},"at:touchtranslate1":"translate-z-via-touchtranslate"},{parents:[[pT(),Number.NEGATIVE_INFINITY]]})),Tp}function C_(i){i.global.addParent(y_(),Number.NEGATIVE_INFINITY),i.sliceView.addParent(w_(),Number.NEGATIVE_INFINITY),i.perspectiveView.addParent(b_(),Number.NEGATIVE_INFINITY)}let sa;const Ul=[];function x_(){if(sa===void 0){const i=sa=document.createElement("div");i.classList.add("neuroglancer-drag-status"),document.body.appendChild(i)}return sa}function E_(){sa!==void 0&&(Fe(sa),sa.style.display="none")}function gT(i){const e=x_();Fe(e),typeof i=="string"?e.appendChild(document.createTextNode(i)):e.appendChild(i()),e.style.display=""}function mT(i,e){rx(Ul,t=>!(t.target===i&&t.operation===e))}function Ei(i,e,t){mT(i,e),Ul.push({target:i,operation:e,status:t}),gT(t)}function Zt(i,e){mT(i,e);const t=Ul.length===0?void 0:Ul[Ul.length-1];t===void 0?E_():gT(t.status)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function oi(i,e,t){const{document:n}=i.view;let s=i.clientX,r=i.clientY;const o=h=>{const g=h.clientX-s,v=h.clientY-r;s=h.clientX,r=h.clientY,e(h,g,v)},l=i.button,c=h=>{n.removeEventListener("pointermove",o,!0),n.removeEventListener("pointerup",u,!1),t!==void 0&&t(h,h.clientX-s,h.clientY-r)},u=h=>{h.button===l&&c(h)};n.addEventListener("pointermove",o,!0),n.addEventListener("pointerup",u,!1),n.addEventListener("pointercancel",c,!1)}const T_=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="closeIconTitle">
    <title id="closeIconTitle">Close</title>    
    <path d="M6.34314575 6.34314575L17.6568542 17.6568542M6.34314575 17.6568542L17.6568542 6.34314575"/>
</svg>`;function _v(i={}){return $e({svg:T_,...i})}const ra="neuroglancer-drag-over",nw={row:"row",column:"col"},k_={left:"right",right:"left",top:"bottom",bottom:"top"},Zs={left:"column",right:"column",top:"row",bottom:"row"},Bd={left:"row",right:"row",top:"column",bottom:"column"},zr={row:"width",column:"height"},iw={row:"left",column:"top"},L_={row:"right",column:"bottom"},sw={left:"marginLeft",right:"marginRight",top:"marginTop",bottom:"marginBottom"},Fd={left:-1,right:1,top:-1,bottom:1};class ho extends K{constructor(e,t=new wr){super(),this.sidePanelManager=e,this.location=t,this.element=document.createElement("div"),this.visibility=new Pt(Pt.VISIBLE);const{element:n}=this;n.classList.add("neuroglancer-side-panel"),n.draggable=!0,n.addEventListener("dragstart",s=>{this.sidePanelManager.startDrag(this.makeDragSource(),s),n.style.backgroundColor="black",setTimeout(()=>{n.style.backgroundColor=""},0),Ei(n,"drag",()=>document.createTextNode("Drag side panel to move it to the left/right/top/bottom of another panel"))}),n.addEventListener("dragend",s=>{this.sidePanelManager.endDrag(),Zt(n,"drag")})}makeDragSource(){return{dropAsNewPanel:e=>{const t=this.location.value;this.location.value={...t,...e},this.location.locationChanged.dispatch()}}}close(){this.location.visible=!1}addTitleBar(e){const t=document.createElement("div");t.classList.add("neuroglancer-side-panel-titlebar");const{title:n}=e;let s;n!==void 0&&(s=document.createElement("div"),s.classList.add("neuroglancer-side-panel-title"),s.textContent=n,t.appendChild(s));const r=_v({title:"Close panel",onClick:()=>{this.close()}});return r.style.order="100",t.appendChild(r),this.element.appendChild(t),{titleBar:t,titleElement:s,closeButton:r}}addBody(e){e.draggable=!0,e.addEventListener("dragstart",t=>{t.preventDefault(),t.stopPropagation()}),this.element.appendChild(e)}}class D_ extends K{constructor(e,t,n=new Pt(Pt.VISIBLE)){super(),this.display=e,this.center=t,this.visibility=n,this.element=document.createElement("div"),this.centerColumn=document.createElement("div"),this.beforeRender=new Ze,this.sides={left:this.makeSidePanelSideState("left"),right:this.makeSidePanelSideState("right"),top:this.makeSidePanelSideState("top"),bottom:this.makeSidePanelSideState("bottom")},this.registeredPanels=new Set,this.layoutNeedsUpdate=!1,this.invalidateLayout=()=>{this.layoutNeedsUpdate=!0,this.display.scheduleRedraw()};const{element:s,centerColumn:r}=this;s.style.display="flex",s.style.flex="1",s.style.flexDirection="row",r.style.display="flex",r.style.flex="1",r.style.flexDirection="column",r.style.flexBasis="0px",r.style.minWidth="0px",this.render(),this.registerDisposer(e.updateStarted.add(()=>{this.beforeRender.dispatch(),this.layoutNeedsUpdate&&(this.render(),++e.resizeGeneration)})),this.registerDisposer(this.visibility.changed.add(this.invalidateLayout))}get visible(){return this.visibility.visible}makeSidePanelSideState(e){return{flexGroups:[],outerDropZoneElement:this.makeDropZone(e,Fd[e]*(1/0),0,e,!1)}}hasDroppablePanel(){return this.dragSource!==void 0}startDrag(e,t){setTimeout(()=>{this.dragSource===e&&(this.element.dataset.neuroglancerSidePanelDrag="true")},0),this.dragSource=e,t.stopPropagation(),t.dataTransfer.setData("neuroglancer-side-panel","")}endDrag(){delete this.element.dataset.neuroglancerSidePanelDrag,this.dragSource=void 0}makeDropZone(e,t,n,s,r=!1){const o=document.createElement("div");o.className="neuroglancer-side-panel-drop-zone";const l=10,c=Zs[s],u=Bd[s];return o.style[zr[u]]=`${l}px`,o.style[zr[c]]="100%",r?(o.style.position="absolute",o.style[s]="50%",o.style[sw[s]]="-${size/2}px"):(o.style.position="relative",o.style[sw[k_[s]]]=`-${l}px`),o.addEventListener("dragenter",h=>{this.hasDroppablePanel()&&(o.classList.add(ra),h.preventDefault(),Ei(o,"drop",()=>document.createTextNode(`Drop side panel as new ${c}`)))}),o.addEventListener("dragleave",()=>{Zt(o,"drop"),o.classList.remove(ra)}),o.addEventListener("dragover",h=>{this.hasDroppablePanel()&&h.preventDefault()}),o.addEventListener("drop",h=>{const{dragSource:g}=this;if(g===void 0)return;Zt(o,"drop"),o.classList.remove(ra);const v=Zs[e];g.dropAsNewPanel({side:e,row:v==="column"?n:t,col:v==="row"?n:t}),this.dragSource=void 0,h.preventDefault(),h.stopPropagation()}),o}registerPanel(e){return this.registeredPanels.add(e),this.invalidateLayout(),e.location.locationChanged.add(this.invalidateLayout),()=>{this.unregisterPanel(e)}}unregisterPanel(e){var t;this.registeredPanels.delete(e),e.location.locationChanged.remove(this.invalidateLayout),(t=e.panel)==null||t.dispose(),this.invalidateLayout()}disposed(){for(const{panel:e}of this.registeredPanels)e==null||e.dispose();super.disposed()}render(){this.layoutNeedsUpdate=!1;const e={left:[],right:[],top:[],bottom:[]};for(const o of this.registeredPanels)e[o.location.value.side].push(o);const t=o=>this.renderSide(o,this.sides[o].flexGroups,e[o]),n=this;function*s(){yield n.sides.left.outerDropZoneElement,yield*t("left"),yield n.centerColumn,yield*t("right"),yield n.sides.right.outerDropZoneElement}si(this.element,s());function*r(){yield n.sides.top.outerDropZoneElement,yield*t("top"),yield n.center,yield*t("bottom"),yield n.sides.bottom.outerDropZoneElement}si(this.centerColumn,r())}makeCrossGutter(e,t){const n=document.createElement("div");n.style.position="relative";const s=Bd[e];n.className=`neuroglancer-resize-gutter-${s==="row"?"horizontal":"vertical"}`,n.addEventListener("pointerdown",o=>{if("button"in o&&o.button!==0)return;o.preventDefault();const l=this.sides[e].flexGroups[t];if(l===void 0||!l.visible)return;let u=l.element.getBoundingClientRect()[zr[s]];const h=l.minSize,g=()=>{Ei(n,"drag",`Drag to resize, current ${zr[s]} is ${l.crossSize}px`)};g(),oi(o,(v,y,b)=>{const w=s==="row"?y:b;u-=Fd[e]*w,l.crossSize=Math.max(h,Math.round(u)),g(),this.invalidateLayout()},()=>{Zt(n,"drag")})});const r=this.makeDropZone(e,t-Fd[e]*.5,0,e,!0);return n.appendChild(r),n}makeFlexGutter(e,t,n){const s=document.createElement("div");s.style.position="relative";const r=Zs[e];s.className=`neuroglancer-resize-gutter-${r==="row"?"horizontal":"vertical"}`,s.addEventListener("pointerdown",l=>{if("button"in l&&l.button!==0)return;l.preventDefault();const c=this.sides[e].flexGroups[t];if(c===void 0||!c.visible)return;const{cells:u}=c,h=u[n];if(h===void 0||!h.registeredPanel.location.visible)return;let g=n+1;for(;g<u.length&&!u[g].registeredPanel.location.visible;)++g;if(g===u.length)return;const v=u[g],y=()=>{Ei(s,"drag",`Drag to resize, current ${zr[r]} ratio is ${h.registeredPanel.location.value.flex} : ${v.registeredPanel.location.value.flex}`)};y(),oi(l,b=>{const w=h.registeredPanel.panel,C=v.registeredPanel.panel;if(w===void 0||C===void 0)return;const E=w.element.getBoundingClientRect(),k=C.element.getBoundingClientRect(),D=Math.max(.1,Math.min(.9,r==="column"?(b.clientY-E.top)/(k.bottom-E.top):(b.clientX-E.left)/(k.right-E.left))),A=h.registeredPanel.location.value,N=v.registeredPanel.location.value,I=A.flex+N.flex;h.registeredPanel.location.value={...A,flex:Math.round(D*I*100)/100},v.registeredPanel.location.value={...N,flex:Math.round((1-D)*I*100)/100},y(),h.registeredPanel.location.locationChanged.dispatch(),v.registeredPanel.location.locationChanged.dispatch(),this.invalidateLayout()},()=>{Zt(s,"drag")})});const o=this.makeDropZone(e,t,n+.5,iw[Zs[e]],!0);return s.appendChild(o),s}renderSide(e,t,n){const s=nw[Bd[e]],r=nw[Zs[e]];n.sort((c,u)=>{const h=c.location.value,g=u.location.value,v=h[r]-g[r];return v!==0?v:h[s]-g[s]});const o=this;function*l(){let c=0;const u=n.length;let h=0;for(;c<u;){const g=n[c].location.value[r];let v=c,y=0,b=0;do{const k=n[v].location.value;if(k[r]!==g)break;k.visible&&(++y,b=Math.max(b,k.minSize)),++v}while(v<u);const w=y>0;let C=t[h];if(C===void 0){const k=o.makeCrossGutter(e,h),D=document.createElement("div");D.className=`neuroglancer-side-panel-${Zs[e]}`,C=t[h]={element:D,gutterElement:k,cells:[],crossSize:-1,minSize:b,visible:w,beginDropZone:o.makeDropZone(e,h,-1/0,iw[Zs[e]]),endDropZone:o.makeDropZone(e,h,1/0,L_[Zs[e]])}}else C.visible=w,C.minSize=b,C.crossSize=Math.max(C.crossSize,b);function*E(){yield C.beginDropZone;let k=0;for(let D=c,A=0;D<v;++D,++A){const N=n[D];let I=C.cells[A];I===void 0?I=C.cells[A]={registeredPanel:N,gutterElement:void 0}:I.registeredPanel=N;const P=I.registeredPanel.location.value;C.crossSize===-1&&(C.crossSize=Math.max(b,P.size)),(P[r]!==h||P[s]!==A||P.visible&&P.size!==C.crossSize)&&(I.registeredPanel.location.value={...P,[r]:h,[s]:A,size:P.visible?C.crossSize:P.size},I.registeredPanel.location.changed.dispatch());const O=P.visible&&o.visibility.visible;let{panel:_}=N;if(!O){_!==void 0&&(_.dispose(),N.panel=void 0);continue}++k,_===void 0&&(_=N.panel=N.makePanel()),_.element.style.flex=y>1?`${P.flex}`:"1",yield _.element,k===y?I.gutterElement=void 0:(I.gutterElement===void 0&&(I.gutterElement=o.makeFlexGutter(e,h,A)),yield I.gutterElement)}yield C.endDropZone}si(C.element,E()),C.cells.length=v-c,w&&(C.element.style[zr[Bd[e]]]=`${C.crossSize}px`,Fd[e]>0?(yield C.gutterElement,yield C.element):(yield C.element,yield C.gutterElement)),c=v,++h}t.length=h}return l()}}function gr(i,e="text/plain"){let t=!1;const n=ti(document,"copy",s=>{const{clipboardData:r}=s;r!==null&&(r.setData(e,i),t=!0),s.stopPropagation(),s.preventDefault()},!0);try{document.execCommand("copy")}finally{n()}return t}class Kn extends K{constructor(e,t){super(),this.element=$e({...t,onClick:()=>{e.value=!e.value}}),this.element.classList.add("neuroglancer-checkbox-icon"),this.element.classList.add(t.backgroundScheme==="dark"?"dark-background":"light-background");const n=()=>{const s=e.value;this.element.dataset.checked=s?"true":"false",this.element.title=(s?t.disableTitle:t.enableTitle)||""};this.registerDisposer(e.changed.add(n)),n()}}const I_=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="copyIconTitle">
    <title id="copyIconTitle">Copy</title>    
    <rect width="12" height="14" x="8" y="7"/>
    <polyline points="16 3 4 3 4 17"/>
</svg>`;function xs(i={}){return $e({svg:I_,...i})}function vT(i={}){return $e({text:"↗",...i})}function rw(i){return i.closest(".neuroglancer-selection-details")}class P_ extends ho{constructor(e,t,n,s){super(e,t.location),this.sidePanelManager=e,this.state=t,this.manager=n,this.selectedLayer=s,this.body=document.createElement("div");const{element:r,body:o}=this;r.classList.add("neuroglancer-selection-details"),this.registerDisposer(new ji(this.element,ic()));const{titleBar:l}=this.addTitleBar({title:"Selection"}),c=$e({svg:hT,title:"Previous selection",onClick:()=>{this.state.goBack()}}),u=$e({svg:fT,title:"Next selection",onClick:()=>{this.state.goForward()}});l.appendChild(c),l.appendChild(u),l.appendChild(this.registerDisposer(new Kn(t.pin,{text:"📌︎",enableTitle:"Pin selection",disableTitle:"Unpin selection"})).element),o.classList.add("neuroglancer-selection-details-body"),this.addBody(o),o.appendChild(this.registerDisposer(new Vn(t,(h,g,v)=>{if(!t.location.visible||(c.style.visibility=t.canGoBack()?"visible":"hidden",u.style.visibility=t.canGoForward()?"visible":"hidden",h===void 0))return;const{position:y}=h;if(y!==void 0){const b=document.createElement("div");b.classList.add("neuroglancer-selection-details-position");const w=xs({title:"Copy position",onClick:()=>{gr(k.map(A=>Math.floor(A)).join(", "))}});b.appendChild(w);const{coordinateSpace:{rank:C,names:E},position:k}=h;for(let A=0;A<C;++A){const N=document.createElement("span");N.classList.add("neuroglancer-selection-details-position-dimension");const I=document.createElement("span");I.classList.add("neuroglancer-selection-details-position-dimension-name"),I.textContent=E[A];const P=document.createElement("span");P.classList.add("neuroglancer-selection-details-position-dimension-coordinate"),P.textContent=Math.floor(k[A]).toString(),N.appendChild(I),N.appendChild(P),b.appendChild(N)}const D=vT({title:"Move to position",onClick:()=>{this.manager.globalPosition.value=k}});b.appendChild(D),g.appendChild(b)}for(const b of h.layers){const{layer:w}=b;g.appendChild(v.registerDisposer(new Vn({value:void 0,changed:w.managedLayer.layerChanged},(C,E,k)=>{if(w.wasDisposed||!w.isReady)return;const D=document.createElement("div");if(D.classList.add("neuroglancer-selection-details-layer-body"),!w.displaySelectionState(b.state,D,k))return;const A=document.createElement("div");E.appendChild(A),A.classList.add("neuroglancer-selection-details-layer");const N=document.createElement("div");N.classList.add("neuroglancer-selection-details-layer-title"),N.textContent=w.managedLayer.name,N.addEventListener("click",()=>{this.selectedLayer.layer=w.managedLayer,this.selectedLayer.visible=!0}),N.title="Click to show layer side panel",A.appendChild(N),A.appendChild(D)})).element)}})).element)}close(){super.close(),this.state.value=void 0,this.state.pin.value=!0}}const yT=`<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeCrossedIconTitle">
	<title id="eyeCrossedIconTitle">Hidden (crossed eye)</title>
	<path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"/>
	<circle cx="12" cy="12" r="3"/>
	<path d="M3 21L20 4"/>
</svg>`;function ST(i={}){const e=$e({svg:yT,...i});return e.classList.add("neuroglancer-eye-icon"),e}const A_=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="filterIconTitle">
    <title id="filterIconTitle">Filter</title>    
    <path d="M10 12.261L4.028 3.972h16L14 12.329V17l-4 3z"/>
</svg>`;function R_(i={}){return $e({svg:A_,...i})}const N_=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="starIconTitle">
  <title id="starIconTitle">Star</title>  
  <polygon points="12 17.844 6.183 20.902 7.294 14.425 2.588 9.838 9.092 8.893 12 3 14.908 8.893 21.412 9.838 16.706 14.425 17.817 20.902"/>
</svg>`;function bT(i={}){const e=$e({svg:N_,...i});return e.classList.add("neuroglancer-star-icon"),e}class mr{constructor(e,t,n){this.key=e,this.value=t,this.label=n}toString(){const{key:e,value:t,label:n}=this;let s;return t===void 0?s=`${e}`:s=`${e}→${t}`,n===void 0?s:`${s} ${n}`}}class M_ extends K{constructor(){super(...arguments),this.selectedSegment=new X,this.baseSelectedSegment=new X,this.hasSelectedSegment=!1,this.changed=new ue}get value(){return this.hasSelectedSegment?this.selectedSegment:void 0}get baseValue(){return this.hasSelectedSegment?this.baseSelectedSegment:void 0}set(e,t=!1){const{selectedSegment:n,baseSelectedSegment:s}=this;let r=0,o=0,l=0,c=0,u;if(e==null)u=!1;else if(typeof e=="number")r=l=e>>>0,o=c=e<0?4294967295:0,u=!0;else if(e instanceof mr){const h=e.value||e.key;r=h.low,o=h.high,l=e.key.low,c=e.key.high,u=!0}else e instanceof X?(r=l=e.low,o=c=e.high,u=!0):u=!1;t&&r===0&&o===0&&(u=!1),u?u&&(!this.hasSelectedSegment||n.low!==r||n.high!==o||s.low!==l||s.high!==c)&&(n.low=r,n.high=o,s.low=l,s.high=c,this.hasSelectedSegment=!0,this.changed.dispatch()):this.hasSelectedSegment&&(this.hasSelectedSegment=!1,this.changed.dispatch())}isSelected(e){return this.hasSelectedSegment&&X.equal(e,this.selectedSegment)}bindTo(e,t){this.registerDisposer(e.changed.add(()=>{const n=e.get(t);let s;n!==void 0&&(s=n.value),this.set(s,t.displayState.segmentationGroupState.value.hideSegmentZero.value)}))}}function sc(i){i.useTemporarySegmentEquivalences.value=!1,i.useTemporaryVisibleSegments.value=!1,i.temporaryVisibleSegments.clear(),i.temporarySegmentEquivalences.clear()}function wT(i,e,t=!1){let n,s,r;if(typeof e=="number"?n=new X(e>>>0,e<0?4294967295:0):typeof e=="string"?n=X.parseString(e):n=t?e.clone():e,i==null)return n;const{segmentEquivalences:o,segmentPropertyMap:{value:l}}=i.segmentationGroupState.value;o.size!==0?(s=o.get(n),X.equal(s,n)?r=void 0:r=s):s=n;const c=l==null?void 0:l.getSegmentLabel(s);return c===void 0&&r===void 0?n:new mr(n,r,c)}function eo(i,e){if(e instanceof mr)return e;const t=wT(i,e);return t instanceof X?new mr(t):t}function ow(i,e){const{length:t}=e;i.value<t&&(i.value=t)}function rc(i,e){return ys(t=>e.style.setProperty("--neuroglancer-segment-list-width",`${t}ch`),i.segmentationGroupState.value.maxIdLength)}const Vv=(()=>{const i=document.createElement("div");i.classList.add("neuroglancer-segment-list-entry");const e=document.createElement("div");e.classList.add("neuroglancer-segment-list-entry-sticky"),i.appendChild(e);const t=xs({title:"Copy segment ID"});t.classList.add("neuroglancer-segment-list-entry-copy");const n=document.createElement("div");n.classList.add("neuroglancer-segment-list-entry-copy-container");const s=n.childElementCount;n.appendChild(t);const r=e.childElementCount;e.appendChild(n);const o=e.childElementCount,l=ST({title:"Toggle segment visibility"});l.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),e.appendChild(l);const c=document.createElement("div");c.classList.add("neuroglancer-segment-list-entry-id-container");const u=e.childElementCount;e.appendChild(c);const h=document.createElement("div");h.classList.add("neuroglancer-segment-list-entry-id");const g=c.childElementCount;c.appendChild(h);const v=bT({title:"Star segment"});v.classList.add("neuroglancer-segment-list-entry-star");const y=e.childElementCount;e.appendChild(v);const b=document.createElement("span");b.classList.add("neuroglancer-segment-list-entry-name");const w=i.childElementCount;i.appendChild(b);const C=R_({title:"Filter by label"});C.classList.add("neuroglancer-segment-list-entry-filter");const E=i.childElementCount;return i.appendChild(C),{template:i,copyContainerIndex:r,copyIndex:s,visibleIndex:o,idContainerIndex:u,idIndex:g,labelIndex:w,filterIndex:E,starIndex:y,unmappedIdIndex:-1,unmappedCopyIndex:-1}})(),O_=(()=>{const i=Vv,e=i.template.cloneNode(!0),t=e.children[0],n=t.children[i.idContainerIndex],s=n.childElementCount,r=n.children[i.idIndex].cloneNode(!0);r.classList.add("neuroglancer-segment-list-entry-unmapped-id"),n.appendChild(r);const o=t.children[i.copyContainerIndex],l=o.childElementCount;return o.appendChild(o.children[i.copyIndex].cloneNode(!0)),{...i,template:e,unmappedIdIndex:s,unmappedCopyIndex:l}})();function __(i){const e=Vv,t=e.template.cloneNode(!0),n=[];for(let s=0;s<i;++s){n.push(t.childElementCount);const r=document.createElement("div");r.classList.add("neuroglancer-segment-list-entry-extra-property"),r.style.width=`max(var(--neuroglancer-column-${s}-width), var(--neuroglancer-column-${s}-label-width))`,t.appendChild(r)}return{...e,template:t,numericalPropertyIndices:n}}const aw=new WeakMap;function V_(i){const e=h=>{const g=h.currentTarget,v=g.dataset.id,y=Yn;y.tryParseString(v),i.segmentSelectionState.set(y),rw(g)||i.selectSegment(y,!1)},t=h=>{const g=h.currentTarget,v=g.dataset.id,y=Yn;y.tryParseString(v),i.selectSegment(y,rw(g)?"toggle":!0)},n=()=>{i.segmentSelectionState.set(null)},s=h=>h.currentTarget.closest(".neuroglancer-segment-list-entry"),r=h=>{const g=s(h);gr(g.dataset.id),h.stopPropagation()},o=h=>{const g=s(h);gr(g.dataset.unmappedId),h.stopPropagation()},l=h=>{const v=s(h).dataset.id,y=Yn;y.tryParseString(v);const{selectedSegments:b,visibleSegments:w}=i.segmentationGroupState.value,C=!w.has(y);C&&b.add(y),w.set(y,C),h.stopPropagation(),h.preventDefault()},c=h=>{const v=s(h).dataset.id,y=Yn;y.tryParseString(v),i.filterBySegmentLabel(y),h.stopPropagation()},u=h=>{if(h.button!==2||h.ctrlKey||h.altKey||h.metaKey||h.shiftKey)return;const v=h.currentTarget.dataset.id,y=Yn;y.tryParseString(v),i.moveToSegment(y)};return(h,g)=>{const{children:v}=h,y=v[0].children;h.addEventListener("mousedown",u);const b=y[g.copyContainerIndex];g.unmappedCopyIndex!==-1&&b.children[g.unmappedCopyIndex].addEventListener("click",o),b.children[g.copyIndex].addEventListener("click",r),h.addEventListener("mouseenter",e),h.addEventListener("mouseleave",n),y[g.visibleIndex].addEventListener("click",l),v[g.filterIndex].addEventListener("click",c),h.addEventListener("action:select-position",t),y[g.starIndex].addEventListener("click",C=>{const k=s(C).dataset.id,D=Yn;D.tryParseString(k);const{selectedSegments:A}=i.segmentationGroupState.value;A.set(D,!A.has(D))})}}class za{constructor(e,t){if(this.displayState=e,this.template=t,e!==void 0){let n=aw.get(e);n===void 0&&(n=V_(e),aw.set(e,n)),this.registerEventHandlers=n}}static make(e,t){return new za(e,t?O_:Vv)}get(e){const{displayState:t}=this;return this.getWithNormalizedId(eo(t,e))}getWithNormalizedId(e){const{displayState:t}=this,{template:n}=this,s=n.template.cloneNode(!0),r=e.key,o=e.value??r,l=o.toString();s.dataset.id=l;const{children:c}=s,u=c[0].children,h=u[n.idContainerIndex];h.children[n.idIndex].textContent=l;const{unmappedIdIndex:g}=n;if(t!==void 0?this.registerEventHandlers(s,n):u[n.visibleIndex].style.display="none",g!==-1){const v=h.children[g];if(X.equal(r,o)){v.style.display="none";const y=u[n.copyContainerIndex];y.children[n.unmappedCopyIndex].style.display="none"}else{const y=r.toString();s.dataset.unmappedId=y,v.textContent=y,t!==void 0&&ow(t.segmentationGroupState.value.maxIdLength,y)}}return c[n.labelIndex].textContent=e.label??"",t!==void 0&&(this.updateWithId(s,o),ow(t.segmentationGroupState.value.maxIdLength,l)),s}update(e){const t=Yn,n=e.dataset.id;n!==void 0&&(t.parseString(n),this.updateWithId(e,t))}updateWithId(e,t){const{children:n}=e,s=n[0].children,{template:r}=this,{displayState:o}=this,{segmentSelectionState:l}=o,{visibleSegments:c}=o.segmentationGroupState.value;s[r.visibleIndex].classList.toggle("neuroglancer-visible",c.has(t)),e.dataset.selected=(l.hasSelectedSegment&&X.equal(l.selectedSegment,t)).toString();const{selectedSegments:u}=o.segmentationGroupState.value;s[r.starIndex].classList.toggle("neuroglancer-starred",u.has(t));const h=s[r.idContainerIndex];lw(h.children[r.idIndex],Xg(this.displayState,t));const{unmappedIdIndex:g}=r;if(g!==-1){let v,y;if(o.baseSegmentColoring.value&&(v=e.dataset.unmappedId)!==void 0){const b=Yn;b.parseString(v),y=Xg(this.displayState,b)}else y=bx;lw(h.children[g],y)}}}function lw(i,e){i.style.backgroundColor=uT(e),i.style.color=rg(e)?"white":"black"}class CT extends za{constructor(e,t,n){const s=e.segmentationGroupState.value.segmentPropertyMap.value,r=((s==null?void 0:s.numericalProperties)??[]).filter(n),o=__(r.length);super(e,o),this.parentElement=t,this.segmentPropertyMap=s,this.numericalProperties=r,(this.numericalPropertyWidths=new Array(this.numericalProperties.length)).fill(0)}getWithNormalizedId(e){var r;const t=super.getWithNormalizedId(e),{numericalProperties:n}=this,{numericalPropertyIndices:s}=this.template;if(s.length>0){const o=((r=this.segmentPropertyMap)==null?void 0:r.getSegmentInlineIndex(e.value??e.key))??-1;if(o!==-1){const{numericalPropertyWidths:l}=this;for(let c=0,u=s.length;c<u;++c){const h=n[c].values[o];if(!Number.isNaN(h)){const g=h.toString(),v=g.length;v>l[c]&&(l[c]=v,this.parentElement.style.setProperty(`--neuroglancer-column-${c}-width`,`${v}ch`)),t.children[s[c]].textContent=g}}}}return t}makeHeaderLabel(e,t,n){const s=document.createElement("span");s.textContent=e,s.classList.add("neuroglancer-segment-list-header-label"),s.classList.add("neuroglancer-segment-list-header-label"),e==="label"&&(n.style.textAlign="left");const r=document.createElement("span");r.classList.add("neuroglancer-segment-list-header-label-sort"),s.appendChild(r),r.textContent="▲";const o=dO(s).width;return this.parentElement.style.setProperty(t,`${o}px`),n.appendChild(s),{id:e,label:s,sortIcon:r}}getHeader(){const{template:e}=this,t=e.template.cloneNode(!0),{children:n}=t,s=n[0].children,r=s[e.copyContainerIndex];r.style.visibility="hidden",s[e.visibleIndex].style.visibility="hidden",n[e.filterIndex].style.visibility="hidden";const o=s[e.idContainerIndex],l=[this.makeHeaderLabel("id","--neuroglancer-id-column-label-width",o.children[e.idIndex]),this.makeHeaderLabel("label","--neuroglancer-label-column-label-width",n[e.labelIndex])],{numericalProperties:c}=this,{numericalPropertyIndices:u}=this.template;for(let h=0,g=u.length;h<g;++h){const v=c[h],y=this.makeHeaderLabel(v.id,`--neuroglancer-column-${h}-label-width`,t.children[u[h]]),{description:b}=v;b&&(y.label.title=b),l.push(y)}return{container:t,propertyLabels:l}}}function Bv(i,e){return za.make(i??void 0,!0).getWithNormalizedId(e)}function Ga(i,e,t){e.registerDisposer(ca((n,s)=>{h2(n,s,t)},i.segmentationGroupState)),e.registerDisposer(ca((n,s)=>{n.registerDisposer(s.segmentColorHash.changed.add(t)),n.registerDisposer(s.segmentDefaultColor.changed.add(t))},i.segmentationColorGroupState)),e.registerDisposer(i.saturation.changed.add(t)),e.registerDisposer(i.segmentSelectionState.changed.add(t)),e.registerDisposer(i.baseSegmentColoring.changed.add(t)),e.registerDisposer(i.hoverHighlight.changed.add(t))}function xT(i,e){const t=e.redrawNeeded.dispatch;Ga(i,e,t),e.registerDisposer(ca((n,s)=>{f2(n,s,t)},i.segmentationGroupState))}function B_(i,e){xT(i,e),e.registerDisposer(i.objectAlpha.changed.add(e.redrawNeeded.dispatch))}function Fv(i,e){B_(i,e),e.registerDisposer(i.transform.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.renderScaleTarget.changed.add(e.redrawNeeded.dispatch)),e.registerDisposer(i.transparentPickEnabled.changed.add(e.redrawNeeded.dispatch))}const ET=lh(),Yn=new X;function Xg(i,e,t=ET){if(i==null)return t.fill(1),t;const n=i.segmentationColorGroupState.value,{segmentStatedColors:s}=n;if(s.size!==0&&n.segmentStatedColors.get(e,Yn))return t[0]=(Yn.low&255)/255,t[1]=((Yn.low&65280)>>>8)/255,t[2]=((Yn.low&16711680)>>>16)/255,t;const r=n.segmentDefaultColor.value;return r!==void 0?(t[0]=r[0],t[1]=r[1],t[2]=r[2],t):(n.segmentColorHash.compute(t,e),t)}function F_(i,e,t=1){const n=ET;n[3]=t,Xg(i,e,n);let s=i.saturation.value;i.hoverHighlight.value&&i.segmentSelectionState.isSelected(e)&&(s>.5?s=s-=.5:s+=.5);for(let r=0;r<3;++r)n[r]=n[r]*s+(1-s);return n[0]*=t,n[1]*=t,n[2]*=t,n}function TT(i,e={}){for(const t of nE)e[t]=i[t].rpcId;return e}const U_=Ac(Oc);class Bh extends U_{constructor(e,t,n){super(n),this.chunkManager=e,this.displayState=t;const s=t.segmentationGroupState.value;for(const r of nE)this.registerDisposer(s[r].addRef())}initializeCounterpartWithChunkManager(e){const{displayState:t}=this;e.chunkManager=this.chunkManager.rpcId,TT(t.segmentationGroupState.value,e),e.transform=this.registerDisposer(Tt.makeFromExisting(this.chunkManager.rpc,this.displayState.transform)).rpcId,e.renderScaleTarget=this.registerDisposer(Tt.makeFromExisting(this.chunkManager.rpc,this.displayState.renderScaleTarget)).rpcId,super.initializeCounterpart(this.chunkManager.rpc,e)}}function Uv(i,e,t,n,s){const r=Math.min(1,i.objectAlpha.value),o=i.baseSegmentColoring.value;Ca(i.segmentationGroupState.value,(l,c)=>{const u=n==null?void 0:n.registerUint64(e,l),h=t?F_(i,o?l:c,r):void 0;s(l,h,u,c)})}var z_=Object.defineProperty,G_=Object.getOwnPropertyDescriptor,kT=(i,e,t,n)=>{for(var s=n>1?void 0:n?G_(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&z_(e,t,s),s};const $_=Ve(),Jn=Dc();function LT(i,e){e.vertexBuffer=dn.fromData(i,e.meshData.vertexPositions,i.ARRAY_BUFFER,i.STATIC_DRAW),e.indexBuffer=dn.fromData(i,e.meshData.indices,i.ELEMENT_ARRAY_BUFFER,i.STATIC_DRAW),e.normalBuffer=dn.fromData(i,e.meshData.vertexNormals,i.ARRAY_BUFFER,i.STATIC_DRAW)}function DT(i){i.vertexBuffer.dispose(),i.indexBuffer.dispose(),i.normalBuffer.dispose()}const W_=`
highp vec3 decodeNormalOctahedronSnorm8(highp vec2 e) {
  vec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));
  if (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * vec2(v.x > 0.0 ? 1.0 : -1.0, v.y > 0.0 ? 1.0 : -1.0);
  return normalize(v);
}
`;function cw(i){return{defineShader:e=>{e.addAttribute("highp vec3","aVertexPosition"),e.addVertexCode("highp vec3 getVertexPosition() { return aVertexPosition; }")},bind(e,t,n){n.vertexBuffer.bindToVertexAttrib(t.attribute("aVertexPosition"),3,i,!0)},endLayer:(e,t)=>{e.disableVertexAttribArray(t.attribute("aVertexPosition"))}}}const H_={[cr.float32]:cw(WebGL2RenderingContext.FLOAT),[cr.uint16]:cw(WebGL2RenderingContext.UNSIGNED_SHORT),[cr.uint10]:{defineShader:i=>{i.addAttribute("highp uint","aVertexPosition"),i.addVertexCode(`
highp vec3 getVertexPosition() {
  return vec3(float(aVertexPosition & 1023u),
              float((aVertexPosition >> 10) & 1023u),
              float((aVertexPosition >> 20) & 1023u)) / 1023.0;
}
`)},bind(i,e,t){t.vertexBuffer.bindToVertexAttribI(e.attribute("aVertexPosition"),1,WebGL2RenderingContext.UNSIGNED_INT)},endLayer:(i,e)=>{i.disableVertexAttribArray(e.attribute("aVertexPosition"))}}};class IT{constructor(e,t){this.fragmentRelativeVertices=e,this.vertexPositionFormat=t,this.tempLightVec=new Float32Array(4),this.vertexPositionHandler=H_[this.vertexPositionFormat]}beginLayer(e,t,n,s){const{lightDirection:r,ambientLighting:o,directionalLighting:l}=n,c=this.tempLightVec;ah(c,r,l),c[3]=o,e.uniform4fv(t.uniform("uLightDirection"),c);const u=s.silhouetteRendering.value;u>0&&e.uniform1f(t.uniform("uSilhouettePower"),u)}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginModel(e,t,n,s){const{projectionParameters:r}=n;e.uniformMatrix4fv(t.uniform("uModelViewProjection"),!1,zt($_,r.viewProjectionMat,s)),ch(Jn,s),xx(Jn,Jn,r.displayDimensionRenderInfo.canonicalVoxelFactors),rA(Jn,Jn),sA(Jn,Jn),e.uniformMatrix3fv(t.uniform("uNormalMatrix"),!1,Jn)}drawFragmentHelper(e,t,n,s,r){this.vertexPositionHandler.bind(e,t,n);const{meshData:o}=n;n.normalBuffer.bindToVertexAttrib(t.attribute("aVertexNormal"),2,WebGL2RenderingContext.BYTE,!0),n.indexBuffer.bind();const{indices:l}=o;e.drawElements(o.strips?WebGL2RenderingContext.TRIANGLE_STRIP:WebGL2RenderingContext.TRIANGLES,r-s,l.BYTES_PER_ELEMENT===2?WebGL2RenderingContext.UNSIGNED_SHORT:WebGL2RenderingContext.UNSIGNED_INT,s*l.BYTES_PER_ELEMENT)}drawFragment(e,t,n){const{meshData:s}=n,{indices:r}=s;this.drawFragmentHelper(e,t,n,0,r.length)}drawMultiscaleFragment(e,t,n,s,r){const o=n.meshData.subChunkOffsets[s],l=n.meshData.subChunkOffsets[r];this.drawFragmentHelper(e,t,n,o,l)}endLayer(e,t){this.vertexPositionHandler.endLayer(e,t),e.disableVertexAttribArray(t.attribute("aVertexNormal"))}makeGetter(e){const t=e.registerDisposer(Ht(n=>n>0,[e.displayState.silhouetteRendering]));return Kr(e,e.gl,{memoizeKey:`mesh/MeshShaderManager/${this.fragmentRelativeVertices}/${this.vertexPositionFormat}`,parameters:t,defineShader:(n,s)=>{this.vertexPositionHandler.defineShader(n),n.addAttribute("highp vec2","aVertexNormal"),n.addVarying("highp vec4","vColor"),n.addUniform("highp vec4","uLightDirection"),n.addUniform("highp vec4","uColor"),n.addUniform("highp mat3","uNormalMatrix"),n.addUniform("highp mat4","uModelViewProjection"),n.addUniform("highp uint","uPickID"),s&&n.addUniform("highp float","uSilhouettePower"),this.fragmentRelativeVertices&&(n.addUniform("highp vec3","uFragmentOrigin"),n.addUniform("highp vec3","uFragmentShape")),n.addVertexCode(W_);let r="";this.fragmentRelativeVertices?r+=`
highp vec3 vertexPosition = uFragmentOrigin + uFragmentShape * getVertexPosition();
highp vec3 normalMultiplier = 1.0 / uFragmentShape;
`:r+=`
highp vec3 vertexPosition = getVertexPosition();
highp vec3 normalMultiplier = vec3(1.0, 1.0, 1.0);
`,r+=`
gl_Position = uModelViewProjection * vec4(vertexPosition, 1.0);
vec3 origNormal = decodeNormalOctahedronSnorm8(aVertexNormal);
vec3 normal = normalize(uNormalMatrix * (normalMultiplier * origNormal));
float absCosAngle = abs(dot(normal, uLightDirection.xyz));
float lightingFactor = absCosAngle + uLightDirection.w;
vColor = vec4(lightingFactor * uColor.rgb, uColor.a);
`,s&&(r+=`
vColor *= pow(1.0 - absCosAngle, uSilhouettePower);
`),n.setVertexMain(r),n.setFragmentMain("emit(vColor, uPickID);")}})}}class dw extends co{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new IT(!1,cr.float32),this.getShader=this.meshShaderManager.makeGetter(this),Fv(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));const s=this.backend=this.registerDisposer(new Bh(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=qO,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),s.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const{gl:n,displayState:s,meshShaderManager:r}=this;if(s.objectAlpha.value<=0)return;const o=ql(s.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;const{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),r.beginLayer(n,l,e,this.displayState),r.beginModel(n,l,e,o);const c=this.source.chunks;let u=0,h=0;const{renderScaleHistogram:g}=this.displayState,v=this.source.fragmentSource.chunks;Uv(s,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(y,b,w)=>{const C=$i(y),E=c.get(C);if(++u,E!==void 0){++h,e.emitColor&&r.setColor(n,l,b),e.emitPickID&&r.setPickID(n,l,w),u+=E.fragmentIds.length;for(const k of E.fragmentIds){const{key:D}=this.source.getFragmentKey(C,k),A=v.get(D);A!==void 0&&A.state===je.GPU_MEMORY&&(r.drawFragment(n,l,A),++h)}}}),e.emitColor&&(g.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),g.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,h,u-h)),r.endLayer(n,l)}isReady(){const{displayState:e,source:t}=this;let n=!0;const s=t.fragmentSource.chunks;return Ca(e.segmentationGroupState.value,r=>{const o=$i(r),l=t.chunks.get(o);if(l===void 0){n=!1;return}for(const c of l.fragmentIds){const{key:u}=this.source.getFragmentKey(o,c),h=s.get(u);if(h===void 0||h.state!==je.GPU_MEMORY){n=!1;return}}}),n}}class J_ extends Ts{constructor(e,t){super(e),this.fragmentIds=t.fragmentIds}}class j_ extends Ts{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),LT(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),DT(this)}}class fo extends ri{constructor(){super(...arguments),this.fragmentSource=this.registerDisposer(new Qg(this.chunkManager,this))}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),super.initializeCounterpart(e,t)}getChunk(e){return new J_(this,e)}getFragmentKey(e,t){return{key:`${e}/${t}`,fragmentId:t}}}let Qg=class extends ri{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new j_(this,i)}};Qg=kT([li(XO)],Qg);function uw(i,e,t,n){const s=i.get(rT(e,t,n));return s!==void 0&&s.state===je.GPU_MEMORY}class kp extends co{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.meshShaderManager=new IT(this.source.format.fragmentRelativeVertices,this.source.format.vertexPositionFormat),this.getShader=this.meshShaderManager.makeGetter(this),Fv(n,this),this.registerDisposer(n.silhouetteRendering.changed.add(this.redrawNeeded.dispatch));const s=this.backend=this.registerDisposer(new Bh(e,n,this.layerChunkProgressInfo));s.RPC_TYPE_ID=KO,s.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()}),s.visibility.add(this.visibility),this.registerDisposer(n.renderScaleHistogram.visibility.add(this.visibility))}get isTransparent(){const{displayState:e}=this;return e.objectAlpha.value<1||e.silhouetteRendering.value>0}get transparentPickEnabled(){return this.displayState.transparentPickEnabled.value}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const{gl:n,displayState:s,meshShaderManager:r}=this;if(s.objectAlpha.value<=0)return;const o=ql(s.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(o===void 0)return;const{shader:l}=this.getShader(e.emitter);if(l===null)return;l.bind(),r.beginLayer(n,l,e,this.displayState);const{renderScaleHistogram:c}=this.displayState;e.emitColor&&c.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),ch(Jn,o),xx(Jn,Jn,e.projectionParameters.displayDimensionRenderInfo.voxelPhysicalScales);const u=Math.abs(zm(Jn))**(1/3),{chunks:h}=this.source,g=this.source.fragmentSource.chunks,{projectionParameters:v}=e,y=zt(Ve(),v.viewProjectionMat,o),b=lu(new Float32Array(24),y),w=this.displayState.renderScaleTarget.value,{fragmentRelativeVertices:C}=this.source.format;r.beginModel(n,l,e,o);let E=0,k=0;Uv(s,this,e.emitColor,e.emitPickID?e.pickIDs:void 0,(D,A,N)=>{const I=$i(D),P=h.get(I);if(++E,P===void 0)return;++k;const{manifest:O}=P,{octree:_,chunkShape:W,chunkGridSpatialOrigin:U,vertexOffsets:j}=O;e.emitColor&&r.setColor(n,l,A),e.emitPickID&&r.setPickID(n,l,N),Yb(O,y,b,w,v.width,v.height,(B,H,V)=>{const re=uw(g,I,B,H);return e.emitColor&&c.add(O.lodScales[B]*u,V,re?1:0,re?0:1),re},(B,H,V,re)=>{const se=rT(I,B,H),ve=g.get(se),me=_[5*H],Ie=_[5*H+1],We=_[5*H+2],tt=1<<B;C&&(n.uniform3f(l.uniform("uFragmentOrigin"),U[0]+me*W[0]*tt+j[B*3+0],U[1]+Ie*W[1]*tt+j[B*3+1],U[2]+We*W[2]*tt+j[B*3+2]),n.uniform3f(l.uniform("uFragmentShape"),W[0]*tt,W[1]*tt,W[2]*tt)),r.drawMultiscaleFragment(n,l,ve,V,re)})}),c.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,k,E-k),r.endLayer(n,l)}isReady(e,t){const{displayState:n}=this;if(n.objectAlpha.value<=0)return!0;const s=ql(n.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(s===void 0)return!1;const{chunks:r}=this.source,o=this.source.fragmentSource.chunks,{projectionParameters:l}=e,c=zt(Ve(),l.viewProjectionMat,s),u=lu(new Float32Array(24),c),h=this.displayState.renderScaleTarget.value;let g=!0;return Ca(n.segmentationGroupState.value,v=>{if(!g)return;const y=$i(v),b=r.get(y);if(b===void 0){g=!1;return}const{manifest:w}=b;Yb(w,c,u,h,l.width,l.height,(C,E)=>(g=g&&uw(o,y,C,E),g),()=>{})}),g}getObjectPosition(e){const t=this.displayState.transform.value;if(t.error!==void 0)return;const n=this.source.chunks.get($i(e));if(n===void 0)return;const{manifest:s}=n,{clipLowerBound:r,clipUpperBound:o}=s,{rank:l}=t,c=new Float32Array(l);for(let h=0;h<3;++h)c[h]=(r[h]+o[h])/2;const u=new Float32Array(l);return ps(u,t.modelToRenderLayerTransform,l+1,c,l),u}}class Y_ extends Ts{constructor(e,t){super(e),this.manifest=t.manifest}}class q_ extends Ts{constructor(e,t){super(e),this.meshData=t}copyToGPU(e){super.copyToGPU(e),LT(e,this)}freeGPUMemory(e){super.freeGPUMemory(e),DT(this)}}class Fh extends ri{constructor(e,t){super(e,t),this.fragmentSource=this.registerDisposer(new Zg(this.chunkManager,this)),this.format=t.format}static encodeOptions(e){return{format:e.format,...ri.encodeOptions(e)}}initializeCounterpart(e,t){this.fragmentSource.initializeCounterpart(this.chunkManager.rpc,{}),t.fragmentSource=this.fragmentSource.addCounterpartRef(),t.format=this.format,super.initializeCounterpart(e,t)}getChunk(e){return new Y_(this,e)}}let Zg=class extends ri{constructor(i,e){super(i),this.meshSource=e}get key(){return this.meshSource.key}getChunk(i){return new q_(this,i)}};Zg=kT([li(QO)],Zg);function hw(i,e){return e=Math.imul(e,3432918353)>>>0,e=(e<<15|e>>>17)>>>0,e=Math.imul(e,461845907)>>>0,i^=e,i=(i<<13|i>>>19)>>>0,i=Math.imul(i,5)+3864292196>>>0,i}function K_(i,e){return i^=e,i^=i>>>16,i=Math.imul(i,2246822507)>>>0,i^=i>>>13,i*=3266489909,i^=i>>>16,i>>>0}function PT(i,e,t){let n=i;return n=hw(n,e),n=hw(n,t),K_(n,8)}class X_ extends ri{constructor(e,t){super(e,t),this.properties=t.properties}static encodeOptions(e){return{properties:e.properties}}}function Q_(i,e,t){const n=i.length-1;for(;;){if(e=e&n,i[e]===0){i[e]=t;return}++e}}function Mu(i,e){return e<=255?new Uint8Array(i):e<=65535?new Uint16Array(i):new Uint32Array(i)}function Z_(i){const e=i.length/2,n=2**(Math.ceil(Math.log2(e))+1),s=Mu(n,e+1);for(let r=0;r<e;++r){const o=i[2*r],l=i[2*r+1];Q_(s,PT(0,o,l),r+1)}return s}function eV(i,e,t,n){let s=PT(0,t,n);const r=i.length-1;for(;;){s=s&r;let o=i[s];if(o===0)return-1;if(--o,e[2*o]===t&&e[2*o+1]===n)return o;++s}}class AT{constructor(e){this.inlineProperties=e.inlineProperties}}class tV{constructor(e){this.segmentPropertyMap=e;const{inlineProperties:t}=e;t!==void 0&&(this.inlineIdToIndex=Z_(t.ids)),this.tags=t==null?void 0:t.properties.find(n=>n.type==="tags"),this.labels=t==null?void 0:t.properties.find(n=>n.type==="label"),this.numericalProperties=(t==null?void 0:t.properties.filter(n=>n.type==="number"))??[]}getSegmentInlineIndex(e){const{inlineIdToIndex:t}=this;return t===void 0?-1:eV(t,this.segmentPropertyMap.inlineProperties.ids,e.low,e.high)}getSegmentLabel(e){const t=this.getSegmentInlineIndex(e);if(t===-1)return;const{labels:n,tags:s}=this;let r="";if(n!==void 0&&(r=n.values[t]),s!==void 0){const{tags:o,values:l}=s,c=l[t];for(let u=0,h=c.length;u<h;++u){const g=o[c.charCodeAt(u)];r.length>0&&(r+=" "),r+="#",r+=g}}if(r.length!==0)return r}}function RT(i,e,t){for(let n=0,s=t.length;n<s;++n)e[t[n]]=i[n]}function nV(i){const e=i.length;if(e===0)return!0;let t=i[0],n=i[1];for(let s=0;s<e;s+=2){const r=i[s],o=i[s+1];if((o-n||r-t)<=0)return!1;t=r,n=o}return!0}function iV(i){const{ids:e}=i;if(nV(e))return i;const t=e.length/2,n=Mu(t,t-1);for(let o=0;o<t;++o)n[o]=o;n.sort((o,l)=>{const c=e[o*2],u=e[o*2+1],h=e[l*2],g=e[l*2+1];return u-g||c-h});const s=new Uint32Array(t*2);for(let o=0;o<t;++o){const l=n[o];s[o*2]=e[l*2],s[o*2+1]=e[l*2+1]}const r=i.properties.map(o=>{const{values:l}=o,c=new l.constructor(t);for(let u=0;u<t;++u)c[u]=l[n[u]];return{...o,values:c}});return{ids:s,properties:r}}function sV(i,e,t){const n=new Array(e);return n.fill(""),RT(i.values,n,t),{...i,values:n}}function rV(i,e,t){const n=new Float32Array(e);return n.fill(Number.NaN),RT(i.values,n,t),{...i,values:n}}function fw(i,e,t){const{type:n}=i;return n==="label"||n==="description"||n==="string"||n==="tags"?sV(i,e,t):rV(i,e,t)}function oV(i,e){if(i===void 0)return e;if(e===void 0)return i;let t=0;const n=i.ids.length/2,s=e.ids.length/2,r=new Uint32Array(n),o=new Uint32Array(s),l=i.ids,c=e.ids;IP(n,s,(g,v)=>{const y=l[2*g+1],b=l[2*g],w=c[2*v+1],C=c[2*v];return y-w||b-C},g=>{r[g]=t,++t},g=>{o[g]=t,++t},(g,v)=>{r[g]=t,o[v]=t,++t});let u;if(t===n)u=l;else if(t===s)u=c;else{u=new Uint32Array(t*2);for(let g=0;g<n;++g){const v=r[g];u[2*v]=l[2*g],u[2*v+1]=l[2*g+1]}for(let g=0;g<s;++g){const v=o[g];u[2*v]=c[2*g],u[2*v+1]=c[2*g+1]}}const h=[];if(t===n)h.push(...i.properties);else for(const g of i.properties)h.push(fw(g,t,r));if(t===s)h.push(...e.properties);else for(const g of e.properties)h.push(fw(g,t,o));return{ids:u,properties:h}}function aV(i,e){return new AT({inlineProperties:oV(i.inlineProperties,e.inlineProperties)})}function lV(i){for(;;){if(i.length===0)return;if(i.length===1)return i[0];const e=[];for(let t=0,n=i.length;t<n;t+=2)t+1===n?e.push(i[t]):e.push(aV(i[t],i[t+1]));i=e}}function cV(i,e){return i.memoize.getUncounted({id:"getPreprocessedSegmentPropertyMap",maps:e.map(t=>jt(t))},()=>{const t=lV(e);if(t!==void 0)return new tV(t)})}const dV=/^[,\s]*[0-9]+(?:[,\s]+[0-9]+)*[,\s]*$/;function uV(i,e){var h;if(e.match(dV)!==null){const g=e.split(/[\s,]+/),v=[],y=new Set;for(let b=0,w=g.length;b<w;++b){const C=g[b];if(C==="")continue;const E=new X;if(!E.tryParseString(C))continue;const k=E.toString();y.has(k)||(y.add(k),v.push(E))}return v.sort(X.compare),{ids:v}}const t={regexp:void 0,prefix:void 0,includeTags:[],excludeTags:[],numericalConstraints:[],sortBy:[],includeColumns:[]},n=(h=i==null?void 0:i.segmentPropertyMap.inlineProperties)==null?void 0:h.properties,s=i==null?void 0:i.tags,r=(s==null?void 0:s.tags)||[],o=r.map(g=>g.toLowerCase()),l=i==null?void 0:i.labels,c=[];let u;for(let g=0;g<e.length;g=u){let v=e.indexOf(" ",g);v===-1?u=v=e.length:u=v+1;const y=e.substring(g,v);if(y.length===0)continue;const b=(C,E)=>{const k=C.toLowerCase(),D=o.indexOf(k);if(D===-1){c.push({begin:E,end:v,message:`Invalid tag: ${C}`});return}if(C=r[D],t.includeTags.includes(C)||t.excludeTags.includes(C)){c.push({begin:E,end:v,message:`Duplicate tag: ${C}`});return}return C};if(y.startsWith("#")){const C=b(y.substring(1),g+1);C!==void 0&&t.includeTags.push(C);continue}if(y.startsWith("-#")){const C=b(y.substring(2),g+2);C!==void 0&&t.excludeTags.push(C);continue}if(y.startsWith("<")||y.startsWith(">")){let C=y.substring(1).toLowerCase();if(C!=="id"&&C!=="label"){const E=n==null?void 0:n.find(k=>k.id.toLowerCase()===C&&(k.type==="number"||k.type==="label"||k.type==="string"));if(E===void 0){c.push({begin:g+1,end:v,message:`Invalid field: ${C}`});continue}C=E.id}if(t.sortBy.find(E=>E.fieldId===C)!==void 0){c.push({begin:g+1,end:v,message:`Duplicate sort field: ${C}`});continue}t.sortBy.push({order:y[0],fieldId:C});continue}if(y.startsWith("|")){let C=y.substring(1).toLowerCase();if(C==="id"||C==="label")continue;const E=n==null?void 0:n.find(k=>k.id.toLowerCase()===C&&(k.type==="number"||k.type==="string"));if(E===void 0){c.push({begin:g+1,end:v,message:`Invalid field: ${C}`});continue}if(C=E.id,t.sortBy.find(k=>k.fieldId===C)||t.includeColumns.find(k=>k===C))continue;t.includeColumns.push(C);continue}if(y.startsWith("/")){if(t.regexp!==void 0){c.push({begin:g,end:v,message:"Only one regular expression allowed"});continue}if(t.prefix!==void 0){c.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:g,end:v,message:"No label property"});continue}try{t.regexp=new RegExp(y.substring(1))}catch{c.push({begin:g,end:v,message:"Invalid regular expression syntax"})}continue}const w=y.match(/^([a-zA-Z][a-zA-Z0-9_]*)(<|<=|=|>=|>)([0-9.].*)$/);if(w!==null){let C=w[1].toLowerCase();const E=w[2],k=i==null?void 0:i.numericalProperties.find(_=>_.id.toLowerCase()===C);if(k===void 0){c.push({begin:g,end:g+C.length,message:`Invalid numerical field: ${C}`});continue}C=k.id;let D;try{D=Ic(k.dataType,w[3])}catch(_){c.push({begin:g+w[1].length+w[2].length,end:v,message:_.message});continue}let A=t.numericalConstraints.find(_=>_.fieldId===C);A===void 0&&(A={fieldId:C,bounds:k.bounds},t.numericalConstraints.push(A));const N=jr(k.bounds,A.bounds[0]),I=jr(k.bounds,A.bounds[1]);let P=I,O=N;switch(E){case"<":P=fu(k.dataType,D,-1);break;case"<=":P=D;break;case"=":P=O=D;break;case">=":O=D;break;case">":O=fu(k.dataType,D,1);break}if(O=ii(N,O)>0?N:O,P=ii(I,P)<0?I:P,ii(O,P)>0){c.push({begin:g,end:v,message:"Constraint would not match any values"});continue}A.bounds=[O,P];continue}if(t.regexp!==void 0){c.push({begin:g,end:v,message:"Prefix cannot be combined with regular expression"});continue}if(l===void 0){c.push({begin:g,end:v,message:"No label property"});continue}t.prefix!==void 0?t.prefix+=` ${y}`:t.prefix=y}return c.length>0?{errors:c}:(t.sortBy.length===0&&t.sortBy.push({fieldId:NT(i),order:"<"}),t)}function Lp(i){return"\\u"+i.toString(16).padStart(4,"0")}function hV(i,e){var E;if(e.errors!==void 0)return{query:e,total:-1,count:0,errors:e.errors};if(e.ids!==void 0){const{ids:k}=e;return{query:e,total:-1,explicitIds:k,count:k.length}}const t=(E=i==null?void 0:i.segmentPropertyMap)==null?void 0:E.inlineProperties;if(t===void 0)return{query:e,count:0,total:-1};const n=t==null?void 0:t.properties,s=t.ids.length/2;let r=Mu(s,s);for(let k=0;k<s;++k)r[k]=k;const o=k=>{const D=r.length;let A=0;for(let N=0;N<D;++N){const I=r[N];k(I)&&(r[A]=I,++A)}r=r.subarray(0,A)};if(e.regexp!==void 0||e.prefix!==void 0){const k=i.labels.values,{regexp:D,prefix:A}=e;D!==void 0&&o(N=>k[N].match(D)!==null),A!==void 0&&o(N=>k[N].startsWith(A))}const{includeTags:l,excludeTags:c}=e,u=i.tags;if(l.length>0||c.length>0){const{values:k,tags:D}=u,A=[];for(const _ of l)A.push([D.indexOf(_),1]);for(const _ of c)A.push([D.indexOf(_),0]);A.sort((_,W)=>_[0]-W[0]);let N="^",I=0;const P=_=>{_<I||(N+=`[${Lp(I)}-${Lp(_)}]*`)};for(const[_,W]of A)P(_-1),W&&(N+=Lp(_)),I=_+1;P(65535),N+="$";const O=new RegExp(N);o(_=>k[_].match(O)!==null)}let h,g;const{numericalConstraints:v}=e;if(v.length>0){const k=i.numericalProperties,D=v.length,A=2**D-1;h=Mu(r.length,A);for(let P=0;P<D;++P){const O=v[P],_=k.find(H=>H.id===O.fieldId),{values:W}=_,U=2**P,[j,B]=O.bounds;for(let H=0,V=r.length;H<V;++H){const re=W[r[H]];h[H]|=U*(re>=j&&re<=B)}}g=r,r=g.slice();const N=r.length;let I=0;for(let P=0;P<N;++P)h[P]===A&&(r[I]=r[P],++I);r=r.subarray(0,I)}let y=[];if(u!==void 0){const k=[],{tags:D,values:A}=u,N=new Uint32Array(D.length);for(let I=0,P=r.length;I<P;++I){const O=A[r[I]];for(let _=0,W=O.length;_<W;++_)++N[O.charCodeAt(_)]}for(let I=0,P=D.length;I<P;++I){const O=N[I],_=D[I],W={tag:_,tagIndex:I,count:N[I]};e.includeTags.includes(_)||e.excludeTags.includes(_)?k.push(W):O>0&&y.push(W)}k.push(...y),y=k}const b=(k,D)=>{if(k.type!=="number"){const{values:A}=k;r.sort((N,I)=>Fc(A[N],A[I])*D)}else{const A=k.values;r.sort((N,I)=>(A[N]-A[I])*D)}},w=k=>{u!==void 0&&b(u,k);const D=i==null?void 0:i.labels;D!==void 0&&b(D,k)},{sortBy:C}=e;for(let k=C.length-1;k>=0;--k){const{fieldId:D,order:A}=C[k],N=A==="<"?1:-1;if(D==="id"){if(k+1===C.length){if(A==="<")continue;r.reverse();continue}r.sort((I,P)=>N*(I-P))}else D==="label"?w(N):b(n.find(I=>I.id===D),N)}return{query:e,intermediateIndices:g,intermediateIndicesMask:h,indices:r,tags:y,count:r.length,total:s}}function fV(i,e,t){const{values:s}=e,[r,o]=t,l=o<=r?0:256/(o-r),c=new Uint32Array(258),{numericalConstraints:u}=i.query,h=u.findIndex(g=>g.fieldId===e.id);if(h===-1){const g=i.indices;for(let v=0,y=g.length;v<y;++v){const b=s[g[v]];Number.isNaN(b)||++c[Math.min(255,Math.max(-1,(b-r)*l))+1>>>0]}}else{const g=i.intermediateIndices,v=i.intermediateIndicesMask,y=2**u.length-1-2**h;for(let b=0,w=g.length;b<w;++b)if((v[b]&y)===y){const E=s[g[b]];Number.isNaN(E)||++c[Math.min(255,Math.max(-1,(E-r)*l))+1>>>0]}}return{queryResult:i,histogram:c,window:t}}function pV(i,e,t,n){if(i===void 0){t.length=0,n.length=0;return}const{numericalProperties:s}=i,r=s.length;if((e==null?void 0:e.indices)===void 0){t.length=0;return}for(let l=0;l<r;++l){const c=t[l],u=n[l],h=s[l];c!==void 0&&c.queryResult===e&&us(h.dataType,c.window,u)||(t[l]=fV(e,h,u))}}function NT(i){return i!=null&&i.tags||i!=null&&i.labels?"label":"id"}function gV(i,e){const{ids:t}=e;if(t!==void 0)return t.map(l=>l.toString()).join(", ");let n="";e=e;const{prefix:s,regexp:r}=e;s!==void 0?n=s:r!==void 0&&(n=`/${r}`);for(const l of e.includeTags)n.length>0&&(n+=" "),n+=`#${l}`;for(const l of e.excludeTags)n.length>0&&(n+=" "),n+=`-#${l}`;for(const l of e.numericalConstraints){const{fieldId:c,bounds:u}=l,[h,g]=u,v=i.numericalProperties.find(y=>y.id===c);if(!us(v.dataType,v.bounds,u)){if(ii(h,g)===0){n.length>0&&(n+=" "),n+=`${c}=${h}`;continue}if(ii(h,v.bounds[0])>0){n.length>0&&(n+=" ");const y=fu(v.dataType,h,-1),b=h.toString(),w=y.toString();v.dataType!==J.FLOAT32||b.length<=w.length?n+=`${c}>=${b}`:n+=`${c}>${w}`}if(ii(g,v.bounds[1])<0){n.length>0&&(n+=" ");const y=fu(v.dataType,g,1),b=g.toString(),w=y.toString();v.dataType!==J.FLOAT32||b.length<=w.length?n+=`${c}<=${b}`:n+=`${c}<${w}`}}}let{sortBy:o}=e;if(o.length===1){const l=o[0];l.order==="<"&&l.fieldId===NT(i)&&(o=[])}for(const l of o)n.length>0&&(n+=" "),n+=`${l.order}${l.fieldId}`;for(const l of e.includeColumns)n.length>0&&(n+=" "),n+=`|${l}`;return n}const oa=new X;function mV(i,e,t){if(e===void 0)return;const{explicitIds:n}=e;if(n!==void 0){n.forEach(t);return}const{indices:s}=e;if(s!==void 0){const{ids:r}=i.segmentPropertyMap.inlineProperties;for(let o=0,l=s.length;o<l;++o){const c=s[o];oa.low=r[c*2],oa.high=r[c*2+1],t(oa,o)}}}function*vV(i,e,t=!1){if(e===void 0)return;const{explicitIds:n}=e;if(n!==void 0)for(const r of n)yield r;const{indices:s}=e;if(s!==void 0){const{ids:r}=i.segmentPropertyMap.inlineProperties;for(let o=0,l=s.length;o<l;++o){const c=s[o];t?yield new X(r[c*2],r[c*2+1]):(oa.low=r[c*2],oa.high=r[c*2+1],yield oa)}}}function pw(i,e,t){if(t.size===0)return 0;let n=0;return mV(i,e,s=>{t.has(s)&&++n}),n}function gw(i,e,t,n){const s=i.includeTags.filter(o=>o!==e),r=i.excludeTags.filter(o=>o!==e);return n===!0&&(t?s:r).push(e),{...i,includeTags:s,excludeTags:r}}function yV(i){return i.ids!==void 0?!1:i.errors!==void 0?!0:!(i.numericalConstraints.length>0||i.includeTags.length>0||i.excludeTags.length>0||i.prefix||i.regexp)}function Uh(i,e){if(i===void 0||i.ids!==void 0||i.errors!==void 0)return!1;const{sortBy:t,includeColumns:n}=i;return t.find(s=>s.fieldId===e)!==void 0||n.includes(e)}class SV extends ci{constructor(e){super(),this.layer=e;const{element:t}=this;t.appendChild(this.registerDisposer(new Vn(e.displayState.segmentationGroupState.value.graph,(n,s,r)=>{n!=null&&n.tabContents&&s.appendChild(n.tabContents(e,r,this))})).element)}}class zv{}class Gv extends K{constructor(e,t){super(),this.graph=e,this.segmentsState=t}createRenderLayers(e,t,n){return[]}}const Xd=Symbol("disjoint_sets:rank"),fs=Symbol("disjoint_sets:parent"),Ou=Symbol("disjoint_sets:next"),Nl=Symbol("disjoint_sets:prev");function Dp(i){let e=i,t=i[fs];for(;t!==i;)i=t,t=i[fs];for(i=e[fs];t!==i;)e[fs]=t,e=i,i=e[fs];return t}function bV(i,e){const t=i[Xd],n=e[Xd];return t>n?(e[fs]=i,i):(i[fs]=e,t===n&&(e[Xd]=n+1),e)}function wV(i,e){const t=i[Nl],n=e[Nl];e[Nl]=t,t[Ou]=e,i[Nl]=n,n[Ou]=i}function*mw(i){let e=i;do yield e,e=e[Ou];while(e!==i)}function CV(i){i[fs]=i,i[Xd]=0,i[Ou]=i[Nl]=i}const Yo=Symbol("disjoint_sets:min");function vw(i){return i[fs]===i}class $v{constructor(){this.map=new Map,this.visibleSegmentEquivalencePolicy=new Ne(An.MIN_REPRESENTATIVE),this.generation=0}has(e){const t=e.toString();return this.map.get(t)!==void 0}get(e){const t=e.toString(),n=this.map.get(t);return n===void 0?e:Dp(n)[Yo]}isMinElement(e){const t=this.get(e);return t===e||X.equal(t,e)}makeSet(e){const t=e.toString(),{map:n}=this;let s=n.get(t);return s===void 0?(s=e.clone(),CV(s),s[Yo]=s,n.set(t,s),s):Dp(s)}link(e,t){if(e=this.makeSet(e),t=this.makeSet(t),e===t)return!1;this.generation++;const n=bV(e,t);wV(e,t);const s=e[Yo],r=t[Yo],o=(this.visibleSegmentEquivalencePolicy.value&An.MAX_REPRESENTATIVE)!==0;return n[Yo]=X.less(s,r)===o?r:s,!0}linkAll(e){for(let t=1,n=e.length;t<n;++t)this.link(e[0],e[t])}deleteSet(e){const{map:t}=this;let n=!1;for(const s of this.setElements(e))t.delete(s.toString()),n=!0;return n&&++this.generation,n}*setElements(e){const t=e.toString(),n=this.map.get(t);n===void 0?yield e:yield*mw(n)}clear(){const{map:e}=this;return e.size===0?!1:(++this.generation,e.clear(),!0)}get size(){return this.map.size}*mappings(e=new Array(2)){for(const t of this.map.values())e[0]=t,e[1]=Dp(t)[Yo],yield e}*roots(){for(const e of this.map.values())vw(e)&&(yield e)}[Symbol.iterator](){return this.mappings()}toJSON(){const e=new Array;for(const t of this.map.values())if(vw(t)){const n=new Array;for(const s of mw(t))n.push(s);n.sort(X.compare),e.push(n)}return e.sort((t,n)=>X.compare(t[0],n[0])),e.map(t=>t.map(n=>n.toString()))}}var xV=Object.defineProperty,EV=Object.getOwnPropertyDescriptor,TV=(i,e,t,n)=>{for(var s=n>1?void 0:n?EV(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&xV(e,t,s),s};const kV="DisjointUint64Sets",MT="DisjointUint64Sets.add",OT="DisjointUint64Sets.clear",_T="DisjointUint64Sets.highBitRepresentativeChanged",VT="DisjointUint64Sets.deleteSet";let to=class extends ph{constructor(){super(...arguments),this.disjointSets=new $v,this.changed=new ue}get value(){return this}static makeWithCounterpart(i,e){const t=new to;return t.disjointSets.visibleSegmentEquivalencePolicy=e,t.registerDisposer(e.changed.add(()=>{yw(t)})),t.initializeCounterpart(i),e.value&&yw(t),t}disposed(){this.disjointSets=void 0,this.changed=void 0,super.disposed()}link(i,e){if(this.disjointSets.link(i,e)){const{rpc:t}=this;return t&&t.invoke(MT,{id:this.rpcId,al:i.low,ah:i.high,bl:e.low,bh:e.high}),this.changed.dispatch(),!0}return!1}linkAll(i){for(let e=1,t=i.length;e<t;++e)this.link(i[0],i[e])}has(i){return this.disjointSets.has(i)}get(i){return this.disjointSets.get(i)}clear(){if(this.disjointSets.clear()){const{rpc:i}=this;i&&i.invoke(OT,{id:this.rpcId}),this.changed.dispatch()}}setElements(i){return this.disjointSets.setElements(i)}deleteSet(i){if(this.disjointSets.deleteSet(i)){const{rpc:e}=this;e&&e.invoke(VT,{id:this.rpcId,l:i.low,h:i.high}),this.changed.dispatch()}}get size(){return this.disjointSets.size}toJSON(){return this.disjointSets.toJSON()}restoreState(i){if(i!==void 0){const e=[new X,new X];Ee(i,t=>{Ee(t,(n,s)=>{e[s%2].parseString(String(n),10),s!==0&&this.link(e[0],e[1])})})}}assignFrom(i){this.clear(),i instanceof to&&(i=i.disjointSets);for(const[e,t]of i)this.link(e,t)}};to=TV([gh(kV)],to);const aa=new X,Ip=new X;Rt(MT,function(i){const e=this.get(i.id);aa.low=i.al,aa.high=i.ah,Ip.low=i.bl,Ip.high=i.bh,e.disjointSets.link(aa,Ip)&&e.changed.dispatch()});Rt(OT,function(i){const e=this.get(i.id);e.disjointSets.clear()&&e.changed.dispatch()});function yw(i){i.rpc.invoke(_T,{id:i.rpcId,value:i.disjointSets.visibleSegmentEquivalencePolicy.value})}Rt(_T,function(i){const e=this.get(i.id);e.disjointSets.visibleSegmentEquivalencePolicy.value=i.value});Rt(VT,function(i){const e=this.get(i.id);aa.low=i.l,aa.high=i.h,e.disjointSets.deleteSet(aa)&&e.changed.dispatch()});class LV extends zv{constructor(){super(...arguments),this.spanningTreeEdges=new Map,this.equivalences=new to,this.connections=new Set,this.changed=new Ze}link(e,t){this.equivalences.link(e,t);for(const n of this.connections)n.segmentsState.segmentEquivalences.link(e,t)}linkAll(e){this.equivalences.linkAll(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.linkAll(e)}deleteSet(e){this.equivalences.deleteSet(e);for(const t of this.connections)t.segmentsState.segmentEquivalences.deleteSet(e)}normalizeAll(){for(const e of this.connections)Pp(e.segmentsState.visibleSegments,e.segmentsState.segmentEquivalences.disjointSets)}addSpanningTreeEdge(e,t){const n=e.toString(),s=t.toString(),{spanningTreeEdges:r}=this;let o=r.get(n);o===void 0&&(o=new Set,r.set(n,o));let l=r.get(s);l===void 0&&(l=new Set,r.set(s,l)),o.add(s),l.add(n)}removeSpanningTreeEdge(e,t){const n=e.toString(),s=t.toString(),{spanningTreeEdges:r}=this,o=r.get(n),l=r.get(s);o.delete(s),o.size===0&&r.delete(n),l.delete(n),l.size===0&&r.delete(s)}*getSpanningTreeNeighbors(e){const t=new X,n=this.spanningTreeEdges.get(e.toString());if(n!==void 0)for(const s of n)t.parseString(s),yield t}restoreState(e){const{equivalences:t,spanningTreeEdges:n}=this;if(t.clear(),n.clear(),e===void 0)return;const s=[new X,new X];Ee(e,r=>{Ee(r,(o,l)=>{s[l%2].parseString(String(o),10),l!==0&&t.link(s[0],s[1])&&this.addSpanningTreeEdge(s[0],s[1])})})}toJSON(){const{spanningTreeEdges:e}=this;if(e.size===0)return;const t=new Array;for(const[n,s]of e){const r=X.parseString(n);for(const o of s){const l=X.parseString(o);X.compare(r,l)>0||t.push([r,l])}}return t.sort((n,s)=>X.compare(n[0],s[0])||X.compare(n[1],s[1])),t.map(n=>n.map(s=>s.toString()))}get visibleSegmentEquivalencePolicy(){return An.MIN_REPRESENTATIVE}async merge(e,t){const{equivalences:n}=this;return X.equal(n.get(e),n.get(t))?e:(this.addSpanningTreeEdge(e,t),this.link(e,t),this.normalizeAll(),this.changed.dispatch(),n.get(e))}async split(e,t){const n=this.computeSplit(e,t);if(n===void 0)throw new Error("Segments are already split");const{includeBaseSegments:s,includeRepresentative:r,excludeBaseSegments:o,excludeRepresentative:l}=n,{equivalences:c}=this;this.deleteSet(e),this.linkAll(s),this.linkAll(o);const u=(v,y)=>{for(const b of v)for(const w of this.getSpanningTreeNeighbors(b))X.equal(c.get(w),y)||this.removeSpanningTreeEdge(b,w)},h=c.get(e),g=c.get(t);u(s,h),u(o,g);for(const v of this.connections){const{selectedSegments:y,visibleSegments:b}=v.segmentsState;y.has(l)&&(y.delete(l),y.add(r),b.add(r))}return this.normalizeAll(),this.changed.dispatch(),{include:h,exclude:g}}trackSegment(e,t){return()=>{}}computeSplit(e,t){const{equivalences:n}=this,s=n.get(e);if(!X.equal(s,n.get(t)))return;const r=new $v;for(const g of n.setElements(s))if(!X.equal(g,t))for(const v of this.getSpanningTreeNeighbors(g))X.equal(v,t)||r.link(g,v);const o=[],l=[],c=r.get(e);let u=e,h=t;for(const g of n.setElements(s))X.equal(r.get(g),c)?(o.push(g),X.compare(g,u)<0&&(u=g)):(l.push(g),X.compare(g,h)<0&&(h=g));return o.sort(X.compare),l.sort(X.compare),{includeBaseSegments:o,includeRepresentative:u,excludeBaseSegments:l,excludeRepresentative:h}}connect(e){const t=e.displayState.segmentationGroupState.value,n=new DV(this,t);return t.segmentEquivalences.assignFrom(this.equivalences),Pp(t.visibleSegments,t.segmentEquivalences.disjointSets),n.registerDisposer(t.visibleSegments.changed.add(n.registerCancellable(ze(()=>Pp(t.visibleSegments,t.segmentEquivalences.disjointSets),0)))),this.connections.add(n),n.registerDisposer(()=>{this.connections.delete(n)}),n}}function Pp(i,e){const t=[];for(const n of i.unsafeKeys()){const s=e.get(n);X.equal(n,s)||(t.push(s),i.delete(n))}for(const n of t)i.add(n)}class DV extends Gv{computeSplit(e,t){return this.graph.computeSplit(e,t)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const IV="skeleton/SkeletonLayer";/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wv=6,Hv=`
vec2 getQuadVertexPosition(vec2 lower, vec2 upper) {
  const vec2 coeffs[] = vec2[](
    vec2(0.0, 0.0),
    vec2(0.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 1.0),
    vec2(1.0, 0.0),
    vec2(0.0, 0.0)
  );
  int v = gl_VertexID % 6;
  return mix(lower, upper, coeffs[v]);
}
`;function Jv(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,Wv*e,t)}const BT=Wv;function zh(i,e){i.addVertexCode(Hv),i.addUniform("highp vec3","uCircleParams"),i.addVarying("highp vec4","vCircleCoord"),i.addVertexCode(`
void emitCircle(vec4 position, float diameter, float borderWidth) {
  gl_Position = position;
  float totalDiameter = diameter + 2.0 * (borderWidth + uCircleParams.z);
  if (diameter == 0.0) totalDiameter = 0.0;
  vec2 circleCornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
  gl_Position.xy += circleCornerOffset * uCircleParams.xy * gl_Position.w * totalDiameter;
  vCircleCoord.xy = circleCornerOffset;
  if (borderWidth == 0.0) {
    vCircleCoord.z = totalDiameter;
    vCircleCoord.w = 1e-6;
  } else {
    vCircleCoord.z = diameter / totalDiameter;
    vCircleCoord.w = uCircleParams.z / totalDiameter;
  }
}
`),e?i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0 - 2.0 * abs(0.5 - gl_FragCoord.z);
}
`):i.addFragmentCode(`
float getCircleAlphaMultiplier() {
  return 1.0;
}
`),i.addFragmentCode(`
vec4 getCircleColor(vec4 interiorColor, vec4 borderColor) {
  float radius = length(vCircleCoord.xy);
  if (radius > 1.0) {
    discard;
  }

  float borderColorFraction = clamp((radius - vCircleCoord.z) / vCircleCoord.w, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vCircleCoord.w, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);

  return vec4(color.rgb, color.a * feather * getCircleAlphaMultiplier());
}
`)}function Gh(i,e,t){const{gl:n}=i;n.uniform3f(i.uniform("uCircleParams"),1/e.width,1/e.height,Math.max(1e-6,t.featherWidthInPixels))}function $h(i,e,t){Jv(i,e,t)}const dr=Wv;function ks(i,e=!1){i.addVertexCode(Hv),i.addUniform("highp vec3","uLineParams"),i.addVarying("highp float","vLineCoord"),i.addVarying("highp float","vLineFeatherFraction"),e&&(i.addVarying("highp float","vEndpointFraction"),i.addVarying("highp float","vLineCoordT"),i.addVarying("highp float","vLineBorderStartFraction")),i.addVertexCode(sM),i.addVertexCode(`
vec2 getLineOffset() { return getQuadVertexPosition(vec2(0.0, -1.0), vec2(1.0, 1.0)); }
float getLineEndpointCoefficient() { return getLineOffset().x; }
uint getLineEndpointIndex() { return uint(getLineEndpointCoefficient()); }
void emitLine(vec4 vertexAClip, vec4 vertexBClip, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  if (!clipLineToDepthRange(vertexAClip, vertexBClip)) {
    gl_Position = vec4(2.0, 2.0, 2.0, 1.0);
    return;
  }
  vec3 vertexADevice = vertexAClip.xyz / vertexAClip.w;
  vec3 vertexBDevice = vertexBClip.xyz / vertexBClip.w;

  vec2 lineDirectionUnnormalized = vertexBDevice.xy - vertexADevice.xy;
  vec2 lineDirection;
  float linePixelLength = length(lineDirectionUnnormalized / uLineParams.xy * 0.5);

  if (linePixelLength < 1e-3) {
    lineDirection = vec2(1.0, 0.0);
    vertexADevice.z = vertexBDevice.z = 0.0;
  } else {
    lineDirection = normalize(lineDirectionUnnormalized);
  }
  vec2 lineNormal = normalize(vec2(lineDirection.y, -lineDirection.x) / uLineParams.yx * uLineParams.xy);

  vec2 lineOffset = getLineOffset();
  gl_Position = vec4(mix(vertexADevice, vertexBDevice, lineOffset.x), 1.0);
  float totalLineWidth = lineWidthInPixels + 2.0 * uLineParams.z ${e?" + 2.0 * borderWidth":""};
  if (lineWidthInPixels == 0.0) totalLineWidth = 0.0;
  vLineFeatherFraction = max(1e-6, uLineParams.z) / totalLineWidth;
  gl_Position.xy += (lineOffset.y * lineNormal
                     ${e?"+ lineDirection * (2.0 * lineOffset.x - 1.0)":""})
                  * totalLineWidth * uLineParams.xy;
  vLineCoord = lineOffset.y;
  ${e?"vEndpointFraction = totalLineWidth / (linePixelLength + totalLineWidth * 2.0);":""}
  ${e?"vLineCoordT = lineOffset.x; vLineBorderStartFraction = lineWidthInPixels / totalLineWidth;":""}
}
void emitLine(mat4 projection, vec3 vertexA, vec3 vertexB, float lineWidthInPixels
              ${e?", float borderWidth":""}) {
  emitLine(projection * vec4(vertexA, 1.0), projection * vec4(vertexB, 1.0),
           lineWidthInPixels
           ${e?", borderWidth":""});
}
`),e&&i.addFragmentCode(`
vec4 getRoundedLineColor(vec4 interiorColor, vec4 borderColor) {
  float radius;
  if (vLineCoordT < vEndpointFraction || vLineCoordT > 1.0 - vEndpointFraction) {
    radius = length(vec2(1.0 - min(vLineCoordT, 1.0 - vLineCoordT) / vEndpointFraction,
                         vLineCoord));
    if (radius > 1.0) {
      discard;
    }
  } else {
    radius = abs(vLineCoord);
  }
  float borderColorFraction = clamp((radius - vLineBorderStartFraction) / vLineFeatherFraction, 0.0, 1.0);
  float feather = clamp((1.0 - radius) / vLineFeatherFraction, 0.0, 1.0);
  vec4 color = mix(interiorColor, borderColor, borderColorFraction);
  return vec4(color.rgb, color.a * feather);
}
`),i.addFragmentCode(`
float getLineAlpha() {
  return clamp((1.0 - abs(vLineCoord)) / vLineFeatherFraction, 0.0, 1.0);
}
`)}function Ls(i,e,t){Jv(i,e,t)}function Ds(i,e,t){const{gl:n}=i;n.uniform3f(i.uniform("uLineParams"),1/e.width,1/e.height,t)}function vr(i){i.addAttribute("int","aDummyVertexId",0),i.addVertexCode(`
int getVertexId () {
  return aDummyVertexId + gl_VertexID;
}
#define gl_VertexID (getVertexId())
`)}class Is extends K{constructor(e){super(),this.buffer=new dn(e),this.size=0}disposed(){this.buffer.dispose()}enable(e=256){const{buffer:t}=this,{gl:n}=t;t.bind(),e>this.size&&(this.size=e,n.bufferData(WebGL2RenderingContext.ARRAY_BUFFER,new Int32Array(e),WebGL2RenderingContext.STATIC_DRAW)),n.vertexAttribIPointer(0,1,WebGL2RenderingContext.INT,0,0),n.vertexAttribDivisor(0,0),n.enableVertexAttribArray(0)}disable(){const{gl:e}=this.buffer;e.disableVertexAttribArray(0)}static get(e){return e.memoize.get("VertexIdHelper",()=>new Is(e))}}const PV=Ve(),FT=`void main() {
  emitDefault();
}
`,Pl=[],AV=uo(new Ua,J.FLOAT32,3);let UT=class extends K{constructor(e,t){super(),this.base=e,this.targetIsSliceView=t,this.textureAccessHelper=new Vh("vertexData"),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl)),this.edgeShaderGetter=Kr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/edge",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(n,s)=>{if(s.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(n),this.defineAttributeAccess(n),ks(n),n.addAttribute("highp uvec2","aVertexIndex"),n.addUniform("highp float","uLineWidth");let r=`
highp vec3 vertexA = readAttribute0(aVertexIndex.x);
highp vec3 vertexB = readAttribute0(aVertexIndex.y);
emitLine(uProjection, vertexA, vertexB, uLineWidth);
highp uint lineEndpointIndex = getLineEndpointIndex();
highp uint vertexIndex = aVertexIndex.x * lineEndpointIndex + aVertexIndex.y * (1u - lineEndpointIndex);
`;n.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGB(vec3 color) {
  emit(vec4(color * uColor.a, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
void emitDefault() {
  emit(vec4(uColor.rgb, uColor.a * getLineAlpha() * ${this.getCrossSectionFadeFactor()}), uPickID);
}
`),n.addFragmentCode(wa);const{vertexAttributes:o}=this,l=o.length;for(let c=1;c<l;++c){const u=o[c];n.addVarying(`highp ${u.glslDataType}`,`vCustom${c}`),r+=`vCustom${c} = readAttribute${c}(vertexIndex);
`,n.addFragmentCode(`#define ${u.name} vCustom${c}
`)}n.setVertexMain(r),ba(s,n),n.setFragmentMainFunction(ma(s.parseResult.code))}}),this.nodeShaderGetter=Kr(this,this.gl,{memoizeKey:{type:"skeleton/SkeletonShaderManager/node",vertexAttributes:this.vertexAttributes},fallbackParameters:this.base.fallbackShaderParameters,parameters:this.base.displayState.skeletonRenderingOptions.shaderControlState.builderState,shaderError:this.base.displayState.shaderError,defineShader:(n,s)=>{if(s.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");this.defineCommonShader(n),this.defineAttributeAccess(n),zh(n,this.targetIsSliceView),n.addUniform("highp float","uNodeDiameter");let r=`
highp uint vertexIndex = uint(gl_InstanceID);
highp vec3 vertexPosition = readAttribute0(vertexIndex);
emitCircle(uProjection * vec4(vertexPosition, 1.0), uNodeDiameter, 0.0);
`;n.addFragmentCode(`
vec4 segmentColor() {
  return uColor;
}
void emitRGBA(vec4 color) {
  vec4 borderColor = color;
  emit(getCircleColor(color, borderColor), uPickID);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitDefault() {
  emitRGBA(uColor);
}
`),n.addFragmentCode(wa);const{vertexAttributes:o}=this,l=o.length;for(let c=1;c<l;++c){const u=o[c];n.addVarying(`highp ${u.glslDataType}`,`vCustom${c}`),r+=`vCustom${c} = readAttribute${c}(vertexIndex);
`,n.addFragmentCode(`#define ${u.name} vCustom${c}
`)}n.setVertexMain(r),ba(s,n),n.setFragmentMainFunction(ma(s.parseResult.code))}})}get vertexAttributes(){return this.base.vertexAttributes}defineCommonShader(e){vr(e),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID")}get gl(){return this.base.gl}defineAttributeAccess(e){const{textureAccessHelper:t}=this;t.defineShader(e);const n=this.vertexAttributes.length;for(let s=Pl.length;s<n;++s)Pl[s]=Symbol(`SkeletonShader.vertexAttributeTextureUnit${s}`);this.vertexAttributes.forEach((s,r)=>{e.addTextureSampler(`${Oh(s.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,Pl[r]),e.addVertexCode(t.getAccessor(`readAttribute${r}`,`uVertexAttributeSampler${r}`,s.dataType,s.numComponents))})}getCrossSectionFadeFactor(){return this.targetIsSliceView?"(clamp(1.0 - 2.0 * abs(0.5 - gl_FragCoord.z), 0.0, 1.0))":"(1.0)"}beginLayer(e,t,n,s){const{viewProjectionMat:r}=n.projectionParameters,o=zt(PV,r,s);e.uniformMatrix4fv(t.uniform("uProjection"),!1,o),this.vertexIdHelper.enable()}setColor(e,t,n){e.uniform4fv(t.uniform("uColor"),n)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}drawSkeleton(e,t,n,s,r){const{vertexAttributes:o}=this,l=o.length,{vertexAttributeTextures:c}=s;for(let u=0;u<l;++u){const h=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Pl[u]);e.activeTexture(h),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c[u])}{t.bind();const u=t.attribute("aVertexIndex");s.indexBuffer.bindToVertexAttribI(u,2,WebGL2RenderingContext.UNSIGNED_INT),e.vertexAttribDivisor(u,1),Ds(t,r,this.targetIsSliceView?1:0),Ls(e,1,s.numIndices/2),e.vertexAttribDivisor(u,0),e.disableVertexAttribArray(u)}n!==null&&(n.bind(),Gh(n,r,{featherWidthInPixels:this.targetIsSliceView?1:0}),$h(n.gl,2,s.numVertices))}endLayer(e,t){const{vertexAttributes:n}=this,s=n.length;for(let r=0;r<s;++r){const o=t.textureUnit(Pl[r])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(o),e.bindTexture(e.TEXTURE_2D,null)}this.vertexIdHelper.disable()}};var zT=(i=>(i[i.LINES=0]="LINES",i[i.LINES_AND_POINTS=1]="LINES_AND_POINTS",i))(zT||{});class Sw extends Uc{constructor(e,t=e){super(zT,e,t)}}class bw extends bt{constructor(e,t=e){super(e,wt,t)}}class RV{constructor(){this.compound=new Ih,this.shader=vh(FT),this.shaderControlState=new Ch(this.shader),this.params2d={mode:new Sw(1),lineWidth:new bw(2)},this.params3d={mode:new Sw(0),lineWidth:new bw(1)};const{compound:e}=this;e.add("shader",this.shader),e.add("shaderControls",this.shaderControlState),e.add("mode2d",this.params2d.mode),e.add("lineWidth2d",this.params2d.lineWidth),e.add("mode3d",this.params3d.mode),e.add("lineWidth3d",this.params3d.lineWidth)}get changed(){return this.compound.changed}reset(){this.compound.reset()}restoreState(e){e!==void 0&&this.compound.restoreState(e)}toJSON(){const e=this.compound.toJSON();for(const t of Object.values(e))if(t!==void 0)return e}}class NV extends K{constructor(e,t,n){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.layerChunkProgressInfo=new fh,this.redrawNeeded=new ue,this.fallbackShaderParameters=new Ne(wh(Mc(FT))),Fv(n,this),this.displayState.shaderError.value=void 0;const{skeletonRenderingOptions:s}=n;this.registerDisposer(s.shader.changed.add(()=>{this.displayState.shaderError.value=void 0,this.redrawNeeded.dispatch()}));const r=this.sharedObject=this.registerDisposer(new Bh(e,n,this.layerChunkProgressInfo));r.RPC_TYPE_ID=IV,r.initializeCounterpartWithChunkManager({source:t.addCounterpartRef()});const o=this.vertexAttributes=[OV];for(const[l,c]of t.vertexAttributes)o.push({name:l,dataType:c.dataType,numComponents:c.numComponents,webglDataType:MV(c.dataType),glslDataType:c.numComponents>1?`vec${c.numComponents}`:"float"})}get visibility(){return this.sharedObject.visibility}get gl(){return this.chunkManager.chunkQueueManager.gl}draw(e,t,n,s,r){const o=s.lineWidth.value,{gl:l,source:c,displayState:u}=this;if(u.objectAlpha.value<=0)return;const h=ql(u.transform.value,e.projectionParameters.displayDimensionRenderInfo,r);if(h===void 0)return;let g;s.mode.value===1?g=Math.max(5,o*2):g=o;const v=n.edgeShaderGetter(e.emitter),y=n.nodeShaderGetter(e.emitter),{shader:b,parameters:w}=v,{shader:C,parameters:E}=y;if(b===null||C===null)return;const{shaderControlState:k}=this.displayState.skeletonRenderingOptions;b.bind(),n.beginLayer(l,b,e,h),Xr(l,b,k,w.parseResult.controls),l.uniform1f(b.uniform("uLineWidth"),o),C.bind(),n.beginLayer(l,C,e,h),l.uniform1f(C.uniform("uNodeDiameter"),g),Xr(l,C,k,E.parseResult.controls);const D=c.chunks;Uv(u,t,e.emitColor,e.emitPickID?e.pickIDs:void 0,(A,N,I)=>{const P=$i(A),O=D.get(P);O===void 0||O.state!==je.GPU_MEMORY||(N!==void 0&&(b.bind(),n.setColor(l,b,N),C.bind(),n.setColor(l,C,N)),I!==void 0&&(b.bind(),n.setPickID(l,b,I),C.bind(),n.setPickID(l,C,I)),n.drawSkeleton(l,b,C,O,e.projectionParameters))}),n.endLayer(l,b)}isReady(){const{source:e,displayState:t}=this;if(t.objectAlpha.value<=0)return!0;const n=e.chunks;let s=!0;return Ca(t.segmentationGroupState.value,r=>{const o=$i(r),l=n.get(o);if(l===void 0||l.state!==je.GPU_MEMORY){s=!1;return}}),s}}class Ap extends co{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new UT(this.base,!1)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params3d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch));const{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}get isTransparent(){return this.base.displayState.objectAlpha.value<1}draw(e,t){!e.emitColor&&e.alreadyEmittedPickID||this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}class ww extends Zr{constructor(e){super(),this.base=e,this.renderHelper=this.registerDisposer(new UT(this.base,!0)),this.renderOptions=this.base.displayState.skeletonRenderingOptions.params2d,this.layerChunkProgressInfo=e.layerChunkProgressInfo,this.registerDisposer(e);const{renderOptions:t}=this;this.registerDisposer(t.mode.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.lineWidth.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.redrawNeeded.add(this.redrawNeeded.dispatch)),this.registerDisposer(e.visibility.add(this.visibility))}get gl(){return this.base.gl}draw(e,t){this.base.draw(e,this,this.renderHelper,this.renderOptions,t)}isReady(){return this.base.isReady()}}function MV(i){switch(i){case J.FLOAT32:return WebGL2RenderingContext.FLOAT;default:throw new Error(`Data type not supported by WebGL: ${J[i]}`)}}const OV={dataType:J.FLOAT32,numComponents:3,name:"",webglDataType:WebGL2RenderingContext.FLOAT,glslDataType:"vec3"};class _V extends Ts{constructor(e,t){super(e),this.vertexAttributes=t.vertexAttributes;const n=this.indices=t.indices;this.numVertices=t.numVertices,this.vertexAttributeOffsets=t.vertexAttributeOffsets,this.numIndices=n.length}copyToGPU(e){super.copyToGPU(e);const{attributeTextureFormats:t}=this.source,{vertexAttributes:n,vertexAttributeOffsets:s}=this,r=this.vertexAttributeTextures=[];for(let o=0,l=s.length;o<l;++o){const c=e.createTexture();e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,c),_h(e,t[o],n.subarray(s[o],o+1!==l?s[o+1]:n.length)),r[o]=c}e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),this.indexBuffer=dn.fromData(e,this.indices,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}freeGPUMemory(e){super.freeGPUMemory(e);const{vertexAttributeTextures:t}=this;for(const n of t)e.deleteTexture(n);t.length=0,this.indexBuffer.dispose()}}const VV=new Map;function BV(i){const e=[AV];for(const t of i.values())e.push(uo(new Ua,t.dataType,t.numComponents));return e}class Wh extends ri{get attributeTextureFormats(){let e=this.attributeTextureFormats_;return e===void 0&&(e=this.attributeTextureFormats_=BV(this.vertexAttributes)),e}getChunk(e){return new _V(this,e)}get vertexAttributes(){return VV}}var At=(i=>(i[i.UNKNOWN=0]="UNKNOWN",i[i.IMAGE=1]="IMAGE",i[i.SEGMENTATION=2]="SEGMENTATION",i))(At||{});function em(i){const{rank:e,dataType:t,fillValue:n=t===J.UINT64?X.ZERO:0,compressedSegmentationBlockSize:s}=i,{baseVoxelOffset:r=new Float32Array(e)}=i;return{...Eh(i),compressedSegmentationBlockSize:s,baseVoxelOffset:r,dataType:t,fillValue:n}}function FV(i){if(i.compressedSegmentationBlockSize!==void 0||i.volumeType!==2&&!i.volumeSourceOptions.discreteValues)return!1;switch(i.dataType){case J.UINT32:case J.UINT64:break;default:return!1}switch(i.rank){case 3:return!0;case 4:{const{chunkDataSize:e}=i;return e[3]===1}default:return!1}}function GT(i){const{rank:e,lowerVoxelBound:t,upperVoxelBound:n}=i;if(!FV(i))return em(i);let{volumeSourceOptions:{displayRank:s,multiscaleToViewTransform:r},chunkToMultiscaleTransform:o,chunkToViewTransform:l}=i;l===void 0&&(l=ro(new Float32Array(e*s),s,r,s,o,e+1,s,e,e));const{maxCompressedSegmentationBlockSize:c,chunkDataSize:u}=i;return em({...i,compressedSegmentationBlockSize:Float32Array.from(Cu({rank:e,chunkToViewTransform:l,displayRank:s,lowerVoxelBound:t,upperVoxelBound:n,maxVoxelsPerChunkLog2:9,maxBlockSize:c===void 0?u:PR(new Uint32Array(e),u,c)}))})}function po(i){const{rank:e}=i,{volumeSourceOptions:{displayRank:t,multiscaleToViewTransform:n,modelChannelDimensionIndices:s},chunkToMultiscaleTransform:r}=i,o=ro(new Float32Array(t*e),t,n,t,r,e+1,t,e,e);let{minBlockSize:l}=i;l===void 0?(l=new Uint32Array(e),l.fill(1)):l=new Uint32Array(l);const{lowerVoxelBound:c,upperVoxelBound:u}=i;if(s.length!==0)for(const g of dh(r,e,s)){let v=u[g];c!==void 0&&(v-=c[g]),l[g]=v}const{chunkDataSizes:h=$M({...i,minBlockSize:l,chunkToViewTransform:o,displayRank:t})}=i;return h.map(g=>GT({...i,chunkDataSize:g,chunkToViewTransform:o}))}function $T(i,e,t,n){const{dataType:s}=e;e.defineShader(i,t);let r="",o="";if(t===0)r+="highp int ignoredChannelIndex";else for(let c=0;c<t;++c)c!==0&&(r+=", "),r+=`highp int channelIndex${c}`,o+=`, channelIndex${c}`;i.addFragmentCode(qN);const l=`
${$t(s)} getDataValue(${r}) {
  highp ivec3 p = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(${n}), uChunkDataSize - 1.0)));
  return getDataValueAt(p${o});
}
${$t(s)} getInterpolatedDataValue(${r}) {
  highp vec3 positionWithinChunk = ${n};
  highp ivec3[2] points;
  points[0] = ivec3(max(vec3(0.0, 0.0, 0.0), min(floor(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  points[1] = ivec3(max(vec3(0.0, 0.0, 0.0), min(ceil(positionWithinChunk - 0.5), uChunkDataSize - 1.0)));
  highp vec3 mixCoeff = fract(positionWithinChunk - 0.5);
  ${$t(s)} xvalues[2];
  for (int ix = 0; ix < 2; ++ix) {
    ${$t(s)} yvalues[2];
    for (int iy = 0; iy < 2; ++iy) {
      ${$t(s)} zvalues[2];
      for (int iz = 0; iz < 2; ++iz) {
        zvalues[iz] = getDataValueAt(ivec3(points[ix].x, points[iy].y, points[iz].z)
                                     ${o});
      }
      yvalues[iy] = mixLinear(zvalues[0], zvalues[1], mixCoeff.z);
    }
    xvalues[ix] = mixLinear(yvalues[0], yvalues[1], mixCoeff.y);
  }
  return mixLinear(xvalues[0], xvalues[1], mixCoeff.x);
}
`;i.addFragmentCode(l),t<=1&&i.addFragmentCode(`
${$t(s)} getDataValue() { return getDataValue(0); }
${$t(s)} getInterpolatedDataValue() { return getInterpolatedDataValue(0); }
`)}const WT=new Array;function HT(i){WT.push(i)}function UV(i,e){for(const t of WT){const n=t(i,e);if(n!=null)return n}throw new Error("No chunk format handler found.")}class Ps extends Vc{constructor(e,t){super(e,t),this.chunkFormatHandler=this.registerDisposer(UV(e.chunkQueueManager.gl,this.spec));const n=this.spec.upperVoxelBound.length;this.tempChunkGridPosition=new Float32Array(n),this.tempPositionWithinChunk=new Uint32Array(n)}static encodeSpec(e){const t=e;return{...super.encodeSpec(e),dataType:t.dataType,compressedSegmentationBlockSize:t.compressedSegmentationBlockSize&&Array.from(t.compressedSegmentationBlockSize),baseVoxelOffset:Array.from(t.baseVoxelOffset)}}get chunkFormat(){return this.chunkFormatHandler.chunkFormat}getValueAt(e,t){const n=this.spec.rank,s=this.tempChunkGridPosition,r=this.tempPositionWithinChunk,{spec:o}=this;{const{chunkDataSize:w}=o;for(let C=0;C<n;++C){const E=e[C],k=w[C],D=Math.floor(E/k);s[C]=D,r[C]=Math.floor(E-k*D)}}const l=this.chunks.get(s.join());if(l===void 0)return null;const c=l.chunkDataSize;for(let w=0;w<3;++w)if(r[w]>=c[w])return;if(t.channelSpaceShape.length===0)return l.getValueAt(r);const{numChannels:u,chunkChannelCoordinates:h,chunkChannelDimensionIndices:g}=t,v=g.length;let y=0;const b=new Array(u);for(let w=0;w<u;++w){for(let C=0;C<v;++C)r[g[C]]=h[y++];b[w]=l.getValueAt(r)}return b}getChunk(e){return this.chunkFormatHandler.getChunk(this,e)}}class zV extends sE{get chunkFormat(){return this.source.chunkFormat}constructor(e,t){super(e,t),this.chunkDataSize=t.chunkDataSize||e.spec.chunkDataSize}}let di=class extends x2{};const GV=we(),$V=we(),Cw=.001,WV=.001;function HV(i){let e=0;for(let t=0;t<3;++t)i[t]<0&&(e+=1<<t);return e}const JT=new Float32Array([0,0,0,1,0,0,0,1,0,1,1,0,0,0,1,1,0,1,0,1,1,1,1,1]),JV=(()=>{const i=[0,1,2,4,5,3,6,7],e=[0,1,2,5,3,4,6,7],t=[0,1,1,4,4,7,4,7,1,5,0,1,1,4,4,7,0,2,2,5,5,7,5,7,2,6,0,2,2,5,5,7,0,3,3,6,6,7,6,7,3,4,0,3,3,6,6,7],n=[0,1,2,3,4,5,6,7,1,4,5,0,3,7,2,6,2,6,0,5,7,3,1,4,3,0,6,4,1,2,7,5,4,3,7,1,0,6,5,2,5,2,1,7,6,0,4,3,6,7,3,2,5,4,0,1,7,5,4,6,2,1,3,0],s=new Int32Array(8*8*6);for(let r=0;r<8;++r)for(let o=0;o<t.length;++o){const l=e[r]*8+t[o];s[r*8*6+o]=i[n[l]]}return s})();function _u(i){i.addUniform("highp vec3","uPlaneNormal"),i.addUniform("highp float","uPlaneDistance"),i.addUniform("highp ivec2","uVertexIndex",24),i.addUniform("highp vec3","uVertexBasePosition",8),i.addInitializer(e=>{e.gl.uniform3fv(e.uniform("uVertexBasePosition"),JT)}),i.addVertexCode(`
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex, float planeDistance) {
  for (int e = 0; e < 4; ++e) {
    highp ivec2 vidx = uVertexIndex[vertexIndex*4 + e];
    highp vec3 v1 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.x] + boxLower));
    highp vec3 v2 = max(lowerClipBound, min(upperClipBound, chunkSize * uVertexBasePosition[vidx.y] + boxLower));
    highp vec3 vDir = v2 - v1;
    highp float denom = dot(vDir, uPlaneNormal);
    if (abs(denom) > ${WV}) {
      highp float lambda = (planeDistance - dot(v1, uPlaneNormal)) / denom;
      if ((lambda >= -${Cw}) && (lambda <= (1.0 + ${Cw}))) {
        lambda = clamp(lambda, 0.0, 1.0);
        highp vec3 position = v1 + lambda * vDir;
        return position;
      }
    }
  }
  return vec3(0, 0, 0);
}
vec3 getBoundingBoxPlaneIntersectionVertexPosition(vec3 chunkSize, vec3 boxLower, vec3 lowerClipBound, vec3 upperClipBound, int vertexIndex) {
  return getBoundingBoxPlaneIntersectionVertexPosition(chunkSize, boxLower, lowerClipBound, upperClipBound, vertexIndex, uPlaneDistance);
}
`)}function jV(i,e,t){const{gl:n}=i;n.uniform3fv(i.uniform("uPlaneNormal"),e),n.uniform1f(i.uniform("uPlaneDistance"),t);const s=HV(e);n.uniform2iv(i.uniform("uVertexIndex"),JV.subarray(s*48,(s+1)*48))}function jv(i,e,t,n,s){const r=wx(GV,e,n);ou(r,r);const o=$m(qn($V,t,s),r);jV(i,r,o)}const YV=.001,qV=Ve();function KV(i,e){if(vr(i),_u(i),i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),e){ks(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${dr};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()));
`);return}i.addVarying("highp vec3","vChunkPosition"),i.setVertexMain(`
vec3 position = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, gl_VertexID);
gl_Position = uProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
vChunkPosition = (position - uTranslation) +
    ${YV} * abs(uPlaneNormal);
`)}function XV(i,e,t){t&&Ds(i,e,1)}function QV(i,e,t,n,s,r){const o=t.projectionParameters.value,{centerDataPosition:l}=o;jv(e,o.viewportNormalInGlobalCoordinates,l,r.transform,r.invTransform),i.uniformMatrix4fv(e.uniform("uProjectionMatrix"),!1,zt(qV,n,r.transform)),i.uniform3fv(e.uniform("uLowerClipBound"),s.lowerClipDisplayBound),i.uniform3fv(e.uniform("uUpperClipBound"),s.upperClipDisplayBound)}function ZV(i,e,t){i.uniform3fv(e.uniform("uChunkDataSize"),t)}function eB(i,e,t,n){i.uniform3fv(e.uniform("uTranslation"),t),n?Ls(e.gl,6,1):i.drawArrays(i.TRIANGLE_FAN,0,6)}function tB(i,e,t){return i>e?t>i?i:e>t?e:t:t>e?e:i>t?i:t}class jT extends bv{constructor(e,t){const{shaderError:n=Rc(),shaderParameters:s}=t;super(e.chunkManager,e,t);const{gl:r}=this;this.vertexIdHelper=this.registerDisposer(Is.get(r)),this.shaderParameters=s;const{channelCoordinateSpace:o}=t;this.channelCoordinateSpace=o===void 0?ar(bs):o,this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch));const l=this.registerDisposer(Ht((c,u)=>({numChannelDimensions:c.rank,dataHistogramChannelSpecifications:u}),[this.channelCoordinateSpace,this.dataHistogramSpecifications.channels]));this.shaderGetter=dv(this,r,{memoizeKey:`volume/RenderLayer:${jt(this.constructor)}`,fallbackParameters:t.fallbackShaderParameters,parameters:s,encodeParameters:t.encodeShaderParameters,shaderError:n,extraParameters:l,defineShader:(c,u,h,g)=>{const{chunkFormat:v,dataHistogramsEnabled:y}=u,{dataHistogramChannelSpecifications:b,numChannelDimensions:w}=g;if(KV(c,v===null),c.addOutputBuffer("vec4","v4f_fragData0",0),c.addFragmentCode(`
void emit(vec4 color) {
  v4f_fragData0 = color;
}
`),v===null)return;$T(c,v,w,"vChunkPosition");const C=b.length;if(y&&C>0){let E="";const{dataType:k}=v;for(let D=0;D<C;++D){const{channel:A}=b[D],N=`out_histogram${D}`;c.addOutputBuffer("vec4",N,1+D);const I=`getDataValue(${A.join(",")})`,P=`invlerpForHistogram${D}`;c.addFragmentCode(bu(c,P,k,!1)),c.addFragmentCode(`
float getHistogramValue${D}() {
  return invlerpForHistogram${D}(${I});
}
`),E+=`{
float x = getHistogramValue${D}();
if (x < 0.0) x = 0.0;
else if (x > 1.0) x = 1.0;
else x = (1.0 + x * 253.0) / 255.0;
${N} = vec4(x, x, x, 1.0);
}`}c.addFragmentCode(`void userMain();
void main() {
  ${E}
  userMain();
}
#define main userMain
`)}this.defineShader(c,h)},getContextKey:c=>{var u;return`${(u=c.chunkFormat)==null?void 0:u.shaderKey}/${c.dataHistogramsEnabled}`}}),this.tempChunkPosition=new Float32Array(e.rank),this.initializeCounterpart()}get dataType(){return this.multiscaleSource.dataType}getValueAt(e){const{tempChunkPosition:t}=this;for(const{source:n,chunkTransform:s}of this.visibleSourcesList){if(!ga(t,e,this.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))continue;const r=n.getValueAt(t,s);if(r!=null)return r}return null}beginChunkFormat(e,t,n){const{gl:s}=this,r=this.dataHistogramSpecifications.visibility.visible,o=this.shaderGetter({chunkFormat:t,dataHistogramsEnabled:r}),{shader:l,parameters:c,fallback:u}=o;if(l!==null&&(l.bind(),XV(l,n,t===null),t!==null)){if(r){const{dataHistogramChannelSpecifications:h}=o.extraParameters,g=h.length,v=this.dataHistogramSpecifications.bounds.value;for(let y=0;y<g;++y)Zl(l,`invlerpForHistogram${y}`,t.dataType,v[y])}this.initializeShader(e,l,c,u),t.beginDrawing(s,l)}return o}endSlice(e,t,n){}draw(e){const{sliceView:t}=e,n=t.visibleLayers.get(this),{visibleSources:s}=n;if(s.length===0)return;const{projectionParameters:r,wireFrame:o}=e,{gl:l}=this;this.vertexIdHelper.enable();const c=we(),{renderScaleHistogram:u}=this;u!==void 0&&u.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);let h,g=null,v;const y=we(),b=()=>{g!==null&&(v!==null&&v.endDrawing(l,g),this.endSlice(t,g,h.parameters))};let w=!0;for(const C of s){const E=vv(r,C.chunkLayout),{chunkTransform:{channelToChunkDimensionIndices:k}}=C,D=C.source,{fixedPositionWithinChunk:A,chunkDisplayDimensionIndices:N}=C;for(const B of N)A[B]=0;const I=o?null:D.chunkFormat;if(I!==v&&(v=I,b(),h=this.beginChunkFormat(t,I,r),g=h.shader),g===null)continue;const P=D.chunks;y.fill(1);const O=E.size;let _;const W=D.spec.rank;QV(l,g,t,r.viewProjectionMat,C,E),I!==null&&I.beginSource(l,g),w=!0;let U=0,j=0;if(t.forEachVisibleChunk(C,E,B=>{const H=P.get(B);if(H&&H.state===je.GPU_MEMORY){const V=H.chunkDataSize;if(V!==_){_=V;for(let se=0;se<3;++se){const ve=N[se];y[se]=ve===-1||ve>=W?1:_[ve]}ZV(l,g,y)}const{chunkGridPosition:re}=H;for(let se=0;se<3;++se){const ve=N[se];c[se]=ve===-1||ve>=W?0:O[se]*re[ve]}I!==null&&I.bindChunk(l,g,H,A,N,k,w),w=!1,eB(l,g,c,o),++U}else++j}),(U!==0||j!==0)&&u!==void 0){const{effectiveVoxelSize:B}=C,H=tB(B[0],B[1],B[2]);u.add(H,H/r.pixelSize,U,j)}}if(b(),this.vertexIdHelper.disable(),!e.wireFrame){const C=this.getDataHistogramCount();C>0&&t.computeHistograms(C,this.dataHistogramSpecifications)}}}class xw{constructor(e){this.disjointSets=e,this.generation=Number.NaN,this.hashMap=new Mv}update(){const{disjointSets:e}=this,{generation:t}=e;if(this.generation!==t){this.generation=t;const{hashMap:n}=this;n.clear();for(const[s,r]of e.mappings())n.set(s,r)}}}const Ew=1,Tw=2;class kw extends jT{constructor(e,t){super(e,{shaderParameters:new px(n=>({hasEquivalences:n.registerDisposer(Ht(s=>s.size!==0,[t.segmentationGroupState.value.segmentEquivalences])),hasSegmentStatedColors:n.registerDisposer(Ht((s,r,o)=>(o?r:s).size!==0,[t.segmentStatedColors,t.tempSegmentStatedColors2d,t.useTempSegmentStatedColors2d])),hasSegmentDefaultColor:n.registerDisposer(Ht((s,r)=>s!==void 0||r!==void 0,[t.segmentDefaultColor,t.tempSegmentDefaultColor2d])),hasHighlightColor:n.registerDisposer(Ht(s=>s!==void 0,[t.highlightColor])),hideSegmentZero:t.hideSegmentZero,baseSegmentColoring:t.baseSegmentColoring,baseSegmentHighlighting:t.baseSegmentHighlighting})),transform:t.transform,renderScaleHistogram:t.renderScaleHistogram,renderScaleTarget:t.renderScaleTarget,localPosition:t.localPosition}),this.displayState=t,this.segmentationGroupState=this.displayState.segmentationGroupState.value,this.segmentColorShaderManager=new m_("segmentColorHash"),this.segmentStatedColorShaderManager=new v_("segmentStatedColor"),this.hashTableManager=new cT("visibleSegments"),this.gpuHashTable=this.registerDisposer(Gr.get(this.gl,this.segmentationGroupState.visibleSegments.hashTable)),this.gpuTemporaryHashTable=Gr.get(this.gl,this.segmentationGroupState.temporaryVisibleSegments.hashTable),this.equivalencesShaderManager=new dT("equivalences"),this.equivalencesHashMap=new xw(this.segmentationGroupState.segmentEquivalences.disjointSets),this.temporaryEquivalencesHashMap=new xw(this.segmentationGroupState.temporarySegmentEquivalences.disjointSets),this.gpuEquivalencesHashTable=this.registerDisposer(Gr.get(this.gl,this.equivalencesHashMap.hashMap)),this.gpuTemporaryEquivalencesHashTable=this.registerDisposer(Gr.get(this.gl,this.temporaryEquivalencesHashMap.hashMap)),this.registerDisposer(this.shaderParameters),xT(t,this),this.registerDisposer(t.selectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.notSelectedAlpha.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.ignoreNullVisibleSet.changed.add(this.redrawNeeded.dispatch))}disposed(){var e;(e=this.gpuSegmentStatedColorHashTable)==null||e.dispose()}getSources(e){return this.multiscaleSource.getSources({...e,discreteValues:!0})}defineShader(e,t){this.hashTableManager.defineShader(e);let n=`
uint64_t getUint64DataValue() {
  uint64_t x = toUint64(getDataValue());
`;n+=`return x;
}
`,e.addFragmentCode(n),t.hasEquivalences?(this.equivalencesShaderManager.defineShader(e),e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  uint64_t mappedValue;
  if (${this.equivalencesShaderManager.getFunctionName}(value, mappedValue)) {
    return mappedValue;
  }
  return value;
}
`)):e.addFragmentCode(`
uint64_t getMappedObjectId(uint64_t value) {
  return value;
}
`),e.addUniform("highp uvec2","uSelectedSegment"),e.addUniform("highp uint","uFlags"),e.addUniform("highp float","uSelectedAlpha"),e.addUniform("highp float","uNotSelectedAlpha"),e.addUniform("highp float","uSaturation");let s=`
  uint64_t baseValue = getUint64DataValue();
  uint64_t value = getMappedObjectId(baseValue);
  uint64_t valueForColor = ${t.baseSegmentColoring?"baseValue":"value"};
  uint64_t valueForHighlight = ${t.baseSegmentHighlighting?"baseValue":"value"};

  float alpha = uSelectedAlpha;
  float saturation = uSaturation;
`;t.hideSegmentZero&&(s+=`
  if (value.value[0] == 0u && value.value[1] == 0u) {
    emit(vec4(vec4(0, 0, 0, 0)));
    return;
  }
`),s+=`
  bool has = (uFlags & ${Tw}u) != 0u ? true : ${this.hashTableManager.hasFunctionName}(value);
  if ((uFlags & ${Ew}u) != 0u && uSelectedSegment == valueForHighlight.value) {
    float adjustment = has ? 0.5 : 0.75;
    if (saturation > adjustment) {
      saturation -= adjustment;
    } else {
      saturation += adjustment;
    }
`,t.hasHighlightColor&&(e.addUniform("highp vec4","uHighlightColor"),s+=`
    emit(uHighlightColor);
    return;
`),s+=`
  } else if (!has) {
    alpha = uNotSelectedAlpha;
  }
`;let r=`vec4 getMappedIdColor(uint64_t value) {
`;t.hasSegmentStatedColors&&(this.segmentStatedColorShaderManager.defineShader(e),r+=`
  vec4 rgba;
  if (${this.segmentStatedColorShaderManager.getFunctionName}(value, rgba)) {
    return rgba;
  }
`),t.hasSegmentDefaultColor?(e.addUniform("highp vec4","uSegmentDefaultColor"),r+=`  return uSegmentDefaultColor;
`):(this.segmentColorShaderManager.defineShader(e),r+=`  return vec4(segmentColorHash(value), 0.0);
`),r+=`
}
`,e.addFragmentCode(r),s+=`
  vec4 rgba = getMappedIdColor(valueForColor);
  if (rgba.a > 0.0) {
    alpha = rgba.a;
  }
  emit(vec4(mix(vec3(1.0,1.0,1.0), vec3(rgba), saturation), alpha));
`,e.setFragmentMain(s)}initializeShader(e,t,n){const{gl:s}=this,{displayState:r,segmentationGroupState:o}=this,{segmentSelectionState:l}=this.displayState,{segmentDefaultColor:{value:c},segmentColorHash:{value:u},highlightColor:{value:h},tempSegmentDefaultColor2d:{value:g}}=this.displayState,v=iE(o),y=this.displayState.ignoreNullVisibleSet.value;let b=0,w=0,C=0;if(l.hasSelectedSegment&&r.hoverHighlight.value){const k=r.baseSegmentHighlighting.value?l.baseSelectedSegment:l.selectedSegment;b=k.low,w=k.high,C|=Ew}if(s.uniform1f(t.uniform("uSelectedAlpha"),r.selectedAlpha.value),s.uniform1f(t.uniform("uSaturation"),r.saturation.value),s.uniform1f(t.uniform("uNotSelectedAlpha"),r.notSelectedAlpha.value),s.uniform2ui(t.uniform("uSelectedSegment"),b,w),v.hashTable.size===0&&y&&(C|=Tw),s.uniform1ui(t.uniform("uFlags"),C),this.hashTableManager.enable(s,t,o.useTemporaryVisibleSegments.value?this.gpuTemporaryHashTable:this.gpuHashTable),n.hasEquivalences){const k=o.useTemporarySegmentEquivalences.value;(k?this.temporaryEquivalencesHashMap:this.equivalencesHashMap).update(),this.equivalencesShaderManager.enable(s,t,k?this.gpuTemporaryEquivalencesHashTable:this.gpuEquivalencesHashTable)}const E=g||c;if(E){const[k,D,A,N]=E;s.uniform4f(t.uniform("uSegmentDefaultColor"),k,D,A,N===void 0?0:N)}else this.segmentColorShaderManager.enable(s,t,u);if(n.hasSegmentStatedColors){const k=r.useTempSegmentStatedColors2d.value?r.tempSegmentStatedColors2d.value:r.segmentStatedColors.value;let{gpuSegmentStatedColorHashTable:D}=this;(D===void 0||D.hashTable!==k.hashTable)&&(D==null||D.dispose(),this.gpuSegmentStatedColorHashTable=D=Gr.get(s,k.hashTable)),this.segmentStatedColorShaderManager.enable(s,t,D)}h!==void 0&&s.uniform4fv(t.uniform("uHighlightColor"),h)}endSlice(e,t,n){const{gl:s}=this;this.hashTableManager.disable(s,t),n.hasEquivalences&&this.equivalencesShaderManager.disable(s,t),n.hasSegmentStatedColors&&this.segmentStatedColorShaderManager.disable(s,t),super.endSlice(e,t,n)}}function Ml(i=.5){return new bt(i,Nx)}/**
 * @license
 * Copyright 2020 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yv=12,YT=8,nB=6,iB=`
vec3 getBoxFaceVertexPosition(int vertexIndex) {
  const vec3 vertexPositions[] = vec3[](
  // Front face
  vec3(0.0, 0.0,  1.0), // 0
  vec3(1.0, 0.0,  1.0), // 1
  vec3(1.0,  1.0,  1.0), // 2
  vec3(0.0,  1.0,  1.0), // 3

  // Back face
  vec3(0.0, 0.0, 0.0), // 4
  vec3(0.0,  1.0, 0.0), // 5
  vec3(1.0,  1.0, 0.0), // 6
  vec3(1.0, 0.0, 0.0), // 7

  // Top face
  vec3(0.0,  1.0, 0.0), // 8
  vec3(0.0,  1.0,  1.0), // 9
  vec3(1.0,  1.0,  1.0), // 10
  vec3(1.0,  1.0, 0.0), // 11

  // Bottom face
  vec3(0.0, 0.0, 0.0), // 12
  vec3( 1.0, 0.0, 0.0), // 13
  vec3( 1.0, 0.0,  1.0), // 14
  vec3(0.0, 0.0,  1.0), // 15

  // Right face
  vec3( 1.0, 0.0, 0.0), // 16
  vec3( 1.0,  1.0, 0.0), // 17
  vec3( 1.0,  1.0,  1.0), // 18
  vec3( 1.0, 0.0,  1.0), // 19

  // Left face
  vec3(0.0, 0.0, 0.0), // 20
  vec3(0.0, 0.0,  1.0), // 21
  vec3(0.0,  1.0,  1.0), // 22
  vec3(0.0,  1.0, 0.0) // 23
  );
  const int indices[] = int[](
    0,  1,  2,      0,  2,  3,    // front
    4,  5,  6,      4,  6,  7,    // back
    8,  9,  10,     8,  10, 11,   // top
    12, 13, 14,     12, 14, 15,   // bottom
    16, 17, 18,     16, 18, 19,   // right
    20, 21, 22,     20, 22, 23   // left
  );
  return vertexPositions[indices[vertexIndex]];
}
`;function sB(i,e,t){i.drawArraysInstanced(WebGL2RenderingContext.TRIANGLES,0,6*nB*e,t)}const qT=0,Vu=qT+1,an=Vu+YT,KT=an+Yv,rB=KT+6,oB=Float32Array.from([0,0,0,0,0,1,an+0,1,0,0,1,0,1,an+1,0,1,0,0,1,1,an+2,1,1,0,1,1,1,an+3,0,0,0,0,1,0,an+4,0,0,1,0,1,1,an+5,1,0,0,1,1,0,an+6,1,0,1,1,1,1,an+7,0,0,0,1,0,0,an+8,0,0,1,1,0,1,an+9,0,1,0,1,1,0,an+10,0,1,1,1,1,1,an+11]),Lw=Ve(),er=new Float32Array(6);let XT=class extends Th{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl))}defineShader(e){vr(e);const{rank:t}=this;bh(e,"float",WebGL2RenderingContext.FLOAT,!1,"Bounds",t,2),e.addUniform("vec3","uModelSpaceBoundOffsets",2)}enable(e,t,n){ur(Lw,t.modelViewProjectionMatrix),MA(Lw,er);const{numChunkDisplayDims:s}=t.chunkDisplayTransform;for(let r=0;r<s;++r)er[r]=0,er[r+3]=0;for(let r=s;r<3;++r){const o=Math.abs(er[r+3]-er[r]);er[r]-=o,er[r+3]+=o}super.enable(e,t,r=>{const o=r.vertexShaderInputBinders.Bounds;o.enable(1);const{gl:l}=this;l.uniform3fv(r.uniform("uModelSpaceBoundOffsets"),er),l.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),o.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:c}=this;c.enable(),n(r),c.disable(),o.disable()})}};function QT(i){i.addVertexCode(`
void setBoundingBoxBorderWidth(float width) {}
void setBoundingBoxBorderColor(vec4 color) {}
`)}function ZT(i){i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {}
`)}function tm(i){ZT(i),i.addVertexCode(`
float ng_lineWidth;
void setBoundingBoxBorderWidth(float size) {
  ng_lineWidth = size;
}
void setBoundingBoxBorderColor(vec4 color) {
  vColor = color;
}
`)}function aB(i){QT(i),i.addVertexCode(`
void setBoundingBoxFillColor(vec4 color) {
  vColor = color;
}
`)}class lB extends XT{constructor(){super(...arguments),this.edgeBoxCornerOffsetsBuffer=this.registerDisposer(dn.fromData(this.gl,qp(oB,7,1,dr))),this.edgeShaderGetter=this.getDependentShader("annotation/boundingBox/projection/border",e=>{const{rank:t}=this;this.defineShader(e),ks(e),e.addAttribute("highp vec3","aBoxCornerOffset1"),e.addAttribute("highp vec4","aBoxCornerOffset2"),e.addVarying("highp float","vClipCoefficient"),tm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 endpointA = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset1);
vec3 endpointB = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset2.xyz);
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(endpointA, 1.0),
         uModelViewProjection * vec4(endpointB, 1.0),
         ng_lineWidth);
${this.setPartIndex(e,"uint(aBoxCornerOffset2.w)")};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, getLineAlpha() * vClipCoefficient));
`)}),this.boxCornerOffsetsBuffer=this.registerDisposer(dn.fromData(this.gl,qp(JT,3,1,BT))),this.cornerShaderGetter=this.getDependentShader("annotation/boundingBox/projection/corner",e=>{const{rank:t}=this;this.defineShader(e),zh(e,this.targetIsSliceView),e.addAttribute("highp vec3","aBoxCornerOffset"),e.addVarying("highp float","vClipCoefficient"),tm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
vClipCoefficient = getMaxEndpointSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
vec3 vertexPosition = mix(subspacePositionA, subspacePositionB, aBoxCornerOffset);
emitCircle(uModelViewProjection * vec4(vertexPosition, 1.0), ng_lineWidth, 0.0);
uint cornerIndex = uint(aBoxCornerOffset.x + aBoxCornerOffset.y * 2.0 + aBoxCornerOffset.z * 4.0);
uint cornerPickOffset = ${Vu}u + cornerIndex;
${this.setPartIndex(e,"cornerPickOffset")};
`),e.setFragmentMain(`
vec4 borderColor = vec4(0.0, 0.0, 0.0, 1.0);
vec4 color = getCircleColor(vColor, borderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}drawEdges(e){const{gl:t}=this;this.enable(this.edgeShaderGetter,e,n=>{const s=n.attribute("aBoxCornerOffset1"),r=n.attribute("aBoxCornerOffset2");this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(s,3,WebGL2RenderingContext.FLOAT,!1,4*7,0),this.edgeBoxCornerOffsetsBuffer.bindToVertexAttrib(r,4,WebGL2RenderingContext.FLOAT,!1,4*7,4*3),Ds(n,e.renderContext.projectionParameters,1),Ls(t,Yv,e.count),t.disableVertexAttribArray(s),t.disableVertexAttribArray(r)})}drawCorners(e){const{gl:t}=this;this.enable(this.cornerShaderGetter,e,n=>{const s=n.attribute("aBoxCornerOffset");this.boxCornerOffsetsBuffer.bindToVertexAttrib(s,3,WebGL2RenderingContext.FLOAT,!1),Gh(n,e.renderContext.projectionParameters,{featherWidthInPixels:0}),$h(n.gl,YT,e.count),t.disableVertexAttribArray(s)})}draw(e){this.drawEdges(e),this.drawCorners(e)}}let cB=class extends XT{constructor(){super(...arguments),this.faceShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/face",e=>{const{rank:t}=this;super.defineShader(e),_u(e),ks(e),e.addVarying("highp float","vClipCoefficient"),tm(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex1 = gl_VertexID / ${dr};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex2);
ng_lineWidth = 1.0;
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(vertexPosition1, 1.0),
         uModelViewProjection * vec4(vertexPosition2, 1.0),
         ng_lineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() * vClipCoefficient));
`)}),this.fillShaderGetter=this.getDependentShader("annotation/boundingBox/crossSection/fill",e=>{const{rank:t}=this;super.defineShader(e),_u(e),e.addVarying("highp float","vClipCoefficient"),aB(e),e.setVertexMain(`
float modelPositionA[${t}] = getBounds0();
float modelPositionB[${t}] = getBounds1();
for (int i = 0; i < ${t}; ++i) {
  float a = modelPositionA[i];
  float b = modelPositionB[i];
  modelPositionA[i] = min(a, b);
  modelPositionB[i] = max(a, b);
}
vClipCoefficient = getMaxSubspaceClipCoefficient(modelPositionA, modelPositionB);
if (vClipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vec3 subspacePositionA = projectModelVectorToSubspace(modelPositionA) + uModelSpaceBoundOffsets[0];
vec3 subspacePositionB = projectModelVectorToSubspace(modelPositionB) + uModelSpaceBoundOffsets[1];
int vertexIndex = gl_VertexID;
vec3 vertexPosition = getBoundingBoxPlaneIntersectionVertexPosition(subspacePositionB - subspacePositionA, subspacePositionA, subspacePositionA, subspacePositionB, vertexIndex);
gl_Position = uModelViewProjection * vec4(vertexPosition, 1);
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)})}enableForBoundingBox(e,t,n){super.enable(e,t,s=>{const r=t.renderContext.sliceView.projectionParameters.value;jv(s,r.viewportNormalInGlobalCoordinates,r.centerDataPosition,t.renderSubspaceModelMatrix,t.renderSubspaceInvModelMatrix),n(s)})}draw(e){this.shaderControlState.parseResult.value.code.match(/\bsetBoundingBoxFillColor\b/)&&this.enableForBoundingBox(this.fillShaderGetter,e,()=>{VN(this.gl,WebGL2RenderingContext.TRIANGLE_FAN,0,6,e.count)}),this.enableForBoundingBox(this.faceShaderGetter,e,t=>{Ds(t,e.renderContext.projectionParameters,1),Ls(t.gl,6,e.count)})}};function dB(i,e){const t=i.length;for(let n=0;n<t;++n){const s=e[n],r=e[n+t],o=i[n];i[n]=Math.abs(s-o)<Math.abs(r-o)?s:r}}kh(st.AXIS_ALIGNED_BOUNDING_BOX,{sliceViewRenderHelper:cB,perspectiveViewRenderHelper:lB,defineShaderNoOpSetters(i){ZT(i),QT(i)},pickIdsPerInstance:rB,snapPosition(i,e,t,n){const s=i.length,r=new Float32Array(e,t,s*2);n>=Vu&&n<an&&dB(i,r)},getRepresentativePoint(i,e,t){t===qT||t>=Vu&&t<an||t>=an&&t<KT,i.set(e.pointA)},updateViaRepresentativePoint(i,e,t){const n=e.length,{pointA:s,pointB:r}=i,o=new Float32Array(n),l=new Float32Array(n);for(let c=0;c<n;++c){const u=o[c]=e[c];l[c]=r[c]+(u-s[c])}return{...i,pointA:o,pointB:l}}});const Ko=0,nm=Ko+1,uB=nm+2;function ek(i){i.addVertexCode(`
void setEndpointMarkerSize(float startSize, float endSize) {}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {}
`)}function tk(i){i.addVertexCode(`
void setLineWidth(float width) {}
void setLineColor(vec4 startColor, vec4 endColor) {}
`)}let Dw=class extends Th{constructor(){super(...arguments),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl)),this.edgeShaderGetter=this.getDependentShader("annotation/line/edge",e=>{const{rank:t}=this;this.defineShader(e),ks(e),e.addVarying(`highp float[${t}]`,"vModelPosition"),e.addVertexCode(`
float ng_LineWidth;
`),ek(e),e.addVertexCode(`
void setLineWidth(float width) {
  ng_LineWidth = width;
}
void setLineColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, getLineEndpointCoefficient());
}
`),e.setVertexMain(`
float modelPositionA[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  vModelPosition[i] = mix(modelPositionA[i], modelPositionB[i], getLineEndpointCoefficient());
}
ng_LineWidth = 1.0;
vColor = vec4(0.0, 0.0, 0.0, 0.0);
${this.invokeUserMain}
emitLine(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionA), 1.0),
         uModelViewProjection * vec4(projectModelVectorToSubspace(modelPositionB), 1.0),
         ng_LineWidth);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
float clipCoefficient = getSubspaceClipCoefficient(vModelPosition);
emitAnnotation(vec4(vColor.rgb, vColor.a * getLineAlpha() *
                                ${this.getCrossSectionFadeFactor()} *
                                clipCoefficient));
`)}),this.endpointShaderGetter=this.getDependentShader("annotation/line/endpoint",e=>{const{rank:t}=this;this.defineShader(e),zh(e,this.targetIsSliceView),e.addVarying("highp float","vClipCoefficient"),e.addVarying("highp vec4","vBorderColor"),tk(e),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
int getEndpointIndex() {
  return gl_VertexID / ${BT};
}
void setEndpointMarkerSize(float startSize, float endSize) {
  ng_markerDiameter = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerBorderWidth(float startSize, float endSize) {
  ng_markerBorderWidth = mix(startSize, endSize, float(getEndpointIndex()));
}
void setEndpointMarkerColor(vec4 startColor, vec4 endColor) {
  vColor = mix(startColor, endColor, float(getEndpointIndex()));
}
void setEndpointMarkerBorderColor(vec4 startColor, vec4 endColor) {
  vBorderColor = mix(startColor, endColor, float(getEndpointIndex()));
}
`),e.setVertexMain(`
float modelPosition[${t}] = getVertexPosition0();
float modelPositionB[${t}] = getVertexPosition1();
for (int i = 0; i < ${t}; ++i) {
  modelPosition[i] = mix(modelPosition[i], modelPositionB[i], float(getEndpointIndex()));
}
vClipCoefficient = getSubspaceClipCoefficient(modelPosition);
vColor = vec4(0.0, 0.0, 0.0, 0.0);
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
${this.invokeUserMain}
emitCircle(uModelViewProjection * vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
${this.setPartIndex(e,"uint(getEndpointIndex()) + 1u")};
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
color.a *= vClipCoefficient;
emitAnnotation(color);
`)})}defineShader(e){vr(e);const{rank:t}=this;bh(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t,2)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:o}=this;o.enable(),n(s),o.disable(),r.disable()})}drawEdges(e){this.enable(this.edgeShaderGetter,e,t=>{Ds(t,e.renderContext.projectionParameters,1),Ls(t.gl,1,e.count)})}drawEndpoints(e){this.enable(this.endpointShaderGetter,e,t=>{Gh(t,e.renderContext.projectionParameters,{featherWidthInPixels:.5}),$h(t.gl,2,e.count)})}draw(e){this.drawEdges(e),this.drawEndpoints(e)}};function hB(i,e){const t=i.length;PA(i,e.subarray(0,t),e.subarray(t),i)}function fB(i,e,t){const n=i.length,s=n*t;for(let r=0;r<n;++r)i[r]=e[s+r]}kh(st.LINE,{sliceViewRenderHelper:Dw,perspectiveViewRenderHelper:Dw,defineShaderNoOpSetters(i){ek(i),tk(i)},pickIdsPerInstance:uB,snapPosition(i,e,t,n){const s=i.length,r=new Float32Array(e,t,s*2);n===Ko?hB(i,r):fB(i,r,n-nm)},getRepresentativePoint(i,e,t){i.set(t===Ko||t===nm?e.pointA:e.pointB)},updateViaRepresentativePoint(i,e,t){const n={...i},s=e.length;switch(t){case Ko:{const{pointA:r,pointB:o}=i,l=new Float32Array(s),c=new Float32Array(s);for(let u=0;u<s;++u){const h=l[u]=e[u];c[u]=o[u]+(h-r[u])}return{...i,pointA:l,pointB:c}}case Ko+1:return{...i,pointA:new Float32Array(e)};case Ko+2:return{...i,pointB:new Float32Array(e)}}return n}});let Iw=class extends Th{constructor(){super(...arguments),this.shaderGetter3d=this.getDependentShader("annotation/point:3d",e=>{vr(e),zh(e,this.targetIsSliceView),this.defineShaderCommon(e),e.addVertexMain(`
emitCircle(uModelViewProjection *
           vec4(projectModelVectorToSubspace(modelPosition), 1.0), ng_markerDiameter, ng_markerBorderWidth);
`),e.setFragmentMain(`
vec4 color = getCircleColor(vColor, vBorderColor);
emitAnnotation(color);
`)}),this.makeShaderGetter2d=e=>this.getDependentShader(`annotation/point:2d:${e}`,t=>{vr(t),ks(t,!0),this.defineShaderCommon(t),t.addVertexMain(`
vec3 subspacePositionA = projectModelVectorToSubspace(modelPosition);
vec3 subspacePositionB = subspacePositionA;
vec4 baseProjection = uModelViewProjection * vec4(subspacePositionA, 1.0);
vec4 zCoeffs = uModelViewProjection[${e}];
float minZ = 1e30;
float maxZ = -1e30;
for (int i = 0; i < 3; ++i) {
  // Want: baseProjection[i] + z * zCoeffs[i] = -2.0 * (baseProjection.w - z * zCoeffs.w)
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * (2.0 * zCoeffs.w + zCoeffs[i])
  //  i.e. baseProjection[i] + 2.0 * baseProjection.w < -z * k1
  float k1 = 2.0 * zCoeffs.w + zCoeffs[i];
  float q1 = -(baseProjection[i] + 2.0 * baseProjection.w) / k1;
  if (k1 != 0.0) {
    minZ = min(minZ, q1);
    maxZ = max(maxZ, q1);
  }
  // Want: baseProjection[i] + z * zCoeffs[i] = 2.0 * (baseProjection.w + z * zCoeffs.w)
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * (2.0 * zCoeffs.w - zCoeffs[i])
  //  i.e. baseProjection[i] - 2.0 * baseProjection.w > z * k2
  float k2 = 2.0 * zCoeffs.w - zCoeffs[i];
  float q2 = (baseProjection[i] - 2.0 * baseProjection.w) / k2;
  if (k2 != 0.0) {
    minZ = min(minZ, q2);
    maxZ = max(maxZ, q2);
  }
}
if (minZ > maxZ) minZ = maxZ = 0.0;
subspacePositionA[${e}] = minZ;
subspacePositionB[${e}] = maxZ;
emitLine(uModelViewProjection, subspacePositionA, subspacePositionB, ng_markerDiameter, ng_markerBorderWidth);
`),t.setFragmentMain(`
vec4 color = getRoundedLineColor(vColor, vBorderColor);
emitAnnotation(vec4(color.rgb, color.a * ${this.getCrossSectionFadeFactor()}));
`)}),this.shaderGetter2d=this.makeShaderGetter2d(2),this.shaderGetter1d=this.makeShaderGetter2d(1),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl))}defineShaderCommon(e){const{rank:t}=this;bh(e,"float",WebGL2RenderingContext.FLOAT,!1,"VertexPosition",t),e.addVarying("highp vec4","vBorderColor"),e.addVertexCode(`
float ng_markerDiameter;
float ng_markerBorderWidth;
void setPointMarkerSize(float size) {
  ng_markerDiameter = size;
}
void setPointMarkerBorderWidth(float size) {
  ng_markerBorderWidth = size;
}
void setPointMarkerColor(vec4 color) {
  vColor = color;
}
void setPointMarkerBorderColor(vec4 color) {
  vBorderColor = color;
}
`),e.addVertexMain(`
ng_markerDiameter = 5.0;
ng_markerBorderWidth = 1.0;
vBorderColor = vec4(0.0, 0.0, 0.0, 1.0);
float modelPosition[${t}] = getVertexPosition0();
float clipCoefficient = getSubspaceClipCoefficient(modelPosition);
if (clipCoefficient == 0.0) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
${this.invokeUserMain}
vColor.a *= clipCoefficient;
vBorderColor.a *= clipCoefficient;
${this.setPartIndex(e)};
`)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.VertexPosition;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset);const{vertexIdHelper:o}=this;o.enable(),n(s),o.disable(),r.disable()})}draw(e){const{numChunkDisplayDims:t}=e.chunkDisplayTransform;switch(t){case 3:this.enable(this.shaderGetter3d,e,n=>{Gh(n,e.renderContext.projectionParameters,{featherWidthInPixels:1}),$h(n.gl,1,e.count)});break;case 2:case 1:this.enable(t===2?this.shaderGetter2d:this.shaderGetter1d,e,n=>{Ds(n,e.renderContext.projectionParameters,1),Ls(n.gl,1,e.count)});break}}};kh(st.POINT,{sliceViewRenderHelper:Iw,perspectiveViewRenderHelper:Iw,defineShaderNoOpSetters(i){i.addVertexCode(`
void setPointMarkerSize(float size) {}
void setPointMarkerBorderWidth(float size) {}
void setPointMarkerColor(vec4 color) {}
void setPointMarkerBorderColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition(i,e,t){i.set(new Float32Array(e,t,i.length))},getRepresentativePoint(i,e){i.set(e.point)},updateViaRepresentativePoint(i,e){return{...i,point:new Float32Array(e)}}});const nk=`
struct EllipseQuadraticForm {
  highp float A;  // x*x coefficient
  highp float B;  // x*y coefficient
  highp float C;  // y*y coefficient
  highp float D;  // x coefficient
  highp float E;  // y coefficient
  highp float F;  // 1 coefficient
};
`,pB=[nk,`
EllipseQuadraticForm computeCrossSectionEllipse(mat3 A, vec3 c) {
  EllipseQuadraticForm p;
  p.A = A[0][0];
  p.B = A[0][1] + A[1][0];
  p.C = A[1][1];
  p.D = -2.0 * c[0] * A[0][0] - c[1] * (A[0][1] + A[1][0]) +
        c[2] * (A[0][2] + A[2][0]);
  p.E = -c[0] * (A[0][1] + A[1][0]) - 2.0 * c[1] * A[1][1] +
        c[2] * (A[1][2] + A[2][1]);
  p.F = c[0] * c[0] * A[0][0] + c[0] * c[1] * (A[0][1] + A[1][0]) -
        c[0] * c[2] * (A[0][2] + A[2][0]) + c[1] * c[1] * A[1][1] -
        c[1] * c[2] * (A[1][2] + A[2][1]) + c[2] * c[2] * A[2][2] - 1.0;
  return p;
}
`],gB=`
struct CenterOrientEllipse {
  vec2 k;   // center
  vec2 u1;  // minor axis direction
  vec2 u2;  // major axis direction
  float a;  // semimajor axis
  float b;  // semiminor axis
  bool valid; // indicates if the ellipse is valid
};
`,mB=[nk,gB,`
CenterOrientEllipse computeCenterOrientEllipse(EllipseQuadraticForm p) {
  CenterOrientEllipse r;
  float a11 = p.A;
  float a12 = p.B / 2.0;
  float a22 = p.C;
  float b1 = p.D;
  float b2 = p.E;
  float c = p.F;
  float kdenom = 2.0 * (a12 * a12 - a11 * a22);
  float k1 = r.k.x = (a22 * b1 - a12 * b2) / kdenom;
  float k2 = r.k.y = (a11 * b2 - a12 * b1) / kdenom;
  float mu = 1.0 / (a11 * k1 * k1 + 2.0 * a12 * k1 * k2 + a22 * k2 * k2 - c);
  float m11 = mu * a11;
  float m12 = mu * a12;
  float m22 = mu * a22;
  float lambdaTerm1 = m11 + m22;
  float lambdaTerm2 = sqrt((m11 - m22) * (m11 - m22) + 4.0 * m12 * m12);
  float lambda1 = ((lambdaTerm1 + lambdaTerm2) / 2.0);
  float lambda2 = ((lambdaTerm1 - lambdaTerm2) / 2.0);
  r.a = 1.0 / sqrt(lambda1);
  r.b = 1.0 / sqrt(lambda2);
  r.valid = lambda1 > 0.0 && lambda2 > 0.0;
  if (abs(m11 - m22) < 1e-6 && abs(m12) < 1e-6) {
    r.u1 = vec2(1.0, 0.0);
  } else if (m11 >= m22) {
    r.u1 = normalize(vec2(lambda1 - m22, m12));
  } else {
    r.u1 = normalize(vec2(m12, lambda1 - m11));
  }
  r.u2 = vec2(-r.u1.y, r.u1.x);
  return r;
}
`];function vB(i,e){const t=new Float32Array((i+1)*(e+1)*3);let n=0;for(let s=0;s<=i;++s){const r=s*Math.PI/i,o=Math.sin(r),l=Math.cos(r);for(let c=0;c<=e;++c){const u=c*2*Math.PI/e,h=Math.sin(u),g=Math.cos(u);t[n++]=g*o,t[n++]=l,t[n++]=h*o}}return t}function yB(i,e){const t=new Uint16Array(i*e*6);let n=0;for(let s=0;s<i;s++)for(let r=0;r<e;r++){const o=s*(e+1)+r,l=o+e+1;t[n++]=o,t[n++]=l,t[n++]=o+1,t[n++]=l,t[n++]=l+1,t[n++]=o+1}return t}class SB extends K{constructor(e,t,n){super(),this.vertexBuffer=this.registerDisposer(Xl(e,WebGL2RenderingContext.ARRAY_BUFFER,vB,t,n)).value,this.indexBuffer=this.registerDisposer(Xl(e,WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,yB,t,n)).value,this.numIndices=t*n*6}defineShader(e){e.addAttribute("highp vec3","aSphereVertex"),e.addVarying("highp float","vLightingFactor"),e.addVertexCode(`
void emitSphere(mat4 projectionMatrix, mat4 normalTransformMatrix, vec3 centerPosition, vec3 radii, vec4 lightDirection) {
  vec3 vertexPosition = aSphereVertex * radii + centerPosition;
  gl_Position = projectionMatrix * vec4(vertexPosition, 1.0);
  vec3 normal = normalize((normalTransformMatrix * vec4(aSphereVertex / max(radii, 1e-6), 0.0)).xyz);
  vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
}
`)}draw(e,t){const n=e.attribute("aSphereVertex");this.vertexBuffer.bindToVertexAttrib(n,3,WebGL2RenderingContext.FLOAT,!1),this.indexBuffer.bind(),e.gl.drawElementsInstanced(WebGL2RenderingContext.TRIANGLES,this.numIndices,WebGL2RenderingContext.UNSIGNED_SHORT,0,t),e.gl.disableVertexAttribArray(n)}}const Pw=Ve();class ik extends Th{defineShader(e){const{rank:t}=this;bh(e,"float",WebGL2RenderingContext.FLOAT,!1,"CenterAndRadii",t,2),e.addVertexCode(`
struct SubspaceParams {
  highp vec3 subspaceCenter;
  highp vec3 subspaceRadii;
  highp float clipCoefficient;
  bool cull;
};
SubspaceParams getSubspaceParams() {
  SubspaceParams params;
  highp float modelCenter[${t}] = getCenterAndRadii0();
  highp float modelRadii[${t}] = getCenterAndRadii1();
  float radiusAdjustment = 1.0;
  float clipCoefficient = 1.0;
  for (int i = 0; i < ${t}; ++i) {
    float r = modelRadii[i];
    float c = modelCenter[i];
    float x = uModelClipBounds[i];
    float clipRadius = uModelClipBounds[i + ${t}];
    if (r != 0.0 && clipRadius != 0.0) {
      float d = c - x;
      d = d * d;
      radiusAdjustment -= d / (r * r);
    }
    float e = abs(x - clamp(x, c - r, c + r)) * clipRadius;
    clipCoefficient *= max(0.0, 1.0 - e);
  }
  radiusAdjustment = sqrt(max(0.0, radiusAdjustment));
  params.subspaceCenter = projectModelVectorToSubspace(modelCenter);
  params.subspaceRadii = projectModelVectorToSubspace(modelRadii) * radiusAdjustment;
  params.clipCoefficient = clipCoefficient;
  params.cull = clipCoefficient == 0.0 || radiusAdjustment == 0.0;
  return params;
}
void setEllipsoidFillColor(vec4 color) {
  vColor = color;
}
`)}enable(e,t,n){super.enable(e,t,s=>{const r=s.vertexShaderInputBinders.CenterAndRadii;r.enable(1),this.gl.bindBuffer(WebGL2RenderingContext.ARRAY_BUFFER,t.buffer.buffer),r.bind(this.geometryDataStride,t.bufferOffset),n(s),r.disable()})}}class bB extends ik{constructor(){super(...arguments),this.sphereRenderHelper=this.registerDisposer(new SB(this.gl,10,10)),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/projection",e=>{this.defineShader(e),this.sphereRenderHelper.defineShader(e),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp mat4","uNormalTransform"),e.addVarying("highp float","vClipCoefficient"),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
${this.invokeUserMain}
emitSphere(uModelViewProjection, uNormalTransform, params.subspaceCenter, params.subspaceRadii, uLightDirection);
${this.setPartIndex(e)};
`),e.setFragmentMain(`
emitAnnotation(vec4(vColor.rgb * vLightingFactor, vColor.a * vClipCoefficient));
`)}),this.tempLightVec=new Float32Array(4)}draw(e){this.enable(this.shaderGetter,e,t=>{const{gl:n}=t,s=this.tempLightVec,{lightDirection:r,ambientLighting:o,directionalLighting:l}=e.renderContext;ah(s,r,l),s[3]=o,n.uniform4fv(t.uniform("uLightDirection"),s),n.uniformMatrix4fv(t.uniform("uNormalTransform"),!1,Gm(Ve(),e.renderSubspaceInvModelMatrix)),this.sphereRenderHelper.draw(t,e.count)})}}class wB extends ik{constructor(){super(...arguments),this.shaderGetter=this.getDependentShader("annotation/ellipsoid/crossSection",e=>{vr(e),this.defineShader(e),e.addUniform("highp mat4","uViewportToObject"),e.addUniform("highp mat4","uObjectToViewport"),e.addUniform("highp mat4","uViewportToDevice"),e.addAttribute("highp vec2","aCornerOffset"),e.addVarying("highp vec2","vCircleCoord"),e.addVarying("highp float","vClipCoefficient"),e.addVertexCode(pB),e.addVertexCode(mB),e.addVertexCode(Hv),e.setVertexMain(`
SubspaceParams params = getSubspaceParams();
if (params.cull) {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
  return;
}
vClipCoefficient = params.clipCoefficient;
mat3 Aobject = mat3(0.0);
for (int i = 0; i < 3; ++i) {
  float r = max(params.subspaceRadii[i], 1e-3);
  Aobject[i][i] = 1.0 / (r * r);
}
mat3 RviewportToObject = mat3(uViewportToObject);
mat3 Aviewport = transpose(RviewportToObject) * Aobject * RviewportToObject;
vec3 cViewport = (uObjectToViewport * vec4(params.subspaceCenter, 1.0)).xyz;
EllipseQuadraticForm quadraticForm = computeCrossSectionEllipse(Aviewport, cViewport);
vec2 u1, u2;
float a, b;
CenterOrientEllipse centerOrient = computeCenterOrientEllipse(quadraticForm);
vec2 cornerOffset = getQuadVertexPosition(vec2(-1.0, -1.0), vec2(1.0, 1.0));
vec2 viewportCorner = centerOrient.k +
  centerOrient.u1 * cornerOffset.x * centerOrient.a +
  centerOrient.u2 * cornerOffset.y * centerOrient.b;
if (centerOrient.valid) {
  gl_Position = uViewportToDevice * vec4(viewportCorner, 0.0, 1.0);
} else {
  gl_Position = vec4(2.0, 0.0, 0.0, 1.0);
}
vCircleCoord = cornerOffset;
${this.invokeUserMain}
${this.setPartIndex(e)};
`),e.setFragmentMain(`
if (dot(vCircleCoord, vCircleCoord) > 1.0) {
  discard;
}
emitAnnotation(vec4(vColor.rgb, vColor.a * vClipCoefficient));
`)}),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl))}draw(e){this.enable(this.shaderGetter,e,t=>{const{gl:n}=t,s=e.renderContext.sliceView.projectionParameters.value,r=zt(Pw,e.renderSubspaceInvModelMatrix,s.invViewMatrix);n.uniformMatrix4fv(t.uniform("uViewportToObject"),!1,r),n.uniformMatrix4fv(t.uniform("uViewportToDevice"),!1,s.projectionMat);const o=Pw;ur(o,r),n.uniformMatrix4fv(t.uniform("uObjectToViewport"),!1,o);const{vertexIdHelper:l}=this;l.enable(),Jv(n,1,e.count),l.disable()})}}kh(st.ELLIPSOID,{sliceViewRenderHelper:wB,perspectiveViewRenderHelper:bB,defineShaderNoOpSetters(i){i.addVertexCode(`
void setEllipsoidFillColor(vec4 color) {}
`)},pickIdsPerInstance:1,snapPosition:()=>{},getRepresentativePoint(i,e){i.set(e.center)},updateViaRepresentativePoint(i,e){return{...i,center:new Float32Array(e)}}});const sk=Ve(),rk=we();function ok(i){i.addUniform("highp vec3","uTranslation"),i.addUniform("highp mat4","uProjectionMatrix"),i.addUniform("highp vec3","uChunkDataSize"),i.addUniform("highp vec3","uLowerClipBound"),i.addUniform("highp vec3","uUpperClipBound"),i.setFragmentMain(`
emit(vec4(1.0, 1.0, 1.0, getLineAlpha()), 0u);
`)}const CB={defineShader(i){ok(i),ks(i),i.addVertexCode(`
const vec3[24] boxCornerOffsets = vec3[](
  vec3(0, 0, 0), vec3(0, 0, 1),  // e1
  vec3(1, 0, 0), vec3(1, 0, 1),  // e2
  vec3(0, 1, 0), vec3(0, 1, 1),  // e3
  vec3(1, 1, 0), vec3(1, 1, 1),  // e4
  vec3(0, 0, 0), vec3(0, 1, 0),  // e5
  vec3(0, 0, 1), vec3(0, 1, 1),  // e6
  vec3(1, 0, 0), vec3(1, 1, 0),  // e7
  vec3(1, 0, 1), vec3(1, 1, 1),  // e8
  vec3(0, 0, 0), vec3(1, 0, 0),  // e9
  vec3(0, 0, 1), vec3(1, 0, 1),  // e10
  vec3(0, 1, 0), vec3(1, 1, 0),  // e11
  vec3(0, 1, 1), vec3(1, 1, 1)  // e12
);
`),i.setVertexMain(`
int edgeIndex = gl_VertexID / ${dr};
vec3 cornerA = max(uLowerClipBound, min(uUpperClipBound, uTranslation));
vec3 cornerB = max(uLowerClipBound, min(uUpperClipBound, uTranslation + uChunkDataSize));
vec3 vertexPosition1 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2]);
vec3 vertexPosition2 = mix(cornerA, cornerB, boxCornerOffsets[edgeIndex * 2 + 1]);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){Ds(i,e,1)},draw(i,e,t){const{gl:n}=i,s=sk,{chunkLayout:r}=e;zt(s,t.viewProjectionMat,r.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,s),n.uniform3fv(i.uniform("uChunkDataSize"),r.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=r.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,u=rk;for(let h=0;h<3;++h){const g=c[h];u[h]=(g===-1?0:l[g])*o[h]}n.uniform3fv(i.uniform("uTranslation"),u),Ls(n,Yv,1)}},xB={defineShader(i){_u(i),ok(i),ks(i),i.setVertexMain(`
int vertexIndex1 = gl_VertexID / ${dr};
int vertexIndex2 = vertexIndex1 == 5 ? 0 : vertexIndex1 + 1;
vec3 vertexPosition1 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex1);
vec3 vertexPosition2 = getBoundingBoxPlaneIntersectionVertexPosition(uChunkDataSize, uTranslation, uLowerClipBound, uUpperClipBound, vertexIndex2);
emitLine(uProjectionMatrix * vec4(vertexPosition1, 1.0),
         uProjectionMatrix * vec4(vertexPosition2, 1.0),
         2.0);
`)},initialize(i,e){Ds(i,e,1)},draw(i,e,t){const{gl:n}=i,s=sk,{chunkLayout:r}=e;zt(s,t.viewProjectionMat,r.transform),n.uniformMatrix4fv(i.uniform("uProjectionMatrix"),!1,s),n.uniform3fv(i.uniform("uChunkDataSize"),r.size),n.uniform3fv(i.uniform("uLowerClipBound"),e.lowerClipDisplayBound),n.uniform3fv(i.uniform("uUpperClipBound"),e.upperClipDisplayBound);const o=r.size,{curPositionInChunks:l,chunkDisplayDimensionIndices:c}=e,u=rk;for(let h=0;h<3;++h){const g=c[h];u[h]=(g===-1?0:l[g])*o[h]}n.uniform3fv(i.uniform("uTranslation"),u),jv(i,t.viewportNormalInGlobalCoordinates,t.centerDataPosition,r.transform,r.invTransform),Ls(n,6,1)}};var EB=Object.defineProperty,TB=Object.getOwnPropertyDescriptor,kB=(i,e,t,n)=>{for(var s=n>1?void 0:n?TB(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&EB(e,t,s),s};const LB=Ve();function DB(i){if(i!==void 0)return e=>{const{relatedSegments:t}=e;if(t===void 0)return!1;for(let n=0,s=t.length;n<s;++n){const r=i[n];if(r==null)continue;const{visibleSegments:o,segmentEquivalences:l}=r.segmentationGroupState.value;for(const c of t[n])if(o.has(l.get(c)))return!0}return!1}}function IB(i,e){const t=new SR(i.annotationPropertySerializers);for(const n of i)(e===void 0||e(n))&&t.add(n);return t.serialize()}let im=class extends Ac(Oc){constructor(i,e,t,n){super(n),this.chunkManager=i,this.source=e,this.segmentationStates=t,this.initializeCounterpart(this.chunkManager.rpc,{chunkManager:this.chunkManager.rpcId,source:e.rpcId,segmentationStates:this.serializeDisplayState()});const s=()=>{const r={id:this.rpcId,segmentationStates:this.serializeDisplayState()};this.rpc.invoke(a2,r)};this.registerDisposer(t.changed.add(s))}serializeDisplayState(){const{value:i}=this.segmentationStates;if(i!==void 0)return i.map(e=>e==null?e:TT(e.segmentationGroupState.value))}};im=kB([li(o2)],im);class PB extends K{constructor(e,t){super(),this.chunkManager=e,this.state=t,this.layerChunkProgressInfo=new fh,this.numPickIds=0,this.generation=-1,this.redrawNeeded=new ue,this.serializedAnnotations=void 0,this.handleChangeAffectingBuffer=()=>{this.generation=-1,this.redrawNeeded.dispatch()},this.segmentationStates=this.registerDisposer(Ht((s,r)=>{const{displayState:o,source:l}=this.state,{relationshipStates:c}=o;return o.displayUnfiltered.value?void 0:l.relationships.map(u=>{const h=c.get(u);return h.showMatches.value?h.segmentationState.value:void 0})},[this.state.displayState.relationshipStates,this.state.displayState.ignoreNullSegmentFilter],(s,r)=>s===void 0||r===void 0?s===r:De(s,r))),this.registerDisposer(t),this.registerDisposer(this.source.changed.add(this.handleChangeAffectingBuffer)),this.registerDisposer(Ti((s,r)=>{if(this.handleChangeAffectingBuffer(),r!==void 0)for(const o of r)o!=null&&s.registerDisposer(ca((l,c)=>{l.registerDisposer(c.visibleSegments.changed.add(()=>this.handleChangeAffectingBuffer())),l.registerDisposer(c.segmentEquivalences.changed.add(()=>this.handleChangeAffectingBuffer()))},o.segmentationGroupState))},this.segmentationStates)),this.source instanceof ha||(this.sharedObject=this.registerDisposer(new im(e,this.source,this.segmentationStates,this.layerChunkProgressInfo)));const{displayState:n}=this.state;this.registerDisposer(n.color.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shader.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.shaderControls.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.hoverState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch))}get source(){return this.state.source}get transform(){return this.state.transform}get hoverState(){return this.state.displayState.hoverState}get visibility(){const{sharedObject:e}=this;if(e!==void 0)return e.visibility}get gl(){return this.chunkManager.gl}updateBuffer(){const{source:e}=this;if(e instanceof ha){const t=e.changed.count;if(this.generation!==t){let{buffer:n}=this;n===void 0&&(n=this.buffer=this.registerDisposer(new dn(this.chunkManager.gl))),this.generation=t;const s=this.serializedAnnotations=IB(e,DB(this.segmentationStates.value));n.setData(this.serializedAnnotations.data),this.numPickIds=aE(s)}}}}function ak(i){const{chunkTransform:e}=i,{unpaddedRank:t}=e.modelTransform,n=new Float32Array(t*2),s=new Float32Array(t*3);s.fill(0),n.fill(1,t);const{numChunkDisplayDims:r,chunkDisplayDimensionIndices:o}=i;for(let l=0;l<r;++l){const c=o[l];n[t+c]=0,s[c*3+l]=1}return{modelClipBounds:n,renderSubspaceTransform:s}}function Aw(i,e,t){t.clearMessages();const n=c=>{t.addMessage({severity:ws.error,message:c})};if(i.error!==void 0)return n(i.error);const s=a1(i.modelTransform,e.displayDimensionIndices);let r;try{r=l1(i,s)}catch(c){return n(c.message)}const{modelClipBounds:o,renderSubspaceTransform:l}=ak(r);return{chunkTransform:i,chunkDisplayTransform:r,modelClipBounds:o,renderSubspaceTransform:l}}function qv(i,e){class t extends i{constructor(s,r){super(),this.base=s,this.renderScaleHistogram=r,this.curRank=-1,this.renderHelpers=[],this.isAnnotation=!0;const o=s.visibility;o!==void 0&&this.registerDisposer(o.add(this.visibility)),this.registerDisposer(this.renderScaleHistogram.visibility.add(this.visibility)),this.registerDisposer(()=>{for(const l of this.renderHelpers)l.dispose()}),this.role=s.state.role,this.registerDisposer(s.redrawNeeded.add(this.redrawNeeded.dispatch)),this.handleRankChanged(),this.registerDisposer(this.base.state.displayState.shaderControls.histogramSpecifications.producerVisibility.add(this.visibility))}handleRankChanged(){const{rank:s}=this.base.source;if(s===this.curRank)return;this.curRank=s,this.tempChunkPosition=new Float32Array(s);const{renderHelpers:r,gl:o}=this;for(const u of r)u.dispose();const{properties:l}=this.base.source,{displayState:c}=this.base.state;for(const u of gs){const h=Bl(u),g=h[e],v=r[u]=new g(o,u,s,l,c.shaderControls,c.fallbackShaderControls,c.shaderError);v.pickIdsPerInstance=h.pickIdsPerInstance,v.targetIsSliceView=e==="sliceViewRenderHelper"}}attach(s){super.attach(s),this.handleRankChanged();const{chunkTransform:r}=this,o=s.view.displayDimensionRenderInfo.value;s.state={chunkTransform:r,displayDimensionRenderInfo:o,chunkRenderParameters:Aw(r,o,s.messages)}}updateAttachmentState(s){const r=s.state;this.handleRankChanged();const{chunkTransform:o}=this,l=s.view.displayDimensionRenderInfo.value;return r!==void 0&&r.chunkTransform===o&&r.displayDimensionRenderInfo===l?r.chunkRenderParameters:(r.chunkTransform=o,r.displayDimensionRenderInfo=l,r.chunkRenderParameters=Aw(o,l,s.messages))}get chunkTransform(){return this.base.state.chunkTransform.value}updateModelClipBounds(s,r){const{modelClipBounds:o}=r,l=this.curRank,{chunkTransform:c}=r;ga(o.subarray(0,l),s.projectionParameters.globalPosition,this.base.state.localPosition.value,c.layerRank,c.combinedGlobalLocalToChunkTransform)}get gl(){return this.base.chunkManager.gl}drawGeometryChunkData(s,r,o,l=1){if(!s.bufferValid){let{buffer:c}=s;c===void 0&&(c=s.buffer=new dn(this.gl));const{serializedAnnotations:u}=s;c.setData(u.data),s.numPickIds=aE(u),s.bufferValid=!0}this.drawGeometry(s,r,o,l)}drawGeometry(s,r,o,l=1){const{base:c}=this,{chunkDisplayTransform:u}=o,{serializedAnnotations:h}=s,{typeToIdMaps:g,typeToOffset:v}=h;let y=0;r.emitPickID&&(y=r.pickIDs.register(this,s.numPickIds,0,0,s));const b=c.hoverState.value,w=zt(LB,r.projectionParameters.viewProjectionMat,u.displaySubspaceModelMatrix),C={annotationLayer:c,renderContext:r,selectedIndex:0,basePickId:y,buffer:s.buffer,bufferOffset:0,count:0,modelViewProjectionMatrix:w,modelClipBounds:o.modelClipBounds,subspaceMatrix:o.renderSubspaceTransform,renderSubspaceModelMatrix:u.displaySubspaceModelMatrix,renderSubspaceInvModelMatrix:u.displaySubspaceInvModelMatrix,chunkDisplayTransform:u},E=this.base.state.displayState.shaderControls.histogramSpecifications.visibleHistograms>0;for(const k of gs){const D=g[k];let A=D.size;if(A>0){const N=Bl(k);let I=4294967295;if(b!==void 0){const O=D.get(b.id);O!==void 0&&(I=O*N.pickIdsPerInstance)}A=Math.round(A*l),C.count=A,C.bufferOffset=v[k],C.selectedIndex=I;const P=this.renderHelpers[k];P.draw(C),E&&(P.computeHistograms(C,r.frameNumber),r.bindFramebuffer()),C.basePickId+=A*N.pickIdsPerInstance}}}updateMouseState(s,r,o,l){const c=l,{serializedAnnotations:u}=c,{typeToIds:h,typeToOffset:g}=u,v=this.curRank,y=this.chunkTransform;if(y.error===void 0)for(const b of gs){const w=h[b],C=Bl(b),{pickIdsPerInstance:E}=C;if(o<w.length*E){const k=Math.floor(o/E),D=w[k],A=o%E;s.pickedAnnotationId=D,s.pickedAnnotationLayer=this.base.state,s.pickedOffset=A,s.pickedAnnotationBuffer=u.data.buffer,s.pickedAnnotationType=b,s.pickedAnnotationBufferBaseOffset=u.data.byteOffset+g[b],s.pickedAnnotationIndex=k,s.pickedAnnotationCount=w.length;const N=this.tempChunkPosition,{chunkToLayerTransform:I,combinedGlobalLocalToChunkTransform:P,layerRank:O}=y,{globalToRenderLayerDimensions:_}=y.modelTransform,{position:W}=s;if(!ga(N,W,this.base.state.localPosition.value,O,P))return;const U=this.base.source.annotationPropertySerializers[b];C.snapPosition(N,s.pickedAnnotationBuffer,s.pickedAnnotationBufferBaseOffset+s.pickedAnnotationIndex*U.propertyGroupBytes[0],A);const j=_.length;for(let B=0;B<j;++B){const H=_[B];if(H===-1)continue;let V=I[(v+1)*v+H];for(let re=0;re<v;++re)V+=N[re]*I[re*(O+1)+H];Number.isFinite(V)&&(W[B]=V)}return}o-=w.length*E}}transformPickedValue(s){const{pickedAnnotationBuffer:r}=s;if(r===void 0)return;const{properties:o}=this.base.source;if(o.length===0)return;const{pickedAnnotationBufferBaseOffset:l,pickedAnnotationType:c,pickedAnnotationIndex:u,pickedAnnotationCount:h}=s,{annotationPropertySerializers:g}=this.base.source,v=new Array(o.length);return g[c].deserialize(new DataView(r),l,u,h,_n.LITTLE===Na,v),lR(o[0],v[0])}}return t}const lk=i=>class extends i{constructor(){super(...arguments),this.layerChunkProgressInfo=this.base.layerChunkProgressInfo}draw(t,n){const s=this.updateAttachmentState(n);if(this.curRank===0||s===void 0)return;this.updateModelClipBounds(t,s);const{source:r}=this.base;if(r instanceof ha){const{base:o}=this;o.updateBuffer(),this.drawGeometry(o,t,s)}else{const{renderScaleHistogram:o}=this;o.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber),this.drawGeometryChunkData(r.temporary.data,t,s);const{value:l}=this.base.segmentationStates;let c=0,u=0;if(l!==void 0)for(let h=0,g=l.length;h<g;++h){const v=l[h];if(v==null)continue;const y=r.segmentFilteredSources[h].chunks;Ca(v.segmentationGroupState.value,b=>{const w=$i(b),C=y.get(w);if(C!==void 0&&C.state===je.GPU_MEMORY){const{data:E}=C;if(E===void 0)return;this.drawGeometryChunkData(E,t,s),++c}else++u})}o.add(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,c,u)}}isReady(){const{base:t}=this,{source:n}=t;if(!(n instanceof Bc))return!0;const{value:s}=this.base.segmentationStates;if(s===void 0)return!0;for(let r=0,o=s.length;r<o;++r){const l=s[r];if(l===null)return!1;if(l===void 0)continue;const c=n.segmentFilteredSources[r].chunks;let u=!1;if(Ca(l.segmentationGroupState.value,h=>{const g=$i(h);c.has(g)||(u=!0)}),u)return!1}return!0}},ck=qv(co,"perspectiveViewRenderHelper");class AB extends lk(ck){}const dk=i=>{class e extends i{constructor(n){super(n.annotationLayer,n.renderScaleHistogram),this.wireFrameRenderHelper=this instanceof Zr?xB:CB,this.wireFrameShaderGetter=Kr(this,this.gl,{memoizeKey:`annotation/wireFrameShader:${this instanceof Zr}`,parameters:ar(void 0),defineShader:o=>{this.wireFrameRenderHelper.defineShader(o)}}),this.renderScaleTarget=n.renderScaleTarget,this.registerDisposer(this.renderScaleTarget.changed.add(this.redrawNeeded.dispatch));const s=this.registerDisposer(new Oc(this.layerChunkProgressInfo)),r=this.base.chunkManager.rpc;s.RPC_TYPE_ID=s2,s.initializeCounterpart(r,{chunkManager:this.base.chunkManager.rpcId,localPosition:this.registerDisposer(Tt.makeFromExisting(r,this.base.state.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Tt.makeFromExisting(r,this.renderScaleTarget)).rpcId}),this.backend=s}attach(n){super.attach(n),n.state.sources=n.registerDisposer(Ti((s,r,o)=>{const l=Dh(o,r,c=>this.base.state.source.getSources(c),n.messages,this);for(const c of l)for(const u of c)s.registerDisposer(u.source),Object.assign(u,ak(u.chunkDisplayTransform));return n.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(r2,{layer:this.backend.rpcId,view:n.view.rpcId,displayDimensionRenderInfo:o,sources:Lh(l)}),this.redrawNeeded.dispatch(),l},this.base.state.transform,n.view.displayDimensionRenderInfo))}draw(n,s){const r=this.updateAttachmentState(s);if(this.curRank===0||r===void 0)return;const o=s.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(n,r);const{renderScaleHistogram:l}=this;l.begin(this.base.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const{projectionParameters:c}=n;let u;if(n.wireFrame){const{shader:h}=this.wireFrameShaderGetter(n.emitter);if(h===null)return;h.bind(),this.wireFrameRenderHelper.initialize(h,c),u=h}mb(c,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(h,g,v,y,b)=>{const w=h.source.chunks.get(h.curPositionInChunks.join());let C;if(w===void 0||w.state!==je.GPU_MEMORY)C=0;else{const{data:E}=w;if(E===void 0)return;u!==void 0?this.wireFrameRenderHelper.draw(u,h,c):this.drawGeometryChunkData(E,n,r,v),C=1}l.add(y,b,C,1-C)})}isReady(n,s){const r=this.updateAttachmentState(s);if(this.curRank===0||r===void 0)return;const o=s.state.sources.value;if(o.length===0)return;this.updateModelClipBounds(n,r);const{projectionParameters:l}=n;let c=!0;return mb(l,this.base.state.localPosition.value,this.renderScaleTarget.value,o[0],()=>{},(u,h,g,v,y)=>{const b=u.source.chunks.get(u.curPositionInChunks.join());if(b===void 0||b.state!==je.GPU_MEMORY){c=!1;return}}),c}}return e},RB=dk(ck),NB=dk(qv(Zr,"sliceViewRenderHelper")),MB=lk(qv(Zr,"sliceViewRenderHelper")),Bu=new Ne(0);window.addEventListener("keydown",i=>{Bu.value=kv(i)});window.addEventListener("keyup",i=>{Bu.value=kv(i)});const OB=new Set(["f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","escape","pause"]),_B=new Set(["color","date","datetime","datetime-local","email","month","number","password","search","tel","text","time","url","week"]);class Pi extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.modifierShortcutsAreGlobal=!0,this.allShortcutsAreGlobal=!1,this.allowSpaceKeyOnButtons=!1,this.shouldIgnore=void 0,this.registerEventListener(e,"keydown",this.handleKeyDown.bind(this),!1)}shouldIgnoreEvent(e,t){var l;if((l=this.shouldIgnore)!=null&&l.call(this,t))return!0;const n=t.target,{tagName:s}=n;if(n===this.target)return!1;const r=s==="TEXTAREA"||s==="INPUT"||s==="BUTTON"||s==="SELECT",o=!r&&(n.isContentEditable||n.ownerDocument&&n.ownerDocument.designMode==="on");return!r&&!o||this.allShortcutsAreGlobal||OB.has(e)?!1:o||this.modifierShortcutsAreGlobal&&(t.altKey||t.ctrlKey||t.metaKey)?!0:s==="INPUT"&&_B.has(n.type)?e!=="enter":s==="INPUT"||s==="BUTTON"?this.allowSpaceKeyOnButtons?!1:e==="space":!0}handleKeyDown(e){const t=VB(e);this.shouldIgnoreEvent(t,e)||PE(t,e,e,this.eventMap)}}function VB(i){return i.code.toLowerCase()}const Fu=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="plusIconTitle">
    <title id="plusIconTitle">Plus</title>    
    <path d="M20 12L4 12M12 4L12 20"/>
</svg>`;function uk(i={}){return $e({svg:Fu,...i})}const BB=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="binIconTitle">
    <title id="binIconTitle">Bin</title>    
    <path d="M19 6L5 6M14 5L10 5M6 10L6 20C6 20.6666667 6.33333333 21 7 21 7.66666667 21 11 21 17 21 17.6666667 21 18 20.6666667 18 20 18 19.3333333 18 16 18 10"/>
</svg>`;function vs(i={}){const e=$e({svg:BB,...i}),t=e.firstElementChild;return t.style.fill="white",e}const Rw=10,Ud=.5;class FB{constructor(){this.anchorIndex=0,this.anchorClientOffset=0}splice(e){let{anchorIndex:t}=this,n=0;for(const s of e){if(n+=s.retainCount,t<n)break;const{deleteCount:r}=s;if(t<n+r){t=n;break}const{insertCount:o}=s;t=t-r+o,n+=o-o}this.anchorIndex=t}}class Nw{constructor(){this.startIndex=0,this.endIndex=0,this.anchorIndex=0,this.anchorOffset=0,this.scrollOffset=0,this.viewportWidth=0}}class UB{constructor(){this.itemSize=[],this.totalKnownSize=0,this.numItemsInTotalKnownSize=0}get averageSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize}getEstimatedSize(e){return this.itemSize[e]??this.averageSize}getEstimatedTotalSize(){return this.totalKnownSize/this.numItemsInTotalKnownSize*this.itemSize.length}getEstimatedOffset(e,t=0,n=0){for(;t<e;++t)n+=this.getEstimatedSize(t);for(;t>e;--t)n-=this.getEstimatedSize(t-1);return n}getRangeSize(e,t){let n=0;const{itemSize:s,averageSize:r}=this;for(let o=e;o<t;++o)n+=s[o]??r;return n}splice(e){let{itemSize:t}=this;t=this.itemSize=LP(t,e),this.totalKnownSize=t.reduce((n,s)=>n+s,0),this.numItemsInTotalKnownSize=t.reduce(n=>n+1,0)}}function zB(i,e,t,n,s,r){const{anchorIndex:o,anchorClientOffset:l}=r,c=s.getEstimatedOffset(o);let u,h,g,v,y;if(n===0||s.totalKnownSize===0)u=Math.max(0,o-Rw/2),h=Math.min(t,u+Rw),y=o,g=0,v=l;else{const b=s.getEstimatedTotalSize(),w=Math.max(0,b-n);v=c-l,v=Math.max(0,Math.min(w,v));const C=v-2*Ud*n,E=v-Ud*n,k=v+n+Ud*n,D=c-l+n+2*Ud*n;u=Math.min(t,e.startIndex);let A=s.getEstimatedOffset(u,o,c);if(A<C)for(;u+1<t;++u){const I=s.getEstimatedSize(u);if(A+I>=E)break;A+=I}if(A>=E)for(;A>C&&u>0;--u){const I=s.getEstimatedSize(u-1);A-=I}h=Math.min(t,e.endIndex);let N=s.getEstimatedOffset(h,o,c);if(N<k)for(;N<=D&&h+1<=t;++h){const I=s.getEstimatedSize(h);N+=I}else if(N>=D)for(;h>u;--h){const I=s.getEstimatedSize(h-1);if(N-I<k)break;N-=I}for(y=o,g=c;y<u;++y){const I=s.getEstimatedSize(y);g+=I}for(;y>h;--y){const I=s.getEstimatedSize(y-1);g-=I}}i.startIndex=u,i.endIndex=h,i.anchorIndex=y,i.anchorOffset=g,i.scrollOffset=v}function GB(i,e){const t=e.getEstimatedOffset(i.anchorIndex),n=i.anchorOffset;i.anchorOffset=t,i.scrollOffset+=t-n}function $B(i,e){return i.startIndex<e.startIndex||i.endIndex>e.endIndex||i.viewportWidth!==0&&e.viewportWidth===0}class Uu extends K{constructor(e){super(),this.element=document.createElement("div"),this.scrollContent=document.createElement("div"),this.header=document.createElement("div"),this.body=document.createElement("div"),this.topItems=document.createElement("div"),this.bottomItems=document.createElement("div"),this.renderedItems=[],this.renderGeneration=-1,this.listGeneration=-1,this.newRenderedItems=[],this.state=new FB,this.renderParams=new Nw,this.newRenderParams=new Nw,this.sizes=new UB,this.debouncedUpdateView=this.registerCancellable(et(()=>this.updateView())),this.resizeObserver=new ResizeObserver(()=>this.updateView());const{selectedIndex:t}=e;t!==void 0&&(this.state.anchorIndex=t,this.state.anchorClientOffset=0);const n=this.source=e.source;this.sizes.itemSize.length=n.length;const{element:s,header:r,body:o,scrollContent:l,topItems:c,bottomItems:u}=this;this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.disconnect()),s.appendChild(l),s.style.overflowAnchor="none",l.appendChild(r),l.appendChild(o),r.style.position="sticky",r.style.zIndex="1",r.style.top="0",e.horizontalScroll?(l.style.width="min-content",l.style.minWidth="100%",r.style.width="min-content",r.style.minWidth="100%",u.style.width="min-content",u.style.minWidth="100%"):(l.style.width="100%",r.style.width="100%",u.style.width="100%"),o.appendChild(c),o.appendChild(u),c.style.width="min-content",c.style.position="relative",c.style.height="0",c.style.minWidth="100%",u.style.height="0",u.style.position="relative",s.addEventListener("scroll",()=>{const h=s.scrollTop;this.state.anchorClientOffset=this.renderParams.anchorOffset-h,this.renderParams.scrollOffset=h,this.debouncedUpdateView()}),n.changed!==void 0&&this.registerDisposer(n.changed.add(h=>{this.sizes.splice(h),this.state.splice(h),this.renderedItems.length=0,this.debouncedUpdateView()})),n.renderChanged!==void 0&&this.registerDisposer(n.renderChanged.add(this.debouncedUpdateView))}updateView(){const{element:e}=this,t=e.clientHeight-this.header.offsetHeight,n=e.clientWidth,{source:s,state:r,sizes:o}=this,l=s.length,{body:c,topItems:u,bottomItems:h}=this,{changed:g,renderChanged:v}=s;let y;for(;;){y=this.newRenderParams;const C=this.renderParams;zB(y,C,l,t,o,r),y.viewportWidth=n;let E;if(v!==void 0&&v.count!==this.renderGeneration||g!==void 0&&g.count!==this.listGeneration?(this.renderGeneration=v===void 0?-1:v.count,this.listGeneration=g===void 0?-1:g.count,E=!0,this.renderedItems.length=0):E=!1,!E&&!$B(y,C)){C.scrollOffset=y.scrollOffset,y=C;break}this.renderParams=y,this.newRenderParams=C;const k=this.renderedItems,D=this.newRenderedItems;D.length=0,this.renderedItems=D,this.newRenderedItems=k;const{source:A}=this,{render:N}=A,{startIndex:I,endIndex:P,anchorIndex:O}=y;function*_(W,U){for(let j=W;j<U;++j){let B=k[j];B===void 0&&(B=N.call(A,j)),D[j]=B,yield B}}si(u,_(I,O)),si(h,_(O,P));for(let W=I;W<P;++W){const B=D[W].getBoundingClientRect().height,H=o.itemSize[W];H!==void 0&&(o.totalKnownSize-=H,--o.numItemsInTotalKnownSize),o.itemSize[W]=B,o.totalKnownSize+=B,++o.numItemsInTotalKnownSize}}GB(y,o),r.anchorIndex=y.anchorIndex,r.anchorClientOffset=y.anchorOffset-y.scrollOffset;const b=o.getRangeSize(y.startIndex,y.anchorIndex),w=o.getEstimatedTotalSize()||0;c.style.height=`${w}px`,u.style.top=`${y.anchorOffset-b}px`,h.style.top=`${y.anchorOffset}px`,e.scrollTop=y.scrollOffset}getItemElement(e){return this.renderedItems[e]}forEachRenderedItem(e){const{startIndex:t,endIndex:n}=this.renderParams,{renderedItems:s}=this;for(let r=t;r<n;++r){const o=s[r];o!==void 0&&e(o,r)}}scrollToTop(){this.state.anchorIndex=0,this.state.anchorClientOffset=0,this.debouncedUpdateView()}scrollItemIntoView(e){const t=this.sizes.getEstimatedOffset(e),n=t+this.sizes.getEstimatedSize(e),s=this.element.scrollTop;if(t<s)this.state.anchorIndex=e,this.state.anchorClientOffset=0;else if(t>s&&n>s+this.element.offsetHeight)this.state.anchorIndex=e+1,this.state.anchorClientOffset=this.element.offsetHeight;else return;this.debouncedUpdateView()}disposed(){gt(this.element)}}class hk extends K{constructor(){super(...arguments),this.changed=new ue,this.isLoadingChanged=new ue,this.states=[],this.relationships=[],this.loadingCount=0}get value(){return this.states}get isLoading(){return this.loadingCount!==0}markLoading(){return this.loadingCount++,()=>{--this.loadingCount===0&&this.isLoadingChanged.dispatch()}}sort(){this.states.sort((e,t)=>{const n=e.sourceIndex-t.sourceIndex;return n!==0?n:e.subsourceIndex-t.subsourceIndex})}updateRelationships(){const e=new Set;for(const t of this.states)for(const n of t.source.relationships)e.add(n);this.relationships=Array.from(e)}add(e){return this.states.push(e),this.sort(),this.updateRelationships(),this.changed.dispatch(),()=>{const t=this.states.indexOf(e);this.states.splice(t,1),this.updateRelationships(),this.changed.dispatch()}}}function WB(i,e){switch(e.type){case st.AXIS_ALIGNED_BOUNDING_BOX:case st.LINE:Hx(i,e.pointA,e.pointB),IR(i,i,.5);break;case st.POINT:i.set(e.point);break;case st.ELLIPSOID:i.set(e.center);break}}function fk(i,e,t){e.error===void 0&&i.setLayerPosition(e.modelTransform,t)}function pk(i,e,t){const{layerRank:n}=e,s=new Float32Array(n);In[i.type].visitGeometry(i,(r,o)=>{s.set(r);const l=new Float32Array(n);(o?Gx:ps)(l,e.chunkToLayerTransform,n+1,s,n),t(l,o)})}class gk extends ci{constructor(e,t){super(),this.layer=e,this.displayState=t,this.previousSelectedState=void 0,this.previousHoverId=void 0,this.previousHoverAnnotationLayerState=void 0,this.virtualListSource={length:0,render:v=>this.render(v),changed:new Ze},this.virtualList=new Uu({source:this.virtualListSource}),this.listElements=[],this.updated=!1,this.mutableControls=document.createElement("div"),this.headerRow=document.createElement("div"),this.attachedAnnotationStates=new Map,this.forceUpdateView=()=>{this.updated=!1,this.updateView()},this.globalDimensionIndices=[],this.localDimensionIndices=[],this.curCoordinateSpaceGeneration=-1,this.prevCoordinateSpaceGeneration=-1,this.columnWidths=[],this.gridTemplate="",this.selectedAnnotationState=ni((v,y)=>{var k;if(v===void 0)return;const{layer:b}=this,w=(k=v.layers.find(D=>D.layer===b))==null?void 0:k.state;if(w===void 0)return;const{annotationId:C}=w;if(C===void 0)return;const E=this.annotationStates.states.find(D=>D.sourceIndex===w.annotationSourceIndex&&(w.annotationSubsource===void 0||D.subsourceId===w.annotationSubsource));if(E!==void 0)return{annotationId:C,annotationLayerState:E,pin:y}},this.layer.manager.root.selectionState,this.layer.manager.root.selectionState.pin),this.element.classList.add("neuroglancer-annotation-layer-view"),this.registerDisposer(this.visibility.changed.add(()=>this.updateView())),this.registerDisposer(this.annotationStates.changed.add(()=>this.updateAttachedAnnotationLayerStates())),this.headerRow.classList.add("neuroglancer-annotation-list-header");const n=document.createElement("div");n.className="neuroglancer-annotation-toolbox",e.initializeAnnotationLayerViewTab(this);const s=this.registerDisposer(new Nv(this.displayState.color));s.element.title="Change annotation display color",this.registerDisposer(new Wn(ni(v=>v.match(/\bdefaultColor\b/)!==null,t.shaderControls.processedFragmentMain),s.element)),n.appendChild(s.element);const{mutableControls:r}=this,o=$e({text:In[st.POINT].icon,title:"Annotate point",onClick:()=>{this.layer.tool.value=new wk(this.layer,{})}});r.appendChild(o);const l=$e({text:In[st.AXIS_ALIGNED_BOUNDING_BOX].icon,title:"Annotate bounding box",onClick:()=>{this.layer.tool.value=new Kv(this.layer,{})}});r.appendChild(l);const c=$e({text:In[st.LINE].icon,title:"Annotate line",onClick:()=>{this.layer.tool.value=new Hh(this.layer,{})}});r.appendChild(c);const u=$e({text:In[st.ELLIPSOID].icon,title:"Annotate ellipsoid",onClick:()=>{this.layer.tool.value=new Ek(this.layer,{})}});r.appendChild(u),n.appendChild(r),this.element.appendChild(n),this.element.appendChild(this.headerRow);const{virtualList:h}=this;h.element.classList.add("neuroglancer-annotation-list"),this.element.appendChild(h.element),this.virtualList.element.addEventListener("mouseleave",()=>{this.displayState.hoverState.value=void 0});const g=S_();this.registerDisposer(new ji(this.virtualList.element,g)),this.virtualList.element.title=g.describe(),this.registerDisposer(this.displayState.hoverState.changed.add(()=>this.updateHoverView())),this.registerDisposer(this.selectedAnnotationState.changed.add(()=>this.updateSelectionView())),this.registerDisposer(this.layer.localCoordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.registerDisposer(this.layer.manager.root.coordinateSpace.changed.add(()=>{this.updateCoordinateSpace(),this.updateView()})),this.updateCoordinateSpace(),this.updateAttachedAnnotationLayerStates(),this.updateSelectionView()}get annotationStates(){return this.layer.annotationStates}updateAttachedAnnotationLayerStates(){const e=this.annotationStates.states,{attachedAnnotationStates:t}=this,n=new Map;for(const[s,r]of t)e.includes(s)||(t.delete(s),r.refCounted.dispose());for(const s of e){const r=t.get(s);if(r!==void 0){n.set(s,r);continue}const o=s.source,l=new K;o instanceof ha&&(l.registerDisposer(o.childAdded.add(c=>this.addAnnotationElement(c,s))),l.registerDisposer(o.childUpdated.add(c=>this.updateAnnotationElement(c,s))),l.registerDisposer(o.childDeleted.add(c=>this.deleteAnnotationElement(c,s)))),l.registerDisposer(s.transform.changed.add(this.forceUpdateView)),n.set(s,{refCounted:l,annotations:[],idToIndex:new Map,listOffset:0})}this.attachedAnnotationStates=n,t.clear(),this.updateCoordinateSpace(),this.forceUpdateView()}updateCoordinateSpace(){const e=this.layer.localCoordinateSpace.value,t=this.layer.manager.root.coordinateSpace.value,n=[],s=[];for(let r=0,o=t.rank;r<o;++r)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.globalToRenderLayerDimensions[r]!==-1})&&n.push(r);for(let r=0,o=e.rank;r<o;++r)this.annotationStates.states.some(l=>{const c=l.transform.value;return c.error!==void 0?!1:c.localToRenderLayerDimensions[r]!==-1})&&s.push(r);(!De(n,this.globalDimensionIndices)||!De(s,this.localDimensionIndices))&&(this.localDimensionIndices=s,this.globalDimensionIndices=n,++this.curCoordinateSpaceGeneration)}getRenderedAnnotationListElement(e,t,n=!1){const s=this.attachedAnnotationStates.get(e);if(s===void 0)return;const r=s.idToIndex.get(t);if(r===void 0)return;const o=s.listOffset+r;return n&&this.virtualList.scrollItemIntoView(r),this.virtualList.getItemElement(o)}clearSelectionClass(){const{previousSelectedState:e}=this;if(e===void 0)return;this.previousSelectedState=void 0;const t=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId);t!==void 0&&t.classList.remove("neuroglancer-annotation-selected")}clearHoverClass(){const{previousHoverId:e,previousHoverAnnotationLayerState:t}=this;if(t!==void 0){this.previousHoverAnnotationLayerState=void 0,this.previousHoverId=void 0;const n=this.getRenderedAnnotationListElement(t,e);n!==void 0&&n.classList.remove("neuroglancer-annotation-hover")}}updateSelectionView(){const e=this.selectedAnnotationState.value,{previousSelectedState:t}=this;if(t===e||t!==void 0&&e!==void 0&&t.annotationId===e.annotationId&&t.annotationLayerState===e.annotationLayerState&&t.pin===e.pin||(this.clearSelectionClass(),this.previousSelectedState=e,e===void 0))return;const n=this.getRenderedAnnotationListElement(e.annotationLayerState,e.annotationId,e.pin);n!==void 0&&n.classList.add("neuroglancer-annotation-selected")}updateHoverView(){const e=this.displayState.hoverState.value;let t,n;e!==void 0&&(t=e.id,n=e.annotationLayerState);const{previousHoverId:s,previousHoverAnnotationLayerState:r}=this;if(t===s&&n===r||(this.clearHoverClass(),this.previousHoverId=t,this.previousHoverAnnotationLayerState=n,t===void 0))return;const o=this.getRenderedAnnotationListElement(n,t);o!==void 0&&o.classList.add("neuroglancer-annotation-hover")}render(e){const{annotation:t,state:n}=this.listElements[e];return this.makeAnnotationListElement(t,n)}setColumnWidth(e,t){t+=2;const{columnWidths:n}=this;n[e]>t||(n[e]=t,this.element.style.setProperty(`--neuroglancer-column-${e}-width`,`${t}ch`))}updateView(){if(!this.visible)return;if(this.curCoordinateSpaceGeneration!==this.prevCoordinateSpaceGeneration){this.updated=!1;const{columnWidths:s}=this;s.length=0;const{headerRow:r}=this,o=document.createElement("div");o.style.gridColumn="symbol";const l=document.createElement("div");l.style.gridColumn="delete",Fe(r),r.appendChild(o);let c=0,u="[symbol] 2ch";const h=(y,b)=>{const w=document.createElement("div");w.classList.add("neuroglancer-annotations-view-dimension");const C=document.createElement("span");C.classList.add("neuroglancer-annotations-view-dimension-name"),C.textContent=y.names[b];const E=document.createElement("scale");E.classList.add("neuroglancer-annotations-view-dimension-scale"),E.textContent=qr(y.scales[b],y.units[b],{precision:2}),w.appendChild(C),w.appendChild(E),w.style.gridColumn=`dim ${c+1}`,this.setColumnWidth(c,E.textContent.length+C.textContent.length+3),u+=` [dim] var(--neuroglancer-column-${c}-width)`,++c,r.appendChild(w)},g=this.layer.manager.root.coordinateSpace.value;for(const y of this.globalDimensionIndices)h(g,y);const v=this.layer.localCoordinateSpace.value;for(const y of this.localDimensionIndices)h(v,y);r.appendChild(l),u+=" [delete] 2ch",this.gridTemplate=u,r.style.gridTemplateColumns=u,this.prevCoordinateSpaceGeneration=this.curCoordinateSpaceGeneration}if(this.updated)return;let e=!1;const{listElements:t}=this;t.length=0;for(const[s,r]of this.attachedAnnotationStates){if(s.source.readonly||(e=!0),s.chunkTransform.value.error!==void 0)continue;const{source:o}=s,l=Array.from(o);r.annotations=l;const{idToIndex:c}=r;c.clear();for(let u=0,h=l.length;u<h;++u)c.set(l[u].id,u);for(const u of l)t.push({state:s,annotation:u})}const n=this.virtualListSource.length;this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:0,deleteCount:n,insertCount:t.length}]),this.mutableControls.style.display=e?"contents":"none",this.resetOnUpdate()}updateListLength(){let e=0;for(const t of this.attachedAnnotationStates.values())t.listOffset=e,e+=t.annotations.length;this.virtualListSource.length=e}addAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const s=n.annotations.length;n.annotations.push(e),n.idToIndex.set(e.id,s);const r=n.listOffset+s;this.listElements.splice(r,0,{state:t,annotation:e}),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:0,insertCount:1}])}this.resetOnUpdate()}updateAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const s=n.idToIndex.get(e.id);if(s!==void 0){const r=n.listOffset+s;n.annotations[s]=e,this.listElements[r].annotation=e,this.virtualListSource.changed.dispatch([{retainCount:r,deleteCount:1,insertCount:1}])}}this.resetOnUpdate()}deleteAnnotationElement(e,t){if(!this.visible){this.updated=!1;return}if(!this.updated){this.updateView();return}const n=this.attachedAnnotationStates.get(t);if(n!==void 0){const{idToIndex:s}=n,r=s.get(e);if(r!==void 0){const o=n.listOffset+r,{annotations:l}=n;l.splice(r,1),s.delete(e);for(let c=r,u=l.length;c<u;++c)s.set(l[c].id,c);this.listElements.splice(o,1),this.updateListLength(),this.virtualListSource.changed.dispatch([{retainCount:o,deleteCount:1,insertCount:0}])}}this.resetOnUpdate()}resetOnUpdate(){this.clearHoverClass(),this.clearSelectionClass(),this.updated=!0,this.updateHoverView(),this.updateSelectionView()}makeAnnotationListElement(e,t){const n=t.chunkTransform.value,s=document.createElement("div");s.classList.add("neuroglancer-annotation-list-entry"),s.dataset.color=t.displayState.color.toString(),s.style.gridTemplateColumns=this.gridTemplate;const r=document.createElement("div");r.className="neuroglancer-annotation-icon",r.textContent=In[e.type].icon,s.appendChild(r);let o;const l=()=>{t.source.readonly||o===void 0&&(o=vs({title:"Delete annotation",onClick:h=>{h.stopPropagation(),h.preventDefault();const g=t.source.getReference(e.id);try{t.source.delete(g)}finally{g.dispose()}}}),o.classList.add("neuroglancer-annotation-list-entry-delete"),s.appendChild(o))};let c=0;if(pk(e,n,(h,g)=>{++c;const v=document.createElement("div");v.className="neuroglancer-annotation-position",s.appendChild(v);let y=0;const b=(w,C)=>{for(const E of w){const k=C[E];if(k!==-1){const D=Math.floor(h[k]),A=document.createElement("div"),N=D.toString();A.textContent=N,A.classList.add("neuroglancer-annotation-coordinate"),A.style.gridColumn=`dim ${y+1}`,this.setColumnWidth(y,N.length),v.appendChild(A)}++y}};b(this.globalDimensionIndices,n.modelTransform.globalToRenderLayerDimensions),b(this.localDimensionIndices,n.modelTransform.localToRenderLayerDimensions),l()}),e.description){++c;const h=document.createElement("div");h.classList.add("neuroglancer-annotation-description"),h.textContent=e.description,s.appendChild(h)}r.style.gridRow=`span ${c}`,o!==void 0&&(o.style.gridRow=`span ${c}`),s.addEventListener("mouseenter",()=>{this.displayState.hoverState.value={id:e.id,partIndex:0,annotationLayerState:t},this.layer.selectAnnotation(t,e.id,!1)}),s.addEventListener("action:select-position",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,"toggle")}),s.addEventListener("action:pin-annotation",h=>{h.stopPropagation(),this.layer.selectAnnotation(t,e.id,!0)}),s.addEventListener("action:move-to-annotation",h=>{h.stopPropagation(),h.preventDefault();const{layerRank:g}=n,v=new Float32Array(g),y=new Float32Array(g);WB(v,e),ps(y,n.chunkToLayerTransform,g+1,v,g),fk(this.layer,n,y)});const u=this.selectedAnnotationState.value;return u!==void 0&&u.annotationLayerState===t&&u.annotationId===e.id&&s.classList.add("neuroglancer-annotation-selected"),s}}class HB extends ci{constructor(e){super(),this.layer=e,this.layerView=this.registerDisposer(new gk(this.layer,this.layer.annotationDisplayState));const{element:t}=this;t.classList.add("neuroglancer-annotations-tab"),t.appendChild(this.layerView.element)}}function zu(i,e=!1){const t=[],{relationships:n}=i.source,{relationshipStates:s}=i.displayState;for(let r=0,o=n.length;r<o;++r){const l=s.get(n[r]).segmentationState.value;if(l!=null&&l.segmentSelectionState.hasSelectedSegment){t[r]=[l.segmentSelectionState.selectedSegment.clone()],e&&(t[r]=[...t[r],l.segmentSelectionState.baseSelectedSegment.clone()]);continue}t[r]=[]}return t}class mk extends AE{constructor(e,t){super(e)}get annotationLayer(){for(const e of this.layer.annotationStates.states)if(!e.source.readonly)return e}}const vk="annotatePoint",yk="annotateLine",Sk="annotateBoundingBox",bk="annotateSphere";class wk extends mk{trigger(e){const{annotationLayer:t}=this;if(t!==void 0&&e.updateUnconditionally()){const n=oc(e,t);if(n===void 0)return;const s={id:"",description:"",relatedSegments:zu(t),point:n,type:st.POINT,properties:t.source.properties.map(o=>o.default)},r=t.source.add(s,!0);this.layer.selectAnnotation(t,r.id,!0),r.dispose()}}get description(){return"annotate point"}toJSON(){return vk}}function oc(i,e){const t=e.chunkTransform.value;if(t.error!==void 0)return;const n=new Float32Array(t.modelTransform.unpaddedRank);if(ga(n,i.unsnappedPosition,e.localPosition.value,t.layerRank,t.combinedGlobalLocalToChunkTransform))return n}class Ck extends mk{constructor(){super(...arguments),this.inProgressAnnotation=new Ne(void 0)}trigger(e){const{annotationLayer:t,inProgressAnnotation:n}=this;if(t!==void 0&&e.updateUnconditionally()){const s=()=>{const r=n.value,o=r.reference,l=this.getUpdatedAnnotation(o.value,e,t);JSON.stringify(fg(l,t.source))!==JSON.stringify(fg(o.value,t.source))&&(r.annotationLayer.source.update(o,l),this.layer.selectAnnotation(t,o.id,!0))};if(n.value===void 0){const r=t.source.add(this.getInitialAnnotation(e,t),!1);this.layer.selectAnnotation(t,r.id,!0);const o=e.changed.add(s),l=()=>{o(),r.dispose()};n.value={annotationLayer:t,reference:r,disposer:l}}else{s();const r=n.value;r.annotationLayer.source.commit(r.reference),r.disposer(),n.value=void 0}}}disposed(){this.deactivate(),super.disposed()}deactivate(){const e=this.inProgressAnnotation.value;e!==void 0&&(e.annotationLayer.source.delete(e.reference),e.disposer(),this.inProgressAnnotation.value=void 0)}}class xk extends Ck{getInitialAnnotation(e,t){const n=oc(e,t);return{id:"",type:this.annotationType,description:"",pointA:n,pointB:n,properties:t.source.properties.map(s=>s.default)}}getUpdatedAnnotation(e,t,n){const s=oc(t,n);return s===void 0?e:{...e,pointB:s}}}class Kv extends xk{get description(){return"annotate bounding box"}getUpdatedAnnotation(e,t,n){const s=super.getUpdatedAnnotation(e,t,n),{pointA:r,pointB:o}=s,l=r.length;for(let c=0;c<l;++c)r[c]===o[c]&&(o[c]+=1);return s}toJSON(){return Sk}}Kv.prototype.annotationType=st.AXIS_ALIGNED_BOUNDING_BOX;class Hh extends xk{constructor(){super(...arguments),this.getBaseSegment=!1}get description(){return"annotate line"}getInitialAnnotation(e,t){const n=super.getInitialAnnotation(e,t);return this.initialRelationships=n.relatedSegments=zu(t,this.getBaseSegment),n}getUpdatedAnnotation(e,t,n){const s=super.getUpdatedAnnotation(e,t,n),r=this.initialRelationships,o=zu(n,this.getBaseSegment);return r===void 0?s.relatedSegments=o:s.relatedSegments=Array.from(o,(l,c)=>{const u=r[c];return l=l.filter(h=>u.findIndex(g=>X.equal(h,g))===-1),[...u,...l]}),s}toJSON(){return yk}}Hh.prototype.annotationType=st.LINE;class Ek extends Ck{getInitialAnnotation(e,t){const n=oc(e,t);return{type:st.ELLIPSOID,id:"",description:"",segments:zu(t),center:n,radii:Et(0,0,0),properties:t.source.properties.map(s=>s.default)}}getUpdatedAnnotation(e,t,n){const s=oc(t,n);if(s===void 0)return e;const r=e.center,o=r.length;for(let l=0;l<o;++l)s[l]=Math.abs(r[l]-s[l]);return{...e,radii:s}}get description(){return"annotate ellipsoid"}toJSON(){return bk}}$c(vk,(i,e)=>new wk(i,e));$c(Sk,(i,e)=>new Kv(i,e));$c(yk,(i,e)=>new Hh(i,e));$c(bk,(i,e)=>new Ek(i,e));const JB=He.fromObject({enter:{action:"commit"},escape:{action:"cancel"}});function jB(i,e,t,n){return new Vn(t,(s,r,o)=>{const l=document.createElement("div");l.classList.add("neuroglancer-related-segment-list"),s!=null&&o.registerDisposer(rc(s,l));const c=document.createElement("div");c.classList.add("neuroglancer-related-segment-list-header");const u=xs({title:"Copy segment IDs",onClick:()=>{gr(e.map(b=>b.toString()).join(", "))}});c.appendChild(u);let h;if(s!=null&&(h=document.createElement("input"),h.type="checkbox",h.addEventListener("change",()=>{const{visibleSegments:b}=s.segmentationGroupState.value,w=e.some(C=>!b.has(C));for(const C of e)b.set(C,w)}),c.appendChild(h)),n!==void 0){const b=vs({title:"Remove all IDs",onClick:()=>{n([])}});c.appendChild(b)}const g=document.createElement("span");if(g.classList.add("neuroglancer-related-segment-list-title"),g.textContent=i,c.appendChild(g),n!==void 0){const b=uk({title:"Add related segment ID",onClick:()=>{const w=new K,C=o.registerDisposer(dx(w)),E=document.createElement("div");E.classList.add("neuroglancer-segment-list-entry"),E.classList.add("neuroglancer-segment-list-entry-new");const k=xs({});if(k.classList.add("neuroglancer-segment-list-entry-copy"),E.appendChild(k),s!=null){const P=document.createElement("input");P.classList.add("neuroglancer-segment-list-entry-visible-checkbox"),P.type="checkbox",E.appendChild(P)}const D=vs({title:"Cancel adding new segment ID",onClick:()=>{C()}});D.classList.add("neuroglancer-segment-list-entry-delete"),E.appendChild(D);const A=document.createElement("input");A.autocomplete="off",A.spellcheck=!1,A.classList.add("neuroglancer-segment-list-entry-id");const N=w.registerDisposer(new Pi(A,JB));N.allShortcutsAreGlobal=!0;const I=()=>{const P=new X;if(P.tryParseString(A.value))return A.dataset.valid="true",P;A.dataset.valid="false"};I(),A.addEventListener("input",()=>{I()}),A.addEventListener("blur",()=>{const P=I();P!==void 0&&n([...e,P]),C()}),fe(A,"cancel",C),fe(A,"commit",()=>{const P=I();P!==void 0&&n([...e,P]),C()}),E.appendChild(A),l.appendChild(E),A.focus(),w.registerDisposer(()=>{A.value="",E.remove()})}});c.appendChild(b)}l.appendChild(c);const v=[],y=za.make(s??void 0,!1);for(const b of e){const w=y.get(b);if(v.push(w),n!==void 0){const C=vs({title:"Remove ID",onClick:E=>{n(e.filter(k=>!X.equal(k,b))),E.stopPropagation()}});C.classList.add("neuroglancer-segment-list-entry-delete"),w.children[0].appendChild(C)}l.appendChild(w)}if(s!=null){const b=o.registerCancellable(et(()=>{const{visibleSegments:w}=s.segmentationGroupState.value;let C=0;for(const E of e)w.has(E)&&++C;for(const E of v)y.update(E);h.checked=C===e.length&&C>0,h.indeterminate=C>0&&C<e.length}));b(),b.flush(),Ga(s,o,b),o.registerDisposer(s.segmentationGroupState.changed.add(b))}r.appendChild(l)})}const Mw="annotationColor";function Xv(i){class e extends i{constructor(...n){super(...n),this.annotationStates=this.registerDisposer(new hk),this.annotationDisplayState=new J1,this.annotationCrossSectionRenderScaleHistogram=new Ea,this.annotationCrossSectionRenderScaleTarget=Qr(8),this.annotationProjectionRenderScaleHistogram=new Ea,this.annotationProjectionRenderScaleTarget=Qr(8),this.annotationDisplayState.color.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shader.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.shaderControls.changed.add(this.specificationChanged.dispatch),this.tabs.add("annotations",{label:"Annotations",order:10,getter:()=>new HB(this)});let s;const r=()=>{const l=this.isReady;l&&s!==void 0?(s(),s=void 0):!l&&s===void 0&&(s=this.annotationStates.markLoading())};this.readyStateChanged.add(r),r();const{mouseState:o}=this.manager.layerSelectedValues;this.registerDisposer(o.changed.add(()=>{if(o.active){const{pickedAnnotationLayer:l}=o;if(l!==void 0&&this.annotationStates.states.includes(l)){const c=this.annotationDisplayState.hoverState.value;(c===void 0||c.id!==o.pickedAnnotationId||c.partIndex!==o.pickedOffset||c.annotationLayerState!==l)&&(this.annotationDisplayState.hoverState.value={id:o.pickedAnnotationId,partIndex:o.pickedOffset,annotationLayerState:l});return}}this.annotationDisplayState.hoverState.value=void 0}))}initializeAnnotationLayerViewTab(n){}restoreState(n){super.restoreState(n),this.annotationDisplayState.color.restoreState(n[Mw])}captureSelectionState(n,s){super.captureSelectionState(n,s);const r=s.pickedAnnotationLayer;r===void 0||!this.annotationStates.states.includes(r)||(n.annotationId=s.pickedAnnotationId,n.annotationType=s.pickedAnnotationType,n.annotationBuffer=new Uint8Array(s.pickedAnnotationBuffer,s.pickedAnnotationBufferBaseOffset),n.annotationIndex=s.pickedAnnotationIndex,n.annotationCount=s.pickedAnnotationCount,n.annotationPartIndex=s.pickedOffset,n.annotationSourceIndex=r.sourceIndex,n.annotationSubsource=r.subsourceId)}displayAnnotationState(n,s,r){if(n.annotationId===void 0)return!1;const o=this.annotationStates.states.find(c=>c.sourceIndex===n.annotationSourceIndex&&c.subsubsourceId===n.annotationSubsubsourceId&&(n.annotationSubsource===void 0||c.subsourceId===n.annotationSubsource));if(o===void 0)return!1;const l=r.registerDisposer(o.source.getReference(n.annotationId));return s.appendChild(r.registerDisposer(new Vn(r.registerDisposer(new px(()=>({annotation:l,chunkTransform:o.chunkTransform}))),({annotation:c,chunkTransform:u},h,g)=>{let v;if(c==null)if(n.annotationType!==void 0&&n.annotationBuffer!==void 0){const y=In[n.annotationType],b=o.source.rank,w=y.serializedBytes(b),C=n.annotationBuffer.byteOffset,E=new DataView(n.annotationBuffer.buffer),k=_n.LITTLE===Na,{properties:D}=o.source,A=new Vx(b,w,D),N=n.annotationIndex,I=n.annotationCount;c=y.deserialize(E,C+A.propertyGroupBytes[0]*N,k,b,n.annotationId),A.deserialize(E,C,N,I,k,c.properties=new Array(D.length)),o.source.hasNonSerializedProperties()&&(v="Loading...")}else v=c===null?"Annotation not found":"Loading...";if(c!=null){const y=u.error===void 0?u.layerRank:0,b=document.createElement("div");b.classList.add("neuroglancer-selected-annotation-details-position-grid"),b.style.gridTemplateColumns=`[icon] 0fr [copy] 0fr repeat(${y}, [dim] 0fr [coord] 0fr) [move] 0fr [delete] 0fr`,h.appendChild(b);const w=In[c.type],C=document.createElement("div");if(C.className="neuroglancer-selected-annotation-details-icon",C.textContent=w.icon,b.appendChild(C),y!==0){const{layerDimensionNames:O}=u.modelTransform;for(let _=0;_<y;++_){const W=document.createElement("div");W.classList.add("neuroglancer-selected-annotation-details-position-dim"),W.textContent=O[_],W.style.gridColumn=`dim ${_+1}`,b.appendChild(W)}pk(c,u,(_,W)=>{const U=xs({title:"Copy position",onClick:()=>{gr(_.map(j=>Math.floor(j)).join(", "))}});U.style.gridColumn="copy",b.appendChild(U);for(let j=0;j<y;++j){const B=document.createElement("div");B.classList.add("neuroglancer-selected-annotation-details-position-coord"),B.style.gridColumn=`coord ${j+1}`,B.textContent=Math.floor(_[j]).toString(),b.appendChild(B)}if(!W){const j=vT({title:"Move to position",onClick:()=>{fk(this,u,_)}});j.style.gridColumn="move",b.appendChild(j)}})}if(!o.source.readonly){const O=vs({title:"Delete annotation",onClick:()=>{o.source.delete(l)}});O.classList.add("neuroglancer-selected-annotation-details-delete"),b.appendChild(O)}const{relationships:E,properties:k}=o.source,D=o.source.readonly,A=document.createElement("label");A.classList.add("neuroglancer-annotation-property");const N=document.createElement("span");N.classList.add("neuroglancer-annotation-property-label"),N.textContent="ID",A.appendChild(N);const I=document.createElement("span");I.classList.add("neuroglancer-annotation-property-value"),I.textContent=l.id,A.appendChild(I),h.appendChild(A);for(let O=0,_=k.length;O<_;++O){const W=k[O],U=document.createElement("label");U.classList.add("neuroglancer-annotation-property");const j=document.createElement("span");j.classList.add("neuroglancer-annotation-property-label"),j.textContent=W.identifier,U.appendChild(j);const{description:B}=W;B!==void 0&&(U.title=B);const H=c.properties[O],V=document.createElement("span");switch(V.classList.add("neuroglancer-annotation-property-value"),W.type){case"rgb":{const re=na(H),se=Pn(re);V.textContent=se,V.style.backgroundColor=se,V.style.color=rg(re)?"white":"black";break}case"rgba":{const re=na(H);V.textContent=Pn(Hm(H)),V.style.backgroundColor=Pn(na(H)),V.style.color=rg(re)?"white":"black";break}default:V.textContent=Bx(W,H);break}U.appendChild(V),h.appendChild(U)}const{relatedSegments:P}=c;for(let O=0,_=E.length;O<_;++O){const W=P===void 0?[]:P[O];if(W.length===0&&D)continue;const U=O,j=E[O];h.appendChild(g.registerDisposer(jB(j,W,o.displayState.relationshipStates.get(j).segmentationState,D?void 0:B=>{const H=l.value;if(H==null)return;let{relatedSegments:V}=H;V===void 0?V=o.source.relationships.map(()=>[]):V=V.slice(),V[U]=B;const re={...H,relatedSegments:V};o.source.update(l,re),o.source.commit(l)})).element)}if(!o.source.readonly||c.description)if(o.source.readonly){const O=document.createElement("div");O.className="neuroglancer-annotation-details-description",O.textContent=c.description||"",h.appendChild(O)}else{const O=document.createElement("textarea");O.value=c.description||"",O.rows=3,O.className="neuroglancer-annotation-details-description",O.placeholder="Description",O.addEventListener("change",()=>{const _=O.value;o.source.update(l,{...c,description:_||void 0}),o.source.commit(l)}),h.appendChild(O)}}if(v!==void 0){const y=document.createElement("div");y.classList.add("neuroglancer-selection-annotation-status"),y.textContent=v,h.appendChild(y)}})).element),!0}displaySelectionState(n,s,r){let o=this.displayAnnotationState(n,s,r);return super.displaySelectionState(n,s,r)&&(o=!0),o}addLocalAnnotations(n,s,r){const{subsourceEntry:o}=n,l=new wu({localPosition:this.localPosition,transform:n.getRenderLayerTransform(),source:s,displayState:this.annotationDisplayState,dataSource:n.loadedDataSource.layerDataSource,subsourceIndex:n.subsourceIndex,subsourceId:o.id,role:r});this.addAnnotationLayerState(l,n)}addStaticAnnotations(n){const{subsourceEntry:s}=n,{staticAnnotations:r}=s.subsource;return r===void 0?!1:(n.activate(()=>{this.addLocalAnnotations(n,r,fr.DEFAULT_ANNOTATION)}),!0)}addAnnotationLayerState(n,s){const r=s.activated;r.registerDisposer(this.annotationStates.add(n));const o=new PB(this.manager.chunkManager,n.addRef());if(o.source instanceof Bc){const l=new NB({annotationLayer:o.addRef(),renderScaleTarget:this.annotationCrossSectionRenderScaleTarget,renderScaleHistogram:this.annotationCrossSectionRenderScaleHistogram});r.registerDisposer(s.messages.addChild(l.messages));const c=new RB({annotationLayer:o.addRef(),renderScaleTarget:this.annotationProjectionRenderScaleTarget,renderScaleHistogram:this.annotationProjectionRenderScaleHistogram});r.registerDisposer(s.messages.addChild(c.messages)),r.registerDisposer(Ti((u,h)=>{h&&(u.registerDisposer(this.addRenderLayer(l.addRef())),u.registerDisposer(this.addRenderLayer(c.addRef())))},this.annotationDisplayState.displayUnfiltered))}{const l=new MB(o,this.annotationCrossSectionRenderScaleHistogram);r.registerDisposer(this.addRenderLayer(l)),r.registerDisposer(s.messages.addChild(l.messages))}{const l=new AB(o.addRef(),this.annotationProjectionRenderScaleHistogram);r.registerDisposer(this.addRenderLayer(l)),r.registerDisposer(s.messages.addChild(l.messages))}}selectAnnotation(n,s,r){this.manager.root.selectionState.captureSingleLayerState(this,o=>(o.annotationId=s,o.annotationSourceIndex=n.sourceIndex,o.annotationSubsource=n.subsourceId,o.annotationSubsubsourceId=n.subsubsourceId,!0),r)}toJSON(){const n=super.toJSON();return n[Mw]=this.annotationDisplayState.color.toJSON(),n}}return e}const Qv="selectSegments",sm="mousedown0",YB=He.fromObject({[`at:alt?+shift?+${sm}`]:"drag-select-segments"});class qB extends Va{toJSON(){return Qv}activate(e){const{layer:t}=this,{body:n,header:s}=Ba(e);let r=0,o=!1;e.bindInputEventMap(YB);const l=()=>Bu.value&LE.ALT?2:1,c=v=>{r!==v&&(r=v,o=!1,u())},u=()=>{Fe(n);const v=document.createElement("span");switch(r){case 0:s.textContent="Select/Deselect segments",v.textContent=`${sm} to select segments; alt+${sm} to deselect segments.`;break;case 1:case 2:s.textContent=`${r===1?"Select":"Deselect"} segments`,v.textContent=`Drag to ${r===1?"select":"deselect"} segments (${t.displayState.segmentationGroupState.value.visibleSegments.size} selected).`}n.appendChild(v)};u();const h=()=>{if(r===0)return;const{segmentSelectionState:v}=t.displayState;if(v.hasSelectedSegment){const y=v.selectedSegment,{selectedSegments:b,visibleSegments:w}=t.displayState.segmentationGroupState.value;switch(r){case 1:b.add(y),w.add(y);break;case 2:b.delete(y);break}}};e.registerDisposer(t.displayState.segmentSelectionState.changed.add(()=>{o&&h()})),e.registerDisposer(t.displayState.segmentationGroupState.value.visibleSegments.changed.add(u)),e.registerDisposer(Bu.changed.add(()=>{r!==0&&c(l())}));const g=(v,y)=>{v.stopPropagation(),c(y),h();const b=v.detail.screenX,w=v.detail.screenY;oi(v.detail,(C,E,k)=>{if(!o){const D=C.screenX-b,A=C.screenY-w;D*D+A*A>25&&(h(),o=!0)}},C=>{o=!1,c(0)})};e.bindAction("drag-select-segments",v=>g(v,l()))}get description(){return"select"}}function KB(i){Ji(i,Qv,e=>new qB(e))}const Zv="mergeSegments",ey="splitSegments",XB=He.fromObject({"at:shift?+mousedown0":{action:"merge-segments"},"at:shift?+mousedown2":{action:"set-anchor"}}),QB=He.fromObject({"at:shift?+mousedown0":{action:"split-segments"},"at:shift?+alt+mousedown0":{action:"split-and-select-segments"},"at:shift?+mousedown2":{action:"set-anchor"}});let ZB=class extends Va{constructor(e){super(e),this.lastAnchorBaseSegment=new Ne(void 0);const t=()=>{const n=e.anchorSegment.value;if(n===void 0)return;const{segmentSelectionState:s}=e.displayState;if(!s.hasSelectedSegment)return;const{segmentEquivalences:r}=e.displayState.segmentationGroupState.value,o=r.get(n);if(!X.equal(s.selectedSegment,o))return;const l=s.baseSelectedSegment,c=qd(l),u=r.disjointSets.visibleSegmentEquivalencePolicy.value;u&An.NONREPRESENTATIVE_EXCLUDED&&c||u&An.REPRESENTATIVE_EXCLUDED&&!c||(this.lastAnchorBaseSegment.value=l.clone())};this.registerDisposer(e.displayState.segmentSelectionState.changed.add(t)),this.registerDisposer(e.anchorSegment.changed.add(t))}toJSON(){return Zv}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{const u=this.layer.anchorSegment.value,h=this.lastAnchorBaseSegment.value;if(u===void 0)return{anchorSegment:void 0,error:"Select anchor segment for merge"};const g=t.segmentEquivalences.get(u);return t.visibleSegments.has(g)?h===void 0||!X.equal(t.segmentEquivalences.get(h),g)?{anchorSegment:u,error:"Hover over base segment within anchor segment that is closest to merge location"}:{anchorSegment:h,error:void 0}:{anchorSegment:u,error:"Anchor segment must be in visible set"}},s=()=>{const{anchorSegment:u,error:h}=n();if(u===void 0||h!==void 0)return{anchorSegment:u,error:h,otherSegment:void 0,anchorSegmentValid:!1};const{displayState:g}=this.layer,v=g.segmentSelectionState.baseValue;return v===void 0||X.equal(g.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(u))?{anchorSegment:u,otherSegment:void 0,error:"Hover over segment to merge",anchorSegmentValid:!0}:{anchorSegment:u,otherSegment:v,error:void 0,anchorSegmentValid:!0}},{body:r,header:o}=Ba(e);o.textContent="Merge segments",r.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(XB),e.registerDisposer(()=>{sc(t)});const l=()=>{Fe(r);const{displayState:u}=this.layer,{anchorSegment:h,otherSegment:g,anchorSegmentValid:v,error:y}=s(),b=E=>{const k=Bv(this.layer.displayState,E);return k.classList.add("neuroglancer-segment-list-entry-double-line"),k};if(h!==void 0&&r.appendChild(b(eo(u,h))),y!==void 0){const E=document.createElement("span");E.textContent=y,r.appendChild(E)}if(g!==void 0){const E=document.createElement("span");E.textContent=" merge ",r.appendChild(E),r.appendChild(b(eo(u,g)))}const{segmentEquivalences:w}=t;if(!v){sc(t);return}t.useTemporaryVisibleSegments.value=!0;const C=t.temporaryVisibleSegments;C.clear(),C.add(w.get(h)),g!==void 0&&C.add(w.get(g))};l(),e.registerDisposer(rc(this.layer.displayState,r));const c=e.registerCancellable(et(l));Ga(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c)),e.registerDisposer(this.lastAnchorBaseSegment.changed.add(c)),e.bindAction("merge-segments",u=>{u.stopPropagation(),(async()=>{const{graph:{value:h}}=t;if(h===void 0)return;const{anchorSegment:g,otherSegment:v,error:y}=s();if(!(g===void 0||v===void 0||y!==void 0))try{await h.merge(g,v),Pe.showTemporaryMessage("Merge performed")}catch(b){Pe.showTemporaryMessage(`Merge failed: ${b}`)}})()}),e.bindAction("set-anchor",u=>{u.stopPropagation();const{segmentSelectionState:h}=this.layer.displayState,g=h.baseValue;if(g===void 0)return;const v=this.layer.anchorSegment.value;if(t.visibleSegments.add(g),v===void 0||!X.equal(v,g)){this.layer.anchorSegment.value=g.clone();return}})}get description(){return"merge"}};class eF extends Va{toJSON(){return ey}activate(e){const t=this.layer.displayState.segmentationGroupState.value,n=()=>{const h=this.layer.anchorSegment.value;if(h===void 0)return{anchorSegment:void 0,error:"Select anchor segment for split"};const g=t.segmentEquivalences.get(h);return t.visibleSegments.has(g)?{anchorSegment:h,error:void 0}:{anchorSegment:h,error:"Anchor segment must be in visible set"}},{body:s,header:r}=Ba(e);r.textContent="Split segments",s.classList.add("neuroglancer-merge-segments-status"),e.bindInputEventMap(QB);const o=()=>{const{anchorSegment:h,error:g}=n();if(h===void 0||g!==void 0)return{anchorSegment:h,error:g,otherSegment:void 0,anchorSegmentValid:!1};const{displayState:v}=this.layer,y=v.segmentSelectionState.baseValue;return y===void 0||!X.equal(v.segmentSelectionState.selectedSegment,t.segmentEquivalences.get(h))||X.equal(y,h)?{anchorSegment:h,otherSegment:void 0,anchorSegmentValid:!0,error:"Hover over base segment to seed split"}:{anchorSegment:h,otherSegment:y,anchorSegmentValid:!0,error:void 0}};e.registerDisposer(()=>{sc(t)});const l=()=>{Fe(s);const{displayState:h}=this.layer,{anchorSegment:g,otherSegment:v,anchorSegmentValid:y,error:b}=o();let w,C;(()=>{const{segmentEquivalences:D}=t,{graphConnection:{value:A}}=this.layer;if(!y||A===void 0){sc(t);return}if(t.useTemporaryVisibleSegments.value=!0,v!==void 0){const I=A.computeSplit(g,v);if(I!==void 0){w=new mr(g,I.includeRepresentative),C=new mr(v,I.excludeRepresentative),t.useTemporarySegmentEquivalences.value=!0;const P=I.includeRepresentative,O=I.excludeRepresentative,_=t.temporarySegmentEquivalences;_.clear();for(const U of I.includeBaseSegments)_.link(U,P);for(const U of I.excludeBaseSegments)_.link(U,O);const W=t.temporaryVisibleSegments;W.clear(),W.add(P),W.add(O);return}}t.useTemporarySegmentEquivalences.value=!1;const N=t.temporaryVisibleSegments;N.clear(),N.add(D.get(g))})();const k=D=>{const A=Bv(this.layer.displayState,D);return A.classList.add("neuroglancer-segment-list-entry-double-line"),A};if(g!==void 0&&s.appendChild(k(w??eo(h,g))),b!==void 0){const D=document.createElement("span");D.textContent=b,s.appendChild(D)}if(C!==void 0){const D=document.createElement("span");D.textContent=" split ",s.appendChild(D),s.appendChild(k(C))}};e.registerDisposer(rc(this.layer.displayState,s)),l();const c=e.registerCancellable(et(l));Ga(this.layer.displayState,e,c),e.registerDisposer(this.layer.anchorSegment.changed.add(c));const u=async h=>{const{graph:{value:g}}=t;if(g===void 0)return;const{anchorSegment:v,otherSegment:y,error:b}=o();if(!(v===void 0||y===void 0||b!==void 0))try{await g.split(v,y),h&&t.visibleSegments.add(t.segmentEquivalences.get(y)),Pe.showTemporaryMessage("Split performed")}catch(w){Pe.showTemporaryMessage(`Split failed: ${w}`)}};e.bindAction("split-segments",h=>{h.stopPropagation(),u(!1)}),e.bindAction("split-and-select-segments",h=>{h.stopPropagation(),u(!0)}),e.bindAction("set-anchor",h=>{h.stopPropagation();const{segmentSelectionState:g}=this.layer.displayState,v=g.baseValue;if(v===void 0)return;t.visibleSegments.add(v);const y=this.layer.anchorSegment.value;if(y===void 0||!X.equal(y,v)){this.layer.anchorSegment.value=v.clone();return}})}get description(){return"split"}}function tF(i){Ji(i,Zv,e=>new ZB(e)),Ji(i,ey,e=>new eF(e))}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nF=0,iF=1,sF=2;function Ia(i){let e=0;const{deltaMode:t}=i;switch(t){case nF:e=1/200;break;case iF:e=1/10;break;case sF:e=2;break}return Math.exp(i.deltaY*e)}const Ow=He.fromObject({"shift?+mousedown0":{action:"set"},"shift?+alt+mousedown0":{action:"adjust-window-via-drag"},"shift?+wheel":{action:"zoom-via-wheel"}});class Tk extends K{constructor(e,t,n,s){super(),this.element=e,this.dataType=t,this.getModel=n,this.setModel=s,e.title=Ow.describe(),this.registerDisposer(new ji(e,Ow)),fe(e,"set",r=>{const o=r.detail,l=this.getModel(),c=this.getTargetValue(o);if(c===void 0)return;const u=_l(l.window,l.range),h=iR(u,c),g=v=>{const y=this.getModel();this.setModel(Gu(y,"range",h,v))};g(c),oi(o,v=>{const y=this.getTargetValue(v);y!==void 0&&g(y)})}),fe(e,"adjust-window-via-drag",r=>{const o=r.detail,l=this.getTargetFraction(o),c=this.getWindowLerp(l),u=l<.5?0:1,h=g=>{const v=this.getModel();this.setModel(Gu(v,"window",u,g))};oi(o,g=>{const v=this.getModel().window,y=this.getTargetFraction(g);h(u===0?ds([c,v[1]],this.dataType,-y/(1-y)):ds([v[0],c],this.dataType,1/y))})}),fe(e,"zoom-via-wheel",r=>{const o=r.detail,l=Ia(o),c=this.getTargetFraction(o),{dataType:u}=this,h=this.getModel(),g=ds(h.window,u,c*(1-l)),v=ds(h.window,u,(1-c)*l+c);this.setModel({...h,window:[g,v],range:h.range})})}getTargetFraction(e){const t=this.element.getBoundingClientRect();return(e.clientX-t.left)/t.width}getWindowLerp(e){return ds(this.getModel().window,this.dataType,e)}getTargetValue(e){const t=this.getTargetFraction(e);if(Number.isFinite(t))return this.getWindowLerp(t)}}const _w=Symbol("histogramSamplerTexture");function Gu(i,e,t,n,s=!1){const r={...i},o=i[e];if(r[e]=[o[0],o[1]],r[e][t]=n,e==="window"&&ii(n,o[1-t])*(2*t-1)<0&&(r[e][1-t]=n),e==="range"&&s){const l=[i.window[0],i.window[1]];for(let c=0;c<2;++c)ii(n,l[c])*(2*c-1)>0&&(l[c]=n);r.window=l}return r}const rF=254,Al=rF+1;class oF extends m1{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.controller=this.registerDisposer(new Tk(this.element,this.parent.dataType,()=>this.parent.trackable.value,n=>{this.parent.trackable.value=n})),this.dataValuesBuffer=this.registerDisposer(Xl(this.gl,WebGL2RenderingContext.ARRAY_BUFFER,()=>{const n=new Uint8Array(Al*dr);for(let s=0;s<Al;++s)for(let r=0;r<dr;++r)n[s*dr+r]=s;return n})).value,this.lineShader=this.registerDisposer((()=>{const n=new pr(this.gl);return ks(n),n.addTextureSampler("sampler2D","uHistogramSampler",_w),n.addOutputBuffer("vec4","out_color",0),n.addAttribute("uint","aDataValue"),n.addUniform("float","uBoundsFraction"),n.addVertexCode(`
float getCount(int i) {
  return texelFetch(uHistogramSampler, ivec2(i, 0), 0).x;
}
vec4 getVertex(float cdf, int i) {
  float x;
  if (i == 0) {
    x = -1.0;
  } else if (i == 255) {
    x = 1.0;
  } else {
    x = float(i) / 254.0 * uBoundsFraction * 2.0 - 1.0;
  }
  return vec4(x, cdf * (2.0 - uLineParams.y) - 1.0 + uLineParams.y * 0.5, 0.0, 1.0);
}
`),n.setVertexMain(`
int lineNumber = int(aDataValue);
int dataValue = lineNumber;
float cumSum = 0.0;
for (int i = 0; i <= dataValue; ++i) {
  cumSum += getCount(i);
}
float total = cumSum + getCount(dataValue + 1);
float cumSumEnd = dataValue == ${Al-1} ? cumSum : total;
if (dataValue == ${Al-1}) {
  cumSum + getCount(dataValue + 1);
}
for (int i = dataValue + 2; i < 256; ++i) {
  total += getCount(i);
}
total = max(total, 1.0);
float cdf1 = cumSum / total;
float cdf2 = cumSumEnd / total;
emitLine(getVertex(cdf1, lineNumber), getVertex(cdf2, lineNumber + 1), 1.0);
`),n.setFragmentMain(`
out_color = vec4(0.0, 1.0, 1.0, getLineAlpha());
`),n.build()})()),this.regionCornersBuffer=Ql(this.gl,0,-1,1,1),this.regionShader=this.registerDisposer((()=>{const n=new pr(this.gl);return n.addAttribute("vec2","aVertexPosition"),n.addUniform("vec2","uBounds"),n.addUniform("vec4","uColor"),n.addOutputBuffer("vec4","out_color",0),n.setVertexMain(`
gl_Position = vec4(mix(uBounds[0], uBounds[1], aVertexPosition.x) * 2.0 - 1.0, aVertexPosition.y, 0.0, 1.0);
`),n.setFragmentMain(`
out_color = uColor;
`),n.build()})());const{element:t}=this;t.classList.add("neuroglancer-invlerp-cdfpanel")}get drawOrder(){return 100}drawIndirect(){const{lineShader:e,gl:t,regionShader:n,parent:{dataType:s,trackable:{value:r}}}=this;this.setGLLogicalViewport(),t.clearColor(0,0,0,0),t.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.enable(WebGL2RenderingContext.BLEND),t.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),t.disable(WebGL2RenderingContext.DEPTH_TEST),t.disable(WebGL2RenderingContext.STENCIL_TEST);{n.bind(),t.uniform4f(n.uniform("uColor"),.2,.2,.2,1);const o=Hn(r.window,r.range[0]),l=Hn(r.window,r.range[1]),c=pu(s,r.window);t.uniform2f(n.uniform("uBounds"),Math.min(o,l)*c,Math.max(o,l)*c+(1-c));const u=n.attribute("aVertexPosition");this.regionCornersBuffer.bindToVertexAttrib(u,2,WebGL2RenderingContext.FLOAT),t.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),t.disableVertexAttribArray(u)}if(this.parent.histogramSpecifications.producerVisibility.visible){const{renderViewport:o}=this;e.bind(),Ds(e,{width:o.logicalWidth,height:o.logicalHeight},1);const l=e.textureUnit(_w);t.uniform1f(e.uniform("uBoundsFraction"),pu(s,r.window)),t.activeTexture(WebGL2RenderingContext.TEXTURE0+l),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,this.parent.texture),va(t);const c=e.attribute("aDataValue");this.dataValuesBuffer.bindToVertexAttribI(c,1,WebGL2RenderingContext.UNSIGNED_BYTE),Ls(t,Al,1),t.disableVertexAttribArray(c),t.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}t.disable(WebGL2RenderingContext.BLEND)}isReady(){return!0}}function aF(){}class lF extends m1{constructor(e){super(e.display,document.createElement("div"),e.visibility),this.parent=e,this.cornersBuffer=Ql(this.gl,-1,-1,1,1);const{element:t}=this;t.classList.add("neuroglancer-invlerp-legend-panel");const n=this.shaderOptions=e.legendShaderOptions;this.shaderGetter=Kr(this,this.gl,{...n,memoizeKey:{id:"colorLegendShader",base:n.memoizeKey},defineShader:(s,r,o)=>{s.addOutputBuffer("vec4","v4f_fragData0",0),s.addAttribute("vec2","aVertexPosition"),s.addUniform("float","uLegendOffset"),s.addVarying("float","vLinearPosition"),s.setVertexMain(`
gl_Position = vec4(aVertexPosition, 0.0, 1.0);
vLinearPosition = -uLegendOffset + ((aVertexPosition.x + 1.0) * 0.5) * (1.0 + 2.0 * uLegendOffset);
`);const l=this.parent.dataType,c=$t(l);s.addFragmentCode(gM(s,"ng_colorLegendLerp",l)),s.addFragmentCode(`
void emit(vec4 v) {
  v4f_fragData0 = v;
}
${c} getDataValue() {
  return ng_colorLegendLerp(vLinearPosition);
}
${c} getDataValue(int dummyChannel) {
  return getDataValue();
}
${c} getInterpolatedDataValue() {
  return getDataValue();
}
${c} getInterpolatedDataValue(int dummyChannel) {
  return getDataValue();
}
`),n.defineShader(s,r,o)}})}drawIndirect(){const e=this.shaderGetter(aF),{shader:t}=e;if(t===null)return;this.setGLLogicalViewport();const{gl:n}=this;n.clearColor(0,0,0,0),n.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),t.bind(),this.shaderOptions.initializeShader(e),n.enable(WebGL2RenderingContext.BLEND);const{trackable:{value:{window:s}},dataType:r}=this.parent;Zl(t,"ng_colorLegendLerp",this.parent.dataType,s);const o=rR(r,s);n.uniform1f(t.uniform("uLegendOffset"),Number.isFinite(o)?o:0),n.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),n.disable(WebGL2RenderingContext.DEPTH_TEST),n.disable(WebGL2RenderingContext.STENCIL_TEST);const l=t.attribute("aVertexPosition");this.cornersBuffer.bindToVertexAttrib(l,2,WebGL2RenderingContext.FLOAT),n.drawArrays(WebGL2RenderingContext.TRIANGLE_FAN,0,4),n.disableVertexAttribArray(l)}isReady(){return!0}}function Vw(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add("neuroglancer-invlerp-widget-bound"),t.classList.add(`neuroglancer-invlerp-widget-${i}-bound`),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=i==="range"?`Data value that maps to ${e}`:`${e===0?"Lower":"Upper"} bound for distribution`,t}function Bw(i,e,t){const n=document.createElement("div");n.classList.add("neuroglancer-invlerp-widget-bounds"),n.classList.add(`neuroglancer-invlerp-widget-${i}-bounds`);const s=[Vw(i,0),Vw(i,1)];for(let o=0;o<2;++o){const l=s[o];l.addEventListener("input",()=>{kk(l)}),l.addEventListener("change",()=>{const c=t.value,u=c[i];try{const h=Ic(e,l.value);t.value=Gu(c,i,o,h,!0)}catch{rm(l,u[o])}})}let r;return n.appendChild(s[0]),n.appendChild(s[1]),i==="range"&&(r=[document.createElement("div"),document.createElement("div"),document.createElement("div")],r[1].classList.add("neuroglancer-invlerp-widget-range-spacer"),n.insertBefore(r[0],s[0]),n.insertBefore(r[1],s[1]),n.appendChild(r[2])),{container:n,inputs:s,spacers:r}}function kk(i){Dn(i,Math.max(1,i.value.length+.1))}function rm(i,e){let t;e instanceof X||Number.isInteger(e)?t=e.toString():t=e.toPrecision(6),i.value=t,kk(i)}function Lk(i){const e=i.value,{range:t}=e;i.value={...e,range:[t[1],t[0]]}}function cF(i,e,t){const n=e.value,s=ds(n.range,i,.5-t/2),r=ds(n.range,i,.5+t/2);e.value={...n,range:[s,r]}}function dF(i,e,t,n,s){const r=Math.exp(s),o=e.value,l=ds(t,i,.5-r/2+n),c=ds(t,i,.5+r/2+n);e.value={...o,range:[l,c]}}class Dk extends ci{constructor(e,t,n,s,r,o,l){super(e),this.display=t,this.dataType=n,this.trackable=s,this.histogramSpecifications=r,this.histogramIndex=o,this.legendShaderOptions=l,this.cdfPanel=this.registerDisposer(new oF(this)),this.boundElements={range:Bw("range",this.dataType,this.trackable),window:Bw("window",this.dataType,this.trackable)},this.registerDisposer(r.visibility.add(this.visibility));const{element:c,boundElements:u}=this;if(l!==void 0){const g=this.registerDisposer(new lF(this));c.appendChild(g.element)}const h=g=>{const v=$e({svg:g,title:"Invert range",onClick:()=>{this.invertRange()}});return u.range.spacers[1].appendChild(v),v};this.invertArrows=[h(fT),h(hT)],c.appendChild(u.range.container),c.appendChild(this.cdfPanel.element),c.classList.add("neuroglancer-invlerp-widget"),c.appendChild(u.window.container),this.updateView(),this.registerDisposer(s.changed.add(this.registerCancellable(et(()=>this.updateView()))))}get texture(){return this.histogramSpecifications.getFramebuffers(this.display.gl)[this.histogramIndex].colorBuffers[0].texture}invertRange(){Lk(this.trackable)}updateView(){const{boundElements:e}=this,{trackable:{value:t},dataType:n}=this;for(let g=0;g<2;++g)rm(e.range.inputs[g],t.range[g]),rm(e.window.inputs[g],t.window[g]);const s=ii(t.range[0],t.range[1])>0;e.range.container.style.flexDirection=s?"row-reverse":"row";const r=_l(t.window,t.range),o=e.range.spacers,l=pu(n,t.window),c=Hn(t.window,r[s?1:0])*l,u=Hn(t.window,r[s?0:1])*l+(1-l);o[s?2:0].style.width=`${c*100}%`,o[s?0:2].style.width=`${(1-u)*100}%`;const{invertArrows:h}=this;h[s?1:0].style.display="",h[s?0:1].style.display="none"}}class uF extends ci{constructor(e,t,n,s,r,o,l){super(e),this.display=t,this.watchableDataType=n,this.trackable=s,this.histogramSpecifications=r,this.histogramIndex=o,this.legendShaderOptions=l,this.invlerpWidget=this.makeInvlerpWidget(),this.registerDisposer(n.changed.add(()=>{Fe(this.element),this.invlerpWidget.dispose(),this.invlerpWidget=this.makeInvlerpWidget()}))}get dataType(){return this.watchableDataType.value}disposed(){this.invlerpWidget.dispose(),super.disposed()}makeInvlerpWidget(){const{dataType:e}=this,t=new Dk(this.visibility,this.display,e,this.trackable,this.histogramSpecifications,this.histogramIndex,this.legendShaderOptions);return this.element.appendChild(t.element),t}}const hF=He.fromObject({"at:shift+wheel":{action:"adjust-contrast-via-wheel"},"at:shift+mousedown0":{action:"adjust-via-drag"},"at:shift+mousedown2":{action:"invert-range"}});function Ik(i,e){i.bindInputEventMap(hF),i.bindAction("adjust-contrast-via-wheel",t=>{t.stopPropagation();const n=Ia(t.detail);cF(e.dataType,e.trackable,n)}),i.bindAction("adjust-via-drag",t=>{t.stopPropagation();let n=t.detail.screenX,s=t.detail.screenY,r=e.trackable.value.range,o=r,l=n,c=s;oi(t.detail,u=>{const h=e.trackable.value.range,g=u.screenX,v=u.screenY;us(e.dataType,h,o)||(r=h,n=l,s=c),dF(e.dataType,e.trackable,r,(v-s)*2/screen.height,(g-n)*4/screen.width),o=e.trackable.value.range,l=g,c=v})}),i.bindAction("invert-range",t=>{t.stopPropagation(),Lk(e.trackable)})}const fF=new X;class Pk extends K{constructor(e,t){super(),this.segmentationDisplayState=e,this.parentElement=t,this.changed=new Ze,this.explicitSegmentsVisible=!1,this.debouncedUpdate=ze(()=>this.update(),0)}updateRendering(e){this.segmentWidgetFactory.update(e)}updateRenderedItems(e){e.forEachRenderedItem(t=>{this.updateRendering(t)})}}class Ak extends Pk{constructor(e,t){super(e,t),this.segmentationDisplayState=e,this.parentElement=t,this.render=n=>{const{explicitSegments:s}=this,r=s[n];return this.segmentWidgetFactory.get(r)},this.update(),this.registerDisposer(e.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate))}update(){const e=[],{selectedSegments:t}=this.segmentationDisplayState.segmentationGroupState.value,n=[...t],{explicitSegments:s}=this;s===void 0?e.push({retainCount:0,insertCount:n.length,deleteCount:0}):e.push(...DP(s,n,X.equal)),this.explicitSegments=n,this.length=n.length,this.changed.dispatch(e)}}class Rk extends Pk{constructor(e,t,n,s){super(n,s),this.query=e,this.segmentPropertyMap=t,this.segmentationDisplayState=n,this.parentElement=s,this.queryResult=new Ne(void 0),this.prevQueryResult=new Ne(void 0),this.statusText=new Ne(""),this.selectedMatches=0,this.visibleMatches=0,this.matchStatusTextPrefix="",this.selectedSegmentsGeneration=-1,this.visibleSegmentsGeneration=-1,this.explicitSegmentsVisible=!1,this.render=r=>{const{explicitSegments:o}=this;let l;if(o!==void 0)l=o[r];else{l=fF;const c=this.queryResult.value.indices[r],{ids:u}=this.segmentPropertyMap.segmentPropertyMap.inlineProperties;l.low=u[c*2],l.high=u[c*2+1]}return this.segmentWidgetFactory.get(l)},this.update(),this.registerDisposer(n.segmentationGroupState.value.selectedSegments.changed.add(this.debouncedUpdate)),this.registerDisposer(n.segmentationGroupState.value.visibleSegments.changed.add(this.debouncedUpdate)),e&&this.registerDisposer(e.changed.add(this.debouncedUpdate))}get numMatches(){var e;return((e=this.queryResult.value)==null?void 0:e.count)??0}update(){const e=this.query.value,{segmentPropertyMap:t}=this;this.prevQueryResult.value=this.queryResult.value;const n=this.prevQueryResult.value;let s;if(this.prevQuery===e)s=n;else{const A=uV(t,e);s=hV(t,A)}const r=[];let o=!1,l="";const c=yV(s.query);c||this.explicitSegments!==void 0&&this.explicitSegmentsVisible&&(r.push({deleteCount:this.explicitSegments.length,retainCount:0,insertCount:0}),this.explicitSegments=void 0,o=!0);const{explicitIds:u}=s;u!==void 0?this.explicitSegments=u:this.explicitSegmentsVisible||(this.explicitSegments=void 0),n!==s&&(r.push({retainCount:0,deleteCount:(n==null?void 0:n.count)??0,insertCount:s.count}),o=!0,this.queryResult.value=s),s.explicitIds!==void 0?l=`${s.count} ids`:c?l=`${s.count} total ids`:s.total>0&&(l=`${s.count} match /${s.total} total ids`);const{selectedSegments:h,visibleSegments:g}=this.segmentationDisplayState.segmentationGroupState.value,v=h.changed.count,y=g.changed.count,b=this.selectedSegmentsGeneration,w=this.visibleSegmentsGeneration,C=n!==s,E=b!==v||C,k=w!==y||C;this.selectedSegmentsGeneration=v,this.visibleSegmentsGeneration=y,E&&(this.selectedMatches=s.count>0?pw(t,s,h):0),k&&(this.visibleMatches=s.count>0?pw(t,s,g):0);let D=l;this.selectedMatches>0&&(this.selectedMatches===this.visibleMatches?D=`${this.selectedMatches} vis/${D}`:this.visibleMatches>0?D=`${this.visibleMatches} vis/${this.selectedMatches} star/${D}`:D=`${this.selectedMatches} star/${D}`),this.statusText.value=D,this.prevQuery=e,this.matchStatusTextPrefix=l,this.length=s.count,o&&this.changed.dispatch(r)}}const Fw=He.fromObject({enter:{action:"toggle-listed"},"shift+enter":{action:"hide-listed"},"control+enter":{action:"hide-all"},escape:{action:"cancel"}});function Nk(i){Dn(i,Math.max(1,i.value.length+.1))}function Rp(i,e){let t;if(Number.isInteger(e))t=e.toString();else{const n=e.toString(),s=e.toPrecision(6);t=n.length<s.length?n:s}i.value=t,Nk(i)}function pF(i,e){const t=document.createElement("input");return t.addEventListener("focus",()=>{t.select()}),t.classList.add(`neuroglancer-segment-query-result-numerical-plot-${i}-bound`),t.classList.add("neuroglancer-segment-query-result-numerical-plot-bound"),t.type="text",t.spellcheck=!1,t.autocomplete="off",t.title=(e===0?"Lower":"Upper")+" bound "+(i==="range"?"range":"for distribution"),t.addEventListener("input",()=>{Nk(t)}),t}function gF(i,e,t){if(i===void 0||i.indices===void 0)return;const n=i.query;let{sortBy:s,includeColumns:r}=n;Uh(n,t)?(s=s.filter(l=>l.fieldId!==t),r=r.filter(l=>l!==t)):r.push(t),e({...n,sortBy:s,includeColumns:r})}function Mk(i,e,t){var u;const n=i==null?void 0:i.query,s=n==null?void 0:n.sortBy;if(s===void 0)return;const{includeColumns:r}=n,l=((u=s.find(h=>h.fieldId===t))==null?void 0:u.order)==="<"?">":"<",c=r.filter(h=>h!==t);for(const h of s)h.fieldId!=="id"&&h.fieldId!=="label"&&h.fieldId!==t&&c.push(h.fieldId);e({...n,sortBy:[{fieldId:t,order:l}],includeColumns:c})}function Ok(i,e,t){var r,o;const n=(r=i==null?void 0:i.query)==null?void 0:r.sortBy,s=(o=n==null?void 0:n.find(l=>l.fieldId===t))==null?void 0:o.order;e.textContent=s===">"?"▼":"▲",e.style.visibility=s===void 0?"":"visible",e.title=`Sort by ${t} in ${s==="<"?"descending":"ascending"} order`}class mF extends K{constructor(e,t,n){super(),this.segmentPropertyMap=e,this.queryResult=t,this.setQuery=n,this.propertyHistograms=[],this.bounds={window:new Ne([]),range:new Ne([])},this.throttledUpdate=this.registerCancellable(oh(()=>this.updateHistograms(),100)),this.debouncedRender=this.registerCancellable(et(()=>this.updateHistogramRenderings())),this.debouncedSetQuery=this.registerCancellable(ze(()=>this.setQueryFromBounds(),200));const s=e==null?void 0:e.numericalProperties,r=[];let o;if(s!==void 0&&s.length>0){o=document.createElement("details");const l=document.createElement("summary");l.textContent=`${s.length} numerical propert${s.length>1?"ies":"y"}`,o.appendChild(l),o.classList.add("neuroglancer-segment-query-result-numerical-list");const c=this.bounds.window.value;for(let u=0,h=s.length;u<h;++u){const g=s[u],v=this.makeNumericalPropertySummary(u,g);r.push(v),o.appendChild(v.element),c[u]=g.bounds}}this.listElement=o,this.properties=r,this.registerDisposer(this.queryResult.changed.add(()=>{this.handleNewQueryResult()})),this.registerDisposer(this.bounds.window.changed.add(this.throttledUpdate)),this.registerDisposer(this.bounds.window.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedRender)),this.registerDisposer(this.bounds.range.changed.add(this.debouncedSetQuery)),this.handleNewQueryResult()}setQueryFromBounds(){const e=this.queryResult.value;if(e===void 0||e.indices===void 0)return;const t=e.query,n=[],s=this.bounds.range.value,{properties:r}=this;for(let o=0,l=r.length;o<l;++o){const c=r[o].property;n.push({fieldId:c.id,bounds:s[o]})}this.setQuery({...t,numericalConstraints:n})}getBounds(e){const{bounds:t}=this;return{range:t.range.value[e],window:t.window.value[e]}}setBounds(e,t){const{property:n}=this.properties[e];let s=_l(n.bounds,t.range);ii(s[0],s[1])>0&&(s=[s[1],s[0]]);const r=_l(n.bounds,t.window),o=this.getBounds(e),{dataType:l}=this.properties[e].property;us(l,r,o.window)||(this.bounds.window.value[e]=r,this.bounds.window.changed.dispatch()),us(l,s,o.range)||(this.bounds.range.value[e]=s,this.bounds.range.changed.dispatch())}setBound(e,t,n,s){const o=this.segmentPropertyMap.numericalProperties[n].bounds;s=jr(o,s);const l=this.getBounds(n),c=Gu(l,e,t,s,!0);this.setBounds(n,c)}handleNewQueryResult(){const e=this.queryResult.value,{listElement:t}=this;if(t!==void 0){if((e==null?void 0:e.indices)!==void 0){const{numericalConstraints:n}=e.query,{numericalProperties:s}=this.segmentPropertyMap,r=this.bounds.range.value,o=n.length,l=s.length;r.length=l;for(let c=0;c<l;++c)r[c]=s[c].bounds;for(let c=0;c<o;++c){const u=n[c],h=s.findIndex(g=>g.id===u.fieldId);r[h]=u.bounds}}this.updateHistograms(),this.throttledUpdate.cancel()}}updateHistograms(){const e=this.queryResult.value,{listElement:t}=this;t!==void 0&&(pV(this.segmentPropertyMap,e,this.propertyHistograms,this.bounds.window.value),this.updateHistogramRenderings())}updateHistogramRenderings(){this.debouncedRender.cancel();const{listElement:e}=this;if(e===void 0)return;const{propertyHistograms:t}=this;if(t.length===0){e.style.display="none";return}e.style.display="";const{properties:n}=this;for(let s=0,r=n.length;s<r;++s)this.updateNumericalPropertySummary(s,n[s],t[s])}makeNumericalPropertySummary(e,t){const n=document.createElement("div");n.classList.add("neuroglancer-segment-query-result-numerical-plot-container");const s=document.createElement("img");s.classList.add("neuroglancer-segment-query-result-numerical-plot");const r=new Tk(s,t.dataType,()=>this.getBounds(e),h=>this.setBounds(e,h)),o=document.createElement("span");o.classList.add("neuroglancer-segment-query-result-numerical-plot-sort");const l=document.createElement("input");l.type="checkbox",l.addEventListener("click",()=>{gF(this.queryResult.value,this.setQuery,t.id)});const c=h=>{const g=document.createElement("div");g.classList.add("neuroglancer-segment-query-result-numerical-plot-bounds"),g.classList.add(`neuroglancer-segment-query-result-numerical-plot-bounds-${h}`);const v=w=>{const C=pF(h,w);return C.addEventListener("change",()=>{if(this.bounds[h].value[e]!==void 0){try{const k=Ic(t.dataType,C.value);this.setBound(h,w,e,k),this.bounds[h].changed.dispatch()}catch{}Rp(C,this.bounds[h].value[e][w])}}),C},y=[v(0),v(1)];let b;if(h==="range"){b=[document.createElement("div"),document.createElement("div"),document.createElement("div")],b[1].classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-spacer"),b[1].appendChild(l);const w=document.createElement("span");w.classList.add("neuroglancer-segment-query-result-numerical-plot-label"),w.appendChild(document.createTextNode(t.id)),w.appendChild(o),w.addEventListener("click",()=>{Mk(this.queryResult.value,this.setQuery,t.id)}),b[1].appendChild(w);const{description:C}=t;C&&(b[1].title=C),g.appendChild(b[0]),g.appendChild(y[0]);const E=document.createElement("div");E.textContent="≤",E.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(E),g.appendChild(b[1]);const k=document.createElement("div");k.textContent="≤",k.classList.add("neuroglancer-segment-query-result-numerical-plot-bound-constraint-symbol"),g.appendChild(k),g.appendChild(y[1]),g.appendChild(b[2])}else g.appendChild(y[0]),g.appendChild(y[1]);return{container:g,spacers:b,inputs:y}},u={range:c("range"),window:c("window")};return n.appendChild(u.range.container),n.appendChild(s),n.appendChild(u.window.container),{property:t,controller:r,element:n,plotImg:s,boundElements:u,bounds:{window:[NaN,NaN],range:[NaN,NaN]},propertyHistogram:void 0,columnCheckbox:l,sortIcon:o}}updateNumericalPropertySummary(e,t,n){const s=t.bounds.window,r=this.bounds.window.value[e],o=t.bounds.range,l=this.bounds.range.value[e],{property:c}=t,u=this.queryResult.value,h=Uh(u==null?void 0:u.query,c.id);if(t.columnCheckbox.checked=h,t.columnCheckbox.title=h?"Remove column from result table":"Add column to result table",Ok(u,t.sortIcon,c.id),t.propertyHistogram===n&&us(c.dataType,s,r)&&us(c.dataType,o,l))return;const{histogram:g}=n,v="http://www.w3.org/2000/svg",y=document.createElementNS(v,"svg");y.setAttribute("width","1"),y.setAttribute("height","1"),y.setAttribute("preserveAspectRatio","none");const b=document.createElementNS(v,"rect"),w=Hn(r,l[0]),C=Hn(r,l[1]);b.setAttribute("x",`${w}`),b.setAttribute("y","0"),b.setAttribute("width",`${C-w}`),b.setAttribute("height","1"),b.setAttribute("fill","#4f4f4f"),y.appendChild(b);const E=g.length,k=(_,W,U)=>{const j=document.createElementNS(v,"polyline");let B="",H=0;for(let me=_;me<U;++me)H+=g[me];if(H===0)return;const V=Hn(r,n.window[0]),re=Hn(r,n.window[1]),se=(me,Ie)=>{const We=me/(E-2),tt=V*(1-We)+re*We;B+=` ${tt},${1-Ie}`};_!==0&&se(_,0);let ve=0;for(let me=_;me<W;++me){const Ie=g[me];ve+=Ie,se(me,ve/H)}return j.setAttribute("fill","none"),j.setAttribute("stroke-width","1px"),j.setAttribute("points",B),j.setAttribute("vector-effect","non-scaling-stroke"),j};{const _=k(0,E-1,E);_!==void 0&&(_.setAttribute("stroke","cyan"),y.appendChild(_))}if(!us(c.dataType,c.bounds,l)){const _=Math.floor(Math.max(0,Math.min(1,Hn(n.window,l[0])))*(E-2)),W=Math.ceil(Math.max(0,Math.min(1,Hn(n.window,l[1])))*(E-2)),U=k(_,W,W);U!==void 0&&(U.setAttribute("stroke","white"),y.appendChild(U))}const D=new XMLSerializer().serializeToString(y);t.plotImg.src=`data:image/svg+xml;base64,${btoa(D)}`,t.propertyHistogram=n;for(let _=0;_<2;++_)s[_]=r[_],Rp(t.boundElements.window.inputs[_],r[_]),o[_]=l[_],Rp(t.boundElements.range.inputs[_],l[_]);const A=t.boundElements.range.spacers,N=_l(r,l),I=pu(c.dataType,r),P=Hn(r,N[0])*I,O=Hn(r,N[1])*I+(1-I);A[0].style.width=`${P*100}%`,A[2].style.width=`${(1-O)*100}%`}}function vF(i,e){const{tags:t}=i;if(t===void 0||t.length===0)return;const n=i.query,s=document.createElement("div");s.classList.add("neuroglancer-segment-query-result-tag-list");for(const{tag:r,count:o}of t){const l=document.createElement("div");l.classList.add("neuroglancer-segment-query-result-tag");const c=document.createElement("span");c.classList.add("neuroglancer-segment-query-result-tag-name"),c.textContent=r,s.appendChild(l);const u=n.includeTags.includes(r),h=n.excludeTags.includes(r);let g;u?g="Remove tag from required set":h?g="Remove tag from excluded set":g="Add tag to required set",c.addEventListener("click",()=>{e(gw(n,r,!0,!u&&!h))}),c.title=g;const v=u||h,y=w=>{const C=w?o:i.count-o,E=document.createElement("div");if(E.classList.add("neuroglancer-segment-query-result-tag-toggle"),E.classList.add(`neuroglancer-segment-query-result-tag-${w?"include":"exclude"}`),l.appendChild(E),!v&&C===0)return;const k=w?u:h;E.appendChild(new Kn({get value(){return k},set value(D){e(gw(n,r,w,D))},changed:ux},{text:w?"+":"-",enableTitle:`Add tag to ${w?"required":"exclusion"} set`,disableTitle:`Remove tag from ${w?"required":"exclusion"} set`,backgroundScheme:"dark"}).element)};y(!0),y(!1),l.appendChild(c);const b=document.createElement("span");b.classList.add("neuroglancer-segment-query-result-tag-count"),v||(b.textContent=o.toString()),l.appendChild(b)}return s}class _k extends K{constructor(e,t){super(),this.listSource=e,this.group=t,this.element=document.createElement("div"),this.selectionStatusContainer=document.createElement("span"),this.selectionStatusMessage=document.createElement("span"),this.statusChanged=new ue,this.debouncedUpdateStatus=ze(()=>this.updateStatus(),0);const{element:n}=this;n.style.display="contents",this.starAllButton=bT({title:"Click to toggle star status, shift+click to unstar non-visible segments.",onClick:r=>{const o=this.starAllButton.classList.contains("neuroglancer-starred");if(r.shiftKey){const l=[];for(const c of this.group.selectedSegments)this.group.visibleSegments.has(c)||l.push(c);this.group.selectedSegments.delete(l);return}this.selectSegments(!o,!1)}}),this.copyAllSegmentsButton=xs({title:"Copy all segment IDs",onClick:()=>{this.copySegments(!1)}}),this.copyVisibleSegmentsButton=xs({title:"Copy visible segment IDs",onClick:()=>{this.copySegments(!0)}}),this.visibilityToggleAllButton=ST({onClick:r=>{if(r.shiftKey){this.invertVisibility();return}this.makeSegmentsVisible(!this.visibilityToggleAllButton.classList.contains("neuroglancer-visible"))}});const{selectionStatusContainer:s}=this;this.selectionStatusMessage.classList.add("neuroglancer-segment-list-status-message"),s.classList.add("neuroglancer-segment-list-status"),s.appendChild(this.copyAllSegmentsButton),s.appendChild(this.starAllButton),s.appendChild(this.visibilityToggleAllButton),s.appendChild(this.copyVisibleSegmentsButton),s.appendChild(this.selectionStatusMessage),this.element.appendChild(s),this.registerDisposer(t.visibleSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(t.selectedSegments.changed.add(this.debouncedUpdateStatus)),this.registerDisposer(e.changed.add(this.debouncedUpdateStatus))}makeSegmentsVisible(e){const{visibleSegments:t}=this.group,n=Array.from(this.listSegments(!0));t.set(n,e)}invertVisibility(){const e=[],t=[],{visibleSegments:n}=this.group;for(const s of this.listSegments(!0))n.has(s)?t.push(s):e.push(s);n.set(e,!0),n.set(t,!1)}selectSegments(e,t=!1){const{selectedSegments:n,visibleSegments:s}=this.group,r=Array.from(this.listSegments(!0));(e||!t)&&n.set(r,e),t&&s.set(r,e)}copySegments(e=!1){let t=[...this.listSegments(!0)];e&&(t=t.filter(n=>this.group.visibleSegments.has(n))),t.sort(X.compare),gr(t.join(", "))}*listSegments(e=!1){}updateStatus(){const{listSource:e,group:t,starAllButton:n,selectionStatusMessage:s,copyAllSegmentsButton:r,copyVisibleSegmentsButton:o,visibilityToggleAllButton:l}=this;e.debouncedUpdate.flush();const{visibleSegments:c,selectedSegments:u}=t;let h=0,g=0,v=0,y="";const b=u.size,w=c.size;e instanceof Rk?(v=e.numMatches,h=e.visibleMatches,g=e.selectedMatches,y=e.statusText.value):y=`${w}/${b} visible`;const C=v?h:w,E=v?g:b,k=v||b;n.classList.toggle("neuroglancer-starred",E===k),n.classList.toggle("neuroglancer-indeterminate",E>0&&E!==k),s.textContent=y,r.title=`Copy all ${k} ${v?"matching":"starred"} segment(s)`,o.title=`Copy ${C} ${v?"visible matching":"visible"} segment(s)`,r.style.visibility=k?"visible":"hidden",o.style.visibility=C?"visible":"hidden",n.style.visibility=k?"visible":"hidden",l.style.visibility=k?"visible":"hidden";const D=C===k;l.classList.toggle("neuroglancer-visible",D);const A=C>0&&C!==k;l.classList.toggle("neuroglancer-indeterminate",A);let N;D?N=`Click to hide ${k} segment ID(s).`:N=`Click to show ${k-C} segment ID(s).`,A&&(N+="  Shift+click to invert visibility."),l.title=N,this.statusChanged.dispatch()}}class yF extends _k{constructor(e,t){super(e,t),this.listSource=e,this.group=t}listSegments(e=!1){return this.group.selectedSegments[Symbol.iterator]()}}class SF extends _k{constructor(e,t,n,s,r,o,l){super(t,n),this.listSource=t,this.segmentPropertyMap=s,this.debouncedUpdateQueryModel=l;const c=w=>{o.focus(),o.select();const C=gV(s,w);document.execCommand("insertText",!1,C),r.value=C,o.select()},u=document.createElement("div");u.classList.add("neuroglancer-segment-query-result-statistics");const h=document.createElement("div");h.classList.add("neuroglancer-segment-query-result-statistics-separator");const g=document.createElement("ul");g.classList.add("neuroglancer-segment-query-errors"),this.element.prepend(g,u,h),this.registerEventListener(o,"input",()=>{l()}),this.registerDisposer(fe(o,"cancel",()=>{o.focus(),o.select(),document.execCommand("delete"),o.blur(),o.value="",r.value=""})),this.registerDisposer(fe(o,"toggle-listed",()=>{this.toggleMatches()})),this.registerDisposer(fe(o,"hide-all",()=>{n.visibleSegments.clear()})),this.registerDisposer(fe(o,"hide-listed",()=>{l(),l.flush(),t.debouncedUpdate.flush();const{visibleSegments:w}=n;this.listSource instanceof Ak?w.clear():w.delete(Array.from(this.listSegments()))}));const v=this.registerDisposer(new mF(s,t.queryResult,c));{const{listElement:w}=v;w!==void 0&&u.appendChild(w)}const y=w=>{const C=w==null?void 0:w.errors;if(Fe(g),C!==void 0)for(const E of C){const k=document.createElement("li");k.textContent=E.message,g.appendChild(k)}};let b;ys(w=>{if(t.segmentWidgetFactory=new CT(t.segmentationDisplayState,t.parentElement,E=>Uh(w==null?void 0:w.query,E.id)),e.scrollToTop(),Fe(e.header),s!==void 0){const E=t.segmentWidgetFactory.getHeader();E.container.classList.add("neuroglancer-segment-list-header");for(const k of E.propertyLabels){const{label:D,sortIcon:A,id:N}=k;D.addEventListener("click",()=>{Mk(t.queryResult.value,c,N)}),Ok(w,A,N)}e.header.appendChild(E.container)}if(y(w),h.style.display="none",b==null||b.remove(),w===void 0)return;const{query:C}=w;C.errors!==void 0||C.ids!==void 0||(b=vF(w,c),b!==void 0&&u.appendChild(b),(v.properties.length>0||b!==void 0)&&(h.style.display=""))},t.queryResult)}updateQuery(){const{listSource:e,debouncedUpdateQueryModel:t}=this;t(),t.flush(),e.debouncedUpdate.flush()}listSegments(e=!1){const{listSource:t,segmentPropertyMap:n}=this;this.updateQuery();const s=t.queryResult.value;return vV(n,s,e)}toggleMatches(){const{listSource:e}=this;this.updateQuery(),e.debouncedUpdate.flush();const t=e.queryResult.value;if(t===void 0)return;const{visibleMatches:n}=e,s=n!==t.count;return this.selectSegments(s,!0),!0}}class bF extends ci{constructor(e){super(),this.layer=e;const{element:t}=this;t.classList.add("neuroglancer-segment-display-tab"),t.appendChild(this.registerDisposer(new Vn(e.displayState.segmentationGroupState.value.graph,(c,u,h)=>{if(c===void 0||c.tabContents)return;const g=document.createElement("div");g.className="neuroglancer-segmentation-toolbox",g.appendChild(ia(h,e.toolBinder,{toolJson:Zv,label:"Merge",title:"Merge segments"})),g.appendChild(ia(h,e.toolBinder,{toolJson:ey,label:"Split",title:"Split segments"})),u.appendChild(g)})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-toolbox",n.appendChild(ia(this,e.toolBinder,{toolJson:Qv,label:"Select",title:"Select/Deselect segments"})),t.appendChild(n);const s=document.createElement("input");s.classList.add("neuroglancer-segment-list-query"),s.addEventListener("focus",()=>{s.select()});const r=this.registerDisposer(new Pi(s,Fw));r.allShortcutsAreGlobal=!0;const{segmentQuery:o}=this.layer.displayState,l=this.registerCancellable(ze(()=>{o.value=s.value},200));s.autocomplete="off",s.title=Fw.describe(),s.spellcheck=!1,s.placeholder="Enter ID, name prefix or /regexp",this.registerDisposer(ys(c=>{s.value=c},o)),this.registerDisposer(ys(c=>{Date.now()-c<100&&(setTimeout(()=>{s.focus()},0),this.layer.segmentQueryFocusTime.value=Number.NEGATIVE_INFINITY)},this.layer.segmentQueryFocusTime)),t.appendChild(s),t.appendChild(this.registerDisposer(new Vn(e.displayState.segmentPropertyMap,(c,u,h)=>{const g=h.registerDisposer(new Rk(o,c,e.displayState,u)),v=h.registerDisposer(new Ak(e.displayState,u)),y=h.registerDisposer(new Uu({source:g,horizontalScroll:!0})),b=h.registerDisposer(new Uu({source:v,horizontalScroll:!0})),w=e.displayState.segmentationGroupState.value,C=h.registerDisposer(new SF(y,g,w,c,o,s,l));C.element.appendChild(y.element),u.appendChild(C.element);const E=h.registerDisposer(new yF(v,w));E.element.appendChild(b.element),u.appendChild(E.element);const k=()=>{const N=g.query.value!==""||g.numMatches>0,I=v.length>0||!N;C.element.style.display=N?"contents":"none",E.element.style.display=I?"contents":"none"};h.registerDisposer(C.statusChanged.add(k)),h.registerDisposer(E.statusChanged.add(k)),C.updateStatus(),E.updateStatus();const D=h.registerCancellable(et(()=>{g.updateRenderedItems(y),v.updateRenderedItems(b)})),{displayState:A}=this.layer;Ga(A,h,D),h.registerDisposer(A.segmentationGroupState.value.selectedSegments.changed.add(D)),y.element.classList.add("neuroglancer-segment-list"),y.element.classList.add("neuroglancer-preview-list"),b.element.classList.add("neuroglancer-segment-list"),h.registerDisposer(e.bindSegmentListWidth(y.element)),h.registerDisposer(e.bindSegmentListWidth(b.element)),h.registerDisposer(new ji(y.element,ic())),h.registerDisposer(new ji(b.element,ic())),v.segmentWidgetFactory=new CT(v.segmentationDisplayState,v.parentElement,N=>Uh(void 0,N.id)),b.scrollToTop(),Fe(b.header)})).element)}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ea{static insertAfter(e,t){const n=e.next0;t.next0=n,t.prev0=e,e.next0=t,n.prev0=t}static insertBefore(e,t){const n=e.prev0;t.prev0=n,t.next0=e,e.prev0=t,n.next0=t}static front(e){const t=e.next0;return t===e?null:t}static back(e){const t=e.prev0;return t===e?null:t}static pop(e){const t=e.next0,n=e.prev0;return t.prev0=n,n.next0=t,e.next0=null,e.prev0=null,e}static*iterator(e){for(let t=e.next0;t!==e;t=t.next0)yield t}static*reverseIterator(e){for(let t=e.prev0;t!==e;t=t.prev0)yield t}static initializeHead(e){e.next0=e.prev0=e}}class wF{constructor(){ea.initializeHead(this)}}const om=new wF,CF=window.top===window,ty=ze(()=>{if(!CF)return;const{activeElement:i}=document;if(i===null||i===document.body){const e=ea.front(om);e!==null&&e.element.focus({preventScroll:!0})}});window.addEventListener("focus",()=>{ty()},!0);window.addEventListener("blur",()=>{ty()},!0);class Jh extends K{constructor(e){super(),this.element=e,this.prev0=null,this.next0=null,this.lastFocusedElement=null,this.scheduleUpdateFocus=this.registerCancellable(ze(()=>{const{activeElement:t}=document,{element:n}=this;n.contains(t)||Dv(t)||(t!=null&&(t===this.lastFocusedElement||t.contains(n))&&this.element.focus({preventScroll:!0}),this.lastFocusedElement=null)},0)),e.tabIndex=-1,this.registerEventListener(e,"pointerdown",t=>{t.target===e&&(this.lastFocusedElement=null,e.focus({preventScroll:!0}))}),this.registerEventListener(e,"mouseenter",()=>{this.lastFocusedElement=document.activeElement,this.scheduleUpdateFocus()}),this.registerEventListener(e,"mouseleave",()=>{this.scheduleUpdateFocus.cancel()}),ea.insertBefore(om,this),this.registerEventListener(e,"focus",()=>{ea.pop(this),ea.insertAfter(om,this)}),ty()}disposed(){ea.pop(this),super.disposed()}}let am=0;const xF=He.fromObject({escape:{action:"close"}});class Wc extends K{constructor(){super(),this.keyMap=new He,this.keyMap.addParent(xF,Number.NEGATIVE_INFINITY),++am;const e=this.container=document.createElement("div");e.className="overlay";const t=this.content=document.createElement("div");this.registerDisposer(new Jh(t)),t.className="overlay-content",e.appendChild(t),document.body.appendChild(e),this.registerDisposer(new Pi(this.container,this.keyMap)),this.registerEventListener(e,"action:close",()=>{this.dispose()}),t.focus()}disposed(){--am,document.body.removeChild(this.container),super.disposed()}}function jh(i={}){return $e({text:"?",...i})}class Uw extends K{constructor(e){super(),this.group=e,this.element=document.createElement("div"),this.topRow=document.createElement("div"),this.label=document.createElement("label"),this.selectElement=document.createElement("select"),this.linkedLayers=document.createElement("div"),this.unlinkButton=document.createElement("button");const{element:t,label:n,topRow:s,selectElement:r,linkedLayers:o,unlinkButton:l}=this;s.appendChild(n),s.appendChild(r),s.appendChild(l),l.textContent="Unlink",l.addEventListener("click",()=>{this.group.isolate()}),t.appendChild(s),t.appendChild(o),this.updateView();const c=ze(()=>this.updateView(),0);this.registerEventListener(r,"change",()=>{this.updateModel(),c()}),this.registerDisposer(this.group.changed.add(c)),this.registerDisposer(this.group.linkedLayersChanged.add(c)),this.registerDisposer(this.group.layerManager.layersChanged.add(c))}updateModel(){const e=this.selectElement.value;e===""&&this.group.root.value!==this.group.layer?this.group.isolate():this.group.linkByName(e)}updateView(){const{selectElement:e,group:t}=this,{predicate:n}=t;Fe(e);const s=this.group.rootGroup.linkedLayers.size!==0;this.unlinkButton.style.display=s?"":"none";const{linkedLayers:r}=this,o=t.linkedLayers.size!==0;if(r.style.display=o?"":"none",this.unlinkButton.textContent=o?"Unlink all":"Unlink",o){this.element.style.display="",e.style.display="none",Fe(r);for(const l of t.linkedLayers){const c=document.createElement("div");c.classList.add("neuroglancer-linked-layer-widget-layer");const u=_v({title:"Unlink layer",onClick:()=>{this.group.getGroup(l).isolate()}});c.appendChild(u),c.appendChild(document.createTextNode(l.managedLayer.name)),r.appendChild(c)}}else{e.style.display="";const l=document.createElement("option");e.appendChild(l);let c=0;for(const u of this.group.layerManager.managedLayers){const h=u.layer;if(h!==null&&h!==t.layer&&n(h)){++c;const g=document.createElement("option"),{name:v}=u;g.textContent=v,g.value=v,e.appendChild(g)}}e.value=t.toJSON()??"",this.element.style.display=c===0?"none":""}}}const EF=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="maximiseIconTitle">
    <title id="maximiseIconTitle">Maximise View</title>    
    <polyline points="21 16 21 21 16 21"/>
    <polyline points="8 21 3 21 3 16"/>
    <polyline points="16 3 21 3 21 8"/>
    <polyline points="3 8 3 3 8 3"/>
</svg>`;function Yh(i={}){return $e({svg:EF,...i})}var TF=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Vk(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Np={exports:{}},zw;function $a(){return zw||(zw=1,function(i,e){(function(t,n){i.exports=n()})(TF,function(){var t=navigator.userAgent,n=navigator.platform,s=/gecko\/\d/i.test(t),r=/MSIE \d/.test(t),o=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(t),l=/Edge\/(\d+)/.exec(t),c=r||o||l,u=c&&(r?document.documentMode||6:+(l||o)[1]),h=!l&&/WebKit\//.test(t),g=h&&/Qt\/\d+\.\d+/.test(t),v=!l&&/Chrome\/(\d+)/.exec(t),y=v&&+v[1],b=/Opera\//.test(t),w=/Apple Computer/.test(navigator.vendor),C=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(t),E=/PhantomJS/.test(t),k=w&&(/Mobile\/\w+/.test(t)||navigator.maxTouchPoints>2),D=/Android/.test(t),A=k||D||/webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(t),N=k||/Mac/.test(n),I=/\bCrOS\b/.test(t),P=/win/i.test(n),O=b&&t.match(/Version\/(\d*\.\d*)/);O&&(O=Number(O[1])),O&&O>=15&&(b=!1,h=!0);var _=N&&(g||b&&(O==null||O<12.11)),W=s||c&&u>=9;function U(a){return new RegExp("(^|\\s)"+a+"(?:$|\\s)\\s*")}var j=function(a,d){var p=a.className,f=U(d).exec(p);if(f){var m=p.slice(f.index+f[0].length);a.className=p.slice(0,f.index)+(m?f[1]+m:"")}};function B(a){for(var d=a.childNodes.length;d>0;--d)a.removeChild(a.firstChild);return a}function H(a,d){return B(a).appendChild(d)}function V(a,d,p,f){var m=document.createElement(a);if(p&&(m.className=p),f&&(m.style.cssText=f),typeof d=="string")m.appendChild(document.createTextNode(d));else if(d)for(var S=0;S<d.length;++S)m.appendChild(d[S]);return m}function re(a,d,p,f){var m=V(a,d,p,f);return m.setAttribute("role","presentation"),m}var se;document.createRange?se=function(a,d,p,f){var m=document.createRange();return m.setEnd(f||a,p),m.setStart(a,d),m}:se=function(a,d,p){var f=document.body.createTextRange();try{f.moveToElementText(a.parentNode)}catch{return f}return f.collapse(!0),f.moveEnd("character",p),f.moveStart("character",d),f};function ve(a,d){if(d.nodeType==3&&(d=d.parentNode),a.contains)return a.contains(d);do if(d.nodeType==11&&(d=d.host),d==a)return!0;while(d=d.parentNode)}function me(a){var d=a.ownerDocument||a,p;try{p=a.activeElement}catch{p=d.body||null}for(;p&&p.shadowRoot&&p.shadowRoot.activeElement;)p=p.shadowRoot.activeElement;return p}function Ie(a,d){var p=a.className;U(d).test(p)||(a.className+=(p?" ":"")+d)}function We(a,d){for(var p=a.split(" "),f=0;f<p.length;f++)p[f]&&!U(p[f]).test(d)&&(d+=" "+p[f]);return d}var tt=function(a){a.select()};k?tt=function(a){a.selectionStart=0,a.selectionEnd=a.value.length}:c&&(tt=function(a){try{a.select()}catch{}});function rt(a){return a.display.wrapper.ownerDocument}function nt(a){return Ge(a.display.wrapper)}function Ge(a){return a.getRootNode?a.getRootNode():a.ownerDocument}function Te(a){return rt(a).defaultView}function Se(a){var d=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,d)}}function ge(a,d,p){d||(d={});for(var f in a)a.hasOwnProperty(f)&&(p!==!1||!d.hasOwnProperty(f))&&(d[f]=a[f]);return d}function Ce(a,d,p,f,m){d==null&&(d=a.search(/[^\s\u00a0]/),d==-1&&(d=a.length));for(var S=f||0,x=m||0;;){var T=a.indexOf("	",S);if(T<0||T>=d)return x+(d-S);x+=T-S,x+=p-x%p,S=T+1}}var ot=function(){this.id=null,this.f=null,this.time=0,this.handler=Se(this.onTimeout,this)};ot.prototype.onTimeout=function(a){a.id=0,a.time<=+new Date?a.f():setTimeout(a.handler,a.time-+new Date)},ot.prototype.set=function(a,d){this.f=d;var p=+new Date+a;(!this.id||p<this.time)&&(clearTimeout(this.id),this.id=setTimeout(this.handler,a),this.time=p)};function Ae(a,d){for(var p=0;p<a.length;++p)if(a[p]==d)return p;return-1}var Nt=50,Ri={toString:function(){return"CodeMirror.Pass"}},hn={scroll:!1},Fn={origin:"*mouse"},nn={origin:"+move"};function sn(a,d,p){for(var f=0,m=0;;){var S=a.indexOf("	",f);S==-1&&(S=a.length);var x=S-f;if(S==a.length||m+x>=d)return f+Math.min(x,d-m);if(m+=S-f,m+=p-m%p,f=S+1,m>=d)return f}}var fn=[""];function ui(a){for(;fn.length<=a;)fn.push(Oe(fn)+" ");return fn[a]}function Oe(a){return a[a.length-1]}function Un(a,d){for(var p=[],f=0;f<a.length;f++)p[f]=d(a[f],f);return p}function Ns(a,d,p){for(var f=0,m=p(d);f<a.length&&p(a[f])<=m;)f++;a.splice(f,0,d)}function ja(){}function Ms(a,d){var p;return Object.create?p=Object.create(a):(ja.prototype=a,p=new ja),d&&ge(d,p),p}var Ni=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;function Cr(a){return/\w/.test(a)||a>""&&(a.toUpperCase()!=a.toLowerCase()||Ni.test(a))}function hi(a,d){return d?d.source.indexOf("\\w")>-1&&Cr(a)?!0:d.test(a):Cr(a)}function Os(a){for(var d in a)if(a.hasOwnProperty(d)&&a[d])return!1;return!0}var Xi=/[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;function Lt(a){return a.charCodeAt(0)>=768&&Xi.test(a)}function _s(a,d,p){for(;(p<0?d>0:d<a.length)&&Lt(a.charAt(d));)d+=p;return d}function Mi(a,d,p){for(var f=d>p?-1:1;;){if(d==p)return d;var m=(d+p)/2,S=f<0?Math.ceil(m):Math.floor(m);if(S==d)return a(S)?d:p;a(S)?p=S:d=S+f}}function Vs(a,d,p,f){if(!a)return f(d,p,"ltr",0);for(var m=!1,S=0;S<a.length;++S){var x=a[S];(x.from<p&&x.to>d||d==p&&x.to==d)&&(f(Math.max(x.from,d),Math.min(x.to,p),x.level==1?"rtl":"ltr",S),m=!0)}m||f(d,p,"ltr")}var xr=null;function Bs(a,d,p){var f;xr=null;for(var m=0;m<a.length;++m){var S=a[m];if(S.from<d&&S.to>d)return m;S.to==d&&(S.from!=S.to&&p=="before"?f=m:xr=m),S.from==d&&(S.from!=S.to&&p!="before"?f=m:xr=m)}return f??xr}var cf=function(){var a="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN",d="nnnnnnNNr%%r,rNNmmmmmmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmmmnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmnNmmmmmmrrmmNmmmmrr1111111111";function p(R){return R<=247?a.charAt(R):1424<=R&&R<=1524?"R":1536<=R&&R<=1785?d.charAt(R-1536):1774<=R&&R<=2220?"r":8192<=R&&R<=8203?"w":R==8204?"b":"L"}var f=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,m=/[stwN]/,S=/[LRr]/,x=/[Lb1n]/,T=/[1n]/;function L(R,F,$){this.level=R,this.from=F,this.to=$}return function(R,F){var $=F=="ltr"?"L":"R";if(R.length==0||F=="ltr"&&!f.test(R))return!1;for(var q=R.length,Y=[],Z=0;Z<q;++Z)Y.push(p(R.charCodeAt(Z)));for(var ne=0,le=$;ne<q;++ne){var ce=Y[ne];ce=="m"?Y[ne]=le:le=ce}for(var pe=0,de=$;pe<q;++pe){var ye=Y[pe];ye=="1"&&de=="r"?Y[pe]="n":S.test(ye)&&(de=ye,ye=="r"&&(Y[pe]="R"))}for(var Le=1,xe=Y[0];Le<q-1;++Le){var Me=Y[Le];Me=="+"&&xe=="1"&&Y[Le+1]=="1"?Y[Le]="1":Me==","&&xe==Y[Le+1]&&(xe=="1"||xe=="n")&&(Y[Le]=xe),xe=Me}for(var it=0;it<q;++it){var Ft=Y[it];if(Ft==",")Y[it]="N";else if(Ft=="%"){var dt=void 0;for(dt=it+1;dt<q&&Y[dt]=="%";++dt);for(var Ln=it&&Y[it-1]=="!"||dt<q&&Y[dt]=="1"?"1":"N",yn=it;yn<dt;++yn)Y[yn]=Ln;it=dt-1}}for(var Dt=0,Sn=$;Dt<q;++Dt){var Gt=Y[Dt];Sn=="L"&&Gt=="1"?Y[Dt]="L":S.test(Gt)&&(Sn=Gt)}for(var Mt=0;Mt<q;++Mt)if(m.test(Y[Mt])){var It=void 0;for(It=Mt+1;It<q&&m.test(Y[It]);++It);for(var St=(Mt?Y[Mt-1]:$)=="L",bn=(It<q?Y[It]:$)=="L",Go=St==bn?St?"L":"R":$,Xs=Mt;Xs<It;++Xs)Y[Xs]=Go;Mt=It-1}for(var Xt=[],Fi,Ut=0;Ut<q;)if(x.test(Y[Ut])){var ip=Ut;for(++Ut;Ut<q&&x.test(Y[Ut]);++Ut);Xt.push(new L(0,ip,Ut))}else{var rs=Ut,Nr=Xt.length,Mr=F=="rtl"?1:0;for(++Ut;Ut<q&&Y[Ut]!="L";++Ut);for(var on=rs;on<Ut;)if(T.test(Y[on])){rs<on&&(Xt.splice(Nr,0,new L(1,rs,on)),Nr+=Mr);var $o=on;for(++on;on<Ut&&T.test(Y[on]);++on);Xt.splice(Nr,0,new L(2,$o,on)),Nr+=Mr,rs=on}else++on;rs<Ut&&Xt.splice(Nr,0,new L(1,rs,Ut))}return F=="ltr"&&(Xt[0].level==1&&(Fi=R.match(/^\s+/))&&(Xt[0].from=Fi[0].length,Xt.unshift(new L(0,0,Fi[0].length))),Oe(Xt).level==1&&(Fi=R.match(/\s+$/))&&(Oe(Xt).to-=Fi[0].length,Xt.push(new L(0,q-Fi[0].length,q)))),F=="rtl"?Xt.reverse():Xt}}();function Be(a,d){var p=a.order;return p==null&&(p=a.order=cf(a.text,d)),p}var Xc=[],ke=function(a,d,p){if(a.addEventListener)a.addEventListener(d,p,!1);else if(a.attachEvent)a.attachEvent("on"+d,p);else{var f=a._handlers||(a._handlers={});f[d]=(f[d]||Xc).concat(p)}};function Qi(a,d){return a._handlers&&a._handlers[d]||Xc}function Yt(a,d,p){if(a.removeEventListener)a.removeEventListener(d,p,!1);else if(a.detachEvent)a.detachEvent("on"+d,p);else{var f=a._handlers,m=f&&f[d];if(m){var S=Ae(m,p);S>-1&&(f[d]=m.slice(0,S).concat(m.slice(S+1)))}}}function mt(a,d){var p=Qi(a,d);if(p.length)for(var f=Array.prototype.slice.call(arguments,2),m=0;m<p.length;++m)p[m].apply(null,f)}function vt(a,d,p){return typeof d=="string"&&(d={type:d,preventDefault:function(){this.defaultPrevented=!0}}),mt(a,p||d.type,a,d),pn(d)||d.codemirrorIgnore}function zn(a){var d=a._handlers&&a._handlers.cursorActivity;if(d)for(var p=a.curOp.cursorActivityHandlers||(a.curOp.cursorActivityHandlers=[]),f=0;f<d.length;++f)Ae(p,d[f])==-1&&p.push(d[f])}function Tn(a,d){return Qi(a,d).length>0}function fi(a){a.prototype.on=function(d,p){ke(this,d,p)},a.prototype.off=function(d,p){Yt(this,d,p)}}function qt(a){a.preventDefault?a.preventDefault():a.returnValue=!1}function vo(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}function pn(a){return a.defaultPrevented!=null?a.defaultPrevented:a.returnValue==!1}function Fs(a){qt(a),vo(a)}function Ya(a){return a.target||a.srcElement}function pi(a){var d=a.which;return d==null&&(a.button&1?d=1:a.button&2?d=3:a.button&4&&(d=2)),N&&a.ctrlKey&&d==1&&(d=3),d}var df=function(){if(c&&u<9)return!1;var a=V("div");return"draggable"in a||"dragDrop"in a}(),yo;function Qc(a){if(yo==null){var d=V("span","​");H(a,V("span",[d,document.createTextNode("x")])),a.firstChild.offsetHeight!=0&&(yo=d.offsetWidth<=1&&d.offsetHeight>2&&!(c&&u<8))}var p=yo?V("span","​"):V("span"," ",null,"display: inline-block; width: 1px; margin-right: -1px");return p.setAttribute("cm-text",""),p}var qa;function Us(a){if(qa!=null)return qa;var d=H(a,document.createTextNode("AخA")),p=se(d,0,1).getBoundingClientRect(),f=se(d,1,2).getBoundingClientRect();return B(a),!p||p.left==p.right?!1:qa=f.right-p.right<3}var Gn=`

b`.split(/\n/).length!=3?function(a){for(var d=0,p=[],f=a.length;d<=f;){var m=a.indexOf(`
`,d);m==-1&&(m=a.length);var S=a.slice(d,a.charAt(m-1)=="\r"?m-1:m),x=S.indexOf("\r");x!=-1?(p.push(S.slice(0,x)),d+=x+1):(p.push(S),d=m+1)}return p}:function(a){return a.split(/\r\n?|\n/)},zs=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch{return!1}}:function(a){var d;try{d=a.ownerDocument.selection.createRange()}catch{}return!d||d.parentElement()!=a?!1:d.compareEndPoints("StartToEnd",d)!=0},Zc=function(){var a=V("div");return"oncopy"in a?!0:(a.setAttribute("oncopy","return;"),typeof a.oncopy=="function")}(),gi=null;function uf(a){if(gi!=null)return gi;var d=H(a,V("span","x")),p=d.getBoundingClientRect(),f=se(d,0,1).getBoundingClientRect();return gi=Math.abs(p.left-f.left)>1}var So={},mi={};function vi(a,d){arguments.length>2&&(d.dependencies=Array.prototype.slice.call(arguments,2)),So[a]=d}function Er(a,d){mi[a]=d}function bo(a){if(typeof a=="string"&&mi.hasOwnProperty(a))a=mi[a];else if(a&&typeof a.name=="string"&&mi.hasOwnProperty(a.name)){var d=mi[a.name];typeof d=="string"&&(d={name:d}),a=Ms(d,a),a.name=d.name}else{if(typeof a=="string"&&/^[\w\-]+\/[\w\-]+\+xml$/.test(a))return bo("application/xml");if(typeof a=="string"&&/^[\w\-]+\/[\w\-]+\+json$/.test(a))return bo("application/json")}return typeof a=="string"?{name:a}:a||{name:"null"}}function wo(a,d){d=bo(d);var p=So[d.name];if(!p)return wo(a,"text/plain");var f=p(a,d);if(Gs.hasOwnProperty(d.name)){var m=Gs[d.name];for(var S in m)m.hasOwnProperty(S)&&(f.hasOwnProperty(S)&&(f["_"+S]=f[S]),f[S]=m[S])}if(f.name=d.name,d.helperType&&(f.helperType=d.helperType),d.modeProps)for(var x in d.modeProps)f[x]=d.modeProps[x];return f}var Gs={};function Co(a,d){var p=Gs.hasOwnProperty(a)?Gs[a]:Gs[a]={};ge(d,p)}function Oi(a,d){if(d===!0)return d;if(a.copyState)return a.copyState(d);var p={};for(var f in d){var m=d[f];m instanceof Array&&(m=m.concat([])),p[f]=m}return p}function Ka(a,d){for(var p;a.innerMode&&(p=a.innerMode(d),!(!p||p.mode==a));)d=p.state,a=p.mode;return p||{mode:a,state:d}}function xo(a,d,p){return a.startState?a.startState(d,p):!0}var yt=function(a,d,p){this.pos=this.start=0,this.string=a,this.tabSize=d||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0,this.lineOracle=p};yt.prototype.eol=function(){return this.pos>=this.string.length},yt.prototype.sol=function(){return this.pos==this.lineStart},yt.prototype.peek=function(){return this.string.charAt(this.pos)||void 0},yt.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},yt.prototype.eat=function(a){var d=this.string.charAt(this.pos),p;if(typeof a=="string"?p=d==a:p=d&&(a.test?a.test(d):a(d)),p)return++this.pos,d},yt.prototype.eatWhile=function(a){for(var d=this.pos;this.eat(a););return this.pos>d},yt.prototype.eatSpace=function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},yt.prototype.skipToEnd=function(){this.pos=this.string.length},yt.prototype.skipTo=function(a){var d=this.string.indexOf(a,this.pos);if(d>-1)return this.pos=d,!0},yt.prototype.backUp=function(a){this.pos-=a},yt.prototype.column=function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=Ce(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?Ce(this.string,this.lineStart,this.tabSize):0)},yt.prototype.indentation=function(){return Ce(this.string,null,this.tabSize)-(this.lineStart?Ce(this.string,this.lineStart,this.tabSize):0)},yt.prototype.match=function(a,d,p){if(typeof a=="string"){var f=function(x){return p?x.toLowerCase():x},m=this.string.substr(this.pos,a.length);if(f(m)==f(a))return d!==!1&&(this.pos+=a.length),!0}else{var S=this.string.slice(this.pos).match(a);return S&&S.index>0?null:(S&&d!==!1&&(this.pos+=S[0].length),S)}},yt.prototype.current=function(){return this.string.slice(this.start,this.pos)},yt.prototype.hideFirstChars=function(a,d){this.lineStart+=a;try{return d()}finally{this.lineStart-=a}},yt.prototype.lookAhead=function(a){var d=this.lineOracle;return d&&d.lookAhead(a)},yt.prototype.baseToken=function(){var a=this.lineOracle;return a&&a.baseToken(this.pos)};function be(a,d){if(d-=a.first,d<0||d>=a.size)throw new Error("There is no line "+(d+a.first)+" in the document.");for(var p=a;!p.lines;)for(var f=0;;++f){var m=p.children[f],S=m.chunkSize();if(d<S){p=m;break}d-=S}return p.lines[d]}function Zi(a,d,p){var f=[],m=d.line;return a.iter(d.line,p.line+1,function(S){var x=S.text;m==p.line&&(x=x.slice(0,p.ch)),m==d.line&&(x=x.slice(d.ch)),f.push(x),++m}),f}function Xa(a,d,p){var f=[];return a.iter(d,p,function(m){f.push(m.text)}),f}function Rn(a,d){var p=d-a.height;if(p)for(var f=a;f;f=f.parent)f.height+=p}function M(a){if(a.parent==null)return null;for(var d=a.parent,p=Ae(d.lines,a),f=d.parent;f;d=f,f=f.parent)for(var m=0;f.children[m]!=d;++m)p+=f.children[m].chunkSize();return p+d.first}function G(a,d){var p=a.first;e:do{for(var f=0;f<a.children.length;++f){var m=a.children[f],S=m.height;if(d<S){a=m;continue e}d-=S,p+=m.chunkSize()}return p}while(!a.lines);for(var x=0;x<a.lines.length;++x){var T=a.lines[x],L=T.height;if(d<L)break;d-=L}return p+x}function te(a,d){return d>=a.first&&d<a.first+a.size}function ae(a,d){return String(a.lineNumberFormatter(d+a.firstLineNumber))}function Q(a,d,p){if(p===void 0&&(p=null),!(this instanceof Q))return new Q(a,d,p);this.line=a,this.ch=d,this.sticky=p}function he(a,d){return a.line-d.line||a.ch-d.ch}function Ye(a,d){return a.sticky==d.sticky&&he(a,d)==0}function Ot(a){return Q(a.line,a.ch)}function gn(a,d){return he(a,d)<0?d:a}function Eo(a,d){return he(a,d)<0?a:d}function $y(a,d){return Math.max(a.first,Math.min(d,a.first+a.size-1))}function Re(a,d){if(d.line<a.first)return Q(a.first,0);var p=a.first+a.size-1;return d.line>p?Q(p,be(a,p).text.length):xD(d,be(a,d.line).text.length)}function xD(a,d){var p=a.ch;return p==null||p>d?Q(a.line,d):p<0?Q(a.line,0):a}function Wy(a,d){for(var p=[],f=0;f<d.length;f++)p[f]=Re(a,d[f]);return p}var ed=function(a,d){this.state=a,this.lookAhead=d},_i=function(a,d,p,f){this.state=d,this.doc=a,this.line=p,this.maxLookAhead=f||0,this.baseTokens=null,this.baseTokenPos=1};_i.prototype.lookAhead=function(a){var d=this.doc.getLine(this.line+a);return d!=null&&a>this.maxLookAhead&&(this.maxLookAhead=a),d},_i.prototype.baseToken=function(a){if(!this.baseTokens)return null;for(;this.baseTokens[this.baseTokenPos]<=a;)this.baseTokenPos+=2;var d=this.baseTokens[this.baseTokenPos+1];return{type:d&&d.replace(/( |^)overlay .*/,""),size:this.baseTokens[this.baseTokenPos]-a}},_i.prototype.nextLine=function(){this.line++,this.maxLookAhead>0&&this.maxLookAhead--},_i.fromSaved=function(a,d,p){return d instanceof ed?new _i(a,Oi(a.mode,d.state),p,d.lookAhead):new _i(a,Oi(a.mode,d),p)},_i.prototype.save=function(a){var d=a!==!1?Oi(this.doc.mode,this.state):this.state;return this.maxLookAhead>0?new ed(d,this.maxLookAhead):d};function Hy(a,d,p,f){var m=[a.state.modeGen],S={};Xy(a,d.text,a.doc.mode,p,function(R,F){return m.push(R,F)},S,f);for(var x=p.state,T=function(R){p.baseTokens=m;var F=a.state.overlays[R],$=1,q=0;p.state=!0,Xy(a,d.text,F.mode,p,function(Y,Z){for(var ne=$;q<Y;){var le=m[$];le>Y&&m.splice($,1,Y,m[$+1],le),$+=2,q=Math.min(Y,le)}if(Z)if(F.opaque)m.splice(ne,$-ne,Y,"overlay "+Z),$=ne+2;else for(;ne<$;ne+=2){var ce=m[ne+1];m[ne+1]=(ce?ce+" ":"")+"overlay "+Z}},S),p.state=x,p.baseTokens=null,p.baseTokenPos=1},L=0;L<a.state.overlays.length;++L)T(L);return{styles:m,classes:S.bgClass||S.textClass?S:null}}function Jy(a,d,p){if(!d.styles||d.styles[0]!=a.state.modeGen){var f=Qa(a,M(d)),m=d.text.length>a.options.maxHighlightLength&&Oi(a.doc.mode,f.state),S=Hy(a,d,f);m&&(f.state=m),d.stateAfter=f.save(!m),d.styles=S.styles,S.classes?d.styleClasses=S.classes:d.styleClasses&&(d.styleClasses=null),p===a.doc.highlightFrontier&&(a.doc.modeFrontier=Math.max(a.doc.modeFrontier,++a.doc.highlightFrontier))}return d.styles}function Qa(a,d,p){var f=a.doc,m=a.display;if(!f.mode.startState)return new _i(f,!0,d);var S=ED(a,d,p),x=S>f.first&&be(f,S-1).stateAfter,T=x?_i.fromSaved(f,x,S):new _i(f,xo(f.mode),S);return f.iter(S,d,function(L){hf(a,L.text,T);var R=T.line;L.stateAfter=R==d-1||R%5==0||R>=m.viewFrom&&R<m.viewTo?T.save():null,T.nextLine()}),p&&(f.modeFrontier=T.line),T}function hf(a,d,p,f){var m=a.doc.mode,S=new yt(d,a.options.tabSize,p);for(S.start=S.pos=f||0,d==""&&jy(m,p.state);!S.eol();)ff(m,S,p.state),S.start=S.pos}function jy(a,d){if(a.blankLine)return a.blankLine(d);if(a.innerMode){var p=Ka(a,d);if(p.mode.blankLine)return p.mode.blankLine(p.state)}}function ff(a,d,p,f){for(var m=0;m<10;m++){f&&(f[0]=Ka(a,p).mode);var S=a.token(d,p);if(d.pos>d.start)return S}throw new Error("Mode "+a.name+" failed to advance stream.")}var Yy=function(a,d,p){this.start=a.start,this.end=a.pos,this.string=a.current(),this.type=d||null,this.state=p};function qy(a,d,p,f){var m=a.doc,S=m.mode,x;d=Re(m,d);var T=be(m,d.line),L=Qa(a,d.line,p),R=new yt(T.text,a.options.tabSize,L),F;for(f&&(F=[]);(f||R.pos<d.ch)&&!R.eol();)R.start=R.pos,x=ff(S,R,L.state),f&&F.push(new Yy(R,x,Oi(m.mode,L.state)));return f?F:new Yy(R,x,L.state)}function Ky(a,d){if(a)for(;;){var p=a.match(/(?:^|\s+)line-(background-)?(\S+)/);if(!p)break;a=a.slice(0,p.index)+a.slice(p.index+p[0].length);var f=p[1]?"bgClass":"textClass";d[f]==null?d[f]=p[2]:new RegExp("(?:^|\\s)"+p[2]+"(?:$|\\s)").test(d[f])||(d[f]+=" "+p[2])}return a}function Xy(a,d,p,f,m,S,x){var T=p.flattenSpans;T==null&&(T=a.options.flattenSpans);var L=0,R=null,F=new yt(d,a.options.tabSize,f),$,q=a.options.addModeClass&&[null];for(d==""&&Ky(jy(p,f.state),S);!F.eol();){if(F.pos>a.options.maxHighlightLength?(T=!1,x&&hf(a,d,f,F.pos),F.pos=d.length,$=null):$=Ky(ff(p,F,f.state,q),S),q){var Y=q[0].name;Y&&($="m-"+($?Y+" "+$:Y))}if(!T||R!=$){for(;L<F.start;)L=Math.min(F.start,L+5e3),m(L,R);R=$}F.start=F.pos}for(;L<F.pos;){var Z=Math.min(F.pos,L+5e3);m(Z,R),L=Z}}function ED(a,d,p){for(var f,m,S=a.doc,x=p?-1:d-(a.doc.mode.innerMode?1e3:100),T=d;T>x;--T){if(T<=S.first)return S.first;var L=be(S,T-1),R=L.stateAfter;if(R&&(!p||T+(R instanceof ed?R.lookAhead:0)<=S.modeFrontier))return T;var F=Ce(L.text,null,a.options.tabSize);(m==null||f>F)&&(m=T-1,f=F)}return m}function TD(a,d){if(a.modeFrontier=Math.min(a.modeFrontier,d),!(a.highlightFrontier<d-10)){for(var p=a.first,f=d-1;f>p;f--){var m=be(a,f).stateAfter;if(m&&(!(m instanceof ed)||f+m.lookAhead<d)){p=f+1;break}}a.highlightFrontier=Math.min(a.highlightFrontier,p)}}var Qy=!1,es=!1;function kD(){Qy=!0}function LD(){es=!0}function td(a,d,p){this.marker=a,this.from=d,this.to=p}function Za(a,d){if(a)for(var p=0;p<a.length;++p){var f=a[p];if(f.marker==d)return f}}function DD(a,d){for(var p,f=0;f<a.length;++f)a[f]!=d&&(p||(p=[])).push(a[f]);return p}function ID(a,d,p){var f=p&&window.WeakSet&&(p.markedSpans||(p.markedSpans=new WeakSet));f&&a.markedSpans&&f.has(a.markedSpans)?a.markedSpans.push(d):(a.markedSpans=a.markedSpans?a.markedSpans.concat([d]):[d],f&&f.add(a.markedSpans)),d.marker.attachLine(a)}function PD(a,d,p){var f;if(a)for(var m=0;m<a.length;++m){var S=a[m],x=S.marker,T=S.from==null||(x.inclusiveLeft?S.from<=d:S.from<d);if(T||S.from==d&&x.type=="bookmark"&&(!p||!S.marker.insertLeft)){var L=S.to==null||(x.inclusiveRight?S.to>=d:S.to>d);(f||(f=[])).push(new td(x,S.from,L?null:S.to))}}return f}function AD(a,d,p){var f;if(a)for(var m=0;m<a.length;++m){var S=a[m],x=S.marker,T=S.to==null||(x.inclusiveRight?S.to>=d:S.to>d);if(T||S.from==d&&x.type=="bookmark"&&(!p||S.marker.insertLeft)){var L=S.from==null||(x.inclusiveLeft?S.from<=d:S.from<d);(f||(f=[])).push(new td(x,L?null:S.from-d,S.to==null?null:S.to-d))}}return f}function pf(a,d){if(d.full)return null;var p=te(a,d.from.line)&&be(a,d.from.line).markedSpans,f=te(a,d.to.line)&&be(a,d.to.line).markedSpans;if(!p&&!f)return null;var m=d.from.ch,S=d.to.ch,x=he(d.from,d.to)==0,T=PD(p,m,x),L=AD(f,S,x),R=d.text.length==1,F=Oe(d.text).length+(R?m:0);if(T)for(var $=0;$<T.length;++$){var q=T[$];if(q.to==null){var Y=Za(L,q.marker);Y?R&&(q.to=Y.to==null?null:Y.to+F):q.to=m}}if(L)for(var Z=0;Z<L.length;++Z){var ne=L[Z];if(ne.to!=null&&(ne.to+=F),ne.from==null){var le=Za(T,ne.marker);le||(ne.from=F,R&&(T||(T=[])).push(ne))}else ne.from+=F,R&&(T||(T=[])).push(ne)}T&&(T=Zy(T)),L&&L!=T&&(L=Zy(L));var ce=[T];if(!R){var pe=d.text.length-2,de;if(pe>0&&T)for(var ye=0;ye<T.length;++ye)T[ye].to==null&&(de||(de=[])).push(new td(T[ye].marker,null,null));for(var Le=0;Le<pe;++Le)ce.push(de);ce.push(L)}return ce}function Zy(a){for(var d=0;d<a.length;++d){var p=a[d];p.from!=null&&p.from==p.to&&p.marker.clearWhenEmpty!==!1&&a.splice(d--,1)}return a.length?a:null}function RD(a,d,p){var f=null;if(a.iter(d.line,p.line+1,function(Y){if(Y.markedSpans)for(var Z=0;Z<Y.markedSpans.length;++Z){var ne=Y.markedSpans[Z].marker;ne.readOnly&&(!f||Ae(f,ne)==-1)&&(f||(f=[])).push(ne)}}),!f)return null;for(var m=[{from:d,to:p}],S=0;S<f.length;++S)for(var x=f[S],T=x.find(0),L=0;L<m.length;++L){var R=m[L];if(!(he(R.to,T.from)<0||he(R.from,T.to)>0)){var F=[L,1],$=he(R.from,T.from),q=he(R.to,T.to);($<0||!x.inclusiveLeft&&!$)&&F.push({from:R.from,to:T.from}),(q>0||!x.inclusiveRight&&!q)&&F.push({from:T.to,to:R.to}),m.splice.apply(m,F),L+=F.length-3}}return m}function eS(a){var d=a.markedSpans;if(d){for(var p=0;p<d.length;++p)d[p].marker.detachLine(a);a.markedSpans=null}}function tS(a,d){if(d){for(var p=0;p<d.length;++p)d[p].marker.attachLine(a);a.markedSpans=d}}function nd(a){return a.inclusiveLeft?-1:0}function id(a){return a.inclusiveRight?1:0}function gf(a,d){var p=a.lines.length-d.lines.length;if(p!=0)return p;var f=a.find(),m=d.find(),S=he(f.from,m.from)||nd(a)-nd(d);if(S)return-S;var x=he(f.to,m.to)||id(a)-id(d);return x||d.id-a.id}function nS(a,d){var p=es&&a.markedSpans,f;if(p)for(var m=void 0,S=0;S<p.length;++S)m=p[S],m.marker.collapsed&&(d?m.from:m.to)==null&&(!f||gf(f,m.marker)<0)&&(f=m.marker);return f}function iS(a){return nS(a,!0)}function sd(a){return nS(a,!1)}function ND(a,d){var p=es&&a.markedSpans,f;if(p)for(var m=0;m<p.length;++m){var S=p[m];S.marker.collapsed&&(S.from==null||S.from<d)&&(S.to==null||S.to>d)&&(!f||gf(f,S.marker)<0)&&(f=S.marker)}return f}function sS(a,d,p,f,m){var S=be(a,d),x=es&&S.markedSpans;if(x)for(var T=0;T<x.length;++T){var L=x[T];if(L.marker.collapsed){var R=L.marker.find(0),F=he(R.from,p)||nd(L.marker)-nd(m),$=he(R.to,f)||id(L.marker)-id(m);if(!(F>=0&&$<=0||F<=0&&$>=0)&&(F<=0&&(L.marker.inclusiveRight&&m.inclusiveLeft?he(R.to,p)>=0:he(R.to,p)>0)||F>=0&&(L.marker.inclusiveRight&&m.inclusiveLeft?he(R.from,f)<=0:he(R.from,f)<0)))return!0}}}function yi(a){for(var d;d=iS(a);)a=d.find(-1,!0).line;return a}function MD(a){for(var d;d=sd(a);)a=d.find(1,!0).line;return a}function OD(a){for(var d,p;d=sd(a);)a=d.find(1,!0).line,(p||(p=[])).push(a);return p}function mf(a,d){var p=be(a,d),f=yi(p);return p==f?d:M(f)}function rS(a,d){if(d>a.lastLine())return d;var p=be(a,d),f;if(!$s(a,p))return d;for(;f=sd(p);)p=f.find(1,!0).line;return M(p)+1}function $s(a,d){var p=es&&d.markedSpans;if(p){for(var f=void 0,m=0;m<p.length;++m)if(f=p[m],!!f.marker.collapsed){if(f.from==null)return!0;if(!f.marker.widgetNode&&f.from==0&&f.marker.inclusiveLeft&&vf(a,d,f))return!0}}}function vf(a,d,p){if(p.to==null){var f=p.marker.find(1,!0);return vf(a,f.line,Za(f.line.markedSpans,p.marker))}if(p.marker.inclusiveRight&&p.to==d.text.length)return!0;for(var m=void 0,S=0;S<d.markedSpans.length;++S)if(m=d.markedSpans[S],m.marker.collapsed&&!m.marker.widgetNode&&m.from==p.to&&(m.to==null||m.to!=p.from)&&(m.marker.inclusiveLeft||p.marker.inclusiveRight)&&vf(a,d,m))return!0}function ts(a){a=yi(a);for(var d=0,p=a.parent,f=0;f<p.lines.length;++f){var m=p.lines[f];if(m==a)break;d+=m.height}for(var S=p.parent;S;p=S,S=p.parent)for(var x=0;x<S.children.length;++x){var T=S.children[x];if(T==p)break;d+=T.height}return d}function rd(a){if(a.height==0)return 0;for(var d=a.text.length,p,f=a;p=iS(f);){var m=p.find(0,!0);f=m.from.line,d+=m.from.ch-m.to.ch}for(f=a;p=sd(f);){var S=p.find(0,!0);d-=f.text.length-S.from.ch,f=S.to.line,d+=f.text.length-S.to.ch}return d}function yf(a){var d=a.display,p=a.doc;d.maxLine=be(p,p.first),d.maxLineLength=rd(d.maxLine),d.maxLineChanged=!0,p.iter(function(f){var m=rd(f);m>d.maxLineLength&&(d.maxLineLength=m,d.maxLine=f)})}var To=function(a,d,p){this.text=a,tS(this,d),this.height=p?p(this):1};To.prototype.lineNo=function(){return M(this)},fi(To);function _D(a,d,p,f){a.text=d,a.stateAfter&&(a.stateAfter=null),a.styles&&(a.styles=null),a.order!=null&&(a.order=null),eS(a),tS(a,p);var m=f?f(a):1;m!=a.height&&Rn(a,m)}function VD(a){a.parent=null,eS(a)}var BD={},FD={};function oS(a,d){if(!a||/^\s*$/.test(a))return null;var p=d.addModeClass?FD:BD;return p[a]||(p[a]=a.replace(/\S+/g,"cm-$&"))}function aS(a,d){var p=re("span",null,null,h?"padding-right: .1px":null),f={pre:re("pre",[p],"CodeMirror-line"),content:p,col:0,pos:0,cm:a,trailingSpace:!1,splitSpaces:a.getOption("lineWrapping")};d.measure={};for(var m=0;m<=(d.rest?d.rest.length:0);m++){var S=m?d.rest[m-1]:d.line,x=void 0;f.pos=0,f.addToken=zD,Us(a.display.measure)&&(x=Be(S,a.doc.direction))&&(f.addToken=$D(f.addToken,x)),f.map=[];var T=d!=a.display.externalMeasured&&M(S);WD(S,f,Jy(a,S,T)),S.styleClasses&&(S.styleClasses.bgClass&&(f.bgClass=We(S.styleClasses.bgClass,f.bgClass||"")),S.styleClasses.textClass&&(f.textClass=We(S.styleClasses.textClass,f.textClass||""))),f.map.length==0&&f.map.push(0,0,f.content.appendChild(Qc(a.display.measure))),m==0?(d.measure.map=f.map,d.measure.cache={}):((d.measure.maps||(d.measure.maps=[])).push(f.map),(d.measure.caches||(d.measure.caches=[])).push({}))}if(h){var L=f.content.lastChild;(/\bcm-tab\b/.test(L.className)||L.querySelector&&L.querySelector(".cm-tab"))&&(f.content.className="cm-tab-wrap-hack")}return mt(a,"renderLine",a,d.line,f.pre),f.pre.className&&(f.textClass=We(f.pre.className,f.textClass||"")),f}function UD(a){var d=V("span","•","cm-invalidchar");return d.title="\\u"+a.charCodeAt(0).toString(16),d.setAttribute("aria-label",d.title),d}function zD(a,d,p,f,m,S,x){if(d){var T=a.splitSpaces?GD(d,a.trailingSpace):d,L=a.cm.state.specialChars,R=!1,F;if(!L.test(d))a.col+=d.length,F=document.createTextNode(T),a.map.push(a.pos,a.pos+d.length,F),c&&u<9&&(R=!0),a.pos+=d.length;else{F=document.createDocumentFragment();for(var $=0;;){L.lastIndex=$;var q=L.exec(d),Y=q?q.index-$:d.length-$;if(Y){var Z=document.createTextNode(T.slice($,$+Y));c&&u<9?F.appendChild(V("span",[Z])):F.appendChild(Z),a.map.push(a.pos,a.pos+Y,Z),a.col+=Y,a.pos+=Y}if(!q)break;$+=Y+1;var ne=void 0;if(q[0]=="	"){var le=a.cm.options.tabSize,ce=le-a.col%le;ne=F.appendChild(V("span",ui(ce),"cm-tab")),ne.setAttribute("role","presentation"),ne.setAttribute("cm-text","	"),a.col+=ce}else q[0]=="\r"||q[0]==`
`?(ne=F.appendChild(V("span",q[0]=="\r"?"␍":"␤","cm-invalidchar")),ne.setAttribute("cm-text",q[0]),a.col+=1):(ne=a.cm.options.specialCharPlaceholder(q[0]),ne.setAttribute("cm-text",q[0]),c&&u<9?F.appendChild(V("span",[ne])):F.appendChild(ne),a.col+=1);a.map.push(a.pos,a.pos+1,ne),a.pos++}}if(a.trailingSpace=T.charCodeAt(d.length-1)==32,p||f||m||R||S||x){var pe=p||"";f&&(pe+=f),m&&(pe+=m);var de=V("span",[F],pe,S);if(x)for(var ye in x)x.hasOwnProperty(ye)&&ye!="style"&&ye!="class"&&de.setAttribute(ye,x[ye]);return a.content.appendChild(de)}a.content.appendChild(F)}}function GD(a,d){if(a.length>1&&!/  /.test(a))return a;for(var p=d,f="",m=0;m<a.length;m++){var S=a.charAt(m);S==" "&&p&&(m==a.length-1||a.charCodeAt(m+1)==32)&&(S=" "),f+=S,p=S==" "}return f}function $D(a,d){return function(p,f,m,S,x,T,L){m=m?m+" cm-force-border":"cm-force-border";for(var R=p.pos,F=R+f.length;;){for(var $=void 0,q=0;q<d.length&&($=d[q],!($.to>R&&$.from<=R));q++);if($.to>=F)return a(p,f,m,S,x,T,L);a(p,f.slice(0,$.to-R),m,S,null,T,L),S=null,f=f.slice($.to-R),R=$.to}}}function lS(a,d,p,f){var m=!f&&p.widgetNode;m&&a.map.push(a.pos,a.pos+d,m),!f&&a.cm.display.input.needsContentAttribute&&(m||(m=a.content.appendChild(document.createElement("span"))),m.setAttribute("cm-marker",p.id)),m&&(a.cm.display.input.setUneditable(m),a.content.appendChild(m)),a.pos+=d,a.trailingSpace=!1}function WD(a,d,p){var f=a.markedSpans,m=a.text,S=0;if(!f){for(var x=1;x<p.length;x+=2)d.addToken(d,m.slice(S,S=p[x]),oS(p[x+1],d.cm.options));return}for(var T=m.length,L=0,R=1,F="",$,q,Y=0,Z,ne,le,ce,pe;;){if(Y==L){Z=ne=le=q="",pe=null,ce=null,Y=1/0;for(var de=[],ye=void 0,Le=0;Le<f.length;++Le){var xe=f[Le],Me=xe.marker;if(Me.type=="bookmark"&&xe.from==L&&Me.widgetNode)de.push(Me);else if(xe.from<=L&&(xe.to==null||xe.to>L||Me.collapsed&&xe.to==L&&xe.from==L)){if(xe.to!=null&&xe.to!=L&&Y>xe.to&&(Y=xe.to,ne=""),Me.className&&(Z+=" "+Me.className),Me.css&&(q=(q?q+";":"")+Me.css),Me.startStyle&&xe.from==L&&(le+=" "+Me.startStyle),Me.endStyle&&xe.to==Y&&(ye||(ye=[])).push(Me.endStyle,xe.to),Me.title&&((pe||(pe={})).title=Me.title),Me.attributes)for(var it in Me.attributes)(pe||(pe={}))[it]=Me.attributes[it];Me.collapsed&&(!ce||gf(ce.marker,Me)<0)&&(ce=xe)}else xe.from>L&&Y>xe.from&&(Y=xe.from)}if(ye)for(var Ft=0;Ft<ye.length;Ft+=2)ye[Ft+1]==Y&&(ne+=" "+ye[Ft]);if(!ce||ce.from==L)for(var dt=0;dt<de.length;++dt)lS(d,0,de[dt]);if(ce&&(ce.from||0)==L){if(lS(d,(ce.to==null?T+1:ce.to)-L,ce.marker,ce.from==null),ce.to==null)return;ce.to==L&&(ce=!1)}}if(L>=T)break;for(var Ln=Math.min(T,Y);;){if(F){var yn=L+F.length;if(!ce){var Dt=yn>Ln?F.slice(0,Ln-L):F;d.addToken(d,Dt,$?$+Z:Z,le,L+Dt.length==Y?ne:"",q,pe)}if(yn>=Ln){F=F.slice(Ln-L),L=Ln;break}L=yn,le=""}F=m.slice(S,S=p[R++]),$=oS(p[R++],d.cm.options)}}}function cS(a,d,p){this.line=d,this.rest=OD(d),this.size=this.rest?M(Oe(this.rest))-p+1:1,this.node=this.text=null,this.hidden=$s(a,d)}function od(a,d,p){for(var f=[],m,S=d;S<p;S=m){var x=new cS(a.doc,be(a.doc,S),S);m=S+x.size,f.push(x)}return f}var ko=null;function HD(a){ko?ko.ops.push(a):a.ownsGroup=ko={ops:[a],delayedCallbacks:[]}}function JD(a){var d=a.delayedCallbacks,p=0;do{for(;p<d.length;p++)d[p].call(null);for(var f=0;f<a.ops.length;f++){var m=a.ops[f];if(m.cursorActivityHandlers)for(;m.cursorActivityCalled<m.cursorActivityHandlers.length;)m.cursorActivityHandlers[m.cursorActivityCalled++].call(null,m.cm)}}while(p<d.length)}function jD(a,d){var p=a.ownsGroup;if(p)try{JD(p)}finally{ko=null,d(p)}}var el=null;function _t(a,d){var p=Qi(a,d);if(p.length){var f=Array.prototype.slice.call(arguments,2),m;ko?m=ko.delayedCallbacks:el?m=el:(m=el=[],setTimeout(YD,0));for(var S=function(T){m.push(function(){return p[T].apply(null,f)})},x=0;x<p.length;++x)S(x)}}function YD(){var a=el;el=null;for(var d=0;d<a.length;++d)a[d]()}function dS(a,d,p,f){for(var m=0;m<d.changes.length;m++){var S=d.changes[m];S=="text"?KD(a,d):S=="gutter"?hS(a,d,p,f):S=="class"?Sf(a,d):S=="widget"&&XD(a,d,f)}d.changes=null}function tl(a){return a.node==a.text&&(a.node=V("div",null,null,"position: relative"),a.text.parentNode&&a.text.parentNode.replaceChild(a.node,a.text),a.node.appendChild(a.text),c&&u<8&&(a.node.style.zIndex=2)),a.node}function qD(a,d){var p=d.bgClass?d.bgClass+" "+(d.line.bgClass||""):d.line.bgClass;if(p&&(p+=" CodeMirror-linebackground"),d.background)p?d.background.className=p:(d.background.parentNode.removeChild(d.background),d.background=null);else if(p){var f=tl(d);d.background=f.insertBefore(V("div",null,p),f.firstChild),a.display.input.setUneditable(d.background)}}function uS(a,d){var p=a.display.externalMeasured;return p&&p.line==d.line?(a.display.externalMeasured=null,d.measure=p.measure,p.built):aS(a,d)}function KD(a,d){var p=d.text.className,f=uS(a,d);d.text==d.node&&(d.node=f.pre),d.text.parentNode.replaceChild(f.pre,d.text),d.text=f.pre,f.bgClass!=d.bgClass||f.textClass!=d.textClass?(d.bgClass=f.bgClass,d.textClass=f.textClass,Sf(a,d)):p&&(d.text.className=p)}function Sf(a,d){qD(a,d),d.line.wrapClass?tl(d).className=d.line.wrapClass:d.node!=d.text&&(d.node.className="");var p=d.textClass?d.textClass+" "+(d.line.textClass||""):d.line.textClass;d.text.className=p||""}function hS(a,d,p,f){if(d.gutter&&(d.node.removeChild(d.gutter),d.gutter=null),d.gutterBackground&&(d.node.removeChild(d.gutterBackground),d.gutterBackground=null),d.line.gutterClass){var m=tl(d);d.gutterBackground=V("div",null,"CodeMirror-gutter-background "+d.line.gutterClass,"left: "+(a.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px; width: "+f.gutterTotalWidth+"px"),a.display.input.setUneditable(d.gutterBackground),m.insertBefore(d.gutterBackground,d.text)}var S=d.line.gutterMarkers;if(a.options.lineNumbers||S){var x=tl(d),T=d.gutter=V("div",null,"CodeMirror-gutter-wrapper","left: "+(a.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px");if(T.setAttribute("aria-hidden","true"),a.display.input.setUneditable(T),x.insertBefore(T,d.text),d.line.gutterClass&&(T.className+=" "+d.line.gutterClass),a.options.lineNumbers&&(!S||!S["CodeMirror-linenumbers"])&&(d.lineNumber=T.appendChild(V("div",ae(a.options,p),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+a.display.lineNumInnerWidth+"px"))),S)for(var L=0;L<a.display.gutterSpecs.length;++L){var R=a.display.gutterSpecs[L].className,F=S.hasOwnProperty(R)&&S[R];F&&T.appendChild(V("div",[F],"CodeMirror-gutter-elt","left: "+f.gutterLeft[R]+"px; width: "+f.gutterWidth[R]+"px"))}}}function XD(a,d,p){d.alignable&&(d.alignable=null);for(var f=U("CodeMirror-linewidget"),m=d.node.firstChild,S=void 0;m;m=S)S=m.nextSibling,f.test(m.className)&&d.node.removeChild(m);fS(a,d,p)}function QD(a,d,p,f){var m=uS(a,d);return d.text=d.node=m.pre,m.bgClass&&(d.bgClass=m.bgClass),m.textClass&&(d.textClass=m.textClass),Sf(a,d),hS(a,d,p,f),fS(a,d,f),d.node}function fS(a,d,p){if(pS(a,d.line,d,p,!0),d.rest)for(var f=0;f<d.rest.length;f++)pS(a,d.rest[f],d,p,!1)}function pS(a,d,p,f,m){if(d.widgets)for(var S=tl(p),x=0,T=d.widgets;x<T.length;++x){var L=T[x],R=V("div",[L.node],"CodeMirror-linewidget"+(L.className?" "+L.className:""));L.handleMouseEvents||R.setAttribute("cm-ignore-events","true"),ZD(L,R,p,f),a.display.input.setUneditable(R),m&&L.above?S.insertBefore(R,p.gutter||p.text):S.appendChild(R),_t(L,"redraw")}}function ZD(a,d,p,f){if(a.noHScroll){(p.alignable||(p.alignable=[])).push(d);var m=f.wrapperWidth;d.style.left=f.fixedPos+"px",a.coverGutter||(m-=f.gutterTotalWidth,d.style.paddingLeft=f.gutterTotalWidth+"px"),d.style.width=m+"px"}a.coverGutter&&(d.style.zIndex=5,d.style.position="relative",a.noHScroll||(d.style.marginLeft=-f.gutterTotalWidth+"px"))}function nl(a){if(a.height!=null)return a.height;var d=a.doc.cm;if(!d)return 0;if(!ve(document.body,a.node)){var p="position: relative;";a.coverGutter&&(p+="margin-left: -"+d.display.gutters.offsetWidth+"px;"),a.noHScroll&&(p+="width: "+d.display.wrapper.clientWidth+"px;"),H(d.display.measure,V("div",[a.node],null,p))}return a.height=a.node.parentNode.offsetHeight}function ns(a,d){for(var p=Ya(d);p!=a.wrapper;p=p.parentNode)if(!p||p.nodeType==1&&p.getAttribute("cm-ignore-events")=="true"||p.parentNode==a.sizer&&p!=a.mover)return!0}function ad(a){return a.lineSpace.offsetTop}function bf(a){return a.mover.offsetHeight-a.lineSpace.offsetHeight}function gS(a){if(a.cachedPaddingH)return a.cachedPaddingH;var d=H(a.measure,V("pre","x","CodeMirror-line-like")),p=window.getComputedStyle?window.getComputedStyle(d):d.currentStyle,f={left:parseInt(p.paddingLeft),right:parseInt(p.paddingRight)};return!isNaN(f.left)&&!isNaN(f.right)&&(a.cachedPaddingH=f),f}function Vi(a){return Nt-a.display.nativeBarWidth}function Tr(a){return a.display.scroller.clientWidth-Vi(a)-a.display.barWidth}function wf(a){return a.display.scroller.clientHeight-Vi(a)-a.display.barHeight}function eI(a,d,p){var f=a.options.lineWrapping,m=f&&Tr(a);if(!d.measure.heights||f&&d.measure.width!=m){var S=d.measure.heights=[];if(f){d.measure.width=m;for(var x=d.text.firstChild.getClientRects(),T=0;T<x.length-1;T++){var L=x[T],R=x[T+1];Math.abs(L.bottom-R.bottom)>2&&S.push((L.bottom+R.top)/2-p.top)}}S.push(p.bottom-p.top)}}function mS(a,d,p){if(a.line==d)return{map:a.measure.map,cache:a.measure.cache};if(a.rest){for(var f=0;f<a.rest.length;f++)if(a.rest[f]==d)return{map:a.measure.maps[f],cache:a.measure.caches[f]};for(var m=0;m<a.rest.length;m++)if(M(a.rest[m])>p)return{map:a.measure.maps[m],cache:a.measure.caches[m],before:!0}}}function tI(a,d){d=yi(d);var p=M(d),f=a.display.externalMeasured=new cS(a.doc,d,p);f.lineN=p;var m=f.built=aS(a,f);return f.text=m.pre,H(a.display.lineMeasure,m.pre),f}function vS(a,d,p,f){return Bi(a,Lo(a,d),p,f)}function Cf(a,d){if(d>=a.display.viewFrom&&d<a.display.viewTo)return a.display.view[Dr(a,d)];var p=a.display.externalMeasured;if(p&&d>=p.lineN&&d<p.lineN+p.size)return p}function Lo(a,d){var p=M(d),f=Cf(a,p);f&&!f.text?f=null:f&&f.changes&&(dS(a,f,p,Lf(a)),a.curOp.forceUpdate=!0),f||(f=tI(a,d));var m=mS(f,d,p);return{line:d,view:f,rect:null,map:m.map,cache:m.cache,before:m.before,hasHeights:!1}}function Bi(a,d,p,f,m){d.before&&(p=-1);var S=p+(f||""),x;return d.cache.hasOwnProperty(S)?x=d.cache[S]:(d.rect||(d.rect=d.view.text.getBoundingClientRect()),d.hasHeights||(eI(a,d.view,d.rect),d.hasHeights=!0),x=iI(a,d,p,f),x.bogus||(d.cache[S]=x)),{left:x.left,right:x.right,top:m?x.rtop:x.top,bottom:m?x.rbottom:x.bottom}}var yS={left:0,right:0,top:0,bottom:0};function SS(a,d,p){for(var f,m,S,x,T,L,R=0;R<a.length;R+=3)if(T=a[R],L=a[R+1],d<T?(m=0,S=1,x="left"):d<L?(m=d-T,S=m+1):(R==a.length-3||d==L&&a[R+3]>d)&&(S=L-T,m=S-1,d>=L&&(x="right")),m!=null){if(f=a[R+2],T==L&&p==(f.insertLeft?"left":"right")&&(x=p),p=="left"&&m==0)for(;R&&a[R-2]==a[R-3]&&a[R-1].insertLeft;)f=a[(R-=3)+2],x="left";if(p=="right"&&m==L-T)for(;R<a.length-3&&a[R+3]==a[R+4]&&!a[R+5].insertLeft;)f=a[(R+=3)+2],x="right";break}return{node:f,start:m,end:S,collapse:x,coverStart:T,coverEnd:L}}function nI(a,d){var p=yS;if(d=="left")for(var f=0;f<a.length&&(p=a[f]).left==p.right;f++);else for(var m=a.length-1;m>=0&&(p=a[m]).left==p.right;m--);return p}function iI(a,d,p,f){var m=SS(d.map,p,f),S=m.node,x=m.start,T=m.end,L=m.collapse,R;if(S.nodeType==3){for(var F=0;F<4;F++){for(;x&&Lt(d.line.text.charAt(m.coverStart+x));)--x;for(;m.coverStart+T<m.coverEnd&&Lt(d.line.text.charAt(m.coverStart+T));)++T;if(c&&u<9&&x==0&&T==m.coverEnd-m.coverStart?R=S.parentNode.getBoundingClientRect():R=nI(se(S,x,T).getClientRects(),f),R.left||R.right||x==0)break;T=x,x=x-1,L="right"}c&&u<11&&(R=sI(a.display.measure,R))}else{x>0&&(L=f="right");var $;a.options.lineWrapping&&($=S.getClientRects()).length>1?R=$[f=="right"?$.length-1:0]:R=S.getBoundingClientRect()}if(c&&u<9&&!x&&(!R||!R.left&&!R.right)){var q=S.parentNode.getClientRects()[0];q?R={left:q.left,right:q.left+Io(a.display),top:q.top,bottom:q.bottom}:R=yS}for(var Y=R.top-d.rect.top,Z=R.bottom-d.rect.top,ne=(Y+Z)/2,le=d.view.measure.heights,ce=0;ce<le.length-1&&!(ne<le[ce]);ce++);var pe=ce?le[ce-1]:0,de=le[ce],ye={left:(L=="right"?R.right:R.left)-d.rect.left,right:(L=="left"?R.left:R.right)-d.rect.left,top:pe,bottom:de};return!R.left&&!R.right&&(ye.bogus=!0),a.options.singleCursorHeightPerLine||(ye.rtop=Y,ye.rbottom=Z),ye}function sI(a,d){if(!window.screen||screen.logicalXDPI==null||screen.logicalXDPI==screen.deviceXDPI||!uf(a))return d;var p=screen.logicalXDPI/screen.deviceXDPI,f=screen.logicalYDPI/screen.deviceYDPI;return{left:d.left*p,right:d.right*p,top:d.top*f,bottom:d.bottom*f}}function bS(a){if(a.measure&&(a.measure.cache={},a.measure.heights=null,a.rest))for(var d=0;d<a.rest.length;d++)a.measure.caches[d]={}}function wS(a){a.display.externalMeasure=null,B(a.display.lineMeasure);for(var d=0;d<a.display.view.length;d++)bS(a.display.view[d])}function il(a){wS(a),a.display.cachedCharWidth=a.display.cachedTextHeight=a.display.cachedPaddingH=null,a.options.lineWrapping||(a.display.maxLineChanged=!0),a.display.lineNumChars=null}function CS(a){return v&&D?-(a.body.getBoundingClientRect().left-parseInt(getComputedStyle(a.body).marginLeft)):a.defaultView.pageXOffset||(a.documentElement||a.body).scrollLeft}function xS(a){return v&&D?-(a.body.getBoundingClientRect().top-parseInt(getComputedStyle(a.body).marginTop)):a.defaultView.pageYOffset||(a.documentElement||a.body).scrollTop}function xf(a){var d=yi(a),p=d.widgets,f=0;if(p)for(var m=0;m<p.length;++m)p[m].above&&(f+=nl(p[m]));return f}function ld(a,d,p,f,m){if(!m){var S=xf(d);p.top+=S,p.bottom+=S}if(f=="line")return p;f||(f="local");var x=ts(d);if(f=="local"?x+=ad(a.display):x-=a.display.viewOffset,f=="page"||f=="window"){var T=a.display.lineSpace.getBoundingClientRect();x+=T.top+(f=="window"?0:xS(rt(a)));var L=T.left+(f=="window"?0:CS(rt(a)));p.left+=L,p.right+=L}return p.top+=x,p.bottom+=x,p}function ES(a,d,p){if(p=="div")return d;var f=d.left,m=d.top;if(p=="page")f-=CS(rt(a)),m-=xS(rt(a));else if(p=="local"||!p){var S=a.display.sizer.getBoundingClientRect();f+=S.left,m+=S.top}var x=a.display.lineSpace.getBoundingClientRect();return{left:f-x.left,top:m-x.top}}function cd(a,d,p,f,m){return f||(f=be(a.doc,d.line)),ld(a,f,vS(a,f,d.ch,m),p)}function Si(a,d,p,f,m,S){f=f||be(a.doc,d.line),m||(m=Lo(a,f));function x(Z,ne){var le=Bi(a,m,Z,ne?"right":"left",S);return ne?le.left=le.right:le.right=le.left,ld(a,f,le,p)}var T=Be(f,a.doc.direction),L=d.ch,R=d.sticky;if(L>=f.text.length?(L=f.text.length,R="before"):L<=0&&(L=0,R="after"),!T)return x(R=="before"?L-1:L,R=="before");function F(Z,ne,le){var ce=T[ne],pe=ce.level==1;return x(le?Z-1:Z,pe!=le)}var $=Bs(T,L,R),q=xr,Y=F(L,$,R=="before");return q!=null&&(Y.other=F(L,q,R!="before")),Y}function TS(a,d){var p=0;d=Re(a.doc,d),a.options.lineWrapping||(p=Io(a.display)*d.ch);var f=be(a.doc,d.line),m=ts(f)+ad(a.display);return{left:p,right:p,top:m,bottom:m+f.height}}function Ef(a,d,p,f,m){var S=Q(a,d,p);return S.xRel=m,f&&(S.outside=f),S}function Tf(a,d,p){var f=a.doc;if(p+=a.display.viewOffset,p<0)return Ef(f.first,0,null,-1,-1);var m=G(f,p),S=f.first+f.size-1;if(m>S)return Ef(f.first+f.size-1,be(f,S).text.length,null,1,1);d<0&&(d=0);for(var x=be(f,m);;){var T=rI(a,x,m,d,p),L=ND(x,T.ch+(T.xRel>0||T.outside>0?1:0));if(!L)return T;var R=L.find(1);if(R.line==m)return R;x=be(f,m=R.line)}}function kS(a,d,p,f){f-=xf(d);var m=d.text.length,S=Mi(function(x){return Bi(a,p,x-1).bottom<=f},m,0);return m=Mi(function(x){return Bi(a,p,x).top>f},S,m),{begin:S,end:m}}function LS(a,d,p,f){p||(p=Lo(a,d));var m=ld(a,d,Bi(a,p,f),"line").top;return kS(a,d,p,m)}function kf(a,d,p,f){return a.bottom<=p?!1:a.top>p?!0:(f?a.left:a.right)>d}function rI(a,d,p,f,m){m-=ts(d);var S=Lo(a,d),x=xf(d),T=0,L=d.text.length,R=!0,F=Be(d,a.doc.direction);if(F){var $=(a.options.lineWrapping?aI:oI)(a,d,p,S,F,f,m);R=$.level!=1,T=R?$.from:$.to-1,L=R?$.to:$.from-1}var q=null,Y=null,Z=Mi(function(Le){var xe=Bi(a,S,Le);return xe.top+=x,xe.bottom+=x,kf(xe,f,m,!1)?(xe.top<=m&&xe.left<=f&&(q=Le,Y=xe),!0):!1},T,L),ne,le,ce=!1;if(Y){var pe=f-Y.left<Y.right-f,de=pe==R;Z=q+(de?0:1),le=de?"after":"before",ne=pe?Y.left:Y.right}else{!R&&(Z==L||Z==T)&&Z++,le=Z==0?"after":Z==d.text.length?"before":Bi(a,S,Z-(R?1:0)).bottom+x<=m==R?"after":"before";var ye=Si(a,Q(p,Z,le),"line",d,S);ne=ye.left,ce=m<ye.top?-1:m>=ye.bottom?1:0}return Z=_s(d.text,Z,1),Ef(p,Z,le,ce,f-ne)}function oI(a,d,p,f,m,S,x){var T=Mi(function($){var q=m[$],Y=q.level!=1;return kf(Si(a,Q(p,Y?q.to:q.from,Y?"before":"after"),"line",d,f),S,x,!0)},0,m.length-1),L=m[T];if(T>0){var R=L.level!=1,F=Si(a,Q(p,R?L.from:L.to,R?"after":"before"),"line",d,f);kf(F,S,x,!0)&&F.top>x&&(L=m[T-1])}return L}function aI(a,d,p,f,m,S,x){var T=kS(a,d,f,x),L=T.begin,R=T.end;/\s/.test(d.text.charAt(R-1))&&R--;for(var F=null,$=null,q=0;q<m.length;q++){var Y=m[q];if(!(Y.from>=R||Y.to<=L)){var Z=Y.level!=1,ne=Bi(a,f,Z?Math.min(R,Y.to)-1:Math.max(L,Y.from)).right,le=ne<S?S-ne+1e9:ne-S;(!F||$>le)&&(F=Y,$=le)}}return F||(F=m[m.length-1]),F.from<L&&(F={from:L,to:F.to,level:F.level}),F.to>R&&(F={from:F.from,to:R,level:F.level}),F}var kr;function Do(a){if(a.cachedTextHeight!=null)return a.cachedTextHeight;if(kr==null){kr=V("pre",null,"CodeMirror-line-like");for(var d=0;d<49;++d)kr.appendChild(document.createTextNode("x")),kr.appendChild(V("br"));kr.appendChild(document.createTextNode("x"))}H(a.measure,kr);var p=kr.offsetHeight/50;return p>3&&(a.cachedTextHeight=p),B(a.measure),p||1}function Io(a){if(a.cachedCharWidth!=null)return a.cachedCharWidth;var d=V("span","xxxxxxxxxx"),p=V("pre",[d],"CodeMirror-line-like");H(a.measure,p);var f=d.getBoundingClientRect(),m=(f.right-f.left)/10;return m>2&&(a.cachedCharWidth=m),m||10}function Lf(a){for(var d=a.display,p={},f={},m=d.gutters.clientLeft,S=d.gutters.firstChild,x=0;S;S=S.nextSibling,++x){var T=a.display.gutterSpecs[x].className;p[T]=S.offsetLeft+S.clientLeft+m,f[T]=S.clientWidth}return{fixedPos:Df(d),gutterTotalWidth:d.gutters.offsetWidth,gutterLeft:p,gutterWidth:f,wrapperWidth:d.wrapper.clientWidth}}function Df(a){return a.scroller.getBoundingClientRect().left-a.sizer.getBoundingClientRect().left}function DS(a){var d=Do(a.display),p=a.options.lineWrapping,f=p&&Math.max(5,a.display.scroller.clientWidth/Io(a.display)-3);return function(m){if($s(a.doc,m))return 0;var S=0;if(m.widgets)for(var x=0;x<m.widgets.length;x++)m.widgets[x].height&&(S+=m.widgets[x].height);return p?S+(Math.ceil(m.text.length/f)||1)*d:S+d}}function If(a){var d=a.doc,p=DS(a);d.iter(function(f){var m=p(f);m!=f.height&&Rn(f,m)})}function Lr(a,d,p,f){var m=a.display;if(!p&&Ya(d).getAttribute("cm-not-content")=="true")return null;var S,x,T=m.lineSpace.getBoundingClientRect();try{S=d.clientX-T.left,x=d.clientY-T.top}catch{return null}var L=Tf(a,S,x),R;if(f&&L.xRel>0&&(R=be(a.doc,L.line).text).length==L.ch){var F=Ce(R,R.length,a.options.tabSize)-R.length;L=Q(L.line,Math.max(0,Math.round((S-gS(a.display).left)/Io(a.display))-F))}return L}function Dr(a,d){if(d>=a.display.viewTo||(d-=a.display.viewFrom,d<0))return null;for(var p=a.display.view,f=0;f<p.length;f++)if(d-=p[f].size,d<0)return f}function mn(a,d,p,f){d==null&&(d=a.doc.first),p==null&&(p=a.doc.first+a.doc.size),f||(f=0);var m=a.display;if(f&&p<m.viewTo&&(m.updateLineNumbers==null||m.updateLineNumbers>d)&&(m.updateLineNumbers=d),a.curOp.viewChanged=!0,d>=m.viewTo)es&&mf(a.doc,d)<m.viewTo&&Hs(a);else if(p<=m.viewFrom)es&&rS(a.doc,p+f)>m.viewFrom?Hs(a):(m.viewFrom+=f,m.viewTo+=f);else if(d<=m.viewFrom&&p>=m.viewTo)Hs(a);else if(d<=m.viewFrom){var S=dd(a,p,p+f,1);S?(m.view=m.view.slice(S.index),m.viewFrom=S.lineN,m.viewTo+=f):Hs(a)}else if(p>=m.viewTo){var x=dd(a,d,d,-1);x?(m.view=m.view.slice(0,x.index),m.viewTo=x.lineN):Hs(a)}else{var T=dd(a,d,d,-1),L=dd(a,p,p+f,1);T&&L?(m.view=m.view.slice(0,T.index).concat(od(a,T.lineN,L.lineN)).concat(m.view.slice(L.index)),m.viewTo+=f):Hs(a)}var R=m.externalMeasured;R&&(p<R.lineN?R.lineN+=f:d<R.lineN+R.size&&(m.externalMeasured=null))}function Ws(a,d,p){a.curOp.viewChanged=!0;var f=a.display,m=a.display.externalMeasured;if(m&&d>=m.lineN&&d<m.lineN+m.size&&(f.externalMeasured=null),!(d<f.viewFrom||d>=f.viewTo)){var S=f.view[Dr(a,d)];if(S.node!=null){var x=S.changes||(S.changes=[]);Ae(x,p)==-1&&x.push(p)}}}function Hs(a){a.display.viewFrom=a.display.viewTo=a.doc.first,a.display.view=[],a.display.viewOffset=0}function dd(a,d,p,f){var m=Dr(a,d),S,x=a.display.view;if(!es||p==a.doc.first+a.doc.size)return{index:m,lineN:p};for(var T=a.display.viewFrom,L=0;L<m;L++)T+=x[L].size;if(T!=d){if(f>0){if(m==x.length-1)return null;S=T+x[m].size-d,m++}else S=T-d;d+=S,p+=S}for(;mf(a.doc,p)!=p;){if(m==(f<0?0:x.length-1))return null;p+=f*x[m-(f<0?1:0)].size,m+=f}return{index:m,lineN:p}}function lI(a,d,p){var f=a.display,m=f.view;m.length==0||d>=f.viewTo||p<=f.viewFrom?(f.view=od(a,d,p),f.viewFrom=d):(f.viewFrom>d?f.view=od(a,d,f.viewFrom).concat(f.view):f.viewFrom<d&&(f.view=f.view.slice(Dr(a,d))),f.viewFrom=d,f.viewTo<p?f.view=f.view.concat(od(a,f.viewTo,p)):f.viewTo>p&&(f.view=f.view.slice(0,Dr(a,p)))),f.viewTo=p}function IS(a){for(var d=a.display.view,p=0,f=0;f<d.length;f++){var m=d[f];!m.hidden&&(!m.node||m.changes)&&++p}return p}function sl(a){a.display.input.showSelection(a.display.input.prepareSelection())}function PS(a,d){d===void 0&&(d=!0);var p=a.doc,f={},m=f.cursors=document.createDocumentFragment(),S=f.selection=document.createDocumentFragment(),x=a.options.$customCursor;x&&(d=!0);for(var T=0;T<p.sel.ranges.length;T++)if(!(!d&&T==p.sel.primIndex)){var L=p.sel.ranges[T];if(!(L.from().line>=a.display.viewTo||L.to().line<a.display.viewFrom)){var R=L.empty();if(x){var F=x(a,L);F&&Pf(a,F,m)}else(R||a.options.showCursorWhenSelecting)&&Pf(a,L.head,m);R||cI(a,L,S)}}return f}function Pf(a,d,p){var f=Si(a,d,"div",null,null,!a.options.singleCursorHeightPerLine),m=p.appendChild(V("div"," ","CodeMirror-cursor"));if(m.style.left=f.left+"px",m.style.top=f.top+"px",m.style.height=Math.max(0,f.bottom-f.top)*a.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(a.getWrapperElement().className)){var S=cd(a,d,"div",null,null),x=S.right-S.left;m.style.width=(x>0?x:a.defaultCharWidth())+"px"}if(f.other){var T=p.appendChild(V("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));T.style.display="",T.style.left=f.other.left+"px",T.style.top=f.other.top+"px",T.style.height=(f.other.bottom-f.other.top)*.85+"px"}}function ud(a,d){return a.top-d.top||a.left-d.left}function cI(a,d,p){var f=a.display,m=a.doc,S=document.createDocumentFragment(),x=gS(a.display),T=x.left,L=Math.max(f.sizerWidth,Tr(a)-f.sizer.offsetLeft)-x.right,R=m.direction=="ltr";function F(de,ye,Le,xe){ye<0&&(ye=0),ye=Math.round(ye),xe=Math.round(xe),S.appendChild(V("div",null,"CodeMirror-selected","position: absolute; left: "+de+`px;
                             top: `+ye+"px; width: "+(Le??L-de)+`px;
                             height: `+(xe-ye)+"px"))}function $(de,ye,Le){var xe=be(m,de),Me=xe.text.length,it,Ft;function dt(Dt,Sn){return cd(a,Q(de,Dt),"div",xe,Sn)}function Ln(Dt,Sn,Gt){var Mt=LS(a,xe,null,Dt),It=Sn=="ltr"==(Gt=="after")?"left":"right",St=Gt=="after"?Mt.begin:Mt.end-(/\s/.test(xe.text.charAt(Mt.end-1))?2:1);return dt(St,It)[It]}var yn=Be(xe,m.direction);return Vs(yn,ye||0,Le??Me,function(Dt,Sn,Gt,Mt){var It=Gt=="ltr",St=dt(Dt,It?"left":"right"),bn=dt(Sn-1,It?"right":"left"),Go=ye==null&&Dt==0,Xs=Le==null&&Sn==Me,Xt=Mt==0,Fi=!yn||Mt==yn.length-1;if(bn.top-St.top<=3){var Ut=(R?Go:Xs)&&Xt,ip=(R?Xs:Go)&&Fi,rs=Ut?T:(It?St:bn).left,Nr=ip?L:(It?bn:St).right;F(rs,St.top,Nr-rs,St.bottom)}else{var Mr,on,$o,sp;It?(Mr=R&&Go&&Xt?T:St.left,on=R?L:Ln(Dt,Gt,"before"),$o=R?T:Ln(Sn,Gt,"after"),sp=R&&Xs&&Fi?L:bn.right):(Mr=R?Ln(Dt,Gt,"before"):T,on=!R&&Go&&Xt?L:St.right,$o=!R&&Xs&&Fi?T:bn.left,sp=R?Ln(Sn,Gt,"after"):L),F(Mr,St.top,on-Mr,St.bottom),St.bottom<bn.top&&F(T,St.bottom,null,bn.top),F($o,bn.top,sp-$o,bn.bottom)}(!it||ud(St,it)<0)&&(it=St),ud(bn,it)<0&&(it=bn),(!Ft||ud(St,Ft)<0)&&(Ft=St),ud(bn,Ft)<0&&(Ft=bn)}),{start:it,end:Ft}}var q=d.from(),Y=d.to();if(q.line==Y.line)$(q.line,q.ch,Y.ch);else{var Z=be(m,q.line),ne=be(m,Y.line),le=yi(Z)==yi(ne),ce=$(q.line,q.ch,le?Z.text.length+1:null).end,pe=$(Y.line,le?0:null,Y.ch).start;le&&(ce.top<pe.top-2?(F(ce.right,ce.top,null,ce.bottom),F(T,pe.top,pe.left,pe.bottom)):F(ce.right,ce.top,pe.left-ce.right,ce.bottom)),ce.bottom<pe.top&&F(T,ce.bottom,null,pe.top)}p.appendChild(S)}function Af(a){if(a.state.focused){var d=a.display;clearInterval(d.blinker);var p=!0;d.cursorDiv.style.visibility="",a.options.cursorBlinkRate>0?d.blinker=setInterval(function(){a.hasFocus()||Po(a),d.cursorDiv.style.visibility=(p=!p)?"":"hidden"},a.options.cursorBlinkRate):a.options.cursorBlinkRate<0&&(d.cursorDiv.style.visibility="hidden")}}function AS(a){a.hasFocus()||(a.display.input.focus(),a.state.focused||Nf(a))}function Rf(a){a.state.delayingBlurEvent=!0,setTimeout(function(){a.state.delayingBlurEvent&&(a.state.delayingBlurEvent=!1,a.state.focused&&Po(a))},100)}function Nf(a,d){a.state.delayingBlurEvent&&!a.state.draggingText&&(a.state.delayingBlurEvent=!1),a.options.readOnly!="nocursor"&&(a.state.focused||(mt(a,"focus",a,d),a.state.focused=!0,Ie(a.display.wrapper,"CodeMirror-focused"),!a.curOp&&a.display.selForContextMenu!=a.doc.sel&&(a.display.input.reset(),h&&setTimeout(function(){return a.display.input.reset(!0)},20)),a.display.input.receivedFocus()),Af(a))}function Po(a,d){a.state.delayingBlurEvent||(a.state.focused&&(mt(a,"blur",a,d),a.state.focused=!1,j(a.display.wrapper,"CodeMirror-focused")),clearInterval(a.display.blinker),setTimeout(function(){a.state.focused||(a.display.shift=!1)},150))}function hd(a){for(var d=a.display,p=d.lineDiv.offsetTop,f=Math.max(0,d.scroller.getBoundingClientRect().top),m=d.lineDiv.getBoundingClientRect().top,S=0,x=0;x<d.view.length;x++){var T=d.view[x],L=a.options.lineWrapping,R=void 0,F=0;if(!T.hidden){if(m+=T.line.height,c&&u<8){var $=T.node.offsetTop+T.node.offsetHeight;R=$-p,p=$}else{var q=T.node.getBoundingClientRect();R=q.bottom-q.top,!L&&T.text.firstChild&&(F=T.text.firstChild.getBoundingClientRect().right-q.left-1)}var Y=T.line.height-R;if((Y>.005||Y<-.005)&&(m<f&&(S-=Y),Rn(T.line,R),RS(T.line),T.rest))for(var Z=0;Z<T.rest.length;Z++)RS(T.rest[Z]);if(F>a.display.sizerWidth){var ne=Math.ceil(F/Io(a.display));ne>a.display.maxLineLength&&(a.display.maxLineLength=ne,a.display.maxLine=T.line,a.display.maxLineChanged=!0)}}}Math.abs(S)>2&&(d.scroller.scrollTop+=S)}function RS(a){if(a.widgets)for(var d=0;d<a.widgets.length;++d){var p=a.widgets[d],f=p.node.parentNode;f&&(p.height=f.offsetHeight)}}function fd(a,d,p){var f=p&&p.top!=null?Math.max(0,p.top):a.scroller.scrollTop;f=Math.floor(f-ad(a));var m=p&&p.bottom!=null?p.bottom:f+a.wrapper.clientHeight,S=G(d,f),x=G(d,m);if(p&&p.ensure){var T=p.ensure.from.line,L=p.ensure.to.line;T<S?(S=T,x=G(d,ts(be(d,T))+a.wrapper.clientHeight)):Math.min(L,d.lastLine())>=x&&(S=G(d,ts(be(d,L))-a.wrapper.clientHeight),x=L)}return{from:S,to:Math.max(x,S+1)}}function dI(a,d){if(!vt(a,"scrollCursorIntoView")){var p=a.display,f=p.sizer.getBoundingClientRect(),m=null,S=p.wrapper.ownerDocument;if(d.top+f.top<0?m=!0:d.bottom+f.top>(S.defaultView.innerHeight||S.documentElement.clientHeight)&&(m=!1),m!=null&&!E){var x=V("div","​",null,`position: absolute;
                         top: `+(d.top-p.viewOffset-ad(a.display))+`px;
                         height: `+(d.bottom-d.top+Vi(a)+p.barHeight)+`px;
                         left: `+d.left+"px; width: "+Math.max(2,d.right-d.left)+"px;");a.display.lineSpace.appendChild(x),x.scrollIntoView(m),a.display.lineSpace.removeChild(x)}}}function uI(a,d,p,f){f==null&&(f=0);var m;!a.options.lineWrapping&&d==p&&(p=d.sticky=="before"?Q(d.line,d.ch+1,"before"):d,d=d.ch?Q(d.line,d.sticky=="before"?d.ch-1:d.ch,"after"):d);for(var S=0;S<5;S++){var x=!1,T=Si(a,d),L=!p||p==d?T:Si(a,p);m={left:Math.min(T.left,L.left),top:Math.min(T.top,L.top)-f,right:Math.max(T.left,L.left),bottom:Math.max(T.bottom,L.bottom)+f};var R=Mf(a,m),F=a.doc.scrollTop,$=a.doc.scrollLeft;if(R.scrollTop!=null&&(ol(a,R.scrollTop),Math.abs(a.doc.scrollTop-F)>1&&(x=!0)),R.scrollLeft!=null&&(Ir(a,R.scrollLeft),Math.abs(a.doc.scrollLeft-$)>1&&(x=!0)),!x)break}return m}function hI(a,d){var p=Mf(a,d);p.scrollTop!=null&&ol(a,p.scrollTop),p.scrollLeft!=null&&Ir(a,p.scrollLeft)}function Mf(a,d){var p=a.display,f=Do(a.display);d.top<0&&(d.top=0);var m=a.curOp&&a.curOp.scrollTop!=null?a.curOp.scrollTop:p.scroller.scrollTop,S=wf(a),x={};d.bottom-d.top>S&&(d.bottom=d.top+S);var T=a.doc.height+bf(p),L=d.top<f,R=d.bottom>T-f;if(d.top<m)x.scrollTop=L?0:d.top;else if(d.bottom>m+S){var F=Math.min(d.top,(R?T:d.bottom)-S);F!=m&&(x.scrollTop=F)}var $=a.options.fixedGutter?0:p.gutters.offsetWidth,q=a.curOp&&a.curOp.scrollLeft!=null?a.curOp.scrollLeft:p.scroller.scrollLeft-$,Y=Tr(a)-p.gutters.offsetWidth,Z=d.right-d.left>Y;return Z&&(d.right=d.left+Y),d.left<10?x.scrollLeft=0:d.left<q?x.scrollLeft=Math.max(0,d.left+$-(Z?0:10)):d.right>Y+q-3&&(x.scrollLeft=d.right+(Z?0:10)-Y),x}function Of(a,d){d!=null&&(pd(a),a.curOp.scrollTop=(a.curOp.scrollTop==null?a.doc.scrollTop:a.curOp.scrollTop)+d)}function Ao(a){pd(a);var d=a.getCursor();a.curOp.scrollToPos={from:d,to:d,margin:a.options.cursorScrollMargin}}function rl(a,d,p){(d!=null||p!=null)&&pd(a),d!=null&&(a.curOp.scrollLeft=d),p!=null&&(a.curOp.scrollTop=p)}function fI(a,d){pd(a),a.curOp.scrollToPos=d}function pd(a){var d=a.curOp.scrollToPos;if(d){a.curOp.scrollToPos=null;var p=TS(a,d.from),f=TS(a,d.to);NS(a,p,f,d.margin)}}function NS(a,d,p,f){var m=Mf(a,{left:Math.min(d.left,p.left),top:Math.min(d.top,p.top)-f,right:Math.max(d.right,p.right),bottom:Math.max(d.bottom,p.bottom)+f});rl(a,m.scrollLeft,m.scrollTop)}function ol(a,d){Math.abs(a.doc.scrollTop-d)<2||(s||Vf(a,{top:d}),MS(a,d,!0),s&&Vf(a),cl(a,100))}function MS(a,d,p){d=Math.max(0,Math.min(a.display.scroller.scrollHeight-a.display.scroller.clientHeight,d)),!(a.display.scroller.scrollTop==d&&!p)&&(a.doc.scrollTop=d,a.display.scrollbars.setScrollTop(d),a.display.scroller.scrollTop!=d&&(a.display.scroller.scrollTop=d))}function Ir(a,d,p,f){d=Math.max(0,Math.min(d,a.display.scroller.scrollWidth-a.display.scroller.clientWidth)),!((p?d==a.doc.scrollLeft:Math.abs(a.doc.scrollLeft-d)<2)&&!f)&&(a.doc.scrollLeft=d,FS(a),a.display.scroller.scrollLeft!=d&&(a.display.scroller.scrollLeft=d),a.display.scrollbars.setScrollLeft(d))}function al(a){var d=a.display,p=d.gutters.offsetWidth,f=Math.round(a.doc.height+bf(a.display));return{clientHeight:d.scroller.clientHeight,viewHeight:d.wrapper.clientHeight,scrollWidth:d.scroller.scrollWidth,clientWidth:d.scroller.clientWidth,viewWidth:d.wrapper.clientWidth,barLeft:a.options.fixedGutter?p:0,docHeight:f,scrollHeight:f+Vi(a)+d.barHeight,nativeBarWidth:d.nativeBarWidth,gutterWidth:p}}var Pr=function(a,d,p){this.cm=p;var f=this.vert=V("div",[V("div",null,null,"min-width: 1px")],"CodeMirror-vscrollbar"),m=this.horiz=V("div",[V("div",null,null,"height: 100%; min-height: 1px")],"CodeMirror-hscrollbar");f.tabIndex=m.tabIndex=-1,a(f),a(m),ke(f,"scroll",function(){f.clientHeight&&d(f.scrollTop,"vertical")}),ke(m,"scroll",function(){m.clientWidth&&d(m.scrollLeft,"horizontal")}),this.checkedZeroWidth=!1,c&&u<8&&(this.horiz.style.minHeight=this.vert.style.minWidth="18px")};Pr.prototype.update=function(a){var d=a.scrollWidth>a.clientWidth+1,p=a.scrollHeight>a.clientHeight+1,f=a.nativeBarWidth;if(p){this.vert.style.display="block",this.vert.style.bottom=d?f+"px":"0";var m=a.viewHeight-(d?f:0);this.vert.firstChild.style.height=Math.max(0,a.scrollHeight-a.clientHeight+m)+"px"}else this.vert.scrollTop=0,this.vert.style.display="",this.vert.firstChild.style.height="0";if(d){this.horiz.style.display="block",this.horiz.style.right=p?f+"px":"0",this.horiz.style.left=a.barLeft+"px";var S=a.viewWidth-a.barLeft-(p?f:0);this.horiz.firstChild.style.width=Math.max(0,a.scrollWidth-a.clientWidth+S)+"px"}else this.horiz.style.display="",this.horiz.firstChild.style.width="0";return!this.checkedZeroWidth&&a.clientHeight>0&&(f==0&&this.zeroWidthHack(),this.checkedZeroWidth=!0),{right:p?f:0,bottom:d?f:0}},Pr.prototype.setScrollLeft=function(a){this.horiz.scrollLeft!=a&&(this.horiz.scrollLeft=a),this.disableHoriz&&this.enableZeroWidthBar(this.horiz,this.disableHoriz,"horiz")},Pr.prototype.setScrollTop=function(a){this.vert.scrollTop!=a&&(this.vert.scrollTop=a),this.disableVert&&this.enableZeroWidthBar(this.vert,this.disableVert,"vert")},Pr.prototype.zeroWidthHack=function(){var a=N&&!C?"12px":"18px";this.horiz.style.height=this.vert.style.width=a,this.horiz.style.visibility=this.vert.style.visibility="hidden",this.disableHoriz=new ot,this.disableVert=new ot},Pr.prototype.enableZeroWidthBar=function(a,d,p){a.style.visibility="";function f(){var m=a.getBoundingClientRect(),S=p=="vert"?document.elementFromPoint(m.right-1,(m.top+m.bottom)/2):document.elementFromPoint((m.right+m.left)/2,m.bottom-1);S!=a?a.style.visibility="hidden":d.set(1e3,f)}d.set(1e3,f)},Pr.prototype.clear=function(){var a=this.horiz.parentNode;a.removeChild(this.horiz),a.removeChild(this.vert)};var ll=function(){};ll.prototype.update=function(){return{bottom:0,right:0}},ll.prototype.setScrollLeft=function(){},ll.prototype.setScrollTop=function(){},ll.prototype.clear=function(){};function Ro(a,d){d||(d=al(a));var p=a.display.barWidth,f=a.display.barHeight;OS(a,d);for(var m=0;m<4&&p!=a.display.barWidth||f!=a.display.barHeight;m++)p!=a.display.barWidth&&a.options.lineWrapping&&hd(a),OS(a,al(a)),p=a.display.barWidth,f=a.display.barHeight}function OS(a,d){var p=a.display,f=p.scrollbars.update(d);p.sizer.style.paddingRight=(p.barWidth=f.right)+"px",p.sizer.style.paddingBottom=(p.barHeight=f.bottom)+"px",p.heightForcer.style.borderBottom=f.bottom+"px solid transparent",f.right&&f.bottom?(p.scrollbarFiller.style.display="block",p.scrollbarFiller.style.height=f.bottom+"px",p.scrollbarFiller.style.width=f.right+"px"):p.scrollbarFiller.style.display="",f.bottom&&a.options.coverGutterNextToScrollbar&&a.options.fixedGutter?(p.gutterFiller.style.display="block",p.gutterFiller.style.height=f.bottom+"px",p.gutterFiller.style.width=d.gutterWidth+"px"):p.gutterFiller.style.display=""}var _S={native:Pr,null:ll};function VS(a){a.display.scrollbars&&(a.display.scrollbars.clear(),a.display.scrollbars.addClass&&j(a.display.wrapper,a.display.scrollbars.addClass)),a.display.scrollbars=new _S[a.options.scrollbarStyle](function(d){a.display.wrapper.insertBefore(d,a.display.scrollbarFiller),ke(d,"mousedown",function(){a.state.focused&&setTimeout(function(){return a.display.input.focus()},0)}),d.setAttribute("cm-not-content","true")},function(d,p){p=="horizontal"?Ir(a,d):ol(a,d)},a),a.display.scrollbars.addClass&&Ie(a.display.wrapper,a.display.scrollbars.addClass)}var pI=0;function Ar(a){a.curOp={cm:a,viewChanged:!1,startHeight:a.doc.height,forceUpdate:!1,updateInput:0,typing:!1,changeObjs:null,cursorActivityHandlers:null,cursorActivityCalled:0,selectionChanged:!1,updateMaxLine:!1,scrollLeft:null,scrollTop:null,scrollToPos:null,focus:!1,id:++pI,markArrays:null},HD(a.curOp)}function Rr(a){var d=a.curOp;d&&jD(d,function(p){for(var f=0;f<p.ops.length;f++)p.ops[f].cm.curOp=null;gI(p)})}function gI(a){for(var d=a.ops,p=0;p<d.length;p++)mI(d[p]);for(var f=0;f<d.length;f++)vI(d[f]);for(var m=0;m<d.length;m++)yI(d[m]);for(var S=0;S<d.length;S++)SI(d[S]);for(var x=0;x<d.length;x++)bI(d[x])}function mI(a){var d=a.cm,p=d.display;CI(d),a.updateMaxLine&&yf(d),a.mustUpdate=a.viewChanged||a.forceUpdate||a.scrollTop!=null||a.scrollToPos&&(a.scrollToPos.from.line<p.viewFrom||a.scrollToPos.to.line>=p.viewTo)||p.maxLineChanged&&d.options.lineWrapping,a.update=a.mustUpdate&&new gd(d,a.mustUpdate&&{top:a.scrollTop,ensure:a.scrollToPos},a.forceUpdate)}function vI(a){a.updatedDisplay=a.mustUpdate&&_f(a.cm,a.update)}function yI(a){var d=a.cm,p=d.display;a.updatedDisplay&&hd(d),a.barMeasure=al(d),p.maxLineChanged&&!d.options.lineWrapping&&(a.adjustWidthTo=vS(d,p.maxLine,p.maxLine.text.length).left+3,d.display.sizerWidth=a.adjustWidthTo,a.barMeasure.scrollWidth=Math.max(p.scroller.clientWidth,p.sizer.offsetLeft+a.adjustWidthTo+Vi(d)+d.display.barWidth),a.maxScrollLeft=Math.max(0,p.sizer.offsetLeft+a.adjustWidthTo-Tr(d))),(a.updatedDisplay||a.selectionChanged)&&(a.preparedSelection=p.input.prepareSelection())}function SI(a){var d=a.cm;a.adjustWidthTo!=null&&(d.display.sizer.style.minWidth=a.adjustWidthTo+"px",a.maxScrollLeft<d.doc.scrollLeft&&Ir(d,Math.min(d.display.scroller.scrollLeft,a.maxScrollLeft),!0),d.display.maxLineChanged=!1);var p=a.focus&&a.focus==me(nt(d));a.preparedSelection&&d.display.input.showSelection(a.preparedSelection,p),(a.updatedDisplay||a.startHeight!=d.doc.height)&&Ro(d,a.barMeasure),a.updatedDisplay&&Ff(d,a.barMeasure),a.selectionChanged&&Af(d),d.state.focused&&a.updateInput&&d.display.input.reset(a.typing),p&&AS(a.cm)}function bI(a){var d=a.cm,p=d.display,f=d.doc;if(a.updatedDisplay&&BS(d,a.update),p.wheelStartX!=null&&(a.scrollTop!=null||a.scrollLeft!=null||a.scrollToPos)&&(p.wheelStartX=p.wheelStartY=null),a.scrollTop!=null&&MS(d,a.scrollTop,a.forceScroll),a.scrollLeft!=null&&Ir(d,a.scrollLeft,!0,!0),a.scrollToPos){var m=uI(d,Re(f,a.scrollToPos.from),Re(f,a.scrollToPos.to),a.scrollToPos.margin);dI(d,m)}var S=a.maybeHiddenMarkers,x=a.maybeUnhiddenMarkers;if(S)for(var T=0;T<S.length;++T)S[T].lines.length||mt(S[T],"hide");if(x)for(var L=0;L<x.length;++L)x[L].lines.length&&mt(x[L],"unhide");p.wrapper.offsetHeight&&(f.scrollTop=d.display.scroller.scrollTop),a.changeObjs&&mt(d,"changes",d,a.changeObjs),a.update&&a.update.finish()}function kn(a,d){if(a.curOp)return d();Ar(a);try{return d()}finally{Rr(a)}}function Vt(a,d){return function(){if(a.curOp)return d.apply(a,arguments);Ar(a);try{return d.apply(a,arguments)}finally{Rr(a)}}}function rn(a){return function(){if(this.curOp)return a.apply(this,arguments);Ar(this);try{return a.apply(this,arguments)}finally{Rr(this)}}}function Bt(a){return function(){var d=this.cm;if(!d||d.curOp)return a.apply(this,arguments);Ar(d);try{return a.apply(this,arguments)}finally{Rr(d)}}}function cl(a,d){a.doc.highlightFrontier<a.display.viewTo&&a.state.highlight.set(d,Se(wI,a))}function wI(a){var d=a.doc;if(!(d.highlightFrontier>=a.display.viewTo)){var p=+new Date+a.options.workTime,f=Qa(a,d.highlightFrontier),m=[];d.iter(f.line,Math.min(d.first+d.size,a.display.viewTo+500),function(S){if(f.line>=a.display.viewFrom){var x=S.styles,T=S.text.length>a.options.maxHighlightLength?Oi(d.mode,f.state):null,L=Hy(a,S,f,!0);T&&(f.state=T),S.styles=L.styles;var R=S.styleClasses,F=L.classes;F?S.styleClasses=F:R&&(S.styleClasses=null);for(var $=!x||x.length!=S.styles.length||R!=F&&(!R||!F||R.bgClass!=F.bgClass||R.textClass!=F.textClass),q=0;!$&&q<x.length;++q)$=x[q]!=S.styles[q];$&&m.push(f.line),S.stateAfter=f.save(),f.nextLine()}else S.text.length<=a.options.maxHighlightLength&&hf(a,S.text,f),S.stateAfter=f.line%5==0?f.save():null,f.nextLine();if(+new Date>p)return cl(a,a.options.workDelay),!0}),d.highlightFrontier=f.line,d.modeFrontier=Math.max(d.modeFrontier,f.line),m.length&&kn(a,function(){for(var S=0;S<m.length;S++)Ws(a,m[S],"text")})}}var gd=function(a,d,p){var f=a.display;this.viewport=d,this.visible=fd(f,a.doc,d),this.editorIsHidden=!f.wrapper.offsetWidth,this.wrapperHeight=f.wrapper.clientHeight,this.wrapperWidth=f.wrapper.clientWidth,this.oldDisplayWidth=Tr(a),this.force=p,this.dims=Lf(a),this.events=[]};gd.prototype.signal=function(a,d){Tn(a,d)&&this.events.push(arguments)},gd.prototype.finish=function(){for(var a=0;a<this.events.length;a++)mt.apply(null,this.events[a])};function CI(a){var d=a.display;!d.scrollbarsClipped&&d.scroller.offsetWidth&&(d.nativeBarWidth=d.scroller.offsetWidth-d.scroller.clientWidth,d.heightForcer.style.height=Vi(a)+"px",d.sizer.style.marginBottom=-d.nativeBarWidth+"px",d.sizer.style.borderRightWidth=Vi(a)+"px",d.scrollbarsClipped=!0)}function xI(a){if(a.hasFocus())return null;var d=me(nt(a));if(!d||!ve(a.display.lineDiv,d))return null;var p={activeElt:d};if(window.getSelection){var f=Te(a).getSelection();f.anchorNode&&f.extend&&ve(a.display.lineDiv,f.anchorNode)&&(p.anchorNode=f.anchorNode,p.anchorOffset=f.anchorOffset,p.focusNode=f.focusNode,p.focusOffset=f.focusOffset)}return p}function EI(a){if(!(!a||!a.activeElt||a.activeElt==me(Ge(a.activeElt)))&&(a.activeElt.focus(),!/^(INPUT|TEXTAREA)$/.test(a.activeElt.nodeName)&&a.anchorNode&&ve(document.body,a.anchorNode)&&ve(document.body,a.focusNode))){var d=a.activeElt.ownerDocument,p=d.defaultView.getSelection(),f=d.createRange();f.setEnd(a.anchorNode,a.anchorOffset),f.collapse(!1),p.removeAllRanges(),p.addRange(f),p.extend(a.focusNode,a.focusOffset)}}function _f(a,d){var p=a.display,f=a.doc;if(d.editorIsHidden)return Hs(a),!1;if(!d.force&&d.visible.from>=p.viewFrom&&d.visible.to<=p.viewTo&&(p.updateLineNumbers==null||p.updateLineNumbers>=p.viewTo)&&p.renderedView==p.view&&IS(a)==0)return!1;US(a)&&(Hs(a),d.dims=Lf(a));var m=f.first+f.size,S=Math.max(d.visible.from-a.options.viewportMargin,f.first),x=Math.min(m,d.visible.to+a.options.viewportMargin);p.viewFrom<S&&S-p.viewFrom<20&&(S=Math.max(f.first,p.viewFrom)),p.viewTo>x&&p.viewTo-x<20&&(x=Math.min(m,p.viewTo)),es&&(S=mf(a.doc,S),x=rS(a.doc,x));var T=S!=p.viewFrom||x!=p.viewTo||p.lastWrapHeight!=d.wrapperHeight||p.lastWrapWidth!=d.wrapperWidth;lI(a,S,x),p.viewOffset=ts(be(a.doc,p.viewFrom)),a.display.mover.style.top=p.viewOffset+"px";var L=IS(a);if(!T&&L==0&&!d.force&&p.renderedView==p.view&&(p.updateLineNumbers==null||p.updateLineNumbers>=p.viewTo))return!1;var R=xI(a);return L>4&&(p.lineDiv.style.display="none"),TI(a,p.updateLineNumbers,d.dims),L>4&&(p.lineDiv.style.display=""),p.renderedView=p.view,EI(R),B(p.cursorDiv),B(p.selectionDiv),p.gutters.style.height=p.sizer.style.minHeight=0,T&&(p.lastWrapHeight=d.wrapperHeight,p.lastWrapWidth=d.wrapperWidth,cl(a,400)),p.updateLineNumbers=null,!0}function BS(a,d){for(var p=d.viewport,f=!0;;f=!1){if(!f||!a.options.lineWrapping||d.oldDisplayWidth==Tr(a)){if(p&&p.top!=null&&(p={top:Math.min(a.doc.height+bf(a.display)-wf(a),p.top)}),d.visible=fd(a.display,a.doc,p),d.visible.from>=a.display.viewFrom&&d.visible.to<=a.display.viewTo)break}else f&&(d.visible=fd(a.display,a.doc,p));if(!_f(a,d))break;hd(a);var m=al(a);sl(a),Ro(a,m),Ff(a,m),d.force=!1}d.signal(a,"update",a),(a.display.viewFrom!=a.display.reportedViewFrom||a.display.viewTo!=a.display.reportedViewTo)&&(d.signal(a,"viewportChange",a,a.display.viewFrom,a.display.viewTo),a.display.reportedViewFrom=a.display.viewFrom,a.display.reportedViewTo=a.display.viewTo)}function Vf(a,d){var p=new gd(a,d);if(_f(a,p)){hd(a),BS(a,p);var f=al(a);sl(a),Ro(a,f),Ff(a,f),p.finish()}}function TI(a,d,p){var f=a.display,m=a.options.lineNumbers,S=f.lineDiv,x=S.firstChild;function T(Z){var ne=Z.nextSibling;return h&&N&&a.display.currentWheelTarget==Z?Z.style.display="none":Z.parentNode.removeChild(Z),ne}for(var L=f.view,R=f.viewFrom,F=0;F<L.length;F++){var $=L[F];if(!$.hidden)if(!$.node||$.node.parentNode!=S){var q=QD(a,$,R,p);S.insertBefore(q,x)}else{for(;x!=$.node;)x=T(x);var Y=m&&d!=null&&d<=R&&$.lineNumber;$.changes&&(Ae($.changes,"gutter")>-1&&(Y=!1),dS(a,$,R,p)),Y&&(B($.lineNumber),$.lineNumber.appendChild(document.createTextNode(ae(a.options,R)))),x=$.node.nextSibling}R+=$.size}for(;x;)x=T(x)}function Bf(a){var d=a.gutters.offsetWidth;a.sizer.style.marginLeft=d+"px",_t(a,"gutterChanged",a)}function Ff(a,d){a.display.sizer.style.minHeight=d.docHeight+"px",a.display.heightForcer.style.top=d.docHeight+"px",a.display.gutters.style.height=d.docHeight+a.display.barHeight+Vi(a)+"px"}function FS(a){var d=a.display,p=d.view;if(!(!d.alignWidgets&&(!d.gutters.firstChild||!a.options.fixedGutter))){for(var f=Df(d)-d.scroller.scrollLeft+a.doc.scrollLeft,m=d.gutters.offsetWidth,S=f+"px",x=0;x<p.length;x++)if(!p[x].hidden){a.options.fixedGutter&&(p[x].gutter&&(p[x].gutter.style.left=S),p[x].gutterBackground&&(p[x].gutterBackground.style.left=S));var T=p[x].alignable;if(T)for(var L=0;L<T.length;L++)T[L].style.left=S}a.options.fixedGutter&&(d.gutters.style.left=f+m+"px")}}function US(a){if(!a.options.lineNumbers)return!1;var d=a.doc,p=ae(a.options,d.first+d.size-1),f=a.display;if(p.length!=f.lineNumChars){var m=f.measure.appendChild(V("div",[V("div",p)],"CodeMirror-linenumber CodeMirror-gutter-elt")),S=m.firstChild.offsetWidth,x=m.offsetWidth-S;return f.lineGutter.style.width="",f.lineNumInnerWidth=Math.max(S,f.lineGutter.offsetWidth-x)+1,f.lineNumWidth=f.lineNumInnerWidth+x,f.lineNumChars=f.lineNumInnerWidth?p.length:-1,f.lineGutter.style.width=f.lineNumWidth+"px",Bf(a.display),!0}return!1}function Uf(a,d){for(var p=[],f=!1,m=0;m<a.length;m++){var S=a[m],x=null;if(typeof S!="string"&&(x=S.style,S=S.className),S=="CodeMirror-linenumbers")if(d)f=!0;else continue;p.push({className:S,style:x})}return d&&!f&&p.push({className:"CodeMirror-linenumbers",style:null}),p}function zS(a){var d=a.gutters,p=a.gutterSpecs;B(d),a.lineGutter=null;for(var f=0;f<p.length;++f){var m=p[f],S=m.className,x=m.style,T=d.appendChild(V("div",null,"CodeMirror-gutter "+S));x&&(T.style.cssText=x),S=="CodeMirror-linenumbers"&&(a.lineGutter=T,T.style.width=(a.lineNumWidth||1)+"px")}d.style.display=p.length?"":"none",Bf(a)}function dl(a){zS(a.display),mn(a),FS(a)}function kI(a,d,p,f){var m=this;this.input=p,m.scrollbarFiller=V("div",null,"CodeMirror-scrollbar-filler"),m.scrollbarFiller.setAttribute("cm-not-content","true"),m.gutterFiller=V("div",null,"CodeMirror-gutter-filler"),m.gutterFiller.setAttribute("cm-not-content","true"),m.lineDiv=re("div",null,"CodeMirror-code"),m.selectionDiv=V("div",null,null,"position: relative; z-index: 1"),m.cursorDiv=V("div",null,"CodeMirror-cursors"),m.measure=V("div",null,"CodeMirror-measure"),m.lineMeasure=V("div",null,"CodeMirror-measure"),m.lineSpace=re("div",[m.measure,m.lineMeasure,m.selectionDiv,m.cursorDiv,m.lineDiv],null,"position: relative; outline: none");var S=re("div",[m.lineSpace],"CodeMirror-lines");m.mover=V("div",[S],null,"position: relative"),m.sizer=V("div",[m.mover],"CodeMirror-sizer"),m.sizerWidth=null,m.heightForcer=V("div",null,null,"position: absolute; height: "+Nt+"px; width: 1px;"),m.gutters=V("div",null,"CodeMirror-gutters"),m.lineGutter=null,m.scroller=V("div",[m.sizer,m.heightForcer,m.gutters],"CodeMirror-scroll"),m.scroller.setAttribute("tabIndex","-1"),m.wrapper=V("div",[m.scrollbarFiller,m.gutterFiller,m.scroller],"CodeMirror"),v&&y>=105&&(m.wrapper.style.clipPath="inset(0px)"),m.wrapper.setAttribute("translate","no"),c&&u<8&&(m.gutters.style.zIndex=-1,m.scroller.style.paddingRight=0),!h&&!(s&&A)&&(m.scroller.draggable=!0),a&&(a.appendChild?a.appendChild(m.wrapper):a(m.wrapper)),m.viewFrom=m.viewTo=d.first,m.reportedViewFrom=m.reportedViewTo=d.first,m.view=[],m.renderedView=null,m.externalMeasured=null,m.viewOffset=0,m.lastWrapHeight=m.lastWrapWidth=0,m.updateLineNumbers=null,m.nativeBarWidth=m.barHeight=m.barWidth=0,m.scrollbarsClipped=!1,m.lineNumWidth=m.lineNumInnerWidth=m.lineNumChars=null,m.alignWidgets=!1,m.cachedCharWidth=m.cachedTextHeight=m.cachedPaddingH=null,m.maxLine=null,m.maxLineLength=0,m.maxLineChanged=!1,m.wheelDX=m.wheelDY=m.wheelStartX=m.wheelStartY=null,m.shift=!1,m.selForContextMenu=null,m.activeTouch=null,m.gutterSpecs=Uf(f.gutters,f.lineNumbers),zS(m),p.init(m)}var md=0,is=null;c?is=-.53:s?is=15:v?is=-.7:w&&(is=-1/3);function GS(a){var d=a.wheelDeltaX,p=a.wheelDeltaY;return d==null&&a.detail&&a.axis==a.HORIZONTAL_AXIS&&(d=a.detail),p==null&&a.detail&&a.axis==a.VERTICAL_AXIS?p=a.detail:p==null&&(p=a.wheelDelta),{x:d,y:p}}function LI(a){var d=GS(a);return d.x*=is,d.y*=is,d}function $S(a,d){v&&y==102&&(a.display.chromeScrollHack==null?a.display.sizer.style.pointerEvents="none":clearTimeout(a.display.chromeScrollHack),a.display.chromeScrollHack=setTimeout(function(){a.display.chromeScrollHack=null,a.display.sizer.style.pointerEvents=""},100));var p=GS(d),f=p.x,m=p.y,S=is;d.deltaMode===0&&(f=d.deltaX,m=d.deltaY,S=1);var x=a.display,T=x.scroller,L=T.scrollWidth>T.clientWidth,R=T.scrollHeight>T.clientHeight;if(f&&L||m&&R){if(m&&N&&h){e:for(var F=d.target,$=x.view;F!=T;F=F.parentNode)for(var q=0;q<$.length;q++)if($[q].node==F){a.display.currentWheelTarget=F;break e}}if(f&&!s&&!b&&S!=null){m&&R&&ol(a,Math.max(0,T.scrollTop+m*S)),Ir(a,Math.max(0,T.scrollLeft+f*S)),(!m||m&&R)&&qt(d),x.wheelStartX=null;return}if(m&&S!=null){var Y=m*S,Z=a.doc.scrollTop,ne=Z+x.wrapper.clientHeight;Y<0?Z=Math.max(0,Z+Y-50):ne=Math.min(a.doc.height,ne+Y+50),Vf(a,{top:Z,bottom:ne})}md<20&&d.deltaMode!==0&&(x.wheelStartX==null?(x.wheelStartX=T.scrollLeft,x.wheelStartY=T.scrollTop,x.wheelDX=f,x.wheelDY=m,setTimeout(function(){if(x.wheelStartX!=null){var le=T.scrollLeft-x.wheelStartX,ce=T.scrollTop-x.wheelStartY,pe=ce&&x.wheelDY&&ce/x.wheelDY||le&&x.wheelDX&&le/x.wheelDX;x.wheelStartX=x.wheelStartY=null,pe&&(is=(is*md+pe)/(md+1),++md)}},200)):(x.wheelDX+=f,x.wheelDY+=m))}}var Nn=function(a,d){this.ranges=a,this.primIndex=d};Nn.prototype.primary=function(){return this.ranges[this.primIndex]},Nn.prototype.equals=function(a){if(a==this)return!0;if(a.primIndex!=this.primIndex||a.ranges.length!=this.ranges.length)return!1;for(var d=0;d<this.ranges.length;d++){var p=this.ranges[d],f=a.ranges[d];if(!Ye(p.anchor,f.anchor)||!Ye(p.head,f.head))return!1}return!0},Nn.prototype.deepCopy=function(){for(var a=[],d=0;d<this.ranges.length;d++)a[d]=new qe(Ot(this.ranges[d].anchor),Ot(this.ranges[d].head));return new Nn(a,this.primIndex)},Nn.prototype.somethingSelected=function(){for(var a=0;a<this.ranges.length;a++)if(!this.ranges[a].empty())return!0;return!1},Nn.prototype.contains=function(a,d){d||(d=a);for(var p=0;p<this.ranges.length;p++){var f=this.ranges[p];if(he(d,f.from())>=0&&he(a,f.to())<=0)return p}return-1};var qe=function(a,d){this.anchor=a,this.head=d};qe.prototype.from=function(){return Eo(this.anchor,this.head)},qe.prototype.to=function(){return gn(this.anchor,this.head)},qe.prototype.empty=function(){return this.head.line==this.anchor.line&&this.head.ch==this.anchor.ch};function bi(a,d,p){var f=a&&a.options.selectionsMayTouch,m=d[p];d.sort(function(q,Y){return he(q.from(),Y.from())}),p=Ae(d,m);for(var S=1;S<d.length;S++){var x=d[S],T=d[S-1],L=he(T.to(),x.from());if(f&&!x.empty()?L>0:L>=0){var R=Eo(T.from(),x.from()),F=gn(T.to(),x.to()),$=T.empty()?x.from()==x.head:T.from()==T.head;S<=p&&--p,d.splice(--S,2,new qe($?F:R,$?R:F))}}return new Nn(d,p)}function Js(a,d){return new Nn([new qe(a,d||a)],0)}function js(a){return a.text?Q(a.from.line+a.text.length-1,Oe(a.text).length+(a.text.length==1?a.from.ch:0)):a.to}function WS(a,d){if(he(a,d.from)<0)return a;if(he(a,d.to)<=0)return js(d);var p=a.line+d.text.length-(d.to.line-d.from.line)-1,f=a.ch;return a.line==d.to.line&&(f+=js(d).ch-d.to.ch),Q(p,f)}function zf(a,d){for(var p=[],f=0;f<a.sel.ranges.length;f++){var m=a.sel.ranges[f];p.push(new qe(WS(m.anchor,d),WS(m.head,d)))}return bi(a.cm,p,a.sel.primIndex)}function HS(a,d,p){return a.line==d.line?Q(p.line,a.ch-d.ch+p.ch):Q(p.line+(a.line-d.line),a.ch)}function DI(a,d,p){for(var f=[],m=Q(a.first,0),S=m,x=0;x<d.length;x++){var T=d[x],L=HS(T.from,m,S),R=HS(js(T),m,S);if(m=T.to,S=R,p=="around"){var F=a.sel.ranges[x],$=he(F.head,F.anchor)<0;f[x]=new qe($?R:L,$?L:R)}else f[x]=new qe(L,L)}return new Nn(f,a.sel.primIndex)}function Gf(a){a.doc.mode=wo(a.options,a.doc.modeOption),ul(a)}function ul(a){a.doc.iter(function(d){d.stateAfter&&(d.stateAfter=null),d.styles&&(d.styles=null)}),a.doc.modeFrontier=a.doc.highlightFrontier=a.doc.first,cl(a,100),a.state.modeGen++,a.curOp&&mn(a)}function JS(a,d){return d.from.ch==0&&d.to.ch==0&&Oe(d.text)==""&&(!a.cm||a.cm.options.wholeLineUpdateBefore)}function $f(a,d,p,f){function m(pe){return p?p[pe]:null}function S(pe,de,ye){_D(pe,de,ye,f),_t(pe,"change",pe,d)}function x(pe,de){for(var ye=[],Le=pe;Le<de;++Le)ye.push(new To(R[Le],m(Le),f));return ye}var T=d.from,L=d.to,R=d.text,F=be(a,T.line),$=be(a,L.line),q=Oe(R),Y=m(R.length-1),Z=L.line-T.line;if(d.full)a.insert(0,x(0,R.length)),a.remove(R.length,a.size-R.length);else if(JS(a,d)){var ne=x(0,R.length-1);S($,$.text,Y),Z&&a.remove(T.line,Z),ne.length&&a.insert(T.line,ne)}else if(F==$)if(R.length==1)S(F,F.text.slice(0,T.ch)+q+F.text.slice(L.ch),Y);else{var le=x(1,R.length-1);le.push(new To(q+F.text.slice(L.ch),Y,f)),S(F,F.text.slice(0,T.ch)+R[0],m(0)),a.insert(T.line+1,le)}else if(R.length==1)S(F,F.text.slice(0,T.ch)+R[0]+$.text.slice(L.ch),m(0)),a.remove(T.line+1,Z);else{S(F,F.text.slice(0,T.ch)+R[0],m(0)),S($,q+$.text.slice(L.ch),Y);var ce=x(1,R.length-1);Z>1&&a.remove(T.line+1,Z-1),a.insert(T.line+1,ce)}_t(a,"change",a,d)}function Ys(a,d,p){function f(m,S,x){if(m.linked)for(var T=0;T<m.linked.length;++T){var L=m.linked[T];if(L.doc!=S){var R=x&&L.sharedHist;p&&!R||(d(L.doc,R),f(L.doc,m,R))}}}f(a,null,!0)}function jS(a,d){if(d.cm)throw new Error("This document is already in use.");a.doc=d,d.cm=a,If(a),Gf(a),YS(a),a.options.direction=d.direction,a.options.lineWrapping||yf(a),a.options.mode=d.modeOption,mn(a)}function YS(a){(a.doc.direction=="rtl"?Ie:j)(a.display.lineDiv,"CodeMirror-rtl")}function II(a){kn(a,function(){YS(a),mn(a)})}function vd(a){this.done=[],this.undone=[],this.undoDepth=a?a.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=a?a.maxGeneration:1}function Wf(a,d){var p={from:Ot(d.from),to:js(d),text:Zi(a,d.from,d.to)};return XS(a,p,d.from.line,d.to.line+1),Ys(a,function(f){return XS(f,p,d.from.line,d.to.line+1)},!0),p}function qS(a){for(;a.length;){var d=Oe(a);if(d.ranges)a.pop();else break}}function PI(a,d){if(d)return qS(a.done),Oe(a.done);if(a.done.length&&!Oe(a.done).ranges)return Oe(a.done);if(a.done.length>1&&!a.done[a.done.length-2].ranges)return a.done.pop(),Oe(a.done)}function KS(a,d,p,f){var m=a.history;m.undone.length=0;var S=+new Date,x,T;if((m.lastOp==f||m.lastOrigin==d.origin&&d.origin&&(d.origin.charAt(0)=="+"&&m.lastModTime>S-(a.cm?a.cm.options.historyEventDelay:500)||d.origin.charAt(0)=="*"))&&(x=PI(m,m.lastOp==f)))T=Oe(x.changes),he(d.from,d.to)==0&&he(d.from,T.to)==0?T.to=js(d):x.changes.push(Wf(a,d));else{var L=Oe(m.done);for((!L||!L.ranges)&&yd(a.sel,m.done),x={changes:[Wf(a,d)],generation:m.generation},m.done.push(x);m.done.length>m.undoDepth;)m.done.shift(),m.done[0].ranges||m.done.shift()}m.done.push(p),m.generation=++m.maxGeneration,m.lastModTime=m.lastSelTime=S,m.lastOp=m.lastSelOp=f,m.lastOrigin=m.lastSelOrigin=d.origin,T||mt(a,"historyAdded")}function AI(a,d,p,f){var m=d.charAt(0);return m=="*"||m=="+"&&p.ranges.length==f.ranges.length&&p.somethingSelected()==f.somethingSelected()&&new Date-a.history.lastSelTime<=(a.cm?a.cm.options.historyEventDelay:500)}function RI(a,d,p,f){var m=a.history,S=f&&f.origin;p==m.lastSelOp||S&&m.lastSelOrigin==S&&(m.lastModTime==m.lastSelTime&&m.lastOrigin==S||AI(a,S,Oe(m.done),d))?m.done[m.done.length-1]=d:yd(d,m.done),m.lastSelTime=+new Date,m.lastSelOrigin=S,m.lastSelOp=p,f&&f.clearRedo!==!1&&qS(m.undone)}function yd(a,d){var p=Oe(d);p&&p.ranges&&p.equals(a)||d.push(a)}function XS(a,d,p,f){var m=d["spans_"+a.id],S=0;a.iter(Math.max(a.first,p),Math.min(a.first+a.size,f),function(x){x.markedSpans&&((m||(m=d["spans_"+a.id]={}))[S]=x.markedSpans),++S})}function NI(a){if(!a)return null;for(var d,p=0;p<a.length;++p)a[p].marker.explicitlyCleared?d||(d=a.slice(0,p)):d&&d.push(a[p]);return d?d.length?d:null:a}function MI(a,d){var p=d["spans_"+a.id];if(!p)return null;for(var f=[],m=0;m<d.text.length;++m)f.push(NI(p[m]));return f}function QS(a,d){var p=MI(a,d),f=pf(a,d);if(!p)return f;if(!f)return p;for(var m=0;m<p.length;++m){var S=p[m],x=f[m];if(S&&x)e:for(var T=0;T<x.length;++T){for(var L=x[T],R=0;R<S.length;++R)if(S[R].marker==L.marker)continue e;S.push(L)}else x&&(p[m]=x)}return p}function No(a,d,p){for(var f=[],m=0;m<a.length;++m){var S=a[m];if(S.ranges){f.push(p?Nn.prototype.deepCopy.call(S):S);continue}var x=S.changes,T=[];f.push({changes:T});for(var L=0;L<x.length;++L){var R=x[L],F=void 0;if(T.push({from:R.from,to:R.to,text:R.text}),d)for(var $ in R)(F=$.match(/^spans_(\d+)$/))&&Ae(d,Number(F[1]))>-1&&(Oe(T)[$]=R[$],delete R[$])}}return f}function Hf(a,d,p,f){if(f){var m=a.anchor;if(p){var S=he(d,m)<0;S!=he(p,m)<0?(m=d,d=p):S!=he(d,p)<0&&(d=p)}return new qe(m,d)}else return new qe(p||d,d)}function Sd(a,d,p,f,m){m==null&&(m=a.cm&&(a.cm.display.shift||a.extend)),Kt(a,new Nn([Hf(a.sel.primary(),d,p,m)],0),f)}function ZS(a,d,p){for(var f=[],m=a.cm&&(a.cm.display.shift||a.extend),S=0;S<a.sel.ranges.length;S++)f[S]=Hf(a.sel.ranges[S],d[S],null,m);var x=bi(a.cm,f,a.sel.primIndex);Kt(a,x,p)}function Jf(a,d,p,f){var m=a.sel.ranges.slice(0);m[d]=p,Kt(a,bi(a.cm,m,a.sel.primIndex),f)}function e0(a,d,p,f){Kt(a,Js(d,p),f)}function OI(a,d,p){var f={ranges:d.ranges,update:function(m){this.ranges=[];for(var S=0;S<m.length;S++)this.ranges[S]=new qe(Re(a,m[S].anchor),Re(a,m[S].head))},origin:p&&p.origin};return mt(a,"beforeSelectionChange",a,f),a.cm&&mt(a.cm,"beforeSelectionChange",a.cm,f),f.ranges!=d.ranges?bi(a.cm,f.ranges,f.ranges.length-1):d}function t0(a,d,p){var f=a.history.done,m=Oe(f);m&&m.ranges?(f[f.length-1]=d,bd(a,d,p)):Kt(a,d,p)}function Kt(a,d,p){bd(a,d,p),RI(a,a.sel,a.cm?a.cm.curOp.id:NaN,p)}function bd(a,d,p){(Tn(a,"beforeSelectionChange")||a.cm&&Tn(a.cm,"beforeSelectionChange"))&&(d=OI(a,d,p));var f=p&&p.bias||(he(d.primary().head,a.sel.primary().head)<0?-1:1);n0(a,s0(a,d,f,!0)),!(p&&p.scroll===!1)&&a.cm&&a.cm.getOption("readOnly")!="nocursor"&&Ao(a.cm)}function n0(a,d){d.equals(a.sel)||(a.sel=d,a.cm&&(a.cm.curOp.updateInput=1,a.cm.curOp.selectionChanged=!0,zn(a.cm)),_t(a,"cursorActivity",a))}function i0(a){n0(a,s0(a,a.sel,null,!1))}function s0(a,d,p,f){for(var m,S=0;S<d.ranges.length;S++){var x=d.ranges[S],T=d.ranges.length==a.sel.ranges.length&&a.sel.ranges[S],L=wd(a,x.anchor,T&&T.anchor,p,f),R=x.head==x.anchor?L:wd(a,x.head,T&&T.head,p,f);(m||L!=x.anchor||R!=x.head)&&(m||(m=d.ranges.slice(0,S)),m[S]=new qe(L,R))}return m?bi(a.cm,m,d.primIndex):d}function Mo(a,d,p,f,m){var S=be(a,d.line);if(S.markedSpans)for(var x=0;x<S.markedSpans.length;++x){var T=S.markedSpans[x],L=T.marker,R="selectLeft"in L?!L.selectLeft:L.inclusiveLeft,F="selectRight"in L?!L.selectRight:L.inclusiveRight;if((T.from==null||(R?T.from<=d.ch:T.from<d.ch))&&(T.to==null||(F?T.to>=d.ch:T.to>d.ch))){if(m&&(mt(L,"beforeCursorEnter"),L.explicitlyCleared))if(S.markedSpans){--x;continue}else break;if(!L.atomic)continue;if(p){var $=L.find(f<0?1:-1),q=void 0;if((f<0?F:R)&&($=r0(a,$,-f,$&&$.line==d.line?S:null)),$&&$.line==d.line&&(q=he($,p))&&(f<0?q<0:q>0))return Mo(a,$,d,f,m)}var Y=L.find(f<0?-1:1);return(f<0?R:F)&&(Y=r0(a,Y,f,Y.line==d.line?S:null)),Y?Mo(a,Y,d,f,m):null}}return d}function wd(a,d,p,f,m){var S=f||1,x=Mo(a,d,p,S,m)||!m&&Mo(a,d,p,S,!0)||Mo(a,d,p,-S,m)||!m&&Mo(a,d,p,-S,!0);return x||(a.cantEdit=!0,Q(a.first,0))}function r0(a,d,p,f){return p<0&&d.ch==0?d.line>a.first?Re(a,Q(d.line-1)):null:p>0&&d.ch==(f||be(a,d.line)).text.length?d.line<a.first+a.size-1?Q(d.line+1,0):null:new Q(d.line,d.ch+p)}function o0(a){a.setSelection(Q(a.firstLine(),0),Q(a.lastLine()),hn)}function a0(a,d,p){var f={canceled:!1,from:d.from,to:d.to,text:d.text,origin:d.origin,cancel:function(){return f.canceled=!0}};return p&&(f.update=function(m,S,x,T){m&&(f.from=Re(a,m)),S&&(f.to=Re(a,S)),x&&(f.text=x),T!==void 0&&(f.origin=T)}),mt(a,"beforeChange",a,f),a.cm&&mt(a.cm,"beforeChange",a.cm,f),f.canceled?(a.cm&&(a.cm.curOp.updateInput=2),null):{from:f.from,to:f.to,text:f.text,origin:f.origin}}function Oo(a,d,p){if(a.cm){if(!a.cm.curOp)return Vt(a.cm,Oo)(a,d,p);if(a.cm.state.suppressEdits)return}if(!((Tn(a,"beforeChange")||a.cm&&Tn(a.cm,"beforeChange"))&&(d=a0(a,d,!0),!d))){var f=Qy&&!p&&RD(a,d.from,d.to);if(f)for(var m=f.length-1;m>=0;--m)l0(a,{from:f[m].from,to:f[m].to,text:m?[""]:d.text,origin:d.origin});else l0(a,d)}}function l0(a,d){if(!(d.text.length==1&&d.text[0]==""&&he(d.from,d.to)==0)){var p=zf(a,d);KS(a,d,p,a.cm?a.cm.curOp.id:NaN),hl(a,d,p,pf(a,d));var f=[];Ys(a,function(m,S){!S&&Ae(f,m.history)==-1&&(h0(m.history,d),f.push(m.history)),hl(m,d,null,pf(m,d))})}}function Cd(a,d,p){var f=a.cm&&a.cm.state.suppressEdits;if(!(f&&!p)){for(var m=a.history,S,x=a.sel,T=d=="undo"?m.done:m.undone,L=d=="undo"?m.undone:m.done,R=0;R<T.length&&(S=T[R],!(p?S.ranges&&!S.equals(a.sel):!S.ranges));R++);if(R!=T.length){for(m.lastOrigin=m.lastSelOrigin=null;;)if(S=T.pop(),S.ranges){if(yd(S,L),p&&!S.equals(a.sel)){Kt(a,S,{clearRedo:!1});return}x=S}else if(f){T.push(S);return}else break;var F=[];yd(x,L),L.push({changes:F,generation:m.generation}),m.generation=S.generation||++m.maxGeneration;for(var $=Tn(a,"beforeChange")||a.cm&&Tn(a.cm,"beforeChange"),q=function(ne){var le=S.changes[ne];if(le.origin=d,$&&!a0(a,le,!1))return T.length=0,{};F.push(Wf(a,le));var ce=ne?zf(a,le):Oe(T);hl(a,le,ce,QS(a,le)),!ne&&a.cm&&a.cm.scrollIntoView({from:le.from,to:js(le)});var pe=[];Ys(a,function(de,ye){!ye&&Ae(pe,de.history)==-1&&(h0(de.history,le),pe.push(de.history)),hl(de,le,null,QS(de,le))})},Y=S.changes.length-1;Y>=0;--Y){var Z=q(Y);if(Z)return Z.v}}}}function c0(a,d){if(d!=0&&(a.first+=d,a.sel=new Nn(Un(a.sel.ranges,function(m){return new qe(Q(m.anchor.line+d,m.anchor.ch),Q(m.head.line+d,m.head.ch))}),a.sel.primIndex),a.cm)){mn(a.cm,a.first,a.first-d,d);for(var p=a.cm.display,f=p.viewFrom;f<p.viewTo;f++)Ws(a.cm,f,"gutter")}}function hl(a,d,p,f){if(a.cm&&!a.cm.curOp)return Vt(a.cm,hl)(a,d,p,f);if(d.to.line<a.first){c0(a,d.text.length-1-(d.to.line-d.from.line));return}if(!(d.from.line>a.lastLine())){if(d.from.line<a.first){var m=d.text.length-1-(a.first-d.from.line);c0(a,m),d={from:Q(a.first,0),to:Q(d.to.line+m,d.to.ch),text:[Oe(d.text)],origin:d.origin}}var S=a.lastLine();d.to.line>S&&(d={from:d.from,to:Q(S,be(a,S).text.length),text:[d.text[0]],origin:d.origin}),d.removed=Zi(a,d.from,d.to),p||(p=zf(a,d)),a.cm?_I(a.cm,d,f):$f(a,d,f),bd(a,p,hn),a.cantEdit&&wd(a,Q(a.firstLine(),0))&&(a.cantEdit=!1)}}function _I(a,d,p){var f=a.doc,m=a.display,S=d.from,x=d.to,T=!1,L=S.line;a.options.lineWrapping||(L=M(yi(be(f,S.line))),f.iter(L,x.line+1,function(Y){if(Y==m.maxLine)return T=!0,!0})),f.sel.contains(d.from,d.to)>-1&&zn(a),$f(f,d,p,DS(a)),a.options.lineWrapping||(f.iter(L,S.line+d.text.length,function(Y){var Z=rd(Y);Z>m.maxLineLength&&(m.maxLine=Y,m.maxLineLength=Z,m.maxLineChanged=!0,T=!1)}),T&&(a.curOp.updateMaxLine=!0)),TD(f,S.line),cl(a,400);var R=d.text.length-(x.line-S.line)-1;d.full?mn(a):S.line==x.line&&d.text.length==1&&!JS(a.doc,d)?Ws(a,S.line,"text"):mn(a,S.line,x.line+1,R);var F=Tn(a,"changes"),$=Tn(a,"change");if($||F){var q={from:S,to:x,text:d.text,removed:d.removed,origin:d.origin};$&&_t(a,"change",a,q),F&&(a.curOp.changeObjs||(a.curOp.changeObjs=[])).push(q)}a.display.selForContextMenu=null}function _o(a,d,p,f,m){var S;f||(f=p),he(f,p)<0&&(S=[f,p],p=S[0],f=S[1]),typeof d=="string"&&(d=a.splitLines(d)),Oo(a,{from:p,to:f,text:d,origin:m})}function d0(a,d,p,f){p<a.line?a.line+=f:d<a.line&&(a.line=d,a.ch=0)}function u0(a,d,p,f){for(var m=0;m<a.length;++m){var S=a[m],x=!0;if(S.ranges){S.copied||(S=a[m]=S.deepCopy(),S.copied=!0);for(var T=0;T<S.ranges.length;T++)d0(S.ranges[T].anchor,d,p,f),d0(S.ranges[T].head,d,p,f);continue}for(var L=0;L<S.changes.length;++L){var R=S.changes[L];if(p<R.from.line)R.from=Q(R.from.line+f,R.from.ch),R.to=Q(R.to.line+f,R.to.ch);else if(d<=R.to.line){x=!1;break}}x||(a.splice(0,m+1),m=0)}}function h0(a,d){var p=d.from.line,f=d.to.line,m=d.text.length-(f-p)-1;u0(a.done,p,f,m),u0(a.undone,p,f,m)}function fl(a,d,p,f){var m=d,S=d;return typeof d=="number"?S=be(a,$y(a,d)):m=M(d),m==null?null:(f(S,m)&&a.cm&&Ws(a.cm,m,p),S)}function pl(a){this.lines=a,this.parent=null;for(var d=0,p=0;p<a.length;++p)a[p].parent=this,d+=a[p].height;this.height=d}pl.prototype={chunkSize:function(){return this.lines.length},removeInner:function(a,d){for(var p=a,f=a+d;p<f;++p){var m=this.lines[p];this.height-=m.height,VD(m),_t(m,"delete")}this.lines.splice(a,d)},collapse:function(a){a.push.apply(a,this.lines)},insertInner:function(a,d,p){this.height+=p,this.lines=this.lines.slice(0,a).concat(d).concat(this.lines.slice(a));for(var f=0;f<d.length;++f)d[f].parent=this},iterN:function(a,d,p){for(var f=a+d;a<f;++a)if(p(this.lines[a]))return!0}};function gl(a){this.children=a;for(var d=0,p=0,f=0;f<a.length;++f){var m=a[f];d+=m.chunkSize(),p+=m.height,m.parent=this}this.size=d,this.height=p,this.parent=null}gl.prototype={chunkSize:function(){return this.size},removeInner:function(a,d){this.size-=d;for(var p=0;p<this.children.length;++p){var f=this.children[p],m=f.chunkSize();if(a<m){var S=Math.min(d,m-a),x=f.height;if(f.removeInner(a,S),this.height-=x-f.height,m==S&&(this.children.splice(p--,1),f.parent=null),(d-=S)==0)break;a=0}else a-=m}if(this.size-d<25&&(this.children.length>1||!(this.children[0]instanceof pl))){var T=[];this.collapse(T),this.children=[new pl(T)],this.children[0].parent=this}},collapse:function(a){for(var d=0;d<this.children.length;++d)this.children[d].collapse(a)},insertInner:function(a,d,p){this.size+=d.length,this.height+=p;for(var f=0;f<this.children.length;++f){var m=this.children[f],S=m.chunkSize();if(a<=S){if(m.insertInner(a,d,p),m.lines&&m.lines.length>50){for(var x=m.lines.length%25+25,T=x;T<m.lines.length;){var L=new pl(m.lines.slice(T,T+=25));m.height-=L.height,this.children.splice(++f,0,L),L.parent=this}m.lines=m.lines.slice(0,x),this.maybeSpill()}break}a-=S}},maybeSpill:function(){if(!(this.children.length<=10)){var a=this;do{var d=a.children.splice(a.children.length-5,5),p=new gl(d);if(a.parent){a.size-=p.size,a.height-=p.height;var m=Ae(a.parent.children,a);a.parent.children.splice(m+1,0,p)}else{var f=new gl(a.children);f.parent=a,a.children=[f,p],a=f}p.parent=a.parent}while(a.children.length>10);a.parent.maybeSpill()}},iterN:function(a,d,p){for(var f=0;f<this.children.length;++f){var m=this.children[f],S=m.chunkSize();if(a<S){var x=Math.min(d,S-a);if(m.iterN(a,x,p))return!0;if((d-=x)==0)break;a=0}else a-=S}}};var ml=function(a,d,p){if(p)for(var f in p)p.hasOwnProperty(f)&&(this[f]=p[f]);this.doc=a,this.node=d};ml.prototype.clear=function(){var a=this.doc.cm,d=this.line.widgets,p=this.line,f=M(p);if(!(f==null||!d)){for(var m=0;m<d.length;++m)d[m]==this&&d.splice(m--,1);d.length||(p.widgets=null);var S=nl(this);Rn(p,Math.max(0,p.height-S)),a&&(kn(a,function(){f0(a,p,-S),Ws(a,f,"widget")}),_t(a,"lineWidgetCleared",a,this,f))}},ml.prototype.changed=function(){var a=this,d=this.height,p=this.doc.cm,f=this.line;this.height=null;var m=nl(this)-d;m&&($s(this.doc,f)||Rn(f,f.height+m),p&&kn(p,function(){p.curOp.forceUpdate=!0,f0(p,f,m),_t(p,"lineWidgetChanged",p,a,M(f))}))},fi(ml);function f0(a,d,p){ts(d)<(a.curOp&&a.curOp.scrollTop||a.doc.scrollTop)&&Of(a,p)}function VI(a,d,p,f){var m=new ml(a,p,f),S=a.cm;return S&&m.noHScroll&&(S.display.alignWidgets=!0),fl(a,d,"widget",function(x){var T=x.widgets||(x.widgets=[]);if(m.insertAt==null?T.push(m):T.splice(Math.min(T.length,Math.max(0,m.insertAt)),0,m),m.line=x,S&&!$s(a,x)){var L=ts(x)<a.scrollTop;Rn(x,x.height+nl(m)),L&&Of(S,m.height),S.curOp.forceUpdate=!0}return!0}),S&&_t(S,"lineWidgetAdded",S,m,typeof d=="number"?d:M(d)),m}var p0=0,qs=function(a,d){this.lines=[],this.type=d,this.doc=a,this.id=++p0};qs.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,d=a&&!a.curOp;if(d&&Ar(a),Tn(this,"clear")){var p=this.find();p&&_t(this,"clear",p.from,p.to)}for(var f=null,m=null,S=0;S<this.lines.length;++S){var x=this.lines[S],T=Za(x.markedSpans,this);a&&!this.collapsed?Ws(a,M(x),"text"):a&&(T.to!=null&&(m=M(x)),T.from!=null&&(f=M(x))),x.markedSpans=DD(x.markedSpans,T),T.from==null&&this.collapsed&&!$s(this.doc,x)&&a&&Rn(x,Do(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(var L=0;L<this.lines.length;++L){var R=yi(this.lines[L]),F=rd(R);F>a.display.maxLineLength&&(a.display.maxLine=R,a.display.maxLineLength=F,a.display.maxLineChanged=!0)}f!=null&&a&&this.collapsed&&mn(a,f,m+1),this.lines.length=0,this.explicitlyCleared=!0,this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&i0(a.doc)),a&&_t(a,"markerCleared",a,this,f,m),d&&Rr(a),this.parent&&this.parent.clear()}},qs.prototype.find=function(a,d){a==null&&this.type=="bookmark"&&(a=1);for(var p,f,m=0;m<this.lines.length;++m){var S=this.lines[m],x=Za(S.markedSpans,this);if(x.from!=null&&(p=Q(d?S:M(S),x.from),a==-1))return p;if(x.to!=null&&(f=Q(d?S:M(S),x.to),a==1))return f}return p&&{from:p,to:f}},qs.prototype.changed=function(){var a=this,d=this.find(-1,!0),p=this,f=this.doc.cm;!d||!f||kn(f,function(){var m=d.line,S=M(d.line),x=Cf(f,S);if(x&&(bS(x),f.curOp.selectionChanged=f.curOp.forceUpdate=!0),f.curOp.updateMaxLine=!0,!$s(p.doc,m)&&p.height!=null){var T=p.height;p.height=null;var L=nl(p)-T;L&&Rn(m,m.height+L)}_t(f,"markerChanged",f,a)})},qs.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(!d.maybeHiddenMarkers||Ae(d.maybeHiddenMarkers,this)==-1)&&(d.maybeUnhiddenMarkers||(d.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)},qs.prototype.detachLine=function(a){if(this.lines.splice(Ae(this.lines,a),1),!this.lines.length&&this.doc.cm){var d=this.doc.cm.curOp;(d.maybeHiddenMarkers||(d.maybeHiddenMarkers=[])).push(this)}},fi(qs);function Vo(a,d,p,f,m){if(f&&f.shared)return BI(a,d,p,f,m);if(a.cm&&!a.cm.curOp)return Vt(a.cm,Vo)(a,d,p,f,m);var S=new qs(a,m),x=he(d,p);if(f&&ge(f,S,!1),x>0||x==0&&S.clearWhenEmpty!==!1)return S;if(S.replacedWith&&(S.collapsed=!0,S.widgetNode=re("span",[S.replacedWith],"CodeMirror-widget"),f.handleMouseEvents||S.widgetNode.setAttribute("cm-ignore-events","true"),f.insertLeft&&(S.widgetNode.insertLeft=!0)),S.collapsed){if(sS(a,d.line,d,p,S)||d.line!=p.line&&sS(a,p.line,d,p,S))throw new Error("Inserting collapsed marker partially overlapping an existing one");LD()}S.addToHistory&&KS(a,{from:d,to:p,origin:"markText"},a.sel,NaN);var T=d.line,L=a.cm,R;if(a.iter(T,p.line+1,function($){L&&S.collapsed&&!L.options.lineWrapping&&yi($)==L.display.maxLine&&(R=!0),S.collapsed&&T!=d.line&&Rn($,0),ID($,new td(S,T==d.line?d.ch:null,T==p.line?p.ch:null),a.cm&&a.cm.curOp),++T}),S.collapsed&&a.iter(d.line,p.line+1,function($){$s(a,$)&&Rn($,0)}),S.clearOnEnter&&ke(S,"beforeCursorEnter",function(){return S.clear()}),S.readOnly&&(kD(),(a.history.done.length||a.history.undone.length)&&a.clearHistory()),S.collapsed&&(S.id=++p0,S.atomic=!0),L){if(R&&(L.curOp.updateMaxLine=!0),S.collapsed)mn(L,d.line,p.line+1);else if(S.className||S.startStyle||S.endStyle||S.css||S.attributes||S.title)for(var F=d.line;F<=p.line;F++)Ws(L,F,"text");S.atomic&&i0(L.doc),_t(L,"markerAdded",L,S)}return S}var vl=function(a,d){this.markers=a,this.primary=d;for(var p=0;p<a.length;++p)a[p].parent=this};vl.prototype.clear=function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();_t(this,"clear")}},vl.prototype.find=function(a,d){return this.primary.find(a,d)},fi(vl);function BI(a,d,p,f,m){f=ge(f),f.shared=!1;var S=[Vo(a,d,p,f,m)],x=S[0],T=f.widgetNode;return Ys(a,function(L){T&&(f.widgetNode=T.cloneNode(!0)),S.push(Vo(L,Re(L,d),Re(L,p),f,m));for(var R=0;R<L.linked.length;++R)if(L.linked[R].isParent)return;x=Oe(S)}),new vl(S,x)}function g0(a){return a.findMarks(Q(a.first,0),a.clipPos(Q(a.lastLine())),function(d){return d.parent})}function FI(a,d){for(var p=0;p<d.length;p++){var f=d[p],m=f.find(),S=a.clipPos(m.from),x=a.clipPos(m.to);if(he(S,x)){var T=Vo(a,S,x,f.primary,f.primary.type);f.markers.push(T),T.parent=f}}}function UI(a){for(var d=function(f){var m=a[f],S=[m.primary.doc];Ys(m.primary.doc,function(L){return S.push(L)});for(var x=0;x<m.markers.length;x++){var T=m.markers[x];Ae(S,T.doc)==-1&&(T.parent=null,m.markers.splice(x--,1))}},p=0;p<a.length;p++)d(p)}var zI=0,vn=function(a,d,p,f,m){if(!(this instanceof vn))return new vn(a,d,p,f,m);p==null&&(p=0),gl.call(this,[new pl([new To("",null)])]),this.first=p,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=p;var S=Q(p,0);this.sel=Js(S),this.history=new vd(null),this.id=++zI,this.modeOption=d,this.lineSep=f,this.direction=m=="rtl"?"rtl":"ltr",this.extend=!1,typeof a=="string"&&(a=this.splitLines(a)),$f(this,{from:S,to:S,text:a}),Kt(this,Js(S),hn)};vn.prototype=Ms(gl.prototype,{constructor:vn,iter:function(a,d,p){p?this.iterN(a-this.first,d-a,p):this.iterN(this.first,this.first+this.size,a)},insert:function(a,d){for(var p=0,f=0;f<d.length;++f)p+=d[f].height;this.insertInner(a-this.first,d,p)},remove:function(a,d){this.removeInner(a-this.first,d)},getValue:function(a){var d=Xa(this,this.first,this.first+this.size);return a===!1?d:d.join(a||this.lineSeparator())},setValue:Bt(function(a){var d=Q(this.first,0),p=this.first+this.size-1;Oo(this,{from:d,to:Q(p,be(this,p).text.length),text:this.splitLines(a),origin:"setValue",full:!0},!0),this.cm&&rl(this.cm,0,0),Kt(this,Js(d),hn)}),replaceRange:function(a,d,p,f){d=Re(this,d),p=p?Re(this,p):d,_o(this,a,d,p,f)},getRange:function(a,d,p){var f=Zi(this,Re(this,a),Re(this,d));return p===!1?f:p===""?f.join(""):f.join(p||this.lineSeparator())},getLine:function(a){var d=this.getLineHandle(a);return d&&d.text},getLineHandle:function(a){if(te(this,a))return be(this,a)},getLineNumber:function(a){return M(a)},getLineHandleVisualStart:function(a){return typeof a=="number"&&(a=be(this,a)),yi(a)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return Re(this,a)},getCursor:function(a){var d=this.sel.primary(),p;return a==null||a=="head"?p=d.head:a=="anchor"?p=d.anchor:a=="end"||a=="to"||a===!1?p=d.to():p=d.from(),p},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:Bt(function(a,d,p){e0(this,Re(this,typeof a=="number"?Q(a,d||0):a),null,p)}),setSelection:Bt(function(a,d,p){e0(this,Re(this,a),Re(this,d||a),p)}),extendSelection:Bt(function(a,d,p){Sd(this,Re(this,a),d&&Re(this,d),p)}),extendSelections:Bt(function(a,d){ZS(this,Wy(this,a),d)}),extendSelectionsBy:Bt(function(a,d){var p=Un(this.sel.ranges,a);ZS(this,Wy(this,p),d)}),setSelections:Bt(function(a,d,p){if(a.length){for(var f=[],m=0;m<a.length;m++)f[m]=new qe(Re(this,a[m].anchor),Re(this,a[m].head||a[m].anchor));d==null&&(d=Math.min(a.length-1,this.sel.primIndex)),Kt(this,bi(this.cm,f,d),p)}}),addSelection:Bt(function(a,d,p){var f=this.sel.ranges.slice(0);f.push(new qe(Re(this,a),Re(this,d||a))),Kt(this,bi(this.cm,f,f.length-1),p)}),getSelection:function(a){for(var d=this.sel.ranges,p,f=0;f<d.length;f++){var m=Zi(this,d[f].from(),d[f].to());p=p?p.concat(m):m}return a===!1?p:p.join(a||this.lineSeparator())},getSelections:function(a){for(var d=[],p=this.sel.ranges,f=0;f<p.length;f++){var m=Zi(this,p[f].from(),p[f].to());a!==!1&&(m=m.join(a||this.lineSeparator())),d[f]=m}return d},replaceSelection:function(a,d,p){for(var f=[],m=0;m<this.sel.ranges.length;m++)f[m]=a;this.replaceSelections(f,d,p||"+input")},replaceSelections:Bt(function(a,d,p){for(var f=[],m=this.sel,S=0;S<m.ranges.length;S++){var x=m.ranges[S];f[S]={from:x.from(),to:x.to(),text:this.splitLines(a[S]),origin:p}}for(var T=d&&d!="end"&&DI(this,f,d),L=f.length-1;L>=0;L--)Oo(this,f[L]);T?t0(this,T):this.cm&&Ao(this.cm)}),undo:Bt(function(){Cd(this,"undo")}),redo:Bt(function(){Cd(this,"redo")}),undoSelection:Bt(function(){Cd(this,"undo",!0)}),redoSelection:Bt(function(){Cd(this,"redo",!0)}),setExtending:function(a){this.extend=a},getExtending:function(){return this.extend},historySize:function(){for(var a=this.history,d=0,p=0,f=0;f<a.done.length;f++)a.done[f].ranges||++d;for(var m=0;m<a.undone.length;m++)a.undone[m].ranges||++p;return{undo:d,redo:p}},clearHistory:function(){var a=this;this.history=new vd(this.history),Ys(this,function(d){return d.history=a.history},!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(a){return a&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:No(this.history.done),undone:No(this.history.undone)}},setHistory:function(a){var d=this.history=new vd(this.history);d.done=No(a.done.slice(0),null,!0),d.undone=No(a.undone.slice(0),null,!0)},setGutterMarker:Bt(function(a,d,p){return fl(this,a,"gutter",function(f){var m=f.gutterMarkers||(f.gutterMarkers={});return m[d]=p,!p&&Os(m)&&(f.gutterMarkers=null),!0})}),clearGutter:Bt(function(a){var d=this;this.iter(function(p){p.gutterMarkers&&p.gutterMarkers[a]&&fl(d,p,"gutter",function(){return p.gutterMarkers[a]=null,Os(p.gutterMarkers)&&(p.gutterMarkers=null),!0})})}),lineInfo:function(a){var d;if(typeof a=="number"){if(!te(this,a)||(d=a,a=be(this,a),!a))return null}else if(d=M(a),d==null)return null;return{line:d,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},addLineClass:Bt(function(a,d,p){return fl(this,a,d=="gutter"?"gutter":"class",function(f){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass";if(!f[m])f[m]=p;else{if(U(p).test(f[m]))return!1;f[m]+=" "+p}return!0})}),removeLineClass:Bt(function(a,d,p){return fl(this,a,d=="gutter"?"gutter":"class",function(f){var m=d=="text"?"textClass":d=="background"?"bgClass":d=="gutter"?"gutterClass":"wrapClass",S=f[m];if(S)if(p==null)f[m]=null;else{var x=S.match(U(p));if(!x)return!1;var T=x.index+x[0].length;f[m]=S.slice(0,x.index)+(!x.index||T==S.length?"":" ")+S.slice(T)||null}else return!1;return!0})}),addLineWidget:Bt(function(a,d,p){return VI(this,a,d,p)}),removeLineWidget:function(a){a.clear()},markText:function(a,d,p){return Vo(this,Re(this,a),Re(this,d),p,p&&p.type||"range")},setBookmark:function(a,d){var p={replacedWith:d&&(d.nodeType==null?d.widget:d),insertLeft:d&&d.insertLeft,clearWhenEmpty:!1,shared:d&&d.shared,handleMouseEvents:d&&d.handleMouseEvents};return a=Re(this,a),Vo(this,a,a,p,"bookmark")},findMarksAt:function(a){a=Re(this,a);var d=[],p=be(this,a.line).markedSpans;if(p)for(var f=0;f<p.length;++f){var m=p[f];(m.from==null||m.from<=a.ch)&&(m.to==null||m.to>=a.ch)&&d.push(m.marker.parent||m.marker)}return d},findMarks:function(a,d,p){a=Re(this,a),d=Re(this,d);var f=[],m=a.line;return this.iter(a.line,d.line+1,function(S){var x=S.markedSpans;if(x)for(var T=0;T<x.length;T++){var L=x[T];!(L.to!=null&&m==a.line&&a.ch>=L.to||L.from==null&&m!=a.line||L.from!=null&&m==d.line&&L.from>=d.ch)&&(!p||p(L.marker))&&f.push(L.marker.parent||L.marker)}++m}),f},getAllMarks:function(){var a=[];return this.iter(function(d){var p=d.markedSpans;if(p)for(var f=0;f<p.length;++f)p[f].from!=null&&a.push(p[f].marker)}),a},posFromIndex:function(a){var d,p=this.first,f=this.lineSeparator().length;return this.iter(function(m){var S=m.text.length+f;if(S>a)return d=a,!0;a-=S,++p}),Re(this,Q(p,d))},indexFromPos:function(a){a=Re(this,a);var d=a.ch;if(a.line<this.first||a.ch<0)return 0;var p=this.lineSeparator().length;return this.iter(this.first,a.line,function(f){d+=f.text.length+p}),d},copy:function(a){var d=new vn(Xa(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return d.scrollTop=this.scrollTop,d.scrollLeft=this.scrollLeft,d.sel=this.sel,d.extend=!1,a&&(d.history.undoDepth=this.history.undoDepth,d.setHistory(this.getHistory())),d},linkedDoc:function(a){a||(a={});var d=this.first,p=this.first+this.size;a.from!=null&&a.from>d&&(d=a.from),a.to!=null&&a.to<p&&(p=a.to);var f=new vn(Xa(this,d,p),a.mode||this.modeOption,d,this.lineSep,this.direction);return a.sharedHist&&(f.history=this.history),(this.linked||(this.linked=[])).push({doc:f,sharedHist:a.sharedHist}),f.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}],FI(f,g0(this)),f},unlinkDoc:function(a){if(a instanceof lt&&(a=a.doc),this.linked)for(var d=0;d<this.linked.length;++d){var p=this.linked[d];if(p.doc==a){this.linked.splice(d,1),a.unlinkDoc(this),UI(g0(this));break}}if(a.history==this.history){var f=[a.id];Ys(a,function(m){return f.push(m.id)},!0),a.history=new vd(null),a.history.done=No(this.history.done,f),a.history.undone=No(this.history.undone,f)}},iterLinkedDocs:function(a){Ys(this,a)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(a){return this.lineSep?a.split(this.lineSep):Gn(a)},lineSeparator:function(){return this.lineSep||`
`},setDirection:Bt(function(a){a!="rtl"&&(a="ltr"),a!=this.direction&&(this.direction=a,this.iter(function(d){return d.order=null}),this.cm&&II(this.cm))})}),vn.prototype.eachLine=vn.prototype.iter;var m0=0;function GI(a){var d=this;if(v0(d),!(vt(d,a)||ns(d.display,a))){qt(a),c&&(m0=+new Date);var p=Lr(d,a,!0),f=a.dataTransfer.files;if(!(!p||d.isReadOnly()))if(f&&f.length&&window.FileReader&&window.File)for(var m=f.length,S=Array(m),x=0,T=function(){++x==m&&Vt(d,function(){p=Re(d.doc,p);var Y={from:p,to:p,text:d.doc.splitLines(S.filter(function(Z){return Z!=null}).join(d.doc.lineSeparator())),origin:"paste"};Oo(d.doc,Y),t0(d.doc,Js(Re(d.doc,p),Re(d.doc,js(Y))))})()},L=function(Y,Z){if(d.options.allowDropFileTypes&&Ae(d.options.allowDropFileTypes,Y.type)==-1){T();return}var ne=new FileReader;ne.onerror=function(){return T()},ne.onload=function(){var le=ne.result;if(/[\x00-\x08\x0e-\x1f]{2}/.test(le)){T();return}S[Z]=le,T()},ne.readAsText(Y)},R=0;R<f.length;R++)L(f[R],R);else{if(d.state.draggingText&&d.doc.sel.contains(p)>-1){d.state.draggingText(a),setTimeout(function(){return d.display.input.focus()},20);return}try{var F=a.dataTransfer.getData("Text");if(F){var $;if(d.state.draggingText&&!d.state.draggingText.copy&&($=d.listSelections()),bd(d.doc,Js(p,p)),$)for(var q=0;q<$.length;++q)_o(d.doc,"",$[q].anchor,$[q].head,"drag");d.replaceSelection(F,"around","paste"),d.display.input.focus()}}catch{}}}}function $I(a,d){if(c&&(!a.state.draggingText||+new Date-m0<100)){Fs(d);return}if(!(vt(a,d)||ns(a.display,d))&&(d.dataTransfer.setData("Text",a.getSelection()),d.dataTransfer.effectAllowed="copyMove",d.dataTransfer.setDragImage&&!w)){var p=V("img",null,null,"position: fixed; left: 0; top: 0;");p.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",b&&(p.width=p.height=1,a.display.wrapper.appendChild(p),p._top=p.offsetTop),d.dataTransfer.setDragImage(p,0,0),b&&p.parentNode.removeChild(p)}}function WI(a,d){var p=Lr(a,d);if(p){var f=document.createDocumentFragment();Pf(a,p,f),a.display.dragCursor||(a.display.dragCursor=V("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),a.display.lineSpace.insertBefore(a.display.dragCursor,a.display.cursorDiv)),H(a.display.dragCursor,f)}}function v0(a){a.display.dragCursor&&(a.display.lineSpace.removeChild(a.display.dragCursor),a.display.dragCursor=null)}function y0(a){if(document.getElementsByClassName){for(var d=document.getElementsByClassName("CodeMirror"),p=[],f=0;f<d.length;f++){var m=d[f].CodeMirror;m&&p.push(m)}p.length&&p[0].operation(function(){for(var S=0;S<p.length;S++)a(p[S])})}}var S0=!1;function HI(){S0||(JI(),S0=!0)}function JI(){var a;ke(window,"resize",function(){a==null&&(a=setTimeout(function(){a=null,y0(jI)},100))}),ke(window,"blur",function(){return y0(Po)})}function jI(a){var d=a.display;d.cachedCharWidth=d.cachedTextHeight=d.cachedPaddingH=null,d.scrollbarsClipped=!1,a.setSize()}for(var Ks={3:"Pause",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",61:"=",91:"Mod",92:"Mod",93:"Mod",106:"*",107:"=",109:"-",110:".",111:"/",145:"ScrollLock",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",224:"Mod",63232:"Up",63233:"Down",63234:"Left",63235:"Right",63272:"Delete",63273:"Home",63275:"End",63276:"PageUp",63277:"PageDown",63302:"Insert"},yl=0;yl<10;yl++)Ks[yl+48]=Ks[yl+96]=String(yl);for(var xd=65;xd<=90;xd++)Ks[xd]=String.fromCharCode(xd);for(var Sl=1;Sl<=12;Sl++)Ks[Sl+111]=Ks[Sl+63235]="F"+Sl;var ss={};ss.basic={Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore","Shift-Backspace":"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite",Esc:"singleSelection"},ss.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Up":"goLineUp","Ctrl-Down":"goLineDown","Ctrl-Left":"goGroupLeft","Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore","Ctrl-U":"undoSelection","Shift-Ctrl-U":"redoSelection","Alt-U":"redoSelection",fallthrough:"basic"},ss.emacsy={"Ctrl-F":"goCharRight","Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars","Ctrl-O":"openLine"},ss.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Home":"goDocStart","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd","Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineLeft","Cmd-Right":"goLineRight","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delWrappedLineLeft","Cmd-Delete":"delWrappedLineRight","Cmd-U":"undoSelection","Shift-Cmd-U":"redoSelection","Ctrl-Up":"goDocStart","Ctrl-Down":"goDocEnd",fallthrough:["basic","emacsy"]},ss.default=N?ss.macDefault:ss.pcDefault;function YI(a){var d=a.split(/-(?!$)/);a=d[d.length-1];for(var p,f,m,S,x=0;x<d.length-1;x++){var T=d[x];if(/^(cmd|meta|m)$/i.test(T))S=!0;else if(/^a(lt)?$/i.test(T))p=!0;else if(/^(c|ctrl|control)$/i.test(T))f=!0;else if(/^s(hift)?$/i.test(T))m=!0;else throw new Error("Unrecognized modifier name: "+T)}return p&&(a="Alt-"+a),f&&(a="Ctrl-"+a),S&&(a="Cmd-"+a),m&&(a="Shift-"+a),a}function qI(a){var d={};for(var p in a)if(a.hasOwnProperty(p)){var f=a[p];if(/^(name|fallthrough|(de|at)tach)$/.test(p))continue;if(f=="..."){delete a[p];continue}for(var m=Un(p.split(" "),YI),S=0;S<m.length;S++){var x=void 0,T=void 0;S==m.length-1?(T=m.join(" "),x=f):(T=m.slice(0,S+1).join(" "),x="...");var L=d[T];if(!L)d[T]=x;else if(L!=x)throw new Error("Inconsistent bindings for "+T)}delete a[p]}for(var R in d)a[R]=d[R];return a}function Bo(a,d,p,f){d=Ed(d);var m=d.call?d.call(a,f):d[a];if(m===!1)return"nothing";if(m==="...")return"multi";if(m!=null&&p(m))return"handled";if(d.fallthrough){if(Object.prototype.toString.call(d.fallthrough)!="[object Array]")return Bo(a,d.fallthrough,p,f);for(var S=0;S<d.fallthrough.length;S++){var x=Bo(a,d.fallthrough[S],p,f);if(x)return x}}}function b0(a){var d=typeof a=="string"?a:Ks[a.keyCode];return d=="Ctrl"||d=="Alt"||d=="Shift"||d=="Mod"}function w0(a,d,p){var f=a;return d.altKey&&f!="Alt"&&(a="Alt-"+a),(_?d.metaKey:d.ctrlKey)&&f!="Ctrl"&&(a="Ctrl-"+a),(_?d.ctrlKey:d.metaKey)&&f!="Mod"&&(a="Cmd-"+a),!p&&d.shiftKey&&f!="Shift"&&(a="Shift-"+a),a}function C0(a,d){if(b&&a.keyCode==34&&a.char)return!1;var p=Ks[a.keyCode];return p==null||a.altGraphKey?!1:(a.keyCode==3&&a.code&&(p=a.code),w0(p,a,d))}function Ed(a){return typeof a=="string"?ss[a]:a}function Fo(a,d){for(var p=a.doc.sel.ranges,f=[],m=0;m<p.length;m++){for(var S=d(p[m]);f.length&&he(S.from,Oe(f).to)<=0;){var x=f.pop();if(he(x.from,S.from)<0){S.from=x.from;break}}f.push(S)}kn(a,function(){for(var T=f.length-1;T>=0;T--)_o(a.doc,"",f[T].from,f[T].to,"+delete");Ao(a)})}function jf(a,d,p){var f=_s(a.text,d+p,p);return f<0||f>a.text.length?null:f}function Yf(a,d,p){var f=jf(a,d.ch,p);return f==null?null:new Q(d.line,f,p<0?"after":"before")}function qf(a,d,p,f,m){if(a){d.doc.direction=="rtl"&&(m=-m);var S=Be(p,d.doc.direction);if(S){var x=m<0?Oe(S):S[0],T=m<0==(x.level==1),L=T?"after":"before",R;if(x.level>0||d.doc.direction=="rtl"){var F=Lo(d,p);R=m<0?p.text.length-1:0;var $=Bi(d,F,R).top;R=Mi(function(q){return Bi(d,F,q).top==$},m<0==(x.level==1)?x.from:x.to-1,R),L=="before"&&(R=jf(p,R,1))}else R=m<0?x.to:x.from;return new Q(f,R,L)}}return new Q(f,m<0?p.text.length:0,m<0?"before":"after")}function KI(a,d,p,f){var m=Be(d,a.doc.direction);if(!m)return Yf(d,p,f);p.ch>=d.text.length?(p.ch=d.text.length,p.sticky="before"):p.ch<=0&&(p.ch=0,p.sticky="after");var S=Bs(m,p.ch,p.sticky),x=m[S];if(a.doc.direction=="ltr"&&x.level%2==0&&(f>0?x.to>p.ch:x.from<p.ch))return Yf(d,p,f);var T=function(ce,pe){return jf(d,ce instanceof Q?ce.ch:ce,pe)},L,R=function(ce){return a.options.lineWrapping?(L=L||Lo(a,d),LS(a,d,L,ce)):{begin:0,end:d.text.length}},F=R(p.sticky=="before"?T(p,-1):p.ch);if(a.doc.direction=="rtl"||x.level==1){var $=x.level==1==f<0,q=T(p,$?1:-1);if(q!=null&&($?q<=x.to&&q<=F.end:q>=x.from&&q>=F.begin)){var Y=$?"before":"after";return new Q(p.line,q,Y)}}var Z=function(ce,pe,de){for(var ye=function(it,Ft){return Ft?new Q(p.line,T(it,1),"before"):new Q(p.line,it,"after")};ce>=0&&ce<m.length;ce+=pe){var Le=m[ce],xe=pe>0==(Le.level!=1),Me=xe?de.begin:T(de.end,-1);if(Le.from<=Me&&Me<Le.to||(Me=xe?Le.from:T(Le.to,-1),de.begin<=Me&&Me<de.end))return ye(Me,xe)}},ne=Z(S+f,f,F);if(ne)return ne;var le=f>0?F.end:T(F.begin,-1);return le!=null&&!(f>0&&le==d.text.length)&&(ne=Z(f>0?0:m.length-1,f,R(le)),ne)?ne:null}var bl={selectAll:o0,singleSelection:function(a){return a.setSelection(a.getCursor("anchor"),a.getCursor("head"),hn)},killLine:function(a){return Fo(a,function(d){if(d.empty()){var p=be(a.doc,d.head.line).text.length;return d.head.ch==p&&d.head.line<a.lastLine()?{from:d.head,to:Q(d.head.line+1,0)}:{from:d.head,to:Q(d.head.line,p)}}else return{from:d.from(),to:d.to()}})},deleteLine:function(a){return Fo(a,function(d){return{from:Q(d.from().line,0),to:Re(a.doc,Q(d.to().line+1,0))}})},delLineLeft:function(a){return Fo(a,function(d){return{from:Q(d.from().line,0),to:d.from()}})},delWrappedLineLeft:function(a){return Fo(a,function(d){var p=a.charCoords(d.head,"div").top+5,f=a.coordsChar({left:0,top:p},"div");return{from:f,to:d.from()}})},delWrappedLineRight:function(a){return Fo(a,function(d){var p=a.charCoords(d.head,"div").top+5,f=a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:p},"div");return{from:d.from(),to:f}})},undo:function(a){return a.undo()},redo:function(a){return a.redo()},undoSelection:function(a){return a.undoSelection()},redoSelection:function(a){return a.redoSelection()},goDocStart:function(a){return a.extendSelection(Q(a.firstLine(),0))},goDocEnd:function(a){return a.extendSelection(Q(a.lastLine()))},goLineStart:function(a){return a.extendSelectionsBy(function(d){return x0(a,d.head.line)},{origin:"+move",bias:1})},goLineStartSmart:function(a){return a.extendSelectionsBy(function(d){return E0(a,d.head)},{origin:"+move",bias:1})},goLineEnd:function(a){return a.extendSelectionsBy(function(d){return XI(a,d.head.line)},{origin:"+move",bias:-1})},goLineRight:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5;return a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:p},"div")},nn)},goLineLeft:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5;return a.coordsChar({left:0,top:p},"div")},nn)},goLineLeftSmart:function(a){return a.extendSelectionsBy(function(d){var p=a.cursorCoords(d.head,"div").top+5,f=a.coordsChar({left:0,top:p},"div");return f.ch<a.getLine(f.line).search(/\S/)?E0(a,d.head):f},nn)},goLineUp:function(a){return a.moveV(-1,"line")},goLineDown:function(a){return a.moveV(1,"line")},goPageUp:function(a){return a.moveV(-1,"page")},goPageDown:function(a){return a.moveV(1,"page")},goCharLeft:function(a){return a.moveH(-1,"char")},goCharRight:function(a){return a.moveH(1,"char")},goColumnLeft:function(a){return a.moveH(-1,"column")},goColumnRight:function(a){return a.moveH(1,"column")},goWordLeft:function(a){return a.moveH(-1,"word")},goGroupRight:function(a){return a.moveH(1,"group")},goGroupLeft:function(a){return a.moveH(-1,"group")},goWordRight:function(a){return a.moveH(1,"word")},delCharBefore:function(a){return a.deleteH(-1,"codepoint")},delCharAfter:function(a){return a.deleteH(1,"char")},delWordBefore:function(a){return a.deleteH(-1,"word")},delWordAfter:function(a){return a.deleteH(1,"word")},delGroupBefore:function(a){return a.deleteH(-1,"group")},delGroupAfter:function(a){return a.deleteH(1,"group")},indentAuto:function(a){return a.indentSelection("smart")},indentMore:function(a){return a.indentSelection("add")},indentLess:function(a){return a.indentSelection("subtract")},insertTab:function(a){return a.replaceSelection("	")},insertSoftTab:function(a){for(var d=[],p=a.listSelections(),f=a.options.tabSize,m=0;m<p.length;m++){var S=p[m].from(),x=Ce(a.getLine(S.line),S.ch,f);d.push(ui(f-x%f))}a.replaceSelections(d)},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):a.execCommand("insertTab")},transposeChars:function(a){return kn(a,function(){for(var d=a.listSelections(),p=[],f=0;f<d.length;f++)if(d[f].empty()){var m=d[f].head,S=be(a.doc,m.line).text;if(S){if(m.ch==S.length&&(m=new Q(m.line,m.ch-1)),m.ch>0)m=new Q(m.line,m.ch+1),a.replaceRange(S.charAt(m.ch-1)+S.charAt(m.ch-2),Q(m.line,m.ch-2),m,"+transpose");else if(m.line>a.doc.first){var x=be(a.doc,m.line-1).text;x&&(m=new Q(m.line,1),a.replaceRange(S.charAt(0)+a.doc.lineSeparator()+x.charAt(x.length-1),Q(m.line-1,x.length-1),m,"+transpose"))}}p.push(new qe(m,m))}a.setSelections(p)})},newlineAndIndent:function(a){return kn(a,function(){for(var d=a.listSelections(),p=d.length-1;p>=0;p--)a.replaceRange(a.doc.lineSeparator(),d[p].anchor,d[p].head,"+input");d=a.listSelections();for(var f=0;f<d.length;f++)a.indentLine(d[f].from().line,null,!0);Ao(a)})},openLine:function(a){return a.replaceSelection(`
`,"start")},toggleOverwrite:function(a){return a.toggleOverwrite()}};function x0(a,d){var p=be(a.doc,d),f=yi(p);return f!=p&&(d=M(f)),qf(!0,a,f,d,1)}function XI(a,d){var p=be(a.doc,d),f=MD(p);return f!=p&&(d=M(f)),qf(!0,a,p,d,-1)}function E0(a,d){var p=x0(a,d.line),f=be(a.doc,p.line),m=Be(f,a.doc.direction);if(!m||m[0].level==0){var S=Math.max(p.ch,f.text.search(/\S/)),x=d.line==p.line&&d.ch<=S&&d.ch;return Q(p.line,x?0:S,p.sticky)}return p}function Td(a,d,p){if(typeof d=="string"&&(d=bl[d],!d))return!1;a.display.input.ensurePolled();var f=a.display.shift,m=!1;try{a.isReadOnly()&&(a.state.suppressEdits=!0),p&&(a.display.shift=!1),m=d(a)!=Ri}finally{a.display.shift=f,a.state.suppressEdits=!1}return m}function QI(a,d,p){for(var f=0;f<a.state.keyMaps.length;f++){var m=Bo(d,a.state.keyMaps[f],p,a);if(m)return m}return a.options.extraKeys&&Bo(d,a.options.extraKeys,p,a)||Bo(d,a.options.keyMap,p,a)}var ZI=new ot;function wl(a,d,p,f){var m=a.state.keySeq;if(m){if(b0(d))return"handled";if(/\'$/.test(d)?a.state.keySeq=null:ZI.set(50,function(){a.state.keySeq==m&&(a.state.keySeq=null,a.display.input.reset())}),T0(a,m+" "+d,p,f))return!0}return T0(a,d,p,f)}function T0(a,d,p,f){var m=QI(a,d,f);return m=="multi"&&(a.state.keySeq=d),m=="handled"&&_t(a,"keyHandled",a,d,p),(m=="handled"||m=="multi")&&(qt(p),Af(a)),!!m}function k0(a,d){var p=C0(d,!0);return p?d.shiftKey&&!a.state.keySeq?wl(a,"Shift-"+p,d,function(f){return Td(a,f,!0)})||wl(a,p,d,function(f){if(typeof f=="string"?/^go[A-Z]/.test(f):f.motion)return Td(a,f)}):wl(a,p,d,function(f){return Td(a,f)}):!1}function eP(a,d,p){return wl(a,"'"+p+"'",d,function(f){return Td(a,f,!0)})}var Kf=null;function L0(a){var d=this;if(!(a.target&&a.target!=d.display.input.getField())&&(d.curOp.focus=me(nt(d)),!vt(d,a))){c&&u<11&&a.keyCode==27&&(a.returnValue=!1);var p=a.keyCode;d.display.shift=p==16||a.shiftKey;var f=k0(d,a);b&&(Kf=f?p:null,!f&&p==88&&!Zc&&(N?a.metaKey:a.ctrlKey)&&d.replaceSelection("",null,"cut")),s&&!N&&!f&&p==46&&a.shiftKey&&!a.ctrlKey&&document.execCommand&&document.execCommand("cut"),p==18&&!/\bCodeMirror-crosshair\b/.test(d.display.lineDiv.className)&&tP(d)}}function tP(a){var d=a.display.lineDiv;Ie(d,"CodeMirror-crosshair");function p(f){(f.keyCode==18||!f.altKey)&&(j(d,"CodeMirror-crosshair"),Yt(document,"keyup",p),Yt(document,"mouseover",p))}ke(document,"keyup",p),ke(document,"mouseover",p)}function D0(a){a.keyCode==16&&(this.doc.sel.shift=!1),vt(this,a)}function I0(a){var d=this;if(!(a.target&&a.target!=d.display.input.getField())&&!(ns(d.display,a)||vt(d,a)||a.ctrlKey&&!a.altKey||N&&a.metaKey)){var p=a.keyCode,f=a.charCode;if(b&&p==Kf){Kf=null,qt(a);return}if(!(b&&(!a.which||a.which<10)&&k0(d,a))){var m=String.fromCharCode(f??p);m!="\b"&&(eP(d,a,m)||d.display.input.onKeyPress(a))}}}var nP=400,Xf=function(a,d,p){this.time=a,this.pos=d,this.button=p};Xf.prototype.compare=function(a,d,p){return this.time+nP>a&&he(d,this.pos)==0&&p==this.button};var Cl,xl;function iP(a,d){var p=+new Date;return xl&&xl.compare(p,a,d)?(Cl=xl=null,"triple"):Cl&&Cl.compare(p,a,d)?(xl=new Xf(p,a,d),Cl=null,"double"):(Cl=new Xf(p,a,d),xl=null,"single")}function P0(a){var d=this,p=d.display;if(!(vt(d,a)||p.activeTouch&&p.input.supportsTouch())){if(p.input.ensurePolled(),p.shift=a.shiftKey,ns(p,a)){h||(p.scroller.draggable=!1,setTimeout(function(){return p.scroller.draggable=!0},100));return}if(!Qf(d,a)){var f=Lr(d,a),m=pi(a),S=f?iP(f,m):"single";Te(d).focus(),m==1&&d.state.selectingText&&d.state.selectingText(a),!(f&&sP(d,m,f,S,a))&&(m==1?f?oP(d,f,S,a):Ya(a)==p.scroller&&qt(a):m==2?(f&&Sd(d.doc,f),setTimeout(function(){return p.input.focus()},20)):m==3&&(W?d.display.input.onContextMenu(a):Rf(d)))}}}function sP(a,d,p,f,m){var S="Click";return f=="double"?S="Double"+S:f=="triple"&&(S="Triple"+S),S=(d==1?"Left":d==2?"Middle":"Right")+S,wl(a,w0(S,m),m,function(x){if(typeof x=="string"&&(x=bl[x]),!x)return!1;var T=!1;try{a.isReadOnly()&&(a.state.suppressEdits=!0),T=x(a,p)!=Ri}finally{a.state.suppressEdits=!1}return T})}function rP(a,d,p){var f=a.getOption("configureMouse"),m=f?f(a,d,p):{};if(m.unit==null){var S=I?p.shiftKey&&p.metaKey:p.altKey;m.unit=S?"rectangle":d=="single"?"char":d=="double"?"word":"line"}return(m.extend==null||a.doc.extend)&&(m.extend=a.doc.extend||p.shiftKey),m.addNew==null&&(m.addNew=N?p.metaKey:p.ctrlKey),m.moveOnDrag==null&&(m.moveOnDrag=!(N?p.altKey:p.ctrlKey)),m}function oP(a,d,p,f){c?setTimeout(Se(AS,a),0):a.curOp.focus=me(nt(a));var m=rP(a,p,f),S=a.doc.sel,x;a.options.dragDrop&&df&&!a.isReadOnly()&&p=="single"&&(x=S.contains(d))>-1&&(he((x=S.ranges[x]).from(),d)<0||d.xRel>0)&&(he(x.to(),d)>0||d.xRel<0)?aP(a,f,d,m):lP(a,f,d,m)}function aP(a,d,p,f){var m=a.display,S=!1,x=Vt(a,function(R){h&&(m.scroller.draggable=!1),a.state.draggingText=!1,a.state.delayingBlurEvent&&(a.hasFocus()?a.state.delayingBlurEvent=!1:Rf(a)),Yt(m.wrapper.ownerDocument,"mouseup",x),Yt(m.wrapper.ownerDocument,"mousemove",T),Yt(m.scroller,"dragstart",L),Yt(m.scroller,"drop",x),S||(qt(R),f.addNew||Sd(a.doc,p,null,null,f.extend),h&&!w||c&&u==9?setTimeout(function(){m.wrapper.ownerDocument.body.focus({preventScroll:!0}),m.input.focus()},20):m.input.focus())}),T=function(R){S=S||Math.abs(d.clientX-R.clientX)+Math.abs(d.clientY-R.clientY)>=10},L=function(){return S=!0};h&&(m.scroller.draggable=!0),a.state.draggingText=x,x.copy=!f.moveOnDrag,ke(m.wrapper.ownerDocument,"mouseup",x),ke(m.wrapper.ownerDocument,"mousemove",T),ke(m.scroller,"dragstart",L),ke(m.scroller,"drop",x),a.state.delayingBlurEvent=!0,setTimeout(function(){return m.input.focus()},20),m.scroller.dragDrop&&m.scroller.dragDrop()}function A0(a,d,p){if(p=="char")return new qe(d,d);if(p=="word")return a.findWordAt(d);if(p=="line")return new qe(Q(d.line,0),Re(a.doc,Q(d.line+1,0)));var f=p(a,d);return new qe(f.from,f.to)}function lP(a,d,p,f){c&&Rf(a);var m=a.display,S=a.doc;qt(d);var x,T,L=S.sel,R=L.ranges;if(f.addNew&&!f.extend?(T=S.sel.contains(p),T>-1?x=R[T]:x=new qe(p,p)):(x=S.sel.primary(),T=S.sel.primIndex),f.unit=="rectangle")f.addNew||(x=new qe(p,p)),p=Lr(a,d,!0,!0),T=-1;else{var F=A0(a,p,f.unit);f.extend?x=Hf(x,F.anchor,F.head,f.extend):x=F}f.addNew?T==-1?(T=R.length,Kt(S,bi(a,R.concat([x]),T),{scroll:!1,origin:"*mouse"})):R.length>1&&R[T].empty()&&f.unit=="char"&&!f.extend?(Kt(S,bi(a,R.slice(0,T).concat(R.slice(T+1)),0),{scroll:!1,origin:"*mouse"}),L=S.sel):Jf(S,T,x,Fn):(T=0,Kt(S,new Nn([x],0),Fn),L=S.sel);var $=p;function q(de){if(he($,de)!=0)if($=de,f.unit=="rectangle"){for(var ye=[],Le=a.options.tabSize,xe=Ce(be(S,p.line).text,p.ch,Le),Me=Ce(be(S,de.line).text,de.ch,Le),it=Math.min(xe,Me),Ft=Math.max(xe,Me),dt=Math.min(p.line,de.line),Ln=Math.min(a.lastLine(),Math.max(p.line,de.line));dt<=Ln;dt++){var yn=be(S,dt).text,Dt=sn(yn,it,Le);it==Ft?ye.push(new qe(Q(dt,Dt),Q(dt,Dt))):yn.length>Dt&&ye.push(new qe(Q(dt,Dt),Q(dt,sn(yn,Ft,Le))))}ye.length||ye.push(new qe(p,p)),Kt(S,bi(a,L.ranges.slice(0,T).concat(ye),T),{origin:"*mouse",scroll:!1}),a.scrollIntoView(de)}else{var Sn=x,Gt=A0(a,de,f.unit),Mt=Sn.anchor,It;he(Gt.anchor,Mt)>0?(It=Gt.head,Mt=Eo(Sn.from(),Gt.anchor)):(It=Gt.anchor,Mt=gn(Sn.to(),Gt.head));var St=L.ranges.slice(0);St[T]=cP(a,new qe(Re(S,Mt),It)),Kt(S,bi(a,St,T),Fn)}}var Y=m.wrapper.getBoundingClientRect(),Z=0;function ne(de){var ye=++Z,Le=Lr(a,de,!0,f.unit=="rectangle");if(Le)if(he(Le,$)!=0){a.curOp.focus=me(nt(a)),q(Le);var xe=fd(m,S);(Le.line>=xe.to||Le.line<xe.from)&&setTimeout(Vt(a,function(){Z==ye&&ne(de)}),150)}else{var Me=de.clientY<Y.top?-20:de.clientY>Y.bottom?20:0;Me&&setTimeout(Vt(a,function(){Z==ye&&(m.scroller.scrollTop+=Me,ne(de))}),50)}}function le(de){a.state.selectingText=!1,Z=1/0,de&&(qt(de),m.input.focus()),Yt(m.wrapper.ownerDocument,"mousemove",ce),Yt(m.wrapper.ownerDocument,"mouseup",pe),S.history.lastSelOrigin=null}var ce=Vt(a,function(de){de.buttons===0||!pi(de)?le(de):ne(de)}),pe=Vt(a,le);a.state.selectingText=pe,ke(m.wrapper.ownerDocument,"mousemove",ce),ke(m.wrapper.ownerDocument,"mouseup",pe)}function cP(a,d){var p=d.anchor,f=d.head,m=be(a.doc,p.line);if(he(p,f)==0&&p.sticky==f.sticky)return d;var S=Be(m);if(!S)return d;var x=Bs(S,p.ch,p.sticky),T=S[x];if(T.from!=p.ch&&T.to!=p.ch)return d;var L=x+(T.from==p.ch==(T.level!=1)?0:1);if(L==0||L==S.length)return d;var R;if(f.line!=p.line)R=(f.line-p.line)*(a.doc.direction=="ltr"?1:-1)>0;else{var F=Bs(S,f.ch,f.sticky),$=F-x||(f.ch-p.ch)*(T.level==1?-1:1);F==L-1||F==L?R=$<0:R=$>0}var q=S[L+(R?-1:0)],Y=R==(q.level==1),Z=Y?q.from:q.to,ne=Y?"after":"before";return p.ch==Z&&p.sticky==ne?d:new qe(new Q(p.line,Z,ne),f)}function R0(a,d,p,f){var m,S;if(d.touches)m=d.touches[0].clientX,S=d.touches[0].clientY;else try{m=d.clientX,S=d.clientY}catch{return!1}if(m>=Math.floor(a.display.gutters.getBoundingClientRect().right))return!1;f&&qt(d);var x=a.display,T=x.lineDiv.getBoundingClientRect();if(S>T.bottom||!Tn(a,p))return pn(d);S-=T.top-x.viewOffset;for(var L=0;L<a.display.gutterSpecs.length;++L){var R=x.gutters.childNodes[L];if(R&&R.getBoundingClientRect().right>=m){var F=G(a.doc,S),$=a.display.gutterSpecs[L];return mt(a,p,a,F,$.className,d),pn(d)}}}function Qf(a,d){return R0(a,d,"gutterClick",!0)}function N0(a,d){ns(a.display,d)||dP(a,d)||vt(a,d,"contextmenu")||W||a.display.input.onContextMenu(d)}function dP(a,d){return Tn(a,"gutterContextMenu")?R0(a,d,"gutterContextMenu",!1):!1}function M0(a){a.display.wrapper.className=a.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+a.options.theme.replace(/(^|\s)\s*/g," cm-s-"),il(a)}var Uo={toString:function(){return"CodeMirror.Init"}},O0={},kd={};function uP(a){var d=a.optionHandlers;function p(f,m,S,x){a.defaults[f]=m,S&&(d[f]=x?function(T,L,R){R!=Uo&&S(T,L,R)}:S)}a.defineOption=p,a.Init=Uo,p("value","",function(f,m){return f.setValue(m)},!0),p("mode",null,function(f,m){f.doc.modeOption=m,Gf(f)},!0),p("indentUnit",2,Gf,!0),p("indentWithTabs",!1),p("smartIndent",!0),p("tabSize",4,function(f){ul(f),il(f),mn(f)},!0),p("lineSeparator",null,function(f,m){if(f.doc.lineSep=m,!!m){var S=[],x=f.doc.first;f.doc.iter(function(L){for(var R=0;;){var F=L.text.indexOf(m,R);if(F==-1)break;R=F+m.length,S.push(Q(x,F))}x++});for(var T=S.length-1;T>=0;T--)_o(f.doc,m,S[T],Q(S[T].line,S[T].ch+m.length))}}),p("specialChars",/[\u0000-\u001f\u007f-\u009f\u00ad\u061c\u200b\u200e\u200f\u2028\u2029\u202d\u202e\u2066\u2067\u2069\ufeff\ufff9-\ufffc]/g,function(f,m,S){f.state.specialChars=new RegExp(m.source+(m.test("	")?"":"|	"),"g"),S!=Uo&&f.refresh()}),p("specialCharPlaceholder",UD,function(f){return f.refresh()},!0),p("electricChars",!0),p("inputStyle",A?"contenteditable":"textarea",function(){throw new Error("inputStyle can not (yet) be changed in a running editor")},!0),p("spellcheck",!1,function(f,m){return f.getInputField().spellcheck=m},!0),p("autocorrect",!1,function(f,m){return f.getInputField().autocorrect=m},!0),p("autocapitalize",!1,function(f,m){return f.getInputField().autocapitalize=m},!0),p("rtlMoveVisually",!P),p("wholeLineUpdateBefore",!0),p("theme","default",function(f){M0(f),dl(f)},!0),p("keyMap","default",function(f,m,S){var x=Ed(m),T=S!=Uo&&Ed(S);T&&T.detach&&T.detach(f,x),x.attach&&x.attach(f,T||null)}),p("extraKeys",null),p("configureMouse",null),p("lineWrapping",!1,fP,!0),p("gutters",[],function(f,m){f.display.gutterSpecs=Uf(m,f.options.lineNumbers),dl(f)},!0),p("fixedGutter",!0,function(f,m){f.display.gutters.style.left=m?Df(f.display)+"px":"0",f.refresh()},!0),p("coverGutterNextToScrollbar",!1,function(f){return Ro(f)},!0),p("scrollbarStyle","native",function(f){VS(f),Ro(f),f.display.scrollbars.setScrollTop(f.doc.scrollTop),f.display.scrollbars.setScrollLeft(f.doc.scrollLeft)},!0),p("lineNumbers",!1,function(f,m){f.display.gutterSpecs=Uf(f.options.gutters,m),dl(f)},!0),p("firstLineNumber",1,dl,!0),p("lineNumberFormatter",function(f){return f},dl,!0),p("showCursorWhenSelecting",!1,sl,!0),p("resetSelectionOnContextMenu",!0),p("lineWiseCopyCut",!0),p("pasteLinesPerSelection",!0),p("selectionsMayTouch",!1),p("readOnly",!1,function(f,m){m=="nocursor"&&(Po(f),f.display.input.blur()),f.display.input.readOnlyChanged(m)}),p("screenReaderLabel",null,function(f,m){m=m===""?null:m,f.display.input.screenReaderLabelChanged(m)}),p("disableInput",!1,function(f,m){m||f.display.input.reset()},!0),p("dragDrop",!0,hP),p("allowDropFileTypes",null),p("cursorBlinkRate",530),p("cursorScrollMargin",0),p("cursorHeight",1,sl,!0),p("singleCursorHeightPerLine",!0,sl,!0),p("workTime",100),p("workDelay",100),p("flattenSpans",!0,ul,!0),p("addModeClass",!1,ul,!0),p("pollInterval",100),p("undoDepth",200,function(f,m){return f.doc.history.undoDepth=m}),p("historyEventDelay",1250),p("viewportMargin",10,function(f){return f.refresh()},!0),p("maxHighlightLength",1e4,ul,!0),p("moveInputWithCursor",!0,function(f,m){m||f.display.input.resetPosition()}),p("tabindex",null,function(f,m){return f.display.input.getField().tabIndex=m||""}),p("autofocus",null),p("direction","ltr",function(f,m){return f.doc.setDirection(m)},!0),p("phrases",null)}function hP(a,d,p){var f=p&&p!=Uo;if(!d!=!f){var m=a.display.dragFunctions,S=d?ke:Yt;S(a.display.scroller,"dragstart",m.start),S(a.display.scroller,"dragenter",m.enter),S(a.display.scroller,"dragover",m.over),S(a.display.scroller,"dragleave",m.leave),S(a.display.scroller,"drop",m.drop)}}function fP(a){a.options.lineWrapping?(Ie(a.display.wrapper,"CodeMirror-wrap"),a.display.sizer.style.minWidth="",a.display.sizerWidth=null):(j(a.display.wrapper,"CodeMirror-wrap"),yf(a)),If(a),mn(a),il(a),setTimeout(function(){return Ro(a)},100)}function lt(a,d){var p=this;if(!(this instanceof lt))return new lt(a,d);this.options=d=d?ge(d):{},ge(O0,d,!1);var f=d.value;typeof f=="string"?f=new vn(f,d.mode,null,d.lineSeparator,d.direction):d.mode&&(f.modeOption=d.mode),this.doc=f;var m=new lt.inputStyles[d.inputStyle](this),S=this.display=new kI(a,f,m,d);S.wrapper.CodeMirror=this,M0(this),d.lineWrapping&&(this.display.wrapper.className+=" CodeMirror-wrap"),VS(this),this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,delayingBlurEvent:!1,focused:!1,suppressEdits:!1,pasteIncoming:-1,cutIncoming:-1,selectingText:!1,draggingText:!1,highlight:new ot,keySeq:null,specialChars:null},d.autofocus&&!A&&S.input.focus(),c&&u<11&&setTimeout(function(){return p.display.input.reset(!0)},20),pP(this),HI(),Ar(this),this.curOp.forceUpdate=!0,jS(this,f),d.autofocus&&!A||this.hasFocus()?setTimeout(function(){p.hasFocus()&&!p.state.focused&&Nf(p)},20):Po(this);for(var x in kd)kd.hasOwnProperty(x)&&kd[x](this,d[x],Uo);US(this),d.finishInit&&d.finishInit(this);for(var T=0;T<Zf.length;++T)Zf[T](this);Rr(this),h&&d.lineWrapping&&getComputedStyle(S.lineDiv).textRendering=="optimizelegibility"&&(S.lineDiv.style.textRendering="auto")}lt.defaults=O0,lt.optionHandlers=kd;function pP(a){var d=a.display;ke(d.scroller,"mousedown",Vt(a,P0)),c&&u<11?ke(d.scroller,"dblclick",Vt(a,function(L){if(!vt(a,L)){var R=Lr(a,L);if(!(!R||Qf(a,L)||ns(a.display,L))){qt(L);var F=a.findWordAt(R);Sd(a.doc,F.anchor,F.head)}}})):ke(d.scroller,"dblclick",function(L){return vt(a,L)||qt(L)}),ke(d.scroller,"contextmenu",function(L){return N0(a,L)}),ke(d.input.getField(),"contextmenu",function(L){d.scroller.contains(L.target)||N0(a,L)});var p,f={end:0};function m(){d.activeTouch&&(p=setTimeout(function(){return d.activeTouch=null},1e3),f=d.activeTouch,f.end=+new Date)}function S(L){if(L.touches.length!=1)return!1;var R=L.touches[0];return R.radiusX<=1&&R.radiusY<=1}function x(L,R){if(R.left==null)return!0;var F=R.left-L.left,$=R.top-L.top;return F*F+$*$>20*20}ke(d.scroller,"touchstart",function(L){if(!vt(a,L)&&!S(L)&&!Qf(a,L)){d.input.ensurePolled(),clearTimeout(p);var R=+new Date;d.activeTouch={start:R,moved:!1,prev:R-f.end<=300?f:null},L.touches.length==1&&(d.activeTouch.left=L.touches[0].pageX,d.activeTouch.top=L.touches[0].pageY)}}),ke(d.scroller,"touchmove",function(){d.activeTouch&&(d.activeTouch.moved=!0)}),ke(d.scroller,"touchend",function(L){var R=d.activeTouch;if(R&&!ns(d,L)&&R.left!=null&&!R.moved&&new Date-R.start<300){var F=a.coordsChar(d.activeTouch,"page"),$;!R.prev||x(R,R.prev)?$=new qe(F,F):!R.prev.prev||x(R,R.prev.prev)?$=a.findWordAt(F):$=new qe(Q(F.line,0),Re(a.doc,Q(F.line+1,0))),a.setSelection($.anchor,$.head),a.focus(),qt(L)}m()}),ke(d.scroller,"touchcancel",m),ke(d.scroller,"scroll",function(){d.scroller.clientHeight&&(ol(a,d.scroller.scrollTop),Ir(a,d.scroller.scrollLeft,!0),mt(a,"scroll",a))}),ke(d.scroller,"mousewheel",function(L){return $S(a,L)}),ke(d.scroller,"DOMMouseScroll",function(L){return $S(a,L)}),ke(d.wrapper,"scroll",function(){return d.wrapper.scrollTop=d.wrapper.scrollLeft=0}),d.dragFunctions={enter:function(L){vt(a,L)||Fs(L)},over:function(L){vt(a,L)||(WI(a,L),Fs(L))},start:function(L){return $I(a,L)},drop:Vt(a,GI),leave:function(L){vt(a,L)||v0(a)}};var T=d.input.getField();ke(T,"keyup",function(L){return D0.call(a,L)}),ke(T,"keydown",Vt(a,L0)),ke(T,"keypress",Vt(a,I0)),ke(T,"focus",function(L){return Nf(a,L)}),ke(T,"blur",function(L){return Po(a,L)})}var Zf=[];lt.defineInitHook=function(a){return Zf.push(a)};function El(a,d,p,f){var m=a.doc,S;p==null&&(p="add"),p=="smart"&&(m.mode.indent?S=Qa(a,d).state:p="prev");var x=a.options.tabSize,T=be(m,d),L=Ce(T.text,null,x);T.stateAfter&&(T.stateAfter=null);var R=T.text.match(/^\s*/)[0],F;if(!f&&!/\S/.test(T.text))F=0,p="not";else if(p=="smart"&&(F=m.mode.indent(S,T.text.slice(R.length),T.text),F==Ri||F>150)){if(!f)return;p="prev"}p=="prev"?d>m.first?F=Ce(be(m,d-1).text,null,x):F=0:p=="add"?F=L+a.options.indentUnit:p=="subtract"?F=L-a.options.indentUnit:typeof p=="number"&&(F=L+p),F=Math.max(0,F);var $="",q=0;if(a.options.indentWithTabs)for(var Y=Math.floor(F/x);Y;--Y)q+=x,$+="	";if(q<F&&($+=ui(F-q)),$!=R)return _o(m,$,Q(d,0),Q(d,R.length),"+input"),T.stateAfter=null,!0;for(var Z=0;Z<m.sel.ranges.length;Z++){var ne=m.sel.ranges[Z];if(ne.head.line==d&&ne.head.ch<R.length){var le=Q(d,R.length);Jf(m,Z,new qe(le,le));break}}}var wi=null;function Ld(a){wi=a}function ep(a,d,p,f,m){var S=a.doc;a.display.shift=!1,f||(f=S.sel);var x=+new Date-200,T=m=="paste"||a.state.pasteIncoming>x,L=Gn(d),R=null;if(T&&f.ranges.length>1)if(wi&&wi.text.join(`
`)==d){if(f.ranges.length%wi.text.length==0){R=[];for(var F=0;F<wi.text.length;F++)R.push(S.splitLines(wi.text[F]))}}else L.length==f.ranges.length&&a.options.pasteLinesPerSelection&&(R=Un(L,function(ce){return[ce]}));for(var $=a.curOp.updateInput,q=f.ranges.length-1;q>=0;q--){var Y=f.ranges[q],Z=Y.from(),ne=Y.to();Y.empty()&&(p&&p>0?Z=Q(Z.line,Z.ch-p):a.state.overwrite&&!T?ne=Q(ne.line,Math.min(be(S,ne.line).text.length,ne.ch+Oe(L).length)):T&&wi&&wi.lineWise&&wi.text.join(`
`)==L.join(`
`)&&(Z=ne=Q(Z.line,0)));var le={from:Z,to:ne,text:R?R[q%R.length]:L,origin:m||(T?"paste":a.state.cutIncoming>x?"cut":"+input")};Oo(a.doc,le),_t(a,"inputRead",a,le)}d&&!T&&V0(a,d),Ao(a),a.curOp.updateInput<2&&(a.curOp.updateInput=$),a.curOp.typing=!0,a.state.pasteIncoming=a.state.cutIncoming=-1}function _0(a,d){var p=a.clipboardData&&a.clipboardData.getData("Text");if(p)return a.preventDefault(),!d.isReadOnly()&&!d.options.disableInput&&d.hasFocus()&&kn(d,function(){return ep(d,p,0,null,"paste")}),!0}function V0(a,d){if(!(!a.options.electricChars||!a.options.smartIndent))for(var p=a.doc.sel,f=p.ranges.length-1;f>=0;f--){var m=p.ranges[f];if(!(m.head.ch>100||f&&p.ranges[f-1].head.line==m.head.line)){var S=a.getModeAt(m.head),x=!1;if(S.electricChars){for(var T=0;T<S.electricChars.length;T++)if(d.indexOf(S.electricChars.charAt(T))>-1){x=El(a,m.head.line,"smart");break}}else S.electricInput&&S.electricInput.test(be(a.doc,m.head.line).text.slice(0,m.head.ch))&&(x=El(a,m.head.line,"smart"));x&&_t(a,"electricInput",a,m.head.line)}}}function B0(a){for(var d=[],p=[],f=0;f<a.doc.sel.ranges.length;f++){var m=a.doc.sel.ranges[f].head.line,S={anchor:Q(m,0),head:Q(m+1,0)};p.push(S),d.push(a.getRange(S.anchor,S.head))}return{text:d,ranges:p}}function tp(a,d,p,f){a.setAttribute("autocorrect",p?"on":"off"),a.setAttribute("autocapitalize",f?"on":"off"),a.setAttribute("spellcheck",!!d)}function F0(){var a=V("textarea",null,null,"position: absolute; bottom: -1em; padding: 0; width: 1px; height: 1em; min-height: 1em; outline: none"),d=V("div",[a],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");return h?a.style.width="1000px":a.setAttribute("wrap","off"),k&&(a.style.border="1px solid black"),d}function gP(a){var d=a.optionHandlers,p=a.helpers={};a.prototype={constructor:a,focus:function(){Te(this).focus(),this.display.input.focus()},setOption:function(f,m){var S=this.options,x=S[f];S[f]==m&&f!="mode"||(S[f]=m,d.hasOwnProperty(f)&&Vt(this,d[f])(this,m,x),mt(this,"optionChange",this,f))},getOption:function(f){return this.options[f]},getDoc:function(){return this.doc},addKeyMap:function(f,m){this.state.keyMaps[m?"push":"unshift"](Ed(f))},removeKeyMap:function(f){for(var m=this.state.keyMaps,S=0;S<m.length;++S)if(m[S]==f||m[S].name==f)return m.splice(S,1),!0},addOverlay:rn(function(f,m){var S=f.token?f:a.getMode(this.options,f);if(S.startState)throw new Error("Overlays may not be stateful.");Ns(this.state.overlays,{mode:S,modeSpec:f,opaque:m&&m.opaque,priority:m&&m.priority||0},function(x){return x.priority}),this.state.modeGen++,mn(this)}),removeOverlay:rn(function(f){for(var m=this.state.overlays,S=0;S<m.length;++S){var x=m[S].modeSpec;if(x==f||typeof f=="string"&&x.name==f){m.splice(S,1),this.state.modeGen++,mn(this);return}}}),indentLine:rn(function(f,m,S){typeof m!="string"&&typeof m!="number"&&(m==null?m=this.options.smartIndent?"smart":"prev":m=m?"add":"subtract"),te(this.doc,f)&&El(this,f,m,S)}),indentSelection:rn(function(f){for(var m=this.doc.sel.ranges,S=-1,x=0;x<m.length;x++){var T=m[x];if(T.empty())T.head.line>S&&(El(this,T.head.line,f,!0),S=T.head.line,x==this.doc.sel.primIndex&&Ao(this));else{var L=T.from(),R=T.to(),F=Math.max(S,L.line);S=Math.min(this.lastLine(),R.line-(R.ch?0:1))+1;for(var $=F;$<S;++$)El(this,$,f);var q=this.doc.sel.ranges;L.ch==0&&m.length==q.length&&q[x].from().ch>0&&Jf(this.doc,x,new qe(L,q[x].to()),hn)}}}),getTokenAt:function(f,m){return qy(this,f,m)},getLineTokens:function(f,m){return qy(this,Q(f),m,!0)},getTokenTypeAt:function(f){f=Re(this.doc,f);var m=Jy(this,be(this.doc,f.line)),S=0,x=(m.length-1)/2,T=f.ch,L;if(T==0)L=m[2];else for(;;){var R=S+x>>1;if((R?m[R*2-1]:0)>=T)x=R;else if(m[R*2+1]<T)S=R+1;else{L=m[R*2+2];break}}var F=L?L.indexOf("overlay "):-1;return F<0?L:F==0?null:L.slice(0,F-1)},getModeAt:function(f){var m=this.doc.mode;return m.innerMode?a.innerMode(m,this.getTokenAt(f).state).mode:m},getHelper:function(f,m){return this.getHelpers(f,m)[0]},getHelpers:function(f,m){var S=[];if(!p.hasOwnProperty(m))return S;var x=p[m],T=this.getModeAt(f);if(typeof T[m]=="string")x[T[m]]&&S.push(x[T[m]]);else if(T[m])for(var L=0;L<T[m].length;L++){var R=x[T[m][L]];R&&S.push(R)}else T.helperType&&x[T.helperType]?S.push(x[T.helperType]):x[T.name]&&S.push(x[T.name]);for(var F=0;F<x._global.length;F++){var $=x._global[F];$.pred(T,this)&&Ae(S,$.val)==-1&&S.push($.val)}return S},getStateAfter:function(f,m){var S=this.doc;return f=$y(S,f??S.first+S.size-1),Qa(this,f+1,m).state},cursorCoords:function(f,m){var S,x=this.doc.sel.primary();return f==null?S=x.head:typeof f=="object"?S=Re(this.doc,f):S=f?x.from():x.to(),Si(this,S,m||"page")},charCoords:function(f,m){return cd(this,Re(this.doc,f),m||"page")},coordsChar:function(f,m){return f=ES(this,f,m||"page"),Tf(this,f.left,f.top)},lineAtHeight:function(f,m){return f=ES(this,{top:f,left:0},m||"page").top,G(this.doc,f+this.display.viewOffset)},heightAtLine:function(f,m,S){var x=!1,T;if(typeof f=="number"){var L=this.doc.first+this.doc.size-1;f<this.doc.first?f=this.doc.first:f>L&&(f=L,x=!0),T=be(this.doc,f)}else T=f;return ld(this,T,{top:0,left:0},m||"page",S||x).top+(x?this.doc.height-ts(T):0)},defaultTextHeight:function(){return Do(this.display)},defaultCharWidth:function(){return Io(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(f,m,S,x,T){var L=this.display;f=Si(this,Re(this.doc,f));var R=f.bottom,F=f.left;if(m.style.position="absolute",m.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(m),L.sizer.appendChild(m),x=="over")R=f.top;else if(x=="above"||x=="near"){var $=Math.max(L.wrapper.clientHeight,this.doc.height),q=Math.max(L.sizer.clientWidth,L.lineSpace.clientWidth);(x=="above"||f.bottom+m.offsetHeight>$)&&f.top>m.offsetHeight?R=f.top-m.offsetHeight:f.bottom+m.offsetHeight<=$&&(R=f.bottom),F+m.offsetWidth>q&&(F=q-m.offsetWidth)}m.style.top=R+"px",m.style.left=m.style.right="",T=="right"?(F=L.sizer.clientWidth-m.offsetWidth,m.style.right="0px"):(T=="left"?F=0:T=="middle"&&(F=(L.sizer.clientWidth-m.offsetWidth)/2),m.style.left=F+"px"),S&&hI(this,{left:F,top:R,right:F+m.offsetWidth,bottom:R+m.offsetHeight})},triggerOnKeyDown:rn(L0),triggerOnKeyPress:rn(I0),triggerOnKeyUp:D0,triggerOnMouseDown:rn(P0),execCommand:function(f){if(bl.hasOwnProperty(f))return bl[f].call(null,this)},triggerElectric:rn(function(f){V0(this,f)}),findPosH:function(f,m,S,x){var T=1;m<0&&(T=-1,m=-m);for(var L=Re(this.doc,f),R=0;R<m&&(L=np(this.doc,L,T,S,x),!L.hitSide);++R);return L},moveH:rn(function(f,m){var S=this;this.extendSelectionsBy(function(x){return S.display.shift||S.doc.extend||x.empty()?np(S.doc,x.head,f,m,S.options.rtlMoveVisually):f<0?x.from():x.to()},nn)}),deleteH:rn(function(f,m){var S=this.doc.sel,x=this.doc;S.somethingSelected()?x.replaceSelection("",null,"+delete"):Fo(this,function(T){var L=np(x,T.head,f,m,!1);return f<0?{from:L,to:T.head}:{from:T.head,to:L}})}),findPosV:function(f,m,S,x){var T=1,L=x;m<0&&(T=-1,m=-m);for(var R=Re(this.doc,f),F=0;F<m;++F){var $=Si(this,R,"div");if(L==null?L=$.left:$.left=L,R=U0(this,$,T,S),R.hitSide)break}return R},moveV:rn(function(f,m){var S=this,x=this.doc,T=[],L=!this.display.shift&&!x.extend&&x.sel.somethingSelected();if(x.extendSelectionsBy(function(F){if(L)return f<0?F.from():F.to();var $=Si(S,F.head,"div");F.goalColumn!=null&&($.left=F.goalColumn),T.push($.left);var q=U0(S,$,f,m);return m=="page"&&F==x.sel.primary()&&Of(S,cd(S,q,"div").top-$.top),q},nn),T.length)for(var R=0;R<x.sel.ranges.length;R++)x.sel.ranges[R].goalColumn=T[R]}),findWordAt:function(f){var m=this.doc,S=be(m,f.line).text,x=f.ch,T=f.ch;if(S){var L=this.getHelper(f,"wordChars");(f.sticky=="before"||T==S.length)&&x?--x:++T;for(var R=S.charAt(x),F=hi(R,L)?function($){return hi($,L)}:/\s/.test(R)?function($){return/\s/.test($)}:function($){return!/\s/.test($)&&!hi($)};x>0&&F(S.charAt(x-1));)--x;for(;T<S.length&&F(S.charAt(T));)++T}return new qe(Q(f.line,x),Q(f.line,T))},toggleOverwrite:function(f){f!=null&&f==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?Ie(this.display.cursorDiv,"CodeMirror-overwrite"):j(this.display.cursorDiv,"CodeMirror-overwrite"),mt(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==me(nt(this))},isReadOnly:function(){return!!(this.options.readOnly||this.doc.cantEdit)},scrollTo:rn(function(f,m){rl(this,f,m)}),getScrollInfo:function(){var f=this.display.scroller;return{left:f.scrollLeft,top:f.scrollTop,height:f.scrollHeight-Vi(this)-this.display.barHeight,width:f.scrollWidth-Vi(this)-this.display.barWidth,clientHeight:wf(this),clientWidth:Tr(this)}},scrollIntoView:rn(function(f,m){f==null?(f={from:this.doc.sel.primary().head,to:null},m==null&&(m=this.options.cursorScrollMargin)):typeof f=="number"?f={from:Q(f,0),to:null}:f.from==null&&(f={from:f,to:null}),f.to||(f.to=f.from),f.margin=m||0,f.from.line!=null?fI(this,f):NS(this,f.from,f.to,f.margin)}),setSize:rn(function(f,m){var S=this,x=function(L){return typeof L=="number"||/^\d+$/.test(String(L))?L+"px":L};f!=null&&(this.display.wrapper.style.width=x(f)),m!=null&&(this.display.wrapper.style.height=x(m)),this.options.lineWrapping&&wS(this);var T=this.display.viewFrom;this.doc.iter(T,this.display.viewTo,function(L){if(L.widgets){for(var R=0;R<L.widgets.length;R++)if(L.widgets[R].noHScroll){Ws(S,T,"widget");break}}++T}),this.curOp.forceUpdate=!0,mt(this,"refresh",this)}),operation:function(f){return kn(this,f)},startOperation:function(){return Ar(this)},endOperation:function(){return Rr(this)},refresh:rn(function(){var f=this.display.cachedTextHeight;mn(this),this.curOp.forceUpdate=!0,il(this),rl(this,this.doc.scrollLeft,this.doc.scrollTop),Bf(this.display),(f==null||Math.abs(f-Do(this.display))>.5||this.options.lineWrapping)&&If(this),mt(this,"refresh",this)}),swapDoc:rn(function(f){var m=this.doc;return m.cm=null,this.state.selectingText&&this.state.selectingText(),jS(this,f),il(this),this.display.input.reset(),rl(this,f.scrollLeft,f.scrollTop),this.curOp.forceScroll=!0,_t(this,"swapDoc",this,m),m}),phrase:function(f){var m=this.options.phrases;return m&&Object.prototype.hasOwnProperty.call(m,f)?m[f]:f},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},fi(a),a.registerHelper=function(f,m,S){p.hasOwnProperty(f)||(p[f]=a[f]={_global:[]}),p[f][m]=S},a.registerGlobalHelper=function(f,m,S,x){a.registerHelper(f,m,x),p[f]._global.push({pred:S,val:x})}}function np(a,d,p,f,m){var S=d,x=p,T=be(a,d.line),L=m&&a.direction=="rtl"?-p:p;function R(){var pe=d.line+L;return pe<a.first||pe>=a.first+a.size?!1:(d=new Q(pe,d.ch,d.sticky),T=be(a,pe))}function F(pe){var de;if(f=="codepoint"){var ye=T.text.charCodeAt(d.ch+(p>0?0:-1));if(isNaN(ye))de=null;else{var Le=p>0?ye>=55296&&ye<56320:ye>=56320&&ye<57343;de=new Q(d.line,Math.max(0,Math.min(T.text.length,d.ch+p*(Le?2:1))),-p)}}else m?de=KI(a.cm,T,d,p):de=Yf(T,d,p);if(de==null)if(!pe&&R())d=qf(m,a.cm,T,d.line,L);else return!1;else d=de;return!0}if(f=="char"||f=="codepoint")F();else if(f=="column")F(!0);else if(f=="word"||f=="group")for(var $=null,q=f=="group",Y=a.cm&&a.cm.getHelper(d,"wordChars"),Z=!0;!(p<0&&!F(!Z));Z=!1){var ne=T.text.charAt(d.ch)||`
`,le=hi(ne,Y)?"w":q&&ne==`
`?"n":!q||/\s/.test(ne)?null:"p";if(q&&!Z&&!le&&(le="s"),$&&$!=le){p<0&&(p=1,F(),d.sticky="after");break}if(le&&($=le),p>0&&!F(!Z))break}var ce=wd(a,d,S,x,!0);return Ye(S,ce)&&(ce.hitSide=!0),ce}function U0(a,d,p,f){var m=a.doc,S=d.left,x;if(f=="page"){var T=Math.min(a.display.wrapper.clientHeight,Te(a).innerHeight||m(a).documentElement.clientHeight),L=Math.max(T-.5*Do(a.display),3);x=(p>0?d.bottom:d.top)+p*L}else f=="line"&&(x=p>0?d.bottom+3:d.top-3);for(var R;R=Tf(a,S,x),!!R.outside;){if(p<0?x<=0:x>=m.height){R.hitSide=!0;break}x+=p*5}return R}var Qe=function(a){this.cm=a,this.lastAnchorNode=this.lastAnchorOffset=this.lastFocusNode=this.lastFocusOffset=null,this.polling=new ot,this.composing=null,this.gracePeriod=!1,this.readDOMTimeout=null};Qe.prototype.init=function(a){var d=this,p=this,f=p.cm,m=p.div=a.lineDiv;m.contentEditable=!0,tp(m,f.options.spellcheck,f.options.autocorrect,f.options.autocapitalize);function S(T){for(var L=T.target;L;L=L.parentNode){if(L==m)return!0;if(/\bCodeMirror-(?:line)?widget\b/.test(L.className))break}return!1}ke(m,"paste",function(T){!S(T)||vt(f,T)||_0(T,f)||u<=11&&setTimeout(Vt(f,function(){return d.updateFromDOM()}),20)}),ke(m,"compositionstart",function(T){d.composing={data:T.data,done:!1}}),ke(m,"compositionupdate",function(T){d.composing||(d.composing={data:T.data,done:!1})}),ke(m,"compositionend",function(T){d.composing&&(T.data!=d.composing.data&&d.readFromDOMSoon(),d.composing.done=!0)}),ke(m,"touchstart",function(){return p.forceCompositionEnd()}),ke(m,"input",function(){d.composing||d.readFromDOMSoon()});function x(T){if(!(!S(T)||vt(f,T))){if(f.somethingSelected())Ld({lineWise:!1,text:f.getSelections()}),T.type=="cut"&&f.replaceSelection("",null,"cut");else if(f.options.lineWiseCopyCut){var L=B0(f);Ld({lineWise:!0,text:L.text}),T.type=="cut"&&f.operation(function(){f.setSelections(L.ranges,0,hn),f.replaceSelection("",null,"cut")})}else return;if(T.clipboardData){T.clipboardData.clearData();var R=wi.text.join(`
`);if(T.clipboardData.setData("Text",R),T.clipboardData.getData("Text")==R){T.preventDefault();return}}var F=F0(),$=F.firstChild;tp($),f.display.lineSpace.insertBefore(F,f.display.lineSpace.firstChild),$.value=wi.text.join(`
`);var q=me(Ge(m));tt($),setTimeout(function(){f.display.lineSpace.removeChild(F),q.focus(),q==m&&p.showPrimarySelection()},50)}}ke(m,"copy",x),ke(m,"cut",x)},Qe.prototype.screenReaderLabelChanged=function(a){a?this.div.setAttribute("aria-label",a):this.div.removeAttribute("aria-label")},Qe.prototype.prepareSelection=function(){var a=PS(this.cm,!1);return a.focus=me(Ge(this.div))==this.div,a},Qe.prototype.showSelection=function(a,d){!a||!this.cm.display.view.length||((a.focus||d)&&this.showPrimarySelection(),this.showMultipleSelections(a))},Qe.prototype.getSelection=function(){return this.cm.display.wrapper.ownerDocument.getSelection()},Qe.prototype.showPrimarySelection=function(){var a=this.getSelection(),d=this.cm,p=d.doc.sel.primary(),f=p.from(),m=p.to();if(d.display.viewTo==d.display.viewFrom||f.line>=d.display.viewTo||m.line<d.display.viewFrom){a.removeAllRanges();return}var S=Dd(d,a.anchorNode,a.anchorOffset),x=Dd(d,a.focusNode,a.focusOffset);if(!(S&&!S.bad&&x&&!x.bad&&he(Eo(S,x),f)==0&&he(gn(S,x),m)==0)){var T=d.display.view,L=f.line>=d.display.viewFrom&&z0(d,f)||{node:T[0].measure.map[2],offset:0},R=m.line<d.display.viewTo&&z0(d,m);if(!R){var F=T[T.length-1].measure,$=F.maps?F.maps[F.maps.length-1]:F.map;R={node:$[$.length-1],offset:$[$.length-2]-$[$.length-3]}}if(!L||!R){a.removeAllRanges();return}var q=a.rangeCount&&a.getRangeAt(0),Y;try{Y=se(L.node,L.offset,R.offset,R.node)}catch{}Y&&(!s&&d.state.focused?(a.collapse(L.node,L.offset),Y.collapsed||(a.removeAllRanges(),a.addRange(Y))):(a.removeAllRanges(),a.addRange(Y)),q&&a.anchorNode==null?a.addRange(q):s&&this.startGracePeriod()),this.rememberSelection()}},Qe.prototype.startGracePeriod=function(){var a=this;clearTimeout(this.gracePeriod),this.gracePeriod=setTimeout(function(){a.gracePeriod=!1,a.selectionChanged()&&a.cm.operation(function(){return a.cm.curOp.selectionChanged=!0})},20)},Qe.prototype.showMultipleSelections=function(a){H(this.cm.display.cursorDiv,a.cursors),H(this.cm.display.selectionDiv,a.selection)},Qe.prototype.rememberSelection=function(){var a=this.getSelection();this.lastAnchorNode=a.anchorNode,this.lastAnchorOffset=a.anchorOffset,this.lastFocusNode=a.focusNode,this.lastFocusOffset=a.focusOffset},Qe.prototype.selectionInEditor=function(){var a=this.getSelection();if(!a.rangeCount)return!1;var d=a.getRangeAt(0).commonAncestorContainer;return ve(this.div,d)},Qe.prototype.focus=function(){this.cm.options.readOnly!="nocursor"&&((!this.selectionInEditor()||me(Ge(this.div))!=this.div)&&this.showSelection(this.prepareSelection(),!0),this.div.focus())},Qe.prototype.blur=function(){this.div.blur()},Qe.prototype.getField=function(){return this.div},Qe.prototype.supportsTouch=function(){return!0},Qe.prototype.receivedFocus=function(){var a=this,d=this;this.selectionInEditor()?setTimeout(function(){return a.pollSelection()},20):kn(this.cm,function(){return d.cm.curOp.selectionChanged=!0});function p(){d.cm.state.focused&&(d.pollSelection(),d.polling.set(d.cm.options.pollInterval,p))}this.polling.set(this.cm.options.pollInterval,p)},Qe.prototype.selectionChanged=function(){var a=this.getSelection();return a.anchorNode!=this.lastAnchorNode||a.anchorOffset!=this.lastAnchorOffset||a.focusNode!=this.lastFocusNode||a.focusOffset!=this.lastFocusOffset},Qe.prototype.pollSelection=function(){if(!(this.readDOMTimeout!=null||this.gracePeriod||!this.selectionChanged())){var a=this.getSelection(),d=this.cm;if(D&&v&&this.cm.display.gutterSpecs.length&&mP(a.anchorNode)){this.cm.triggerOnKeyDown({type:"keydown",keyCode:8,preventDefault:Math.abs}),this.blur(),this.focus();return}if(!this.composing){this.rememberSelection();var p=Dd(d,a.anchorNode,a.anchorOffset),f=Dd(d,a.focusNode,a.focusOffset);p&&f&&kn(d,function(){Kt(d.doc,Js(p,f),hn),(p.bad||f.bad)&&(d.curOp.selectionChanged=!0)})}}},Qe.prototype.pollContent=function(){this.readDOMTimeout!=null&&(clearTimeout(this.readDOMTimeout),this.readDOMTimeout=null);var a=this.cm,d=a.display,p=a.doc.sel.primary(),f=p.from(),m=p.to();if(f.ch==0&&f.line>a.firstLine()&&(f=Q(f.line-1,be(a.doc,f.line-1).length)),m.ch==be(a.doc,m.line).text.length&&m.line<a.lastLine()&&(m=Q(m.line+1,0)),f.line<d.viewFrom||m.line>d.viewTo-1)return!1;var S,x,T;f.line==d.viewFrom||(S=Dr(a,f.line))==0?(x=M(d.view[0].line),T=d.view[0].node):(x=M(d.view[S].line),T=d.view[S-1].node.nextSibling);var L=Dr(a,m.line),R,F;if(L==d.view.length-1?(R=d.viewTo-1,F=d.lineDiv.lastChild):(R=M(d.view[L+1].line)-1,F=d.view[L+1].node.previousSibling),!T)return!1;for(var $=a.doc.splitLines(vP(a,T,F,x,R)),q=Zi(a.doc,Q(x,0),Q(R,be(a.doc,R).text.length));$.length>1&&q.length>1;)if(Oe($)==Oe(q))$.pop(),q.pop(),R--;else if($[0]==q[0])$.shift(),q.shift(),x++;else break;for(var Y=0,Z=0,ne=$[0],le=q[0],ce=Math.min(ne.length,le.length);Y<ce&&ne.charCodeAt(Y)==le.charCodeAt(Y);)++Y;for(var pe=Oe($),de=Oe(q),ye=Math.min(pe.length-($.length==1?Y:0),de.length-(q.length==1?Y:0));Z<ye&&pe.charCodeAt(pe.length-Z-1)==de.charCodeAt(de.length-Z-1);)++Z;if($.length==1&&q.length==1&&x==f.line)for(;Y&&Y>f.ch&&pe.charCodeAt(pe.length-Z-1)==de.charCodeAt(de.length-Z-1);)Y--,Z++;$[$.length-1]=pe.slice(0,pe.length-Z).replace(/^\u200b+/,""),$[0]=$[0].slice(Y).replace(/\u200b+$/,"");var Le=Q(x,Y),xe=Q(R,q.length?Oe(q).length-Z:0);if($.length>1||$[0]||he(Le,xe))return _o(a.doc,$,Le,xe,"+input"),!0},Qe.prototype.ensurePolled=function(){this.forceCompositionEnd()},Qe.prototype.reset=function(){this.forceCompositionEnd()},Qe.prototype.forceCompositionEnd=function(){this.composing&&(clearTimeout(this.readDOMTimeout),this.composing=null,this.updateFromDOM(),this.div.blur(),this.div.focus())},Qe.prototype.readFromDOMSoon=function(){var a=this;this.readDOMTimeout==null&&(this.readDOMTimeout=setTimeout(function(){if(a.readDOMTimeout=null,a.composing)if(a.composing.done)a.composing=null;else return;a.updateFromDOM()},80))},Qe.prototype.updateFromDOM=function(){var a=this;(this.cm.isReadOnly()||!this.pollContent())&&kn(this.cm,function(){return mn(a.cm)})},Qe.prototype.setUneditable=function(a){a.contentEditable="false"},Qe.prototype.onKeyPress=function(a){a.charCode==0||this.composing||(a.preventDefault(),this.cm.isReadOnly()||Vt(this.cm,ep)(this.cm,String.fromCharCode(a.charCode==null?a.keyCode:a.charCode),0))},Qe.prototype.readOnlyChanged=function(a){this.div.contentEditable=String(a!="nocursor")},Qe.prototype.onContextMenu=function(){},Qe.prototype.resetPosition=function(){},Qe.prototype.needsContentAttribute=!0;function z0(a,d){var p=Cf(a,d.line);if(!p||p.hidden)return null;var f=be(a.doc,d.line),m=mS(p,f,d.line),S=Be(f,a.doc.direction),x="left";if(S){var T=Bs(S,d.ch);x=T%2?"right":"left"}var L=SS(m.map,d.ch,x);return L.offset=L.collapse=="right"?L.end:L.start,L}function mP(a){for(var d=a;d;d=d.parentNode)if(/CodeMirror-gutter-wrapper/.test(d.className))return!0;return!1}function zo(a,d){return d&&(a.bad=!0),a}function vP(a,d,p,f,m){var S="",x=!1,T=a.doc.lineSeparator(),L=!1;function R(Y){return function(Z){return Z.id==Y}}function F(){x&&(S+=T,L&&(S+=T),x=L=!1)}function $(Y){Y&&(F(),S+=Y)}function q(Y){if(Y.nodeType==1){var Z=Y.getAttribute("cm-text");if(Z){$(Z);return}var ne=Y.getAttribute("cm-marker"),le;if(ne){var ce=a.findMarks(Q(f,0),Q(m+1,0),R(+ne));ce.length&&(le=ce[0].find(0))&&$(Zi(a.doc,le.from,le.to).join(T));return}if(Y.getAttribute("contenteditable")=="false")return;var pe=/^(pre|div|p|li|table|br)$/i.test(Y.nodeName);if(!/^br$/i.test(Y.nodeName)&&Y.textContent.length==0)return;pe&&F();for(var de=0;de<Y.childNodes.length;de++)q(Y.childNodes[de]);/^(pre|p)$/i.test(Y.nodeName)&&(L=!0),pe&&(x=!0)}else Y.nodeType==3&&$(Y.nodeValue.replace(/\u200b/g,"").replace(/\u00a0/g," "))}for(;q(d),d!=p;)d=d.nextSibling,L=!1;return S}function Dd(a,d,p){var f;if(d==a.display.lineDiv){if(f=a.display.lineDiv.childNodes[p],!f)return zo(a.clipPos(Q(a.display.viewTo-1)),!0);d=null,p=0}else for(f=d;;f=f.parentNode){if(!f||f==a.display.lineDiv)return null;if(f.parentNode&&f.parentNode==a.display.lineDiv)break}for(var m=0;m<a.display.view.length;m++){var S=a.display.view[m];if(S.node==f)return yP(S,d,p)}}function yP(a,d,p){var f=a.text.firstChild,m=!1;if(!d||!ve(f,d))return zo(Q(M(a.line),0),!0);if(d==f&&(m=!0,d=f.childNodes[p],p=0,!d)){var S=a.rest?Oe(a.rest):a.line;return zo(Q(M(S),S.text.length),m)}var x=d.nodeType==3?d:null,T=d;for(!x&&d.childNodes.length==1&&d.firstChild.nodeType==3&&(x=d.firstChild,p&&(p=x.nodeValue.length));T.parentNode!=f;)T=T.parentNode;var L=a.measure,R=L.maps;function F(le,ce,pe){for(var de=-1;de<(R?R.length:0);de++)for(var ye=de<0?L.map:R[de],Le=0;Le<ye.length;Le+=3){var xe=ye[Le+2];if(xe==le||xe==ce){var Me=M(de<0?a.line:a.rest[de]),it=ye[Le]+pe;return(pe<0||xe!=le)&&(it=ye[Le+(pe?1:0)]),Q(Me,it)}}}var $=F(x,T,p);if($)return zo($,m);for(var q=T.nextSibling,Y=x?x.nodeValue.length-p:0;q;q=q.nextSibling){if($=F(q,q.firstChild,0),$)return zo(Q($.line,$.ch-Y),m);Y+=q.textContent.length}for(var Z=T.previousSibling,ne=p;Z;Z=Z.previousSibling){if($=F(Z,Z.firstChild,-1),$)return zo(Q($.line,$.ch+ne),m);ne+=Z.textContent.length}}var Ct=function(a){this.cm=a,this.prevInput="",this.pollingFast=!1,this.polling=new ot,this.hasSelection=!1,this.composing=null,this.resetting=!1};Ct.prototype.init=function(a){var d=this,p=this,f=this.cm;this.createField(a);var m=this.textarea;a.wrapper.insertBefore(this.wrapper,a.wrapper.firstChild),k&&(m.style.width="0px"),ke(m,"input",function(){c&&u>=9&&d.hasSelection&&(d.hasSelection=null),p.poll()}),ke(m,"paste",function(x){vt(f,x)||_0(x,f)||(f.state.pasteIncoming=+new Date,p.fastPoll())});function S(x){if(!vt(f,x)){if(f.somethingSelected())Ld({lineWise:!1,text:f.getSelections()});else if(f.options.lineWiseCopyCut){var T=B0(f);Ld({lineWise:!0,text:T.text}),x.type=="cut"?f.setSelections(T.ranges,null,hn):(p.prevInput="",m.value=T.text.join(`
`),tt(m))}else return;x.type=="cut"&&(f.state.cutIncoming=+new Date)}}ke(m,"cut",S),ke(m,"copy",S),ke(a.scroller,"paste",function(x){if(!(ns(a,x)||vt(f,x))){if(!m.dispatchEvent){f.state.pasteIncoming=+new Date,p.focus();return}var T=new Event("paste");T.clipboardData=x.clipboardData,m.dispatchEvent(T)}}),ke(a.lineSpace,"selectstart",function(x){ns(a,x)||qt(x)}),ke(m,"compositionstart",function(){var x=f.getCursor("from");p.composing&&p.composing.range.clear(),p.composing={start:x,range:f.markText(x,f.getCursor("to"),{className:"CodeMirror-composing"})}}),ke(m,"compositionend",function(){p.composing&&(p.poll(),p.composing.range.clear(),p.composing=null)})},Ct.prototype.createField=function(a){this.wrapper=F0(),this.textarea=this.wrapper.firstChild;var d=this.cm.options;tp(this.textarea,d.spellcheck,d.autocorrect,d.autocapitalize)},Ct.prototype.screenReaderLabelChanged=function(a){a?this.textarea.setAttribute("aria-label",a):this.textarea.removeAttribute("aria-label")},Ct.prototype.prepareSelection=function(){var a=this.cm,d=a.display,p=a.doc,f=PS(a);if(a.options.moveInputWithCursor){var m=Si(a,p.sel.primary().head,"div"),S=d.wrapper.getBoundingClientRect(),x=d.lineDiv.getBoundingClientRect();f.teTop=Math.max(0,Math.min(d.wrapper.clientHeight-10,m.top+x.top-S.top)),f.teLeft=Math.max(0,Math.min(d.wrapper.clientWidth-10,m.left+x.left-S.left))}return f},Ct.prototype.showSelection=function(a){var d=this.cm,p=d.display;H(p.cursorDiv,a.cursors),H(p.selectionDiv,a.selection),a.teTop!=null&&(this.wrapper.style.top=a.teTop+"px",this.wrapper.style.left=a.teLeft+"px")},Ct.prototype.reset=function(a){if(!(this.contextMenuPending||this.composing&&a)){var d=this.cm;if(this.resetting=!0,d.somethingSelected()){this.prevInput="";var p=d.getSelection();this.textarea.value=p,d.state.focused&&tt(this.textarea),c&&u>=9&&(this.hasSelection=p)}else a||(this.prevInput=this.textarea.value="",c&&u>=9&&(this.hasSelection=null));this.resetting=!1}},Ct.prototype.getField=function(){return this.textarea},Ct.prototype.supportsTouch=function(){return!1},Ct.prototype.focus=function(){if(this.cm.options.readOnly!="nocursor"&&(!A||me(Ge(this.textarea))!=this.textarea))try{this.textarea.focus()}catch{}},Ct.prototype.blur=function(){this.textarea.blur()},Ct.prototype.resetPosition=function(){this.wrapper.style.top=this.wrapper.style.left=0},Ct.prototype.receivedFocus=function(){this.slowPoll()},Ct.prototype.slowPoll=function(){var a=this;this.pollingFast||this.polling.set(this.cm.options.pollInterval,function(){a.poll(),a.cm.state.focused&&a.slowPoll()})},Ct.prototype.fastPoll=function(){var a=!1,d=this;d.pollingFast=!0;function p(){var f=d.poll();!f&&!a?(a=!0,d.polling.set(60,p)):(d.pollingFast=!1,d.slowPoll())}d.polling.set(20,p)},Ct.prototype.poll=function(){var a=this,d=this.cm,p=this.textarea,f=this.prevInput;if(this.contextMenuPending||this.resetting||!d.state.focused||zs(p)&&!f&&!this.composing||d.isReadOnly()||d.options.disableInput||d.state.keySeq)return!1;var m=p.value;if(m==f&&!d.somethingSelected())return!1;if(c&&u>=9&&this.hasSelection===m||N&&/[\uf700-\uf7ff]/.test(m))return d.display.input.reset(),!1;if(d.doc.sel==d.display.selForContextMenu){var S=m.charCodeAt(0);if(S==8203&&!f&&(f="​"),S==8666)return this.reset(),this.cm.execCommand("undo")}for(var x=0,T=Math.min(f.length,m.length);x<T&&f.charCodeAt(x)==m.charCodeAt(x);)++x;return kn(d,function(){ep(d,m.slice(x),f.length-x,null,a.composing?"*compose":null),m.length>1e3||m.indexOf(`
`)>-1?p.value=a.prevInput="":a.prevInput=m,a.composing&&(a.composing.range.clear(),a.composing.range=d.markText(a.composing.start,d.getCursor("to"),{className:"CodeMirror-composing"}))}),!0},Ct.prototype.ensurePolled=function(){this.pollingFast&&this.poll()&&(this.pollingFast=!1)},Ct.prototype.onKeyPress=function(){c&&u>=9&&(this.hasSelection=null),this.fastPoll()},Ct.prototype.onContextMenu=function(a){var d=this,p=d.cm,f=p.display,m=d.textarea;d.contextMenuPending&&d.contextMenuPending();var S=Lr(p,a),x=f.scroller.scrollTop;if(!S||b)return;var T=p.options.resetSelectionOnContextMenu;T&&p.doc.sel.contains(S)==-1&&Vt(p,Kt)(p.doc,Js(S),hn);var L=m.style.cssText,R=d.wrapper.style.cssText,F=d.wrapper.offsetParent.getBoundingClientRect();d.wrapper.style.cssText="position: static",m.style.cssText=`position: absolute; width: 30px; height: 30px;
      top: `+(a.clientY-F.top-5)+"px; left: "+(a.clientX-F.left-5)+`px;
      z-index: 1000; background: `+(c?"rgba(255, 255, 255, .05)":"transparent")+`;
      outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);`;var $;h&&($=m.ownerDocument.defaultView.scrollY),f.input.focus(),h&&m.ownerDocument.defaultView.scrollTo(null,$),f.input.reset(),p.somethingSelected()||(m.value=d.prevInput=" "),d.contextMenuPending=Y,f.selForContextMenu=p.doc.sel,clearTimeout(f.detectingSelectAll);function q(){if(m.selectionStart!=null){var ne=p.somethingSelected(),le="​"+(ne?m.value:"");m.value="⇚",m.value=le,d.prevInput=ne?"":"​",m.selectionStart=1,m.selectionEnd=le.length,f.selForContextMenu=p.doc.sel}}function Y(){if(d.contextMenuPending==Y&&(d.contextMenuPending=!1,d.wrapper.style.cssText=R,m.style.cssText=L,c&&u<9&&f.scrollbars.setScrollTop(f.scroller.scrollTop=x),m.selectionStart!=null)){(!c||c&&u<9)&&q();var ne=0,le=function(){f.selForContextMenu==p.doc.sel&&m.selectionStart==0&&m.selectionEnd>0&&d.prevInput=="​"?Vt(p,o0)(p):ne++<10?f.detectingSelectAll=setTimeout(le,500):(f.selForContextMenu=null,f.input.reset())};f.detectingSelectAll=setTimeout(le,200)}}if(c&&u>=9&&q(),W){Fs(a);var Z=function(){Yt(window,"mouseup",Z),setTimeout(Y,20)};ke(window,"mouseup",Z)}else setTimeout(Y,50)},Ct.prototype.readOnlyChanged=function(a){a||this.reset(),this.textarea.disabled=a=="nocursor",this.textarea.readOnly=!!a},Ct.prototype.setUneditable=function(){},Ct.prototype.needsContentAttribute=!1;function SP(a,d){if(d=d?ge(d):{},d.value=a.value,!d.tabindex&&a.tabIndex&&(d.tabindex=a.tabIndex),!d.placeholder&&a.placeholder&&(d.placeholder=a.placeholder),d.autofocus==null){var p=me(Ge(a));d.autofocus=p==a||a.getAttribute("autofocus")!=null&&p==document.body}function f(){a.value=T.getValue()}var m;if(a.form&&(ke(a.form,"submit",f),!d.leaveSubmitMethodAlone)){var S=a.form;m=S.submit;try{var x=S.submit=function(){f(),S.submit=m,S.submit(),S.submit=x}}catch{}}d.finishInit=function(L){L.save=f,L.getTextArea=function(){return a},L.toTextArea=function(){L.toTextArea=isNaN,f(),a.parentNode.removeChild(L.getWrapperElement()),a.style.display="",a.form&&(Yt(a.form,"submit",f),!d.leaveSubmitMethodAlone&&typeof a.form.submit=="function"&&(a.form.submit=m))}},a.style.display="none";var T=lt(function(L){return a.parentNode.insertBefore(L,a.nextSibling)},d);return T}function bP(a){a.off=Yt,a.on=ke,a.wheelEventPixels=LI,a.Doc=vn,a.splitLines=Gn,a.countColumn=Ce,a.findColumn=sn,a.isWordChar=Cr,a.Pass=Ri,a.signal=mt,a.Line=To,a.changeEnd=js,a.scrollbarModel=_S,a.Pos=Q,a.cmpPos=he,a.modes=So,a.mimeModes=mi,a.resolveMode=bo,a.getMode=wo,a.modeExtensions=Gs,a.extendMode=Co,a.copyState=Oi,a.startState=xo,a.innerMode=Ka,a.commands=bl,a.keyMap=ss,a.keyName=C0,a.isModifierKey=b0,a.lookupKey=Bo,a.normalizeKeyMap=qI,a.StringStream=yt,a.SharedTextMarker=vl,a.TextMarker=qs,a.LineWidget=ml,a.e_preventDefault=qt,a.e_stopPropagation=vo,a.e_stop=Fs,a.addClass=Ie,a.contains=ve,a.rmClass=j,a.keyNames=Ks}uP(lt),gP(lt);var wP="iter insert remove copy getEditor constructor".split(" ");for(var Id in vn.prototype)vn.prototype.hasOwnProperty(Id)&&Ae(wP,Id)<0&&(lt.prototype[Id]=function(a){return function(){return a.apply(this.doc,arguments)}}(vn.prototype[Id]));return fi(vn),lt.inputStyles={textarea:Ct,contenteditable:Qe},lt.defineMode=function(a){!lt.defaults.mode&&a!="null"&&(lt.defaults.mode=a),vi.apply(this,arguments)},lt.defineMIME=Er,lt.defineMode("null",function(){return{token:function(a){return a.skipToEnd()}}}),lt.defineMIME("text/plain","null"),lt.defineExtension=function(a,d){lt.prototype[a]=d},lt.defineDocExtension=function(a,d){vn.prototype[a]=d},lt.fromTextArea=SP,bP(lt),lt.version="5.65.16",lt})}(Np)),Np.exports}(function(i,e){(function(t){t($a())})(function(t){var n="CodeMirror-lint-markers",s="CodeMirror-lint-line-";function r(P,O,_){var W=document.createElement("div");W.className="CodeMirror-lint-tooltip cm-s-"+P.options.theme,W.appendChild(_.cloneNode(!0)),P.state.lint.options.selfContain?P.getWrapperElement().appendChild(W):document.body.appendChild(W);function U(j){if(!W.parentNode)return t.off(document,"mousemove",U);var B=Math.max(0,j.clientY-W.offsetHeight-5),H=Math.max(0,Math.min(j.clientX+5,W.ownerDocument.defaultView.innerWidth-W.offsetWidth));W.style.top=B+"px",W.style.left=H+"px"}return t.on(document,"mousemove",U),U(O),W.style.opacity!=null&&(W.style.opacity=1),W}function o(P){P.parentNode&&P.parentNode.removeChild(P)}function l(P){P.parentNode&&(P.style.opacity==null&&o(P),P.style.opacity=0,setTimeout(function(){o(P)},600))}function c(P,O,_,W){var U=r(P,O,_);function j(){t.off(W,"mouseout",j),U&&(l(U),U=null)}var B=setInterval(function(){if(U)for(var H=W;;H=H.parentNode){if(H&&H.nodeType==11&&(H=H.host),H==document.body)return;if(!H){j();break}}if(!U)return clearInterval(B)},400);t.on(W,"mouseout",j)}function u(P,O,_){this.marked=[],O instanceof Function&&(O={getAnnotations:O}),(!O||O===!0)&&(O={}),this.options={},this.linterOptions=O.options||{};for(var W in h)this.options[W]=h[W];for(var W in O)h.hasOwnProperty(W)?O[W]!=null&&(this.options[W]=O[W]):O.options||(this.linterOptions[W]=O[W]);this.timeout=null,this.hasGutter=_,this.onMouseOver=function(U){I(P,U)},this.waitingFor=0}var h={highlightLines:!1,tooltips:!0,delay:500,lintOnChange:!0,getAnnotations:null,async:!1,selfContain:null,formatAnnotation:null,onUpdateLinting:null};function g(P){var O=P.state.lint;O.hasGutter&&P.clearGutter(n),O.options.highlightLines&&v(P);for(var _=0;_<O.marked.length;++_)O.marked[_].clear();O.marked.length=0}function v(P){P.eachLine(function(O){var _=O.wrapClass&&/\bCodeMirror-lint-line-\w+\b/.exec(O.wrapClass);_&&P.removeLineClass(O,"wrap",_[0])})}function y(P,O,_,W,U){var j=document.createElement("div"),B=j;return j.className="CodeMirror-lint-marker CodeMirror-lint-marker-"+_,W&&(B=j.appendChild(document.createElement("div")),B.className="CodeMirror-lint-marker CodeMirror-lint-marker-multiple"),U!=!1&&t.on(B,"mouseover",function(H){c(P,H,O,B)}),j}function b(P,O){return P=="error"?P:O}function w(P){for(var O=[],_=0;_<P.length;++_){var W=P[_],U=W.from.line;(O[U]||(O[U]=[])).push(W)}return O}function C(P){var O=P.severity;O||(O="error");var _=document.createElement("div");return _.className="CodeMirror-lint-message CodeMirror-lint-message-"+O,typeof P.messageHTML<"u"?_.innerHTML=P.messageHTML:_.appendChild(document.createTextNode(P.message)),_}function E(P,O){var _=P.state.lint,W=++_.waitingFor;function U(){W=-1,P.off("change",U)}P.on("change",U),O(P.getValue(),function(j,B){P.off("change",U),_.waitingFor==W&&(B&&j instanceof t&&(j=B),P.operation(function(){D(P,j)}))},_.linterOptions,P)}function k(P){var O=P.state.lint;if(O){var _=O.options,W=_.getAnnotations||P.getHelper(t.Pos(0,0),"lint");if(W)if(_.async||W.async)E(P,W);else{var U=W(P.getValue(),O.linterOptions,P);if(!U)return;U.then?U.then(function(j){P.operation(function(){D(P,j)})}):P.operation(function(){D(P,U)})}}}function D(P,O){var _=P.state.lint;if(_){var W=_.options;g(P);for(var U=w(O),j=0;j<U.length;++j){var B=U[j];if(B){for(var H=null,V=_.hasGutter&&document.createDocumentFragment(),re=0;re<B.length;++re){var se=B[re],ve=se.severity;ve||(ve="error"),H=b(H,ve),W.formatAnnotation&&(se=W.formatAnnotation(se)),_.hasGutter&&V.appendChild(C(se)),se.to&&_.marked.push(P.markText(se.from,se.to,{className:"CodeMirror-lint-mark CodeMirror-lint-mark-"+ve,__annotation:se}))}_.hasGutter&&P.setGutterMarker(j,n,y(P,V,H,B.length>1,W.tooltips)),W.highlightLines&&P.addLineClass(j,"wrap",s+H)}}W.onUpdateLinting&&W.onUpdateLinting(O,U,P)}}function A(P){var O=P.state.lint;O&&(clearTimeout(O.timeout),O.timeout=setTimeout(function(){k(P)},O.options.delay))}function N(P,O,_){for(var W=_.target||_.srcElement,U=document.createDocumentFragment(),j=0;j<O.length;j++){var B=O[j];U.appendChild(C(B))}c(P,_,U,W)}function I(P,O){var _=O.target||O.srcElement;if(/\bCodeMirror-lint-mark-/.test(_.className)){for(var W=_.getBoundingClientRect(),U=(W.left+W.right)/2,j=(W.top+W.bottom)/2,B=P.findMarksAt(P.coordsChar({left:U,top:j},"client")),H=[],V=0;V<B.length;++V){var re=B[V].__annotation;re&&H.push(re)}H.length&&N(P,H,O)}}t.defineOption("lint",!1,function(P,O,_){if(_&&_!=t.Init&&(g(P),P.state.lint.options.lintOnChange!==!1&&P.off("change",A),t.off(P.getWrapperElement(),"mouseover",P.state.lint.onMouseOver),clearTimeout(P.state.lint.timeout),delete P.state.lint),O){for(var W=P.getOption("gutters"),U=!1,j=0;j<W.length;++j)W[j]==n&&(U=!0);var B=P.state.lint=new u(P,O,U);B.options.lintOnChange&&P.on("change",A),B.options.tooltips!=!1&&B.options.tooltips!="gutter"&&t.on(P.getWrapperElement(),"mouseover",B.onMouseOver),k(P)}}),t.defineExtension("performLint",function(){k(this)})})})();var kF=$a();const or=Vk(kF);var LF=function(i){i.defineMode("glsl",function(r,o){var l=r.indentUnit,c=o.keywords||e(t),u=o.builtins||e(n),h=o.blockKeywords||e("case do else for if switch while struct"),g=o.atoms||e("null"),v=o.hooks||{},y=o.multiLineStrings,b=/[+\-*&%=<>!?|\/]/,w;function C(I,P){var O=I.next();if(v[O]){var _=v[O](I,P);if(_!==!1)return _}if(O=='"'||O=="'")return P.tokenize=E(O),P.tokenize(I,P);if(/[\[\]{}\(\),;\:\.]/.test(O))return w=O,"bracket";if(/\d/.test(O))return I.eatWhile(/[\w\.]/),"number";if(O=="/"){if(I.eat("*"))return P.tokenize=k,k(I,P);if(I.eat("/"))return I.skipToEnd(),"comment"}if(O=="#")return I.eatWhile(/[\S]+/),I.eatWhile(/[\s]+/),I.eatWhile(/[\S]+/),I.eatWhile(/[\s]+/),"comment";if(b.test(O))return I.eatWhile(b),"operator";I.eatWhile(/[\w\$_]/);var W=I.current();return c.propertyIsEnumerable(W)?(h.propertyIsEnumerable(W)&&(w="newstatement"),"keyword"):u.propertyIsEnumerable(W)?"builtin":g.propertyIsEnumerable(W)?"atom":"word"}function E(I){return function(P,O){for(var _=!1,W,U=!1;(W=P.next())!=null;){if(W==I&&!_){U=!0;break}_=!_&&W=="\\"}return(U||!(_||y))&&(O.tokenize=C),"string"}}function k(I,P){for(var O=!1,_;_=I.next();){if(_=="/"&&O){P.tokenize=C;break}O=_=="*"}return"comment"}function D(I,P,O,_,W){this.indented=I,this.column=P,this.type=O,this.align=_,this.prev=W}function A(I,P,O){return I.context=new D(I.indented,P,O,null,I.context)}function N(I){var P=I.context.type;return(P==")"||P=="]"||P=="}")&&(I.indented=I.context.indented),I.context=I.context.prev}return{startState:function(I){return{tokenize:null,context:new D((I||0)-l,0,"top",!1),indented:0,startOfLine:!0}},token:function(I,P){var O=P.context;if(I.sol()&&(O.align==null&&(O.align=!1),P.indented=I.indentation(),P.startOfLine=!0),I.eatSpace())return null;w=null;var _=(P.tokenize||C)(I,P);if(_=="comment"||_=="meta")return _;if(O.align==null&&(O.align=!0),(w==";"||w==":")&&O.type=="statement")N(P);else if(w=="{")A(P,I.column(),"}");else if(w=="[")A(P,I.column(),"]");else if(w=="(")A(P,I.column(),")");else if(w=="}"){for(;O.type=="statement";)O=N(P);for(O.type=="}"&&(O=N(P));O.type=="statement";)O=N(P)}else w==O.type?N(P):(O.type=="}"||O.type=="top"||O.type=="statement"&&w=="newstatement")&&A(P,I.column(),"statement");return P.startOfLine=!1,_},indent:function(I,P){if(I.tokenize!=C&&I.tokenize!=null)return 0;var O=P&&P.charAt(0),_=I.context,W=O==_.type;return _.type=="statement"?_.indented+(O=="{"?0:l):_.align?_.column+(W?0:1):_.indented+(W?0:l)},electricChars:"{}"}});function e(r){for(var o={},l=r.split(" "),c=0;c<l.length;++c)o[l[c]]=!0;return o}var t="attribute const uniform varying break continue do for while if else in out inout float int void bool true false lowp mediump highp precision invariant discard return mat2 mat3 mat4 vec2 vec3 vec4 ivec2 ivec3 ivec4 bvec2 bvec3 bvec4 sampler2D samplerCube struct gl_FragCoord gl_FragColor",n="radians degrees sin cos tan asin acos atan pow exp log exp2 log2 sqrt inversesqrt abs sign floor ceil fract mod min max clamp mix step smoothstep length distance dot cross normalize faceforward reflect refract matrixCompMult lessThan lessThanEqual greaterThan greaterThanEqual equal notEqual any all not dFdx dFdy fwidth texture2D texture2DProj texture2DLod texture2DProjLod textureCube textureCubeLod require export";function s(r,o){return o.startOfLine?(r.skipToEnd(),"meta"):!1}(function(){i.defineMIME("text/x-glsl",{name:"glsl",keywords:e(t),builtins:e(n),blockKeywords:e("case do else for if switch while struct"),atoms:e("null"),hooks:{"#":s}})})()};const DF=Vk(LF);DF(or);const IF=500;class qh extends K{constructor(e){super(),this.state=e,this.changingValue=!1,this.debouncedValueUpdater=ze(()=>{this.changingValue=!0;try{this.state.fragmentMain.value=this.textEditor.getValue()}finally{this.changingValue=!1}},IF),this.textEditor=or(s=>{},{value:this.state.fragmentMain.value,mode:"glsl",gutters:["CodeMirror-lint-markers"]}),this.textEditor.on("change",()=>{this.setValidState(void 0),this.debouncedValueUpdater()}),this.registerDisposer(this.state.fragmentMain.changed.add(()=>{this.changingValue||this.textEditor.setValue(this.state.fragmentMain.value)})),this.element.classList.add("neuroglancer-shader-code-widget"),this.registerDisposer(this.state.shaderError.changed.add(()=>{this.updateErrorState()}));const{shaderControlState:t}=this.state;t!==void 0&&this.registerDisposer(t.parseErrors.changed.add(()=>{this.updateErrorState()})),this.updateErrorState();const n=new IntersectionObserver(s=>{s.some(r=>r.isIntersecting)&&this.textEditor.refresh()},{root:document.body});n.observe(this.element),this.registerDisposer(()=>n.disconnect())}get element(){return this.textEditor.getWrapperElement()}updateErrorState(){const{sourceStringNumber:e=1}=this.state,t=this.state.shaderError.value;let n;const{shaderControlState:s}=this.state;s!==void 0?n=s.parseErrors.value:n=[],t===void 0&&n.length===0?this.setValidState(void 0):t!=null||n.length!==0?(this.textEditor.setOption("lint",{getAnnotations:()=>{const r=[];for(const o of n)r.push({message:o.message,severity:"error",from:or.Pos(o.line)});if(t!=null)if(t.name==="ShaderCompilationError")for(const o of t.errorMessages)r.push({message:o.message,severity:"error",from:or.Pos(o.file===e&&o.line||0)});else t.name==="ShaderLinkError"?r.push({message:t.log,severity:"error",from:or.Pos(0)}):r.push({message:t.message,severity:"error",from:or.Pos(0)});return r}}),this.setValidState(!1)):(this.textEditor.setOption("lint",void 0),this.setValidState(!0))}setValidState(e){const{element:t}=this;t.classList.remove("invalid-input"),t.classList.remove("valid-input"),e===!0?t.classList.add("valid-input"):e===!1&&t.classList.add("invalid-input")}disposed(){this.debouncedValueUpdater.flush(),this.debouncedValueUpdater=void 0,gt(this.element),this.textEditor=void 0,super.disposed()}}const Bk=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="pauseIconTitle">
    <title id="pauseIconTitle">Pause</title>    
    <rect width="4" height="16" x="5" y="4"/>
    <rect width="4" height="16" x="15" y="4"/>
</svg>`,Fk=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="playIconTitle">
    <title id="playIconTitle">Play</title>    
    <path d="M20 12L5 21V3z"/>
</svg>`,Uk=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="videoIconTitle">
    <title id="videoIconTitle">Video</title>    
    <polygon points="18 12 9 16.9 9 7"/>
    <circle cx="12" cy="12" r="10"/>
</svg>`;class ny extends K{constructor(e,t={}){super(),this.model=e,this.element=document.createElement("label"),this.inputElement=document.createElement("input");let{validator:n,label:s}=t;const{element:r,inputElement:o}=this;n===void 0&&(e instanceof bt?n=e.validator:n=l=>l),this.validator=n,s!==void 0&&(r.textContent=s),r.appendChild(o),r.className="neuroglancer-number-input",o.type="text",this.registerDisposer(this.model.changed.add(()=>this.updateView())),this.registerEventListener(o,"change",()=>this.updateModel()),this.updateView()}updateView(){this.inputElement.value=""+this.model.value}updateModel(){let e=parseFloat(this.inputElement.value.trim());if(Number.isNaN(e)){this.updateView();return}try{e=this.validator(e),this.model.value=e}catch{this.updateView()}}disposed(){gt(this.element),super.disposed()}}function zk(i,e,t,n){return Math.floor((i-e)*(n-1)/(t-e))}function PF(i,e,t){const{boundingBoxes:n,bounds:s}=i;let[r,o]=Yx(s,e);if(r=Math.floor(r),o=Math.floor(o-1),!Number.isFinite(r)||!Number.isFinite(o))return;const l=[],c=h=>zk(h,r,o,t),{rank:u}=i;for(const h of n){const g=Kx(h,e,u);g!==void 0&&(g.lower=Math.max(0,c(g.lower)),g.upper=Math.min(t-1,c(Math.ceil(g.upper-1))),l.push(g))}return l.sort((h,g)=>{const v=h.lower-g.lower;return v!==0?v:g.upper-g.upper}),rx(l,(h,g)=>{if(g===0)return!0;const v=l[g-1];return v.lower!==h.lower||v.upper!==h.upper}),{lowerBound:r,upperBound:o,normalizedBounds:l}}class Gk extends K{constructor(e,t,n="column"){super(),this.position=e,this.dimensionId=t,this.orientation=n,this.element=document.createElement("div"),this.visible=!0,this.dragging=new Ne(!1),this.tickWidth=this.orientation==="column"?10:5,this.barWidth=this.orientation==="column"?15:10,this.barRightMargin=this.orientation==="column"?10:2,this.canvasWidth=this.tickWidth+this.barWidth+this.barRightMargin;const s=this.element;s.classList.add("neuroglancer-position-dimension-plot"),s.dataset.orientation=n;const r=document.createElement("canvas"),o=r.getContext("2d"),l=document.createElement("div"),c=document.createElement("div");c.appendChild(l);const u=document.createTextNode("");l.appendChild(u);const h=document.createElement("div"),g=document.createElement("div");c.classList.add("neuroglancer-position-dimension-plot-lowerbound"),h.classList.add("neuroglancer-position-dimension-plot-upperbound"),g.classList.add("neuroglancer-position-dimension-plot-hoverposition"),s.appendChild(c),s.appendChild(h),s.appendChild(g),s.appendChild(r);let v,y,b;const w=()=>{const D=this.position.coordinateSpace.value,A=D.ids.indexOf(this.dimensionId);if(A===-1)return;let N;n==="column"?(N=100,r.width=this.canvasWidth,r.height=N,h.style.marginTop=`${N-1}px`):(N=r.clientWidth,r.width=N,r.height=this.canvasWidth);const I=PF(D,A,N);if(I===void 0||D.bounds.lowerBounds[A]+1===D.bounds.upperBounds[A]){this.element.style.display="none",this.visible=!1;return}this.visible=!0;const{lowerBound:P,upperBound:O}=I;v=P,y=O,u.textContent=P.toString(),h.textContent=O.toString();let _,W,U;n!=="column"&&(W=l.clientWidth,U=h.clientWidth,_=Math.max(W,U)/2,r.style.marginLeft=`${_}px`,r.style.marginRight=`${_}px`,h.style.position="relative",h.style.left=`${N+_-U/2}px`,l.style.marginLeft=`${_-W/2}px`),this.drawDimensionBounds(r,o,I);const j=this.position.value[A],B=(se,ve)=>{if(se!==void 0&&se>=P&&Math.floor(se)<=O){o.fillStyle=ve;const me=zk(se,P,O,N);return n==="column"?o.fillRect(0,me,this.canvasWidth,1):o.fillRect(me,0,1,this.canvasWidth),me}},H=B(j,"#f66"),V=this.dragging.value;let re=V?H:B(b,"#66f");if(re!==void 0){g.textContent=(V?Math.floor(j):b).toString();const se=n==="column"?l.clientHeight:l.clientWidth,ve=n==="column"?h.clientHeight:h.clientWidth;let me,Ie,We;if(n!=="column"){me=g.clientWidth,re+=_,re-=me/2,re=Math.max(0,re);const tt=N+_-ve/2-me;Ie=re>_+se/2,We=re<tt}else Ie=re>se,We=re<N-ve;l.style.visibility=Ie?"":"hidden",h.style.visibility=We?"":"hidden",g.style.display="",g.style.visibility="visible",n==="column"?g.style.marginTop=`${re}px`:g.style.marginLeft=`${re}px`}else l.style.visibility="",g.style.display="none",h.style.visibility=""},C=this.registerCancellable(et(w));this.registerDisposer(this.position.changed.add(C));const E=D=>{if(v===void 0||y===void 0)return;const A=r.getBoundingClientRect();let N;return n==="column"?N=(D.clientY-A.top)/A.height:N=(D.clientX-A.left)/A.width,N=Math.max(0,N),N=Math.min(1,N),Math.round(N*(y-v))+v},k=D=>{const A=this.position.coordinateSpace.value,N=A.ids.indexOf(this.dimensionId);if(N===-1)return;let I=E(D);if(I===void 0)return;const{position:P}=this,O=P.value;A.bounds.voxelCenterAtIntegerCoordinates[N]||(I+=.5),O[N]=I,P.value=O};r.addEventListener("pointermove",D=>{b=E(D),C()}),r.addEventListener("pointerleave",()=>{b=void 0,C()}),r.addEventListener("pointerdown",D=>{D.preventDefault(),D.stopPropagation(),!(D.ctrlKey||D.altKey||D.metaKey)&&(oi(D,A=>{this.wasDisposed||(b=void 0,k(A),C(),this.dragging.value=!0)},()=>{this.dragging.value=!1,C()}),k(D))}),w(),n==="row"&&(r.style.maxWidth="100%",r.style.justifySelf="stretch",new ResizeObserver(w).observe(r))}drawDimensionBounds(e,t,n){const{orientation:s}=this;t.clearRect(0,0,e.width,e.height);const{normalizedBounds:r}=n,o=s==="column"?c=>{t.fillRect(0,c,this.tickWidth,1)}:c=>{t.fillRect(c,0,1,this.tickWidth)};t.fillStyle="#fff";for(const{lower:c,upper:u}of r)o(c),o(u);const l=r.length;t.fillStyle="#ccc";for(let c=0;c<l;++c){const{lower:u,upper:h}=r[c],g=Math.floor(c*this.barWidth/l),v=Math.max(1,this.barWidth/l);s==="column"?t.fillRect(g+this.tickWidth,u,v,h+1-u):t.fillRect(u,g+this.tickWidth,h+1-u,v)}}}const Qd="neuroglancer-position",Gw=He.fromObject({arrowup:{action:"adjust-up"},arrowdown:{action:"adjust-down"},arrowleft:{action:"maybe-tab-backward",preventDefault:!1},arrowright:{action:"maybe-tab-forward",preventDefault:!1},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},wheel:{action:"adjust-via-wheel"},"alt+wheel":{action:"adjust-velocity-via-wheel"},backspace:{action:"delete-backward",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}}),AF=[i=>i.nameElement,i=>i.coordinate,i=>i.scaleElement];function Zd(i,e){const t=i.coordinateArrays[e];return t===void 0?t:i.units[e]!==""||i.scales[e]!==1?null:t}let RF=class{constructor(e,t,n,s){this.coordinateSpace=e,this.id=t,this.container=document.createElement("div"),this.nameContainer=document.createElement("span"),this.nameElement=document.createElement("input"),this.scaleContainer=document.createElement("span"),this.scaleElement=document.createElement("input"),this.coordinate=document.createElement("input"),this.coordinateLabel=document.createElement("span"),this.playButton=document.createElement("div"),this.pauseButton=document.createElement("div"),this.coordinateLabelWidth=0,this.maxPositionWidth=0,this.maxPositionWidthSeen=0,this.dropdownOwner=void 0,this.modified=!1,this.draggingPosition=!1,this.hasFocus=!1;const{container:r,scaleElement:o,scaleContainer:l,coordinate:c,nameElement:u,nameContainer:h,coordinateLabel:g,playButton:v,pauseButton:y}=this;r.title="",r.classList.add("neuroglancer-position-dimension");const{allowFocus:b,showPlayback:w}=s;b&&(r.draggable=!0,r.tabIndex=-1),r.appendChild(h),r.appendChild(o),h.appendChild(u),h.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",l.appendChild(o),u.classList.add("neuroglancer-position-dimension-name"),u.disabled=!0,u.spellcheck=!1,u.autocomplete="off",u.required=!0,u.placeholder=" ",l.classList.add("neuroglancer-position-dimension-scale-container"),o.classList.add("neuroglancer-position-dimension-scale"),o.disabled=!0,o.spellcheck=!1,o.autocomplete="off",r.appendChild(l),w&&(v.classList.add("neuroglancer-icon"),y.classList.add("neuroglancer-icon"),v.innerHTML=Fk,y.innerHTML=Bk,r.appendChild(v),r.appendChild(y)),r.appendChild(c),c.type="text",c.classList.add("neuroglancer-position-dimension-coordinate"),c.spellcheck=!1,c.autocomplete="off",c.pattern=String.raw`(-?\d+(?:\.(?:\d+)?)?)`;const C=Zd(e,n);if(C!=null){let E=0;for(const k of C.labels)E=Math.max(E,k.length);this.coordinateLabelWidth=E,g.style.width=`${E+2}ch`,r.appendChild(g)}c.required=!0,c.placeholder=" ",g.classList.add("neuroglancer-position-dimension-coordinate-label"),b&&(h.addEventListener("dblclick",()=>{u.disabled=!1,u.focus(),u.select()}),l.addEventListener("dblclick",()=>{o.disabled=!1,o.focus(),o.select()}),c.addEventListener("focus",()=>{c.select()}),r.addEventListener("click",E=>{(!(E.target instanceof HTMLInputElement)||E.target.disabled)&&c.focus()}))}};function $w(i,e){const t=e.length;t>i.maxPositionWidthSeen&&(i.maxPositionWidthSeen=t),Dn(i.coordinate,Math.max(Math.min(i.maxPositionWidth,i.maxPositionWidthSeen),t))}function Ww(i){const{value:e}=i;Dn(i),i.parentElement.dataset.isEmpty=e===""?"true":"false"}class Hc extends K{constructor(e,t,{copyButton:n=!0,velocity:s=void 0,singleDimensionId:r=void 0,getToolBinder:o=void 0,allowFocus:l=!0,showPlayback:c=!0}={}){super(),this.position=e,this.combiner=t,this.element=document.createElement("div"),this.dimensionContainer=document.createElement("div"),this.coordinateSpace=void 0,this.dimensionWidgets=new Map,this.dimensionWidgetList=[],this.dragSource=void 0;const{element:u,dimensionContainer:h}=this;if(this.velocity=s,this.singleDimensionId=r,this.getToolBinder=o,this.allowFocus=l,this.showPlayback=c,this.registerDisposer(e.coordinateSpace.changed.add(this.registerCancellable(et(()=>this.updateDimensions())))),u.className="neuroglancer-position-widget",h.style.display="contents",u.appendChild(h),n){const b=xs({title:"Copy position to clipboard",onClick:()=>{const w=gr(this.getPositionText());Pe.showTemporaryMessage(w?"Position copied to clipboard":"Failed to copy position to clipboard")}});b.addEventListener("dragstart",w=>{w.dataTransfer.setData(Qd,JSON.stringify({position:e.toJSON(),dimensions:e.coordinateSpace.value.names})),w.dataTransfer.setData("text",this.getPositionText()),w.stopPropagation()}),b.draggable=!0,u.appendChild(b)}const g=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(e.changed.add(g)),s!==void 0&&this.registerDisposer(s.changed.add(g));const v=b=>{const w=b.target;return!!(w instanceof Element&&w.matches(".neuroglancer-position-dimension-playback *"))};if(l){const b=this.registerDisposer(new Pi(u,Gw));b.allShortcutsAreGlobal=!0,b.shouldIgnore=v}const y=this.registerDisposer(new ji(u,Gw));y.shouldIgnore=v,this.registerDisposer(fe(u,"cancel",b=>{this.coordinateSpace=void 0,this.updateView(),this.closeDropdown();const{target:w}=b;w instanceof HTMLElement&&w.blur()})),this.updateView()}getDimensionIndex(e){return this.position.coordinateSpace.value.ids.indexOf(e)}openRegularDropdown(e,t){var l,c;t.classList.add("neuroglancer-position-dimension-dropdown");const n=e.dropdownOwner,s=(l=this.getToolBinder)==null?void 0:l.call(this);if(s!==void 0){const u=this.getDimensionIndex(e.id),h=ia(n,s,{toolJson:{type:Jc,dimension:e.coordinateSpace.names[u]}});t.appendChild(h)}const r=n.registerDisposer(new Gk(this.position,e.id));t.appendChild(r.element);const o=(c=this.velocity)==null?void 0:c.dimensionVelocity(n,e.id);if(o!==void 0){const u=document.createElement("div");u.classList.add("neuroglancer-position-dimension-playback");const h=document.createElement("div");h.classList.add("neuroglancer-position-dimension-playback-header"),u.appendChild(h),h.appendChild(n.registerDisposer(new Kn(this.velocity.playbackEnabled(e.id),{svg:Uk,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),h.appendChild(document.createTextNode("Playback")),t.appendChild(u);const g=n.registerDisposer(Ht(v=>v!==void 0,[o]));u.appendChild(n.registerDisposer(new Vn(g,(v,y,b)=>{if(!v)return;const w=new Ne(0);w.changed.add(()=>{const I=w.value,P=o.value;P!==void 0&&P.velocity!==I&&(o.value={...P,velocity:I})});const C=$e({text:"±",title:"Negate velocity",onClick:()=>{w.value=-w.value}}),E=b.registerDisposer(new ny(w));E.element.insertBefore(C,E.element.firstChild),E.element.title="Velocity in coordinates per second";const k=document.createElement("span");k.textContent="/s",E.element.appendChild(k),y.appendChild(E.element);const D=new Uc(ms,ms.STOP),A=()=>{var I,P;D.value=((I=o.value)==null?void 0:I.atBoundary)??ms.STOP,w.value=((P=o.value)==null?void 0:P.velocity)??0};A(),b.registerDisposer(o.changed.add(A)),D.changed.add(()=>{const I=D.value,P=o.value;P!==void 0&&P.atBoundary!==I&&(o.value={...P,atBoundary:I})});const N=new Mh(D).element;y.appendChild(N),N.title="Behavior when lower/upper bound is reached"})).element)}r.dragging.changed.add(()=>{(e.draggingPosition=r.dragging.value)===!1&&this.updateDropdownVisibility(e)})}openCoordinateArrayDropdown(e,t,n){t.classList.add("neuroglancer-position-dimension-coordinate-dropdown");const{coordinates:s,labels:r}=n,o=s.length;t.style.setProperty("--neuroglancer-coordinate-label-width",`${e.coordinateLabelWidth}ch`);for(let l=0;l<o;++l){const c=document.createElement("div");c.classList.add("neuroglancer-dimension-dropdown-coordinate-entry");const u=document.createElement("div");u.classList.add("neuroglancer-dimension-dropdown-coordinate");const h=document.createElement("div");h.classList.add("neuroglancer-dimension-dropdown-coordinate-label"),h.textContent=r[l],u.textContent=s[l].toString(),c.appendChild(u),c.appendChild(h),c.addEventListener("click",()=>{const g=this.getDimensionIndex(e.id);if(g===-1)return;const{position:v}=this,y=v.value;y[g]=s[l]+.5,e.modified=!1,v.value=y}),t.appendChild(c)}}openDropdown(e){if(e.dropdownOwner!==void 0)return;const t=this.getDimensionIndex(e.id);if(t===-1)return;this.closeDropdown();const n=e.dropdownOwner=new K,s=document.createElement("div");s.draggable=!0,s.addEventListener("dragstart",o=>{o.stopPropagation(),o.preventDefault()}),s.addEventListener("pointerenter",()=>{e.hasFocus=!0}),s.tabIndex=-1,e.container.appendChild(s);const r=Zd(e.coordinateSpace,t);r==null?this.openRegularDropdown(e,s):this.openCoordinateArrayDropdown(e,s,r),this.widgetWithOpenDropdown=e,n.registerDisposer(()=>{gt(s),e.dropdownOwner=void 0,e.container.dataset.dropdownVisible=void 0,this.widgetWithOpenDropdown=void 0}),n.registerEventListener(document,"pointerdown",o=>{const{target:l}=o;l instanceof Node&&e.container.contains(l)||this.closeDropdown(e)},{capture:!0})}closeDropdown(e=this.widgetWithOpenDropdown){if(e===void 0)return;const{dropdownOwner:t}=e;t!==void 0&&t.dispose()}pasteString(e,t){for(;;){e.coordinate.focus();const n=t.match(/^\s*(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))?/);if(n===null)break;if(n[1]!==void 0&&document.execCommand("insertText",void 0,n[1]),n[2]!==void 0){const{dimensionWidgetList:s}=this,r=s.indexOf(e);if(r===-1||r+1===s.length)break;const o=t.substring(n[0].length);e=s[r+1],t=o;continue}break}}reorderDimensionTo(e,t){if(e===t)return;const{coordinateSpace:n}=this.position;n.value=r1(n.value,e,t)}updateDropdownVisibility(e){e.hasFocus||e.draggingPosition?this.openDropdown(e):this.closeDropdown(e)}newDimension(e,t,n){const s=new RF(e,t,n,{allowFocus:this.allowFocus,showPlayback:this.showPlayback});this.singleDimensionId===void 0&&(s.container.addEventListener("dragstart",r=>{this.dragSource=s,r.stopPropagation(),r.dataTransfer.setData("neuroglancer-dimension","")}),s.container.addEventListener("dragenter",r=>{const{dragSource:o}=this;if(o===void 0||o===s)return;const{dimensionWidgetList:l}=this,c=l.indexOf(o),u=l.indexOf(s);c===-1||u===-1||(r.preventDefault(),this.reorderDimensionTo(u,c))}),s.container.addEventListener("dragend",r=>{this.dragSource===s&&(this.dragSource=void 0)})),this.allowFocus?(s.container.addEventListener("focusin",()=>{s.hasFocus=!0,this.updateDropdownVisibility(s)}),s.container.addEventListener("focusout",r=>{const{relatedTarget:o}=r;o instanceof Node&&s.container.contains(o)||(s.hasFocus=!1,this.updateDropdownVisibility(s))}),s.coordinate.addEventListener("paste",r=>{const o=s.coordinate,l=o.value,{clipboardData:c}=r;if(c===null)return;let u=c.getData("text"),{selectionEnd:h,selectionStart:g}=o;if(g!==0||h!==l.length){g==null&&(g=0),h==null&&(h=0);const v=u.match(/[^\-0-9.]/);v!==null&&(u=u.substring(0,v.index)),u.length>0&&document.execCommand("insertText",void 0,u)}else this.pasteString(s,u);r.preventDefault(),r.stopPropagation()}),s.coordinate.addEventListener("input",()=>{s.modified=!0;const r=s.coordinate,o=r.value;let{selectionDirection:l,selectionEnd:c,selectionStart:u}=r;u===null&&(u=0),c===null&&(c=u);let h="";const g=/[^\-0-9.]/g;h+=o.substring(0,u).replace(g,"");const v=h.length;h+=o.substring(u,c).replace(g,"");const y=h.length;h+=o.substring(c).replace(g,""),r.value=h,r.selectionStart=v,r.selectionEnd=y,r.selectionDirection=l,$w(s,h),c===u&&c===o.length&&o.match(/^(-?\d+(?:\.(?:\d+)?)?)((?:\s+(?![\s,]))|(?:\s*,\s*))$/)&&this.selectAdjacentCoordinate(s,1)}),s.nameElement.addEventListener("input",()=>{const{nameElement:r}=s;Dn(r),this.updateNameValidity()}),s.scaleElement.addEventListener("input",()=>{const{scaleElement:r}=s;Ww(r),this.updateScaleValidity(s)}),s.coordinate.addEventListener("blur",r=>{const{relatedTarget:o}=r;this.dimensionWidgetList.some(l=>l.coordinate===o)||s.modified&&this.updatePosition()}),s.nameElement.addEventListener("blur",r=>{s.nameElement.disabled=!0;const{relatedTarget:o}=r;this.dimensionWidgetList.some(l=>l.nameElement===o)||this.updateNames()||this.forceUpdateDimensions()}),s.scaleElement.addEventListener("blur",r=>{s.scaleElement.disabled=!0;const{relatedTarget:o}=r;this.dimensionWidgetList.some(l=>l.scaleElement===o)||this.updateScales()||this.forceUpdateDimensions()})):s.coordinate.disabled=!0,fe(s.container,"adjust-via-wheel",r=>{const o=r.detail,{deltaY:l}=o;l!==0&&this.adjustDimensionPosition(s.id,Math.sign(l))}),fe(s.container,"adjust-velocity-via-wheel",r=>{const o=r.detail;this.adjustDimensionVelocity(s,Ia(o))}),fe(s.container,"adjust-up",()=>{this.adjustDimensionPosition(s.id,-1)}),fe(s.container,"adjust-down",()=>{this.adjustDimensionPosition(s.id,1)});for(const r of AF){const o=r(s);fe(o,"maybe-tab-forward",l=>{this.handleLeftRightMovement(l,s,1,r)}),fe(o,"maybe-tab-backward",l=>{this.handleLeftRightMovement(l,s,-1,r)}),fe(o,"tab-forward",()=>{this.selectAdjacentField(s,1,r)}),fe(o,"tab-backward",()=>{this.selectAdjacentField(s,-1,r)})}if(fe(s.coordinate,"commit",()=>{this.updatePosition()}),fe(s.nameElement,"commit",()=>{this.updateNames()}),fe(s.scaleElement,"commit",()=>{this.updateScales()}),fe(s.coordinate,"delete-backward",r=>{r.stopPropagation();const{coordinate:o}=s;o.selectionStart===o.selectionEnd&&o.selectionStart===0&&(r.preventDefault(),this.selectAdjacentCoordinate(s,-1))}),this.showPlayback){const r=o=>{var l;(l=this.velocity)==null||l.togglePlayback(s.id,o)};s.playButton.addEventListener("click",()=>r(!1)),s.pauseButton.addEventListener("click",()=>r(!0))}return s}forceUpdateDimensions(){let{position:{coordinateSpace:{value:e}}}=this;e.valid||(e=bs),this.coordinateSpace=e;const{dimensionWidgets:t,dimensionWidgetList:n}=this;n.length=0;const{names:s,ids:r,scales:o,units:l,bounds:{lowerBounds:c,upperBounds:u}}=e,h=(v,y)=>{const b=c[y],w=u[y],C=Math.max(Number.isFinite(b)?Math.floor(b).toString().length:0,Number.isFinite(w)?Math.ceil(w).toString().length:0);let E=t.get(v);E===void 0?(E=this.newDimension(e,v,y),t.set(v,E),E.maxPositionWidthSeen=C):E.coordinateSpace=e,E.maxPositionWidth=C;const k=s[y];E.nameElement.value=k,E.nameElement.dataset.isValid=void 0,Dn(E.nameElement);const D=Zd(e,y);D===void 0?E.container.dataset.coordinateArray="none":D===null?E.container.dataset.coordinateArray="invalid":E.container.dataset.coordinateArray="valid",E.scaleContainer.title="Drag to reorder, double click to change scale",D===null&&(E.scaleContainer.title+=".  Coordinate array disabled.  To use the coordinate array, remove the unit/scale.");const{scale:A,prefix:N,unit:I}=Wx(o[y],l[y]),P=`${A}${N}${I}`;return E.scaleElement.value=P,E.scaleElement.dataset.isValid=void 0,Ww(E.scaleElement),n.push(E),E.container},{singleDimensionId:g}=this;if(g!==void 0){const v=this.getDimensionIndex(g);v===-1?si(this.dimensionContainer,[]):si(this.dimensionContainer,[h(g,v)])}else si(this.dimensionContainer,r.map(h));for(const[v,y]of t)y.coordinateSpace!==e&&(this.closeDropdown(y),t.delete(v))}updateDimensions(){const{position:{coordinateSpace:{value:e}}}=this;e!==this.coordinateSpace&&this.forceUpdateDimensions()}selectAdjacentField(e,t,n){const{dimensionWidgetList:s}=this;let r=s.indexOf(e);if(r!==-1)for(;;){if(r+=t,r<0||r>=s.length)return!1;const o=s[r],l=n(o);if(l.style.display!=="none")return l.disabled=!1,l.focus(),l.selectionStart=0,l.selectionEnd=l.value.length,l.selectionDirection=t===1?"forward":"backward",!0}}selectAdjacentCoordinate(e,t){return this.selectAdjacentField(e,t,n=>n.coordinate)}handleLeftRightMovement(e,t,n,s){e.stopPropagation();const r=s(t);r.selectionStart!==r.selectionEnd||r.selectionStart!==(n===1?r.value.length:0)||this.selectAdjacentField(t,n,s)&&e.preventDefault()}updateNameValidity(){const{dimensionWidgetList:e}=this,t=e.map(r=>r.nameElement.value),n=t.length,s=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=s[r]===!1?"false":"true"}updateScaleValidity(e){const t=jl(e.scaleElement.value)!==void 0;e.scaleElement.dataset.isValid=t.toString()}adjustDimensionPosition(e,t){const n=this.getDimensionIndex(e);if(n===-1)return;this.updatePosition();const{position:s}=this;if(!s.valid)return;const r=s.coordinateSpace.value,{bounds:o}=r,l=Float32Array.from(s.value);l[n]=vg(o,n,l[n]+t),this.position.value=l,this.updateView()}adjustDimensionVelocity(e,t){const{velocity:n}=this;n!==void 0&&n.multiplyVelocity(e.id,t)}updatePosition(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:t}=this,{value:n}=t,s=t.coordinateSpace.value;if(n===void 0)return;const r=e.length;let o=!1;for(let l=0;l<r;++l){const c=e[l];if(!c.modified)continue;c.modified=!1,o=!0;const u=c.coordinate.value;let h=Number(u);Number.isFinite(h)&&(Number.isInteger(h)&&!u.includes(".")&&s!==void 0&&!s.bounds.voxelCenterAtIntegerCoordinates[l]&&(h+=.5),n[l]=h)}o&&(t.value=n)}updateNames(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,n=t.value,s=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(s).includes(!1))return!1;const r=n.names;if(De(r,s))return!1;const o=n.timestamps.map((c,u)=>r[u]===s[u]?c:Date.now()),l={...n,names:s,timestamps:o};return t.value=l,!0}updateScales(){if(!this.allowFocus)return;const{dimensionWidgetList:e}=this,{position:{coordinateSpace:t}}=this,n=t.value,s=e.map(g=>jl(g.scaleElement.value));if(s.includes(void 0))return!1;const r=Float64Array.from(s,g=>g.scale),o=Array.from(s,g=>g.unit),{scales:l,units:c}=n;if(De(l,r)&&De(c,o))return!1;const u=n.timestamps.map((g,v)=>r[v]===l[v]&&o[v]===c[v]?g:Date.now()),h=Ue({valid:n.valid,rank:n.rank,scales:r,units:o,timestamps:u,ids:n.ids,names:n.names,boundingBoxes:n.boundingBoxes,coordinateArrays:n.coordinateArrays});return t.value=h,!0}getPositionText(){const{position:e}=this;return e.valid?e.value.map(t=>Math.floor(t)).join(", "):""}updateView(){var o;this.updateDimensions();const{position:{value:e},dimensionWidgetList:t}=this,n=t.length;if(e===void 0)return;const s=this.coordinateSpace,{velocity:r}=this;for(let l=0;l<n;++l){const c=t[l],u=c.coordinate,h=Math.floor(e[l]),g=h.toString();$w(c,g),u.value=g;const v=Zd(s,l);let y="";if(v!=null){const{coordinates:w}=v,C=xP(w,h,(E,k)=>E-k);C!==w.length&&(y=v.labels[C])}const b=c.coordinateLabel;if(b.textContent=y,this.showPlayback){const w=(o=r==null?void 0:r.value)==null?void 0:o[l];if(w!==void 0){const C=w.paused;c.playButton.style.display=C?"":"none",c.pauseButton.style.display=C?"none":""}else c.playButton.style.display="none",c.pauseButton.style.display="none"}}}disposed(){this.closeDropdown(),gt(this.element),super.disposed()}}class NF extends K{constructor(e,t,n){super(),this.element=e,this.mouseState=t,this.coordinateSpace=n,this.tempPosition=we(),e.className="neuroglancer-mouse-position-widget";const s=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(t.changed.add(s)),this.registerDisposer(n.changed.add(s))}updateView(){let e="";const{mouseState:t,coordinateSpace:{value:n}}=this;if(t.active&&n!==void 0){const s=t.position,{rank:r,names:o}=n;for(let l=0;l<r;++l)l!==0&&(e+="  "),e+=`${o[l]} ${Math.floor(s[l])}`}this.element.textContent=e}disposed(){gt(this.element),super.disposed()}}const Jc="dimension",MF=He.fromObject({"at:shift?+wheel":{action:"adjust-position-via-wheel"},"at:shift?+alt+wheel":{action:"adjust-velocity-via-wheel"},"shift?+alt?+space":{action:"toggle-playback"},"at:shift?+alt?+mousedown0":{action:"toggle-playback"}});class OF extends Tu{constructor(e,t){super(e.toolBinder),this.viewer=e,this.dimensionId=t;const n=this.coordinateSpace.value,s=this.dimensionIndex=n.ids.indexOf(t);this.dimensionName=n.names[s],this.registerDisposer(this.coordinateSpace.changed.add(()=>{const r=this.coordinateSpace.value,o=this.dimensionIndex=this.coordinateSpace.value.ids.indexOf(t);if(o===-1){this.unbind();return}const l=r.names[o];this.dimensionName!==l&&(this.dimensionName=l,this.changed.dispatch())}))}get position(){return this.viewer.position}get velocity(){return this.viewer.velocity}get coordinateSpace(){return this.viewer.coordinateSpaceCombiner.combined}activate(e){const{viewer:t}=this,{content:n}=OE(e);n.classList.add("neuroglancer-position-tool"),e.bindInputEventMap(MF);const s=new Hc(t.position,t.coordinateSpaceCombiner,{velocity:t.velocity,singleDimensionId:this.dimensionId,copyButton:!1,allowFocus:!1,showPlayback:!1});s.element.style.userSelect="none",n.appendChild(e.registerDisposer(s).element);const r=e.registerDisposer(new Gk(t.position,this.dimensionId,"row"));r.element.style.flex="1",n.appendChild(r.element),e.bindAction("adjust-position-via-wheel",c=>{c.stopPropagation();const u=c.detail,{deltaY:h}=u;h!==0&&s.adjustDimensionPosition(this.dimensionId,Math.sign(h))});const o=this.velocity.dimensionVelocity(e,this.dimensionId),l=e.registerDisposer(Ht(c=>c!==void 0,[o]));n.appendChild(e.registerDisposer(new Vn(l,(c,u,h)=>{if(!c)return;u.classList.add("neuroglancer-position-dimension-playback");const g=document.createElement("div"),v=document.createElement("div");g.classList.add("neuroglancer-icon"),v.classList.add("neuroglancer-icon"),g.innerHTML=Fk,v.innerHTML=Bk,u.appendChild(g),u.appendChild(v);const y=()=>t.velocity.togglePlayback(this.dimensionId);g.addEventListener("click",y),v.addEventListener("click",y);const b=()=>{var P;const I=(P=o.value)==null?void 0:P.paused;g.style.display=I?"":"none",v.style.display=I?"none":""};h.registerDisposer(o.changed.add(b)),b();const w=new Ne(0);w.changed.add(()=>{const I=w.value,P=o.value;P!==void 0&&P.velocity!==I&&(o.value={...P,velocity:I})});const C=$e({text:"±",title:"Negate velocity",onClick:()=>{w.value=-w.value}}),E=h.registerDisposer(new ny(w));E.inputElement.disabled=!0,E.element.insertBefore(C,E.element.firstChild),E.element.title="Velocity in coordinates per second";const k=document.createElement("span");k.textContent="/s",E.element.appendChild(k),u.appendChild(E.element);const D=new Uc(ms,ms.STOP),A=()=>{var I,P;D.value=((I=o.value)==null?void 0:I.atBoundary)??ms.STOP,w.value=((P=o.value)==null?void 0:P.velocity)??0};A(),h.registerDisposer(o.changed.add(A)),D.changed.add(()=>{const I=D.value,P=o.value;P!==void 0&&P.atBoundary!==I&&(o.value={...P,atBoundary:I})});const N=new Mh(D).element;u.appendChild(N),N.title="Behavior when lower/upper bound is reached"})).element),n.appendChild(e.registerDisposer(new Kn(t.velocity.playbackEnabled(this.dimensionId),{svg:Uk,enableTitle:"Enable playback/velocity",disableTitle:"Disable playback/velocity",backgroundScheme:"dark"})).element),e.bindAction("adjust-velocity-via-wheel",c=>{c.stopPropagation();const u=Ia(c.detail);t.velocity.multiplyVelocity(this.dimensionId,u)}),e.bindAction("toggle-playback",c=>{c.stopPropagation(),t.velocity.togglePlayback(this.dimensionId)})}get description(){return`dim ${this.dimensionName}`}toJSON(){return{type:Jc,dimension:this.dimensionName}}}function iy(i,e){const t=z(e,"dimension",ie),n=i.coordinateSpaceCombiner.combined.value,s=n.names.indexOf(t);if(s===-1)throw new Error(`Invalid dimension name: ${JSON.stringify(t)}`);return new OF(i,n.ids[s])}function _F(i){Ji(i,Jc,(e,t)=>iy({position:e.position,velocity:e.velocity,coordinateSpaceCombiner:e.layerSpecification.coordinateSpaceCombiner,toolBinder:e.toolBinder},t))}function VF(i){Ji(i,Jc,(e,t)=>iy({position:e.localPosition,velocity:e.localVelocity,coordinateSpaceCombiner:e.localCoordinateSpaceCombiner,toolBinder:e.toolBinder},t))}function BF(i){Ji(i,Jc,(e,t)=>iy({position:e.viewerNavigationState.position.value,velocity:e.viewerNavigationState.velocity.velocity,coordinateSpaceCombiner:e.layerSpecification.root.coordinateSpaceCombiner,toolBinder:e.toolBinder},t))}function FF(i){return{makeControl:(e,t,n)=>{const{watchableValue:s,channelCoordinateSpaceCombiner:r,dataType:o,defaultChannel:l,histogramSpecifications:c,legendShaderOptions:u,histogramIndex:h}=i(e);if(r!==void 0&&l.length!==0){const v=t.registerDisposer(new $r(r.combined)),y=t.registerDisposer(new Hc(v,r,{copyButton:!1}));t.registerDisposer(v.changed.add(()=>{const w=v.value,C=Array.from(w,k=>Math.floor(k)),E=s.value;De(E.channel,C)||(s.value={...s.value,channel:C})}));const b=()=>{const w=v.value,C=s.value;De(w,C.channel)||(w.set(C.channel),v.changed.dispatch())};b(),t.registerDisposer(s.changed.add(b)),n.labelContainer.appendChild(y.element)}const g=t.registerDisposer(new Dk(n.visibility,n.display,o,s,c,h,l.length===0?u:void 0));return{control:g,controlElement:g.element}},activateTool:(e,t)=>{Ik(e,t)}}}function UF(i){return{makeControl:(e,t,n)=>{const{watchableValue:s,properties:r,histogramSpecifications:o,legendShaderOptions:l,histogramIndex:c}=i(e);{const v=document.createElement("select");for(const[w,C]of r){const E=document.createElement("option");E.textContent=`${w} (${J[C].toLowerCase()})`,E.value=w,v.appendChild(E)}const y=()=>{const w=v.value,C=r.get(w),{window:E,range:k}=s.value;s.value={window:E!==void 0?gu(E,C):void 0,range:k!==void 0?gu(k,C):void 0,property:w,dataType:C}},b=()=>{v.value=s.value.property};t.registerEventListener(v,"change",y),t.registerDisposer(s.changed.add(b)),b(),n.labelContainer.appendChild(v)}const u={changed:s.changed,get value(){let{dataType:v,window:y,range:b}=s.value;return b===void 0&&(b=ki[v]),{window:Ox(y??b),range:b}},set value(v){const{window:y,range:b}=v;s.value={...s.value,window:y,range:b}}},h=Ht(v=>v.dataType,[s]),g=t.registerDisposer(new uF(n.visibility,n.display,h,u,o,c,l));return{control:g,controlElement:g.element}},activateTool:(e,t)=>{Ik(e,t)}}}function Hw(i,e){const{shaderControlState:t}=i,n=t.state.get(e);if(n===void 0)return;const{control:s}=n;switch(s.type){case"slider":return hs(()=>({value:n.trackable,options:{min:s.min,max:s.max,step:s.step}}));case"color":return nT(()=>n.trackable);case"checkbox":return Zo(()=>n.trackable);case"imageInvlerp":{let r=0;for(const[o,{control:{type:l}}]of t.state){if(o===e)break;l==="imageInvlerp"&&++r}return FF(()=>({dataType:s.dataType,defaultChannel:s.default.channel,watchableValue:n.trackable,channelCoordinateSpaceCombiner:t.channelCoordinateSpaceCombiner,histogramSpecifications:t.histogramSpecifications,histogramIndex:r,legendShaderOptions:i.legendShaderOptions}))}case"propertyInvlerp":{let r=0;for(const[o,{control:{type:l}}]of t.state){if(o===e)break;l==="propertyInvlerp"&&++r}return UF(()=>({properties:s.properties,watchableValue:n.trackable,histogramSpecifications:t.histogramSpecifications,histogramIndex:r,legendShaderOptions:i.legendShaderOptions}))}}}function $k(i,e,t){return{label:t,toolJson:zF(t,e),makeControl:(n,s,r)=>{const o=i(n);return Hw(o,t).makeControl(n,s,r)},activateTool:(n,s)=>{const r=i(n.tool.layer);return Hw(r,t).activateTool(n,s)}}}class Kh extends ci{constructor(e,t,n,s={}){super(s.visibility),this.state=e,this.display=t,this.layer=n,this.options=s,this.controlDisposer=void 0;const{toolId:r=Wk}=s;this.toolId=r;const{element:o}=this;o.style.display="contents";const{controls:l}=e;this.registerDisposer(l.changed.add(this.registerCancellable(ze(()=>this.updateControls(),0)))),this.updateControls()}updateControls(){const{element:e}=this;this.controlDisposer!==void 0&&(this.controlDisposer.dispose(),Fe(e));const t=this.controlDisposer=new K,n=()=>({shaderControlState:this.state,legendShaderOptions:this.options.legendShaderOptions});for(const s of this.state.state.keys())e.appendChild(Rv(t,this.layer,this.visibility,$k(n,this.toolId,s)))}disposed(){var e;(e=this.controlDisposer)==null||e.dispose(),super.disposed()}}const Wk="shaderControl",Hk="control";function zF(i,e){return{type:e,[Hk]:i}}class GF extends QE{constructor(e,t,n,s){super(e,$k(()=>t,n,s)),this.layerShaderControls=t,this.control=s,this.registerDisposer(t.shaderControlState.controls.changed.add(this.registerCancellable(ze(()=>{t.shaderControlState.state.get(s)===void 0&&this.unbind()}))))}activate(e){const{shaderControlState:t}=this.layerShaderControls;t.state.get(this.control)!==void 0&&super.activate(e)}}function Xh(i,e,t=Wk){Ji(i,t,(n,s)=>{const r=z(s,Hk,ie);return new GF(n,e(n),t,r)})}function Jk(i){return new qh({fragmentMain:i.displayState.skeletonRenderingOptions.shader,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState})}let $F=class extends ci{constructor(e){super(),this.layer=e;const{element:t}=this;t.classList.add("neuroglancer-segmentation-rendering-tab");{const s=this.registerDisposer(new Uw(e.displayState.linkedSegmentationGroup));s.label.textContent="Linked to: ",t.appendChild(s.element)}{const s=this.registerDisposer(new Uw(e.displayState.linkedSegmentationColorGroup));s.label.textContent="Colors linked to: ",t.appendChild(s.element)}for(const s of sT)t.appendChild(Rv(this,e,this.visibility,s));const n=this.registerDisposer(new Vn(e.hasSkeletonsLayer,(s,r,o)=>{if(!s)return;const l=document.createElement("div");l.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";const c=document.createElement("div");c.style.flex="1",c.textContent="Skeleton shader:",l.appendChild(c),l.appendChild(Yh({title:"Show larger editor view",onClick:()=>{new WF(this.layer)}})),l.appendChild(jh({title:"Documentation on skeleton rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),r.appendChild(l);const u=o.registerDisposer(Jk(this.layer));r.appendChild(u.element),r.appendChild(o.registerDisposer(new Kh(e.displayState.skeletonRenderingOptions.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,toolId:KE})).element),u.textEditor.refresh()},this.visibility));t.appendChild(n.element)}},WF=class extends Wc{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(Jk(this.layer)),this.content.classList.add("neuroglancer-segmentation-layer-skeleton-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};var HF=Object.defineProperty,JF=Object.getOwnPropertyDescriptor,jF=(i,e,t,n)=>{for(var s=n>1?void 0:n?JF(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&HF(e,t,s),s};let ac=class extends ph{constructor(){super(...arguments),this.hashTable=new Mv,this.changed=new Ze}get value(){return this}static makeWithCounterpart(i){const e=new ac;return e.initializeCounterpart(i),e}set_(i,e){return this.hashTable.set(i,e)}set(i,e){if(this.set_(i,e)){const{rpc:t}=this;t&&t.invoke("Uint64Map.set",{id:this.rpcId,key:i,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}get(i,e){return this.hashTable.get(i,e)}[Symbol.iterator](){return this.hashTable.entries()}unsafeEntries(){return this.hashTable.unsafeEntries()}delete_(i){return this.hashTable.delete(i)}delete(i){if(this.delete_(i)){const{rpc:e}=this;e&&e.invoke("Uint64Map.delete",{id:this.rpcId,key:i}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}assignFrom(i){this.clear();for(const[e,t]of i.unsafeEntries())this.set(e,t)}clear(){if(this.hashTable.clear()){const{rpc:i}=this;i&&i.invoke("Uint64Map.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){const i={};for(const[e,t]of this.hashTable.unsafeEntries())i[e.toString()]=t.toString();return i}};ac=jF([gh("Uint64Map")],ac);Rt("Uint64Map.set",function(i){const e=this.get(i.id);e.set_(i.key,i.value)&&e.changed.dispatch()});Rt("Uint64Map.delete",function(i){const e=this.get(i.id);e.delete_(i.key)&&e.changed.dispatch()});Rt("Uint64Map.clear",function(i){const e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});class YF{constructor(){this.changed=new Ze,this.data=new Map}dispose(){this.data.clear()}get size(){return this.data.size}get value(){return this}has(e){return this.data.has(BigInt(e.toString()))}add(e){const{data:t}=this;if(Array.isArray(e)){const n=[];for(let s of e){const r=BigInt(s.toString());t.has(r)||(s=s.clone(),n.push(s),t.set(r,s))}n.length!==0&&this.changed.dispatch(n,!0)}else{const n=BigInt(e.toString());if(t.has(n))return;t.set(n,e.clone()),this.changed.dispatch(e,!0)}}[Symbol.iterator](){return this.data.values()}delete(e){const{data:t}=this;if(Array.isArray(e)){const n=[];for(const s of e){const r=BigInt(s.toString());t.has(r)&&(t.delete(r),n.push(s))}n.length!==0&&this.changed.dispatch(n,!1)}else{const n=BigInt(e.toString());if(!t.has(n))return;t.delete(n),this.changed.dispatch(e,!1)}}set(e,t){t?this.add(e):this.delete(e)}clear(){this.data.size>0&&(this.data.clear(),this.changed.dispatch(null,!1))}toJSON(){return Array.from(this.data.keys(),e=>e.toString())}assignFrom(e){this.clear();const t=e.data,{data:n}=this,s=Array.from(t.values());for(const[r,o]of t)n.set(r,o);this.changed.dispatch(s,!0)}}var qF=Object.defineProperty,KF=Object.getOwnPropertyDescriptor,XF=(i,e,t,n)=>{for(var s=n>1?void 0:n?KF(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&qF(e,t,s),s};let lc=class extends ph{constructor(){super(...arguments),this.hashTable=new oT,this.changed=new Ze}get value(){return this}static makeWithCounterpart(i){const e=new lc;return e.initializeCounterpart(i),e}set(i,e){e?this.add(i):this.delete(i)}reserve_(i){return this.hashTable.reserve(i)}reserve(i){if(this.reserve_(i)){const{rpc:e}=this;e&&e.invoke("Uint64Set.reserve",{id:this.rpcId,value:i})}}add_(i){let e=!1;for(const t of i)e=this.hashTable.add(t)||e;return e}add(i){const e=Array().concat(i);if(this.add_(e)){const{rpc:t}=this;t&&t.invoke("Uint64Set.add",{id:this.rpcId,value:e}),this.changed.dispatch(i,!0)}}has(i){return this.hashTable.has(i)}[Symbol.iterator](){return this.hashTable.keys()}unsafeKeys(){return this.hashTable.unsafeKeys()}delete_(i){let e=!1;for(const t of i)e=this.hashTable.delete(t)||e;return e}delete(i){const e=Array().concat(i);if(this.delete_(Array().concat(i))){const{rpc:t}=this;t&&t.invoke("Uint64Set.delete",{id:this.rpcId,value:e}),this.changed.dispatch(i,!1)}}get size(){return this.hashTable.size}clear(){if(this.hashTable.clear()){const{rpc:i}=this;i&&i.invoke("Uint64Set.clear",{id:this.rpcId}),this.changed.dispatch(null,!1)}}toJSON(){const i=new Array;for(const e of this.unsafeKeys())i.push(e.toString());return i.sort(),i}assignFrom(i){this.clear();for(const e of i.unsafeKeys())this.add(e)}};lc=XF([gh("Uint64Set")],lc);Rt("Uint64Set.reserve",function(i){const e=this.get(i.id);e.reserve_(i.value)&&e.changed.dispatch()});Rt("Uint64Set.add",function(i){const e=this.get(i.id);e.add_(i.value)&&e.changed.dispatch()});Rt("Uint64Set.delete",function(i){const e=this.get(i.id);e.delete_(i.value)&&e.changed.dispatch()});Rt("Uint64Set.clear",function(i){const e=this.get(i.id);e.hashTable.clear()&&e.changed.dispatch()});class QF extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.localGraph=new LV,this.visibleSegments=this.registerDisposer(lc.makeWithCounterpart(this.layer.manager.rpc)),this.selectedSegments=this.registerDisposer(new YF),this.segmentPropertyMap=new Ne(void 0),this.graph=new Ne(void 0),this.segmentEquivalences=this.registerDisposer(to.makeWithCounterpart(this.layer.manager.rpc,this.layer.registerDisposer(Ht(r=>(r==null?void 0:r.visibleSegmentEquivalencePolicy)||An.MIN_REPRESENTATIVE,[this.graph])))),this.localSegmentEquivalences=!1,this.maxIdLength=new Ne(1),this.hideSegmentZero=new ut(!0,!0),this.segmentQuery=new bt("",ie),this.temporaryVisibleSegments=this.layer.registerDisposer(lc.makeWithCounterpart(this.layer.manager.rpc)),this.temporarySegmentEquivalences=this.layer.registerDisposer(to.makeWithCounterpart(this.layer.manager.rpc,this.segmentEquivalences.disjointSets.visibleSegmentEquivalencePolicy)),this.useTemporaryVisibleSegments=this.layer.registerDisposer(Tt.make(this.layer.manager.rpc,!1)),this.useTemporarySegmentEquivalences=this.layer.registerDisposer(Tt.make(this.layer.manager.rpc,!1));const{specificationChanged:t}=this;this.hideSegmentZero.changed.add(t.dispatch),this.segmentQuery.changed.add(t.dispatch);const{visibleSegments:n,selectedSegments:s}=this;n.changed.add(t.dispatch),s.changed.add(t.dispatch),s.changed.add((r,o)=>{o||(r?n.delete(r):n.clear())}),n.changed.add((r,o)=>{o&&r&&s.add(r)})}restoreState(e){oe(e,Gg,t=>this.hideSegmentZero.restoreState(t)),oe(e,Lu,t=>{this.localGraph.restoreState(t)}),oe(e,Sp,t=>{const{segmentEquivalences:n,selectedSegments:s,visibleSegments:r}=this;Ee(t,o=>{let l=String(o);const c=l.startsWith("!");c&&(l=l.substring(1));const u=X.parseString(l,10),h=n.get(u);s.add(h),c||r.add(h)})}),oe(e,zb,t=>this.segmentQuery.restoreState(t))}toJSON(){const e={};e[Gg]=this.hideSegmentZero.toJSON();const{selectedSegments:t,visibleSegments:n}=this;t.size>0?e[Sp]=[...t].map(r=>n.has(r)?r.toString():"!"+r.toString()):e[Sp]=[];const{segmentEquivalences:s}=this;return this.localSegmentEquivalences&&s.size>0&&(e[Lu]=s.toJSON()),e[zb]=this.segmentQuery.toJSON(),e}assignFrom(e){this.maxIdLength.value=e.maxIdLength.value,this.hideSegmentZero.value=e.hideSegmentZero.value,this.selectedSegments.assignFrom(e.selectedSegments),this.visibleSegments.assignFrom(e.visibleSegments),this.segmentEquivalences.assignFrom(e.segmentEquivalences)}}class ZF extends K{constructor(e){super(),this.layer=e,this.specificationChanged=new Ze,this.segmentColorHash=Ov.getDefault(),this.segmentStatedColors=this.registerDisposer(new ac),this.tempSegmentStatedColors2d=this.registerDisposer(new ac),this.segmentDefaultColor=new FA,this.tempSegmentDefaultColor2d=new Ne(void 0),this.highlightColor=new Ne(void 0);const{specificationChanged:t}=this;this.segmentColorHash.changed.add(t.dispatch),this.segmentStatedColors.changed.add(t.dispatch),this.tempSegmentStatedColors2d.changed.add(t.dispatch),this.segmentDefaultColor.changed.add(t.dispatch),this.tempSegmentDefaultColor2d.changed.add(t.dispatch),this.highlightColor.changed.add(t.dispatch)}restoreState(e){oe(e,Hg,t=>this.segmentColorHash.restoreState(t)),oe(e,qg,t=>this.segmentDefaultColor.restoreState(t)),oe(e,Ub,t=>{const n=Jl(t,s=>Ra(String(s)));for(const[s,r]of n){const o=X.parseString(String(s)),l=new X(da(r));this.segmentStatedColors.set(o,l)}})}toJSON(){const e={};e[Hg]=this.segmentColorHash.toJSON(),e[qg]=this.segmentDefaultColor.toJSON();const{segmentStatedColors:t}=this;if(t.size>0){const n=e[Ub]={};for(const[s,r]of t.unsafeEntries())n[s.toString()]=Pn(na(r.low))}return e}assignFrom(e){this.segmentColorHash.value=e.segmentColorHash.value,this.segmentStatedColors.assignFrom(e.segmentStatedColors),this.tempSegmentStatedColors2d.assignFrom(e.tempSegmentStatedColors2d),this.segmentDefaultColor.value=e.segmentDefaultColor.value,this.highlightColor.value=e.highlightColor.value}}class Jw extends K{constructor(e,t){super(),this.linkedGroup=e,this.propertyName=t,this.value}get changed(){return this.linkedGroup.root.changed}get value(){const e=this.linkedGroup.root.value;if(e!==this.curRoot){this.curRoot=e;const t=e.displayState[this.propertyName];if(e===this.linkedGroup.layer){const{curGroupState:n}=this;n!==void 0&&(t.assignFrom(n),n.dispose())}this.curGroupState=t.addRef()}return this.curGroupState}disposed(){var e;(e=this.curGroupState)==null||e.dispose()}}class eU{constructor(e){this.layer=e,this.segmentSelectionState=new M_,this.selectedAlpha=Ml(.5),this.saturation=Ml(1),this.notSelectedAlpha=Ml(0),this.hoverHighlight=new ut(!0,!0),this.silhouetteRendering=new bt(0,Dx,0),this.objectAlpha=Ml(1),this.ignoreNullVisibleSet=new ut(!0,!0),this.skeletonRenderingOptions=new RV,this.shaderError=Rc(),this.renderScaleHistogram=new Ea,this.renderScaleTarget=Qr(1),this.selectSegment=this.layer.selectSegment,this.transparentPickEnabled=this.layer.pick,this.baseSegmentColoring=new ut(!1,!1),this.baseSegmentHighlighting=new ut(!1,!1),this.useTempSegmentStatedColors2d=this.layer.registerDisposer(Tt.make(this.layer.manager.rpc,!1)),this.filterBySegmentLabel=this.layer.filterBySegmentLabel,this.moveToSegment=t=>{this.layer.moveToSegment(t)},this.linkedSegmentationGroup=this.layer.registerDisposer(new Fb(this.layer.manager.rootLayers,this.layer,t=>t instanceof En,t=>t.displayState.linkedSegmentationGroup)),this.linkedSegmentationColorGroup=this.layer.registerDisposer(new Fb(this.layer.manager.rootLayers,this.layer,t=>t instanceof En,t=>t.displayState.linkedSegmentationColorGroup)),this.originalSegmentationGroupState=this.layer.registerDisposer(new QF(this.layer)),this.originalSegmentationColorGroupState=this.layer.registerDisposer(new ZF(this.layer)),e.displayState=this,this.segmentationGroupState=this.layer.registerDisposer(new Jw(this.linkedSegmentationGroup,"originalSegmentationGroupState")),this.segmentationColorGroupState=this.layer.registerDisposer(new Jw(this.linkedSegmentationColorGroup,"originalSegmentationColorGroupState")),this.hideSegmentZero=this.layer.registerDisposer(new Hd(this.segmentationGroupState,t=>t.hideSegmentZero)),this.segmentColorHash=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.segmentColorHash)),this.segmentStatedColors=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.segmentStatedColors)),this.tempSegmentStatedColors2d=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.tempSegmentStatedColors2d)),this.segmentDefaultColor=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.segmentDefaultColor)),this.tempSegmentDefaultColor2d=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.tempSegmentDefaultColor2d)),this.highlightColor=this.layer.registerDisposer(new Wo(this.segmentationColorGroupState,t=>t.highlightColor)),this.segmentQuery=this.layer.registerDisposer(new Hd(this.segmentationGroupState,t=>t.segmentQuery)),this.segmentPropertyMap=this.layer.registerDisposer(new Hd(this.segmentationGroupState,t=>t.segmentPropertyMap))}}const tU=Xv(Li),$l=class $l extends tU{constructor(e){super(e),this.sliceViewRenderScaleHistogram=new Ea,this.sliceViewRenderScaleTarget=Qr(1),this.graphConnection=new Ne(void 0),this.segmentQueryFocusTime=new Ne(Number.NEGATIVE_INFINITY),this.selectSegment=(n,s)=>{this.manager.root.selectionState.captureSingleLayerState(this,r=>(r.value=n.clone(),!0),s)},this.filterBySegmentLabel=n=>{const s=eo(this.displayState,n),{label:r}=s;r&&this.filterSegments(r)},this.filterSegments=n=>{this.displayState.segmentationGroupState.value.segmentQuery.value=n,this.segmentQueryFocusTime.value=Date.now(),this.tabs.value="segments",this.manager.root.selectedLayer.layer=this.managedLayer},this.displayState=new eU(this),this.anchorSegment=new bt(void 0,n=>n===void 0?void 0:X.parseString(n)),this.has2dLayer=this.registerDisposer(ni(n=>n.some(s=>s instanceof kw),{changed:this.layersChanged,value:this.renderLayers})),this.has3dLayer=this.registerDisposer(ni(n=>n.some(s=>s instanceof dw||s instanceof kp||s instanceof Ap||s instanceof ww),{changed:this.layersChanged,value:this.renderLayers})),this.hasSkeletonsLayer=this.registerDisposer(ni(n=>n.some(s=>s instanceof Ap),{changed:this.layersChanged,value:this.renderLayers})),this.registerDisposer(ca((n,s)=>{n.registerDisposer(s.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationGroupState)),this.registerDisposer(ca((n,s)=>{n.registerDisposer(s.specificationChanged.add(this.specificationChanged.dispatch)),this.specificationChanged.dispatch()},this.displayState.segmentationColorGroupState)),this.displayState.segmentSelectionState.bindTo(this.manager.layerSelectedValues,this),this.displayState.selectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.saturation.changed.add(this.specificationChanged.dispatch),this.displayState.notSelectedAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.objectAlpha.changed.add(this.specificationChanged.dispatch),this.displayState.hoverHighlight.changed.add(this.specificationChanged.dispatch),this.displayState.baseSegmentColoring.changed.add(this.specificationChanged.dispatch),this.displayState.ignoreNullVisibleSet.changed.add(this.specificationChanged.dispatch),this.displayState.skeletonRenderingOptions.changed.add(this.specificationChanged.dispatch),this.displayState.renderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.silhouetteRendering.changed.add(this.specificationChanged.dispatch),this.anchorSegment.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.displayState.originalSegmentationGroupState.localGraph.changed.add(this.specificationChanged.dispatch),this.displayState.linkedSegmentationGroup.changed.add(()=>this.updateDataSubsourceActivations()),this.tabs.add("rendering",{label:"Render",order:-100,getter:()=>new $F(this)}),this.tabs.add("segments",{label:"Seg.",order:-50,getter:()=>new bF(this)});const t=this.registerDisposer(Ht(n=>n===void 0,[this.displayState.segmentationGroupState.value.graph]));this.tabs.add("graph",{label:"Graph",order:-25,getter:()=>new SV(this),hidden:t}),this.tabs.default="rendering"}bindSegmentListWidth(e){return rc(this.displayState,e)}get volumeOptions(){return{volumeType:At.SEGMENTATION}}activateDataSubsources(e){const t=[],n=this.displayState.linkedSegmentationGroup.root.value===this;let s;for(const r of e){if(this.addStaticAnnotations(r))continue;const{volume:o,mesh:l,segmentPropertyMap:c,segmentationGraph:u,local:h}=r.subsourceEntry.subsource;if(o instanceof di){switch(o.dataType){case J.FLOAT32:r.deactivate("Data type not compatible with segmentation layer");continue}r.activate(()=>r.addRenderLayer(new kw(o,{...this.displayState,transform:r.getRenderLayerTransform(),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition})),this.displayState.segmentationGroupState.value)}else l!==void 0?r.activate(()=>{const g={...this.displayState,transform:r.getRenderLayerTransform()};if(l instanceof fo)r.addRenderLayer(new dw(this.manager.chunkManager,l,g));else if(l instanceof Fh)r.addRenderLayer(new kp(this.manager.chunkManager,l,g));else{const v=new NV(this.manager.chunkManager,l,g);r.addRenderLayer(new Ap(v.addRef())),r.addRenderLayer(new ww(v))}},this.displayState.segmentationGroupState.value):c!==void 0?n?(r.activate(()=>{}),t.push(c)):r.deactivate("Not supported on non-root linked segmentation layers"):u!==void 0?n?s!==void 0?r.deactivate("Only one segmentation graph is supported"):(s=u,r.activate(g=>{const v=u.connect(this);g.registerDisposer(()=>{v.dispose(),this.graphConnection.value=void 0});const y={...this.displayState,transform:r.getRenderLayerTransform()},b=v.createRenderLayers(this.manager.chunkManager,y,this.localPosition);this.graphConnection.value=v;for(const w of b)r.addRenderLayer(w)})):r.deactivate("Not supported on non-root linked segmentation layers"):h===Ta.equivalences?n?s!==void 0?r.deactivate("Only one segmentation graph is supported"):(s=this.displayState.originalSegmentationGroupState.localGraph,r.activate(g=>{this.graphConnection.value=g.registerDisposer(s.connect(this)),g.registerDisposer(()=>{this.graphConnection.value=void 0})})):r.deactivate("Not supported on non-root linked segmentation layers"):r.deactivate("Not compatible with segmentation layer")}this.displayState.originalSegmentationGroupState.segmentPropertyMap.value=cV(this.manager.chunkManager,t),this.displayState.originalSegmentationGroupState.graph.value=s}getLegacyDataSourceSpecifications(e,t,n,s){const r=super.getLegacyDataSourceSpecifications(e,t,n,s),o=oe(t,AO,c=>c===null?null:ie(c)),l=oe(t,RO,c=>c===null?null:ie(c));if(o!==void 0||l!==void 0)for(const c of r)c.enableDefaultSubsources=!1,c.subsources=new Map([["default",{enabled:!0}],["bounds",{enabled:!0}]]);return o!=null&&r.push(Fl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:o,type:"mesh"}))),l!=null&&r.push(Fl(this.manager.dataSourceProviderRegistry.convertLegacyUrl({url:l,type:"skeletons"}))),t[Lu]!==void 0&&s.find(c=>c.url===Dg)===void 0&&r.push({url:Dg,enableDefaultSubsources:!0,transform:{outputSpace:pa,sourceRank:0,transform:void 0,inputSpace:pa},subsources:new Map}),r}restoreState(e){super.restoreState(e),this.displayState.selectedAlpha.restoreState(e[Vg]),this.displayState.saturation.restoreState(e[Ug]),this.displayState.notSelectedAlpha.restoreState(e[Bg]),this.displayState.hoverHighlight.restoreState(e[zg]),this.displayState.objectAlpha.restoreState(e[Fg]),this.displayState.baseSegmentColoring.restoreState(e[$g]),this.displayState.silhouetteRendering.restoreState(e[Yg]),this.displayState.ignoreNullVisibleSet.restoreState(e[Wg]);const{skeletonRenderingOptions:t}=this.displayState;t.restoreState(e[Du]);const n=e[NO];n!==void 0&&t.shader.restoreState(n),this.displayState.renderScaleTarget.restoreState(e[Jg]),this.anchorSegment.restoreState(e[Wb]),this.sliceViewRenderScaleTarget.restoreState(e[jg]);const s=oe(e,Gb,ie);s!==void 0&&this.displayState.linkedSegmentationGroup.linkByName(s);const r=oe(e,$b,o=>o===!1?void 0:ie(o),s);r!==void 0&&this.displayState.linkedSegmentationColorGroup.linkByName(r),this.displayState.segmentationGroupState.value.restoreState(e),this.displayState.segmentationColorGroupState.value.restoreState(e)}toJSON(){const e=super.toJSON();e[Vg]=this.displayState.selectedAlpha.toJSON(),e[Bg]=this.displayState.notSelectedAlpha.toJSON(),e[Ug]=this.displayState.saturation.toJSON(),e[Fg]=this.displayState.objectAlpha.toJSON(),e[zg]=this.displayState.hoverHighlight.toJSON(),e[$g]=this.displayState.baseSegmentColoring.toJSON(),e[Wg]=this.displayState.ignoreNullVisibleSet.toJSON(),e[Yg]=this.displayState.silhouetteRendering.toJSON(),e[Wb]=this.anchorSegment.toJSON(),e[Du]=this.displayState.skeletonRenderingOptions.toJSON(),e[Jg]=this.displayState.renderScaleTarget.toJSON(),e[jg]=this.sliceViewRenderScaleTarget.toJSON();const{linkedSegmentationGroup:t,linkedSegmentationColorGroup:n}=this.displayState;return e[Gb]=t.toJSON(),n.root.value!==t.root.value&&(e[$b]=n.toJSON()??!1),e[Lu]=this.displayState.originalSegmentationGroupState.localGraph.toJSON(),t.root.value===this&&Object.assign(e,this.displayState.segmentationGroupState.value.toJSON()),n.root.value===this&&Object.assign(e,this.displayState.segmentationColorGroupState.value.toJSON()),e}transformPickedValue(e){return e==null?e:wT(this.displayState,e,!0)}handleAction(e,t){switch(e){case"recolor":{this.displayState.segmentationColorGroupState.value.segmentColorHash.randomize();break}case"clear-segments":{if(!this.pick.value)break;this.displayState.segmentationGroupState.value.visibleSegments.clear();break}case"select":case"star":{if(!this.pick.value)break;const{segmentSelectionState:n}=this.displayState;if(n.hasSelectedSegment){const s=n.selectedSegment,r=this.displayState.segmentationGroupState.value,o=e==="select"?r.visibleSegments:r.selectedSegments,l=!o.has(s);(l||t.segmentationToggleSegmentState===void 0)&&(t.segmentationToggleSegmentState=l),t.defer(()=>{t.segmentationToggleSegmentState===l&&o.set(s,l)})}break}}}selectionStateFromJson(e,t){super.selectionStateFromJson(e,t);const n=new X;let{value:s}=e;typeof s=="number"&&(s=s.toString()),typeof s!="string"||!n.tryParseString(s)?e.value=void 0:e.value=n}selectionStateToJson(e,t){const n=super.selectionStateToJson(e,t),{value:s}=e;return s instanceof mr?t?n.value={key:s.key.toString(),value:s.value?s.value.toString():void 0,label:s.label}:n.value=(s.value||s.key).toString():s instanceof X&&(n.value=s.toString()),n}displaySegmentationSelection(e,t,n){const{value:s}=e;let r;if((typeof s=="number"||typeof s=="string")&&(r=new X,!r.tryParseString(s.toString())))return!1;if(s instanceof X)r=s.clone();else if(s instanceof mr)r=s.key.clone();else return!1;const{displayState:o}=this,l=eo(o,r),{segmentEquivalences:c,segmentPropertyMap:{value:u}}=this.displayState.segmentationGroupState.value,h=c.get(r),g=Bv(this.displayState,l);if(Ga(o,n,n.redraw),n.registerDisposer(rc(o,g)),g.classList.add("neuroglancer-selection-details-segment"),t.appendChild(g),u!==void 0){const{inlineProperties:v}=u.segmentPropertyMap;if(v!==void 0){const y=u.getSegmentInlineIndex(h);if(y!==-1){for(const b of v.properties)if(b.type!=="label"){if(b.type==="description"){const w=b.values[y];if(!w)continue;const C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-description"),C.textContent=w,t.appendChild(C)}else if(b.type==="number"||b.type==="string"){const w=b.values[y];if(b.type==="number"?Number.isNaN(w):!w)continue;const C=document.createElement("div");C.classList.add("neuroglancer-selection-details-segment-property");const E=document.createElement("div");E.classList.add("neuroglancer-selection-details-segment-property-name"),E.textContent=b.id,b.description&&(E.title=b.description);const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-segment-property-value"),k.textContent=w.toString(),C.appendChild(E),C.appendChild(k),t.appendChild(C)}}}}}return!0}displaySelectionState(e,t,n){let s=this.displaySegmentationSelection(e,t,n);return super.displaySelectionState(e,t,n)&&(s=!0),s}moveToSegment(e){for(const t of this.renderLayers){if(!(t instanceof kp))continue;const n=t.getObjectPosition(e);if(n!==void 0){this.setLayerPosition(t.displayState.transform.value,n);return}}Pe.showTemporaryMessage(`No position information loaded for segment ${e}`)}};$l.type="segmentation",$l.typeAbbreviation="seg",$l.supportsPickOption=!0;let En=$l;YO(En);lo(En);JE(At.SEGMENTATION,En);Nh(i=>{if(i.mesh!==void 0)return{layerConstructor:En,priority:1}});Xh(En,i=>({shaderControlState:i.displayState.skeletonRenderingOptions.shaderControlState}),KE);tF(En);KB(En);class nU extends K{constructor(e){super(),this.ref=e,this.element=document.createElement("label"),this.selectElement=document.createElement("select"),this.registerDisposer(e);const{element:t,selectElement:n}=this;t.appendChild(n),this.updateView(),this.registerEventListener(n,"change",()=>this.updateModel()),this.registerDisposer(this.ref.changed.add(ze(()=>this.updateView(),0)))}updateModel(){this.ref.layerName=this.selectElement.value||void 0}updateView(){const{selectElement:e,ref:t}=this,{filter:n}=t;Fe(e);const s=document.createElement("option");e.appendChild(s);for(const r of this.ref.layerManager.managedLayers)if(n(r)){const o=document.createElement("option"),{name:l}=r;o.textContent=l,o.value=l,e.appendChild(o)}e.value=t.layerName||""}}const iU="points",Mp="annotations",jw="annotationProperties",Yw="annotationRelationships",qw="crossSectionAnnotationSpacing",Kw="projectionAnnotationSpacing",Xw="shader",Qw="shaderControls";function sU(i,e){e!==void 0&&Ee(e,(t,n)=>{i.add({type:st.POINT,id:""+n,point:Mx(t),properties:[]})})}function rU(i){const e=i.layer;return e===null||e instanceof En}function oU(i){if(i===void 0)return null;const e=i.layer;return e===null||!(e instanceof En)?null:e.displayState}const Zw="linkedSegmentationLayer",eC="filterBySegmentation",tC="ignoreNullSegmentFilter";class aU extends K{constructor(e,t,n){super(),this.layerManager=e,this.annotationStates=t,this.annotationDisplayState=n,this.changed=new ue,this.curGeneration=-1,this.wasLoading=void 0,this.map=new Map,this.registerDisposer(t.changed.add(()=>this.update())),this.registerDisposer(t.isLoadingChanged.add(()=>this.update())),this.update()}update(){const e=this.annotationStates.changed.count,t=this.annotationStates.isLoading;if(this.curGeneration===e&&t===this.wasLoading)return;this.wasLoading=t,this.curGeneration=e;const{map:n}=this;let s=!1;for(const r of this.annotationStates.relationships){let o=n.get(r);o===void 0&&(o=this.addRelationship(r),s=!0),o.seenGeneration=e}if(!t){const{relationshipStates:r}=this.annotationDisplayState;for(const[o,l]of n)l.seenGeneration!==e&&(n.delete(o),r.delete(o),s=!0)}s&&this.changed.dispatch()}addRelationship(e){const t=this.annotationDisplayState.relationshipStates.get(e),n=new LO(this.layerManager.addRef(),rU);n.registerDisposer(n.changed.add(()=>{t.segmentationState.value=n.layerName===void 0?void 0:oU(n.layer)}));const{showMatches:s}=t,r={layerRef:n,showMatches:s,seenGeneration:-1};return n.changed.add(this.changed.dispatch),s.changed.add(this.changed.dispatch),this.map.set(e,r),r}get(e){return this.update(),this.map.get(e)}unbind(e){e.layerRef.changed.remove(this.changed.dispatch),e.showMatches.changed.remove(this.changed.dispatch)}reset(){for(const e of this.map.values())e.showMatches.reset()}toJSON(){const{map:e}=this;if(e.size===0)return{};let t;const n=[];for(const[s,r]of e){r.showMatches.value&&n.push(s);const{layerName:o}=r.layerRef;o!==void 0&&((t=t||{})[s]=o)}return n.sort(),{[Zw]:t,[eC]:n.length===0?void 0:n}}restoreState(e){const{isLoading:t}=this.annotationStates;oe(e,Zw,n=>{typeof n=="string"&&(n={segments:n}),ee(n);for(const s of Object.keys(n)){const r=ie(n[s]);let o=this.map.get(s);if(o===void 0){if(!t)continue;o=this.addRelationship(s)}o.layerRef.layerName=r}for(const[s,r]of this.map)Object.prototype.hasOwnProperty.call(n,s)||(r.layerRef.layerName=void 0)}),oe(e,eC,n=>{typeof n=="boolean"&&(n=n===!0?["segments"]:[]);for(const s of Zn(n)){let r=this.map.get(s);if(r===void 0){if(!t)continue;r=this.addRelationship(s)}r.showMatches.value=!0}})}disposed(){const{map:e}=this;for(const t of e.values())this.unbind(t);e.clear(),super.disposed()}}class lU extends K{constructor(e,t){super(),this.relationship=e,this.state=t,this.element=document.createElement("label"),this.seenGeneration=-1;const{element:n}=this,s=this.registerDisposer(new Es(t.showMatches)),r=new nU(t.layerRef);n.appendChild(s.element),n.appendChild(document.createTextNode(e)),n.appendChild(r.element)}}class cU extends K{constructor(e){super(),this.linkedSegmentationLayers=e,this.widgets=new Map,this.element=document.createElement("div"),this.element.style.display="contents";const t=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(this.linkedSegmentationLayers.annotationStates.changed.add(t)),this.updateView()}updateView(){const{linkedSegmentationLayers:e}=this,{annotationStates:t}=e,n=t.changed.count,{widgets:s}=this;function*r(){for(const o of t.relationships){let l=s.get(o);l===void 0&&(l=new lU(o,e.get(o))),l.seenGeneration=n,yield l.element}}for(const[o,l]of s)l.seenGeneration!==n&&(l.dispose(),s.delete(o));si(this.element,r.call(this))}disposed(){super.disposed();for(const e of this.widgets.values())e.dispose()}}const dU=Xv(Li),ih=class ih extends dU{constructor(e){super(e),this.localAnnotationsJson=void 0,this.pointAnnotationsJson=void 0,this.linkedSegmentationLayers=this.registerDisposer(new aU(this.manager.rootLayers,this.annotationStates,this.annotationDisplayState)),this.linkedSegmentationLayers.changed.add(this.specificationChanged.dispatch),this.annotationDisplayState.ignoreNullSegmentFilter.changed.add(this.specificationChanged.dispatch),this.annotationCrossSectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.annotationProjectionRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new hU(this)}),this.tabs.default="annotations"}disposed(){const{localAnnotations:e}=this;e!==void 0&&e.dispose(),super.disposed()}restoreState(e){super.restoreState(e),this.linkedSegmentationLayers.restoreState(e),this.localAnnotationsJson=e[Mp],this.localAnnotationProperties=oe(e,jw,Fx),this.localAnnotationRelationships=oe(e,Yw,Zn,["segments"]),this.pointAnnotationsJson=e[iU],this.annotationCrossSectionRenderScaleTarget.restoreState(e[qw]),this.annotationProjectionRenderScaleTarget.restoreState(e[Kw]),this.annotationDisplayState.ignoreNullSegmentFilter.restoreState(e[tC]),this.annotationDisplayState.shader.restoreState(e[Xw]),this.annotationDisplayState.shaderControls.restoreState(e[Qw])}getLegacyDataSourceSpecifications(e,t,n,s){if(Object.prototype.hasOwnProperty.call(t,"source"))return super.getLegacyDataSourceSpecifications(e,t,n,s);const r=oe(t,"voxelSize",l=>_e(new Float64Array(3),l,c=>wt(c)/1e9)),o=["m","m","m"];if(r!==void 0){const l=Ue({rank:3,units:o,scales:r,names:["x","y","z"]});n===void 0?n={outputSpace:l,sourceRank:3,transform:void 0,inputSpace:l}:n={...n,inputSpace:l}}return[{url:gE,transform:n,enableDefaultSubsources:!0,subsources:new Map}]}activateDataSubsources(e){let t=!1,n;for(const r of e){const{subsourceEntry:o}=r,{local:l}=o.subsource,c=h=>n!==void 0&&Qn(h)!==Qn(n)?(r.deactivate("Annotation properties are not compatible"),!1):(n=h,!0);if(l===Ta.annotations){if(t){r.deactivate("Only one local annotations source per layer is supported");continue}if(t=!0,!c(this.localAnnotationProperties??[]))continue;r.activate(h=>{const g=this.localAnnotations=new Ux(r.loadedDataSource.transform,this.localAnnotationProperties??[],this.localAnnotationRelationships);try{g.restoreState(this.localAnnotationsJson)}catch{}h.registerDisposer(()=>{g.dispose(),this.localAnnotations=void 0}),h.registerDisposer(this.localAnnotations.changed.add(this.specificationChanged.dispatch));try{sU(this.localAnnotations,this.pointAnnotationsJson)}catch{}this.pointAnnotationsJson=void 0,this.localAnnotationsJson=void 0;const v=new wu({localPosition:this.localPosition,transform:h.registerDisposer(o1(this.manager.root.coordinateSpace,this.localPosition.coordinateSpace,r.loadedDataSource.transform,void 0)),source:g.addRef(),displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:fr.ANNOTATION});this.addAnnotationLayerState(v,r)});continue}const{annotation:u}=o.subsource;if(u!==void 0){if(!c(u.properties))continue;r.activate(()=>{const h=new wu({localPosition:this.localPosition,transform:r.getRenderLayerTransform(),source:u,displayState:this.annotationDisplayState,dataSource:r.loadedDataSource.layerDataSource,subsourceIndex:r.subsourceIndex,subsourceId:o.id,role:fr.ANNOTATION});this.addAnnotationLayerState(h,r)});continue}r.deactivate("Not compatible with annotation layer")}const s=this.annotationDisplayState.annotationProperties.value;Qn(s)!==Qn(n)&&(this.annotationDisplayState.annotationProperties.value=n)}initializeAnnotationLayerViewTab(e){const t=e.registerDisposer(ni(s=>s.some(r=>r.source instanceof Bc),this.annotationStates)),n=e.registerDisposer(new Vn(t,(s,r,o)=>{if(s){{const l=o.registerDisposer(new Pu(this.annotationCrossSectionRenderScaleHistogram,this.annotationCrossSectionRenderScaleTarget));l.label.textContent="Spacing (cross section)",r.appendChild(l.element)}{const l=o.registerDisposer(new Pu(this.annotationProjectionRenderScaleHistogram,this.annotationProjectionRenderScaleTarget));l.label.textContent="Spacing (projection)",r.appendChild(l.element)}}}));e.element.insertBefore(n.element,e.element.firstChild);{const s=e.registerDisposer(new Es(this.annotationDisplayState.ignoreNullSegmentFilter)),r=document.createElement("label");r.appendChild(document.createTextNode("Ignore null related segment filter")),r.title="Display all annotations if filtering by related segments is enabled but no segments are selected",r.appendChild(s.element),e.element.appendChild(r)}e.element.appendChild(e.registerDisposer(new cU(this.linkedSegmentationLayers)).element)}toJSON(){const e=super.toJSON();e[qw]=this.annotationCrossSectionRenderScaleTarget.toJSON(),e[Kw]=this.annotationProjectionRenderScaleTarget.toJSON(),this.localAnnotations!==void 0?e[Mp]=this.localAnnotations.toJSON():this.localAnnotationsJson!==void 0&&(e[Mp]=this.localAnnotationsJson),e[jw]=pR(this.localAnnotationProperties);const{localAnnotationRelationships:t}=this;return e[Yw]=t.length===1&&t[0]==="segments"?void 0:t,e[tC]=this.annotationDisplayState.ignoreNullSegmentFilter.toJSON(),e[Xw]=this.annotationDisplayState.shader.toJSON(),e[Qw]=this.annotationDisplayState.shaderControls.toJSON(),Object.assign(e,this.linkedSegmentationLayers.toJSON()),e}};ih.type="annotation",ih.typeAbbreviation="ann";let no=ih;function jk(i){return new qh({shaderError:i.annotationDisplayState.shaderError,fragmentMain:i.annotationDisplayState.shader,shaderControlState:i.annotationDisplayState.shaderControls})}let uU=class extends Wc{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(jk(this.layer)),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}},hU=class extends ci{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(jk(this.layer));const{element:t}=this;t.classList.add("neuroglancer-annotation-rendering-tab"),t.appendChild(this.registerDisposer(new Vn(e.annotationDisplayState.annotationProperties,(r,o)=>{if(r===void 0||r.length===0)return;const l=document.createElement("div");o.appendChild(l),l.classList.add("neuroglancer-annotation-shader-property-list");for(const c of r){const u=document.createElement("div");u.classList.add("neuroglancer-annotation-shader-property");const h=document.createElement("span");h.classList.add("neuroglancer-annotation-shader-property-type"),h.textContent=c.type;const g=document.createElement("span");g.classList.add("neuroglancer-annotation-shader-property-identifier"),g.textContent=`prop_${c.identifier}`,u.appendChild(h),u.appendChild(g);const{description:v}=c;v!==void 0&&(u.title=v),l.appendChild(u)}})).element);const n=document.createElement("div");n.className="neuroglancer-segmentation-dropdown-skeleton-shader-header";const s=document.createElement("div");s.style.flex="1",s.textContent="Annotation shader:",n.appendChild(s),n.appendChild(Yh({title:"Show larger editor view",onClick:()=>{new uU(this.layer)}})),n.appendChild(jh({title:"Documentation on annotation rendering",href:"https://github.com/google/neuroglancer/blob/master/src/annotation/rendering.md"})),t.appendChild(n),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Kh(e.annotationDisplayState.shaderControls,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}};lo(no);lo(no,"pointAnnotation");Nh(i=>{if(i.local===Ta.annotations)return{layerConstructor:no,priority:100};if(i.annotation!==void 0)return{layerConstructor:no,priority:1}});Xh(no,i=>({shaderControlState:i.annotationDisplayState.shaderControls}));var sy=(i=>(i[i.DEFAULT=0]="DEFAULT",i[i.ADDITIVE=1]="ADDITIVE",i))(sy||{});const fU=new Map([[0,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA)}],[1,i=>{i.blendFunc(i.SRC_ALPHA,i.ONE)}]]);function pU(i=0){return new Uc(sy,i)}const Yk=`#uicontrol invlerp normalized
void main() {
  emitGrayscale(normalized());
}
`;function gU(i=Yk){return vh(i)}function qk(i,e){i.addFragmentCode(`
#define VOLUME_RENDERING false

void emitRGBA(vec4 rgba) {
  emit(vec4(rgba.rgb, rgba.a * uOpacity));
}
void emitRGB(vec3 rgb) {
  emit(vec4(rgb, uOpacity));
}
void emitGrayscale(float value) {
  emit(vec4(value, value, value, uOpacity));
}
void emitTransparent() {
  emit(vec4(0.0, 0.0, 0.0, 0.0));
}
`),i.addFragmentCode(wa),ba(e,i),i.setFragmentMainFunction(ma(e.parseResult.code))}class mU extends jT{constructor(e,t){var o,l;const{opacity:n,blendMode:s,shaderControlState:r}=t;super(e,{...t,fallbackShaderParameters:new Ne(wh(Mc(Yk,{imageData:{dataType:e.dataType,channelRank:((l=(o=t.channelCoordinateSpace)==null?void 0:o.value)==null?void 0:l.rank)??0}}))),encodeShaderParameters:c=>c.key,shaderParameters:r.builderState,dataHistogramSpecifications:r.histogramSpecifications}),this.shaderControlState=r,this.opacity=n,this.blendMode=s,this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(s.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(r.changed.add(this.redrawNeeded.dispatch))}defineShader(e,t){if(t.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");e.addUniform("highp float","uOpacity"),qk(e,t)}initializeShader(e,t,n){const{gl:s}=this;s.uniform1f(t.uniform("uOpacity"),this.opacity.value),Xr(s,t,this.shaderControlState,n.parseResult.controls)}setGLBlendMode(e,t){const n=this.blendMode.value;n===sy.ADDITIVE||t>0?(e.enable(e.BLEND),fU.get(n)(e)):e.disable(WebGL2RenderingContext.BLEND)}}function vU(i=1){return new bt(i,Xe)}const yU="volume_rendering/VolumeRenderingRenderLayer",SU="volume_rendering/VolumeRenderingRenderLayer/update",bU=Dc();function wU(i,e,t){let n=0,s=0;for(let u=0;u<3;++u){const h=i[16+u],g=h*e[u],v=h*t[u];n+=Math.min(g,v),s+=Math.max(g,v)}const r=-i[19],o=Math.max(r,n),l=i[23],c=Math.min(l,s);return{near:r,far:l,adjustedNear:o,adjustedFar:c}}function nC(i,e,t,n,s,r){if(n.length===0)return;const{viewMatrix:o,projectionMat:l,displayDimensionRenderInfo:c}=i,{voxelPhysicalScales:u}=c,h=ig(u),g=Ex(l),y=(g/t)**3,b=zm(ch(bU,o)),w={spatialScales:new Map,activeIndex:-1},C=P=>{const O=n[P];return Math.abs(O.chunkLayout.detTransform*b)};let E=n.length-1,k=C(E);for(let P=E;P>=0;--P){const O=C(P),_=Math.cbrt(O*h/b),W=g/Math.cbrt(O);w.spatialScales.set(_,W),O-y>=0&&(k=O,E=P),w.activeIndex=E}const D=Math.cbrt(k*h/b),A=g/Math.cbrt(k);let N=!0;const I=n[E];Q1(i,e,I,(P,O)=>{N&&(s(I,E,D,A,O,w),N=!1),r(I,E,P)})}const CU=64,iC=1,xU=10,Op=Symbol("depthSamplerTextureUnit"),EU=`
void emitRGBA(vec4 rgba) {
  float correctedAlpha = clamp(rgba.a * uBrightnessFactor * uGain, 0.0, 1.0);
  float weightedAlpha = correctedAlpha * computeOITWeight(correctedAlpha, depthAtRayPosition);
  outputColor += vec4(rgba.rgb * weightedAlpha, weightedAlpha);
  revealage *= 1.0 - correctedAlpha;
}
`,TU=Ve(),kU=new Float32Array(24);function Kk(){const i=Math.round(iC+xt*_c);return[iC,i]}function sC(i){const e=Kk(),t=[2**e[0],2**e[1]-1];return jr(t,Math.round(i))}class LU extends co{get gl(){return this.multiscaleSource.chunkManager.gl}get isTransparent(){return!0}get isVolumeRendering(){return!0}constructor(e){super(),this.gain=e.gain,this.multiscaleSource=e.multiscaleSource,this.transform=e.transform,this.channelCoordinateSpace=e.channelCoordinateSpace,this.shaderControlState=e.shaderControlState,this.localPosition=e.localPosition,this.depthSamplesTarget=e.depthSamplesTarget,this.chunkResolutionHistogram=e.chunkResolutionHistogram,this.registerDisposer(this.chunkResolutionHistogram.visibility.add(this.visibility));const t=this.registerDisposer(Ht(o=>o.rank,[this.channelCoordinateSpace]));this.shaderGetter=dv(this,this.gl,{memoizeKey:"VolumeRenderingRenderLayer",parameters:e.shaderControlState.builderState,getContextKey:({emitter:o,chunkFormat:l,wireFrame:c})=>`${jt(o)}:${l.shaderKey}:${c}`,shaderError:e.shaderError,extraParameters:t,defineShader:(o,{emitter:l,chunkFormat:c,wireFrame:u},h,g)=>{if(h.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");vr(o),o.addFragmentCode(`
#define VOLUME_RENDERING true
`),l(o),o.addUniform("highp float","uNearLimitFraction"),o.addUniform("highp float","uFarLimitFraction"),o.addUniform("highp int","uMaxSteps"),o.addUniform("highp vec3","uTranslation"),o.addUniform("highp mat4","uModelViewProjectionMatrix"),o.addUniform("highp mat4","uInvModelViewProjectionMatrix"),o.addUniform("highp vec3","uChunkDataSize"),o.addUniform("highp float","uChunkNumber"),o.addUniform("highp vec3","uLowerClipBound"),o.addUniform("highp vec3","uUpperClipBound"),o.addUniform("highp float","uBrightnessFactor"),o.addUniform("highp float","uGain"),o.addVarying("highp vec4","vNormalizedPosition"),o.addTextureSampler("sampler2D","uDepthSampler",Op),o.addVertexCode(iB),o.setVertexMain(`
vec3 boxVertex = getBoxFaceVertexPosition(gl_VertexID);
vec3 position = max(uLowerClipBound, min(uUpperClipBound, uTranslation + boxVertex * uChunkDataSize));
vNormalizedPosition = gl_Position = uModelViewProjectionMatrix * vec4(position, 1.0);
gl_Position.z = 0.0;
`),o.addFragmentCode(`
vec3 curChunkPosition;
float depthAtRayPosition;
vec4 outputColor;
float revealage;
void userMain();
`),$T(o,c,g,"curChunkPosition"),o.addFragmentCode([EU,`
void emitRGB(vec3 rgb) {
  emitRGBA(vec4(rgb, 1.0));
}
void emitGrayscale(float value) {
  emitRGBA(vec4(value, value, value, value));
}
void emitTransparent() {
  emitRGBA(vec4(0.0, 0.0, 0.0, 0.0));
}
float computeDepthFromClipSpace(vec4 clipSpacePosition) {
  float NDCDepthCoord = clipSpacePosition.z / clipSpacePosition.w;
  return (NDCDepthCoord + 1.0) * 0.5;
}
vec2 computeUVFromClipSpace(vec4 clipSpacePosition) {
  vec2 NDCPosition = clipSpacePosition.xy / clipSpacePosition.w;
  return (NDCPosition + 1.0) * 0.5;
}
`]),u?o.setFragmentMainFunction(`
void main() {
  outputColor = vec4(uChunkNumber, uChunkNumber, uChunkNumber, 1.0);
  emit(outputColor, 0u);
}
`):o.setFragmentMainFunction(`
void main() {
  vec2 normalizedPosition = vNormalizedPosition.xy / vNormalizedPosition.w;
  vec4 nearPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, -1.0, 1.0);
  vec4 farPointH = uInvModelViewProjectionMatrix * vec4(normalizedPosition, 1.0, 1.0);
  vec3 nearPoint = nearPointH.xyz / nearPointH.w;
  vec3 farPoint = farPointH.xyz / farPointH.w;
  vec3 rayVector = farPoint - nearPoint;
  vec3 boxStart = max(uLowerClipBound, uTranslation);
  vec3 boxEnd = min(boxStart + uChunkDataSize, uUpperClipBound);
  float intersectStart = uNearLimitFraction;
  float intersectEnd = uFarLimitFraction;
  for (int i = 0; i < 3; ++i) {
    float startPt = nearPoint[i];
    float endPt = farPoint[i];
    float boxLower = boxStart[i];
    float boxUpper = boxEnd[i];
    float r = rayVector[i];
    float startFraction;
    float endFraction;
    if (startPt >= boxLower && startPt <= boxUpper) {
      startFraction = 0.0;
    } else {
      startFraction = min((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    if (endPt >= boxLower && endPt <= boxUpper) {
      endFraction = 1.0;
    } else {
      endFraction = max((boxLower - startPt) / r, (boxUpper - startPt) / r);
    }
    intersectStart = max(intersectStart, startFraction);
    intersectEnd = min(intersectEnd, endFraction);
  }
  float stepSize = (uFarLimitFraction - uNearLimitFraction) / float(uMaxSteps - 1);
  int startStep = int(floor((intersectStart - uNearLimitFraction) / stepSize));
  int endStep = min(uMaxSteps, int(floor((intersectEnd - uNearLimitFraction) / stepSize)) + 1);
  outputColor = vec4(0, 0, 0, 0);
  revealage = 1.0;
  for (int step = startStep; step < endStep; ++step) {
    vec3 position = mix(nearPoint, farPoint, uNearLimitFraction + float(step) * stepSize);
    vec4 clipSpacePosition = uModelViewProjectionMatrix * vec4(position, 1.0);
    depthAtRayPosition = computeDepthFromClipSpace(clipSpacePosition);
    vec2 uv = computeUVFromClipSpace(clipSpacePosition);
    float depthInBuffer = texture(uDepthSampler, uv).r;
    bool rayPositionBehindOpaqueObject = (1.0 - depthAtRayPosition) < depthInBuffer;
    if (rayPositionBehindOpaqueObject) {
      break;
    }
    curChunkPosition = position - uTranslation;
    userMain();
  }
  emitAccumAndRevealage(outputColor, 1.0 - revealage, 0u);
}
`),o.addFragmentCode(wa),ba(h,o),o.addFragmentCode(`
#define main userMain
`+ma(h.parseResult.code)+`
#undef main
`)}}),this.vertexIdHelper=this.registerDisposer(Is.get(this.gl)),this.registerDisposer(this.depthSamplesTarget.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.gain.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.localPosition.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.transform.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(this.shaderControlState.fragmentMain.changed.add(this.redrawNeeded.dispatch));const{chunkManager:n}=this.multiscaleSource,s=this.registerDisposer(new Oc(this.layerChunkProgressInfo)),r=n.rpc;s.RPC_TYPE_ID=yU,s.initializeCounterpart(r,{chunkManager:n.rpcId,localPosition:this.registerDisposer(Tt.makeFromExisting(r,this.localPosition)).rpcId,renderScaleTarget:this.registerDisposer(Tt.makeFromExisting(r,this.depthSamplesTarget)).rpcId}),this.backend=s}get dataType(){return this.multiscaleSource.dataType}attach(e){super.attach(e),e.state={sources:e.registerDisposer(Ti((t,n,s)=>{const r=Dh(s,n,o=>this.multiscaleSource.getSources(o),e.messages,this);for(const o of r)for(const l of o)t.registerDisposer(l.source);return e.view.flushBackendProjectionParameters(),this.backend.rpc.invoke(SU,{layer:this.backend.rpcId,view:e.view.rpcId,sources:Lh(r)}),this.redrawNeeded.dispatch(),r},this.transform,e.view.displayDimensionRenderInfo))}}get chunkManager(){return this.multiscaleSource.chunkManager}draw(e,t){if(!e.emitColor)return;const n=t.state.sources.value;if(n.length===0)return;let s=0,r=0,o={spatialScales:new Map,activeIndex:0},l=null,c,u;const h=we(),{gl:g}=this;this.vertexIdHelper.enable();const{chunkResolutionHistogram:v}=this;v.begin(this.chunkManager.chunkQueueManager.frameNumberCounter.frameNumber);const y=()=>{if(l===null)return;c!==null&&c.endDrawing(g,l);const P=l.textureUnit(Op);if(g.activeTexture(WebGL2RenderingContext.TEXTURE0+P),g.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null),E!==0||k!==0){let O=o.spatialScales.size-1;const _=new Set([sC(r)]);o.spatialScales.forEach((W,U)=>{const j=sC(W);O!==o.activeIndex&&!_.has(j)&&(v.add(U,W,0,xU,!0),_.add(j)),O--}),v.add(s,r,E,k)}};let b=!0;const{projectionParameters:w}=e;let C,E=0,k=0,D,A=1;const N=this.multiscaleSource.rank,I=we();g.enable(WebGL2RenderingContext.CULL_FACE),g.cullFace(WebGL2RenderingContext.FRONT),nC(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,n[0],(P,O,_,W,U,j)=>{s=_,r=W,o=j;const B=vv(w,P.chunkLayout),H=P.source,{fixedPositionWithinChunk:V,chunkDisplayDimensionIndices:re}=P;for(const Ce of re)V[Ce]=0;const se=H.chunkFormat;if(se!==c&&(c=se,y(),u=this.shaderGetter({emitter:e.emitter,chunkFormat:se,wireFrame:e.wireFrame}),l=u.shader,l!==null&&(l.bind(),se!==null))){if(Xr(g,l,this.shaderControlState,u.parameters.parseResult.controls),e.depthBufferTexture!==void 0&&e.depthBufferTexture!==null){const Ce=l.textureUnit(Op);g.activeTexture(WebGL2RenderingContext.TEXTURE0+Ce),g.bindTexture(WebGL2RenderingContext.TEXTURE_2D,e.depthBufferTexture)}else throw new Error("Depth buffer texture ID for volume rendering is undefined or null");se.beginDrawing(g,l),se.beginSource(g,l)}if(D=void 0,l===null)return;C=H.chunks,h.fill(1);const ve=zt(TU,w.viewProjectionMat,B.transform);g.uniformMatrix4fv(l.uniform("uModelViewProjectionMatrix"),!1,ve);const me=kU;lu(me,ve),ur(ve,ve),g.uniformMatrix4fv(l.uniform("uInvModelViewProjectionMatrix"),!1,ve);const{near:Ie,far:We,adjustedNear:tt,adjustedFar:rt}=wU(me,P.lowerClipDisplayBound,P.upperClipDisplayBound),nt=W,Ge=this.depthSamplesTarget.value,Te=nt/Ge;g.uniform1f(l.uniform("uBrightnessFactor"),Te);const Se=(tt-Ie)/(We-Ie),ge=(rt-Ie)/(We-Ie);g.uniform1f(l.uniform("uNearLimitFraction"),Se),g.uniform1f(l.uniform("uFarLimitFraction"),ge),g.uniform1f(l.uniform("uGain"),Math.exp(this.gain.value)),g.uniform1i(l.uniform("uMaxSteps"),this.depthSamplesTarget.value),g.uniform3fv(l.uniform("uLowerClipBound"),P.lowerClipDisplayBound),g.uniform3fv(l.uniform("uUpperClipBound"),P.upperClipDisplayBound)},P=>{if(l===null)return;const O=P.curPositionInChunks.join(),_=C.get(O);if(_!==void 0&&_.state===je.GPU_MEMORY){const W=P.chunkLayout.size,U=_.chunkDataSize,{chunkDisplayDimensionIndices:j,fixedPositionWithinChunk:B,chunkTransform:{channelToChunkDimensionIndices:H}}=P;if(e.wireFrame){const re=A/C.size;g.uniform1f(l.uniform("uChunkNumber"),re),++A}if(U!==D){D=U;for(let re=0;re<3;++re){const se=j[re];h[re]=se===-1||se>=N?1:D[se]}g.uniform3fv(l.uniform("uChunkDataSize"),h)}const{chunkGridPosition:V}=_;for(let re=0;re<3;++re){const se=j[re];I[re]=se===-1||se>=N?0:W[re]*V[se]}c!=null&&c.bindChunk(g,l,_,B,j,H,b),b=!1,g.uniform3fv(l.uniform("uTranslation"),I),sB(g,1,1),++E}else++k}),g.disable(WebGL2RenderingContext.CULL_FACE),y(),this.vertexIdHelper.disable()}isReady(e,t){const n=t.state.sources.value;if(n.length===0)return!0;let s=!1;return nC(e.projectionParameters,this.localPosition.value,this.depthSamplesTarget.value,n[0],()=>{},r=>{const o=r.source.chunks.get(r.curPositionInChunks.join());(o===void 0||o.state!==je.GPU_MEMORY)&&(s=!0)}),s}}const DU=He.fromObject({arrowup:{action:"tab-backward"},arrowdown:{action:"tab-forward"},tab:{action:"tab-forward"},"shift+tab":{action:"tab-backward"},enter:{action:"commit"},escape:{action:"cancel"}});class IU{constructor(e){this.id=e,this.element=document.createElement("div"),this.nameContainer=document.createElement("div"),this.nameElement=document.createElement("input"),this.lowerElement=document.createElement("div"),this.upperElement=document.createElement("div");const{element:t,nameContainer:n,nameElement:s,lowerElement:r,upperElement:o}=this;t.classList.add("neuroglancer-channel-dimensions-widget-dim"),n.classList.add("neuroglancer-channel-dimensions-widget-name-container"),s.classList.add("neuroglancer-channel-dimensions-widget-name"),n.appendChild(s),r.classList.add("neuroglancer-channel-dimensions-widget-lower"),o.classList.add("neuroglancer-channel-dimensions-widget-upper"),t.appendChild(n),t.appendChild(r),t.appendChild(o),n.draggable=!0,s.disabled=!0,s.spellcheck=!1,s.autocomplete="off",s.required=!0,s.placeholder=" ",n.title="Drag to reorder, double click to rename.  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",n.addEventListener("dblclick",()=>{s.disabled=!1,s.focus(),s.select()}),s.addEventListener("focus",()=>{s.select()})}}class PU extends K{constructor(e){super(),this.combiner=e,this.element=document.createElement("div"),this.dimensionWidgets=[],this.curCoordinateSpace=void 0,this.dragSource=void 0,this.coordinateSpace=this.combiner.combined;const{element:t}=this;t.classList.add("neuroglancer-channel-dimensions-widget");const n=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(e.combined.changed.add(n));const s=this.registerDisposer(new Pi(t,DU));s.allShortcutsAreGlobal=!0,this.registerDisposer(fe(t,"cancel",r=>{this.forceUpdateView();const{target:o}=r;o instanceof HTMLElement&&o.blur()})),this.updateView()}reorderDimensionTo(e,t){if(e===t)return;const{coordinateSpace:n}=this;n.value=r1(n.value,e,t)}makeNewDimensionWidget(e){const t=new IU(e);return t.nameContainer.addEventListener("dragstart",n=>{this.dragSource=t,n.stopPropagation(),n.dataTransfer.setData("neuroglancer-dimension","")}),t.nameContainer.addEventListener("dragenter",n=>{const{dragSource:s}=this;if(s===void 0||s===t)return;const{dimensionWidgets:r}=this,o=r.indexOf(s),l=r.indexOf(t);o===-1||l===-1||(n.preventDefault(),this.reorderDimensionTo(l,o))}),t.nameContainer.addEventListener("dragend",n=>{this.dragSource===t&&(this.dragSource=void 0)}),t.nameElement.addEventListener("blur",n=>{t.nameElement.disabled=!0;const{relatedTarget:s}=n;this.dimensionWidgets.some(r=>r.nameElement===s)||this.updateNames()||this.forceUpdateView()}),t.nameElement.addEventListener("input",()=>{const{nameElement:n}=t;Dn(n),this.updateNameValidity()}),fe(t.nameElement,"commit",()=>{this.updateNames()}),fe(t.nameElement,"tab-forward",n=>this.selectAdjacentField(n,t,1)),fe(t.nameElement,"tab-backward",n=>this.selectAdjacentField(n,t,-1)),t}selectAdjacentField(e,t,n){e.stopPropagation();const{dimensionWidgets:s}=this,r=s.indexOf(t);if(r===-1)return;const o=r+n;if(o<0||o>=s.length)return;const l=s[o];l.nameElement.disabled=!1,l.nameElement.focus(),e.preventDefault()}updateNames(){const{dimensionWidgets:e,coordinateSpace:t}=this,n=t.value,s=e.map(c=>c.nameElement.value);if(this.combiner.getRenameValidity(s).includes(!1))return!1;const r=n.names;if(De(r,s))return!1;const o=n.timestamps.map((c,u)=>r[u]===s[u]?c:Date.now()),l={...n,names:s,timestamps:o};return t.value=l,!0}updateNameValidity(){const{dimensionWidgets:e}=this,t=e.map(r=>r.nameElement.value),n=t.length,s=this.combiner.getRenameValidity(t);for(let r=0;r<n;++r)e[r].nameElement.dataset.isValid=s[r]===!1?"false":"true"}forceUpdateView(){this.curCoordinateSpace=void 0,this.updateView()}updateView(){const{coordinateSpace:{value:e}}=this;if(this.curCoordinateSpace===e)return;this.curCoordinateSpace=e;const{element:t}=this,n=this.dimensionWidgets,s=this.dimensionWidgets=e.ids.map(o=>n.find(l=>l.id===o)||this.makeNewDimensionWidget(o));function*r(){const{names:o,rank:l,bounds:c}=e;for(let u=0;u<l;++u){const h=s[u];h.nameElement.value=o[u],h.nameElement.dataset.isValid=void 0,Dn(h.nameElement);const[g,v]=Yx(c,u);h.lowerElement.textContent=g.toString(),h.upperElement.textContent=v.toString(),yield h.element}}si(t,r.call(this))}}const lm="opacity",cm="blend",rC="shader",oC="shaderControls",dm="crossSectionRenderScale",aC="channelDimensions",um="volumeRendering",hm="volumeRenderingGain",fm="volumeRenderingDepthSamples",AU=Xv(Li),[lC,RU]=Kk(),sh=class sh extends AU{constructor(e){super(e),this.opacity=Ml(.5),this.blendMode=pU(),this.fragmentMain=gU(),this.shaderError=Rc(),this.dataType=new Ne(void 0),this.sliceViewRenderScaleHistogram=new Ea,this.sliceViewRenderScaleTarget=Qr(1),this.volumeRenderingGain=vU(0),this.volumeRenderingChunkResolutionHistogram=new Ea(lC),this.volumeRenderingDepthSamplesTarget=Qr(CU,2**lC,2**RU-1),this.channelCoordinateSpace=new nv,this.channelCoordinateSpaceCombiner=new ov(this.channelCoordinateSpace,WR),this.channelSpace=this.registerDisposer(ni(t=>mh(()=>QR(t)),this.channelCoordinateSpace)),this.volumeRendering=new ut(!1,!1),this.shaderControlState=this.registerDisposer(new Ch(this.fragmentMain,this.registerDisposer(Ht((t,n)=>t===void 0?null:{imageData:{dataType:t,channelRank:n.rank}},[this.dataType,this.channelCoordinateSpace],(t,n)=>JSON.stringify(t)===JSON.stringify(n))),this.channelCoordinateSpaceCombiner)),this.localCoordinateSpaceCombiner.includeDimensionPredicate=Vl,this.blendMode.changed.add(this.specificationChanged.dispatch),this.opacity.changed.add(this.specificationChanged.dispatch),this.volumeRenderingGain.changed.add(this.specificationChanged.dispatch),this.fragmentMain.changed.add(this.specificationChanged.dispatch),this.shaderControlState.changed.add(this.specificationChanged.dispatch),this.sliceViewRenderScaleTarget.changed.add(this.specificationChanged.dispatch),this.volumeRendering.changed.add(this.specificationChanged.dispatch),this.volumeRenderingDepthSamplesTarget.changed.add(this.specificationChanged.dispatch),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new NU(this)}),this.tabs.default="rendering"}markLoading(){const e=super.markLoading(),t=this.channelCoordinateSpaceCombiner.retain();return()=>{e(),t()}}addCoordinateSpace(e){const t=super.addCoordinateSpace(e),n=this.channelCoordinateSpaceCombiner.bind(e);return()=>{t(),n()}}activateDataSubsources(e){let t;for(const n of e){if(this.addStaticAnnotations(n))continue;const{subsourceEntry:s}=n,{subsource:r}=s,{volume:o}=r;if(!(o instanceof di)){n.deactivate("Not compatible with image layer");continue}if(t&&o.dataType!==t){n.deactivate(`Data type must be ${J[o.dataType].toLowerCase()}`);continue}t=o.dataType,n.activate(l=>{n.addRenderLayer(new mU(o,{opacity:this.opacity,blendMode:this.blendMode,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),renderScaleTarget:this.sliceViewRenderScaleTarget,renderScaleHistogram:this.sliceViewRenderScaleHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));const c=l.registerDisposer(new LU({gain:this.volumeRenderingGain,multiscaleSource:o,shaderControlState:this.shaderControlState,shaderError:this.shaderError,transform:n.getRenderLayerTransform(this.channelCoordinateSpace),depthSamplesTarget:this.volumeRenderingDepthSamplesTarget,chunkResolutionHistogram:this.volumeRenderingChunkResolutionHistogram,localPosition:this.localPosition,channelCoordinateSpace:this.channelCoordinateSpace}));l.registerDisposer(n.messages.addChild(c.messages)),l.registerDisposer(Ti((u,h)=>{h&&u.registerDisposer(this.addRenderLayer(c.addRef()))},this.volumeRendering)),this.shaderError.changed.dispatch()})}this.dataType.value=t}restoreState(e){super.restoreState(e),this.opacity.restoreState(e[lm]),oe(e,cm,t=>this.blendMode.restoreState(t)),this.fragmentMain.restoreState(e[rC]),this.shaderControlState.restoreState(e[oC]),this.sliceViewRenderScaleTarget.restoreState(e[dm]),this.channelCoordinateSpace.restoreState(e[aC]),this.volumeRendering.restoreState(e[um]),this.volumeRenderingGain.restoreState(e[hm]),this.volumeRenderingDepthSamplesTarget.restoreState(e[fm])}toJSON(){const e=super.toJSON();return e[lm]=this.opacity.toJSON(),e[cm]=this.blendMode.toJSON(),e[rC]=this.fragmentMain.toJSON(),e[oC]=this.shaderControlState.toJSON(),e[dm]=this.sliceViewRenderScaleTarget.toJSON(),e[aC]=this.channelCoordinateSpace.toJSON(),e[um]=this.volumeRendering.toJSON(),e[hm]=this.volumeRenderingGain.toJSON(),e[fm]=this.volumeRenderingDepthSamplesTarget.toJSON(),e}displayImageSelectionState(e,t){const{value:n}=e;if(n==null)return!1;const s=this.channelSpace.value;if(s.error!==void 0)return!1;const{numChannels:r,coordinates:o,channelCoordinateSpace:{names:l,rank:c}}=s,u=document.createElement("div");u.classList.add("neuroglancer-selection-details-value-grid");let h="[copy] 0fr ";c!==0&&(h+=`repeat(${c}, [dim] 0fr [coord] 0fr) `),h+="[value] 1fr",u.style.gridTemplateColumns=h;for(let g=0;g<r;++g){const v=c===0?n:n[g],y=v==null?"":v.toString(),b=xs({title:"Copy value",onClick:()=>{gr(y)}});u.appendChild(b);for(let C=0;C<c;++C){const E=document.createElement("div");E.classList.add("neuroglancer-selection-details-value-grid-dim"),E.textContent=l[C],u.appendChild(E);const k=document.createElement("div");k.classList.add("neuroglancer-selection-details-value-grid-coord"),k.textContent=o[g*c+C].toString(),u.appendChild(k)}const w=document.createElement("div");w.classList.add("neuroglancer-selection-details-value-grid-value"),w.textContent=y,u.appendChild(w)}return t.appendChild(u),!0}displaySelectionState(e,t,n){let s=this.displayImageSelectionState(e,t);return super.displaySelectionState(e,t,n)&&(s=!0),s}getLegendShaderOptions(){return{memoizeKey:"ImageUserLayer",parameters:this.shaderControlState.builderState,encodeParameters:e=>e.key,defineShader:(e,t)=>{e.addFragmentCode(`
#define uOpacity 1.0
`),qk(e,t)},initializeShader:e=>{const t=e.shader;Xr(this.manager.root.display.gl,t,this.shaderControlState,e.parameters.parseResult.controls)}}}};sh.type="image",sh.typeAbbreviation="img";let io=sh;function Xk(i){return new qh({shaderError:i.shaderError,fragmentMain:i.fragmentMain,shaderControlState:i.shaderControlState})}const Qk=[{label:"Resolution (slice)",toolJson:dm,...Au(i=>({histogram:i.sliceViewRenderScaleHistogram,target:i.sliceViewRenderScaleTarget}))},{label:"Blending (slice)",toolJson:cm,...eT(i=>i.blendMode)},{label:"Opacity (slice)",toolJson:lm,...hs(i=>({value:i.opacity}))},{label:"Volume rendering (experimental)",toolJson:um,...Zo(i=>i.volumeRendering)},{label:"Gain (3D)",toolJson:hm,isValid:i=>i.volumeRendering,...hs(i=>({value:i.volumeRenderingGain,options:{min:-10,max:10,step:.1}}))},{label:"Resolution (3D)",toolJson:fm,isValid:i=>i.volumeRendering,...Au(i=>({histogram:i.volumeRenderingChunkResolutionHistogram,target:i.volumeRenderingDepthSamplesTarget}),zO)}];for(const i of Qk)ZE(io,i);class NU extends ci{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(Xk(this.layer));const{element:t}=this;t.classList.add("neuroglancer-image-dropdown");for(const r of Qk)t.appendChild(Rv(this,e,this.visibility,r));const n=document.createElement("div");n.style.flex="1";const s=document.createElement("div");s.className="neuroglancer-image-dropdown-top-row",s.appendChild(document.createTextNode("Shader")),s.appendChild(n),s.appendChild(Yh({title:"Show larger editor view",onClick:()=>{new MU(this.layer)}})),s.appendChild(jh({title:"Documentation on image layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(s),t.appendChild(this.registerDisposer(new PU(e.channelCoordinateSpaceCombiner)).element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Kh(e.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility,legendShaderOptions:this.layer.getLegendShaderOptions()})).element)}}let MU=class extends Wc{constructor(e){super(),this.layer=e,this.codeWidget=this.registerDisposer(Xk(this.layer)),this.content.classList.add("neuroglancer-image-layer-shader-overlay"),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}};lo(io);JE(At.IMAGE,io);Nh(i=>{const{volume:e}=i;if(e!==void 0&&e.volumeType===At.UNKNOWN)return{layerConstructor:io,priority:-100}});Xh(io,i=>({shaderControlState:i.shaderControlState,legendShaderOptions:i.getLegendShaderOptions()}));/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const OU="CredentialsProvider",_U="CredentialsProvider.get";var VU=Object.defineProperty,BU=Object.getOwnPropertyDescriptor,FU=(i,e,t,n)=>{for(var s=n>1?void 0:n?BU(e,t):e,r=i.length-1,o;r>=0;r--)(o=i[r])&&(s=(n?o(e,t,s):o(s))||s);return n&&s&&VU(e,t,s),s};let pm=class extends Ii{constructor(i,e){super(),this.provider=i,this.registerDisposer(i),this.initializeCounterpart(e)}get(i,e){return this.provider.get(i,e)}};pm=FU([li(OU)],pm);C1(_U,function(i,e){return this.get(i.providerId).get(i.invalidCredentials,e).then(n=>({value:n}))});function ry(i,e){if(e===void 0)return;const t=i.memoize.get({type:"getSharedCredentialsProvider",credentialsProvider:jt(e)},()=>new pm(e.addRef(),i.rpc)),n=t.addCounterpartRef();return t.dispose(),n}function ct(){return i=>{class e extends i{constructor(...n){var r;super(...n);const s=n[1];this.credentialsProvider=(r=s.credentialsProvider)==null?void 0:r.addRef()}initializeCounterpart(n,s){const{credentialsProvider:r}=this;s.credentialsProvider=ry(this.chunkManager,r),super.initializeCounterpart(n,s)}static encodeOptions(n){const s=i.encodeOptions(n),{credentialsProvider:r}=n;return s.credentialsProvider=r===void 0?void 0:jt(r),s}}return e}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const UU="single_mesh/SingleMeshLayer",zU="single_mesh/getSingleMeshInfo",_p="";class GU{}const Ay=class Ay extends GU{};Ay.RPC_ID="single_mesh/SingleMeshSource";let gm=Ay;class Di extends Error{constructor(e,t,n,s){let r=`Fetching ${JSON.stringify(e)} resulted in HTTP error ${t}`;n&&(r+=`: ${n}`),r+=".",super(r),this.name="HttpError",this.message=r,this.url=e,this.status=t,this.statusText=n,s&&(this.response=s)}static fromResponse(e){return new Di(e.url,e.status,e.statusText,e)}static fromRequestError(e,t){if(t instanceof TypeError){let n;return typeof e=="string"?n=e:n=e.url,new Di(n,0,"Network or CORS error")}return t}}const $U=32,WU=500,HU=1e4;function Zk(i){return Math.min(2**i*WU,HU/2)*(1+Math.random())}async function mm(i,e){var t;for(let n=0;;){if((t=e==null?void 0:e.signal)!=null&&t.aborted)throw Hi;let s;try{s=await fetch(i,e)}catch(r){throw Di.fromRequestError(i,r)}if(!s.ok){const{status:r}=s;if((r===429||r===503||r===504)&&++n!==$U){await new Promise(o=>setTimeout(o,Zk(n-1)));continue}throw Di.fromResponse(s)}return s}}function eL(i){return i.arrayBuffer()}function tn(i){return i.json()}async function jc(i,e,t,n=pt){if(n===pt){const o=await mm(i,e);return await t(o)}const s=new AbortController,r=n.add(()=>s.abort());try{const o=await mm(i,{...e,signal:s.signal});return await t(o)}finally{r()}}function Qh(i){const e=/^([^:/]+):\/\/([^/]+)((?:\/.*)?)$/,t=i.match(e);if(t===null)throw new Error(`Invalid URL: ${JSON.stringify(i)}`);return{protocol:t[1],host:t[2],path:t[3]}}function Wa(i){return i instanceof Di?i.status===0||i.status===403||i.status===404:!1}const JU=3;async function Yc(i,e,t,n,s,r,o=pt){let l;for(let c=0;;){yN(o),c>1&&await new Promise(u=>setTimeout(u,Zk(c-2))),l=await i.get(l,o);try{return await jc(typeof e=="function"?e(l.credentials):e,s(l.credentials,t),n,o)}catch(u){if(u instanceof Di&&r(u,l.credentials)==="refresh"){if(++c===JU)throw u;continue}throw u}}}function cc(i,e,t,n,s=pt){return i===void 0?jc(e,t,n,s):Yc(i,e,t,n,(r,o)=>{if(!r.accessToken)return o;const l=new Headers(o.headers);return l.set("Authorization",`${r.tokenType} ${r.accessToken}`),{...o,headers:l}},(r,o)=>{const{status:l}=r;if(l===401||l===403&&!o.accessToken)return"refresh";throw r instanceof Error&&o.email!==void 0&&(r.message+=`  (Using credentials for ${JSON.stringify(o.email)})`),r},s)}async function jU(i,e,t,n,s){const r=await cc(i,`${e}?prefix=${encodeURIComponent(t)}&delimiter=${encodeURIComponent(n)}`,{},h=>h.text(),s),o=new DOMParser().parseFromString(r,"application/xml"),l=o.evaluate('//*[name()="CommonPrefixes"]/*[name()="Prefix"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),c=[];for(let h=0,g=l.snapshotLength;h<g;++h)c.push(l.snapshotItem(h).textContent||"");const u=o.evaluate('//*[name()="Contents"]/*[name()="Key"]',o,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null);for(let h=0,g=u.snapshotLength;h<g;++h)c.push(u.snapshotItem(h).textContent||"");return c}async function vm(i,e,t,n,s){if(!n.startsWith("/"))throw null;const o=await jU(i,t,n.substring(1),"/",s),l=n.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function cC(i,e,t,n,s=pt){return console.log(i),await jc(`https://neuroglancer.lincbrain.org${e}`,t,n,s)}async function YU(i,e,t){return console.log(i),await vm(void 0,"https://neuroglancer.lincbrain.org","https://neuroglancer.lincbrain.org",e,t)}function qU(i,e){return i.getCredentialsProvider("middleauthapp",new URL(e).origin)}function zd(i,e,t){const n=/^\/([^/]+)/,s=t.match(n);if(s!==null)return i.getCredentialsProvider("ngauth_gcs",{authServer:e,bucket:s[1]})}function Ai(i,e){const t=Qh(i);switch(t.protocol){case"gs":case"gs+xml":return{credentialsProvider:void 0,url:i};case"gs+ngauth+http":return{credentialsProvider:zd(e,`http://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+ngauth+https":return{credentialsProvider:zd(e,`https://${t.host}`,t.path),url:"gs:/"+t.path};case"gs+xml+ngauth+http":return{credentialsProvider:zd(e,`http://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"gs+xml+ngauth+https":return{credentialsProvider:zd(e,`https://${t.host}`,t.path),url:"gs+xml:/"+t.path};case"middleauth+https":return i=i.substr(11),{credentialsProvider:qU(e,i),url:i};case"s3":return{credentialsProvider:void 0,url:i};default:return{credentialsProvider:void 0,url:i}}}async function ei(i,e,t,n,s=pt){const r=Qh(e);switch(r.protocol){case"gs":return cc(i,`https://www.googleapis.com/storage/v1/b/${r.host}/o/${encodeURIComponent(r.path.substring(1))}?alt=media&neuroglancer=${Yr()}`,t,n,s);case"gs+xml":return cc(i,`https://storage.googleapis.com/${r.host}${r.path}?neuroglancer=${Yr()}`,t,n,s);case"s3":return cC(r.host,r.path,t,n,s);default:return cC(r.host,r.path,t,n,s)}}class KU extends K{constructor(e){super(),this.gl=e,this.buffer=this.registerDisposer(new dn(e))}resize(e){let t;if(e<256){const n=t=new Uint8Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_BYTE}else if(e<65536){const n=t=new Uint16Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_SHORT}else{const n=t=new Uint32Array(e);for(let s=0;s<e;++s)n[s]=s;this.webglType=WebGL2RenderingContext.UNSIGNED_INT}this.buffer.setData(t),this.length=e}ensure(e){return(this.length===void 0||this.length<e)&&this.resize(e),this}bindToVertexAttrib(e){this.buffer.bindToVertexAttribI(e,1,this.webglType)}bind(e,t=0){const n=e.attribute("aIndexRaw");n>=0&&(this.bindToVertexAttrib(n),t!==0&&this.gl.vertexAttribDivisor(n,t))}}function XU(i,e,t=!1){const n=e.attribute("aIndexRaw");n>=0&&(t&&i.vertexAttribDivisor(n,0),i.disableVertexAttribArray(n))}function QU(i){return i.memoize.get("IndexBuffer",()=>new KU(i))}function ZU(i){i.addAttribute("highp uint","aIndexRaw"),i.addVertexCode(Sh),i.addVertexCode(`
uint getPrimitiveIndex() {
  return aIndexRaw;
}
`)}class e3{constructor(e){this.name=e}defineShader(e){e.addAttribute("highp uint",this.name)}bind(e,t){const n=t.attribute(this.name);e.bindToVertexAttribI(n,1,WebGL2RenderingContext.UNSIGNED_INT)}disable(e){e.gl.disableVertexAttribArray(e.attribute(this.name))}}function t3(i,e){return dn.fromData(i,e,WebGL2RenderingContext.ARRAY_BUFFER,WebGL2RenderingContext.STATIC_DRAW)}const tL=`void main() {
  emitGray();
}
`;class n3{constructor(){this.shaderError=Rc(),this.fragmentMain=vh(tL),this.shaderControlState=new Ch(this.fragmentMain)}}function nL(i){return $t(i.dataType,i.numComponents)}const Fr=[],iL=uo(new Ua,J.FLOAT32,3),i3=iL;function s3(i){return i.split(/[^a-zA-Z0-9]+/).filter(e=>e).join("_")}function sL(i){const e=new Set,t=[];for(const n of i){const s=s3(n);let r="",o=0;for(;e.has(s+r);)r=""+ ++o;t.push(s+r)}return t}class r3{constructor(e,t){this.attributeNames=e,this.attributeInfo=t,this.tempLightVec=new Float32Array(4),this.textureAccessHelper=new Vh("vertexData"),this.indexBufferHelper=new e3("vertexIndex")}defineAttributeAccess(e,t){const{textureAccessHelper:n}=this;n.defineShader(e);const{attributeNames:s}=this;let r=2+s.length;for(let l=Fr.length;l<r;++l)Fr[l]=Symbol(`SingleMeshShaderManager.vertexAttributeTextureUnit${l}`);r=0,e.addTextureSampler("sampler2D","uVertexAttributeSampler0",Fr[r++]),e.addTextureSampler("sampler2D","uVertexAttributeSampler1",Fr[r++]),e.addVertexCode(n.getAccessor("readVertexPosition","uVertexAttributeSampler0",J.FLOAT32,3)),e.addVertexCode(n.getAccessor("readVertexNormal","uVertexAttributeSampler1",J.FLOAT32,3));let o=`
vec3 vertexPosition = readVertexPosition(${t});
vec3 vertexNormal = readVertexNormal(${t});
`;this.attributeInfo.forEach((l,c)=>{e.addTextureSampler(`${Oh(l.dataType)}sampler2D`,`uVertexAttributeSampler${r}`,Fr[r]);const u=nL(l);e.addVarying(`highp ${u}`,`vCustom${c}`),e.addFragmentCode(`
#define ${s[c]} vCustom${c}
`),e.addVertexCode(n.getAccessor(`readAttribute${c}`,`uVertexAttributeSampler${r}`,l.dataType,l.numComponents)),o+=`vCustom${c} = readAttribute${c}(${t});
`,++r}),e.addVertexMain(o)}defineShader(e){e.require(ZU),this.indexBufferHelper.defineShader(e),e.addVarying("highp float","vLightingFactor"),e.addUniform("highp vec4","uLightDirection"),e.addUniform("highp vec4","uColor"),e.addUniform("highp mat4","uModelMatrix"),e.addUniform("highp mat4","uProjection"),e.addUniform("highp uint","uPickID"),e.addVarying("highp uint","vPickID","flat"),e.addVertexMain(`
uint triangleIndex = getPrimitiveIndex() / 3u;
vPickID = uPickID + triangleIndex;
`),e.addFragmentCode(`
void emitPremultipliedRGBA(vec4 color) {
  emit(vec4(color.rgb * vLightingFactor, color.a), vPickID);
}
void emitRGBA(vec4 color) {
  color = clamp(color, 0.0, 1.0);
  color.xyz *= color.a;
  emitPremultipliedRGBA(color);
}
void emitRGB(vec3 color) {
  emitRGBA(vec4(color, 1.0));
}
void emitGray() {
  emitRGB(vec3(1.0, 1.0, 1.0));
}
`),e.addFragmentCode(wa),this.defineAttributeAccess(e,"vertexIndex"),e.addVertexMain(`
gl_Position = uProjection * (uModelMatrix * vec4(vertexPosition, 1.0));
vec3 normal = normalize((uModelMatrix * vec4(vertexNormal, 0.0)).xyz);
vLightingFactor = abs(dot(normal, uLightDirection.xyz)) + uLightDirection.w;
`)}beginLayer(e,t,n){const{lightDirection:s,ambientLighting:r,directionalLighting:o,projectionParameters:l}=n,{viewProjectionMat:c}=l;e.uniformMatrix4fv(t.uniform("uProjection"),!1,c);const u=this.tempLightVec;ah(u,s,o),u[3]=r,e.uniform4fv(t.uniform("uLightDirection"),u)}setPickID(e,t,n){e.uniform1ui(t.uniform("uPickID"),n)}beginObject(e,t,n){e.uniformMatrix4fv(t.uniform("uModelMatrix"),!1,n)}bindVertexData(e,t,n){let s=0;const r=l=>{const c=WebGL2RenderingContext.TEXTURE0+t.textureUnit(Fr[s]);e.activeTexture(c),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,l),++s};r(n.vertexTexture),r(n.normalTexture);const{attributeNames:o}=this;n.vertexAttributeTextures.forEach((l,c)=>{o[c]!==void 0&&r(l)})}disableVertexData(e,t){let n=2;const s=this.attributeInfo.length,{attributeNames:r}=this;for(let o=0;o<s;++o)r[o]!==void 0&&++n;for(let o=0;o<n;++o){const l=t.textureUnit(Fr[o])+WebGL2RenderingContext.TEXTURE0;e.activeTexture(l),e.bindTexture(e.TEXTURE_2D,null)}}drawFragment(e,t,n,s){s.ensure(n.numIndices).bind(t),this.bindVertexData(e,t,n.vertexData),this.indexBufferHelper.bind(n.indexBuffer,t),e.drawArrays(WebGL2RenderingContext.TRIANGLES,0,n.numIndices)}endLayer(e,t){XU(e,t),this.indexBufferHelper.disable(t),this.disableVertexData(e,t)}}class o3{copyToGPU(e,t){const n=(s,r)=>{const o=e.createTexture();return e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,o),_h(e,r,s),o};this.vertexTexture=n(this.vertexPositions,iL),this.normalTexture=n(this.vertexNormals,i3),this.vertexAttributeTextures=this.vertexAttributes.map((s,r)=>n(s,t[r])),e.bindTexture(WebGL2RenderingContext.TEXTURE_2D,null)}freeGPUMemory(e){e.deleteTexture(this.vertexTexture),e.deleteTexture(this.normalTexture);const{vertexAttributeTextures:t}=this;for(const n of t)e.deleteTexture(n);t.length=0}}class a3 extends Ts{constructor(e,t){super(e);const n=this.vertexData=new o3;n.vertexPositions=t.vertexPositions,n.vertexNormals=t.vertexNormals,n.vertexAttributes=t.vertexAttributes;const s=this.indices=t.indices;this.numIndices=s.length}copyToGPU(e){super.copyToGPU(e),this.vertexData.copyToGPU(e,this.source.attributeTextureFormats),this.indexBuffer=t3(e,this.indices)}freeGPUMemory(e){super.freeGPUMemory(e),this.vertexData.freeGPUMemory(e),this.indexBuffer.dispose()}}function l3(i){return i.map(e=>uo(new Ua,e.dataType,e.numComponents))}class c3 extends at(ct()(ri),gm){constructor(){super(...arguments),this.attributeTextureFormats=l3(this.info.vertexAttributes)}get info(){return this.parameters.info}getChunk(e){return new a3(this,e)}}const d3=Ac(Ii);class u3 extends d3{}class h3 extends co{constructor(e,t,n){super(),this.source=e,this.displayState=t,this.transform=n,this.shaderManager=new r3(sL(this.source.info.vertexAttributes.map(r=>r.name)),this.source.info.vertexAttributes),this.shaders=new Map,this.sharedObject=this.registerDisposer(new u3),this.shaderGetter=Kr(this,this.gl,{memoizeKey:{t:"single_mesh/RenderLayer",attributes:this.source.info.vertexAttributes},fallbackParameters:new Ne(wh(Mc(tL))),parameters:this.displayState.shaderControlState.builderState,encodeParameters:r=>r.key,shaderError:this.displayState.shaderError,defineShader:(r,o)=>{if(o.parseResult.errors.length!==0)throw new Error("Invalid UI control specification");ba(o,r),this.shaderManager.defineShader(r),r.setFragmentMainFunction(ma(o.parseResult.code))}}),this.countingBuffer=this.registerDisposer(QU(this.gl)),this.registerDisposer(t.shaderControlState.parseResult.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(t.shaderControlState.changed.add(this.redrawNeeded.dispatch)),this.registerDisposer(n.changed.add(this.redrawNeeded.dispatch));const{sharedObject:s}=this;s.visibility.add(this.visibility),s.RPC_TYPE_ID=UU,s.initializeCounterpart(e.chunkManager.rpc,{chunkManager:e.chunkManager.rpcId,source:e.addCounterpartRef()})}disposeShaders(){const{shaders:e}=this;for(const t of e.values())t!==null&&t.dispose();e.clear()}disposed(){this.disposeShaders(),super.disposed()}get isTransparent(){return this.displayState.fragmentMain.value.match(/emitRGBA|emitPremultipliedRGBA/)!==null}get gl(){return this.source.gl}isReady(){const e=this.source.chunks.get(_p);return!(e===void 0||e.state!==je.GPU_MEMORY)}draw(e,t){if(!e.emitColor&&e.alreadyEmittedPickID)return;const n=ql(this.transform.value,e.projectionParameters.displayDimensionRenderInfo,t);if(n===void 0)return;const s=this.source.chunks.get(_p);if(s===void 0||s.state!==je.GPU_MEMORY)return;const r=this.shaderGetter(e.emitter),{shader:o,parameters:l}=r;if(o===null)return;const{gl:c}=this,u=this.shaderManager;o.bind(),u.beginLayer(c,o,e),Xr(c,o,this.displayState.shaderControlState,l.parseResult.controls);const{pickIDs:h}=e;u.beginObject(c,o,n),e.emitPickID&&u.setPickID(c,o,h.register(this,s.numIndices/3)),u.drawFragment(c,o,s,this.countingBuffer),u.endLayer(c,o)}transformPickedValue(e){const{pickedOffset:t}=e,n=this.source.chunks.get(_p);if(n===void 0)return;const s=t*3,{indices:r}=n;if(s>=r.length)return;const o=r[s],l=[],{attributeNames:c}=this.shaderManager;return n.vertexData.vertexAttributes.forEach((u,h)=>{const g=c[h];g!==void 0&&l.push(`${g}=${u[o].toPrecision(6)}`)}),l.join(", ")}}function f3(i,e,t){return i.memoize.getUncounted({type:"single_mesh:getMeshInfo",url:t},async()=>{const{url:n,credentialsProvider:s}=Ai(t,e);return{info:await i.rpc.promiseInvoke(zU,{chunkManager:i.addCounterpartRef(),credentialsProvider:ry(i,s),parameters:{meshSourceUrl:n}}),url:n,credentialsProvider:s}})}async function rL(i,e,t){const{info:n,url:s,credentialsProvider:r}=await f3(i,e,t);return i.getChunkSource(c3,{credentialsProvider:r,parameters:{meshSourceUrl:s,info:n}})}const dC="shader",uC="shaderControls",rh=class rh extends Li{constructor(e){super(e),this.managedLayer=e,this.displayState=new n3,this.vertexAttributes=new Ne(void 0),this.registerDisposer(this.displayState.shaderControlState.changed.add(this.specificationChanged.dispatch)),this.registerDisposer(this.displayState.fragmentMain.changed.add(this.specificationChanged.dispatch)),this.tabs.add("rendering",{label:"Rendering",order:-100,getter:()=>new g3(this)}),this.tabs.default="rendering"}restoreState(e){super.restoreState(e),this.displayState.fragmentMain.restoreState(e[dC]),this.displayState.shaderControlState.restoreState(e[uC])}activateDataSubsources(e){let t=!1;for(const n of e){const{subsourceEntry:s}=n,{subsource:r}=s,{singleMesh:o}=r;if(o!==void 0){if(t){n.deactivate("Only one single-mesh source supported");continue}t=!0,n.activate(l=>{n.addRenderLayer(new h3(o,this.displayState,n.getRenderLayerTransform())),this.vertexAttributes.value=o.info.vertexAttributes,l.registerDisposer(()=>{this.vertexAttributes.value=void 0})});continue}n.deactivate("Not compatible with image layer")}}toJSON(){const e=super.toJSON();return e[dC]=this.displayState.fragmentMain.toJSON(),e[uC]=this.displayState.shaderControlState.toJSON(),e}};rh.type="mesh",rh.typeAbbreviation="mesh";let dc=rh;function oL(i){return new qh({fragmentMain:i.displayState.fragmentMain,shaderError:i.displayState.shaderError,shaderControlState:i.displayState.shaderControlState})}class p3 extends K{constructor(e){super(),this.attributes=e,this.element=document.createElement("div"),this.element.className="neuroglancer-single-mesh-attribute-widget",this.updateView(),this.registerDisposer(e.changed.add(()=>{this.updateView()}))}updateView(){const{element:e}=this,t=this.attributes.value;if(t===void 0){Fe(e);return}const n=sL(t.map(r=>r.name)),s=t.length;for(let r=0;r<s;++r){const o=t[r],l=document.createElement("div");l.className="neuroglancer-single-mesh-attribute";const c=document.createElement("div");c.className="neuroglancer-single-mesh-attribute-type",c.textContent=nL(o);const u=document.createElement("div");if(u.className="neuroglancer-single-mesh-attribute-name",u.textContent=n[r],l.appendChild(c),l.appendChild(u),o.min!==void 0&&o.max!==void 0){const h=document.createElement("neuroglancer-single-mesh-attribute-minmax");h.className="neuroglancer-single-mesh-attribute-range",h.textContent=`[${o.min.toPrecision(6)}, ${o.max.toPrecision(6)}]`,l.appendChild(h)}e.appendChild(l)}}disposed(){gt(this.element)}}function aL(i){return new p3(i.vertexAttributes)}class g3 extends ci{constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(aL(this.layer)),this.codeWidget=this.registerDisposer(oL(this.layer));const{element:t}=this;t.classList.add("neuroglancer-single-mesh-dropdown");const n=document.createElement("div");n.className="neuroglancer-single-mesh-dropdown-top-row";const s=document.createElement("div");s.style.flex="1",n.appendChild(s),n.appendChild(Yh({title:"Show larger editor view",onClick:()=>{new m3(this.layer)}})),n.appendChild(jh({title:"Documentation on single mesh layer rendering",href:"https://github.com/google/neuroglancer/blob/master/src/sliceview/image_layer_rendering.md"})),t.appendChild(n),t.appendChild(this.attributeWidget.element),t.appendChild(this.codeWidget.element),t.appendChild(this.registerDisposer(new Kh(e.displayState.shaderControlState,this.layer.manager.root.display,this.layer,{visibility:this.visibility})).element)}}class m3 extends Wc{constructor(e){super(),this.layer=e,this.attributeWidget=this.registerDisposer(aL(this.layer)),this.codeWidget=this.registerDisposer(oL(this.layer)),this.content.classList.add("neuroglancer-single-mesh-layer-shader-overlay"),this.content.appendChild(this.attributeWidget.element),this.content.appendChild(this.codeWidget.element),this.codeWidget.textEditor.refresh()}}lo(dc);Nh(i=>{if(i.singleMesh!==void 0)return{layerConstructor:dc,priority:2}});Xh(dc,i=>({shaderControlState:i.displayState.shaderControlState}));const lL="boss";function Ha(i,e,t,n,s=pt){return jc(e,t,n,s).catch(r=>{if(r.status!==500&&r.status!==401&&r.status!==403&&r.status!==504)throw r;return Yc(i,e,t,n,o=>{const l=new Headers(t.headers);return l.set("Authorization",`Bearer ${o}`),{...t,headers:l}},o=>{const{status:l}=o;if(l===403||l===401)return"refresh";throw o},s)})}/**
 * @license
 * Copyright 2017 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class v3{}var fc;let y3=(fc=class extends v3{static stringify(e){return`boss:volume:${e.baseUrl}/${e.collection}/${e.experiment}/${e.channel}/${e.resolution}/${e.encoding}`}},fc.RPC_ID="boss/VolumeChunkSource",fc);var pc;let S3=(pc=class{static stringify(e){return`boss:mesh:${e.baseUrl}`}},pc.RPC_ID="boss/MeshChunkSource",pc);class b3 extends at(ct()(Ps),y3){}class w3 extends at(ct()(fo),S3){}const oy=new Map;oy.set("image",At.IMAGE);oy.set("annotation",At.SEGMENTATION);const C3=new Set(["npz","jpeg"]),x3=Uint32Array.of(512,512,16);var cL=(i=>(i[i.NANOMETERS=0]="NANOMETERS",i[i.MICROMETERS=1]="MICROMETERS",i[i.MILLIMETERS=2]="MILLIMETERS",i[i.CENTIMETERS=3]="CENTIMETERS",i))(cL||{});function E3(i){switch(i){case 1:return 1e6;case 2:return 1e3;case 3:return 100;case 0:return 1e9}}function T3(i,e){ee(i);const t=z(i,"voxel_unit",u=>ft(u,cL)),n=E3(t),s=new Float32Array(3),r=new Float64Array(3),o=new Float64Array(3),l=new Float64Array(3),c=["x","y","z"];for(let u=0;u<3;++u){const h=c[u];s[u]=z(i,`${h}_voxel_size`,wt),r[u]=s[u]/n,o[u]=z(i,`${h}_start`,Je),l[u]=z(i,`${h}_stop`,Je)}return e.coordFrame={voxelSizeBaseInMeters:r,voxelSizeBaseInOriginalUnits:s,voxelOffsetBase:o,imageSizeBase:l,voxelUnit:t,names:c},e}function k3(i){let e=oy.get(i);return e===void 0&&(e=At.UNKNOWN),e}function L3(i){ee(i);const e=z(i,"type",ie);let t=!1;return z(i,"downsample_status",ie)==="DOWNSAMPLED"&&(t=!0),{channelType:e,description:z(i,"description",ie),volumeType:k3(e),dataType:z(i,"datatype",s=>ft(s,J)),downsampled:t,scales:[],key:z(i,"name",ie),baseResolution:z(i,"base_resolution",Je)}}function D3(i,e,t,n,s,r){ee(i);const o=z(i,"channels",l=>Ee(l,c=>A3(e,t,n,r,s,c)));return Promise.all(o).then(l=>{const c=new Map;l.forEach(h=>{c.set(h.key,h)});const u={channels:c,scalingLevels:z(i,"num_hierarchy_levels",Je),coordFrameKey:z(i,"coord_frame",ie),coordFrame:void 0,key:z(i,"name",ie),collection:z(i,"collection",ie)};return B3(e,t,n,u)})}class I3 extends di{constructor(e,t,n,s,r,o){if(super(e),this.baseUrl=t,this.credentialsProvider=n,this.experimentInfo=s,this.parameters=o,this.meshPath=void 0,this.meshUrl=void 0,r===void 0){const g=Array.from(s.channels.keys());if(g.length!==1)throw new Error(`Experiment contains multiple channels: ${JSON.stringify(g)}`);r=g[0]}const l=s.channels.get(r);if(l===void 0)throw new Error(`Specified channel ${JSON.stringify(r)} is not one of the supported channels ${JSON.stringify(Array.from(s.channels.keys()))}`);if(this.channel=r,this.channelInfo=l,this.scales=l.scales,s.coordFrame===void 0)throw new Error(`Specified experiment ${JSON.stringify(s.key)} does not have a valid coordinate frame`);this.coordinateFrame=s.coordFrame,this.channelInfo.downsampled===!1&&(this.scales=[l.scales[0]]),this.experiment=s.key;const c=cn(o.window);if(c!==void 0){const g=Wm(),v=c.split(/,/);if(v.length===2)g[0]=Xe(v[0]),g[1]=Xe(v[1]);else if(v.length===1)g[0]=0,g[1]=Xe(v[1]);else throw new Error(`Invalid window. Must be either one value or two comma separated values: ${JSON.stringify(c)}`);if(this.window=g,this.window[0]===this.window[1])throw new Error(`Invalid window. First element must be different from second: ${JSON.stringify(c)}.`)}const u=cn(o.meshurl);u!==void 0&&(this.meshUrl=u);let h=cn(o.encoding);if(h===void 0)h=this.dataType===J.UINT8?"jpeg":"npz";else if(!C3.has(h))throw new Error(`Invalid encoding: ${JSON.stringify(h)}.`);this.encoding=h}get dataType(){return this.channelInfo.dataType}get volumeType(){return this.channelInfo.volumeType}get rank(){return 3}getSources(e){const t=this.scales[0].downsampleFactors,{rank:n}=this;return yr(this.scales.map(s=>{const r=this.coordinateFrame.voxelOffsetBase,o=we();for(let g=0;g<3;++g)o[g]=Math.ceil(r[g]);const l=s.downsampleFactors,c=n+1,u=new Float32Array(c*c);u[u.length-1]=1;for(let g=0;g<3;++g){const v=l[g]/t[g];u[c*g+g]=v,u[c*n+g]=o[g]*v}n===4&&(u[c*3+3]=1);const h=s.imageSize;return po({rank:3,volumeType:this.volumeType,dataType:this.dataType,chunkToMultiscaleTransform:u,chunkDataSizes:[x3],baseVoxelOffset:o,upperVoxelBound:h,volumeSourceOptions:e}).map(g=>({chunkSource:this.chunkManager.getChunkSource(b3,{credentialsProvider:this.credentialsProvider,spec:g,parameters:{baseUrl:this.baseUrl,collection:this.experimentInfo.collection,experiment:this.experimentInfo.key,channel:this.channel,resolution:s.key,encoding:this.encoding,window:this.window}}),chunkToMultiscaleTransform:u}))}))}getMeshSource(){return this.meshUrl!==void 0?this.chunkManager.getChunkSource(w3,{credentialsProvider:this.credentialsProvider,parameters:{baseUrl:this.meshUrl}}):null}}const P3=/^([^/?]+)\/([^/?]+)(?:\/([^/?]+))?(?:\?(.*))?$/;function dL(i,e,t,n,s){return i.memoize.getUncounted({hostname:e,collection:s,experiment:n,type:"boss:getExperimentInfo"},()=>Ha(t,`${e}/latest/collection/${s}/experiment/${n}/`,{},tn).then(r=>D3(r,i,e,t,s,n)))}function A3(i,e,t,n,s,r){return i.memoize.getUncounted({hostname:e,collection:s,experiment:n,channel:r,type:"boss:getChannelInfo"},()=>Ha(t,`${e}/latest/collection/${s}/experiment/${n}/channel/${r}/`,{},tn).then(L3))}function R3(i,e,t,n,s,r){return i.memoize.getUncounted({hostname:e,collection:n,experiment:s.key,channel:r,downsample:!0,type:"boss:getDownsampleInfoForChannel"},()=>Ha(t,`${e}/latest/downsample/${n}/${s.key}/${r}`,{},tn)).then(o=>M3(o,s,r))}function N3(i,e){ee(i);const t=z(i,"voxel_size",o=>Jl(o,QA)),n=z(i,"extent",o=>Jl(o,ZA)),s=z(i,"num_hierarchy_levels",Je),r=new Array;for(let o=0;o<s;o++){const l=String(o),c=t.get(l),u=n.get(l);if(c===void 0||u===void 0)throw new Error(`Missing voxel_size/extent for resolution ${l}.`);const h=new Float32Array(3);for(let g=0;g<3;++g)h[g]=c[g]/e[g];r[o]={downsampleFactors:h,imageSize:u,key:l}}return r}function M3(i,e,t){const n=e.coordFrame;if(n===void 0)throw new Error(`Missing coordinate frame information for experiment ${e.key}. A valid coordinate frame is required to retrieve downsampling information.`);const s=e.channels.get(t);if(s===void 0)throw new Error(`Specified channel ${JSON.stringify(t)} is not one of the supported channels ${JSON.stringify(Array.from(e.channels.keys()))}`);return s.scales=N3(i,n.voxelSizeBaseInOriginalUnits),e.channels.set(t,s),e}function O3(i,e,t,n){const s=n.match(P3);if(s===null)throw new Error(`Invalid volume path ${JSON.stringify(n)}`);const r=s[1],o=s[2],l=s[3],c=Ma(s[4]||"");return i.memoize.getUncounted({hostname:e,path:n,type:"boss:getVolume"},async()=>{const u=await dL(i,e,t,o,r),h=await R3(i,e,t,r,u,l),g=new I3(i,e,t,h,l,c),v=h.coordFrame,y={lowerBounds:v.voxelOffsetBase,upperBounds:Float64Array.from(v.imageSizeBase,(C,E)=>v.voxelOffsetBase[E]+C)},b=Ue({rank:3,names:v.names,units:["m","m","m"],scales:v.voxelSizeBaseInMeters,boundingBoxes:[qi(y)]});return{modelTransform:Jt(b),subsources:[{id:"default",default:!0,subsource:{volume:g}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(y)}}]}})}const hC=/^((?:http|https):\/\/[^/?]+)\/(.*)$/;function _3(i,e,t){return i.memoize.getUncounted({hostname:e,type:"boss:getCollections"},()=>Ha(t,`${e}/latest/collection/`,{},tn).then(n=>z(n,"collections",s=>Ee(s,ie))))}function V3(i,e,t,n){return i.memoize.getUncounted({hostname:e,collection:n,type:"boss:getExperiments"},()=>Ha(t,`${e}/latest/collection/${n}/experiment/`,{},tn).then(s=>z(s,"experiments",r=>Ee(r,ie))))}function B3(i,e,t,n){const s=n.coordFrameKey;return i.memoize.getUncounted({hostname:e,coordinateframe:s,experimentInfo:n,type:"boss:getCoordinateFrame"},()=>Ha(t,`${e}/latest/coord/${s}/`,{},tn).then(r=>T3(r,n)))}function F3(i,e,t,n){const s=n.match(/^(?:([^/]+)(?:\/?([^/]*)(?:\/?([^/]*)(?:\/?([^/]*)?))?)?)?$/);if(s===null||s[1]===void 0)return Promise.reject(null);if(s[2]===void 0){const r=s[1]||"";return _3(i,e,t).then(o=>({offset:0,completions:On(r,o,l=>l+"/",()=>{})}))}if(s[3]===void 0){const r=s[2]||"";return V3(i,e,t,s[1]).then(o=>({offset:s[1].length+1,completions:On(r,o,l=>l+"/",()=>{})}))}return dL(i,e,t,s[2],s[1]).then(r=>{const o=On(s[3],r.channels,l=>l[0],l=>`${l[1].channelType} (${J[l[1].dataType]})`);return{offset:s[1].length+s[2].length+2,completions:o}})}function U3(i){const e=i.match(/^(?:https:\/\/[^.]+([^/]+))/);if(e===null)throw new Error(`Unable to construct auth server hostname from base hostname ${i}.`);return`https://auth${e[1]}/auth`}class z3 extends Bn{constructor(e){super(),this.credentialsManager=e}get description(){return"bossDB: Block & Object Storage System"}getCredentialsProvider(e){const t=U3(e);return this.credentialsManager.getCredentialsProvider(lL,t)}get(e){const t=e.providerUrl.match(hC);if(t===null)throw new Error(`Invalid boss volume path: ${JSON.stringify(e.providerUrl)}`);const n=this.getCredentialsProvider(e.providerUrl);return O3(e.chunkManager,t[1],n,t[2])}async completeUrl(e){const t=e.providerUrl.match(hC);if(t===null)throw null;const n=t[1],s=this.getCredentialsProvider(t[1]),r=t[2],o=await F3(e.chunkManager,n,s,r);return br(t[1].length+1,o)}}const uL=new Map;function un(i,e){uL.set(i,e)}function G3(i){const e=new N2(i.credentialsManager);for(const[t,n]of uL)try{e.register(t,n(i))}catch(s){console.warn(`Skipping ${t} data source: ${s}`)}return e}un("boss",i=>new z3(i.credentialsManager));class Ki extends K{}function hL(i){let e,t,n;return(s,r)=>t!==void 0&&(e===void 0||s===void 0||e.generation!==s.generation)?(e===void 0&&n.addConsumer(r),t):(e=void 0,n=new SN,t=i(s,n).then(o=>(e=o,n=void 0,o),o=>{throw n.isCanceled&&(n=void 0,t=void 0),o}),t)}function As(i){let e=0;return hL((t,n)=>i(n).then(s=>({generation:++e,credentials:s})))}class $3{constructor(){this.providers=new Map,this.topLevelManager=this}register(e,t){this.providers.set(e,t)}getCredentialsProvider(e,t){const n=this.providers.get(e);if(n===void 0)throw new Error(`No registered credentials provider: ${JSON.stringify(e)}`);return n(t,this.topLevelManager)}}class W3 extends K{constructor(e){super(),this.base=e,this.memoize=new h1}getCredentialsProvider(e,t){return this.memoize.get({key:e,parameters:t},()=>this.registerDisposer(this.base.getCredentialsProvider(e,t).addRef()))}}class H3 extends W3{constructor(){super(new $3),this.base.topLevelManager=this}register(e,t){this.base.register(e,t)}}class J3 extends Ki{constructor(e,t){super(),this.baseProvider=e,this.anonymousCredentials=t,this.anonymous=!0,this.get=hL(n=>this.anonymous&&n===void 0?Promise.resolve({generation:-10,credentials:this.anonymousCredentials}):(this.anonymous=!1,this.baseProvider.get(n)))}}const Rs=new H3,j3=""+new URL("bossauth.html",import.meta.url).href;class Y3{constructor(){this.finished=new Ze}}class q3{constructor(){this.oidcCallbackService="bossAuthCallback",this.pendingRequests=new Map,this.registerListener()}registerListener(){addEventListener("message",e=>{if(e.origin===location.origin)try{const t=ee(JSON.parse(e.data));if(ie(t.service)===this.oidcCallbackService){const s=ie(t.access_token),r=ie(t.state),o=this.pendingRequests.get(r);if(o===void 0)return;o.finished.dispatch(s)}}catch{}})}addPendingRequest(e){const t=new Y3;return this.pendingRequests.set(e,t),t.finished.add(()=>{this.pendingRequests.delete(e)}),t}makeAuthRequestUrl(e){let t=`${e.authServer}/realms/BOSS/protocol/openid-connect/auth?`;return t+=`client_id=${encodeURIComponent(e.clientId)}`,t+=`&redirect_uri=${encodeURIComponent(e.redirect_uri)}`,t+="&response_mode=fragment",t+="&response_type=code%20id_token%20token",e.state&&(t+=`&state=${e.state}`),e.nonce&&(t+=`&nonce=${e.nonce}`),t}}let Vp;function K3(){return Vp===void 0&&(Vp=new q3),Vp}function X3(i,e=pt){const t=Yr(),n=Yr(),s=K3(),r=s.makeAuthRequestUrl({state:t,clientId:i.clientId,redirect_uri:new URL(j3,import.meta.url).href.replace(/\?.*$/,""),authServer:i.authServer,nonce:n}),o=s.addPendingRequest(t),l=new Promise((c,u)=>{o.finished.add((h,g)=>{h!==void 0?c(h):u(g)})});if(o.finished.add(e.add(()=>{o.finished.dispatch(void 0,Hi)})),!e.isCanceled){const c=open(r);c!==null&&o.finished.add(()=>{c.close()})}return l}class Q3 extends Ki{constructor(e){super(),this.authServer=e,this.get=As(t=>{const n=new Pe(!0);let s;return new Promise((r,o)=>{const l=()=>{s=void 0,n.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,n.dispose(),o(Hi))});function c(g="Boss authorization required.",v="Request authorization."){n.setText(g+" ");const y=document.createElement("button");y.textContent=v,n.element.appendChild(y),y.addEventListener("click",()=>{h()}),n.setVisible(!0)}const u=this.authServer;function h(){s!==void 0&&s.cancel(),s=new Sr,c("Waiting for Boss authorization...","Retry"),X3({realm:"boss",clientId:"endpoint",authServer:u},s).then(g=>{s!==void 0&&(l(),r(g))},g=>{s!==void 0&&(s=void 0,c(`Boss authorization failed: ${g}.`,"Retry"))})}c()})})}}Rs.register(lL,i=>new Q3(i));const ay="google-brainmaps";function qo(i,e,t,n=pt){return cc(e,`${i.serverUrl}${t.path}`,{method:t.method,body:t.payload},t.responseType==="json"?tn:eL,n)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var rr=(i=>(i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i))(rr||{}),gc;let Z3=(gc=class{},gc.RPC_ID="brainmaps/VolumeChunkSource",gc);var mc;let ez=(mc=class{},mc.RPC_ID="brainmaps/MultiscaleMeshSource",mc);var vc;let tz=(vc=class{},vc.RPC_ID="brainmaps/MeshSource",vc);var yc;let nz=(yc=class{},yc.RPC_ID="brainmaps/SkeletonSource",yc);var Sc;let iz=(Sc=class{},Sc.RPC_ID="brainmaps/Annotation",Sc);var bc;let sz=(bc=class{},bc.RPC_ID="brainmaps/AnnotationSpatialIndex",bc);class rz extends at(ct()(Ps),Z3){}class oz extends at(ct()(Fh),ez){}class az extends at(ct()(fo),tz){}class lz extends at(ct()(Wh),nz){}class cz extends at(ct()(Eu),sz){}const qc=new Map;qc.set("UINT8",J.UINT8);qc.set("FLOAT",J.FLOAT32);qc.set("UINT32",J.UINT32);qc.set("UINT64",J.UINT64);function dz(i){ee(i);try{return{corner:z(i,"corner",e=>du(we(),e,Xe)),size:z(i,"size",e=>du(we(),e,wt)),metadata:z(i,"metadata",cn)}}catch(e){throw new Error(`Failed to parse bounding box: ${e.message}`)}}class uz{constructor(e){try{ee(e),this.numChannels=z(e,"channelCount",ht),this.dataType=z(e,"channelType",t=>Ax(t,qc)),this.voxelSize=z(e,"pixelSize",t=>du(we(),t,wt)),this.upperVoxelBound=z(e,"volumeSize",t=>du(we(),t,ht)),this.boundingBoxes=z(e,"boundingBox",t=>t===void 0?[]:Ee(t,dz))}catch(t){throw new Error(`Failed to parse BrainMaps volume geometry: ${t.message}`)}}}function hz(i){return ee(i),{name:z(i,"name",ie),type:z(i,"type",ie)}}function fz(i){try{return ee(i),z(i,"meshes",e=>e===void 0?[]:Ee(e,hz))}catch(e){throw new Error(`Failed to parse BrainMaps meshes specification: ${e.message}`)}}const pz="([0-9]*\\.?[0-9]+(?:[eE][-+]?[0-9]+)?)",Bp="([0-9]+)",fL=new RegExp(`^(.*)_${Bp}x${Bp}x${Bp}_lod([0-9]+)_${pz}$`);function gz(i,e){const t=new Map,n=i.scales[0],s=new Set;for(const o of e){if(o.type!=="TRIANGLES")continue;const l=o.name.match(fL);if(l===null)continue;const c=l[1];let u=t.get(c);u===void 0&&(u={key:c,chunkShape:we(),lods:[]},t.set(c,u));const h=parseInt(l[5]);if(u.lods[h]!==void 0){s.add(c);continue}const g=Et(parseInt(l[2],10),parseInt(l[3],10),parseInt(l[4],10)),v=new Uint32Array(3);for(let y=0;y<3;++y)v[y]=Math.ceil(n.upperVoxelBound[y]/g[y]);u.lods[h]={info:o,scale:parseFloat(l[6]),relativeBlockShape:g,gridShape:v}}const r=[];e:for(const o of t.values()){if(s.has(o.key))continue;const l=o.lods[0];if(l===void 0)continue;const c=l.relativeBlockShape;mA(o.chunkShape,c,n.voxelSize);for(let u=1;u<o.lods.length;++u){const h=o.lods[u];if(h===void 0)continue e;const{relativeBlockShape:g}=h;for(let v=0;v<3;++v){const y=g[v],b=c[v];if(y<b||y%b!==0)continue e;g[v]=y/b}}c.fill(1),r.push(o)}return r}function mz(i,e){const t=gz(i,e),n=[],s=o=>{n.some(l=>l.name===o.name)||n.push(o)},r=new Set;for(const o of t){s({multi:o,single:void 0,name:o.key,partOfMultiscale:!1});for(const l of o.lods)r.add(l.info)}for(const o of e)s({single:o,multi:void 0,name:o.name,partOfMultiscale:r.has(o)});return n}class vz{constructor(e){try{ee(e);const t=this.scales=z(e,"geometry",o=>Ee(o,l=>new uz(l)));if(t.length===0)throw new Error("Expected at least one scale.");const n=t[0],s=this.numChannels=n.numChannels,r=this.dataType=n.dataType;for(let o=1,l=t.length;o<l;++o){const c=t[o];if(c.dataType!==r)throw new Error(`Scale ${o} has data type ${J[c.dataType]} but scale 0 has data type ${J[r]}.`);if(c.numChannels!==s)throw new Error(`Scale ${o} has ${c.numChannels} channel(s) but scale 0 has ${s} channels.`)}this.box={lowerBounds:new Float64Array(3),upperBounds:new Float64Array(n.upperVoxelBound)}}catch(t){throw new Error(`Failed to parse BrainMaps multiscale volume specification: ${t.message}`)}}getModelSpace(e=!1){const t=this.scales[0],n=["x","y","z"],s=["m","m","m"],r=Array.from(t.voxelSize,l=>l/1e9),o=Array.from(t.upperVoxelBound);return e&&(n.push("c^"),s.push(""),r.push(1),o.push(this.numChannels)),Ue({names:n,units:s,scales:Float64Array.from(r),boundingBoxes:[qi({lowerBounds:new Float64Array(n.length),upperBounds:Float64Array.from(o)})]})}}let yz=class extends di{constructor(e,t,n,s,r,o,l){super(e),this.instance=t,this.credentialsProvider=n,this.volumeId=s,this.changeSpec=r,this.multiscaleVolumeInfo=o,this.encoding=l.encoding,this.jpegQuality=l.jpegQuality,this.chunkLayoutPreference=l.chunkLayoutPreference;let c=At.IMAGE;this.dataType===J.UINT64&&(c=At.SEGMENTATION),this.volumeType=c}get scales(){return this.multiscaleVolumeInfo.scales}get dataType(){return this.multiscaleVolumeInfo.dataType}get rank(){return this.multiscaleVolumeInfo.numChannels!==1?4:3}getSources(e){let t=rr.RAW;(this.dataType===J.UINT64||this.dataType===J.UINT32)&&this.volumeType===At.SEGMENTATION&&this.encoding!==rr.RAW?t=rr.COMPRESSED_SEGMENTATION:this.volumeType===At.IMAGE&&this.dataType===J.UINT8&&this.multiscaleVolumeInfo.numChannels===1&&this.encoding!==rr.RAW&&e.discreteValues!==!0&&(t=rr.JPEG);const n=t===rr.JPEG?this.jpegQuality:void 0,s=this.scales[0],{upperVoxelBound:r}=s,o=we(),{rank:l}=this;return yr(this.scales.map((c,u)=>{vA(o,c.voxelSize,s.voxelSize);let h=c.upperVoxelBound,g;const{numChannels:v}=c,y=new Float32Array((l+1)**2);y[(l+1)*l+l]=1;const b=new Float32Array(l);v!==1&&(h=Float32Array.of(...h,v),g=Uint32Array.of(1,1,1,v),y[(l+1)*3+3]=1,b[3]=v);for(let w=0;w<3;++w)y[(l+1)*w+w]=o[w],b[w]=r[w]/o[w];return po({rank:l,minBlockSize:g,chunkToMultiscaleTransform:y,dataType:c.dataType,upperVoxelBound:h,volumeType:this.volumeType,volumeSourceOptions:e,chunkLayoutPreference:this.chunkLayoutPreference,maxCompressedSegmentationBlockSize:Et(64,64,64)}).map(w=>({chunkSource:this.chunkManager.getChunkSource(rz,{credentialsProvider:this.credentialsProvider,spec:w,parameters:{volumeId:this.volumeId,changeSpec:this.changeSpec,scaleIndex:u,encoding:t,jpegQuality:n,instance:this.instance}}),chunkToMultiscaleTransform:y,upperClipBound:b}))}))}};function Sz(i){const e=Ve(),t=i.scales[0].voxelSize;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}function bz(i){const e=i.match(/^([^:?/]+:[^:?/]+:[^:?/]+)(?::([^:?/]+))?(?:\/([^?]+))?(?:\?(.*))?$/);if(e===null)throw new Error(`Invalid Brain Maps volume key: ${JSON.stringify(i)}.`);let t;e[2]!==void 0&&(t={changeStackId:e[2]});const n=Ma(e[4]||"");return{volumeId:e[1],changeSpec:t,meshName:e[3],parameters:n}}function wz(i){try{return ee(i),{id:z(i,"id",ie),label:z(i,"label",ie),description:z(i,"description",cn)}}catch(e){throw new Error(`Failed to parse project: ${e.message}`)}}function Cz(i){try{return ee(i),z(i,"project",e=>e===void 0?[]:Ee(e,wz))}catch(e){throw new Error(`Error parsing project list: ${e.message}`)}}function fC(i,e){try{return ee(i),z(i,e,t=>t===void 0?[]:Ee(t,ie))}catch(t){throw new Error(`Error parsing dataset list: ${t.message}`)}}function xz(i){return z(i,"changeStackId",e=>e===void 0?void 0:Ee(e,ie))}const Ez=at(ct()(Bc),iz);class Tz extends Ez{constructor(e,t){super(e,{rank:3,relationships:["segments"],properties:[],...t}),this.credentialsProvider=this.registerDisposer(t.credentialsProvider.addRef())}hasNonSerializedProperties(){return!0}getSources(){const{upperVoxelBound:e}=this.parameters,t=Eh({rank:3,chunkDataSize:e,upperVoxelBound:e}),n=Ve();return[[{chunkSource:this.chunkManager.getChunkSource(cz,{parent:this,spec:{limit:0,chunkToMultiscaleTransform:n,...t},parameters:this.parameters,credentialsProvider:this.credentialsProvider}),chunkToMultiscaleTransform:n}]]}}const kz=[{key:{value:"encoding",description:"Volume chunk data encoding"},values:[{value:"raw",description:""},{value:"jpeg",description:""},{value:"compressed_segmentation",description:""}]},{key:{value:"chunkLayout",description:"Volume chunk layout preference"},values:[{value:"isotropic",description:""},{value:"flat",description:""}]},{key:{value:"jpegQuality",description:"JPEG quality (1 to 100)"},values:[]}];class pL extends Bn{constructor(e,t){super(),this.instance=e,this.credentialsProvider=t}get description(){return this.instance.description}getMultiscaleInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMultiscaleInfo",volumeId:t,instance:this.instance,credentialsProvider:jt(this.credentialsProvider)},()=>qo(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes/${t}`,responseType:"json"}).then(n=>new vz(n)))}getMeshesInfo(e,t){return e.memoize.getUncounted({type:"brainmaps:getMeshesInfo",volumeId:t,instance:this.instance,credentialsProvider:jt(this.credentialsProvider)},()=>qo(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/objects/${t}/meshes`,responseType:"json"}).then(n=>fz(n)))}get(e){const{volumeId:t,changeSpec:n,meshName:s,parameters:r}=bz(e.providerUrl);ee(r);const o=oe(r,"encoding",h=>ft(h,rr)),l=oe(r,"jpegQuality",h=>{const g=Je(h);if(g<1||g>100)throw new Error(`Expected integer in range [1, 100], but received: ${h}`);return g},70),c=oe(r,"chunkLayout",h=>ft(h,Y1)),u={encoding:o,chunkLayoutPreference:c,jpegQuality:l};return e.chunkManager.memoize.getUncounted({type:"brainmaps:get",instance:this.instance,volumeId:t,changeSpec:n,brainmapsOptions:u},async()=>{const[h,g]=await Promise.all([this.getMultiscaleInfo(e.chunkManager,t),this.getMeshesInfo(e.chunkManager,t)]),v=new yz(e.chunkManager,this.instance,this.credentialsProvider,t,n,h,u),y={modelTransform:Jt(h.getModelSpace(h.numChannels!==1)),subsources:[{id:s===void 0?"default":"volume",subsource:{volume:v},default:s===void 0}]},b=Yi(h.box);h.scales[0].boundingBoxes.forEach((k,D)=>{b.add({type:st.AXIS_ALIGNED_BOUNDING_BOX,description:k.metadata,pointA:k.corner,pointB:pA(we(),k.corner,k.size),id:`boundingBox${D}`,properties:[]})}),y.subsources.push({id:"bounds",subsource:{staticAnnotations:b},default:!0});const C=mz(h,g),E=(k,D)=>{let A;const{single:N}=k;if(N!==void 0)N.type==="TRIANGLES"?A=e.chunkManager.getChunkSource(az,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:N.name,changeSpec:n}}):A=e.chunkManager.getChunkSource(lz,{credentialsProvider:this.credentialsProvider,parameters:{instance:this.instance,volumeId:t,meshName:k.name,changeSpec:n}});else{const I=k.multi;A=e.chunkManager.getChunkSource(oz,{credentialsProvider:this.credentialsProvider,format:{fragmentRelativeVertices:!1,vertexPositionFormat:cr.float32},parameters:{instance:this.instance,volumeId:t,info:I,changeSpec:n}})}y.subsources.push({id:s===void 0?`/${k.name}`:"default",subsource:{mesh:A},subsourceToModelSubspaceTransform:Sz(h),modelSubspaceDimensionIndices:[0,1,2],default:D})};if(s!==void 0){const k=C.find(D=>D.name===s);if(k===void 0)throw new Error(`Mesh/skeleton source not found: ${JSON.stringify(k)}`);E(k,!0)}else{let k=!0;for(const D of C)D.partOfMultiscale||(E(D,k),k=!1)}return n!==void 0&&y.subsources.push({id:"spatials",default:!0,modelSubspaceDimensionIndices:[0,1,2],subsource:{annotation:e.chunkManager.getChunkSource(Tz,{parameters:{volumeId:t,changestack:n.changeStackId,instance:this.instance,upperVoxelBound:h.scales[0].upperVoxelBound},credentialsProvider:this.credentialsProvider})}}),y})}getProjectList(e){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getProjectList"},()=>{const t=qo(this.instance,this.credentialsProvider,{method:"GET",path:"/v1beta2/projects",responseType:"json"}).then(s=>Cz(s)),n=`${this.instance.description} project list`;return Pe.forPromise(t,{delay:!0,initialMessage:`Retrieving ${n}.`,errorPrefix:`Error retrieving ${n}: `}),t})}getDatasetList(e,t){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:getDatasetList`},()=>{const n=qo(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/datasets?project_id=${t}`,responseType:"json"}).then(r=>fC(r,"datasetIds")),s=`${this.instance.description} dataset list`;return Pe.forPromise(n,{delay:!0,initialMessage:`Retrieving ${s}`,errorPrefix:`Error retrieving ${s}`}),n})}getVolumeList(e,t,n){return e.memoize.getUncounted({instance:this.instance,type:`brainmaps:${t}:${n}:getVolumeList`},()=>{const s=qo(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/volumes?project_id=${t}&dataset_id=${n}`,responseType:"json"}).then(o=>{const l=fC(o,"volumeId"),c=t.length+n.length+2,u=[];for(const h of l)u.push(h.substring(c));return u}),r=`${this.instance.description} volume list`;return Pe.forPromise(s,{delay:!0,initialMessage:`Retrieving ${r}`,errorPrefix:`Error retrieving ${r}`}),s})}getChangeStackList(e,t){return e.memoize.getUncounted({instance:this.instance,type:"brainmaps:getChangeStackList",volumeId:t},()=>{const n=qo(this.instance,this.credentialsProvider,{method:"GET",path:`/v1beta2/changes/${t}/change_stacks`,responseType:"json"}).then(r=>xz(r)),s=`change stacks for ${t}`;return Pe.forPromise(n,{delay:!0,initialMessage:`Retrieving ${s}.`,errorPrefix:`Error retrieving ${s}: `}),n})}async completeUrl(e){const{providerUrl:t}=e,n=t.match(/^([^:/?]*)(?::([^:/?]*)(?::([^:/?]*)(?::([^:/?]*))?(?:\/([^?]*))?(?:\?(.*))?)?)?$/);if(n===null)throw null;const[,s,r,o,l,c,u]=n;if(u!==void 0)return br(t.length-u.length,await hE(u,kz));if(c!==void 0){const g=`${s}:${r}:${o}`,v=await this.getMeshesInfo(e.chunkManager,g),y=[],b=new Set;for(const w of v)if(w.name.startsWith(c))switch(w.type){case"LINE_SEGMENTS":y.push({value:w.name,description:"Skeletons"});break;case"TRIANGLES":{y.push({value:w.name,description:"Mesh (single-resolution)"});const C=w.name.match(fL);if(C!==null){const E=C[1];if(b.has(E))break;b.add(E),y.push({value:E,description:"Mesh (multi-resolution)"})}break}}return y.sort((w,C)=>Fc(w.value,C.value)),{offset:t.length-c.length,completions:y}}if(l!==void 0){const g=`${s}:${r}:${o}`,v=await this.getChangeStackList(e.chunkManager,g);if(v===void 0)throw null;return{offset:t.length-l.length,completions:mp(l,v)}}if(o!==void 0)return{offset:t.length-o.length,completions:mp(o,await this.getVolumeList(e.chunkManager,s,r))};if(r!==void 0){const g=await this.getDatasetList(e.chunkManager,s);return{offset:t.length-r.length,completions:mp(r,g.map(v=>`${v}:`))}}const h=await this.getProjectList(e.chunkManager);return{offset:0,completions:On(s,h,g=>`${g.id}:`,g=>g.label)}}}const Lz={description:"Google Brain Maps",serverUrl:"https://brainmaps.googleapis.com"};un("brainmaps",i=>new pL(Lz,i.credentialsManager.getCredentialsProvider(ay)));if(typeof NEUROGLANCER_BRAINMAPS_SERVERS<"u")for(const[i,e]of Object.entries(NEUROGLANCER_BRAINMAPS_SERVERS))un(`brainmaps-${i}`,t=>new pL(e,t.credentialsManager.getCredentialsProvider(ay)));const Dz=""+new URL("google_oauth2_redirect.html",import.meta.url).href,Iz="email",Pz="openid",Az="https://accounts.google.com/o/oauth2/v2/auth";function Rz(i){const e=i.split(".");try{if(e.length!==3)throw new Error("Invalid JWT format");const t=atob(e[1]),n=JSON.parse(t);return ee(n),z(n,"email",ie)}catch(t){throw new Error(`Failed to decode id token: ${t.message}`)}}async function Nz(i,e,t){const n=new K;try{return await new Promise((s,r)=>{n.registerDisposer(t.add(()=>r(Hi))),n.registerEventListener(window,"message",o=>{if(o.origin===location.origin&&o.source===i)try{const l=ee(o.data);if(z(l,"state",ie)!==e)throw new Error("invalid state");const u=z(l,"id_token",ie),h={accessToken:z(l,"access_token",ie),tokenType:z(l,"token_type",ie),expiresIn:z(l,"expires_in",ie),scope:z(l,"scope",ie),email:Rz(u)};s(h)}catch(l){r(new Error(`Received unexpected authentication response: ${l.message}`)),console.error("Response received: ",o.data)}})})}finally{n.dispose()}}function Mz(i){let e=`${Az}?client_id=${encodeURIComponent(i.clientId)}`;const t=new URL(Dz,import.meta.url).href.replace(/\?.*$/,"");e+=`&redirect_uri=${t}`;let n="token";const{scopes:s}=i;return s.includes("email")&&s.includes("openid")&&(n="token%20id_token"),e+=`&response_type=${n}`,e+="&include_granted_scopes=true",e+=`&scope=${encodeURIComponent(s.join(" "))}`,i.state&&(e+=`&state=${i.state}`),i.loginHint&&(e+=`&login_hint=${encodeURIComponent(i.loginHint)}`),i.immediate&&(e+="&immediate=true"),i.nonce!==void 0&&(e+=`&nonce=${i.nonce}`),i.authUser!==void 0&&(e+=`&authuser=${i.authUser}`),e}async function Oz(i,e=pt){const t=Yr(),n=Yr(),s=Mz({state:t,nonce:n,clientId:i.clientId,scopes:i.scopes,approvalPrompt:i.approvalPrompt,loginHint:i.loginHint,immediate:i.immediate,authUser:i.authUser});let r,o;const l=[];if(i.immediate){const c=document.createElement("iframe");c.src=s,c.style.display="none",l.push(new Promise((u,h)=>{c.addEventListener("load",()=>{console.log("iframe loaded",c.contentDocument),c.contentDocument==null&&h(new Error("Immediate authentication failed"))})})),document.body.appendChild(c),r=c.contentWindow,o=()=>{gt(c)}}else{const c=open(s);r=c,c!==null&&(o=()=>{try{c.close()}catch{}})}try{return await Promise.race([...l,Nz(r,t,e)])}finally{o==null||o()}}class _z extends Ki{constructor(e){super(),this.options=e,this.get=As(t=>{const{options:n}=this,s=new Pe(!0);let r;return new Promise((o,l)=>{const c=()=>{r=void 0,s.dispose()};t.add(()=>{r!==void 0&&(r.cancel(),r=void 0,s.dispose(),l(Hi))});function u(g=`${n.description} authorization required.`,v="Request authorization."){s.setText(g+"  ");const y=document.createElement("button");y.textContent=v,s.element.appendChild(y),y.addEventListener("click",()=>{h(!1)}),s.setVisible(!0)}function h(g){r!==void 0&&r.cancel(),r=new Sr,u(`Waiting for ${n.description} authorization...`,"Retry"),Oz({clientId:n.clientId,scopes:n.scopes,immediate:g,authUser:0},r).then(v=>{r!==void 0&&(c(),o(v))},v=>{r!==void 0&&(r=void 0,g?u():u(`${n.description} authorization failed: ${v}.`,"Retry"))})}h(!0)})})}}const Vz="https://www.googleapis.com/auth/brainmaps";class Bz extends _z{constructor(e){super({clientId:e,scopes:[Vz,Pz,Iz],description:"Brain Maps"})}}Rs.register(ay,()=>new Bz("639403125587-4k5hgdfumtrvur8v48e3pr7oo91d765k.apps.googleusercontent.com"));/**
 * @license
 * Copyright 2016 Google Inc., 2023 Gergely Csucs
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var gL=(i=>(i[i.JPG=0]="JPG",i[i.JPEG=1]="JPEG",i[i.PNG=2]="PNG",i))(gL||{});const Ry=class Ry{};Ry.RPC_ID="deepzoom/ImageTileSource";let ym=Ry;const ly="DVID";function cy(i){return i.text()}function Fz(i,e,t=pt){return Uz(i,e.url,{method:e.method,body:e.payload},e.responseType===""?cy:e.responseType==="json"?tn:eL,t)}function Uz(i,e,t,n,s=pt){return Yc(i,e,t,n,(r,o)=>{const l={...o};return r.token&&(l.headers={...l.headers,Authorization:`Bearer ${r}`}),l},r=>{const{status:o}=r;if(o===403||o===401)return"refresh";throw r},s)}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Sm=(i=>(i[i.RAW=0]="RAW",i[i.JPEG=1]="JPEG",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSO=3]="COMPRESSO",i[i.PNG=4]="PNG",i))(Sm||{}),wc;let zz=(wc=class{},wc.RPC_ID="precomputed/VolumeChunkSource",wc);var Cc;let Gz=(Cc=class{},Cc.RPC_ID="precomputed/MeshSource",Cc);var uc=(i=>(i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i))(uc||{}),dy=(i=>(i[i.IDENTITY=0]="IDENTITY",i[i.MURMURHASH3_X86_128=1]="MURMURHASH3_X86_128",i))(dy||{});const Ny=class Ny{};Ny.RPC_ID="precomputed/MultiscaleMeshSource";let bm=Ny;var xc;let $z=(xc=class{},xc.RPC_ID="precomputed/SkeletonSource",xc);const My=class My{};My.RPC_ID="precomputed/AnnotationSpatialIndexSource";let wm=My;const Oy=class Oy{};Oy.RPC_ID="precomputed/AnnotationSource";let Cm=Oy;const _y=class _y{};_y.RPC_ID="precomputed/IndexedSegmentPropertySource";let xm=_y;async function Wz(i,e,t,n,s){const r=await cc(i,`https://www.googleapis.com/storage/v1/b/${e}/o?delimiter=${encodeURIComponent(n)}&prefix=${encodeURIComponent(t)}&neuroglancerOrigin=${encodeURIComponent(location.origin)}`,{},tn,s);ee(r);const o=oe(r,"prefixes",Zn,[]),l=oe(r,"items",c=>Ee(c,u=>(ee(u),z(u,"name",ie))),[]).filter(c=>!c.endsWith("_$folder$"));return[...o,...l]}async function Hz(i,e,t,n,s){if(!n.startsWith("/"))throw null;const o=await Wz(i,t,n.substring(1),"/",s),l=n.lastIndexOf("/");return{offset:l+e.length+1,completions:o.map(c=>({value:c.substring(l)}))}}async function Jz(i,e,t){const{text:n,contentType:s}=await ei(t,i,{headers:{accept:"text/html"}},async c=>({text:await c.text(),contentType:c.headers.get("content-type")}),e);if(s===null||/\btext\/html\b/i.exec(s)===null)return[];const r=new DOMParser().parseFromString(n,"text/html"),o=r.evaluate("//a/@href",r,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),l=[];for(let c=0,u=o.snapshotLength;c<u;++c){const g=o.snapshotItem(c).textContent;g&&l.push(new URL(g,i).toString())}return l}async function jz(i,e,t){const n=i.match(/^([a-z]+:\/\/.*\/)([^/?#]*)$/);if(console.log(n),n===null)throw null;const s=await Jz(n[1],e,t);console.log(s);const r=n[1].length,o=[];for(const l of s)console.log(i),l.startsWith(i)&&o.push({value:l.substring(r)});return console.log(o),{offset:r,completions:o}}const Yz=[{value:"gs://",description:"Google Cloud Storage (JSON API)"},{value:"gs+xml://",description:"Google Cloud Storage (XML API)"},{value:"gs+ngauth+http://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+ngauth+https://",description:"Google Cloud Storage (JSON API) authenticated via ngauth"},{value:"gs+xml+ngauth+http://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"gs+xml+ngauth+https://",description:"Google Cloud Storage (XML API) authenticated via ngauth"},{value:"s3://",description:"Amazon Simple Storage Service (S3)"},{value:"https://"},{value:"http://"}];async function go(i,e,t){if(!e.includes("://"))return{offset:0,completions:On(e,Yz,g=>g.value,g=>g.description)};const{url:n,credentialsProvider:s}=Ai(e,i),r=e.length-n.length;let o;try{o=Qh(n)}catch{throw null}const{protocol:l,host:c,path:u}=o,h=await(async()=>{if(l==="gs+xml"&&u.length>0)return await vm(s,`${l}://${c}`,`https://storage.googleapis.com/${c}`,u,t);if(l==="gs"&&u.length>0)return await Hz(s,`${l}://${c}`,c,u,t);if((l==="s3"||l==="https")&&u.length>0)return await YU(c,u,t);const g=n.match(/^((?:http|https):\/\/(?:storage\.googleapis\.com\/[^/]+|[^/]+\.storage\.googleapis\.com|[^/]+\.s3(?:[^./]+)?\.amazonaws.com))(\/.*)$/);if(g!==null)return await vm(s,g[1],g[1],g[2],t);if((c==="neuroglancer.lincbrain.org"||l==="https")&&u.length>0)return await jz(n,t,s);throw null})();return{offset:r+h.offset,completions:h.completions}}class qz extends at(ct()(Ps),zz){}class Kz extends at(ct()(fo),Gz){}class Xz extends at(ct()(Fh),bm){}class Qz extends at(ct()(Wh),$z){get skeletonVertexCoordinatesInVoxels(){return!1}get vertexAttributes(){return this.parameters.metadata.vertexAttributes}}function Wi(i,e){const t=i.split("/");for(const n of e.split("/")){if(n===".."&&t.length!==0){t.length=t.length-1;continue}t.push(n)}return t.join("/")}class Zz{constructor(e,t){ee(e);const n=t===1?3:4,s=this.resolution=new Float64Array(n),r=this.voxelOffset=new Float32Array(n),o=this.size=new Float32Array(n);if(n===4&&(s[3]=1,o[3]=t),z(e,"resolution",c=>_e(s.subarray(0,3),c,wt)),oe(e,"voxel_offset",c=>_e(r.subarray(0,3),c,Je)),z(e,"size",c=>_e(o.subarray(0,3),c,ht)),this.chunkSizes=z(e,"chunk_sizes",c=>Ee(c,u=>{const h=new Uint32Array(n);return n===4&&(h[3]=t),_e(h.subarray(0,3),u,ht),h})),this.chunkSizes.length===0)throw new Error("No chunk sizes specified.");if(this.sharding=z(e,"sharding",Zh),this.sharding!==void 0&&this.chunkSizes.length!==1)throw new Error("Sharding requires a single chunk size per scale");(this.encoding=z(e,"encoding",c=>ft(c,Sm)))===Sm.COMPRESSED_SEGMENTATION&&(this.compressedSegmentationBlockSize=z(e,"compressed_segmentation_block_size",c=>_e(we(),c,ht))),this.key=z(e,"key",ie),this.hidden=z(e,"hidden",Rx)??!1}}function mL(i){ee(i);const e=z(i,"data_type",E=>ft(E,J)),t=z(i,"num_channels",ht),n=z(i,"type",E=>ft(E,At)),s=z(i,"mesh",cn),r=z(i,"skeletons",cn),o=z(i,"segment_properties",cn),l=z(i,"scales",E=>Ee(E,k=>new Zz(k,t)));if(l.length===0)throw new Error("Expected at least one scale");const c=l[0],u=t===1?3:4,h=new Float64Array(u),g=new Float64Array(u),v=new Float64Array(u),y=["x","y","z"],b=["m","m","m"];for(let E=0;E<3;++E)h[E]=c.resolution[E]/1e9,g[E]=c.voxelOffset[E],v[E]=g[E]+c.size[E];u===4&&(h[3]=1,v[3]=t,y[3]="c^",b[3]="");const C=Ue({rank:u,names:y,units:b,scales:h,boundingBoxes:[qi({lowerBounds:g,upperBounds:v})]});return{dataType:e,volumeType:n,mesh:s,skeletons:r,segmentPropertyMap:o,scales:l,modelSpace:C}}class vL extends di{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.url=n,this.info=s}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return this.info.modelSpace.rank}getSources(e){const t=this.info.scales[0].resolution,{rank:n}=this;return yr(this.info.scales.filter(s=>!s.hidden).map(s=>{const{resolution:r}=s,o=n+1,l=new Float32Array(o*o);l[l.length-1]=1;const{lowerBounds:c,upperBounds:u}=this.info.modelSpace.boundingBoxes[0].box,h=new Float32Array(n),g=new Float32Array(n);for(let v=0;v<3;++v){const y=r[v]/t[v];l[o*v+v]=y;const b=s.voxelOffset[v];l[o*n+v]=b*y,h[v]=c[v]/y-b,g[v]=u[v]/y-b}return n===4&&(l[o*3+3]=1,h[3]=c[3],g[3]=u[3]),po({rank:n,dataType:this.dataType,chunkToMultiscaleTransform:l,upperVoxelBound:s.size,volumeType:this.volumeType,chunkDataSizes:s.chunkSizes,baseVoxelOffset:s.voxelOffset,compressedSegmentationBlockSize:s.compressedSegmentationBlockSize,volumeSourceOptions:e}).map(v=>({chunkSource:this.chunkManager.getChunkSource(qz,{credentialsProvider:this.credentialsProvider,spec:v,parameters:{url:Wi(this.url,s.key),encoding:s.encoding,sharding:s.sharding}}),chunkToMultiscaleTransform:l,lowerClipBound:h,upperClipBound:g}))}))}}const eG=at(ct()(Bc),Cm);class tG extends at(ct()(Eu),wm){}class nG extends eG{constructor(e,t){const{parameters:n}=t;super(e,{rank:n.rank,relationships:n.relationships.map(s=>s.name),properties:n.properties,parameters:n}),this.readonly=!0,this.metadata=t.metadata,this.credentialsProvider=t.credentialsProvider}getSources(){return[this.metadata.spatialIndices.map(e=>{const{spec:t}=e;return{chunkSource:this.chunkManager.getChunkSource(tG,{credentialsProvider:this.credentialsProvider,parent:this,spec:t,parameters:e.parameters}),chunkToMultiscaleTransform:t.chunkToMultiscaleTransform}})]}}function iG(i,e,t){return i.getChunkSource(Kz,{parameters:t,credentialsProvider:e})}function yL(i){return z(i,"transform",e=>{const t=Ve();return e!==void 0&&_e(t.subarray(0,12),e,Xe),Gm(t,t),t})}function sG(i){ee(i);const e=z(i,"@type",ie);let t;if(e==="neuroglancer_legacy_mesh")t=void 0;else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{const s=z(i,"lod_scale_multiplier",wt),r=z(i,"vertex_quantization_bits",ht),o=yL(i),l=z(i,"sharding",Zh);t={lodScaleMultiplier:s,transform:o,sharding:l,vertexQuantizationBits:r}}}const n=z(i,"segment_properties",cn);return{metadata:t,segmentPropertyMap:n}}async function rG(i,e,t){let n;try{n=await Ja(i,e,t)}catch(s){if(Wa(s))return{metadata:void 0};throw s}return sG(n)}function pC(i){return i===void 0?uc.RAW:ft(i,uc)}function Zh(i){if(i===void 0)return;ee(i);const e=z(i,"@type",ie);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);const t=z(i,"hash",c=>ft(c,dy)),n=z(i,"preshift_bits",Je),s=z(i,"shard_bits",Je),r=z(i,"minishard_bits",Je),o=z(i,"minishard_index_encoding",pC),l=z(i,"data_encoding",pC);return{hash:t,preshiftBits:n,shardBits:s,minishardBits:r,minishardIndexEncoding:o,dataEncoding:l}}function oG(i){ee(i);const e=z(i,"@type",ie);if(e!=="neuroglancer_skeletons")throw new Error(`Unsupported skeleton type: ${JSON.stringify(e)}`);const t=yL(i),n=new Map;z(i,"vertex_attributes",o=>{o!==void 0&&Ee(o,l=>{ee(l);const c=z(l,"id",ie);if(c==="")throw new Error("vertex attribute id must not be empty");if(n.has(c))throw new Error(`duplicate vertex attribute id ${JSON.stringify(c)}`);const u=z(l,"data_type",g=>ft(g,J)),h=z(l,"num_components",ht);n.set(c,{dataType:u,numComponents:h})})});const s=z(i,"sharding",Zh),r=z(i,"segment_properties",cn);return{metadata:{transform:t,vertexAttributes:n,sharding:s},segmentPropertyMap:r}}async function aG(i,e,t){const n=await Ja(i,e,t);return oG(n)}function SL(){return Ue({names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)})}async function bL(i,e,t){const{metadata:n,segmentPropertyMap:s}=await rG(i,e,t);if(n===void 0)return{source:iG(i,e,{url:t,lod:0}),transform:Ve(),segmentPropertyMap:s};let r;const{vertexQuantizationBits:o}=n;if(o===10)r=cr.uint10;else if(o===16)r=cr.uint16;else throw new Error(`Invalid vertex quantization bits: ${o}`);return{source:i.getChunkSource(Xz,{credentialsProvider:e,parameters:{url:t,metadata:n},format:{fragmentRelativeVertices:!0,vertexPositionFormat:r}}),transform:n.transform,segmentPropertyMap:s}}async function wL(i,e,t){const{metadata:n,segmentPropertyMap:s}=await aG(i,e,t);return{source:i.getChunkSource(Qz,{credentialsProvider:e,parameters:{url:t,metadata:n}}),transform:n.transform,segmentPropertyMap:s}}function Ja(i,e,t){return i.memoize.getUncounted({type:"precomputed:metadata",url:t,credentialsProvider:jt(e)},async()=>await ei(e,`${t}/info`,{},tn))}function gC(i){const e=Ve(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function lG(i,e,t,n){const s=mL(n),r=new vL(i.chunkManager,e,t,s),{modelSpace:o}=s,l=[{id:"default",default:!0,subsource:{volume:r}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(o.bounds)}}];if(s.segmentPropertyMap!==void 0){const c=Wi(t,s.segmentPropertyMap),u=await Ja(i.chunkManager,e,c),h=Kc(i.chunkManager,e,u);l.push({id:"properties",default:!0,subsource:{segmentPropertyMap:h}})}if(s.mesh!==void 0){const c=Wi(t,s.mesh),{source:u,transform:h}=await bL(i.chunkManager,e,c),g=gC(s);zt(g,g,h),l.push({id:"mesh",default:!0,subsource:{mesh:u},subsourceToModelSubspaceTransform:g})}if(s.skeletons!==void 0){const c=Wi(t,s.skeletons),{source:u,transform:h}=await wL(i.chunkManager,e,c),g=gC(s);zt(g,g,h),l.push({id:"skeletons",default:!0,subsource:{mesh:u},subsourceToModelSubspaceTransform:g})}return{modelTransform:Jt(o),subsources:l}}async function cG(i,e,t){const{source:n,transform:s,segmentPropertyMap:r}=await wL(i.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:s}];if(r!==void 0){const l=Wi(t,r),c=await Ja(i.chunkManager,e,l),u=Kc(i.chunkManager,e,c);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:u}})}return{modelTransform:Jt(SL()),subsources:o}}function Fp(i,e){return ee(e),{url:Wi(i,z(e,"key",ie)),sharding:z(e,"sharding",Zh)}}class dG{constructor(e,t){this.url=e,ee(t);const n=z(t,"dimensions",vu),{rank:s}=n,r=z(t,"lower_bound",l=>_e(new Float64Array(s),l,Xe)),o=z(t,"upper_bound",l=>_e(new Float64Array(s),l,Xe));this.coordinateSpace=Ue({rank:s,names:n.names,units:n.units,scales:n.scales,boundingBoxes:[qi({lowerBounds:r,upperBounds:o})]}),this.parameters={type:z(t,"annotation_type",l=>ft(l,st)),rank:s,relationships:z(t,"relationships",l=>Ee(l,c=>{const u=Fp(e,c),h=z(c,"id",ie);return{...u,name:h}})),properties:z(t,"properties",Fx),byId:z(t,"by_id",l=>Fp(e,l))},this.spatialIndices=z(t,"spatial",l=>Ee(l,c=>{const u=Fp(e,c),h=z(c,"grid_shape",C=>_e(new Float32Array(s),C,ht)),g=z(c,"chunk_size",C=>_e(new Float32Array(s),C,wt)),v=z(c,"limit",ht),y=new Float32Array(s);for(let C=0;C<s;++C)y[C]=h[C]*g[C];const b=ai(Float32Array,s+1);for(let C=0;C<s;++C)b[(s+1)*s+C]=r[C];const w={limit:v,chunkToMultiscaleTransform:b,...Eh({rank:s,chunkDataSize:g,upperVoxelBound:y})};return w.upperChunkBound=h,{parameters:u,spec:w,limit:v}})),this.spatialIndices.reverse()}}async function uG(i,e,t,n){const s=new dG(t,n);return{modelTransform:Jt(s.coordinateSpace),subsources:[{id:"default",default:!0,subsource:{annotation:i.chunkManager.getChunkSource(nG,{credentialsProvider:e,metadata:s,parameters:s.parameters})}}]}}async function mC(i,e,t){const{source:n,transform:s,segmentPropertyMap:r}=await bL(i.chunkManager,e,t),o=[{id:"default",default:!0,subsource:{mesh:n},subsourceToModelSubspaceTransform:s}];if(r!==void 0){const l=Wi(t,r),c=await Ja(i.chunkManager,e,l),u=Kc(i.chunkManager,e,c);o.push({id:"properties",default:!0,subsource:{segmentPropertyMap:u}})}return{modelTransform:Jt(SL()),subsources:o}}function hG(i){ee(i);const e=new X,t=z(i,"ids",r=>{r=Zn(r);const o=r.length,l=new Uint32Array(o*2);for(let c=0;c<o;++c){if(!e.tryParseString(r[c]))throw new Error(`Invalid uint64 id: ${JSON.stringify(r[c])}`);l[2*c]=e.low,l[2*c+1]=e.high}return l}),n=t.length/2,s=z(i,"properties",r=>Ee(r,o=>{ee(o);const l=z(o,"id",ie),c=oe(o,"description",ie),u=z(o,"type",g=>{if(g!=="label"&&g!=="description"&&g!=="string"&&g!=="tags"&&g!=="number")throw new Error(`Invalid property type: ${JSON.stringify(g)}`);return g});if(u==="tags"){const g=z(o,"tags",Zn);let v=oe(o,"tag_descriptions",Zn);if(v===void 0)v=new Array(g.length),v.fill("");else if(v.length!==g.length)throw new Error(`Expected tag_descriptions to have length: ${g.length}`);const y=z(o,"values",b=>{if(!Array.isArray(b)||b.length!==n)throw new Error(`Expected ${n} values, but received: ${b.length}`);return b.map(w=>String.fromCharCode(...w))});return{id:l,description:c,type:u,tags:g,tagDescriptions:v,values:y}}if(u==="number"){const g=z(o,"data_type",w=>ft(w,J));if(g===J.UINT64)throw new Error("uint64 properties not supported");const v=z(o,"values",w=>{if(!Array.isArray(w)||w.length!==n)throw new Error(`Expected ${n} values, but received: ${w.length}`);return Lx[g].from(w)});let y=1/0,b=-1/0;for(let w=v.length-1;w>=0;--w){const C=v[w];C<y&&(y=C),C>b&&(b=C)}return{id:l,description:c,type:u,dataType:g,values:v,bounds:[y,b]}}const h=z(o,"values",g=>{if(Zn(g),g.length!==n)throw new Error(`Expected ${n} values, but received: ${g.length}`);return g});return{id:l,description:c,type:u,values:h}}));return iV({ids:t,properties:s})}at(ct()(X_),xm);function Kc(i,e,t,n){try{const s=z(t,"@type",ie);if(s!=="neuroglancer_segment_properties")throw new Error(`Unsupported segment property map type: ${JSON.stringify(s)}`);const r=oe(t,"inline",hG);return new AT({inlineProperties:r})}catch(s){throw new Error(`Error parsing segment property map: ${s.message}`)}}async function fG(i,e,t,n){return{modelTransform:Jt(pa),subsources:[{id:"default",default:!0,subsource:{segmentPropertyMap:Kc(i.chunkManager,e,n)}}]}}const pG=/^([^#]*)(?:#(.*))?$/;function Jr(i){let[,e,t]=i.match(pG);e.endsWith("/")&&(e=e.substring(0,e.length-1));const n=Ma(t||"");return{url:e,parameters:n}}function $u(i,e){const t=XA(e);return t&&(i+=`#${t}`),i}class CL extends Bn{get description(){return"Precomputed file-backed data source"}normalizeUrl(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.providerProtocol+"://"+$u(t,n)}convertLegacyUrl(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.type==="mesh"&&(n.type="mesh"),e.providerProtocol+"://"+$u(t,n)}get(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"precomputed:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=Ai(t,e.credentialsManager);let o;try{o=await Ja(e.chunkManager,r,s)}catch(u){if(Wa(u)&&n.type==="mesh")return await mC(e,r,s);throw u}ee(o);const l=oe(o,"redirect",ie);if(l!==void 0)throw new Cv(l);const c=oe(o,"@type",ie);switch(c){case"neuroglancer_skeletons":return await cG(e,r,s);case"neuroglancer_multilod_draco":case"neuroglancer_legacy_mesh":return await mC(e,r,s);case"neuroglancer_annotations_v1":return await uG(e,r,s,o);case"neuroglancer_segment_properties":return await fG(e,r,s,o);case"neuroglancer_multiscale_volume":case void 0:return await lG(e,r,s,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}class gG extends at(ct()(Ps),ym){}function mG(i){const{width:e,height:t,tilesize:n,overlap:s,format:r}=i,o=ft(r,gL),l=new Array;let c=e,u=t;for(;c>1||u>1;)l.push({width:c,height:u}),c=Math.ceil(c/2),u=Math.ceil(u/2);l.push({width:c,height:u});const h=3,g=Float64Array.of(1/1e9,1/1e9,1),v=new Float64Array(h),y=Float64Array.of(e,t,3),E=Ue({rank:h,names:["x","y","c^"],units:["m","m",""],scales:g,boundingBoxes:[qi({lowerBounds:v,upperBounds:y})]});return{levels:l,modelSpace:E,overlap:s,tilesize:n,format:r,encoding:o}}class vG extends di{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.info=s,this.url=n.substring(0,n.lastIndexOf("."))+"_files"}get dataType(){return J.UINT8}get volumeType(){return At.IMAGE}get rank(){return this.info.modelSpace.rank}getSources(e){const{rank:t}=this,n=[Uint32Array.of(this.info.tilesize,this.info.tilesize,3)];return yr(this.info.levels.map((s,r,o)=>{const l=1<<r,c=t+1,u=new Float32Array(c*c);u[u.length-1]=1;const{upperBounds:h}=this.info.modelSpace.boundingBoxes[0].box,g=new Float32Array(t);for(let v=0;v<2;++v)u[c*v+v]=l,g[v]=h[v]/l;return u[c*2+2]=1,g[2]=h[2],po({rank:t,dataType:this.dataType,chunkToMultiscaleTransform:u,upperVoxelBound:Float32Array.of(s.width,s.height,3),volumeType:this.volumeType,chunkDataSizes:n,volumeSourceOptions:e}).map(v=>({chunkSource:this.chunkManager.getChunkSource(gG,{credentialsProvider:this.credentialsProvider,spec:v,parameters:{url:Wi(this.url,(o.length-1-r).toString()),encoding:this.info.encoding,format:this.info.format,overlap:this.info.overlap,tilesize:this.info.tilesize}}),chunkToMultiscaleTransform:u,upperClipBound:g}))}))}}function yG(i,e,t){if(t.endsWith(".json")||t.includes(".json?"))throw new Error("DZI-JSON: OpenSeadragon hack not supported yet.");return i.memoize.getUncounted({type:"deepzoom:metadata",url:t,credentialsProvider:jt(e)},async()=>{const n=await ei(e,t,{},cy),r=new DOMParser().parseFromString(n,"text/xml").documentElement,o=ee(r.getElementsByTagName("Size").item(0));return{width:ht(o.getAttribute("Width")),height:ht(o.getAttribute("Height")),tilesize:ht(ie(r.getAttribute("TileSize"))),overlap:Je(ie(r.getAttribute("Overlap"))),format:ie(r.getAttribute("Format"))}})}async function SG(i,e,t,n){const s=mG(n),r=new vG(i.chunkManager,e,t,s),{modelSpace:o}=s,l=[{id:"default",default:!0,subsource:{volume:r}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(o.bounds)}}];return{modelTransform:Jt(o),subsources:l}}class bG extends Bn{get description(){return"Deep Zoom file-backed data source"}normalizeUrl(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.providerProtocol+"://"+$u(t,n)}convertLegacyUrl(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.providerProtocol+"://"+$u(t,n)}get(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"deepzoom:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=Ai(t,e.credentialsManager),o=await yG(e.chunkManager,r,s);return SG(e,r,s,o)})}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("deepzoom",()=>new bG);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var xi=(i=>(i[i.JPEG=0]="JPEG",i[i.RAW=1]="RAW",i[i.COMPRESSED_SEGMENTATION=2]="COMPRESSED_SEGMENTATION",i[i.COMPRESSED_SEGMENTATIONARRAY=3]="COMPRESSED_SEGMENTATIONARRAY",i))(xi||{});class uy{}var Ec;let wG=(Ec=class extends uy{},Ec.RPC_ID="dvid/VolumeChunkSource",Ec);const Vy=class Vy extends uy{};Vy.RPC_ID="dvid/SkeletonSource";let Em=Vy;var Tc;let CG=(Tc=class extends uy{},Tc.RPC_ID="dvid/MeshSource",Tc);const ef=new Map;ef.set("uint8",J.UINT8);ef.set("uint32",J.UINT32);ef.set("uint64",J.UINT64);class xG{constructor(e){this.obj=e,ee(e),z(e,"TypeName",ie)}get typeName(){return this.obj.TypeName}get compressionName(){return this.obj.Compression}}class EG{constructor(e,t,n){this.obj=e,this.name=t,this.base=n}}class TG extends at(ct()(Ps),wG){}class kG extends at(ct()(Wh),Em){}class LG extends at(ct()(fo),CG){}class eu extends EG{constructor(e,t,n,s,r){super(e,t,n),this.encoding=s;const o=z(e,"Extended",ee),l=z(o,"Values",u=>Ee(u,ee));if(l.length<1)throw new Error("Expected Extended.Values property to have length >= 1, but received: ${JSON.stringify(extendedValues)}.");this.numLevels=1;const c=new Set(r);if(s===xi.COMPRESSED_SEGMENTATIONARRAY){const u=z(o,"MaxDownresLevel",ht);this.numLevels=u+1}else for(;c.has(t+"_"+this.numLevels.toString());)this.numLevels+=1;c.has(t+"_meshes")?this.meshSrc=t+"_meshes":this.meshSrc="",c.has(t+"_skeletons")?this.skeletonSrc=t+"_skeletons":this.skeletonSrc="",this.dataType=z(l[0],"DataType",u=>Ax(u,ef)),this.voxelSize=z(o,"VoxelSize",u=>_e(we(),u,wt)),this.blockSize=z(o,"BlockSize",u=>_e(we(),u,wt)),this.lowerVoxelBound=z(o,"MinPoint",u=>Y0(we(),u)),this.upperVoxelBoundInclusive=z(o,"MaxPoint",u=>Y0(we(),u))}get volumeType(){return this.encoding===xi.COMPRESSED_SEGMENTATION||this.encoding===xi.COMPRESSED_SEGMENTATIONARRAY?At.SEGMENTATION:At.IMAGE}getSources(e,t,n,s){const{encoding:r}=this,o=[],l=64;for(let c=0;c<this.numLevels;++c){const u=2**c,h=2**-c,g=we(),v=we();for(let E=0;E<3;++E){const k=Math.floor(this.lowerVoxelBound[E]*h);g[E]=k-k%l;const D=Math.ceil((this.upperVoxelBoundInclusive[E]+1)*h);v[E]=D,D%l!==0&&(v[E]+=l-D%l)}let y=t.dataInstanceKey;r!==xi.COMPRESSED_SEGMENTATIONARRAY&&c>0&&(y+="_"+c.toString());const b={baseUrl:t.baseUrl,nodeKey:t.nodeKey,dataInstanceKey:y,dataScale:c.toString(),encoding:r},w=Ve();for(let E=0;E<3;++E)w[5*E]=u,w[12+E]=g[E]*u;const C=po({rank:3,chunkToMultiscaleTransform:w,dataType:this.dataType,baseVoxelOffset:g,upperVoxelBound:gA(we(),v,g),volumeType:this.volumeType,volumeSourceOptions:n,compressedSegmentationBlockSize:r===xi.COMPRESSED_SEGMENTATION||r===xi.COMPRESSED_SEGMENTATIONARRAY?Et(8,8,8):void 0}).map(E=>({chunkSource:e.getChunkSource(TG,{spec:E,parameters:b,credentialsProvider:s}),chunkToMultiscaleTransform:w}));o.push(C)}return yr(o)}}function DG(i,e,t){ee(i);const n=z(i,"Base",s=>new xG(s));switch(n.typeName){case"uint8blk":case"grayscale8":{const s=n.compressionName.indexOf("jpeg")!==-1;return new eu(i,e,n,s?xi.JPEG:xi.RAW,t)}case"labels64":case"labelblk":return new eu(i,e,n,xi.COMPRESSED_SEGMENTATION,t);case"labelarray":case"labelmap":return new eu(i,e,n,xi.COMPRESSED_SEGMENTATIONARRAY,t);default:throw new Error(`DVID data type ${JSON.stringify(n.typeName)} is not supported.`)}}class Wu{constructor(e){if(this.errors=[],this.dataInstances=new Map,this.vnodes=new Set,e instanceof Wu){this.alias=e.alias,this.description=e.description,this.errors=e.errors,this.dataInstances=e.dataInstances;return}ee(e),this.alias=z(e,"Alias",ie),this.description=z(e,"Description",ie);const t=z(e,"DataInstances",ee),n=Object.keys(t);for(const o of n)try{this.dataInstances.set(o,DG(t[o],o,n))}catch(l){const c=`Failed to parse data instance ${JSON.stringify(o)}: ${l.message}`;console.log(c),this.errors.push(c)}const s=z(e,"DAG",ee),r=z(s,"Nodes",ee);for(const o of Object.keys(r))this.vnodes.add(o)}}function IG(i){try{const e=Jl(i,n=>new Wu(n)),t=new Map;for(const[n,s]of e){t.set(n,s);for(const r of s.vnodes)if(r!==n){const o=new Wu(s);t.set(r,o)}}for(const[n,s]of t)s.uuid=n;return t}catch(e){throw new Error(`Failed to parse DVID repositories info: ${e.message}`)}}class PG{constructor(e){this.repositories=IG(e)}getNode(e){const t=[];for(const n of this.repositories.keys())n.startsWith(e)&&t.push(n);if(t.length!==1)throw new Error(`Node key ${JSON.stringify(e)} matches ${JSON.stringify(t)} nodes.`);return this.repositories.get(t[0])}}function xL(i,e,t){return i.memoize.getUncounted({type:"dvid:getServerInfo",baseUrl:e},()=>{const n=Fz(t,{url:`${e}/api/repos/info`,method:"GET",responseType:"json"}).then(r=>new PG(r)),s=`repository info for DVID server ${e}`;return Pe.forPromise(n,{initialMessage:`Retrieving ${s}.`,delay:!0,errorPrefix:`Error retrieving ${s}: `}),n})}class AG extends di{constructor(e,t,n,s,r,o){super(e),this.baseUrl=t,this.nodeKey=n,this.dataInstanceKey=s,this.info=r,this.credentialsProvider=o}get dataType(){return this.info.dataType}get volumeType(){return this.info.volumeType}get rank(){return 3}getSources(e){return this.info.getSources(this.chunkManager,{baseUrl:this.baseUrl,nodeKey:this.nodeKey,dataInstanceKey:this.dataInstanceKey},e,this.credentialsProvider)}}const RG=/^((?:http|https):\/\/[^/]+)\/([^/]+)\/([^/]+)(\?.*)?$/;function EL(i){if(i.startsWith("https"))return i+"/api/server/token"}function NG(i){const e=i.match(RG);if(e===null)throw new Error(`Invalid DVID URL: ${JSON.stringify(i)}.`);const t={baseUrl:e[1],nodeKey:e[2],dataInstanceKey:e[3]},n=e[4];if(n&&n.length>1){const s=Ma(n.substring(1));s.user&&(t.user=s.user)}return t.authServer=EL(t.baseUrl),t}function MG(i,e,t,n){const s=e.baseUrl,r=e.nodeKey,o=e.dataInstanceKey,l=t,c={lowerBounds:new Float64Array(l.lowerVoxelBound),upperBounds:Float64Array.from(l.upperVoxelBoundInclusive,v=>v+1)},u=Ue({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(l.voxelSize,v=>v/1e9),boundingBoxes:[qi(c)]}),h=new AG(i.chunkManager,s,r,o,l,n),g={modelTransform:Jt(u),subsources:[{id:"default",subsource:{volume:h},default:!0}]};if(l.meshSrc){const v=Ve();for(let y=0;y<3;++y)v[5*y]=1/l.voxelSize[y];g.subsources.push({id:"meshes",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(LG,{parameters:{...e,dataInstanceKey:l.meshSrc},credentialsProvider:n})},subsourceToModelSubspaceTransform:v})}return l.skeletonSrc&&g.subsources.push({id:"skeletons",default:!0,subsource:{mesh:i.chunkManager.getChunkSource(kG,{parameters:{...e,dataInstanceKey:l.skeletonSrc},credentialsProvider:n})}}),g.subsources.push({id:"bounds",subsource:{staticAnnotations:Yi(c)},default:!0}),g}function OG(i){const e=NG(i.providerUrl),{baseUrl:t,nodeKey:n,dataInstanceKey:s}=e;return i.chunkManager.memoize.getUncounted({type:"dvid:MultiscaleVolumeChunkSource",baseUrl:t,nodeKey:n,dataInstanceKey:s},async()=>{const r=i.credentialsManager.getCredentialsProvider(ly,{dvidServer:e.baseUrl,authServer:e.authServer}),l=(await xL(i.chunkManager,t,r)).getNode(n);if(l===void 0)throw new Error(`Invalid node: ${JSON.stringify(n)}.`);const c=l.dataInstances.get(s);if(!(c instanceof eu))throw new Error(`Invalid data instance ${s}.`);return MG(i,e,c,r)})}function _G(i,e){return{offset:0,completions:On(e,i.dataInstances.values(),t=>t.name,t=>`${t.base.typeName}`)}}function VG(i,e){const t=e.match(/^(?:([^/]+)(?:\/([^/]*))?)?$/);if(t===null)throw new Error("Invalid DVID URL syntax.");if(t[2]===void 0)return{offset:0,completions:On(e,i.repositories.values(),r=>r.uuid+"/",r=>`${r.alias}: ${r.description}`)};const n=t[1],s=i.getNode(n);return br(n.length+1,_G(s,t[2]))}async function BG(i){const e=/^((?:http|https):\/\/[^/]+)\/([^?]*).*$/,n=i.providerUrl.match(e);if(n===null)throw null;const s=n[1],r=n[2],o=EL(s),l=await xL(i.chunkManager,s,i.credentialsManager.getCredentialsProvider(ly,{dvidServer:s,authServer:o}));return br(s.length+1,VG(l,r))}class FG extends Bn{constructor(e){super(),this.credentialsManager=e}get description(){return"DVID"}get(e){return OG(e)}completeUrl(e){return BG(e)}}un("dvid",i=>new FG(i.credentialsManager));async function UG(i,e=pt){return{token:await jc(i,{method:"GET",credentials:"include"},cy,e)}}class zG extends Ki{constructor(e){super(),this.authServer=e,this.get=As(t=>{if(!this.authServer)return Promise.resolve({token:""});const n=new Pe(!0);let s;return new Promise((r,o)=>{const l=()=>{s=void 0,n.dispose()};t.add(()=>{s!==void 0&&(s.cancel(),s=void 0,n.dispose(),o(Hi))});function c(h,g="DVID authorization required.",v="Request authorization."){n.setText(g+" ");const y=document.createElement("button");y.textContent=v,n.element.appendChild(y),y.addEventListener("click",()=>{const b=h.match(/^[^/]+\/\/[^/.]+\.([^/]+)/);if(b){const w=`https://flyemlogin.${b[1]}/login`;window.alert(`Please log into ${w} and then refresh the neurogalncer page to try again.
If you are unable to log into ${w}, please check your authorization server ${h} to make sure it is correct.`)}else window.alert(`Please check your authorization server ${h} to make sure it is correct.`)}),n.setVisible(!0)}function u(h){s!==void 0&&s.cancel(),s=new Sr,c(h,"Waiting for DVID authorization...","Retry"),UG(h,s).then(g=>{s!==void 0&&(l(),r(g))},g=>{s!==void 0&&(s=void 0,c(h,`DVID authorization failed: ${g}.`,"Retry"))})}u(this.authServer)})})}}class GG extends J3{constructor(e,t){super(new zG(t),{})}}Rs.register(ly,i=>new GG(i.dvidServer,i.authServer));const Gd=1,$G="GrapheneMeshSource:NewSegment";var kc;let f5=(kc=class{},kc.RPC_ID="graphene/VolumeChunkSource",kc);const By=class By{};By.RPC_ID="graphene/ChunkedGraphSource";let Tm=By;const Fy=class Fy{};Fy.RPC_ID="graphene/MeshSource";let km=Fy;const $d=async i=>i;function WG(i,e){const t=X.rshift(new X,i,64-e);return X.equal(t,X.ONE)}function HG(i){if(i.charAt(0)==="~"){const t=i.substring(1).split(/:(.+)/);return{key:t[0],fragmentId:t[1]}}return{key:i,fragmentId:i}}const JG="ChunkedGraphLayer",jG="ChunkedGraphLayer:updateSources";function YG(i){const{rank:e,dataType:t}=i,{baseVoxelOffset:n=new Float32Array(e)}=i;return{...Eh(i),baseVoxelOffset:n,dataType:t}}function tf(i,e=0){const t=SA([...i]);return t[3]=e,t}const Hu=Et(1,0,0),hy=Et(0,0,1),qG=tf(Hu,.5),KG=tf(hy,.5),XG=tf(Hu,.25),QG=tf(hy,.25),ZG=so(.5,.5,.5,.01),e4=new X(da(qG)),t4=new X(da(KG)),n4=new X(da(ZG)),i4=so(0,0,0,.5);class s4 extends at(ct()(fo),km){getFragmentKey(e,t){return HG(t)}}class r4{constructor(e,t){const n=/^(https?:\/\/[.\w:\-/]+)\/segmentation\/(?:1\.0|table)\/([^/]+)\/?$/,s=e.match(n);if(s===null)throw Error(`Graph URL invalid: ${e}`);this.segmentationUrl=`${s[1]}/segmentation/api/v${Gd}/table/${s[2]}`,this.meshingUrl=`${s[1]}/meshing/api/v${Gd}/table/${s[2]}`;try{ee(t),this.supported_api_versions=z(t,"supported_api_versions",r=>Ee(r,KA))}catch{this.supported_api_versions=[0]}if(!(Gd in this.supported_api_versions)){const r=`This Neuroglancer branch requires Graph Server version ${Gd}, but the server only supports version(s) ${this.supported_api_versions}.`;throw new Error(r)}}}const o4=8;class a4{constructor(e){ee(e),this.chunkSize=z(e,"chunk_size",t=>_e(we(),t,ht)),this.nBitsForLayerId=oe(e,"n_bits_for_layer_id",ht,o4)}}function l4(i,e,t){const n=mL(i),s=z(i,"data_dir",l=>Ai(l,t)).url,r=z(i,"app",l=>new r4(e,l)),o=z(i,"graph",l=>new a4(l));return{...n,app:r,graph:o,dataUrl:s}}class c4 extends vL{constructor(e,t,n){super(e,void 0,n.dataUrl,n),this.chunkedGraphCredentialsProvider=t,this.info=n}getChunkedGraphSource(){const{rank:e}=this,t=this.info.scales[0],n=YG({rank:e,dataType:this.info.dataType,upperVoxelBound:t.size,chunkDataSize:Uint32Array.from(this.info.graph.chunkSize),baseVoxelOffset:t.voxelOffset}),s=e+1,r=new Float32Array(s*s);r[r.length-1]=1;const{lowerBounds:o,upperBounds:l}=this.info.modelSpace.boundingBoxes[0].box,c=new Float32Array(e),u=new Float32Array(e);for(let h=0;h<3;++h)r[s*h+h]=1,r[s*e+h]=t.voxelOffset[h],c[h]=o[h],u[h]=l[h];return{chunkSource:this.chunkManager.getChunkSource(T4,{spec:n,credentialsProvider:this.chunkedGraphCredentialsProvider,parameters:{url:`${this.info.app.segmentationUrl}/node`}}),chunkToMultiscaleTransform:r,lowerClipBound:c,upperClipBound:u}}}function vC(i){return z(i,"transform",e=>{const t=Ve();return e!==void 0&&_e(t.subarray(0,12),e,Xe),Gm(t,t),t})}function d4(i){ee(i);const e=z(i,"@type",ie);let t;if(e==="neuroglancer_legacy_mesh"){const s=z(i,"sharding",SC);s===void 0?t=void 0:t={lodScaleMultiplier:0,transform:vC(i),sharding:s,vertexQuantizationBits:10}}else{if(e!=="neuroglancer_multilod_draco")throw new Error(`Unsupported mesh type: ${JSON.stringify(e)}`);{const s=z(i,"lod_scale_multiplier",wt),r=z(i,"vertex_quantization_bits",ht),o=vC(i),l=z(i,"sharding",SC);t={lodScaleMultiplier:s,transform:o,sharding:l,vertexQuantizationBits:r}}}const n=z(i,"segment_properties",cn);return{metadata:t,segmentPropertyMap:n}}async function u4(i,e,t){let n;try{n=await fy(i,e,t)}catch(s){if(Wa(s))return{metadata:void 0};throw s}return d4(n)}function yC(i){return i===void 0?uc.RAW:ft(i,uc)}function h4(i){if(i===void 0)return;ee(i);const e=z(i,"@type",ie);if(e!=="neuroglancer_uint64_sharded_v1")throw new Error(`Unsupported sharding format: ${JSON.stringify(e)}`);const t=z(i,"hash",c=>ft(c,dy)),n=z(i,"preshift_bits",Je),s=z(i,"shard_bits",Je),r=z(i,"minishard_bits",Je),o=z(i,"minishard_index_encoding",yC),l=z(i,"data_encoding",yC);return{hash:t,preshiftBits:n,shardBits:s,minishardBits:r,minishardIndexEncoding:o,dataEncoding:l}}function SC(i){if(i===void 0)return;ee(i);const e=new Array;for(const t in i){const n=Number(t);e[n]=h4(i[n])}return e}function f4(i,e,t){return i.getChunkSource(s4,{parameters:e,credentialsProvider:t})}async function p4(i,e,t,n,s){const{metadata:r,segmentPropertyMap:o}=await u4(i,void 0,n),l={manifestUrl:t,fragmentUrl:n,lod:0,sharding:r==null?void 0:r.sharding,nBitsForLayerId:s},c=(r==null?void 0:r.transform)||Ve();return{source:f4(i,l,e),transform:c,segmentPropertyMap:o}}function fy(i,e,t){return i.memoize.getUncounted({type:"graphene:metadata",url:t,credentialsProvider:jt(e)},async()=>await ei(e,`${t}/info`,{},tn))}function g4(i){const e=Ve(),t=i.scales[0].resolution;for(let n=0;n<3;++n)e[5*n]=1/t[n];return e}async function m4(i,e,t,n){const s=l4(n,t,i.credentialsManager),r=new c4(i.chunkManager,e,s),o=new S4;i.state&&o.restoreState(i.state);const l=new x4(s,e,r,o),{modelSpace:c}=s,u=[{id:"default",default:!0,subsource:{volume:r}},{id:"graph",default:!0,subsource:{segmentationGraph:l}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(c.bounds)}}];if(s.segmentPropertyMap!==void 0){const h=Wi(t,s.segmentPropertyMap),g=await fy(i.chunkManager,e,h),v=Kc(i.chunkManager,e,g);u.push({id:"properties",default:!0,subsource:{segmentPropertyMap:v}})}if(s.mesh!==void 0){const{source:h,transform:g}=await p4(i.chunkManager,e,s.app.meshingUrl,Wi(s.dataUrl,s.mesh),s.graph.nBitsForLayerId),v=g4(s);zt(v,v,g),u.push({id:"mesh",default:!0,subsource:{mesh:h},subsourceToModelSubspaceTransform:v})}return{modelTransform:Jt(c),subsources:u,state:o}}class v4 extends CL{get description(){return"Graphene file-backed data source"}get(e){const{url:t,parameters:n}=Jr(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"graphene:get",providerUrl:t,parameters:n},async()=>{const{url:s,credentialsProvider:r}=Ai(t,e.credentialsManager);let o;try{o=await fy(e.chunkManager,r,s)}catch(u){throw Wa(u)&&n.type==="mesh"&&console.log("does this happen?"),u}ee(o);const l=oe(o,"redirect",ie);if(l!==void 0)throw new Cv(l);const c=oe(o,"@type",ie);switch(c){case"neuroglancer_multiscale_volume":case void 0:return await m4(e,r,s,o);default:throw new Error(`Invalid type: ${JSON.stringify(c)}`)}})}}function Ju(i){for(const e of i.dataSources){const{loadState:t}=e;if(!(t===void 0||t.error!==void 0)){for(const n of t.subsources)if(n.enabled&&n.subsourceEntry.id==="graph")return n}}}function Up(i,e,t,n){const{subsourceEntry:s}=e,r=new Ux(e.loadedDataSource.transform,[],["associated segments"]),o=new J1;o.color.value.set(n),o.relationshipStates.set("associated segments",{segmentationState:new Ne(i.displayState),showMatches:new ut(!1)});const l=new wu({localPosition:i.localPosition,transform:e.getRenderLayerTransform(),source:r,displayState:o,dataSource:e.loadedDataSource.layerDataSource,subsourceIndex:e.subsourceIndex,subsourceId:s.id,subsubsourceId:t,role:fr.ANNOTATION});return i.addAnnotationLayerState(l,e),l}function y4(i,e){return oe(i,e,t=>X.parseString(String(t)))}function bC(i,e){return z(i,e,t=>X.parseString(String(t)))}function Lm(i){const e=bC(i,py),t=bC(i,gy),n=z(i,my,s=>Mx(s));return{segmentId:e,rootId:t,position:n}}const wC="id",CC="error",xC="multicut",EC="focusSegment",TC="sinks",kC="sources",py="segmentId",gy="rootId",my="position",LC="merge",DC="merges",IC="autosubmit",PC="sink",AC="source",RC="mergedRoot",NC="locked";class S4{constructor(){this.changed=new ue,this.multicutState=new w4,this.mergeState=new b4,this.multicutState.changed.add(()=>{this.changed.dispatch()}),this.mergeState.changed.add(()=>{this.changed.dispatch()})}reset(){this.multicutState.reset(),this.mergeState.reset()}toJSON(){return{[xC]:this.multicutState.toJSON(),[LC]:this.mergeState.toJSON()}}restoreState(e){oe(e,xC,t=>{this.multicutState.restoreState(t)}),oe(e,LC,t=>{this.mergeState.restoreState(t)})}}class b4 extends K{constructor(){super(),this.changed=new ue,this.merges=new Ne([]),this.autoSubmit=new ut(!1),this.registerDisposer(this.merges.changed.add(this.changed.dispatch))}reset(){this.merges.value=[],this.autoSubmit.reset()}toJSON(){const{merges:e,autoSubmit:t}=this,n=r=>({[py]:r.segmentId.toJSON(),[gy]:r.rootId.toJSON(),[my]:[...r.position]}),s=r=>{const o={[wC]:r.id,[NC]:r.locked,[PC]:n(r.sink),[AC]:n(r.source)};return r.mergedRoot&&(o[RC]=r.mergedRoot.toJSON()),r.error&&(o[CC]=r.error),o};return{[DC]:e.value.filter(r=>r.source).map(s),[IC]:t.toJSON()}}restoreState(e){function t(s){const r=y4(s,RC),o=z(s,wC,ie),l=oe(s,CC,ie),c=z(s,NC,Ss),u=Lm(s[PC]),h=Lm(s[AC]);return{id:o,locked:c,sink:u,source:h,mergedRoot:r,error:l}}const n=s=>Ee(s,r=>t(r));this.merges.value=z(e,DC,n),this.autoSubmit.restoreState(oe(e,IC,Ss))}}class w4 extends K{constructor(e=new bt(void 0,n=>n),t=new Ne(!1)){super(),this.focusSegment=e,this.blueGroup=t,this.changed=new ue,this.sinks=new Xp,this.sources=new Xp;const n=()=>{this.sinks.size===0&&this.sources.size===0&&(this.focusSegment.value=void 0)};this.registerDisposer(e.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(n)),this.registerDisposer(this.sources.changed.add(n)),this.registerDisposer(this.blueGroup.changed.add(this.changed.dispatch)),this.registerDisposer(this.sinks.changed.add(this.changed.dispatch)),this.registerDisposer(this.sources.changed.add(this.changed.dispatch))}reset(){this.focusSegment.value=void 0,this.blueGroup.value=!1,this.sinks.clear(),this.sources.clear()}toJSON(){const{focusSegment:e,sinks:t,sources:n}=this,s=r=>({[py]:r.segmentId.toJSON(),[gy]:r.rootId.toJSON(),[my]:[...r.position]});return{[EC]:e.toJSON(),[TC]:[...t].map(s),[kC]:[...n].map(s)}}restoreState(e){const t=r=>Ee(r,o=>Lm(o));oe(e,EC,r=>{this.focusSegment.restoreState(X.parseString(String(r)))});const n=z(e,TC,t),s=z(e,kC,t);for(const r of n)this.sinks.add(r);for(const r of s)this.sources.add(r)}swapGroup(){this.blueGroup.value=!this.blueGroup.value}get activeGroup(){return this.blueGroup.value?this.sources:this.sinks}get segments(){return[...this.redSegments,...this.blueSegments]}get redSegments(){return[...this.sinks].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}get blueSegments(){return[...this.sources].filter(e=>!X.equal(e.segmentId,e.rootId)).map(e=>e.segmentId)}}let nf=class extends Gv{constructor(e,t,n,s){super(e,t.displayState.segmentationGroupState.value),this.graph=e,this.layer=t,this.chunkSource=n,this.state=s,this.annotationLayerStates=[],this.lastDeselectionMessageExists=!1,this.deleteMergeSubmission=g=>{const{mergeAnnotationState:v}=this;g.locked=!1,v.source.delete(v.source.getReference(g.id))},this.submitMerge=async(g,v=1)=>{this.graph;const b=Ju(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(w=>w/1e-9);g.error=void 0;for(let w=1;w<=v;w++)try{return await this.graph.graphServer.mergeSegments(g.sink,g.source,b)}catch(C){if(w===v)throw g.error=C.message||"unknown",C}return X.ZERO};const r=t.displayState.segmentationGroupState.value;r.selectedSegments.changed.add((g,v)=>{g!==null&&(g=Array().concat(g)),this.selectedSegmentsChanged(g,v)}),r.visibleSegments.changed.add((g,v)=>{g!==null&&(g=Array().concat(g)),this.visibleSegmentsChanged(g,v)});const{annotationLayerStates:o,state:{multicutState:l}}=this,c=Ju(t),u=Up(t,c,"sinks",Hu),h=Up(t,c,"sources",hy);OC(l.sinks,u),OC(l.sources,h),o.push(u,h),t.tool.value instanceof zl&&(t.tool.value=void 0),this.mergeAnnotationState=Up(t,c,"grapheneMerge",Hu);{const{mergeState:g}=s,{merges:v,autoSubmit:y}=g,{mergeAnnotationState:b}=this,{visibleSegments:w}=r;for(const C of v.value)b.source.add(M4(C));b.source.childAdded.add(C=>{const E=C;E.relatedSegments[0].map(A=>w.has(A))[0]===!1?(setTimeout(()=>{const{tool:A}=t;A.value instanceof zl&&A.value.deactivate()},0),Pe.showTemporaryMessage("Cannot merge a hidden segment.")):v.value.length<VC?v.value=[...v.value,_C(E,!0)]:(setTimeout(()=>{const{tool:A}=t;A.value instanceof zl&&A.value.deactivate()},0),Pe.showTemporaryMessage(`Maximum of ${VC} simultanous merges allowed.`))}),b.source.childCommitted.add(C=>{const E=b.source.getReference(C),k=E.value;if(k){const D=k.relatedSegments[0],A=D.map(I=>w.has(I));D.length<4&&(b.source.delete(E),Pe.showTemporaryMessage("Cannot merge segment with itself.")),A[2]===!1&&(b.source.delete(E),Pe.showTemporaryMessage("Cannot merge a hidden segment."));const N=v.value.find(I=>I.id===E.id);if(N&&!(N!=null&&N.locked)){const I=_C(k,!1);N.sink=I.sink,N.source=I.source,v.changed.dispatch(),y.value&&this.bulkMerge([N])}}E.dispose()}),b.source.childDeleted.add(C=>{let E=!1;const k=v.value.filter(D=>{const A=D.id!==C||D.locked;return A||(E=!0),A});E&&(v.value=k)})}}createRenderLayers(e,t,n){return[new k4(e,this.chunkSource.getChunkedGraphSource(),t,n,this.graph.info.graph.nBitsForLayerId)]}visibleSegmentsChanged(e,t){const{segmentsState:n}=this,{focusSegment:{value:s}}=this.graph.state.multicutState;if(s&&!n.visibleSegments.has(s)&&(n.selectedSegments.has(s)?Pe.showTemporaryMessage("Can't hide active multicut segment.",3e3):Pe.showTemporaryMessage("Can't deselect active multicut segment.",3e3),n.selectedSegments.add(s),n.visibleSegments.add(s),e&&(e=e.filter(r=>!X.equal(r,s)))),e===null){const r=this.segmentsState.selectedSegments.size;this.segmentsState.segmentEquivalences.clear(),Pe.showTemporaryMessage(`Hid all ${r} segments.`,3e3);return}for(const r of e)if(!t){const o=[...n.segmentEquivalences.setElements(r)].length;n.segmentEquivalences.deleteSet(r),this.lastDeselectionMessage&&this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1),this.lastDeselectionMessage=Pe.showMessage(`Hid ${o} segments.`),this.lastDeselectionMessageExists=!0,setTimeout(()=>{this.lastDeselectionMessageExists&&(this.lastDeselectionMessage.dispose(),this.lastDeselectionMessageExists=!1)},2e3)}}selectedSegmentsChanged(e,t){const{segmentsState:n}=this;if(e===null){const s=this.segmentsState.selectedSegments.size;Pe.showTemporaryMessage(`Deselected all ${s} segments.`,3e3);return}for(const s of e){const r=WG(s,this.graph.info.graph.nBitsForLayerId),o=s.clone();t&&r&&this.graph.getRoot(o).then(l=>{n.visibleSegments.has(o)&&n.visibleSegments.add(l),n.selectedSegments.delete(o),n.selectedSegments.add(l)})}}computeSplit(e,t){}getMeshSource(){const{layer:e}=this;for(const t of e.dataSources){const{loadState:n}=t;if(n instanceof xv){const{subsources:s}=n.dataSource,r=s.filter(l=>l.id==="graph")[0];if(r!=null&&r.subsource.segmentationGraph&&r.subsource.segmentationGraph!==this.graph)continue;const o=s.filter(l=>l.id==="mesh")[0];if(o)return o.subsource.mesh}}}meshAddNewSegments(e){const t=this.getMeshSource();if(t)for(const n of e)t.rpc.invoke($G,{rpcId:t.rpcId,segment:n.toString()})}async submitMulticut(e){const{state:{multicutState:t}}=this,{sinks:n,sources:s}=t;if(n.size===0||s.size===0)return Pe.showTemporaryMessage("Must select both red and blue groups to perform a multi-cut.",7e3),!1;const r=await this.graph.graphServer.splitSegments([...n],[...s],e);if(r.length===0)return Pe.showTemporaryMessage("No split found.",3e3),!1;const o=t.focusSegment.value;t.reset();const{segmentsState:l}=this;l.selectedSegments.delete(o);for(const c of[...n,...s])l.selectedSegments.delete(c.rootId);return this.meshAddNewSegments(r),l.selectedSegments.add(r),l.visibleSegments.add(r),!0}async bulkMerge(e){const{merges:t}=this.state.mergeState,n=h=>new Promise(g=>{if(h.length===0){g([]);return}const v=[],y=(E,k)=>{v.push(E);for(const D of h)D.source&&X.equal(D.source.rootId,E)&&(D.source.rootId=k),X.equal(D.sink.rootId,E)&&(D.sink.rootId=k)};let b=0,w=0;const C=(E,k)=>{if(b===h.length||k.length===0)return;w++;let D=[];const A=()=>{N++,N===k.length&&(w-=1),w===0&&g(v)};let N=0;for(const I of k)I.locked=!0,I.status="trying...",t.changed.dispatch(),this.submitMerge(I,3).then(P=>{y(I.source.rootId,P),y(I.sink.rootId,P),I.status="done",I.mergedRoot=P,t.changed.dispatch(),b+=1,C(b,D),D=[],A(),N4(5e3).then(()=>{this.deleteMergeSubmission(I)})}).catch(()=>{t.changed.dispatch(),D.push(I),b>E&&(C(b,D),D=[]),A()})};C(b,h)});e=e.filter(h=>!h.locked&&h.source);const s=await n(e),r=[];for(const h of e)h.error?(h.locked=!1,h.status=h.error):h.mergedRoot&&r.push(h.mergedRoot);const o=this.layer.displayState.segmentationGroupState.value,{visibleSegments:l,selectedSegments:c}=o;c.delete(s);const u=await this.graph.graphServer.filterLatestRoots(r);this.meshAddNewSegments(u),c.add(u),l.add(u),t.changed.dispatch()}};async function TL(i){if(i.response){let e;return i.response.headers.get("content-type")==="application/json"?e=(await i.response.json()).message:e=await i.response.text(),e}}async function zp(i,e){let t,n=()=>{};e.initialMessage&&(t=new Pe(!0),t.setText(e.initialMessage),n=t.dispose.bind(t));try{const s=await i;return n(),s}catch(s){if(s instanceof Di&&s.response){const{errorPrefix:r=""}=e,o=await TL(s);if(o)throw t||(t=new Pe(!0)),t.setErrorMessage(r+o),t.setVisible(!0),new Error(`[${s.response.status}] ${r}${o}`)}throw s}}const MC=Symbol("Graph Server Not Specified.");class C4{constructor(e,t){this.url=e,this.credentialsProvider=t}async getRoot(e,t=""){const n=new Date(t).valueOf()/1e3,s=`${this.url}/node/${String(e)}/root?int64_as_str=1${Number.isNaN(n)?"":`&timestamp=${n}`}`,r=ei(this.credentialsProvider,s,{},$d),l=await(await zp(r,{initialMessage:`Retrieving root for segment ${e}`,errorPrefix:"Could not fetch root: "})).json();return X.parseString(l.root_id)}async mergeSegments(e,t,n){const{url:s}=this;if(s==="")return Promise.reject(MC);const r=ei(this.credentialsProvider,`${s}/merge?int64_as_str=1`,{method:"POST",body:JSON.stringify([[String(e.segmentId),...e.position.map((o,l)=>o*n[l])],[String(t.segmentId),...t.position.map((o,l)=>o*n[l])]])},$d);try{const l=await(await r).json();return X.parseString(l.new_root_ids[0])}catch(o){if(o instanceof Di){const l=await TL(o);throw new Error(l)}throw o}}async splitSegments(e,t,n){const{url:s}=this;if(s==="")return Promise.reject(MC);const r=ei(this.credentialsProvider,`${s}/split?int64_as_str=1`,{method:"POST",body:JSON.stringify({sources:e.map(u=>[String(u.segmentId),...u.position.map((h,g)=>h*n[g])]),sinks:t.map(u=>[String(u.segmentId),...u.position.map((h,g)=>h*n[g])])})},$d),l=await(await zp(r,{initialMessage:`Splitting ${e.length} sources from ${t.length} sinks`,errorPrefix:"Split failed: "})).json(),c=new Array(l.new_root_ids.length);for(let u=0;u<c.length;++u)c[u]=X.parseString(l.new_root_ids[u]);return c}async filterLatestRoots(e){const t=`${this.url}/is_latest_roots`,n=ei(this.credentialsProvider,t,{method:"POST",body:JSON.stringify({node_ids:e.map(l=>l.toJSON())})},$d),r=await(await zp(n,{errorPrefix:"Could not check latest: "})).json(),o=[];for(const[l,c]of r.is_latest.entries())c&&o.push(e[l]);return o}}class x4 extends zv{constructor(e,t,n,s){super(),this.info=e,this.chunkSource=n,this.state=s,this.connections=new Set,this.graphServer=new C4(e.app.segmentationUrl,t)}connect(e){const t=new nf(this,e,this.chunkSource,this.state);return this.connections.add(t),t.registerDisposer(()=>{this.connections.delete(t)}),t}get visibleSegmentEquivalencePolicy(){return An.MAX_REPRESENTATIVE|An.NONREPRESENTATIVE_EXCLUDED}getRoot(e){return this.graphServer.getRoot(e)}tabContents(e,t,n){const s=document.createElement("div");s.style.display="contents";const r=document.createElement("div");r.className="neuroglancer-segmentation-toolbox",r.appendChild(ia(t,e.toolBinder,{toolJson:vy,label:"Multicut",title:"Multicut segments"})),r.appendChild(ia(t,e.toolBinder,{toolJson:yy,label:"Merge",title:"Merge segments"})),s.appendChild(r),s.appendChild(t.registerDisposer(new L4(e,e.annotationDisplayState)).element);const o=n.element;return o.classList.add("neuroglancer-annotations-tab"),o.classList.add("neuroglancer-graphene-tab"),s}async merge(e,t){return new X}async split(e,t){return{include:e,exclude:t}}trackSegment(e,t){return()=>{console.log("trackSegment... do nothing",e,t)}}}class E4 extends Vc{}class T4 extends at(ct()(E4),Tm){}class k4 extends Zr{constructor(e,t,n,s,r){super(),this.chunkManager=e,this.source=t,this.displayState=n,this.localPosition=s,this.layerChunkProgressInfo=new fh,this.leafRequestsActive=this.registerDisposer(Tt.make(e.rpc,!0)),this.chunkTransform=this.registerDisposer(ni(l=>mh(()=>hh(lv(l))),this.displayState.transform));const o=this.sharedObject=this.backend=this.registerDisposer(new Bh(e,n,this.layerChunkProgressInfo));o.RPC_TYPE_ID=JG,o.initializeCounterpartWithChunkManager({source:t.chunkSource.addCounterpartRef(),localPosition:this.registerDisposer(Tt.makeFromExisting(e.rpc,this.localPosition)).rpcId,leafRequestsActive:this.leafRequestsActive.rpcId,nBitsForLayerId:this.registerDisposer(Tt.make(e.rpc,r)).rpcId}),this.registerDisposer(o.visibility.add(this.visibility)),this.registerDisposer(this.leafRequestsActive.changed.add(()=>{this.showOrHideMessage(this.leafRequestsActive.value)}))}attach(e){super.attach(e);const t=this.chunkTransform.value,n=e.view.displayDimensionRenderInfo.value;e.state={chunkTransform:t,displayDimensionRenderInfo:n},e.state.source=e.registerDisposer(Ti((s,r,o)=>{const l=Dh(o,r,c=>[[this.source]],e.messages,this);return e.view.flushBackendProjectionParameters(),this.sharedObject.rpc.invoke(jG,{layer:this.sharedObject.rpcId,view:e.view.rpcId,displayDimensionRenderInfo:o,sources:Lh(l)}),l[0][0]},this.displayState.transform,e.view.displayDimensionRenderInfo))}isReady(){return!0}showOrHideMessage(e){this.leafRequestsStatusMessage&&e?(this.leafRequestsStatusMessage.dispose(),this.leafRequestsStatusMessage=void 0,Pe.showTemporaryMessage("Loading chunked graph segmentation...",3e3)):!this.leafRequestsStatusMessage&&!e&&(this.leafRequestsStatusMessage=Pe.showMessage("At this zoom level, chunked graph segmentation will not be loaded. Please zoom in if you wish to load it."))}}const vy="grapheneMulticutSegments",yy="grapheneMergeSegments";class L4 extends gk{constructor(e,t){super(e,t),this.layer=e,this.displayState=t;const{graphConnection:{value:n}}=e;if(n instanceof nf)for(const s of n.annotationLayerStates)this.annotationStates.add(s)}get annotationStates(){return this._annotationStates===void 0&&(this._annotationStates=this.registerDisposer(new hk)),this._annotationStates}}const OC=(i,e)=>{const t=e.source;t.childDeleted.add(s=>{const r=[...i].find(o=>{var l;return((l=o.annotationReference)==null?void 0:l.id)===s});r&&i.delete(r)});const n=s=>{const r={id:"",point:s.position,type:st.POINT,properties:[],relatedSegments:[[s.segmentId,s.rootId]]},o=t.add(r);s.annotationReference=o};i.changed.add((s,r)=>{if(s===null){for(const o of t)t.delete(t.getReference(o.id));return}r?n(s):s.annotationReference&&t.delete(s.annotationReference)});for(const s of i)n(s)};function D4(i,e){const n=Ju(e).getRenderLayerTransform(),s=mh(()=>hh(lv(n.value)));if(s.error!==void 0)return;const r=new Float32Array(s.modelTransform.unpaddedRank);if(ga(r,i,e.localPosition.value,s.layerRank,s.combinedGlobalLocalToChunkTransform))return r}const I4=(i,e)=>{if(e.updateUnconditionally())return D4(e.unsnappedPosition,i)},P4=He.fromObject({"at:shift?+control+mousedown0":{action:"set-anchor"},"at:shift?+keyg":{action:"swap-group"},"at:shift?+enter":{action:"submit"}});class A4 extends Va{toJSON(){return vy}activate(e){const{layer:t}=this,{graphConnection:{value:n}}=t;if(!n||!(n instanceof nf))return;const{state:{multicutState:s},segmentsState:r}=n;if(s===void 0)return;const{body:o,header:l}=Ba(e);l.textContent="Multicut segments",o.classList.add("graphene-multicut-status"),o.appendChild($e({text:"Swap",title:"Swap group",onClick:()=>{s.swapGroup()}})),o.appendChild($e({text:"Clear",title:"Clear multicut",onClick:()=>{s.reset()}}));const c=async()=>{u.classList.toggle("disabled",!0);const k=Ju(this.layer).loadedDataSource.transform.inputSpace.value.scales.map(D=>D/1e-9);n.submitMulticut(k).then(D=>{u.classList.toggle("disabled",!1),D&&e.cancel()})},u=$e({text:"Submit",title:"Submit multicut",onClick:()=>{c()}});o.appendChild(u);const h=document.createElement("div");h.className="activeGroupIndicator",h.innerHTML="Active Group: ",o.appendChild(h);const{displayState:g}=this.layer,v=g.segmentationGroupState.value,y=g.baseSegmentHighlighting.value,b=g.highlightColor.value;e.bindInputEventMap(P4),e.registerDisposer(()=>{w(),g.baseSegmentHighlighting.value=y,g.highlightColor.value=b});const w=()=>{sc(v),g.useTempSegmentStatedColors2d.value=!1,g.tempSegmentStatedColors2d.value.clear(),g.tempSegmentDefaultColor2d.value=void 0,g.highlightColor.value=void 0},C=()=>{w(),h.classList.toggle("blueGroup",s.blueGroup.value);const E=s.focusSegment.value;if(E!==void 0){g.baseSegmentHighlighting.value=!0,g.highlightColor.value=s.blueGroup.value?QG:XG,r.useTemporaryVisibleSegments.value=!0,r.useTemporarySegmentEquivalences.value=!0,r.temporaryVisibleSegments.add(E);for(const k of s.segments)r.temporaryVisibleSegments.add(k);for(const k of r.segmentEquivalences.setElements(E))r.temporaryVisibleSegments.has(k)||r.temporarySegmentEquivalences.link(E,k);g.tempSegmentDefaultColor2d.value=i4,g.tempSegmentStatedColors2d.value.set(E,n4);for(const k of s.redSegments)g.tempSegmentStatedColors2d.value.set(k,e4);for(const k of s.blueSegments)g.tempSegmentStatedColors2d.value.set(k,t4);g.useTempSegmentStatedColors2d.value=!0}};C(),e.registerDisposer(s.changed.add(C)),e.bindAction("swap-group",E=>{E.stopPropagation(),s.swapGroup()}),e.bindAction("set-anchor",E=>{E.stopPropagation();const k=R4(this,v.visibleSegments);if(!k)return;const{rootId:D,segmentId:A}=k,{focusSegment:N,segments:I}=s;if(N.value===void 0&&(N.value=D.clone()),!X.equal(N.value,D)){Pe.showTemporaryMessage(`The selected supervoxel has root segment ${D.toString()}, but the supervoxels already selected have root ${N.value.toString()}`,12e3);return}if(!X.equal(D,A)){for(const O of I)if(X.equal(O,A)){Pe.showTemporaryMessage(`Supervoxel ${A.toString()} has already been selected`,7e3);return}}s.activeGroup.add(k)}),e.bindAction("submit",E=>{E.stopPropagation(),c()})}get description(){return"multicut"}}const R4=(i,e)=>{const{layer:t,mouseState:n}=i,{segmentSelectionState:{value:s,baseValue:r}}=t.displayState;if(!r||!s)return;if(!e.has(s)){Pe.showTemporaryMessage("The selected supervoxel is of an unselected segment",7e3);return}const o=I4(t,n);if(o!==void 0)return{rootId:s.clone(),segmentId:r.clone(),position:o}},N4=i=>new Promise((e,t)=>{setTimeout(e,i)});class zl extends Hh{constructor(e,t){super(e,{}),this.annotationState=t,this.getBaseSegment=!0;const{inProgressAnnotation:n}=this,{displayState:s}=t;if(!s)return;const{disablePicking:r}=s;this.registerDisposer(n.changed.add(()=>{r.value=n.value!==void 0}))}get annotationLayer(){return this.annotationState}get description(){return"merge line"}toJSON(){return kL}}function _C(i,e){const t=i.relatedSegments[0],n={id:i.id,locked:!1,sink:{position:i.pointA.slice(),rootId:t[0].clone(),segmentId:t[1].clone()}};return e||(n.source={position:i.pointB.slice(),rootId:t[2].clone(),segmentId:t[3].clone()}),n}function M4(i){const{sink:e,source:t}=i;return{id:i.id,type:st.LINE,pointA:e.position.slice(),pointB:t.position.slice(),relatedSegments:[[e.rootId.clone(),e.segmentId.clone(),t.rootId.clone(),t.segmentId.clone()]],properties:[]}}const VC=10,O4=He.fromObject({"at:shift?+enter":{action:"submit"}});class _4 extends Va{activate(e){const{graphConnection:{value:t},tool:n}=this.layer;if(!t||!(t instanceof nf))return;const{state:{mergeState:s}}=t;if(s===void 0)return;const{merges:r,autoSubmit:o}=s,l=new zl(this.layer,t.mergeAnnotationState);n.value=l,e.registerDisposer(()=>{n.value=void 0});const{body:c,header:u}=Ba(e);u.textContent="Merge segments",c.classList.add("graphene-merge-segments-status"),e.bindInputEventMap(O4);const h=async()=>{r.value.filter(A=>A.locked).length||(g.classList.toggle("disabled",!0),await t.bulkMerge(r.value),g.classList.toggle("disabled",!1))},g=$e({text:"Submit",title:"Submit merge",onClick:async()=>{h()}});c.appendChild(g),e.bindAction("submit",async A=>{A.stopPropagation(),h()}),c.appendChild($e({text:"Clear",title:"Clear pending merges",onClick:()=>{r.value=[]}}));const v=e.registerDisposer(new Es(o)),y=document.createElement("label");y.appendChild(document.createTextNode("auto-submit")),y.title="auto-submit merges",y.appendChild(v.element),c.appendChild(y);const b=document.createElement("div");b.classList.add("graphene-merge-segments-merges"),c.appendChild(b);const w=za.make(this.layer.displayState,!0),C=A=>{const N=w.getWithNormalizedId(A);return N.classList.add("neuroglancer-segment-list-entry-double-line"),N},E=A=>{const N=document.createElement("div");N.classList.add("graphene-merge-segments-point");const I=C(eo(this.layer.displayState,A));return N.appendChild(I),N},k=A=>{const N=document.createElement("div");if(N.classList.add("graphene-merge-segments-submission"),N.appendChild(E(A.sink.rootId)),A.source&&(N.appendChild(document.createElement("div")).textContent="ꕹ",N.appendChild(E(A.source.rootId))),A.locked||N.appendChild(vs({title:"Delete merge",onClick:I=>{I.stopPropagation(),I.preventDefault(),t.deleteMergeSubmission(A)}})),A.status){const I=document.createElement("div");I.classList.add("graphene-merge-segments-submission-status"),I.textContent=A.status,N.appendChild(I)}return N},D=()=>{for(;b.firstChild;)b.removeChild(b.firstChild);for(const A of r.value)b.appendChild(k(A))};e.registerDisposer(r.changed.add(D)),D()}toJSON(){return yy}get description(){return"merge segments"}}Ji(En,vy,i=>new A4(i,!0));Ji(En,yy,i=>new _4(i,!0));const kL="annotateMergeLine";$c(kL,(i,e)=>new zl(i,e));un("graphene",()=>new v4);function V4(i,e,t){const n=window.outerHeight-window.innerHeight+window.innerHeight/2-t/2,s=window.innerWidth/2-e/2;return window.open(i,void 0,`toolbar=no, menubar=no, width=${e}, height=${t}, top=${n}, left=${s}`)}async function B4(i){const e=new Pe(!1),t=new Promise(n=>{function s(r,o){e.element.textContent=r+" ";const l=document.createElement("button");l.textContent=o,e.element.appendChild(l),l.addEventListener("click",()=>{s(`Waiting for login to middleauth server ${i}...`,"Retry");const c=V4(`${i}/api/v1/authorize`,400,650),u=()=>{c==null||c.close()};window.addEventListener("beforeunload",u);const h=setInterval(()=>{c!=null&&c.closed&&(clearInterval(h),s(`Login window closed for middleauth server ${i}.`,"Retry"))},1e3),g=async v=>{if(v.source===c){clearInterval(h),window.removeEventListener("message",g),window.removeEventListener("beforeunload",u),u(),ee(v.data);const y=z(v.data,"token",ie),b=z(v.data,"app_urls",Zn);n({tokenType:"Bearer",accessToken:y,url:i,appUrls:b})}};window.addEventListener("message",g)})}s(`middleauth server ${i} login required.`,"Login")});try{return await t}finally{e.dispose()}}const LL="auth_token_v2";function F4(i){const e=localStorage.getItem(`${LL}_${i}`);return e?JSON.parse(e):null}function U4(i,e){localStorage.setItem(`${LL}_${i}`,JSON.stringify(e))}class z4 extends Ki{constructor(e){super(),this.serverUrl=e,this.alreadyTriedLocalStorage=!1,this.get=As(async()=>{let t;return this.alreadyTriedLocalStorage||(this.alreadyTriedLocalStorage=!0,t=F4(this.serverUrl)),t||(t=await B4(this.serverUrl),U4(this.serverUrl,t)),t})}}class G4 extends Error{constructor(e){super(),this.url=e}}class $4 extends Ki{constructor(e,t){super(),this.serverUrl=e,this.credentialsManager=t,this.credentials=void 0,this.get=As(async()=>{const n=await fetch(`${this.serverUrl}/auth_info`).then(o=>o.json()),s=this.credentialsManager.getCredentialsProvider("middleauth",n.login_url);if(this.credentials=await s.get(this.credentials),this.credentials.credentials.appUrls.includes(this.serverUrl))return this.credentials.credentials;throw new Pe(!1).setText(`middleauth: unverified app ${this.serverUrl}`),new G4(this.serverUrl)})}}Rs.register("middleauth",i=>new z4(i));Rs.register("middleauthapp",(i,e)=>new $4(i,e));/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Dm=(i=>(i[i.RAW=0]="RAW",i[i.GZIP=1]="GZIP",i[i.BLOSC=2]="BLOSC",i[i.ZSTD=3]="ZSTD",i))(Dm||{}),Lc;let W4=(Lc=class{},Lc.RPC_ID="n5/VolumeChunkSource",Lc);class H4 extends at(ct()(Ps),W4){}let J4=class extends di{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.multiscaleMetadata=n,this.scales=s;let r,o;if(s.forEach((g,v)=>{if(g!==void 0){if(o===void 0&&(o=v),r!==void 0&&g.dataType!==r)throw new Error(`Scale s${v} has data type ${J[g.dataType]} but expected ${J[r]}.`);r=g.dataType}}),r===void 0)throw new Error("At least one scale must be specified.");const l=n.scales[o],c=s[o];this.dataType=r,this.volumeType=At.IMAGE,this.baseScaleIndex=o;const u=n.modelSpace,{rank:h}=u;this.modelSpace=Ue({names:u.names,scales:u.scales,units:u.units,boundingBoxes:[{transform:pg(Float64Array,l.downsamplingFactor,!1),box:{lowerBounds:new Float64Array(h),upperBounds:new Float64Array(c.size)}}],coordinateArrays:u.coordinateArrays})}get rank(){return this.modelSpace.rank}getSources(e){const{scales:t,rank:n}=this,s=this.multiscaleMetadata.scales;return yr(t.filter(r=>r!==void 0).map((r,o)=>{const l=s[o],c=pg(Float32Array,l.downsamplingFactor);return po({rank:n,chunkToMultiscaleTransform:c,dataType:r.dataType,upperVoxelBound:r.size,volumeType:this.volumeType,chunkDataSizes:[r.chunkSize],volumeSourceOptions:e}).map(u=>({chunkSource:this.chunkManager.getChunkSource(H4,{credentialsProvider:this.credentialsProvider,spec:u,parameters:{url:l.url,encoding:r.encoding}}),chunkToMultiscaleTransform:c}))}))}};class j4{constructor(e){ee(e),this.dataType=z(e,"dataType",n=>ft(n,J)),this.size=Float32Array.from(z(e,"dimensions",n=>Ee(n,ht))),this.chunkSize=z(e,"blockSize",n=>_e(new Uint32Array(this.size.length),n,ht));let t;oe(e,"compression",n=>{t=z(n,"type",s=>ft(s,Dm))}),t===void 0&&(t=z(e,"compressionType",n=>ft(n,Dm))),this.encoding=t}}function Y4(i,e,t){return Promise.all(t.scales.map(async n=>{const s=await DL(i,e,n.url,!0);if(s!==void 0)return new j4(s)}))}function q4(i){let{protocol:e,host:t,path:n}=Qh(i);n.endsWith("/")&&(n=n.substring(0,n.length-1));const s=[];for(;;){s.push(`${e}://${t}${n}/attributes.json`);const r=n.lastIndexOf("/");if(r===-1)break;n=n.substring(0,r)}return s}function K4(i,e,t,n){return i.memoize.getUncounted({type:"n5:attributes.json",url:t,credentialsProvider:jt(e)},()=>ei(e,t,{},tn).then(s=>{try{return ee(s)}catch(r){throw new Error(`Error reading attributes from ${t}: ${r.message}`)}}).catch(s=>{if(Wa(s))return n?void 0:{};throw s}))}async function DL(i,e,t,n){const s=q4(t),r=await Promise.all(s.map((o,l)=>K4(i,e,o,n&&l===s.length-1)));if(r.indexOf(void 0)===-1)return r.reverse(),Object.assign({},...r)}function sr(i,e){if(i!==-1&&e!==i)throw new Error(`Rank mismatch, received ${e} but expected ${i}`);return e}function IL(i){return Float64Array.from(Ee(i,wt))}function PL(i){const e=Gi(i);if(e.length===0)throw new Error("Expected non-empty array");let t=-1;return{all:Ee(e,s=>{const r=IL(s);return t=sr(t,r.length),r}),single:void 0,rank:t}}function X4(i){const e=Gi(i);if(e.length===0)throw new Error("Expected non-empty array");if(Array.isArray(e[0]))return PL(e);const t=IL(i);return{all:void 0,single:t,rank:t.length}}const Q4=["x","y","z","t","c"];function Z4(i){const e=Q4.slice(0,i);for(;e.length<i;)e.push(`d${e.length+1}`);return e}function e$(i,e){ee(e);let t=-1,n=oe(e,"resolution",v=>{const y=Float64Array.from(Ee(v,wt));return t=sr(t,y.length),y}),s=oe(e,"axes",v=>{const y=Ee(v,ie);return t=sr(t,y.length),y}),r=oe(e,"units",v=>{const y=Ee(v,Z0);return t=sr(t,y.length),y}),o={unit:"m",exponent:-9},l,c;oe(e,"downsamplingFactors",v=>{const{single:y,all:b,rank:w}=X4(v);t=sr(t,w),y!==void 0&&(l=y),b!==void 0&&(c=b)}),oe(e,"pixelResolution",v=>{o=z(v,"unit",Z0),oe(v,"dimensions",y=>{n=Float64Array.from(Ee(y,wt)),t=sr(t,n.length)})}),oe(e,"scales",v=>{const{all:y,rank:b}=PL(v);t=sr(t,b),c=y});const u=oe(e,"dimensions",v=>{const y=Ee(v,ht);return t=sr(t,y.length),y});if(t===-1)throw new Error("Unable to determine rank of dataset");r===void 0&&(r=new Array(t),r.fill(o)),n===void 0&&(n=new Float64Array(t),n.fill(1));for(let v=0;v<t;++v)n[v]=ev(n[v],r[v].exponent);const h=new Array(t);s!==void 0&&oe(e,"coordinateArrays",v=>{ee(v);for(let y=0;y<t;++y){const b=s[y];if(Object.prototype.hasOwnProperty.call(v,b)){const w=Zn(v[b]);h[y]={explicit:!1,labels:w,coordinates:Array.from(w,(C,E)=>E)},r[y]={unit:"",exponent:0},n[y]=1}}}),s===void 0&&(s=Z4(t));const g=Ue({rank:t,valid:!0,names:s,scales:n,units:r.map(v=>v.unit),coordinateArrays:h});if(u===void 0){if(c===void 0)throw new Error("Not valid single-resolution or multi-resolution dataset");return{modelSpace:g,url:i,attributes:e,scales:c.map((v,y)=>({url:`${i}/s${y}`,downsamplingFactor:v}))}}return l===void 0&&(l=new Float64Array(t),l.fill(1)),{modelSpace:g,url:i,attributes:e,scales:[{url:i,downsamplingFactor:l}]}}class t$ extends Bn{get description(){return"N5 data source"}get(e){let{providerUrl:t}=e;return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"n5:MultiscaleVolumeChunkSource",providerUrl:t},async()=>{const{url:n,credentialsProvider:s}=Ai(t,e.credentialsManager),r=await DL(e.chunkManager,s,n,!1),o=e$(n,r),l=await Y4(e.chunkManager,s,o),c=new J4(e.chunkManager,s,o,l);return{modelTransform:Jt(c.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:c}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Yi(c.modelSpace.bounds)}}]}})}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("n5",()=>new t$);function AL(i){return new Error(`ngauth server ${i} does not allow requests from Neuroglancer instance ${self.origin}`)}async function n$(i){const e=new Pe(!1);function t(s,r){e.element.textContent=s+" ";const o=document.createElement("button");o.textContent=r,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${i}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to ngauth server ${i}...`,"Retry")})}const n=new Promise((s,r)=>{function o(l){if((l.origin||l.originalEvent.origin)!==i)return;const u=()=>{window.removeEventListener("message",o,!1)},{data:h}=l;l.data==="badorigin"&&(u(),r(AL(i)));try{ee(h);const g=z(h,"token",ie);u(),s(g)}catch{console.log("ngauth: Received unexpected message from ${serverUrl}",l)}}window.addEventListener("message",o,!1)});t(`ngauth server ${i} login required.`,"Login");try{return{token:await n}}finally{e.dispose()}}class i$ extends Ki{constructor(e){super(),this.serverUrl=e,this.get=As(async()=>{const t=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(t.status){case 200:return{token:await t.text()};case 401:return await n$(this.serverUrl);case 403:throw AL(this.serverUrl);default:throw Di.fromResponse(t)}})}}class s$ extends Ki{constructor(e,t,n){super(),this.ngauthCredentialsProvider=e,this.serverUrl=t,this.bucket=n,this.get=As(async()=>({tokenType:"Bearer",accessToken:(await Yc(this.ngauthCredentialsProvider,`${this.serverUrl}/gcs_token`,{method:"POST"},tn,(r,o)=>({...o,body:JSON.stringify({token:r.token,bucket:this.bucket})}),r=>{const{status:o}=r;if(o===401)return"refresh";throw r})).token}))}}Rs.register("ngauth",i=>new i$(i));Rs.register("ngauth_gcs",(i,e)=>new s$(e.getCredentialsProvider("ngauth",i.authServer),i.authServer,i.bucket));function RL(i){return new Error(`Nggraph server ${i} does not allow requests from Neuroglancer instance ${self.origin}`)}async function r$(i){const e=new Pe(!1);function t(s,r){e.element.textContent=s+" ";const o=document.createElement("button");o.textContent=r,e.element.appendChild(o),o.addEventListener("click",()=>{window.open(`${i}/login?origin=${encodeURIComponent(self.origin)}`),t(`Waiting for login to nggraph server ${i}...`,"Retry")})}const n=new Promise((s,r)=>{function o(l){if((l.origin||l.originalEvent.origin)!==i||typeof l.data!="string")return;const u=()=>{window.removeEventListener("message",o,!1)};l.data==="badorigin"?(u(),r(RL(i))):(u(),s(l.data))}window.addEventListener("message",o,!1)});t(`Nggraph server ${i} login required.`,"Login");try{return{token:await n}}finally{e.dispose()}}class o$ extends Ki{constructor(e){super(),this.serverUrl=e,this.get=As(async()=>{const t=await fetch(`${this.serverUrl}/token`,{method:"POST",credentials:"include"});switch(t.status){case 200:return{token:await t.text()};case 401:return await r$(this.serverUrl);case 403:throw RL(this.serverUrl);default:throw Di.fromResponse(t)}})}}const a$="^(https?://[^/]+)/(.*)$";function l$(i){return ee(i),{id:z(i,"id",e=>X.parseString(ie(e))),baseSegments:z(i,"base_segment_ids",e=>Ee(e,t=>X.parseString(ie(t)))),baseSegmentParents:z(i,"base_segment_parent_ids",e=>Ee(e,t=>X.parseString(ie(t)))),name:z(i,"name",ie),tags:z(i,"tags",Zn),numVoxels:z(i,"num_voxels",Je),bounds:z(i,"bounds",e=>Ee(e,t=>Xe(t))),lastLogId:z(i,"last_log_id",e=>e==null?null:X.parseString(ie(e)))}}let BC=0;class c$ extends Gv{constructor(e,t){super(e,t),this.debouncedVisibleSegmentsChanged=this.registerCancellable(ze(()=>this.visibleSegmentsChanged(),0)),this.segmentQueries=new Map,this.ignoreVisibleSegmentsChanged=!1,this.segmentEquivalencesChanged=this.registerCancellable(ze(()=>{this.debouncedVisibleSegmentsChanged.flush(),this.segmentEquivalencesChanged.cancel();const{segmentQueries:s}=this,{segmentEquivalences:r}=this.segmentsState;r.clear();for(const[o,l]of s){if(l.current===void 0||qd(l.id))continue;const{id:c,baseSegments:u}=l.current;if(u.length>0){for(const h of u)r.link(h,c);l.addedEquivalences=!0}else l.addedEquivalences=!1}},0));const n=()=>{this.ignoreVisibleSegmentsChanged||this.debouncedVisibleSegmentsChanged()};this.registerDisposer(t.visibleSegments.changed.add(n)),this.registerDisposer(t.temporaryVisibleSegments.changed.add(n)),this.visibleSegmentsChanged()}computeSplit(e,t){const{segmentEquivalences:n}=this.segmentsState,s=n.get(e);if(qd(s)||!X.equal(n.get(t),s))return;const r=this.segmentQueries.get(s.toString());if(r===void 0)return;const{current:o}=r;if(o===void 0)return;const{baseSegments:l,baseSegmentParents:c}=o,u=c.length,h=new $v;for(let b=0;b<u;++b){const w=l[b],C=c[b];X.equal(w,t)||X.equal(C,t)||(h.link(w,C),console.log(`Linking ${w} - ${C} == ${e}? ${X.equal(e,w)} ${X.equal(e,C)} :: unioned with include = ${X.equal(e,h.get(w))}, with exclude = ${X.equal(t,h.get(w))}`))}const g=[],v=[],y=h.get(e);for(const b of l)X.equal(h.get(b),y)?g.push(b):v.push(b);return console.log("include = "+g.map(b=>b.toString()).join(",")),console.log("exclude = "+v.map(b=>b.toString()).join(",")),{includeRepresentative:s,includeBaseSegments:g,excludeRepresentative:yb,excludeBaseSegments:v}}registerVisibleSegment(e){const t={id:e,current:void 0,addedEquivalences:!1,seenGeneration:BC,disposer:this.graph.watchSegment(e,s=>this.handleSegmentUpdate(t.id.toString(),s))},n=e.toString();this.segmentQueries.set(n,t),console.log(`adding to segmentQueries: ${n}`)}handleSegmentUpdate(e,t){console.log(`handleSegmentUpdate: ${e}`);const n=this.segmentQueries.get(e);if(t==="invalid"){n.disposer(),console.log(`removing from segmentQueries: ${e} due to invalid`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.delete(n.id),this.segmentsState.temporaryVisibleSegments.delete(n.id)}finally{this.ignoreVisibleSegmentsChanged=!1}n.addedEquivalences&&this.segmentEquivalencesChanged();return}if(t==="error"){n.current=void 0,n.addedEquivalences&&this.segmentEquivalencesChanged(),console.log(`Error from ${this.graph.serverUrl}/${this.graph.entityName} watching segment ${e}`);return}n.current=t;const s=n.id,r=t.id;if(X.equal(r,s))n.current=t,qd(n.id)||this.segmentEquivalencesChanged();else{n.id=r;const o=r.toString(),l=this.segmentQueries.get(o);console.log(`removing from segmentQueries: ${e} due to rename -> ${r}`),this.segmentQueries.delete(e);try{this.ignoreVisibleSegmentsChanged=!0,this.segmentsState.visibleSegments.has(s)&&this.segmentsState.visibleSegments.add(r),this.segmentsState.selectedSegments.has(s)&&(this.segmentsState.selectedSegments.delete(s),this.segmentsState.selectedSegments.add(r)),this.segmentsState.temporaryVisibleSegments.has(s)&&(this.segmentsState.temporaryVisibleSegments.delete(s),this.segmentsState.temporaryVisibleSegments.add(r))}finally{this.ignoreVisibleSegmentsChanged=!1}l===void 0?(console.log(`adding to segmentQueries due to rename -> ${r}`),this.segmentQueries.set(o,n),this.segmentEquivalencesChanged()):(t.lastLogId!==null&&(typeof l.current!="object"||l.current.lastLogId===null||X.less(l.current.lastLogId,t.lastLogId))&&(l.current=t,this.segmentEquivalencesChanged()),n.disposer())}}visibleSegmentsChanged(){const{segmentsState:e}=this,{segmentQueries:t}=this,n=++BC,s=r=>{for(const o of r.unsafeKeys()){if(X.equal(o,yb))continue;const l=o.toString(),c=t.get(l);if(c!==void 0){c.seenGeneration=n;continue}this.registerVisibleSegment(o.clone())}};s(e.visibleSegments),s(e.temporaryVisibleSegments);for(const[r,o]of t)o.seenGeneration!==n&&(console.log(`removing from segmentQueries due to seenGeneration: ${r}`),t.delete(r),o.disposer(),o.addedEquivalences&&this.segmentEquivalencesChanged())}}class d$ extends zv{constructor(e,t,n){super(),this.chunkManager=e,this.serverUrl=t,this.entityName=n,this.startingWebsocket=!1,this.websocket=void 0,this.watchesById=new Map,this.watches=new Set,this.nextWatchId=0,this.numOpenFailures=0}get visibleSegmentEquivalencePolicy(){return An.MAX_REPRESENTATIVE|An.REPRESENTATIVE_EXCLUDED}startWebsocket(){if(this.startingWebsocket||this.watches.size===0)return;this.startingWebsocket=!0;let e=new Pe(!this.numOpenFailures);e.setText(`Opening websocket connection for nggraph://${this.serverUrl}/${this.entityName}`),(async()=>{const{numOpenFailures:t}=this;if(t>1){const o=1e3*Math.min(16,2**t);await new Promise(l=>setTimeout(l,o))}const n=(await by(this.chunkManager,this.serverUrl,this.entityName).get()).credentials,s=new URL("/graph/watch/"+encodeURIComponent(n.token),this.serverUrl);s.protocol=s.protocol.replace("http","ws");const r=new WebSocket(s.href);r.onclose=()=>{e!==void 0&&(e.dispose(),e=void 0),++this.numOpenFailures,this.websocket=void 0,this.startingWebsocket=!1,this.watchesById.clear(),this.startWebsocket()},r.onopen=()=>{e!==void 0&&(e.dispose(),e=void 0),this.numOpenFailures=0,this.websocket=r,this.nextWatchId=0;try{for(const o of this.watches){r.send(JSON.stringify({watch:{segment_id:o.segment.toString()}}));const l=this.nextWatchId++;o.watchId=l,this.watchesById.set(l,o)}}catch{}},r.onmessage=o=>{let l,c;try{const u=JSON.parse(o.data);ee(u);const h=z(u,"watch_id",Je),g=this.watchesById.get(h);if(g===void 0)return;c=g;const v=z(u,"state",ie);v==="invalid"||v==="error"?l=v:l=z(u,"info",l$)}catch(u){console.log(`Received unexpected websocket message from ${this.serverUrl}:`,o.data,u);return}console.log("got update",l),c.callback(l)}})()}connect(e){const t=e.displayState.segmentationGroupState.value;return new c$(this,t)}trackSegment(e,t){return this.watchSegment(e,n=>{if(n==="invalid")t(null);else{if(n==="error")return;t(n.id)}})}watchSegment(e,t){const n={callback:t,segment:e,watchId:-1};this.watches.add(n);const{websocket:s}=this;if(s!==void 0)try{s.send(JSON.stringify({watch:{segment_id:e.toString()}}));const o=this.nextWatchId++;n.watchId=o,this.watchesById.set(o,n)}catch{}else this.startWebsocket();return()=>{const{websocket:o}=this;if(o!==void 0&&o.readyState===WebSocket.OPEN){const l=n.watchId;this.watchesById.delete(l);try{o.send(JSON.stringify({unwatch:{watch_id:l}}))}catch{}}this.watches.delete(n)}}async merge(e,t){const n=await Im(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({merge:{anchor:e.toString(),other:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return ee(n),z(n,"merged",s=>X.parseString(s))}async split(e,t){const n=await Im(this.chunkManager,this.serverUrl,this.entityName,"/graph/mutate",{body:JSON.stringify({split:{include:e.toString(),exclude:t.toString()}}),headers:{"Content-Type":"application/json"},method:"POST"});return ee(n),{include:z(n,"include",s=>X.parseString(s)),exclude:z(n,"exclude",s=>X.parseString(s))}}}function FC(i){const e=i.match(a$);if(e===null)throw new Error(`Invalid nggraph url: ${JSON.stringify(i)}`);return{serverUrl:e[1],id:e[2]}}function Sy(i,e,t,n,s=pt){return Yc(i,`${e}${t}`,n,tn,(r,o)=>{const l=new Headers(o.headers);return l.set("Authorization",r.token),{...o,headers:l}},r=>{const{status:o}=r;if(o===401)return"refresh";throw r},s)}function u$(i,e,t,n,s=pt){return Sy(NL(i,e),e,t,n,s)}class h$ extends Ki{constructor(e,t,n){super(),this.parentCredentialsProvider=e,this.serverUrl=t,this.entityName=n,this.get=As(async()=>{const s=await Sy(this.parentCredentialsProvider,this.serverUrl,"/entity_token",{body:JSON.stringify({entity:this.entityName}),headers:{"Content-Type":"application/json"},method:"POST"});return{token:s.token,entityType:s.entity_type,role:s.role}})}}function NL(i,e){return i.memoize.getUncounted({type:"nggraph:credentialsProvider",serverUrl:e},()=>new o$(e))}function by(i,e,t){return i.memoize.getUncounted({type:"nggraph:entityCredentialsProvider",serverUrl:e,entityName:t},()=>new h$(NL(i,e),e,t))}function Im(i,e,t,n,s,r=pt){return Sy(by(i,e,t),e,n,s,r)}function f$(i){return ee(i),z(i,"entities",e=>Ee(e,t=>{ee(t);const n=z(t,"entity",ie),s=z(t,"entity_type",ie),r=z(t,"access_role",ie);return{id:n,entityType:s,accessRole:r}}))}class p$ extends Bn{get description(){return"nggraph data source"}get(e){const{serverUrl:t,id:n}=FC(e.providerUrl);return e.chunkManager.memoize.getUncounted({type:"nggraph:get",serverUrl:t,id:n},async()=>{const s=by(e.chunkManager,t,n),{entityType:r}=(await s.get()).credentials;if(r!=="graph")throw new Error(`Unsupported entity type: ${JSON.stringify(r)}`);const{datasource_url:o}=await Im(e.chunkManager,t,n,"/graph/config",{method:"POST"}),l=await e.registry.get({...e,url:o}),c=new d$(e.chunkManager,t,n),u=[...l.subsources,{id:"graph",default:!0,subsource:{segmentationGraph:c}}];return{modelTransform:l.modelTransform,subsources:u}})}async completeUrl(e){const{serverUrl:t,id:n}=FC(e.providerUrl),s=await e.chunkManager.memoize.getUncounted({type:"nggraph:list",serverUrl:t},async()=>f$(await u$(e.chunkManager,t,"/list",{method:"POST"})));return{offset:t.length+1,completions:On(n,s,r=>r.id,r=>`${r.entityType} (${r.accessRole})`)}}}un("nggraph",()=>new p$);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const g$="nifti/getNiftiVolumeInfo",Uy=class Uy{};Uy.RPC_ID="nifti/VolumeChunkSource";let Pm=Uy;class m$ extends at(ct()(Ps),Pm){}class v$ extends di{constructor(e,t,n,s){super(e),this.credentialsProvider=t,this.url=n,this.info=s}get dataType(){return this.info.dataType}get volumeType(){return At.UNKNOWN}get rank(){return this.info.rank}getSources(e){const{info:t}=this,n=ai(Float32Array,t.rank+1),s=GT({rank:t.rank,volumeType:At.UNKNOWN,chunkDataSize:t.volumeSize,dataType:t.dataType,upperVoxelBound:Float32Array.from(t.volumeSize),chunkToMultiscaleTransform:n,volumeSourceOptions:e});return[[{chunkSource:this.chunkManager.getChunkSource(m$,{credentialsProvider:this.credentialsProvider,spec:s,parameters:{url:this.url}}),chunkToMultiscaleTransform:n}]]}}function y$(i,e,t,n){return i.rpc.promiseInvoke(g$,{chunkManager:i.addCounterpartRef(),credentialsProvider:ry(i,e),url:t},n)}function S$(i,e,t){return i.memoize.getUncounted({type:"nifti/getVolume",url:t},async()=>{const{url:n,credentialsProvider:s}=Ai(t,e),r=await y$(i,s,n,pt),o=new v$(i,s,n,r),l={lowerBounds:new Float64Array(r.rank),upperBounds:Float64Array.from(r.volumeSize)},c=Ue({rank:r.rank,names:r.sourceNames,scales:r.sourceScales,units:r.units,boundingBoxes:[qi(l)]}),u=Ue({rank:r.rank,names:r.viewNames,scales:r.viewScales,units:r.units});return{subsources:[{id:"default",default:!0,subsource:{volume:o}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(l)}}],modelTransform:{sourceRank:r.rank,rank:r.rank,inputSpace:c,outputSpace:u,transform:r.transform}}})}class b$ extends Bn{get description(){return"Single NIfTI file"}get(e){return S$(e.chunkManager,e.credentialsManager,e.providerUrl)}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("nifti",()=>new b$);class w$ extends Bn{get description(){return"Wavefront OBJ mesh file"}async get(e){const t=await rL(e.chunkManager,e.credentialsManager,e.url),n=Ue({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:Jt(n),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("obj",()=>new w$);un("precomputed",()=>new CL);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class C${}class x$ extends C${}const zy=class zy extends x${};zy.RPC_ID="render/TileChunkSource";let Am=zy;const E$=new Set(["jpg","raw16"]),T$=at(Ps,Am);class k$ extends T${}const L$=new Set(["COMPLETE","READ_ONLY"]),D$=new Set(["LOADING"]);function I$(i){const e=Ee(i,ee);if(e.length<1)throw new Error("No stacks found for owner object.");const t=new Map,n=z(e[0],"stackId",A$);for(const s of e){const r=z(s,"stackId",P$),o=R$(s);if(o!==void 0){const l=o.project;let c=t.get(l);if(c===void 0){const u=new Map;t.set(l,{stacks:u}),c=t.get(l)}c.stacks.set(r,o)}}return{owner:n,projects:t}}function P$(i){return ee(i),z(i,"stack",ie)}function A$(i){return ee(i),z(i,"owner",ie)}function R$(i){ee(i);const e=z(i,"state",ie);let t=[],n=we(),s=we();if(L$.has(e)){const l=z(i,"stats",ee);n=M$(l),s=N$(l),Object.prototype.hasOwnProperty.call(l,"channelNames")&&(t=O$(l))}else if(!D$.has(e))return;const r=z(i,"currentVersion",_$),o=z(i,"stackId",V$);return{lowerVoxelBound:n,upperVoxelBound:s,voxelResolution:r,project:o,channels:t}}function N$(i){ee(i);const e=z(i,"stackBounds",ee),t=we();return t[0]=z(e,"maxX",xn)+1,t[1]=z(e,"maxY",xn)+1,t[2]=z(e,"maxZ",xn)+1,t}function M$(i){ee(i);const e=z(i,"stackBounds",ee),t=we();return t[0]=z(e,"minX",xn),t[1]=z(e,"minY",xn),t[2]=z(e,"minZ",xn),t}function O$(i){return ee(i),z(i,"channelNames",e=>Ee(e,ie))}function _$(i){ee(i);const e=we();try{e[0]=z(i,"stackResolutionX",xn),e[1]=z(i,"stackResolutionY",xn),e[2]=z(i,"stackResolutionZ",xn)}catch{e[0]=1,e[1]=1,e[2]=1}return e}function V$(i){return ee(i),z(i,"project",ie)}class B$ extends di{constructor(e,t,n,s,r,o,l){super(e),this.baseUrl=t,this.ownerInfo=n,this.project=r,this.parameters=l;const c=n.projects.get(r);if(c===void 0)throw new Error(`Specified project ${JSON.stringify(r)} does not exist for specified owner ${JSON.stringify(n.owner)}`);if(s===void 0){const v=Array.from(c.stacks.keys());if(v.length!==1)throw new Error(`Dataset contains multiple stacks: ${JSON.stringify(v)}`);s=v[0]}const u=c.stacks.get(s);if(u===void 0)throw new Error(`Specified stack ${JSON.stringify(s)} is not one of the supported stacks: `+JSON.stringify(Array.from(c.stacks.keys())));this.stack=s,this.stackInfo=u,o!==void 0&&o.length>0&&(this.channel=o),this.minIntensity=Ci(l.minIntensity),this.maxIntensity=Ci(l.maxIntensity),this.maxTileSpecsToRender=Ci(l.maxTileSpecsToRender),this.filter=Rx(l.filter),this.minX=Ci(l.minX),this.minY=Ci(l.minY),this.minZ=Ci(l.minZ),this.maxX=Ci(l.maxX),this.maxY=Ci(l.maxY),this.maxZ=Ci(l.maxZ),this.minX!==void 0&&(u.lowerVoxelBound[0]=this.minX),this.minY!==void 0&&(u.lowerVoxelBound[1]=this.minY),this.minZ!==void 0&&(u.lowerVoxelBound[2]=this.minZ),this.maxX!==void 0&&(u.upperVoxelBound[0]=this.maxX),this.maxY!==void 0&&(u.upperVoxelBound[1]=this.maxY),this.maxZ!==void 0&&(u.upperVoxelBound[2]=this.maxZ);let h=cn(l.encoding);if(h===void 0)h="jpg";else if(!E$.has(h))throw new Error(`Invalid encoding: ${JSON.stringify(h)}.`);this.encoding=h,this.numLevels=Ci(l.numlevels),this.dims=we();let g=Ci(l.tilesize);g===void 0&&(g=1024),this.dims[0]=g,this.dims[1]=g,this.dims[2]=1}get dataType(){return this.parameters.encoding==="raw16"?J.UINT16:J.UINT8}get volumeType(){return At.IMAGE}get rank(){return 3}getSources(e){const t=[];let n=this.numLevels;n===void 0&&(n=F$(this.stackInfo,this.dims[0]));const{lowerVoxelBound:s,upperVoxelBound:r}=this.stackInfo;for(let o=0;o<n;o++){const l=Ve(),c=Uint32Array.of(1,1,1);for(let w=0;w<2;++w)l[5*w]=2**o,c[w]=this.dims[w];const u=we(),h=we(),g=we(),v=we();for(let w=0;w<3;w++){const C=l[5*w],E=g[w]=s[w]/C,k=v[w]=r[w]/C;u[w]=Math.floor(E),h[w]=Math.ceil(k)}const y=em({rank:3,chunkDataSize:c,dataType:this.dataType,lowerVoxelBound:u,upperVoxelBound:h}),b=this.chunkManager.getChunkSource(k$,{spec:y,parameters:{baseUrl:this.baseUrl,owner:this.ownerInfo.owner,project:this.stackInfo.project,stack:this.stack,channel:this.channel,minIntensity:this.minIntensity,maxIntensity:this.maxIntensity,maxTileSpecsToRender:this.maxTileSpecsToRender,filter:this.filter,dims:`${this.dims[0]}_${this.dims[1]}`,level:o,encoding:this.encoding}});t.push([{chunkSource:b,chunkToMultiscaleTransform:l,lowerClipBound:g,upperClipBound:v}])}return yr(t)}}function F$(i,e){let t=0;for(let s=0;s<2;s++)t=Math.max(t,i.upperVoxelBound[s]);if(e>=t)return 1;let n=0;for(;t>e;)t=t/2,n++;return n}function tu(i,e,t){return i.memoize.getUncounted({type:"render:getOwnerInfo",hostname:e,owner:t},()=>mm(`${e}/render-ws/v1/owner/${t}/stacks`).then(n=>n.json()).then(I$))}const U$=/^([^/?]+)(?:\/([^/?]+))?(?:\/([^/?]+))(?:\/([^/?]*))?(?:\?(.*))?$/,ML=/^((?:(?:(?:http|https):\/\/[^,/]+)[^/?]))\/(.*)$/;function z$(i,e){let t,n;{const h=e.match(ML);if(h===null)throw new Error(`Invalid render volume path: ${JSON.stringify(e)}`);t=h[1],n=h[2]}const s=n.match(U$);if(s===null)throw new Error(`Invalid volume path ${JSON.stringify(n)}`);const r=s[1],o=s[2],l=s[3],c=s[4],u=Ma(s[5]||"");return i.memoize.getUncounted({type:"render:MultiscaleVolumeChunkSource",hostname:t,path:n},async()=>{const h=await tu(i,t,r),g=new B$(i,t,h,l,o,c,u),v=Ue({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.from(g.stackInfo.voxelResolution,b=>b/1e9),boundingBoxes:[qi({lowerBounds:new Float64Array(g.stackInfo.lowerVoxelBound),upperBounds:new Float64Array(g.stackInfo.upperVoxelBound)})]});return{modelTransform:Jt(v),subsources:[{id:"default",default:!0,subsource:{volume:g}},{id:"bounds",default:!0,subsource:{staticAnnotations:Yi(v.bounds)}}]}})}async function G$(i,e,t){const n=t.match(/^(?:([^/]+)(?:\/([^/]*))?(?:\/([^/]*))?(\/.*?)?)?$/);if(n===null||n[2]===void 0)throw null;if(n[3]===void 0){const h=n[2]||"",g=await tu(i,e,n[1]),v=On(h,g.projects,y=>y[0]+"/",()=>{});return{offset:n[1].length+1,completions:v}}if(n[4]===void 0){const h=n[3]||"",v=(await tu(i,e,n[1])).projects.get(n[2]);if(v===void 0)throw null;const y=On(h,v.stacks,b=>b[0]+"/",b=>b[1].project);return{offset:n[1].length+n[2].length+2,completions:y}}const s=n[4].substr(1)||"",o=(await tu(i,e,n[1])).projects.get(n[2]);if(o===void 0)throw null;const l=o.stacks.get(n[3]);if(l===void 0)throw null;const c=l.channels;if(c.length===0)throw null;const u=On(s,c,h=>h,()=>{});return{offset:n[1].length+n[2].length+n[3].length+3,completions:u}}async function $$(i,e){const t=i.match(ML);if(t===null)throw null;const n=t[1],s=t[2],r=await G$(e,n,s);return br(t[1].length+1,r)}class W$ extends Bn{get description(){return"Render"}get(e){return z$(e.chunkManager,e.providerUrl)}completeUrl(e){return $$(e.providerUrl,e.chunkManager)}}un("render",()=>new W$);class H$ extends Bn{get description(){return"VTK mesh file"}async get(e){const t=await rL(e.chunkManager,e.credentialsManager,e.url),n=Ue({rank:3,names:["x","y","z"],units:["m","m","m"],scales:Float64Array.of(1e-9,1e-9,1e-9)});return{modelTransform:Jt(n),subsources:[{id:"default",default:!0,subsource:{singleMesh:t}}]}}completeUrl(e){return go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("vtk",()=>new H$);/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Qt=(i=>(i[i.arrayToArray=0]="arrayToArray",i[i.arrayToBytes=1]="arrayToBytes",i[i.bytesToBytes=2]="bytesToBytes",i))(Qt||{});function Rm(i,e,t){ee(i);const n=z(i,"name",r=>e(ie(r))),s=z(i,"configuration",r=>(r===void 0?r={}:ee(r),t(r,n)));return{name:n,configuration:s}}function J$(i){const{name:e,configuration:t}=Rm(i,n=>{const s=OL.get(n);if(s===void 0)throw new Error(`Unknown codec: ${JSON.stringify(n)}`);return s},n=>n);return{resolver:e,configuration:t}}const OL=new Map;function mo(i){OL.set(i.name,i)}function ju(i,e){const t=[],n=[],s=[],r=[];n.push(e);const o=Ee(i,J$),l=o.length;let c=0;for(;c<l;++c){const{resolver:w,configuration:C}=o[c];if(w.kind!==Qt.arrayToArray)break;const E=w,{configuration:k,encodedArrayInfo:D}=E.resolve(C,e);n.push(D),e=D,t.push({kind:Qt.arrayToArray,name:w.name,configuration:k})}if(c===l||o[c].resolver.kind!==Qt.arrayToBytes)throw new Error("Missing array -> bytes codec");const{codecSpec:u,layoutInfo:h,encodedSize:g,shardingInfo:v}=(()=>{const{resolver:w,configuration:C}=o[c],E=w,{configuration:k,shardingInfo:D,encodedSize:A}=E.resolve(C,e);if(D!==void 0&&c+1!==l)throw new Error("bytes -> bytes codecs not supported following sharding codec");const N=E.getDecodedArrayLayoutInfo(k,e);return{codecSpec:{name:w.name,kind:Qt.arrayToBytes,configuration:k},layoutInfo:N,encodedSize:A,shardingInfo:D}})();s[c]=h,r.push(g);const y=g,b=[];for(++c;c<l;){const{resolver:w,configuration:C}=o[c];if(w.kind!==Qt.bytesToBytes)throw new Error(`Expected bytes -> bytes codec, but received ${JSON.stringify(w.name)} of kind ${Qt[w.kind]}`);const E=w,{configuration:k,encodedSize:D}=E.resolve(C,y);b.push({name:w.name,kind:w.kind,configuration:k}),r.push(D),++c}for(let w=t.length-1;w>=0;--w)s[w]=o[w].resolver.getDecodedArrayLayoutInfo(t[w].configuration,n[w],s[w+1]);return{[Qt.arrayToArray]:t,[Qt.arrayToBytes]:u,[Qt.bytesToBytes]:b,arrayInfo:n,layoutInfo:s,shardingInfo:v,encodedSize:r}}mo({name:"blosc",kind:Qt.bytesToBytes,resolve(i){return ee(i),{configuration:{}}}});mo({name:"zstd",kind:Qt.bytesToBytes,resolve(i){return ee(i),{configuration:{}}}});/**
 * @license
 * Copyright 2019 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Gy=class Gy{};Gy.RPC_ID="zarr/VolumeChunkSource";let Nm=Gy;mo({name:"bytes",kind:Qt.arrayToBytes,resolve(i,e){ee(i);const t=z(i,"endian",s=>{switch(s){case"little":return _n.LITTLE;case"big":return _n.BIG;case void 0:if(Hl[e.dataType]===1)return Na}throw new Error(`Invalid endian value: ${JSON.stringify(s)}`)}),n=e.chunkShape.reduce((s,r)=>s*r,1);return{configuration:{endian:t},encodedSize:Hl[e.dataType]*n}},getDecodedArrayLayoutInfo(i,e){return{physicalToLogicalDimension:Array.from(e.chunkShape,(t,n)=>n),readChunkShape:e.chunkShape}}});mo({name:"crc32c",kind:Qt.bytesToBytes,resolve(i,e){let t;return e!==void 0&&(t=e+4),{configuration:{},encodedSize:t}}});mo({name:"gzip",kind:Qt.bytesToBytes,resolve(i){return ee(i),{configuration:{level:z(i,"level",Je)}}}});/**
 * @license
 * Copyright 2023 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Yu=(i=>(i[i.DEFAULT=0]="DEFAULT",i[i.V2=1]="V2",i))(Yu||{});const cs=new Map;cs.set("|u1",{endianness:_n.LITTLE,dataType:J.UINT8});cs.set("|i1",{endianness:_n.LITTLE,dataType:J.INT8});for(const[i,e]of[["<",_n.LITTLE],[">",_n.BIG]]){for(const t of["u","i"])cs.set(`${i}${t}8`,{endianness:e,dataType:J.UINT64});cs.set(`${i}u2`,{endianness:e,dataType:J.UINT16}),cs.set(`${i}i2`,{endianness:e,dataType:J.INT16}),cs.set(`${i}u4`,{endianness:e,dataType:J.UINT32}),cs.set(`${i}i4`,{endianness:e,dataType:J.INT32}),cs.set(`${i}f4`,{endianness:e,dataType:J.FLOAT32})}function j$(i){const e=cs.get(i);if(e===void 0)throw new Error(`Unsupported numpy data type: ${JSON.stringify(i)}`);return e}function _L(i){return Ee(i,e=>{if(typeof e!="number"||!Number.isInteger(e)||e<0)throw new Error(`Expected non-negative integer, but received: ${JSON.stringify(e)}`);return e})}function wy(i,e){return _e(new Array(e),i,t=>{if(typeof t!="number"||!Number.isInteger(t)||t<=0)throw new Error(`Expected positive integer, but received: ${JSON.stringify(t)}`);return t})}function Cy(i){if(i!=="."&&i!=="/")throw new Error(`Expected "." or "/", but received: ${JSON.stringify(i)}`);return i}const Mm=new Map([["",{unit:"",scale:1}],["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(const i of["meter","second"])for(const e of Zm){const{longPrefix:t,prefix:n}=e;if(t===void 0)continue;const s={unit:i[0],scale:10**e.exponent};Mm.set(`${t}${i}`,s),Mm.set(`${n}${i[0]}`,s)}function Y$(i){if(i===null)return{scale:1,unit:""};if(typeof i!="string")throw new Error(`Expected string but received: ${JSON.stringify(i)}`);const e=i.trim(),t=/^([-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)(?:[eE][-+]?\d+)?)\s*(.*)/,n=e.match(t);let s,r;n===null?(s=1,r=e):(s=Number(n[1]),r=n[2]);const o=Mm.get(r);if(o===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(r)}`);return{unit:o.unit,scale:s*o.scale}}function VL(i,e){switch(i){case J.UINT8:case J.INT8:case J.UINT16:case J.INT16:case J.UINT32:case J.INT32:case J.UINT64:if(typeof e!="number"||!Number.isInteger(e))throw new Error(`Expected integer but received: ${JSON.stringify(e)}`);return e;case J.FLOAT32:if(typeof e=="number")return e;if(typeof e=="string"){if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e==="NaN")return new Float32Array(Uint32Array.of(2143289344).buffer)[0];if(e.match(/^0x[a-fA-F0-9]+$/))return new Float32Array(Uint32Array.of(Number(e)).buffer)[0]}throw new Error(`Expected number, "Infinity", "-Infinity", "NaN", or hex string but received: ${JSON.stringify(e)}`)}}function q$(i,e){try{ee(i),z(i,"zarr_format",b=>{Ol(b,3)});const t=z(i,"node_type",b=>{if(e!==void 0&&Ol(b,e),b!=="array"&&b!=="group")throw new Error(`Expected "array" or "group" but received: ${JSON.stringify(b)}`);return b});if(e=t,t==="group")return{zarrVersion:3,nodeType:"group",userAttributes:oe(i,"attributes",ee,{})};const n=z(i,"shape",_L),s=n.length,r=z(i,"dimension_names",b=>uu(b??void 0,s)),o=z(i,"data_type",b=>ft(b,J,/^[a-z0-9]+$/)),{configuration:l}=z(i,"chunk_grid",b=>Rm(b,w=>Ol(w,"regular"),w=>z(w,"chunk_shape",C=>wy(C,s)))),{userAttributes:c,dimensionUnits:u}=z(i,"attributes",b=>{b===void 0&&(b={}),ee(b);const w=z(b,"dimension_units",C=>uu(C,s));return{userAttributes:b,dimensionUnits:w}}),{configuration:h,name:g}=z(i,"chunk_key_encoding",b=>Rm(b,w=>ft(w,Yu,/^(v2|default)$/),(w,C)=>oe(w,"separator",Cy,C===Yu.DEFAULT?"/":"."))),v=z(i,"fill_value",b=>VL(o,b)),y=z(i,"codecs",b=>ju(b,{dataType:o,chunkShape:l}));return{zarrVersion:3,nodeType:t,rank:s,shape:n,chunkShape:l,dataType:o,fillValue:v,dimensionNames:r,dimensionUnits:u,chunkKeyEncoding:g,dimensionSeparator:h,userAttributes:c,codecs:y}}catch(t){const n=e===void 0?"":`${e} `;throw new Error(`Error parsing zarr v3 ${n}metadata: ${t.message}`)}}function K$(i,e,t){try{ee(i),z(i,"zarr_format",y=>{Ol(y,2)});const n=z(i,"shape",_L),s=n.length,r=z(i,"chunks",y=>wy(y,s)),o=z(i,"order",y=>{if(y!=="C"&&y!=="F")throw new Error(`Expected "C" or "F", but received: ${JSON.stringify(y)}`);return y}),l=oe(i,"dimension_separator",t===void 0?Cy:y=>Ol(y,t),t??"."),c=z(i,"dtype",y=>j$(ie(y))),u=c.dataType,h=z(i,"fill_value",y=>y===null?0:VL(u,y)),g=[];o==="F"&&g.push({name:"transpose",configuration:{order:Array.from(n,(y,b)=>s-b-1)}}),g.push({name:"bytes",configuration:{endian:c.endianness===_n.LITTLE?"little":"big"}}),z(i,"compressor",y=>{if(y===null)return;ee(y);const b=z(y,"id",ie);switch(b){case"blosc":g.push({name:"blosc",configuration:{cname:z(y,"cname",ie),clevel:z(y,"clevel",Je),typesize:Hl[u],shuffle:z(y,"shuffle",w=>{switch(w){case-1:return Hl[u]===1?"bitshuffle":"shuffle";case 0:return"noshuffle";case 1:return"shuffle";case 2:return"bitshuffle"}throw new Error(`Invalid value: ${JSON.stringify(w)}`)}),blocksize:oe(y,"blocksize",Je,0)}});break;case"zlib":case"gzip":g.push({name:"gzip",configuration:{level:z(y,"level",Je)}});break;case"zstd":g.push({name:"zstd",configuration:{level:z(y,"level",Je)}});break;default:throw new Error(`Unsupported compressor: ${JSON.stringify(b)}`)}});const v=ju(g,{dataType:u,chunkShape:r});return{zarrVersion:2,nodeType:"array",rank:s,shape:n,chunkShape:r,dataType:u,fillValue:h,dimensionNames:z(e,"_ARRAY_DIMENSIONS",y=>uu(y,s)),dimensionUnits:z(e,"dimension_units",y=>uu(y,s)),userAttributes:e,dimensionSeparator:l,chunkKeyEncoding:Yu.V2,codecs:v}}catch(n){throw new Error(`Error parsing zarr v2 metadata: ${n.message}`)}}var BL=(i=>(i[i.START=0]="START",i[i.END=1]="END",i))(BL||{});mo({name:"sharding_indexed",kind:Qt.arrayToBytes,resolve(i,e){ee(i);const t=z(i,"chunk_shape",c=>wy(c,e.chunkShape.length)),n=oe(i,"index_location",c=>ft(c,BL,/^[a-z]+$/),1),s=Array.from(e.chunkShape,(c,u)=>{const h=t[u];if(c%h!==0)throw new Error(`sub-chunk shape of ${JSON.stringify(h)} does not evenly divide outer chunk shape of ${JSON.stringify(e.chunkShape)}`);return c/h}),r=Array.from(s);r.push(2);const o=z(i,"index_codecs",c=>ju(c,{dataType:J.UINT64,chunkShape:r}));if(o.encodedSize[o.encodedSize.length-1]===void 0)throw new Error("index_codecs must specify fixed-size encoding");const l=z(i,"codecs",c=>ju(c,{dataType:e.dataType,chunkShape:t}));return{configuration:{indexCodecs:o,subChunkCodecs:l,subChunkShape:t,subChunkGridShape:s,indexLocation:n},shardingInfo:{subChunkShape:t,subChunkGridShape:s,subChunkCodecs:l}}},getDecodedArrayLayoutInfo(i,e){return i.subChunkCodecs.layoutInfo[0]}});mo({name:"transpose",kind:Qt.arrayToArray,resolve(i,e){ee(i);const{order:t,inverseOrder:n}=z(i,"order",r=>{const o=e.chunkShape.length,l=new Array(o),c=new Array(o);if(r==="C")for(let u=0;u<o;++u)l[u]=u,c[u]=u;else if(r==="F")for(let u=0;u<o;++u)l[u]=o-u-1,c[u]=o-u-1;else _e(l,r,(u,h)=>{if(typeof u!="number"||!Number.isInteger(u)||u<0||u>=o)throw new Error(`Expected integer in range [0, ${o}) but received: ${JSON.stringify(u)}`);if(c[u]!==void 0)throw new Error(`Invalid permutation: ${JSON.stringify(r)}`);return c[u]=h,u});return{order:l,inverseOrder:c}}),s={dataType:e.dataType,chunkShape:Array.from(t,r=>e.chunkShape[r])};return{configuration:{encodedToDecoded:t,decodedToEncoded:n},encodedArrayInfo:s}},getDecodedArrayLayoutInfo(i,e,t){return{physicalToLogicalDimension:Array.from(t.physicalToLogicalDimension,s=>i.encodedToDecoded[s]),readChunkShape:Array.from(i.decodedToEncoded,s=>t.readChunkShape[s])}}});const X$=new Set(["0.4","0.5-dev"]),FL=new Map([["angstrom",{unit:"m",scale:1e-10}],["foot",{unit:"m",scale:.3048}],["inch",{unit:"m",scale:.0254}],["mile",{unit:"m",scale:1609.34}],["parsec",{unit:"m",scale:0x6da012f95c9e88}],["yard",{unit:"m",scale:.9144}],["minute",{unit:"s",scale:60}],["hour",{unit:"s",scale:60*60}],["day",{unit:"s",scale:60*60*24}]]);for(const i of["meter","second"])for(const e of Zm){const{longPrefix:t}=e;t!==void 0&&FL.set(`${t}${i}`,{unit:i[0],scale:10**e.exponent})}function Q$(i){ee(i);const e=z(i,"name",ie),t=oe(i,"type",ie),n=oe(i,"unit",s=>{const r=FL.get(s);if(r===void 0)throw new Error(`Unsupported unit: ${JSON.stringify(s)}`);return r},{unit:"",scale:1});return{name:e,unit:n.unit,scale:n.scale,type:t}}function Z$(i){const e=Ee(i,Q$);return Ue({names:e.map(t=>{const{name:n,type:s}=t;return s==="channel"?`${n}'`:n}),scales:Float64Array.from(e,t=>t.scale),units:e.map(t=>t.unit)})}function eW(i,e){const t=z(e,"scale",n=>_e(new Float64Array(i),n,wt));return pg(Float64Array,t)}function tW(i,e){return ai(Float64Array,i+1)}function nW(i,e){const t=z(e,"translation",n=>_e(new Float64Array(i),n,Xe));return wR(Float64Array,t)}const iW=new Map([["scale",eW],["identity",tW],["translation",nW]]);function sW(i,e){ee(e);const t=z(e,"type",ie),n=iW.get(t);if(n===void 0)throw new Error(`Unsupported coordinate transform type: ${JSON.stringify(t)}`);return n(i,e)}function UL(i,e){let t=ai(Float64Array,i+1);return e===void 0||Ee(e,n=>{const s=sW(i,n);t=ro(new Float64Array(t.length),i+1,s,i+1,t,i+1,i+1,i+1,i+1)}),t}function rW(i,e,t){const n=z(t,"path",ie),s=z(t,"coordinateTransformations",o=>UL(i,o));return{url:`${e}/${n}`,transform:s}}function oW(i,e){const t=z(e,"axes",Z$),n=t.rank,s=z(e,"coordinateTransformations",c=>UL(n,c)),r=z(e,"datasets",c=>Ee(c,u=>{const h=rW(n,i,u);return h.transform=ro(new Float64Array((n+1)**2),n+1,s,n+1,h.transform,n+1,n+1,n+1,n+1),h}));if(r.length===0)throw new Error("At least one scale must be specified");const o=r[0].transform,l=new Float64Array(n);for(let c=0;c<n;++c){const u=l[c]=o[c*(n+1)+c];t.scales[c]*=u}for(const c of r){const u=c.transform;for(let h=0;h<n;++h){let g=0;for(let v=0;v<n;++v)g+=u[v*(n+1)+h]*.5;u[n*(n+1)+h]-=g}for(let h=0;h<n;++h)for(let g=0;g<=n;++g)u[g*(n+1)+h]/=l[h]}return{coordinateSpace:t,scales:r}}function aW(i,e){const t=e.multiscales;if(!Array.isArray(t))return;const n=[];for(const s of t){if(typeof s!="object"||s==null||Array.isArray(s))return;const r=s.version;if(r===void 0)return;if(!X$.has(r)){n.push(`OME multiscale metadata version ${JSON.stringify(r)} is not supported`);continue}return oW(i,s)}if(n.length!==0)throw new Error(n[0])}class lW extends at(ct()(Ps),Nm){}class cW extends di{constructor(e,t,n){super(e),this.credentialsProvider=t,this.multiscale=n,this.volumeType=At.IMAGE}get dataType(){return this.multiscale.dataType}get modelSpace(){return this.multiscale.coordinateSpace}get rank(){return this.multiscale.coordinateSpace.rank}getSources(e){return yr(this.multiscale.scales.map(t=>{const{metadata:n}=t,{rank:s,codecs:r,shape:o}=n,l=r.layoutInfo[0].readChunkShape,{physicalToLogicalDimension:c}=n.codecs.layoutInfo[0],u=new Uint32Array(s),h=new Float32Array(s),g=new Float32Array((s+1)**2);g[(s+1)**2-1]=1;for(let y=0;y<s;++y){const b=c[s-1-y];u[y]=l[b],h[y]=o[b],g[y+b*(s+1)]=1}const v=new Float32Array((s+1)**2);return ro(v,s+1,t.transform,s+1,g,s+1,s+1,s+1,s+1),po({rank:s,chunkToMultiscaleTransform:v,dataType:n.dataType,upperVoxelBound:h,volumeType:this.volumeType,chunkDataSizes:[u],volumeSourceOptions:e,fillValue:n.fillValue}).map(y=>({chunkSource:this.chunkManager.getChunkSource(lW,{credentialsProvider:this.credentialsProvider,spec:y,parameters:{url:t.url,metadata:n}}),chunkToMultiscaleTransform:v}))}))}}function Gp(i,e,t){return i.memoize.getUncounted({type:"zarr:json",url:t,credentialsProvider:jt(e)},async()=>{try{return await ei(e,t,{},tn)}catch(n){if(Wa(n))return;throw n}})}const dW=[{key:{value:"dimension_separator",description:"Dimension separator in chunk keys"},values:[{value:".",description:"(default)"},{value:"/",description:""}]}];function uW(i,e){const t=new Set,n=e===2?"d":"dim_";return i.map((s,r)=>{if(s===null){let l=r;for(;;){if(s=`${n}${l}`,!t.has(s))return t.add(s),s;++l}}if(!t.has(s))return t.add(s),s;let o=1;for(;;){const l=`${s}${o}`;if(!t.has(l))return t.add(l),l;++o}})}function hW(i,e){const t=uW(e.dimensionNames,e.zarrVersion),n=e.dimensionUnits.map(Y$),s=Ue({names:t,scales:Float64Array.from(Array.from(n,o=>o.scale)),units:Array.from(n,o=>o.unit),boundingBoxes:[qi({lowerBounds:new Float64Array(e.rank),upperBounds:Float64Array.from(e.shape)})]}),r=ai(Float64Array,e.rank+1);return{coordinateSpace:s,dataType:e.dataType,scales:[{url:i,transform:r,metadata:e}]}}async function fW(i,e,t,n){const s=await Promise.all(t.scales.map(async w=>{const C=await qu(i,e,w.url,{zarrVersion:n.zarrVersion,expectedNodeType:"array",explicitDimensionSeparator:n.explicitDimensionSeparator});if(C===void 0)throw new Error(`zarr v{zarrVersion} array metadata not found at ${w.url}`);return C})),r=s[0].dataType,o=s.length,l=t.coordinateSpace.rank;for(let w=0;w<o;++w){const C=t.scales[w],E=s[w];if(E.rank!==l)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have rank ${l}, but received: ${E.rank}`);if(E.dataType!==r)throw new Error(`Expected zarr array at ${JSON.stringify(C.url)} to have data type ${J[r]}, but received: ${J[E.dataType]}`)}const c=new Float64Array(l),u=new Float64Array(l),h=t.scales[0],g=s[0];for(let w=0;w<l;++w){const C=c[w]=h.transform[(l+1)*l+w];u[w]=C+g.shape[w]}const v=qi({lowerBounds:c,upperBounds:u}),{coordinateSpace:y}=t;return{coordinateSpace:Ue({names:y.names,units:y.units,scales:y.scales,boundingBoxes:[v]}),dataType:r,scales:t.scales.map((w,C)=>{const E=s[C];return{url:w.url,transform:w.transform,metadata:E}})}}async function qu(i,e,t,n){if(n.zarrVersion===2){const[o,l]=await Promise.all([Gp(i,e,`${t}/.zarray`),Gp(i,e,`${t}/.zattrs`)]);return o===void 0?l===void 0||n.expectedNodeType==="array"?void 0:{zarrVersion:2,nodeType:"group",userAttributes:ee(l)}:n.expectedNodeType==="group"?void 0:K$(o,l??{},n.explicitDimensionSeparator)}if(n.zarrVersion===3){const o=await Gp(i,e,`${t}/zarr.json`);if(o===void 0)return;if(n.explicitDimensionSeparator!==void 0)throw new Error("dimension_separator query parameter not supported for zarr v3");return q$(o,n.expectedNodeType)}const[s,r]=await Promise.all([qu(i,e,t,{...n,zarrVersion:2}),qu(i,e,t,{...n,zarrVersion:3})]);if(s!==void 0&&r!==void 0)throw new Error("Both zarr v2 and v3 metadata found");return s??r}class xy extends Bn{constructor(e=void 0){super(),this.zarrVersion=e}get description(){return`Zarr${this.zarrVersion===void 0?"":` v${this.zarrVersion}`} data source`}get(e){let[,t,n]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);const s=Ma(n||"");ee(s);const r=oe(s,"dimension_separator",Cy);return t.endsWith("/")&&(t=t.substring(0,t.length-1)),e.chunkManager.memoize.getUncounted({type:"zarr:MultiscaleVolumeChunkSource",providerUrl:t,dimensionSeparator:r},async()=>{const{url:o,credentialsProvider:l}=Ai(t,e.credentialsManager),c=await qu(e.chunkManager,l,o,{zarrVersion:this.zarrVersion,explicitDimensionSeparator:r});if(c===void 0)throw new Error("No zarr metadata found");let u;if(c.nodeType==="group"){const g=aW(o,c.userAttributes);if(g===void 0)throw new Error("Neithre array nor OME multiscale metadata found");u=await fW(e.chunkManager,l,g,{zarrVersion:c.zarrVersion,explicitDimensionSeparator:r})}else u=hW(o,c);const h=new cW(e.chunkManager,l,u);return{modelTransform:Jt(h.modelSpace),subsources:[{id:"default",default:!0,url:void 0,subsource:{volume:h}},{id:"bounds",default:!0,url:void 0,subsource:{staticAnnotations:Yi(h.modelSpace.bounds)}}]}})}async completeUrl(e){const[,,t]=e.providerUrl.match(/([^?]*)(?:\?(.*))?$/);return t!==void 0?br(e.providerUrl.length-t.length,await hE(t,dW)):await go(e.credentialsManager,e.providerUrl,e.cancellationToken)}}un("zarr",()=>new xy);un("zarr2",()=>new xy(2));un("zarr3",()=>new xy(3));function pW(i){i.registerEventListener(document,"copy",e=>{if(Dv(e.target))return;const t=document.getSelection();if(t!==null&&t.type==="Range")return;const n=Ph(i.state).value,{clipboardData:s}=e;s!==null&&s.setData("text/plain",JSON.stringify(n,void 0,"  ")),e.preventDefault()})}function gW(i,e){let t=String.raw`^[\[\]{}()\s,]*`;for(let r=0;r<e;++r)r!==0&&(t+=String.raw`[,\s]+`),t+=String.raw`(\d+(?:\.\d+)?)`;t+=String.raw`[\[\]{}()\s,]*$`;const n=i.match(t);if(n===null)return;const s=new Float32Array(e);for(let r=0;r<e;++r){const o=Number(n[r+1]);if(!Number.isFinite(o))return;s[r]=o}return s}function mW(i){i.registerEventListener(document,"paste",e=>{if(Dv(e.target))return;const{clipboardData:t}=e;if(t!==null){const n=t.getData("text/plain"),s=gW(n,i.coordinateSpace.value.rank);s!==void 0&&(i.navigationState.position.value=s)}e.preventDefault()})}function vW(){return ti(document,"contextmenu",i=>{i.preventDefault()})}function yW(){return ti(document,"wheel",i=>{i.ctrlKey&&i.preventDefault()},{passive:!1})}const UC=Symbol("SingleTextureVolumeChunk.textureUnit"),Wd=Symbol("SingleTextureVolumeChunk.textureLayout");class zL extends K{constructor(e,t){super(),this.shaderKey=e,this.dataType=t}defineShader(e,t){e.addTextureSampler(this.shaderSamplerType,"uVolumeChunkSampler",UC)}beginDrawing(e,t){const n=t.textureUnit(UC);e.activeTexture(WebGL2RenderingContext.TEXTURE0+n),t[Wd]=null}endDrawing(e,t){e.bindTexture(Kl[this.shaderSamplerType],null),t[Wd]=null}bindChunk(e,t,n,s,r,o,l){const c=n.textureLayout;(t[Wd]!==c||l)&&(t[Wd]=c,this.setupTextureLayout(e,t,c,s,r,o)),e.bindTexture(Kl[this.shaderSamplerType],n.texture)}beginSource(e,t){}}class GL extends zV{constructor(e,t){super(e,t),this.texture=null,this.data=t.data}copyToGPU(e){if(super.copyToGPU(e),this.data===null)return;const t=this.texture=e.createTexture(),n=Kl[this.chunkFormat.shaderSamplerType];e.bindTexture(n,t),this.setTextureData(e),e.bindTexture(n,null)}freeGPUMemory(e){super.freeGPUMemory(e),this.data!==null&&(e.deleteTexture(this.texture),this.texture=null,this.textureLayout.dispose(),this.textureLayout=null)}}let $L=class WL extends K{constructor(e,t,n){super(),this.chunkDataSize=t,this.textureDims=n,this.textureShape=new Uint32Array(this.textureDims);const s=t.length;let r=0;for(const g of t)g!==1&&++r;const o=this.strides=new Uint32Array(s*n),l=n===3?e.max3dTextureSize:e.maxTextureSize;let c=0,u=1;const{textureShape:h}=this;h.fill(1);for(let g=0;g<s;++g){const v=t[g];if(v===1)continue;const y=v*u;let b;y>l||u!==1&&c+r<n?(++c,u=v,b=1):(b=u,u=y),o[n*g+c]=b,h[c]=u}}static get(e,t,n){return e.memoize.get(`sliceview.UncompressedTextureLayout:${t.join()}:${n}`,()=>new WL(e,t,n))}},$p=new Uint32Array(3*5),SW=class HL extends zL{constructor(e,t,n,s){super(n,t),this.textureDims=s,uo(this,t),this.shaderSamplerType=`${this.samplerPrefix}sampler${s}D`,this.textureAccessHelper=new p_("chunkData",s)}static get(e,t,n){const s=`sliceview.UncompressedChunkFormat:${t}:${n}`;return e.memoize.get(s,()=>new HL(e,t,s,n))}defineShader(e,t){super.defineShader(e,t);const{textureDims:n}=this,s=`ivec${this.textureDims}`,{textureAccessHelper:r}=this,o=(4+t)*n;$p.length<o&&($p=new Uint32Array(o)),e.addUniform(`highp ${s}`,"uVolumeChunkStrides",4+t),e.addFragmentCode(r.getAccessor("readVolumeData","uVolumeChunkSampler",this.dataType));let c=`
${$t(this.dataType)} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)c+=`, highp int channelIndex${u}`;c+=`) {
  highp ${s} offset = uVolumeChunkStrides[0]
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)c+=`
  offset += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;c+=`
  return readVolumeData(offset);
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,n,s,r,o){const l=$p,c=o.length,{strides:u}=n,h=s.length,{textureDims:g}=this;for(let y=0;y<g;++y){let b=0;for(let w=0;w<h;++w)b+=s[w]*u[w*g+y];l[y]=b}for(let y=0;y<3;++y){const b=r[y];if(!(b>=h))for(let w=0;w<g;++w)l[(y+1)*g+w]=u[b*g+w]}for(let y=0;y<c;++y){const b=o[y];if(b===-1)l.fill(0,(4+y)*g,(4+y+1)*g);else for(let w=0;w<g;++w)l[(4+y)*g+w]=u[b*g+w]}const v=(4+c)*g;g===3?e.uniform3iv(t.uniform("uVolumeChunkStrides"),l,0,v):e.uniform2iv(t.uniform("uVolumeChunkStrides"),l,0,v)}getTextureLayout(e,t){return $L.get(e,t,this.textureDims)}setTextureData(e,t,n){const{textureShape:s}=t;(this.textureDims===3?h_:u_)(e,this,n,s[0],s[1],s[2])}};class bW extends GL{setTextureData(e){const{source:t}=this,{chunkFormatHandler:n}=t,{chunkFormat:s}=n;let r;this.chunkDataSize===t.spec.chunkDataSize?this.textureLayout=r=n.textureLayout.addRef():this.textureLayout=r=s.getTextureLayout(e,this.chunkDataSize),this.chunkFormat.setTextureData(e,r,this.data)}getValueAt(e){const{data:t}=this;if(t===null)return this.source.spec.fillValue;const{chunkFormat:n}=this,{chunkDataSize:s}=this;let r=0,o=1;const l=e.length;for(let u=0;u<l;++u)r+=o*e[u],o*=s[u];switch(n.dataType){case J.UINT8:case J.INT8:case J.FLOAT32:case J.UINT16:case J.INT16:case J.UINT32:case J.INT32:return t[r];case J.UINT64:{const u=r*2;return new X(t[u],t[u+1])}}}}let wW=class extends K{};function CW(i,e){const t=new Lx[i](UA[i]);return i===J.UINT64?(t[0]=e.low,t[1]=e.high):t[0]=e,t}function xW(i,e,t,n,s){const{dataType:r}=e,o=CW(r,t),l=new Uint32Array(n);l.fill(1);const c=new $L(i,l,s);c.strides.fill(0);const u=i.createTexture(),h=Kl[e.shaderSamplerType];i.bindTexture(h,u),e.setTextureData(i,c,o),i.bindTexture(h,null);const g=new wW;return g.textureLayout=c,g.texture=u,g}class EW extends K{constructor(e,t){super();let n=0;for(const r of t.chunkDataSize)r>1&&++n;const s=n>=3?3:2;this.chunkFormat=this.registerDisposer(SW.get(e,t.dataType,s)),this.textureLayout=this.registerDisposer(this.chunkFormat.getTextureLayout(e,t.chunkDataSize)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.UncompressedChunkFormat.fillValue:${t.chunkDataSize.length}:${t.dataType}:${t.fillValue}:${s}`,()=>xW(e,this.chunkFormat,t.fillValue,t.chunkDataSize.length,s)))}getChunk(e,t){const n=new bW(e,t);return n.data===null&&(n.texture=this.fillValueChunk.texture,n.textureLayout=this.fillValueChunk.textureLayout),n}}HT((i,e)=>e.compressedSegmentationBlockSize==null?new EW(i,e):null);/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function JL(i,e,t,n,s,r){let o=0,l=0,c=1,u=1;for(let w=0;w<3;++w){const C=s[w],E=n[w],k=Math.floor(C/E),D=C%E;o+=k*c,c*=Math.ceil(t[w]/E),l+=D*u,u*=E}const h=e+o*2,g=i[h],v=i[h+1];let y=g&16777215;const b=g>>24&255;if(b>0){const C=(e+v&16777215)+Math.floor(l*b/32),E=i[C],k=l*b%32,D=E>>k&(1<<b)-1;y+=r*D}return y}function TW(i,e,t,n,s){const r=JL(i,e,t,n,s,1)+e;return i[r]}function kW(i,e,t,n,s,r){const o=JL(e,t,n,s,r,2)+t;return i.low=e[o],i.high=e[o+1],i}class sf extends K{constructor(e,t){super();const n=this.subchunkGridSize=we();for(let s=0;s<3;++s)n[s]=Math.ceil(e[s]/t[s]);this.singleton=!1}static get(e,t,n){return e.memoize.get(`sliceview.CompressedSegmentationTextureLayout:${sg(t)},${sg(n)}`,()=>new sf(t,n))}}const LW=uo(new Ua,J.UINT32);let Wp=new Uint32Array(4*4);class Ey extends zL{constructor(e,t,n,s){super(s,e),this.subchunkSize=t,this.numChannels=n,this.textureAccessHelper=new Vh("chunkData")}static get(e,t,n,s){const r=`sliceview.CompressedSegmentationChunkFormat:${t}:${s}`,o=`${r}:${sg(n)}`;return e.memoize.get(o,()=>new Ey(t,n,s,r))}get shaderSamplerType(){return"usampler2D"}defineShader(e,t){super.defineShader(e,t);const n=4*(4+t);Wp.length<n&&(Wp=new Uint32Array(n));const{textureAccessHelper:s}=this;s.defineShader(e);const r=u=>"compressedSegmentationChunkFormat_"+u;e.addUniform("highp ivec3","uSubchunkGridSize"),e.addUniform("highp ivec3","uSubchunkSize"),e.addUniform("highp ivec4","uVolumeChunkStrides",4+t),e.addFragmentCode(nM);const{dataType:o}=this,l=$t(o);o===J.UINT64?e.addFragmentCode(kt):e.addFragmentCode(Sh),e.addFragmentCode(s.getAccessor(r("readTextureValue"),"uVolumeChunkSampler",J.UINT32,1));let c=`
uint ${r("getChannelOffset")}(int channelIndex) {
  if (channelIndex == 0) {
    return ${this.numChannels}u;
  }
  return ${r("readTextureValue")}(uint(channelIndex)).value;
}
${l} getDataValueAt(highp ivec3 p`;for(let u=0;u<t;++u)c+=`, highp int channelIndex${u}`;c+=`) {
  highp ivec4 chunkPositionFull = uVolumeChunkStrides[0] +
                     + p.x * uVolumeChunkStrides[1]
                     + p.y * uVolumeChunkStrides[2]
                     + p.z * uVolumeChunkStrides[3];
`;for(let u=0;u<t;++u)c+=`
  chunkPositionFull += channelIndex${u} * uVolumeChunkStrides[${4+u}];
`;c+=`
  highp ivec3 chunkPosition = chunkPositionFull.xyz;

  // TODO: maybe premultiply this and store as uniform.
  ivec3 subchunkGridPosition = chunkPosition / uSubchunkSize;
  int subchunkGridOffset = getFortranOrderIndex(subchunkGridPosition, uSubchunkGridSize);

  int channelOffset = int(${r("getChannelOffset")}(chunkPositionFull[3]));

  // TODO: Maybe just combine this offset into subchunkGridStrides.
  int subchunkHeaderOffset = subchunkGridOffset * 2 + channelOffset;

  highp uint subchunkHeader0 = ${r("readTextureValue")}(uint(subchunkHeaderOffset)).value;
  highp uint subchunkHeader1 = ${r("readTextureValue")}(uint(subchunkHeaderOffset + 1)).value;
  highp uint outputValueOffset = (subchunkHeader0 & 0xFFFFFFu) + uint(channelOffset);
  highp uint encodingBits = subchunkHeader0 >> 24u;
  if (encodingBits > 0u) {
    ivec3 subchunkPosition = chunkPosition - subchunkGridPosition * uSubchunkSize;
    int subchunkOffset = getFortranOrderIndex(subchunkPosition, uSubchunkSize);
    uint encodedValueBaseOffset = subchunkHeader1 + uint(channelOffset);
    uint encodedValueOffset = encodedValueBaseOffset + uint(subchunkOffset) * encodingBits / 32u;
    uint encodedValue = ${r("readTextureValue")}(encodedValueOffset).value;
    uint wordOffset = uint(subchunkOffset) * encodingBits % 32u;
    uint encodedValueShifted = encodedValue >> wordOffset;
    uint decodedValue = encodedValueShifted - (encodedValueShifted >> encodingBits << encodingBits);
    outputValueOffset += decodedValue * ${this.dataType===J.UINT64?"2u":"1u"};
  }
  ${l} result;
`,o===J.UINT64?c+=`
  result.value[0] = ${r("readTextureValue")}(outputValueOffset).value;
  result.value[1] = ${r("readTextureValue")}(outputValueOffset+1u).value;
`:c+=`
  result.value = ${r("readTextureValue")}(outputValueOffset).value;
`,c+=`
  return result;
}
`,e.addFragmentCode(c)}setupTextureLayout(e,t,n,s,r,o){const{subchunkGridSize:l}=n;e.uniform3i(t.uniform("uSubchunkGridSize"),l[0],l[1],l[2]);const c=Wp,u=o.length;if(c.fill(0),!n.singleton){for(let h=0;h<3;++h){c[h]=s[h];const g=r[h];g!==-1&&(c[4*(h+1)+g]=1)}for(let h=0;h<u;++h){const g=o[h];g!==-1&&(c[4*(4+h)+g]=1)}}e.uniform4iv(t.uniform("uVolumeChunkStrides"),c,0,(u+4)*4)}setTextureData(e,t,n){_h(e,LW,n)}getTextureLayout(e,t){return sf.get(e,t,this.subchunkSize)}beginSource(e,t){super.beginSource(e,t);const{subchunkSize:n}=this;e.uniform3i(t.uniform("uSubchunkSize"),n[0],n[1],n[2])}}class DW extends GL{setTextureData(e){const{data:t}=this,{chunkFormat:n}=this,s=this.textureLayout=n.getTextureLayout(e,this.chunkDataSize);n.setTextureData(e,s,t)}getValueAt(e){const{chunkDataSize:t,chunkFormat:n}=this,{data:s}=this;if(s===null)return this.source.spec.fillValue;const r=s[e[3]||0];if(n.dataType===J.UINT64){const o=new X;return kW(o,s,r,t,n.subchunkSize,e),o}return TW(s,r,t,n.subchunkSize,e)}}class IW extends K{}function PW(i,e,t){const{dataType:n,numChannels:s}=e,r=new Uint32Array(s+2+(n===J.UINT64?2:1));r[0]=s,r[s]=2,n===J.UINT64?(r[s+2]=t.low,r[s+3]=t.high):r[s+2]=t;const o=new sf(Uint32Array.of(1,1,1),Et(1,1,1));o.singleton=!0;const l=i.createTexture(),c=Kl[e.shaderSamplerType];i.bindTexture(c,l),e.setTextureData(i,o,r),i.bindTexture(c,null);const u=new IW;return u.textureLayout=o,u.texture=l,u}class AW extends K{constructor(e,t){super();const{dataType:n}=t;if(n!==J.UINT64&&n!==J.UINT32)throw new Error(`Unsupported compressed segmentation data type: ${J[n]}`);this.chunkFormat=this.registerDisposer(Ey.get(e,t.dataType,t.compressedSegmentationBlockSize,t.chunkDataSize[3]||1)),this.fillValueChunk=this.registerDisposer(e.memoize.get(`sliceview.CompressedSegmentationChunkFormat.fillValue:${t.dataType}:${t.fillValue}:${this.chunkFormat.numChannels}`,()=>PW(e,this.chunkFormat,t.fillValue)))}getChunk(e,t){const n=new DW(e,t);return n.data===null&&(n.texture=this.fillValueChunk.texture,n.textureLayout=this.fillValueChunk.textureLayout),n}}HT((i,e)=>e.compressedSegmentationBlockSize!=null?new AW(i,e):null);const RW=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle">
    <title id="arrowUpIconTitle">Arrow Up</title>    
    <path d="M18 9l-6-6-6 6"/>
    <path d="M12 21V4"/>
    <path stroke-linecap="round" d="M12 3v1"/>
</svg>`;function Rl(i,e=i.value){i.style.minWidth=e.length+1+"ch"}const zC="neuroglancer-coordinate-space-transform-singleton";function GC(i,e,t){let n;t&&(i+=.5,e+=.5),i===Number.NEGATIVE_INFINITY?n="(-∞,":n=`[${Math.floor(i)},`;let s;return e===Number.POSITIVE_INFINITY?s="+∞)":s=`${Math.floor(e)})`,{lower:n,upper:s}}const $C=He.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},arrowleft:{action:"move-left",preventDefault:!1},arrowright:{action:"move-right",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel"}});function WC(){const i=document.createElement("div"),e=document.createElement("input");i.classList.add("neuroglancer-coordinate-space-transform-scale-container"),e.spellcheck=!1,e.autocomplete="off",e.size=1,e.classList.add("neuroglancer-coordinate-space-transform-scale"),i.appendChild(e);const t=document.createElement("div"),n=document.createElement("span");n.innerHTML=RW,t.appendChild(n);const s=document.createTextNode("");return t.appendChild(s),t.classList.add("neuroglancer-coordinate-space-transform-scale-suggestion"),i.appendChild(t),{cellElement:i,inputElement:e,suggestionElement:t}}function HC(i,e,t,n,s){if(e===void 0||e.scale===t&&e.unit===n)i.style.display="none";else{i.style.display="";const r=qr(e.scale,e.unit,{elide1:!1});i.lastChild.textContent=r,i.title=`${s}${r}`}}function JC(){const i=document.createElement("input");return i.spellcheck=!1,i.autocomplete="off",i.size=1,i.placeholder=" ",i.classList.add("neuroglancer-coordinate-space-transform-output-name"),i}function jC(i,e,t){const n=i.map(v=>jl(v.value));if(n.includes(void 0))return!1;const s=Float64Array.from(n,v=>v.scale),r=Array.from(n,v=>v.unit),o=t.value,{scales:l,units:c,rank:u}=o;for(let v=0;v<u;++v)e[v]||(s[v]=l[v],r[v]=c[v]);if(De(l,s)&&De(c,r))return!1;const h=o.timestamps.map((v,y)=>s[y]===l[y]&&r[y]===c[y]?v:Date.now()),g=Ue({valid:o.valid,rank:o.rank,scales:s,units:r,timestamps:h,ids:o.ids,names:o.names,boundingBoxes:o.boundingBoxes,coordinateArrays:o.coordinateArrays});return t.value=g,!0}function YC(i,e,t,n){const s=new Float64Array(i.scales),r=Array.from(i.units);if(s[e]===t&&r[e]===n)return i;const o=Array.from(i.timestamps);return s[e]=t,r[e]=n,o[e]=Date.now(),{...i,scales:s,units:r,timestamps:o}}class NW extends K{constructor(e,t,n){super(),this.transform=e,this.localCombiner=t,this.globalCombiner=n,this.element=document.createElement("div"),this.coefficientContainer=document.createElement("div"),this.translationContainer=document.createElement("div"),this.outputNameContainer=document.createElement("div"),this.outputScaleContainer=document.createElement("div"),this.inputNameContainer=document.createElement("div"),this.inputScaleContainer=document.createElement("div"),this.inputLowerBoundsContainer=document.createElement("div"),this.inputUpperBoundsContainer=document.createElement("div"),this.coefficientElements=[],this.inputNameElements=[],this.outputNameElements=[],this.outputScaleElements=[],this.outputScaleSuggestionElements=[],this.inputScaleSuggestionElements=[],this.inputScaleElements=[],this.inputBoundsElements=[],this.outputBoundsElements=[],this.addSourceDimensionIcon=$e({svg:Fu,text:"S"}),this.addOutputDimensionIcon=$e({svg:Fu,text:"V"}),this.addOutputDimensionCell=document.createElement("div"),this.addOutputDimensionInput=JC(),this.inputScaleModified=[],this.outputScaleModified=[],this.curSourceRank=-1,this.curRank=-1,this.curTransform=void 0,this.addingSourceDimension=!1,this.resetToIdentityButton=$e({text:"Set to identity",title:"Reset to identity transform",onClick:()=>{const{transform:_}=this,W=_.value.rank;_.transform=ai(Float64Array,W+1)}}),this.resetToDefaultButton=$e({text:"Reset to default",title:"Reset to default input scales, transform, and output dimensions.",onClick:()=>{const{transform:_}=this;if(_.mutableSourceRank)return;const{defaultTransform:W}=_,{outputSpace:U}=W,j=U.ids.map(()=>Qo());_.value={...W,outputSpace:{...U,ids:j}}}});const{element:s}=this,r=this.registerDisposer(new Pi(s,$C));r.allShortcutsAreGlobal=!0,s.classList.add("neuroglancer-coordinate-space-transform-widget"),this.registerDisposer(new ji(s,$C));const o=et(()=>this.updateView());this.registerDisposer(e.changed.add(o));const{coefficientContainer:l,translationContainer:c,outputNameContainer:u,inputNameContainer:h,inputScaleContainer:g,inputLowerBoundsContainer:v,inputUpperBoundsContainer:y,outputScaleContainer:b,addOutputDimensionCell:w,addOutputDimensionIcon:C,addSourceDimensionIcon:E,resetToIdentityButton:k,resetToDefaultButton:D}=this;l.style.display="contents",c.style.display="contents",u.style.display="contents",h.style.display="contents",g.style.display="contents",b.style.display="contents",v.style.display="contents",y.style.display="contents";const A=document.createElement("div");A.classList.add("neuroglancer-coordinate-space-transform-widget-reset-buttons"),k.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-identity"),D.classList.add("neuroglancer-coordinate-space-transform-widget-reset-to-default"),A.appendChild(k),A.appendChild(D),s.appendChild(A);for(const[_,W]of[["source","Source dimensions"],["output","Output dimensions"],["input-lower","Lower"],["input-upper","Upper"],["input-scale","Scale"],["translation","Translation"]]){const U=document.createElement("div");U.classList.add(`neuroglancer-coordinate-space-transform-${_}-label`),U.classList.add("neuroglancer-coordinate-space-transform-label"),U.textContent=W,s.appendChild(U)}e.mutableSourceRank&&w.appendChild(E),w.appendChild(C),w.classList.add("neuroglancer-coordinate-space-transform-output-extend");const N="Embed in additional output dimension",I="Extend to additional source dimension";C.title=N,E.title=I,w.appendChild(this.addOutputDimensionInput),w.dataset.isActive="false",C.addEventListener("click",()=>{this.addingSourceDimension=!1,this.addOutputDimensionInput.title=N,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),E.addEventListener("click",()=>{this.addingSourceDimension=!0,this.addOutputDimensionInput.title=I,this.addOutputDimensionCell.dataset.isActive="true",this.addOutputDimensionInput.focus()}),this.addOutputDimensionInput.addEventListener("blur",()=>{this.updateAddOutputDimensionCellStyle()}),s.appendChild(l),s.appendChild(u),s.appendChild(h),s.appendChild(g),s.appendChild(b),s.appendChild(v),s.appendChild(y),l.appendChild(c),s.addEventListener("input",_=>{const{target:W}=_;if(W instanceof HTMLInputElement){Rl(W);let U=this.inputScaleElements.indexOf(W);if(U!==-1){this.inputScaleModified[U]=!0,this.updateScaleValidity(W);return}if(U=this.outputScaleElements.indexOf(W),U!==-1){this.outputScaleModified[U]=!0,this.updateScaleValidity(W);return}if(U=this.outputNameElements.indexOf(W),U!==-1){this.updateOutputNameValidity();return}if(this.coefficientContainer.contains(W)){this.updateCoefficientValidity(W);return}}});const P=(_,W,U)=>{fe(s,_,j=>{j.stopPropagation();const B=j.target;if(!(B instanceof HTMLInputElement)||U!==0&&(B.selectionStart!==B.selectionEnd||B.selectionStart!==(U===1?B.value.length:0)))return;const H=this.getElementGridPosition(B);if(H===void 0)return;const V=this.getElementByGridPosition(H.row+W,H.col+U);V!==null&&(V.focus(),j.preventDefault())})};P("move-up",-1,0),P("move-down",1,0),P("move-left",0,-1),P("move-right",0,1);const O=(_,W)=>{_.addEventListener("focusout",U=>{const{relatedTarget:j}=U;j instanceof Node&&_.contains(j)||W(U)})};O(l,()=>{this.updateModelTransform()||this.updateViewTransformCoefficients()}),O(u,()=>{this.updateModelOutputNames()||this.updateViewOutputNames()}),O(g,()=>{this.updateModelInputScales()||this.updateViewInputScales()}),O(b,()=>{this.updateModelOutputScales()||this.updateViewOutputScales()}),fe(s,"cancel",_=>{this.curTransform=void 0,this.updateView(),_.target.blur()}),fe(l,"commit",()=>{this.updateModelTransform()}),fe(u,"commit",()=>{this.updateModelOutputNames()}),fe(g,"commit",()=>{this.updateModelInputScales()}),fe(b,"commit",()=>{this.updateModelOutputScales()}),s.addEventListener("focusin",_=>{const{target:W}=_;W instanceof HTMLInputElement&&W.select()}),this.updateView()}updateWillBeDeletedAttributes(e){const{rank:t}=this.transform.value;e===void 0&&(e=new Array(t),e.fill(!1));const{coefficientElements:n,inputBoundsElements:s,inputScaleElements:r}=this;for(let o=0;o<t;++o){const l=e[o];for(let h=0;h<=t;++h){const g=n[t*h+o],v=h<t&&e[h];g.dataset.willBeDeleted=(l||v).toString()}r[o].dataset.willBeDeleted=l.toString();const{lower:c,upper:u}=s[o];c.dataset.willBeDeleted=l.toString(),u.dataset.willBeDeleted=l.toString()}}updateAddOutputDimensionCellStyle(){const{addOutputDimensionInput:e}=this;this.addOutputDimensionCell.dataset.isActive=(e.value.length!==0||document.activeElement===e).toString()}updateOutputNameValidity(){const{outputNameElements:e}=this,t=e.map(c=>c.value),{value:{sourceRank:n,rank:s},mutableSourceRank:r}=this.transform;if(e.length!==s+1)return;const o=sv(t),l=new Array(s);l.fill(!1);for(let c=0;c<=s;++c){let u=o[c];t[c].length===0&&(r||c>=n)&&(u=!0,l[c]=!0),e[c].dataset.isValid=u.toString()}this.updateWillBeDeletedAttributes(l),this.updateAddOutputDimensionCellStyle()}updateScaleValidity(e){const t=jl(e.value)!==void 0;e.dataset.isValid=t.toString()}updateCoefficientValidity(e){const t=Number.isFinite(Number(e.value));e.dataset.isValid=t.toString()}getElementGridPosition(e){{const t=this.outputNameElements.indexOf(e);if(t!==-1)return{row:t,col:-2}}{const t=this.inputScaleElements.indexOf(e);if(t!==-1)return{row:-1,col:t}}{const t=this.coefficientElements.indexOf(e),{rank:n}=this.transform.value;if(t!==-1)return{row:t%n,col:Math.floor(t/n)}}{const t=this.outputScaleElements.indexOf(e);if(t!==-1)return{row:t,col:-1}}}getElementByGridPosition(e,t){const{rank:n}=this.transform.value;return e===-1?t<0||t>=n?null:this.inputScaleElements[t]:t===-2?e<0||e>n?null:this.outputNameElements[e]:t===-1?e<0||e>=n?null:this.outputScaleElements[e]:e<0||e>=n||t<0||t>n?null:this.coefficientElements[t*n+e]}dimensionRefCount(e){return(Vl(e)?this.localCombiner:this.globalCombiner).dimensionRefCounts.get(e)||0}updateModelInputScales(){return jC(this.inputScaleElements,this.inputScaleModified,this.transform.inputSpace)}updateModelOutputScales(){return jC(this.outputScaleElements,this.outputScaleModified,this.transform.outputSpace)}updateModelOutputNames(){const e=this.outputNameElements.map(k=>k.value),{value:t,mutableSourceRank:n}=this.transform,{outputSpace:s,rank:r,sourceRank:o}=t;if(e.length!==r+1)return;const l=[],c=[],u=e[r].length!==0;let h=o;for(let k=0;k<=r;++k){const D=e[k];if(D.length===0){if(k<o){if(!n)return!1;--h}continue}c.push(D),l.push(k)}if(!uh(c))return!1;const g=s.names;if(!u&&De(g,c))return!0;let v=t.inputSpace,y=t.outputSpace,b=t.transform;if(u){this.addingSourceDimension&&++h;const k=e[r],D=(Vl(k)?this.localCombiner:this.globalCombiner).combined.value,A=D.names.indexOf(k);let N,I;A!==-1?(N=D.units[A],I=D.scales[A]):(N="",I=1);const P=v.boundingBoxes.map(O=>Qx(O,r,r+1));this.addingSourceDimension||P.push(Xx(r+1,r)),v=Ue({valid:v.valid,rank:r+1,names:[...v.names,""],ids:[...v.ids,Qo()],timestamps:[...v.timestamps,Date.now()],scales:Float64Array.from([...v.scales,I]),units:[...v.units,N],boundingBoxes:P,coordinateArrays:[...v.coordinateArrays,void 0]}),y=Ue({valid:s.valid,rank:r+1,names:[...s.names,k],ids:[...s.ids,Qo()],timestamps:[...s.timestamps,Date.now()],scales:Float64Array.from([...s.scales,I]),units:[...s.units,N],coordinateArrays:[...s.coordinateArrays,void 0]}),b=Xm(new Float64Array((r+2)**2),r+1,b,r)}b=n1(Float64Array,b,v.rank,l,l),v=Sg(v,l),y=Sg(y,l);const w=y.ids.map((k,D)=>{const A=l[D];if(A===r)return k;const N=c[D],I=g[A];return N===I||this.dimensionRefCount(I)===1&&this.dimensionRefCount(N)===(g.includes(N)?1:0)?k:Qo()}),C=y.timestamps.map((k,D)=>{const A=l[D];return A===r||c[D]===g[A]?k:Date.now()});y={...y,names:c,ids:w,timestamps:C};const E={rank:y.rank,sourceRank:h,outputSpace:y,inputSpace:v,transform:b};return this.transform.value=E,!0}updateModelTransform(){const e=this.coefficientElements,{rank:t}=this.transform.value,n=new Float64Array((t+1)**2);n[n.length-1]=1;for(let s=0;s<t;++s)for(let r=0;r<=t;++r){const o=e[r*t+s],l=parseFloat(o.value);if(!Number.isFinite(l))return!1;n[r*(t+1)+s]=l}return this.transform.transform=n,!0}updateViewOutputNames(){const{transform:{value:{outputSpace:e,rank:t}}}=this;if(t!==this.curRank)return;const{outputNameElements:n}=this,{names:s}=e;for(let r=0;r<t;++r){const o=n[r];o.value=s[r],o.dataset.isValid="true",Rl(o)}n[t].value="",this.updateWillBeDeletedAttributes()}updateViewTransformCoefficients(){const{transform:{value:{transform:e,rank:t}}}=this,{coefficientElements:n}=this;for(let s=0;s<t;++s)for(let r=0;r<=t;++r){const o=n[r*t+s];o.value=e[r*(t+1)+s].toString(),o.dataset.isValid="true",Rl(o)}}ensureViewRankUpdated(){const e=this.transform.value,{rank:t}=e,n=e.sourceRank;if(this.curSourceRank===n&&this.curRank===t)return;const{inputBoundsElements:s,inputNameElements:r,inputScaleElements:o}=this,{element:l,coefficientElements:c,outputNameElements:u,outputScaleElements:h,outputScaleSuggestionElements:g,inputScaleSuggestionElements:v,outputBoundsElements:y,coefficientContainer:b,translationContainer:w,outputNameContainer:C,inputNameContainer:E,inputScaleContainer:k,inputLowerBoundsContainer:D,inputUpperBoundsContainer:A,outputScaleContainer:N}=this;l.style.gridTemplateColumns=`[outputLabel headerStart] min-content [outputNames] 1fr [outputScales] 1fr [headerEnd] repeat(${Math.max(1,t)+1}, [sourceDim] 1fr)`,l.style.gridTemplateRows=`[sourceLabel headerStart] auto [sourceNames] auto [sourceLower] auto [sourceUpper] auto [sourceScales] auto [headerEnd]repeat(${t+1}, [outputDim] auto)`,Fe(b),Fe(w),b.appendChild(w),Fe(C),Fe(E),Fe(k),Fe(D),Fe(A),Fe(N),r.length=0,o.length=0,s.length=0,h.length=0,g.length=0,v.length=0,c.length=0,u.length=0,y.length=0;for(let I=0;I<t;++I){const P=O=>{O.classList.add("neuroglancer-coordinate-space-transform-input"),I>=n&&O.classList.add(zC)};{const O=document.createElement("div");O.classList.add("neuroglancer-coordinate-space-transform-input-name"),P(O),O.style.gridRowStart="sourceNames",O.style.gridColumnStart=`sourceDim ${I+1}`,E.appendChild(O),r.push(O)}{const{cellElement:O,inputElement:_,suggestionElement:W}=WC();O.classList.add("neuroglancer-coordinate-space-transform-input-scale-container"),P(O),O.style.gridRowStart="sourceScales",O.style.gridColumnStart=`sourceDim ${I+1}`,k.appendChild(O),o.push(_),v.push(W);const U=I;W.addEventListener("click",()=>{const j=sb(this.transform,U);j!==void 0&&(this.transform.inputSpace.value=YC(this.transform.inputSpace.value,U,j.scale,j.unit))})}{const O=document.createElement("div");P(O),O.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),O.style.gridRowStart="sourceLower",O.style.gridColumnStart=`sourceDim ${I+1}`,D.appendChild(O);const _=document.createElement("div");P(_),_.classList.add("neuroglancer-coordinate-space-transform-input-bounds"),_.style.gridRowStart="sourceUpper",_.style.gridColumnStart=`sourceDim ${I+1}`,A.appendChild(_),s.push({lower:O,upper:_})}}for(let I=0;I<t;++I){for(let P=0;P<=t;++P){const O=document.createElement("input");O.classList.add("neuroglancer-coordinate-space-transform-coeff"),O.spellcheck=!1,O.autocomplete="off",O.size=1,O.style.gridRowStart=`outputDim ${I+1}`,O.placeholder=" ",O.style.gridColumnStart=`sourceDim ${P+1}`,c[P*t+I]=O,P===t?O.classList.add("neuroglancer-coordinate-space-transform-translation-coeff"):P===n&&O.classList.add(zC),(P===t?w:b).appendChild(O)}{const{cellElement:P,suggestionElement:O,inputElement:_}=WC();P.classList.add("neuroglancer-coordinate-space-transform-output-scale-container"),P.style.gridRowStart=`outputDim ${I+1}`,P.style.gridColumnStart="outputScales";const W=I;O.addEventListener("click",()=>{const{value:U}=this.transform,j=ib(U,W);j!==void 0&&(this.transform.outputSpace.value=YC(U.outputSpace,W,j.scale,j.unit))}),g.push(O),N.appendChild(P),h.push(_)}{const P=document.createElement("div");P.classList.add("neuroglancer-coordinate-space-transform-output-name-container"),P.style.gridRowStart=`outputDim ${I+1}`,P.style.gridColumnStart="outputNames";const O=JC();O.title="Rebind to a different dimension",I>=n?O.title+=", or delete to remove singleton dimension":this.transform.mutableSourceRank&&(O.title+=", or delete to remove source dimension"),O.title+=".  Names ending in ' or ^ indicate dimensions local to the layer; names ending in ^ indicate channel dimensions (image layers only).",u.push(O),C.appendChild(P),P.appendChild(O);const _=document.createElement("div");_.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),P.appendChild(_);const W=document.createElement("div");W.classList.add("neuroglancer-coordinate-space-transform-output-bounds"),P.appendChild(W),y.push({lower:_,upper:W}),P.addEventListener("mousedown",U=>{U.target!==O&&(O.focus(),U.preventDefault())})}}u.push(this.addOutputDimensionInput),this.addOutputDimensionInput.value="",C.appendChild(this.addOutputDimensionCell),this.curSourceRank=n,this.curRank=t}updateViewInputScales(){this.ensureViewRankUpdated(),this.inputScaleModified.length=0;const{inputSpace:e,rank:t,sourceRank:n}=this.transform.value,{inputBoundsElements:s,inputNameElements:r,inputScaleElements:o,inputScaleSuggestionElements:l}=this,{names:c,scales:u,units:h,bounds:{lowerBounds:g,upperBounds:v,voxelCenterAtIntegerCoordinates:y}}=e;for(let b=0;b<t;++b){const w=o[b],C=u[b],E=h[b];w.value=qr(C,E,{elide1:!1}),w.dataset.isValid="true",Rl(w);let k;if(b<n){let I=c[b];I||(I=`${b}`),r[b].textContent=I,k=`source dimension ${I}`,w.title=`Override scale of ${k}`}else k="singleton dimension",w.title=`Set extent of ${k}`;const{lower:D,upper:A}=GC(g[b],v[b],y[b]),N=s[b];N.lower.textContent=D,N.lower.title=`Lower bound of ${k}`,N.upper.title=`Upper bound of ${k}`,N.upper.textContent=A,HC(l[b],sb(this.transform,b),C,E,`Revert scale of ${k} to `)}}updateViewOutputScales(){const{value:e}=this.transform,{rank:t,names:n,units:s,scales:r,bounds:{lowerBounds:o,upperBounds:l,voxelCenterAtIntegerCoordinates:c}}=e.outputSpace,{outputScaleElements:u,outputBoundsElements:h,outputScaleSuggestionElements:g}=this;for(let v=0;v<t;++v){const y=u[v],b=r[v],w=s[v];y.value=qr(b,w,{elide1:!1}),Rl(y);const C=n[v];y.dataset.isValid="true";const E=`Change coordinates of ${Vl(C)?"local":"global"} dimension ${C}`;y.title=`${E} (does not rescale the source)`;const{lower:k,upper:D}=GC(o[v],l[v],c[v]),A=h[v];A.lower.textContent=k,A.upper.textContent=D,HC(g[v],ib(e,v),b,w,`${E} to inferred scale of `)}}updateResetButtonVisibility(e=!1,t=!1){const{transform:{value:n,mutableSourceRank:s,defaultTransform:r}}=this,{rank:o}=n;this.resetToIdentityButton.style.visibility=e||!CR(n.transform,o+1,o+1)?"visible":"hidden",this.resetToDefaultButton.style.visibility=!s&&(e||t||!GR(r,n))?"visible":"hidden"}updateView(){const e=this.transform.value;this.curTransform!==e&&(this.curTransform=e,this.ensureViewRankUpdated(),this.updateViewInputScales(),this.updateViewOutputNames(),this.updateViewTransformCoefficients(),this.updateViewOutputScales(),this.updateAddOutputDimensionCellStyle(),this.updateResetButtonVisibility())}disposed(){gt(this.element),super.disposed()}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function MW(i,e,{horizontal:t=!1,vertical:n=!0,topMargin:s=6,bottomMargin:r=6,leftMargin:o=6,rightMargin:l=6,maxHeight:c=!0,maxWidth:u=!0}={}){const h=e.getBoundingClientRect();if(t){const g=i.ownerDocument.documentElement.clientWidth,v=h.right,y=g-h.left;v>y?(i.style.left="",i.style.right=`${g-h.right}px`,u&&(i.style.maxWidth=v-o+"px")):(i.style.right="",i.style.left=`${h.left}px`,u&&(i.style.maxWidth=y-l+"px"))}if(n){const g=i.ownerDocument.documentElement.clientHeight,v=h.top-s,y=g-h.bottom-r;i.style.left=`${h.left}px`,i.style.width=`${h.width}px`,v>y*3?(i.style.top="",i.style.bottom=`${g-h.top}px`,c&&(i.style.maxHeight=v+"px")):(i.style.top=`${h.bottom}px`,i.style.bottom="",c&&(i.style.maxHeight=y+"px"))}}/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function OW(i){const e=i[Symbol.iterator](),{value:t,done:n}=e.next();if(n)return"";let s=t.length;for(;s>0;){const{value:r,done:o}=e.next();if(o)break;let l=0;for(;l<s&&t.charCodeAt(l)===r.charCodeAt(l);++l);s=l}return t.substring(0,s)}const Hp="neuroglancer-multiline-autocomplete-completion-active";function _W(i){const e=document.createElement("div");return e.textContent=i.value,e}function*qC(i){for(;i.length>0;){const e=i.match(/[:/_]+/);if(e===null){yield i;return}const t=e.index+e[0].length;yield i.substring(0,t),i=i.substring(t)}}function VW(i){const e=document.createElement("div");e.className="neuroglancer-multiline-autocomplete-completion-with-description",e.textContent=i.value;const t=document.createElement("div");return t.className="neuroglancer-multiline-autocomplete-completion-description",t.textContent=i.description||"",e.appendChild(t),e}const BW=He.fromObject({arrowdown:{action:"cycle-next-active-completion"},arrowup:{action:"cycle-prev-active-completion"},home:{action:"home"},end:{action:"end"},tab:{action:"choose-active-completion-or-prefix",preventDefault:!1},enter:{action:"commit"},escape:{action:"cancel",preventDefault:!1,stopPropagation:!1}}),FW=200;class UW extends K{constructor(e){super(),this.element=document.createElement("div"),this.inputElement=document.createElement("span"),this.hintElement=document.createElement("span"),this.completionsVirtualList=void 0,this.onCommit=new Ze,this.onInput=new Ze,this.prevInputValue="",this.completionsVisible=!1,this.activeCompletionPromise=null,this.activeCompletionCancellationToken=void 0,this.hasFocus=!1,this.completionResult=null,this.dropdownContentsStale=!0,this.hasResultForDropdown=!1,this.commonPrefix="",this.completionDisabled=-1,this.activeIndex=-1,this.dropdownStyleStale=!0,this.resizeHandler=()=>{this.completionsVisible&&this.updateDropdownStyle()},this.resizeObserver=new ResizeObserver(this.resizeHandler),this.debouncedUpdateHintState=this.registerCancellable(ze(()=>this.updateHintState(),0)),this.completer=e.completer;const{delay:t=FW}=e,n=this.scheduleUpdateCompletions=ze(()=>{const c=this.activeCompletionCancellationToken=new Sr,u=this.activeCompletionPromise=this.completer(this.value,c);u!==null&&u.then(h=>{this.activeCompletionPromise===u&&(this.setCompletions(h),this.activeCompletionPromise=null)})},t);this.registerDisposer(()=>{n.cancel()});const{element:s,inputElement:r,hintElement:o}=this;s.classList.add("neuroglancer-multiline-autocomplete"),this.registerEventListener(window,"resize",this.resizeHandler),this.resizeObserver.observe(s),this.registerDisposer(()=>this.resizeObserver.unobserve(r)),r.contentEditable="true",r.spellcheck=!1,s.appendChild(document.createTextNode("​")),s.appendChild(r),s.appendChild(o),r.classList.add("neuroglancer-multiline-autocomplete-input"),o.classList.add("neuroglancer-multiline-autocomplete-hint"),r.addEventListener("input",()=>{this.completionDisabled=-1,this.setValueAndSelection(this.value,this.getSelectionRange()),this.debouncedUpdateHintState()}),r.addEventListener("copy",c=>{const{clipboardData:u}=c;if(u!==null){const h=window.getSelection();h!==null&&!h.isCollapsed&&h.containsNode(r,!0)&&u.setData("text/plain",h.toString())}c.preventDefault(),c.stopPropagation()}),this.registerEventListener(document,"selectionchange",()=>{const c=this.getSelectionRange(),{completionDisabled:u}=this;c!==void 0&&c.begin===u&&c.end===u||(this.completionDisabled=-1,this.debouncedUpdateHintState())}),this.setValueAndSelection(""),this.updateHintState(),s.addEventListener("pointerdown",c=>{const{target:u}=c;if(u instanceof Node){if(r.contains(u))return;const{completionsVirtualList:h}=this;if(h!=null&&h.element.contains(u))return}r===document.activeElement&&(this.moveCaretToEndOfInput(),c.stopPropagation(),c.preventDefault())}),s.addEventListener("click",()=>{r.focus()}),this.registerEventListener(this.inputElement,"focus",()=>{if(!this.hasFocus){this.hasFocus=!0,this.dropdownStyleStale=!0,this.updateDropdown();const c=document.createRange(),{childNodes:u}=r;c.setStart(r,0),u.length===0?c.setEnd(r,0):c.setEndAfter(u[u.length-1]);const h=window.getSelection();h!==null&&(h.removeAllRanges(),h.addRange(c)),this.debouncedUpdateHintState()}}),this.registerEventListener(this.inputElement,"blur",()=>{this.hasFocus&&(this.hasFocus=!1,this.updateDropdown()),this.debouncedUpdateHintState();const c=window.getSelection();c!==null&&c.containsNode(this.inputElement,!0)&&c.removeAllRanges(),this.onCommit.dispatch(this.value,!1)}),this.registerEventListener(window,"resize",()=>{this.dropdownStyleStale=!0}),this.registerEventListener(window,"scroll",()=>{this.dropdownStyleStale=!0});const l=this.registerDisposer(new Pi(r,BW));l.allShortcutsAreGlobal=!0,fe(r,"cycle-next-active-completion",()=>{this.cycleActiveCompletion(1)}),fe(r,"cycle-prev-active-completion",()=>{this.cycleActiveCompletion(-1)}),fe(r,"home",()=>{this.moveCaretToBeginningOfInput()}),fe(r,"end",()=>{this.moveCaretToEndOfInput()}),fe(r,"choose-active-completion-or-prefix",c=>{this.selectActiveCompletion(!0)&&c.preventDefault()}),fe(r,"commit",c=>{if(this.selectActiveCompletion(!1))c.stopPropagation();else{const u=!this.completionsVisible;this.disableCompletion(),this.hideCompletions(),this.onCommit.dispatch(this.value,u)}}),fe(r,"cancel",c=>{c.stopPropagation(),this.cancel()&&(c.detail.preventDefault(),c.detail.stopPropagation())})}disableCompletion(){const e=this.getSelectionRange();this.completionDisabled=e!==void 0&&e.end===e.begin?e.end:-1}get placeholder(){return this.inputElement.dataset.placeholder||""}set placeholder(e){this.inputElement.dataset.placeholder=e}getSelectionRange(){const e=window.getSelection();if(e===null||e.rangeCount===0)return;const t=e.getRangeAt(0),{inputElement:n}=this,s=document.createRange();s.setStart(n,0),s.setEnd(t.startContainer,t.startOffset);const r=s.toString().length,o=e.toString().length;return{begin:r,end:r+o}}setValueAndSelection(e,t=void 0){const n=this.completionDisabled!==-1;this.onInput.dispatch(e);const{inputElement:s}=this;Fe(s);let r=0;const o=t!==void 0?document.createRange():void 0;let l=!0;for(const c of qC(e)){l||s.appendChild(document.createElement("wbr")),l=!1;const u=r+c.length,h=document.createTextNode(c);if(s.appendChild(h),o!==void 0){const{begin:g,end:v}=t;g>=r&&g<=u&&o.setStart(h,g-r),v>=r&&v<=u&&o.setEnd(h,v-r)}r=u}if(o!==void 0){l&&(o.setStart(s,0),o.setEnd(s,0));const c=window.getSelection();c!==null&&(c.removeAllRanges(),c.addRange(o))}this.completionDisabled=n&&t!==void 0&&t.end===t.begin?t.end:-1}shouldAttemptCompletion(){const{inputElement:e}=this;if(document.activeElement!==e)return!1;const t=this.getSelectionRange();return t!==void 0&&t.end===t.begin&&t.end!==this.completionDisabled&&t.end===this.value.length}hideCompletions(){this.cancelActiveCompletion(),this.clearCompletions(),this.hintElement.textContent=""}updateHintState(){if(this.debouncedUpdateHintState.cancel(),!this.shouldAttemptCompletion()){this.hideCompletions();return}const{value:e}=this;e!==this.prevInputValue&&(this.hideCompletions(),this.prevInputValue=e,this.scheduleUpdateCompletions())}handleDropdownClick(e){const{completionsVirtualList:t}=this;if(t===void 0)return;const n=t.element;for(let s=e.target;s instanceof HTMLElement&&s!==n;s=s.parentElement){const r=s.dataset.completionIndex;if(r!==void 0){this.selectCompletion(Number(r));break}}}cycleActiveCompletion(e){if(this.completionResult===null)return;let{activeIndex:t}=this;const n=this.completionResult.completions.length;t===-1?e>0?t=0:t=n-1:t=(t+e+n)%n,this.setActiveIndex(t)}shouldShowDropdown(){const{completionResult:e}=this;return e===null||!this.hasFocus?!1:this.hasResultForDropdown}updateDropdownStyle(){const{completionsVirtualList:e,element:t}=this;e!==void 0&&MW(e.element,t,{horizontal:!1}),this.dropdownStyleStale=!1}updateDropdown(){let{completionsVirtualList:e}=this;if(this.shouldShowDropdown()){if(this.dropdownContentsStale){e!==void 0&&e.dispose();const n=this.completionResult,{makeElement:s=_W}=n;e=this.completionsVirtualList=new Uu({source:{length:n.completions.length,render:r=>{const o=n.completions[r],l=s.call(n,o);return l.classList.add("neuroglancer-multiline-autocomplete-completion"),l.dataset.completionIndex=`${r}`,this.activeIndex===r&&l.classList.add(Hp),l}},selectedIndex:this.activeIndex===-1?void 0:this.activeIndex}),e.element.classList.add("neuroglancer-multiline-autocomplete-dropdown"),e.element.addEventListener("mousedown",r=>{this.inputElement.focus(),r.preventDefault()}),e.element.addEventListener("mouseup",this.handleDropdownClick.bind(this)),this.element.appendChild(e.element),this.dropdownContentsStale=!1}this.dropdownStyleStale&&this.updateDropdownStyle(),this.completionsVisible||(this.completionsVisible=!0);const{activeIndex:t}=this;t!==-1&&this.completionsVirtualList.scrollItemIntoView(t)}else this.completionsVisible&&(e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0,this.dropdownContentsStale=!0),this.completionsVisible=!1)}setCompletions(e){this.clearCompletions();const{completions:t}=e;if(t.length===0)return;const n=this.prevInputValue;if(n!==void 0){if(this.completionResult=e,t.length===1){const s=t[0];e.showSingleResult?this.hasResultForDropdown=!0:s.value.startsWith(n)?this.hasResultForDropdown=!1:this.hasResultForDropdown=!0,e.selectSingleResult?this.setActiveIndex(0):this.setHintValue(this.getCompletedValueByIndex(0))}else{this.hasResultForDropdown=!0;const s=OW(function*(){for(const o of e.completions)yield o.value}()),r=this.getCompletedValue(s);r.startsWith(n)&&(this.commonPrefix=r,this.setHintValue(r))}this.updateDropdown()}}setHintValue(e){const t=this.prevInputValue;if(t===void 0)return;(e===t||!e.startsWith(t))&&(e=""),e=e.substring(t.length);const{hintElement:n}=this;Fe(n);let s=!0;for(const r of qC(e)){s||n.appendChild(document.createElement("wbr")),s=!1;const o=document.createTextNode(r);n.appendChild(o)}}setActiveIndex(e){if(!this.dropdownContentsStale){const{activeIndex:t}=this,{completionsVirtualList:n}=this;if(n!==void 0){if(t!==-1){const s=n.getItemElement(t);s!==void 0&&s.classList.remove(Hp)}if(e!==-1){const s=n.getItemElement(e);s!==void 0&&s.classList.add(Hp),n.scrollItemIntoView(e)}}}e!==-1&&this.setHintValue(this.getCompletedValueByIndex(e)),this.activeIndex=e}getCompletedValueByIndex(e){return this.getCompletedValue(this.completionResult.completions[e].value)}getCompletedValue(e){const t=this.completionResult,n=this.prevInputValue;return n===void 0?"":n.substring(0,t.offset)+e}moveCaretToBeginningOfInput(){const e=document.createRange(),{inputElement:t}=this;e.setStart(t,0),e.setEnd(t,0);const n=window.getSelection();n!==null&&(n.removeAllRanges(),n.addRange(e),this.debouncedUpdateHintState())}moveCaretToEndOfInput(){const e=document.createRange(),{inputElement:t}=this,{childNodes:n}=t,s=n[n.length-1];s===void 0?(e.setStart(t,0),e.setEnd(t,0)):(e.setStartAfter(s),e.setEndAfter(s));const r=window.getSelection();r!==null&&(r.removeAllRanges(),r.addRange(e),this.debouncedUpdateHintState())}selectActiveCompletion(e){let{activeIndex:t}=this;if(t===-1){if(!e)return!1;const{completionResult:s}=this;if(s!==null&&s.completions.length===1)t=0;else{const{commonPrefix:r}=this;return r.length>this.value.length?(this.value=r,this.moveCaretToEndOfInput(),!0):!1}}const n=this.getCompletedValueByIndex(t);return this.value===n?!1:(this.value=n,this.moveCaretToEndOfInput(),!0)}selectCompletion(e){this.value=this.getCompletedValueByIndex(e),this.moveCaretToEndOfInput()}cancel(){return!1}cancelActiveCompletion(){this.prevInputValue=void 0;const e=this.activeCompletionCancellationToken;e!==void 0&&e.cancel(),this.activeCompletionCancellationToken=void 0,this.activeCompletionPromise=null}clearCompletions(){if(this.completionResult!==null){this.activeIndex=-1,this.completionResult=null,this.dropdownContentsStale=!0,this.dropdownStyleStale=!0,this.commonPrefix="";const{completionsVirtualList:e}=this;e!==void 0&&(e.dispose(),this.completionsVirtualList=void 0),this.updateDropdown()}}get value(){return this.inputElement.textContent||""}set value(e){e!==this.value&&(this.completionDisabled=-1,this.setValueAndSelection(e),this.debouncedUpdateHintState())}disposed(){const{completionsVirtualList:e}=this;e!==void 0&&e.dispose(),gt(this.element),this.cancelActiveCompletion(),super.disposed()}}class zW extends UW{constructor(e){const{manager:t}=e.source.layer,n=(r,o)=>t.dataSourceProviderRegistry.completeUrl({url:r,chunkManager:t.chunkManager,cancellationToken:o}).then(l=>({completions:l.completions,makeElement:VW,offset:l.offset,showSingleResult:!0}));super({completer:n,delay:0}),this.placeholder="Data source URL",this.dataSourceView=e,this.element.classList.add("neuroglancer-layer-data-source-url-input"),this.dirty=new Ne(!1);const s=r=>{r!==this.dataSourceView.source.spec.url&&(this.dirty.value=!0)};s(""),this.onInput.add(s)}cancel(){return this.value=this.dataSourceView.source.spec.url,this.dirty.value=!1,this.inputElement.blur(),!0}}class jL extends K{constructor(e){super(),this.model=e,this.element=document.createElement("ul"),this.generation=-1,this.element.classList.add("neuroglancer-layer-data-sources-source-messages");const t=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(e.changed.add(t)),this.registerDisposer(()=>gt(this.element)),this.updateView()}updateView(){const{model:e}=this,t=e.changed.count;if(t===this.generation)return;this.generation=t;const{element:n}=this;Fe(n);const s=new Set;for(const r of e){const o=`${r.severity} ${r.message}`;if(s.has(o))continue;s.add(o);const l=document.createElement("li");n.appendChild(l),l.classList.add("neuroglancer-message"),l.classList.add(`neuroglancer-message-${ws[r.severity]}`),l.textContent=r.message}}}class GW extends K{constructor(e,t){super(),this.loadedSubsource=t,this.element=document.createElement("div");const{element:n}=this;n.classList.add("neuroglancer-layer-data-source-subsource");const s=document.createElement("label"),r=document.createElement("span"),o=()=>{s.dataset.isActive=(t.activated!==void 0||!t.enabled).toString()};o(),this.registerDisposer(t.isActiveChanged.add(o)),this.registerDisposer(e.enabledSubsourcesChanged.add(o));const l=this.registerDisposer(new Es({get value(){return t.enabled},set value(b){t.enabled=b,e.enableDefaultSubsources=!1,e.enabledSubsourcesChanged.dispatch()},changed:e.enabledSubsourcesChanged}));s.classList.add("neuroglancer-layer-data-sources-info-line"),s.appendChild(l.element);const c=document.createElement("span");c.classList.add("neuroglancer-layer-data-sources-source-id");const{id:u}=t.subsourceEntry;u!=="default"&&(c.textContent=u),s.appendChild(c),r.classList.add("neuroglancer-layer-data-sources-source-type");const h=this.registerDisposer(new jL(this.loadedSubsource.messages));n.appendChild(s),s.appendChild(r),n.appendChild(h.element);let g="";const{subsource:v}=t.subsourceEntry,{volume:y}=v;if(y instanceof di)g=`${J[y.dataType].toLowerCase()} volume`;else if(v.mesh instanceof fo)g="meshes (single-res.)";else if(v.mesh instanceof Fh)g="meshes (multi-res.)";else if(v.mesh instanceof Wh)g="skeletons";else if(v.segmentPropertyMap!==void 0)g="segment property map";else if(v.local!==void 0)switch(v.local){case Ta.annotations:g="Local annotations";break;case Ta.equivalences:g="local segmentation graph";break}else v.staticAnnotations!==void 0?g="default annotations":v.annotation!==void 0?g="annotations":v.singleMesh!==void 0?g="single mesh":v.segmentationGraph!==void 0&&(g="segmentation graph");r.textContent=g}}class $W extends K{constructor(e){super(),this.source=e,this.element=document.createElement("div");const{element:t}=this,n=document.createElement("label");n.classList.add("neuroglancer-layer-data-sources-source-default"),n.appendChild(this.registerDisposer(new Es({changed:e.enabledSubsourcesChanged,get value(){return e.enableDefaultSubsources},set value(r){if(e.enableDefaultSubsources!==r){if(e.enableDefaultSubsources=r,r)for(const o of e.subsources)o.enabled=o.subsourceEntry.default;e.enabledSubsourcesChanged.dispatch()}}})).element),n.appendChild(document.createTextNode("Enable default subsource set")),n.title="Enable the default set of subsources for this data source.",t.appendChild(n);for(const r of e.subsources)t.appendChild(this.registerDisposer(new GW(e,r)).element);const{transform:s}=e;if(s.mutableSourceRank||s.value.sourceRank!==0){const r=this.registerDisposer(new NW(e.transform,e.layer.localCoordinateSpaceCombiner,e.layer.manager.root.coordinateSpaceCombiner));this.element.appendChild(r.element)}this.registerDisposer(()=>gt(this.element))}}class WW extends K{constructor(e,t){super(),this.tab=e,this.source=t,this.element=document.createElement("div"),this.seenGeneration=0,this.generation=-1;const n=this.urlInput=this.registerDisposer(new zW(this)),s=(o,l)=>{const{source:c}=this,u=c.spec,h=this.source.layer;if(o=h.manager.dataSourceProviderRegistry.normalizeUrl({url:o}),o!==n.value&&(n.disableCompletion(),n.setValueAndSelection(o,{begin:o.length,end:o.length})),n.dirty.value=!1,o&&o===u.url){l&&e.detectedLayerConstructor!==void 0&&YL(c.layer);return}if(h instanceof Cs)try{const g=h.manager.dataSourceProviderRegistry.suggestLayerName(o);jE(h.managedLayer,g)}catch{}c.spec={...u,url:o}};n.onCommit.add(s);const{element:r}=this;r.classList.add("neuroglancer-layer-data-source"),r.appendChild(n.element),r.appendChild(this.registerDisposer(new jL(t.messages)).element),this.updateView()}updateView(){const e=this.source.changed.count;if(e===this.generation)return;this.generation=e,this.urlInput.value=this.source.spec.url,this.urlInput.dirty.value=!1;const{loadState:t}=this.source;let{loadedView:n}=this;if(n!==void 0){if(n.source===t)return;n.dispose(),n=this.loadedView=void 0}t instanceof xv&&(n=this.loadedView=new $W(t),this.element.appendChild(n.element))}disposed(){const{loadedView:e}=this;e!==void 0&&e.dispose(),gt(this.element),super.disposed()}}function YL(i){if(i instanceof Cs){const e=i.detectedLayerConstructor;if(e!==void 0)return Av(i.managedLayer,e),!0}return!1}class HW extends ci{constructor(e){super(),this.layer=e,this.generation=-1,this.sourceViews=new Map,this.addDataSourceIcon=uk({title:"Add additional data source"}),this.layerTypeDetection=document.createElement("div"),this.layerTypeElement=document.createElement("span"),this.dataSourcesContainer=document.createElement("div"),this.detectedLayerConstructor=void 0;const{element:t,dataSourcesContainer:n}=this;t.classList.add("neuroglancer-layer-data-sources-tab"),n.classList.add("neuroglancer-layer-data-sources-container");const{addDataSourceIcon:s}=this;if(s.style.alignSelf="start",s.addEventListener("click",()=>{const o=this.layer.addDataSource(void 0);this.updateView();const l=this.sourceViews.get(o);l!==void 0&&l.urlInput.inputElement.focus()}),t.appendChild(this.dataSourcesContainer),e instanceof Cs){const{layerTypeDetection:o,layerTypeElement:l}=this;o.style.display="none",l.classList.add("neuroglancer-layer-data-sources-tab-type-detection-type"),o.appendChild(document.createTextNode("Create as ")),o.appendChild(l),o.appendChild(document.createTextNode(" layer")),t.appendChild(o),o.classList.add("neuroglancer-layer-data-sources-tab-type-detection"),o.addEventListener("click",()=>{YL(e)})}const r=this.reRender=et(()=>this.updateView());this.registerDisposer(e.dataSourcesChanged.add(r)),this.registerDisposer(this.visibility.changed.add(r)),this.updateView()}updateLayerTypeDetection(){const e=(()=>{const n=this.layer;if(!(n instanceof Cs))return;const s=n.detectedLayerConstructor;if(s!==void 0){for(const r of this.sourceViews.values())if(r.urlInput.dirty.value)return;return s}})();if(e===this.detectedLayerConstructor)return;const{layerTypeDetection:t}=this;if(this.detectedLayerConstructor=e,e!==void 0){const{layerTypeElement:n}=this;n.textContent=e.type,t.title=`Click here or press enter in the data source URL input box to create as ${e.type} layer`,t.style.display=""}else t.style.display="none"}disposed(){const{sourceViews:e}=this;for(const t of e.values())t.dispose();e.clear(),super.disposed()}updateView(){if(!this.visible)return;const e=this.layer.dataSourcesChanged.count;if(e!==this.generation){this.generation=e;const t=Date.now(),{sourceViews:n}=this,{layer:s}=this;function*r(){let o=!0;const{dataSources:l}=s;for(const c of l){let u=n.get(c);u===void 0&&(u=new WW(this,c),u.registerDisposer(u.urlInput.dirty.changed.add(this.reRender)),n.set(c,u)),u.seenGeneration=t,u.updateView();const h=c.spec.url;l.length===1&&h===""&&setTimeout(()=>{u.urlInput.inputElement.focus()},0),o=c.spec.url.length===0,yield u.element}o||(yield this.addDataSourceIcon)}si(this.dataSourcesContainer,r.call(this));for(const[o,l]of n)l.seenGeneration!==t&&(l.dispose(),n.delete(o))}this.updateLayerTypeDetection()}}_E.push({id:"source",label:"Source",order:-100,getter:i=>new HW(i)});const qL=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="controlsAltIconTitle">
    <title id="controlsAltIconTitle">Controls</title>
    <circle cx="9" cy="6" r="2"/>
    <path d="M4 6H7"/>
    <path d="M11 6H20"/>
    <circle cx="9" cy="18" r="2"/>
    <path d="M4 18H7"/>
    <path d="M11 18H20"/>
    <circle cx="15" cy="12" r="2"/>
    <path d="M4 12H13"/>
    <path d="M17 12L20 12"/>
</svg>`,JW=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="layersIconTitle">
    <title id="layersIconTitle">Layers</title>
    <path d="M12 4L20 8.00004L12 12L4 8.00004L12 4Z"/>
    <path d="M20 12L12 16L4 12"/>
    <path d="M20 16L12 20L4 16"/>
</svg>`,jW=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="listIconTitle">
    <title id="listIconTitle"/>
    
    <path d="M10 7L18 7M10 12L18 12M10 17L18 17"/>
    <line x1="7" y1="7" x2="7" y2="7"/>
    <line x1="7" y1="12" x2="7" y2="12"/>
    <line x1="7" y1="17" x2="7" y2="17"/>
</svg>`,YW=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="settingsIconTitle">
    <title id="settingsIconTitle">Settings</title>    
    <path d="M5.03506429,12.7050339 C5.01187484,12.4731696 5,12.2379716 5,12 C5,11.7620284 5.01187484,11.5268304 5.03506429,11.2949661 L3.20577137,9.23205081 L5.20577137,5.76794919 L7.9069713,6.32070904 C8.28729123,6.0461342 8.69629298,5.80882212 9.12862533,5.61412402 L10,3 L14,3 L14.8713747,5.61412402 C15.303707,5.80882212 15.7127088,6.0461342 16.0930287,6.32070904 L18.7942286,5.76794919 L20.7942286,9.23205081 L18.9649357,11.2949661 C18.9881252,11.5268304 19,11.7620284 19,12 C19,12.2379716 18.9881252,12.4731696 18.9649357,12.7050339 L20.7942286,14.7679492 L18.7942286,18.2320508 L16.0930287,17.679291 C15.7127088,17.9538658 15.303707,18.1911779 14.8713747,18.385876 L14,21 L10,21 L9.12862533,18.385876 C8.69629298,18.1911779 8.28729123,17.9538658 7.9069713,17.679291 L5.20577137,18.2320508 L3.20577137,14.7679492 L5.03506429,12.7050339 Z"/>
    <circle cx="12" cy="12" r="1"/>
</svg>`;/**
 * @license
 * Copyright 2016 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function jn(i,e){return t=>{t.style.flex=i,e(t)}}function Wr(i,e){return t=>{t.style.display="flex",t.style.flexDirection=i;for(const n of e){const s=t.ownerDocument.createElement("div");t.appendChild(s),n(s)}}}const qW=Ve();function KL(i,e){const t=mx(qW),{globalPosition:n,displayDimensionRenderInfo:{canonicalVoxelFactors:s,displayDimensionIndices:r}}=i;for(let o=0;o<3;++o){const l=r[o];t[12+o]=l===-1?0:n[l],t[5*o]=e/s[o]}return zt(t,i.viewProjectionMat,t),t}class rf extends K{constructor(e){super(),this.gl=e,this.vertexBuffer=this.registerDisposer(dn.fromData(e,new Float32Array([0,0,0,1,1,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,1,1]),e.ARRAY_BUFFER,e.STATIC_DRAW));const t=.5;this.colorBuffer=this.registerDisposer(dn.fromData(e,new Float32Array([1,0,0,t,1,0,0,t,0,1,0,t,0,1,0,t,0,0,1,t,0,0,1,t]),e.ARRAY_BUFFER,e.STATIC_DRAW)),this.trivialColorShader=this.registerDisposer($N(e))}static get(e){return e.memoize.get("SliceViewPanel:AxesLineHelper",()=>new rf(e))}draw(e,t=!0){const n=this.trivialColorShader,s=this.gl;n.bind(),s.uniformMatrix4fv(n.uniform("uProjectionMatrix"),!1,e);const r=n.attribute("aVertexPosition");this.vertexBuffer.bindToVertexAttrib(r,4);const o=n.attribute("aColor");this.colorBuffer.bindToVertexAttrib(o,4),t&&(s.colorMask(!1,!1,!1,!0),s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT),s.colorMask(!0,!0,!0,!0),s.enable(s.BLEND),s.blendFunc(s.ONE_MINUS_DST_ALPHA,s.DST_ALPHA)),s.lineWidth(1),s.drawArrays(s.LINES,0,6),t&&s.disable(s.BLEND),s.disableVertexAttribArray(r),s.disableVertexAttribArray(o)}}/**
 * @license
 * Copyright 2018 Google Inc.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const KW="perspective_view/PerspectiveView";class XL{constructor(){this.renderLayers=[null],this.pickData=[null],this.values=[0,0,0],this.nextPickID=1}clear(){this.renderLayers.length=1,this.pickData.length=1,this.values.length=3,this.nextPickID=1}registerUint64(e,t,n=1,s=null){return this.register(e,n,t.low,t.high,s)}register(e,t=1,n=0,s=0,r=null){const{renderLayers:o,values:l}=this,c=this.nextPickID;this.nextPickID+=t;const u=o.length;o[u]=e;const h=u*3;return l[h]=c,l[h+1]=n,l[h+2]=s,this.pickData[u]=r,c}setMouseState(e,t){const{renderLayers:n,values:s}=this;let r=0,o=n.length-1;for(;r<o;){const v=Math.ceil(r+(o-r)/2);s[v*3]>t?o=v-1:r=v}const l=e.pickedRenderLayer=n[r],c=r*3,u=e.pickedOffset=t-s[c],{pickedValue:h}=e;h.low=s[c+1],h.high=s[c+2],e.pickedAnnotationId=void 0,e.pickedAnnotationLayer=void 0,e.pickedAnnotationBuffer=void 0,e.pickedAnnotationBufferBaseOffset=void 0,e.pickedAnnotationIndex=void 0,e.pickedAnnotationCount=void 0,e.pickedAnnotationType=void 0;const g=this.pickData[r];l!==null&&l.updateMouseState(e,h,u,g)}}const KC=10,XW=1e3,QW=400,ZW=500,eH=Math.PI/20,tH=20,nH=10;function QL(i,e){return Math.sqrt(i*i+e*e)}function XC(i){let[e,t]=i;e.identifier>t.identifier&&([t,e]=[e,t]);const n=e.clientX-t.clientX,s=e.clientY-t.clientY,r=QL(n,s),o=Math.atan2(n,s);return{distance:r,angle:o}}function iH(i,e){const t=Math.PI*2,n=Math.abs(i-e)%t;return Math.min(n,t-n)}class sH extends K{constructor(e,t){super(),this.target=e,this.eventMap=t,this.prevTouches=new Map,this.moved=!1,this.prevAngle=0,this.rotated=!1,this.prevDistance=0,this.pinched=!1,this.prevCenterX=0,this.prevCenterY=0,this.translated=!1,this.startHold=this.registerCancellable(oh((n,s,r,o)=>{const l={event:n,centerX:r,centerY:o};this.dispatch(`touchhold${n.targetTouches.length}`,n,l,s)},XW,{leading:!1,trailing:!0})),this.numPriorTaps=0,this.priorTapNumTouches=0,this.tapStartTime=0,this.tapEndTime=0,this.curTapNumTouches=0,this.registerEventListener(e,"touchstart",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchmove",n=>{this.handleTouchEvent(n)}),this.registerEventListener(e,"touchend",n=>{this.handleTouchEvent(n)})}dispatch(e,t,n,s=t.eventPhase){IE(e,t,s,n,this.eventMap)}handleTouchEvent(e){if(e.target===this.target)e.preventDefault();else return;const t=new Map,{prevTouches:n,prevEvent:s}=this;let r=0,o=0;for(const v of e.targetTouches)t.set(v.identifier,v),r+=v.clientX,o+=v.clientY;r/=t.size,o/=t.size;for(const[v,y]of n.entries()){const b=t.get(v);if(b===void 0)n.delete(v);else{const w=b.clientX-y.clientX,C=b.clientY-y.clientY;(Math.abs(w)>=KC||Math.abs(C)>=KC)&&(this.moved=!0)}}if(s===void 0||s.targetTouches.length!==t.size||t.size===0){if(this.moved=!1,e.type==="touchstart")this.startHold(e,e.eventPhase,r,o),(s===void 0||s.targetTouches.length===0)&&(this.tapStartTime=Date.now(),this.curTapNumTouches=0),this.curTapNumTouches=Math.max(this.curTapNumTouches,e.targetTouches.length);else{if(e.type==="touchend"){const v=Date.now();if(e.targetTouches.length===0&&v-this.tapStartTime<QW){(this.curTapNumTouches!==this.priorTapNumTouches||v-this.tapEndTime>=ZW)&&(this.numPriorTaps=0),++this.numPriorTaps,this.tapEndTime=v,this.priorTapNumTouches=this.curTapNumTouches;const y={event:e,centerX:r,centerY:o};this.dispatch(`touchtap${this.curTapNumTouches}x${this.numPriorTaps}`,e,y)}}this.startHold.cancel()}if(this.prevTouches=t,this.prevEvent=e,this.prevCenterX=r,this.prevCenterY=o,this.translated=!1,t.size===2){const{distance:v,angle:y}=XC(t.values());this.prevDistance=v,this.prevAngle=y,this.rotated=!1,this.pinched=!1}return}if(!this.moved)return;this.tapStartTime=0,this.startHold.cancel(),this.prevTouches=t,this.prevEvent=e;let{prevCenterX:l,prevCenterY:c,translated:u}=this;const h=r-l,g=o-c;if(u===!1&&QL(h,g)>=nH&&(u=this.translated=!0),u===!0&&(h!==0||g!==0)){this.prevCenterX=r,this.prevCenterY=o;const v={event:e,deltaX:h,deltaY:g,centerX:r,centerY:o};this.dispatch(`touchtranslate${t.size}`,e,v)}if(t.size===2){const{distance:v,angle:y}=XC(t.values());let{pinched:b,rotated:w,prevDistance:C,prevAngle:E}=this;b===!1&&Math.abs(v-C)>=tH&&(this.pinched=b=!0);const k=iH(y,E);if(w===!1&&k>=eH&&(this.rotated=w=!0),b===!0&&v!==C){this.prevDistance=v;const D={event:e,distance:v,prevDistance:C,centerX:r,centerY:o};this.dispatch("touchpinch",e,D)}w===!0&&y!==E&&(this.prevAngle=y,this.dispatch("touchrotate",e,{event:e,centerX:r,centerY:o,angle:y,prevAngle:E}))}}}const Jp=we();class QC{constructor(){this.pickIDs=new XL,this.viewportWidth=0,this.viewportHeight=0,this.invTransform=Ve(),this.frameNumber=-1}}class ZC{constructor(){this.buffer=null,this.glWindowX=0,this.glWindowY=0}}const rH=30,Wt=5,Ke=1+Wt*2,Ku=(()=>{const i=Wt**2,e=(s,r)=>(s-Wt)**2+(r-Wt)**2;let t=new Uint32Array(Ke*Ke),n=0;for(let s=0;s<Ke;++s)for(let r=0;r<Ke;++r)e(s,r)>i||(t[n++]=r*Ke+s);return t=t.subarray(0,n),t.sort((s,r)=>{const o=s%Ke,l=(s-o)/Ke,c=r%Ke,u=(r-c)/Ke;return e(o,l)-e(c,u)}),t})();function ZL(i,e,t,n,s,r,o){const l=n-Wt,c=s-Wt;if(!(l>=0&&c>=0&&l+Ke<=r&&c+Ke<=o))for(let u=0;u<Ke;++u)for(let h=0;h<Ke;++h){const g=l+h,v=c+u;(g<0||v<0||g>=r||v>=o)&&(i[e+(v*Ke+g)*t]=0)}}class eD extends g1{constructor(e,t,n){super(e,t,n.visibility),this.viewer=n,this.mouseX=-1,this.mouseY=-1,this.pickRequestPending=!1,this.mouseStateForcer=()=>this.blockOnPickRequest(),this.pickingData=[new QC,new QC],this.pickRequests=[new ZC,new ZC],this.pickBufferContents=new Float32Array(2*4*Ke*Ke),this.pickTimerId=-1,this.nextPickRequestTime=0,this.pendingPickRequestTimerId=-1,this.pendingPickRequestTimerExpired=()=>{this.pendingPickRequestTimerId=-1,this.pickRequestPending&&this.attemptToIssuePickRequest()},this.inputEventMap=n.inputEventMap,t.classList.add("neuroglancer-rendered-data-panel"),t.classList.add("neuroglancer-panel"),t.classList.add("neuroglancer-noselect"),typeof NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP<"u"&&NEUROGLANCER_SHOW_OBJECT_SELECTION_TOOLTIP===!0&&(t.title="Double click to toggle display of object under mouse pointer.  Control+rightclick to pin/unpin selection."),this.registerDisposer(new Jh(t)),this.registerDisposer(new Pi(t,this.inputEventMap)),this.registerDisposer(new ji(t,this.inputEventMap,s=>{this.onMousemove(s)})),this.registerDisposer(new sH(t,this.inputEventMap)),this.registerEventListener(t,"mousemove",this.onMousemove.bind(this)),this.registerEventListener(t,"touchstart",this.onTouchstart.bind(this)),this.registerEventListener(t,"mouseleave",()=>this.onMouseout()),this.registerEventListener(t,"mouseover",s=>{s.target!==t&&this.onMouseout()},!0),fe(t,"select-position",()=>{this.viewer.selectionDetailsState.select()}),fe(t,"snap",()=>{this.navigationState.pose.snap()}),fe(t,"zoom-in",()=>{this.navigationState.zoomBy(.5)}),fe(t,"zoom-out",()=>{this.navigationState.zoomBy(2)}),fe(t,"depth-range-decrease",()=>{this.navigationState.depthRange.value*=.5}),fe(t,"depth-range-increase",()=>{this.navigationState.depthRange.value*=2});for(let s=0;s<3;++s){const r=LA[s];for(const o of[-1,1]){const l=o<0?"-":"+";fe(t,`rotate-relative-${r}${l}`,()=>{this.navigationState.pose.rotateRelative(Ui[s],o*.1)});const c=we();fe(t,`${r}${l}`,()=>{const{navigationState:u}=this,h=c;h[0]=0,h[1]=0,h[2]=0,h[s]=o,u.pose.translateVoxelsRelative(h)})}}fe(t,"zoom-via-wheel",s=>{const r=s.detail;this.onMousemove(r,!1),this.zoomByMouse(Ia(r))}),fe(t,"adjust-depth-range-via-wheel",s=>{const r=s.detail;this.navigationState.depthRange.value*=Ia(r)}),fe(t,"translate-via-mouse-drag",s=>{oi(s.detail,(r,o,l)=>{this.translateByViewportPixels(o,l)})}),fe(t,"translate-in-plane-via-touchtranslate",s=>{const{detail:r}=s;this.translateByViewportPixels(r.deltaX,r.deltaY)}),fe(t,"translate-z-via-touchtranslate",s=>{const{detail:r}=s,{navigationState:o}=this,l=Jp;l[0]=0,l[1]=0,l[2]=r.deltaY+r.deltaX,o.pose.translateVoxelsRelative(l)});for(const s of[1,10])fe(t,`z+${s}-via-wheel`,r=>{const o=r.detail,{navigationState:l}=this,c=Jp,u=o.deltaY!==0?o.deltaY:o.deltaX;c[0]=0,c[1]=0,c[2]=(u>0?-1:1)*s,l.pose.translateVoxelsRelative(c)});fe(t,"move-to-mouse-position",()=>{const{mouseState:s}=this.viewer;s.updateUnconditionally()&&(this.navigationState.position.value=s.position)}),fe(t,"snap",()=>this.navigationState.pose.snap()),fe(t,"move-annotation",s=>{const{mouseState:r}=this.viewer,o=r.pickedAnnotationId,l=r.pickedAnnotationLayer;if(l!==void 0&&o!==void 0){s.stopPropagation();const c=l.source.getReference(o),u=c.value,h=Bl(u.type),g=r.pickedOffset,{chunkTransform:{value:v}}=l;if(v.error!==void 0)return;const{layerRank:y}=v,b=new Float32Array(y);h.getRepresentativePoint(b,u,r.pickedOffset);const w=TA(Wm(),0,0);r.updateUnconditionally()&&oi(s.detail,(C,E,k)=>{kA(w,w,[E,k]);const D=new Float32Array(y);ps(D,v.chunkToLayerTransform,y+1,b,y);const A=Jp,{displayDimensionIndices:N}=this.navigationState.pose.displayDimensions.value;tN(A,D,v.modelTransform,N),this.translateDataPointByViewportPixels(A,A,w[0],w[1]),nN(D,A,v.modelTransform,N);const I=new Float32Array(y);ps(I,v.layerToChunkTransform,y+1,D,y);const P=h.updateViaRepresentativePoint(u,I,g);l.source.update(c,P)},C=>{l.source.commit(c),c.dispose()})}}),fe(t,"delete-annotation",()=>{const{mouseState:s}=this.viewer,r=s.pickedAnnotationId,o=s.pickedAnnotationLayer;if(o!==void 0&&!o.source.readonly&&r!==void 0){const l=o.source.getReference(r);try{o.source.delete(l)}finally{l.dispose()}}}),fe(t,"zoom-via-touchpinch",s=>{const{detail:r}=s;this.handleMouseMove(r.centerX,r.centerY);const o=r.prevDistance/r.distance;o>.1&&o<10&&this.zoomByMouse(o)})}cancelPickRequests(){const{gl:e}=this;for(const t of this.pickRequests){const{sync:n}=t;n!==null&&e.deleteSync(n),t.sync=null}clearTimeout(this.pickTimerId),this.pickTimerId=-1}issuePickRequestInternal(e){const{gl:t}=this;let{buffer:n}=e;n===null?(n=e.buffer=t.createBuffer(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n),t.bufferData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,2*4*4*Ke*Ke,WebGL2RenderingContext.STREAM_READ)):t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,n);const{renderViewport:s}=this,r=this.mouseX-s.visibleLeftFraction*s.logicalWidth,o=s.height-(this.mouseY-s.visibleTopFraction*s.logicalHeight);this.issuePickRequest(r,o),e.sync=t.fenceSync(WebGL2RenderingContext.SYNC_GPU_COMMANDS_COMPLETE,0),e.frameNumber=this.context.frameNumber,e.glWindowX=r,e.glWindowY=o,t.flush(),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null),this.pickTimerId===-1&&this.scheduleCheckForPickRequestCompletion(),this.pickRequestPending=!1;const{pickRequests:l}=this;e!==l[0]&&(l[1]=l[0],l[0]=e),this.nextPickRequestTime=Date.now()+rH}completePickInternal(e){const{gl:t}=this,{pickBufferContents:n}=this;t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,e.buffer),t.getBufferSubData(WebGL2RenderingContext.PIXEL_PACK_BUFFER,0,n),t.bindBuffer(WebGL2RenderingContext.PIXEL_PACK_BUFFER,null);const{pickingData:s}=this,{frameNumber:r}=e;this.completePickRequest(e.glWindowX,e.glWindowY,n,s[0].frameNumber===r?s[0]:s[1])}scheduleCheckForPickRequestCompletion(){this.pickTimerId=window.setTimeout(()=>{this.pickTimerId=-1,this.checkForPickRequestCompletion()},0)}checkForPickRequestCompletion(e=!1,t=!1){let n=this.context.frameNumber,s=-1;e&&(--n,s=n-1);const{pickRequests:r}=this,{gl:o}=this;let l=!1,c=!1,u;for(const g of r){const{sync:v}=g;if(v===null)continue;const{frameNumber:y}=g;if(!c&&y>=n-1){if(t||o.getSyncParameter(v,WebGL2RenderingContext.SYNC_STATUS)===WebGL2RenderingContext.SIGNALED)this.completePickInternal(g),c=!0;else if(y!==s){l=!0;continue}}o.deleteSync(v),g.sync=null,u=g}const{pickTimerId:h}=this;l&&h===-1?this.scheduleCheckForPickRequestCompletion():!l&&h!==-1&&(window.clearTimeout(h),this.pickTimerId=-1),!e&&u!==void 0&&this.pickRequestPending&&this.canIssuePickRequest()&&this.issuePickRequestInternal(u)}blockOnPickRequest(){this.pickRequestPending&&(this.cancelPickRequests(),this.nextPickRequestTime=0,this.attemptToIssuePickRequest()),this.checkForPickRequestCompletion(!1,!0)}draw(){const{width:e,height:t}=this.renderViewport;this.checkForPickRequestCompletion(!0);const{pickingData:n}=this;n[0]=n[1];const s=this.context.frameNumber,r=n[1];if(r.frameNumber=s,r.viewportWidth=e,r.viewportHeight=t,r.pickIDs.clear(),!this.drawWithPicking(r)){r.frameNumber=-1;return}this.nextPickRequestTime=0,this.mouseX>=0&&this.attemptToIssuePickRequest()}canIssuePickRequest(){const e=Date.now(),{nextPickRequestTime:t,pendingPickRequestTimerId:n}=this;return e<t?(n===-1&&(this.pendingPickRequestTimerId=window.setTimeout(this.pendingPickRequestTimerExpired,t-e)),!1):!0}attemptToIssuePickRequest(){if(!this.canIssuePickRequest())return;const e=this.context.frameNumber,{gl:t}=this,{pickRequests:n}=this;for(const s of n){const{sync:r}=s;if(r!==null)if(s.frameNumber<e-1)t.deleteSync(r);else continue;this.issuePickRequestInternal(s);return}}updateMousePosition(e,t){if(e===this.mouseX&&t===this.mouseY)return;if(this.mouseX=e,this.mouseY=t,e<0){this.pickRequestPending=!1,this.cancelPickRequests();return}const n=this.context.frameNumber,s=this.pickingData[1];s.frameNumber!==n||this.renderViewport.width!==s.viewportWidth||this.renderViewport.height!==s.viewportHeight||(this.pickRequestPending=!0,this.attemptToIssuePickRequest())}onMouseout(){this.updateMousePosition(-1,-1),this.viewer.mouseState.setForcer(void 0)}handleMouseMove(e,t){const{element:n}=this,s=n.getBoundingClientRect(),r=e-(s.left+n.clientLeft),o=t-(s.top+n.clientTop),{mouseState:l}=this.viewer;l.pageX=e+window.scrollX,l.pageY=t+window.scrollY,l.setForcer(this.mouseStateForcer),this.updateMousePosition(r,o)}onMousemove(e,t=!0){const{element:n}=this;t&&e.target!==n||this.handleMouseMove(e.clientX,e.clientY)}onTouchstart(e){const{element:t}=this;if(e.target!==t||e.targetTouches.length!==1)return;const{clientX:n,clientY:s}=e.targetTouches[0];this.handleMouseMove(n,s)}disposed(){const{mouseState:e}=this.viewer;e.removeForcer(this.mouseStateForcer);const{gl:t}=this;this.cancelPickRequests();const{pendingPickRequestTimerId:n}=this;n!==-1&&window.clearTimeout(n);for(const s of this.pickRequests)t.deleteBuffer(s.buffer);super.disposed()}}const oH=[1.5,2,3,5,7.5,10];class aH{constructor(){this.allowedSignificands=oH,this.targetLengthInPixels=0,this.physicalSizePerPixel=0,this.prevPhysicalSizePerPixel=0,this.prevTargetLengthInPixels=0,this.prevPhysicalUnit="\0"}update(){const{physicalSizePerPixel:e,targetLengthInPixels:t}=this;if(this.prevPhysicalSizePerPixel===e&&this.prevTargetLengthInPixels===t&&this.prevPhysicalUnit===this.physicalUnit)return!1;this.prevPhysicalSizePerPixel=e,this.prevTargetLengthInPixels=t,this.prevPhysicalUnit=this.physicalUnit;const n=t*e,s=Math.floor(Math.log10(n)),r=10**s,o=n/r;let l=1;for(const h of this.allowedSignificands)if(Math.abs(h-o)<Math.abs(l-o))l=h;else break;const c=l*r,u=$x(c);return this.lengthInPixels=Math.round(c/e),this.physicalUnit=`${u.prefix}${this.physicalBaseUnit}`,this.physicalLength=l*10**(s-u.exponent),!0}}function lH(i,e,t,n,s){const r=document.createElement("canvas"),o=r.getContext("2d"),l=s.textHeightInPixels*s.scaleFactor,c=`bold ${l}px ${s.fontName}`;o.font=c,o.fillStyle="white";const u=`${n}${i.physicalLength} ${i.physicalUnit}`,h=o.measureText(u),g=Math.max(i.lengthInPixels,h.width),v=s.barHeightInPixels*s.scaleFactor,y=s.barTopMarginInPixels*s.scaleFactor,b=v+y+l,w=s.paddingInPixels*s.scaleFactor,C=b+2*w,E=g+2*w;return r.width=E,r.height=C,o.font=c,o.textAlign="center",o.fillStyle="rgba(0, 0, 0, 0.3)",o.fillRect(0,0,E,C),o.fillStyle="white",o.fillText(u,E/2,C-w-v-y),o.fillRect(w,C-w-v,i.lengthInPixels,v),zN(e,t,r),{width:E,height:C}}class cH extends K{constructor(e,t=new aH){super(),this.gl=e,this.dimensions=t,this.texture=null,this.width=0,this.height=0,this.label="",this.factor=1,this.priorOptions=void 0,this.prevLabel=""}update(e){const{dimensions:t,label:n}=this;let{texture:s}=this;if(!t.update()&&s!==null&&e===this.priorOptions&&n===this.prevLabel)return;s===null&&(s=this.texture=this.gl.createTexture());const{width:r,height:o}=lH(t,this.gl,s,n,e);this.priorOptions=e,this.prevLabel=n,this.width=r,this.height=o}disposed(){this.gl.deleteTexture(this.texture),this.texture=null,super.disposed()}}class tD extends K{constructor(e){super(),this.gl=e,this.scaleBarCopyHelper=this.registerDisposer(Sa.get(this.gl)),this.scaleBars=[];for(let t=0;t<3;++t)this.scaleBars.push(this.registerDisposer(new cH(e)))}draw(e,t,n,s,r){const{scaleBars:o}=this,{displayRank:l,displayDimensionIndices:c,canonicalVoxelFactors:u,globalDimensionNames:h,displayDimensionUnits:g,displayDimensionScales:v}=t,{factors:y}=n,b=Math.min(r.maxWidthFraction*e.logicalWidth,r.maxWidthInPixels*r.scaleFactor);let w=0;for(let D=0;D<l;++D){const A=c[D],N=g[D],I=y[A];let P,O,_;for(P=0;P<w&&(O=o[P],_=O.dimensions,!(_.physicalBaseUnit===N&&O.factor===I));++P);P===w&&(++w,O=o[P],O.label="",_=O.dimensions,O.factor=I,_.physicalBaseUnit=N,_.targetLengthInPixels=b,_.physicalSizePerPixel=v[D]*s/u[D]),O.label+=`${h[A]} `}const{gl:C,scaleBarCopyHelper:E}=this;let k=r.bottomPixelOffset*r.scaleFactor;for(let D=w-1;D>=0;--D){const A=o[D];w===1?A.label="":A.label+=": ",A.update(r),C.viewport(r.leftPixelOffset*r.scaleFactor-e.visibleLeftFraction*e.logicalWidth,k-(1-(e.visibleTopFraction+e.visibleHeightFraction))*e.logicalHeight,A.width,A.height),E.draw(A.texture),k+=A.height+r.marginPixelsBetweenScaleBars*r.scaleFactor}}}const dH={scaleFactor:1,textHeightInPixels:15,barHeightInPixels:8,barTopMarginInPixels:5,fontName:"sans-serif",paddingInPixels:2},nD={...dH,maxWidthInPixels:100,maxWidthFraction:.25,leftPixelOffset:10,bottomPixelOffset:10,marginPixelsBetweenScaleBars:5};function uH(i){const e={...nD};for(const t of["textHeightInPixels","barTopMarginInPixels","barHeightInPixels","paddingInPixels","scaleFactor","maxWidthInPixels","maxWidthFraction","leftPixelOffset","bottomPixelOffset"])z(i,t,n=>{n!==void 0&&(e[t]=xn(n))});return z(i,"fontName",t=>{t!==void 0&&(e.fontName=ie(t))}),e}class hH extends bt{constructor(){super(nD,uH)}}const fH=`
void emit(vec4 color, highp uint pickId) {
  out_color = color;
  float zValue = 1.0 - gl_FragCoord.z;
  out_z = vec4(zValue, zValue, zValue, 1.0);
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`,pH=`
float computeOITWeight(float alpha, float depth) {
  float a = min(1.0, alpha) * 8.0 + 0.01;
  float b = -depth * 0.95 + 1.0;
  return a * a * a * b * b * b;
}
`,gH=[pH,`
void emitAccumAndRevealage(vec4 accum, float revealage, highp uint pickId) {
  v4f_fragData0 = vec4(accum.rgb, revealage);
  v4f_fragData1 = vec4(accum.a, 0.0, 0.0, 0.0);
}
void emit(vec4 color, highp uint pickId) {
  float weight = computeOITWeight(color.a, gl_FragCoord.z);
  vec4 accum = color * weight;
  emitAccumAndRevealage(accum, color.a, pickId);
}
`];function jp(i){i.addOutputBuffer("vec4","out_color",0),i.addOutputBuffer("highp vec4","out_z",1),i.addOutputBuffer("highp vec4","out_pickId",2),i.addFragmentCode(fH)}function mH(i){i.addOutputBuffer("vec4","v4f_fragData0",0),i.addOutputBuffer("vec4","v4f_fragData1",1),i.addFragmentCode(gH)}const os=we(),ex=lh(),vH=Ve();function yH(i){i.addOutputBuffer("vec4","v4f_fragColor",null),i.setFragmentMain(`
vec4 v0 = getValue0();
vec4 v1 = getValue1();
vec4 accum = vec4(v0.rgb, v1.r);
float revealage = v0.a;

v4f_fragColor = vec4(accum.rgb / accum.a, revealage);
`)}const SH=Ac(Ii);class bH extends SH{constructor(e){super(),this.panel=e}initializeCounterpart(e,t){this.sharedProjectionParameters=this.registerDisposer(new yu(e,this.panel.projectionParameters)),t.projectionParameters=this.sharedProjectionParameters.rpcId,super.initializeCounterpart(e,t)}}class Ty extends eD{constructor(e,t,n){super(e,t,n),this.sliceViews=this.registerDisposer(new cv((r,o,l)=>{r.registerDisposer(l),r.registerDisposer(l.visibility.add(this.visibility))})),this.axesLineHelper=this.registerDisposer(rf.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(rE.get(this.gl,jp)),this.offscreenFramebuffer=this.registerDisposer(new ya(this.gl,{colorBuffers:[new Hr(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Hr(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT),new Hr(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)],depthBuffer:new JN(this.gl)})),this.offscreenCopyHelper=this.registerDisposer(Sa.get(this.gl)),this.transparencyCopyHelper=this.registerDisposer(Sa.get(this.gl,yH,2)),this.scaleBars=this.registerDisposer(new tD(this.gl)),this.projectionParameters=this.registerDisposer(new L1({navigationState:this.navigationState,update:(r,o)=>{const{invViewMatrix:l,projectionMat:c,logicalWidth:u,logicalHeight:h}=r,g=u/h,v=Math.PI/4;let{relativeDepthRange:y}=o,w=o.zoomFactor.value/2;if(this.viewer.orthographicProjection.value){const C=Math.max(.1,1-y),E=1+y;vx(c,-g,g,-1,1,C,E)}else{const C=1/Math.tan(v/2);y/=C;const E=Math.max(.1,1-y),k=1+y;w*=C,uA(c,v,g,E,k)}f1(r,c),o.pose.toMat4(l,w),lA(l,l,Zp(os,1,-1,-1)),aA(l,l,Ui[2]),y1(r)}})),this.projectionParameters.changed.add(()=>this.context.scheduleRedraw());const s=this.sharedObject=this.registerDisposer(new bH(this));if(s.RPC_TYPE_ID=KW,s.initializeCounterpart(n.rpc,{}),s.visibility.add(this.visibility),this.visibleLayerTracker=BE(this.viewer.layerManager,co,this.viewer.visibleLayerRoles,this),fe(t,"rotate-via-mouse-drag",r=>{oi(r.detail,(o,l,c)=>{this.navigationState.pose.rotateRelative(Ui[1],l/4*Math.PI/180),this.navigationState.pose.rotateRelative(Ui[0],-c/4*Math.PI/180)})}),fe(t,"rotate-in-plane-via-touchrotate",r=>{const{detail:o}=r;this.navigationState.pose.rotateRelative(Ui[2],o.angle-o.prevAngle)}),fe(t,"rotate-out-of-plane-via-touchtranslate",r=>{const{detail:o}=r;this.navigationState.pose.rotateRelative(Ui[1],o.deltaX/4*Math.PI/180),this.navigationState.pose.rotateRelative(Ui[0],-o.deltaY/4*Math.PI/180)}),n.showSliceViewsCheckbox){const r=this.registerDisposer(new Es(n.showSliceViews));r.element.className="perspective-panel-show-slice-views neuroglancer-noselect";const o=document.createElement("label");o.className="perspective-panel-show-slice-views neuroglancer-noselect",o.appendChild(document.createTextNode("Sections")),o.appendChild(r.element),this.element.appendChild(o)}this.registerDisposer(n.orthographicProjection.changed.add(()=>{this.projectionParameters.update(),this.scheduleRedraw()})),this.registerDisposer(n.showScaleBar.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.scaleBarOptions.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showSliceViews.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.showAxisLines.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.perspectiveViewBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.wireFrame.changed.add(()=>this.scheduleRedraw())),this.sliceViews.changed.add(()=>this.scheduleRedraw())}get rpc(){return this.sharedObject.rpc}get rpcId(){return this.sharedObject.rpcId}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}flushBackendProjectionParameters(){this.sharedObject.sharedProjectionParameters.flush()}translateByViewportPixels(e,t){const n=os,{viewProjectionMat:s,invViewProjectionMat:r,logicalWidth:o,logicalHeight:l}=this.projectionParameters.value,{pose:c}=this.viewer.navigationState;c.updateDisplayPosition(u=>{qn(n,u,s),n[0]+=-2*e/o,n[1]+=2*t/l,qn(u,n,r)})}get navigationState(){return this.viewer.navigationState}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.projectionParameters.setViewport(this.renderViewport)}isReady(){if(!this.visible)return!0;for(const[o,l]of this.sliceViews)if((l||this.viewer.showSliceViews.value)&&!o.isReady())return!1;this.ensureBoundsUpdated();const{width:e,height:t}=this.renderViewport;if(e===0||t===0)return!0;const s={projectionParameters:this.projectionParameters.value},{visibleLayers:r}=this.visibleLayerTracker;for(const[o,l]of r)if(!o.isReady(s,l))return!1;return!0}disposed(){this.sliceViews.clear(),super.disposed()}getDepthArray(){if(!this.navigationState.valid)return;const{offscreenFramebuffer:e,renderViewport:{width:t,height:n}}=this,s=t*n,r=new Float32Array(s*4);try{e.bindSingle(1),this.gl.readPixels(0,0,t,n,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.FLOAT,r)}finally{e.framebuffer.unbind()}const o=new Float32Array(s);for(let l=0;l<s;++l)o[l]=r[l*4];return o}issuePickRequest(e,t){const{offscreenFramebuffer:n}=this;n.readPixelFloat32IntoBuffer(1,e-Wt,t-Wt,0,Ke,Ke),n.readPixelFloat32IntoBuffer(2,e-Wt,t-Wt,4*4*Ke*Ke,Ke,Ke)}completePickRequest(e,t,n,s){const{mouseState:r}=this.viewer;r.pickedRenderLayer=null,ZL(n,0,4,e,t,s.viewportWidth,s.viewportHeight);const o=Ku.length;for(let l=0;l<o;++l){const c=Ku[l],u=n[4*c];if(u===0)continue;const h=c%Ke,g=(c-h)/Ke,v=1-u;os[0]=2*(e+h-Wt)/s.viewportWidth-1,os[1]=2*(t+g-Wt)/s.viewportHeight-1,os[2]=2*v-1,qn(os,os,s.invTransform);let{position:y,unsnappedPosition:b}=r;const{value:w}=this.navigationState.position,C=w.length;y.length!==C&&(y=r.position=new Float32Array(C)),b.length!==C&&(b=r.unsnappedPosition=new Float32Array(C)),y.set(w),r.coordinateSpace=this.navigationState.coordinateSpace.value;const E=this.navigationState.pose.displayDimensions.value,{displayDimensionIndices:k}=E;for(let A=0,N=k.length;A<N;++A)y[k[A]]=os[A];b.set(y);const D=n[4*Ke*Ke+4*c];s.pickIDs.setMouseState(r,D),r.displayDimensions=E,r.setActive(!0);return}r.setActive(!1)}translateDataPointByViewportPixels(e,t,n,s){const r=os,{viewProjectionMat:o,invViewProjectionMat:l,width:c,height:u}=this.projectionParameters.value;return qn(r,t,o),r[0]+=2*n/c,r[1]+=-2*s/u,qn(e,r,l)}get transparentConfiguration(){let e=this.transparentConfiguration_;return e===void 0&&(e=this.transparentConfiguration_=this.registerDisposer(new ya(this.gl,{colorBuffers:Su(this.gl,2,this.gl.RGBA32F,this.gl.RGBA,this.gl.FLOAT),depthBuffer:this.offscreenFramebuffer.depthBuffer.addRef()}))),e}drawWithPicking(e){if(!this.navigationState.valid)return!1;const{width:t,height:n}=this.renderViewport,s=this.viewer.showSliceViews.value;for(const[E,k]of this.sliceViews)(k||s)&&E.updateRendering();const r=this.gl,o=()=>{r.drawBuffers(this.offscreenFramebuffer.singleAttachmentList)},l=()=>{this.offscreenFramebuffer.bind(t,n)};l(),r.disable(r.SCISSOR_TEST),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.stencilMask(4294967295),r.clearStencil(0),r.clear(WebGL2RenderingContext.STENCIL_BUFFER_BIT),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilFunc(WebGL2RenderingContext.ALWAYS,1,1);const c=this.viewer.perspectiveViewBackgroundColor.value;this.gl.clearColor(c[0],c[1],c[2],0),r.clear(r.DEPTH_BUFFER_BIT),r.clearBufferfv(WebGL2RenderingContext.COLOR,0,[c[0],c[1],c[2],0]),r.clearBufferfv(WebGL2RenderingContext.COLOR,1,ng),r.clearBufferfv(WebGL2RenderingContext.COLOR,2,ng),r.enable(r.DEPTH_TEST);const u=this.projectionParameters.value,h=we();ta(h,Ui[2],this.navigationState.pose.orientation.orientation),ah(h,h,-1);const g=.2,v=1-g,y={wireFrame:this.viewer.wireFrame.value,projectionParameters:u,lightDirection:h,ambientLighting:g,directionalLighting:v,pickIDs:e.pickIDs,emitter:jp,emitColor:!0,emitPickID:!0,alreadyEmittedPickID:!1,bindFramebuffer:l,frameNumber:this.context.frameNumber};ru(e.invTransform,u.invViewProjectionMat);const{visibleLayers:b}=this.visibleLayerTracker;let w=!1,C=!1;for(const[E,k]of b)E.isTransparent?w=!0:E.isAnnotation?C=!0:E.draw(y,k);if(this.drawSliceViews(y),C){r.enable(WebGL2RenderingContext.BLEND),r.depthFunc(WebGL2RenderingContext.LEQUAL),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);for(const[E,k]of b)if(E.isAnnotation){const D=E;D.base.state.displayState.disablePicking.value?(o(),D.draw(y,k),y.bindFramebuffer()):D.draw(y,k)}r.depthFunc(WebGL2RenderingContext.LESS),r.disable(WebGL2RenderingContext.BLEND)}if(this.viewer.showAxisLines.value&&this.drawAxisLines(),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),w){r.depthMask(!1),r.enable(WebGL2RenderingContext.BLEND);const{transparentConfiguration:E}=this;y.bindFramebuffer=()=>{E.bind(t,n)},y.bindFramebuffer(),this.gl.clearColor(0,0,0,1),r.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT),y.emitter=mH,r.blendFuncSeparate(WebGL2RenderingContext.ONE,WebGL2RenderingContext.ONE,WebGL2RenderingContext.ZERO,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),y.emitPickID=!1;for(const[k,D]of b)k.isTransparent&&(y.depthBufferTexture=this.offscreenFramebuffer.colorBuffers[1].texture,k.draw(y,D));r.disable(WebGL2RenderingContext.DEPTH_TEST),this.offscreenFramebuffer.bindSingle(0),r.blendFunc(WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA,WebGL2RenderingContext.SRC_ALPHA),this.transparencyCopyHelper.draw(E.colorBuffers[0].texture,E.colorBuffers[1].texture),r.depthMask(!0),r.disable(WebGL2RenderingContext.BLEND),r.enable(WebGL2RenderingContext.DEPTH_TEST),y.bindFramebuffer=l,l(),r.enable(WebGL2RenderingContext.STENCIL_TEST),r.drawBuffers([r.NONE,r.COLOR_ATTACHMENT1,r.COLOR_ATTACHMENT2]),y.emitter=jp,y.emitPickID=!0,y.emitColor=!1,r.stencilFunc(WebGL2RenderingContext.NOTEQUAL,3,1),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.REPLACE),r.stencilMask(2);for(const[k,D]of b)!k.isTransparent||!k.transparentPickEnabled||k.draw(y,D);r.stencilFunc(WebGL2RenderingContext.EQUAL,0,3),r.stencilOp(WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP,WebGL2RenderingContext.KEEP),r.stencilMask(0);for(const[k,D]of b)!k.isTransparent||k.transparentPickEnabled||k.draw(y,D)}if(r.stencilMask(4294967295),r.disable(WebGL2RenderingContext.STENCIL_TEST),this.viewer.showScaleBar.value&&this.viewer.orthographicProjection.value){r.drawBuffers([r.COLOR_ATTACHMENT0]),r.disable(WebGL2RenderingContext.DEPTH_TEST),r.enable(WebGL2RenderingContext.BLEND),r.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA);const{scaleBars:E}=this,k=this.viewer.scaleBarOptions.value;E.draw(this.renderViewport,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value/this.renderViewport.logicalHeight,k),r.disable(WebGL2RenderingContext.BLEND)}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}drawSliceViews(e){const{sliceViewRenderHelper:t}=this,{lightDirection:n,ambientLighting:s,directionalLighting:r,projectionParameters:{viewProjectionMat:o}}=e,l=this.viewer.showSliceViews.value;for(const[c,u]of this.sliceViews){if(!u&&!l)continue;const{width:h,height:g,invViewMatrix:v,viewportNormalInCanonicalCoordinates:y}=c.projectionParameters.value;if(h===0||g===0||!c.valid)continue;const b=Math.abs($m(n,y)),w=s+b*r,C=vH;mx(C),C[0]=h/2,C[5]=-g/2,zt(C,v,C),zt(C,o,C);const E=ex,k=this.viewer.crossSectionBackgroundColor.value;E[0]=k[0],E[1]=k[1],E[2]=k[2],E[3]=1,t.draw(c.offscreenFramebuffer.colorBuffers[0].texture,C,so(w,w,w,1),ex,0,0,1,1)}}drawAxisLines(){const{zoomFactor:{value:e}}=this.viewer.navigationState,t=this.projectionParameters.value,n=Math.min(t.logicalWidth,t.logicalHeight)/this.renderViewport.logicalHeight/4,s=e*n,{gl:r}=this;r.drawBuffers([r.COLOR_ATTACHMENT0]),this.axesLineHelper.draw(KL(t,s),!1)}zoomByMouse(e){this.navigationState.zoomBy(e)}}function wH(i){i.addOutputBuffer("vec4","out_fragColor",0),i.addOutputBuffer("highp vec4","out_pickId",1),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
  float pickIdFloat = float(pickId);
  out_pickId = vec4(pickIdFloat, pickIdFloat, pickIdFloat, 1.0);
}
`)}function CH(i){i.addOutputBuffer("vec4","out_fragColor",null),i.addFragmentCode(`
void emit(vec4 color, highp uint pickId) {
  out_fragColor = color;
}
`)}const Ur=we(),xH=we(),EH=lh();class of extends eD{constructor(e,t,n,s){super(e,t,s),this.sliceView=n,this.axesLineHelper=this.registerDisposer(rf.get(this.gl)),this.sliceViewRenderHelper=this.registerDisposer(rE.get(this.gl,CH)),this.colorFactor=so(1,1,1,1),this.pickIDs=new XL,this.offscreenFramebuffer=this.registerDisposer(new ya(this.gl,{colorBuffers:[new Hr(this.gl,WebGL2RenderingContext.RGBA8,WebGL2RenderingContext.RGBA,WebGL2RenderingContext.UNSIGNED_BYTE),new Hr(this.gl,WebGL2RenderingContext.R32F,WebGL2RenderingContext.RED,WebGL2RenderingContext.FLOAT)]})),this.offscreenCopyHelper=this.registerDisposer(Sa.get(this.gl)),this.scaleBars=this.registerDisposer(new tD(this.gl)),s.wireFrame.changed.add(()=>this.scheduleRedraw()),fe(t,"rotate-via-mouse-drag",r=>{const{mouseState:o}=this.viewer;if(o.updateUnconditionally()){const l=Float32Array.from(o.position);oi(r.detail,(c,u,h)=>{const{pose:g}=this.navigationState,v=ta(Ur,Ui[0],g.orientation.orientation),y=ta(xH,Ui[1],g.orientation.orientation);this.viewer.navigationState.pose.rotateAbsolute(y,-u/4*Math.PI/180,l),this.viewer.navigationState.pose.rotateAbsolute(v,-h/4*Math.PI/180,l)})}}),fe(t,"rotate-in-plane-via-touchrotate",r=>{const{detail:o}=r,{mouseState:l}=this.viewer;this.handleMouseMove(o.centerX,o.centerY),l.updateUnconditionally()&&this.navigationState.pose.rotateAbsolute(this.sliceView.projectionParameters.value.viewportNormalInCanonicalCoordinates,o.angle-o.prevAngle,l.position)}),this.registerDisposer(n),this.visibleLayerTracker=BE(this.viewer.layerManager,Zr,this.viewer.visibleLayerRoles,this),this.registerDisposer(s.crossSectionBackgroundColor.changed.add(()=>this.scheduleRedraw())),this.registerDisposer(n.visibility.add(this.visibility)),this.registerDisposer(n.viewChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.registerDisposer(s.showAxisLines.changed.add(()=>{this.visible&&this.scheduleRedraw()})),this.registerDisposer(s.showScaleBar.changed.add(()=>{this.visible&&this.context.scheduleRedraw()})),this.registerDisposer(s.scaleBarOptions.changed.add(()=>{this.visible&&this.context.scheduleRedraw()}))}flushBackendProjectionParameters(){this.sliceView.flushBackendProjectionParameters()}get displayDimensionRenderInfo(){return this.navigationState.displayDimensionRenderInfo}get rpc(){return this.sliceView.rpc}get rpcId(){return this.sliceView.rpcId}get navigationState(){return this.sliceView.navigationState}translateByViewportPixels(e,t){const{pose:n}=this.viewer.navigationState;n.updateDisplayPosition(s=>{Zp(s,-e,-t,0),qn(s,s,this.sliceView.projectionParameters.value.invViewMatrix)})}translateDataPointByViewportPixels(e,t,n,s){const r=this.sliceView.projectionParameters.value;return qn(e,t,r.viewMatrix),Zp(e,e[0]+n,e[1]+s,e[2]),qn(e,e,r.invViewMatrix),e}isReady(){if(!this.visible)return!1;const{sliceView:e}=this;if(this.ensureBoundsUpdated(),!e.isReady())return!1;const t={projectionParameters:e.projectionParameters.value,sliceView:e};for(const[n,s]of this.visibleLayerTracker.visibleLayers)if(!n.isReady(t,s))return!1;return!0}drawWithPicking(e){const{sliceView:t}=this;if(!t.valid)return!1;t.updateRendering();const n=t.projectionParameters.value,{width:s,height:r,invViewProjectionMat:o}=n;ru(e.invTransform,o);const{gl:l}=this;this.offscreenFramebuffer.bind(s,r),l.disable(WebGL2RenderingContext.SCISSOR_TEST),this.gl.clearColor(0,0,0,0),l.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT);const c=EH,u=this.viewer.crossSectionBackgroundColor.value;c[0]=u[0],c[1]=u[1],c[2]=u[2],c[3]=1,this.offscreenFramebuffer.bindSingle(0),this.sliceViewRenderHelper.draw(t.offscreenFramebuffer.colorBuffers[0].texture,Sx,this.colorFactor,c,0,0,1,1);const{visibleLayers:h}=this.visibleLayerTracker,{pickIDs:g}=this;g.clear();const v=()=>{l.disable(WebGL2RenderingContext.SCISSOR_TEST),l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.offscreenFramebuffer.bind(s,r)};v();const y={wireFrame:this.viewer.wireFrame.value,projectionParameters:n,pickIDs:g,emitter:wH,emitColor:!0,emitPickID:!0,sliceView:t,bindFramebuffer:v,frameNumber:this.context.frameNumber};for(const[b,w]of h)b.draw(y,w);if(l.disable(WebGL2RenderingContext.BLEND),this.viewer.showAxisLines.value||this.viewer.showScaleBar.value){if(this.offscreenFramebuffer.bindSingle(0),this.viewer.showAxisLines.value){const b=Math.min(n.logicalWidth,n.logicalHeight)/4*1.5,{zoomFactor:{value:w}}=this.viewer.navigationState;this.axesLineHelper.draw(NA(KL(n,b*w)))}this.viewer.showScaleBar.value&&(l.enable(WebGL2RenderingContext.BLEND),l.blendFunc(WebGL2RenderingContext.SRC_ALPHA,WebGL2RenderingContext.ONE_MINUS_SRC_ALPHA),this.scaleBars.draw(n,this.navigationState.displayDimensionRenderInfo.value,this.navigationState.relativeDisplayScales.value,this.navigationState.zoomFactor.value,this.viewer.scaleBarOptions.value),l.disable(WebGL2RenderingContext.BLEND))}return this.offscreenFramebuffer.unbind(),this.setGLClippedViewport(),this.offscreenCopyHelper.draw(this.offscreenFramebuffer.colorBuffers[0].texture),!0}ensureBoundsUpdated(){super.ensureBoundsUpdated(),this.sliceView.projectionParameters.setViewport(this.renderViewport)}issuePickRequest(e,t){const{offscreenFramebuffer:n}=this;n.readPixelFloat32IntoBuffer(1,e-Wt,t-Wt,0,Ke,Ke)}completePickRequest(e,t,n,s){const{mouseState:r}=this.viewer;r.pickedRenderLayer=null,ZL(n,0,4,e,t,s.viewportWidth,s.viewportHeight);const{viewportWidth:o,viewportHeight:l}=s,c=Ku.length,{value:u}=this.navigationState.position,h=u.length,g=this.navigationState.pose.displayDimensions.value,{displayRank:v,displayDimensionIndices:y}=g,b=(E,k,D)=>{const A=e+E,N=t+k;Ur[0]=2*A/o-1,Ur[1]=2*N/l-1,Ur[2]=0,qn(Ur,Ur,s.invTransform),D.set(u);for(let I=0;I<v;++I)D[y[I]]=Ur[I]};let{unsnappedPosition:w}=r;w.length!==h&&(w=r.unsnappedPosition=new Float32Array(h)),r.coordinateSpace=this.navigationState.coordinateSpace.value,r.displayDimensions=g,b(0,0,w);const C=(E,k,D)=>{let{position:A}=r;A.length!==h&&(A=r.position=new Float32Array(h)),b(E-Wt,k-Wt,A),this.pickIDs.setMouseState(r,D),r.setActive(!0)};for(let E=0;E<c;++E){const k=Ku[E],D=n[4*E];if(D===0)continue;const A=k%Ke,N=(k-A)/Ke;C(A,N,D);return}C(Wt,Wt,0)}zoomByMouse(e){const{navigationState:t}=this;if(!t.valid)return;const{sliceView:n}=this,{width:s,height:r,invViewMatrix:o,displayDimensionRenderInfo:{displayDimensionIndices:l,displayRank:c}}=n.projectionParameters.value;let{mouseX:u,mouseY:h}=this;u-=s/2,h-=r/2;const g=this.navigationState.position.value;for(let v=0;v<c;++v){const y=l[v],b=o[v]*u+o[4+v]*h;g[y]+=b*(1-e)}this.navigationState.position.changed.dispatch(),t.zoomBy(e)}}const TH=["#f00","#0f0","#99f"],tx=He.fromObject({arrowup:{action:"move-up"},arrowdown:{action:"move-down"},wheel:{action:"adjust-via-wheel"},enter:{action:"commit"},escape:{action:"cancel"}});function kH(i){if(i<1||i>1024){const e=Math.log2(i)|0,t=i/2**e;return`${tT(t,1)}p${e}`}return i.toString()}const LH=[i=>i.name,i=>i.scaleFactor],DH=2e3;class IH extends K{constructor(e,t,n,s="px"){super(),this.displayDimensionRenderInfo=e,this.zoom=t,this.depthRange=n,this.displayUnit=s,this.element=document.createElement("div"),this.dimensionGridContainer=document.createElement("div"),this.depthGridContainer=document.createElement("div"),this.defaultCheckbox=document.createElement("input"),this.dimensionElements=Array.from(Array(3),(w,C)=>{const E=document.createElement("div");E.classList.add("neuroglancer-display-dimensions-widget-dimension"),E.style.display="contents",fe(E,"adjust-via-wheel",P=>{const O=P.detail,{deltaY:_}=O;_!==0&&this.zoomDimension(C,Math.sign(_))});const k=document.createElement("input");k.classList.add("neuroglancer-display-dimensions-widget-name"),k.title="Change display dimensions",k.spellcheck=!1,k.autocomplete="off",k.style.color=TH[C],k.style.gridColumn="1",k.style.gridRow=`${C+1}`,k.addEventListener("focus",()=>{k.select()}),E.appendChild(k);const D=document.createElement("span");D.classList.add("neuroglancer-display-dimensions-widget-scale-factor");const A=document.createElement("input");A.spellcheck=!1,A.title="Change relative scale at which dimension is displayed",A.autocomplete="off",D.style.gridColumn="2",D.style.gridRow=`${C+1}`,A.addEventListener("focus",()=>{A.select()}),D.appendChild(A),E.appendChild(D);const N=document.createElement("span");N.classList.add("neuroglancer-display-dimensions-widget-scale"),N.style.gridColumn="3",N.style.gridRow=`${C+1}`,E.appendChild(N),this.dimensionGridContainer.appendChild(E);const I={name:k,container:E,scaleFactor:A,scale:N,scaleFactorModified:!1};k.addEventListener("input",()=>{Dn(k),this.updateNameValidity()}),fe(k,"commit",()=>{this.updateNames()}),k.addEventListener("blur",P=>{const{relatedTarget:O}=P;this.dimensionElements.some(_=>_.name===O)||this.updateNames()||this.updateView()}),D.addEventListener("click",P=>{const{target:O}=P;O!==A&&(A.focus(),P.preventDefault())}),A.addEventListener("input",()=>{Dn(A),I.scaleFactorModified=!0}),fe(A,"commit",()=>{this.updateScaleFactors()}),A.addEventListener("blur",()=>{this.updateScaleFactors()||this.updateView()});for(const P of LH)fe(P(I),"move-up",()=>{C!==0&&P(this.dimensionElements[C-1]).focus()}),fe(P(I),"move-down",()=>{C!==2&&P(this.dimensionElements[C+1]).focus()});return I}),this.scheduleUpdateView=et(()=>this.updateView());const{element:r,dimensionGridContainer:o,defaultCheckbox:l}=this,c=document.createElement("label"),u=this.registerCancellable(ze(()=>{r.dataset.active="false"},DH)),h=()=>{r.dataset.active="true",u()};this.registerDisposer(t.changed.add(h)),this.registerDisposer(e.relativeDisplayScales.changed.add(h)),this.registerDisposer(n.changed.add(h)),r.classList.add("neuroglancer-display-dimensions-widget"),r.appendChild(o),o.classList.add("neuroglancer-display-dimensions-widget-dimension-grid"),r.addEventListener("pointerleave",()=>{const w=document.activeElement;w instanceof HTMLElement&&r.contains(w)&&w.blur()}),l.type="checkbox",c.appendChild(l),c.appendChild(document.createTextNode("Default")),c.title="Display first 3 dimensions",c.classList.add("neuroglancer-display-dimensions-widget-default"),l.addEventListener("change",()=>{this.updateDefault()}),o.appendChild(c),this.registerDisposer(e),this.registerDisposer(n),this.registerDisposer(t.changed.add(this.scheduleUpdateView)),this.registerDisposer(e.changed.add(this.scheduleUpdateView));const g=this.registerDisposer(new Pi(r,tx));g.allShortcutsAreGlobal=!0,this.registerDisposer(new ji(r,tx)),fe(o,"cancel",()=>{this.updateView();const w=document.activeElement;w instanceof HTMLElement&&r.contains(w)&&w.blur()});const{depthGridContainer:v}=this;v.classList.add("neuroglancer-depth-range-widget-grid"),r.appendChild(v);const y=document.createElement("label"),b=document.createElement("input");b.type="checkbox",y.classList.add("neuroglancer-depth-range-relative-checkbox-label"),b.classList.add("neuroglancer-depth-range-relative-checkbox"),y.appendChild(b),y.appendChild(document.createTextNode("Zoom-relative")),b.addEventListener("change",()=>{const w=b.checked;let C=this.depthRange.value;w!==C<0&&(w?C=-C/this.zoom.value:C=-C*this.zoom.value,this.depthRange.value=C)}),y.title="Depth range is multiplied by scale",r.appendChild(y),fe(v,"adjust-via-wheel",w=>{const C=w.detail,{deltaY:E}=C;if(E===0)return;const k=this.depthRange.value;this.depthRange.value=k*2**Math.sign(E)}),this.registerDisposer(Ti((w,C,{factors:E})=>{Fe(v);const{displayRank:k,globalDimensionNames:D,displayDimensionIndices:A,displayDimensionUnits:N,displayDimensionScales:I,canonicalVoxelFactors:P}=C,O=[],_=()=>{b.checked=this.depthRange.value<0;let j=this.depthRange.value;j<0&&(j*=-this.zoom.value);for(const B of O){const{input:H}=B;H.value=qr(j*B.scale,B.unit,{precision:2,elide1:!1}),Dn(H)}},W=j=>{const B=jl(j.input.value);if(B===void 0||B.unit!==j.unit)return!1;let H=B.scale/j.scale;return this.depthRange.value<0&&(H=-H/this.zoom.value),this.depthRange.value=H,!0};for(let j=0;j<k;++j){const B=A[j],H=D[B],V=N[j],re=E[B];let se=O.find(ve=>ve.unit===V&&ve.factor===re);if(se===void 0){const ve=document.createElement("div");ve.title="Visible depth range",ve.style.display="contents",v.appendChild(ve);const me=document.createElement("span");me.textContent="±",ve.appendChild(me);const Ie=document.createElement("input");Ie.spellcheck=!1,Ie.autocomplete="off",Ie.addEventListener("focus",()=>{Ie.select()}),fe(Ie,"commit",()=>{W(se)}),Ie.addEventListener("change",()=>{W(se)||_()}),Ie.addEventListener("input",()=>{Dn(Ie)}),ve.appendChild(Ie);const We=document.createElement("span");We.classList.add("neuroglancer-depth-range-widget-dimension-names"),ve.appendChild(We),se={unit:V,factor:re,dimensionNames:[],input:Ie,label:We,scale:I[j]/P[j]},O.push(se)}se.dimensionNames.push(H)}for(const j of O)j.dimensionNames.length!==k&&(j.label.textContent=j.dimensionNames.join(" "));w.registerDisposer(fe(v,"cancel",()=>{_();const j=document.activeElement;j instanceof HTMLElement&&v.contains(j)&&j.blur()}));const U=w.registerCancellable(et(_));w.registerDisposer(this.depthRange.changed.add(U)),w.registerDisposer(this.zoom.changed.add(U)),_()},e,this.relativeDisplayScales)),this.updateView()}zoomDimension(e,t){this.updateScaleFactors();const{displayDimensions:n}=this,{relativeDisplayScales:s}=this,{displayDimensionIndices:r}=n.value,o=r[e];if(o===-1)return;const{factors:l}=s.value,c=new Float64Array(l);c[o]*=2**-t,s.setFactors(c)}updateNameValidity(){const{dimensionElements:e}=this,{displayDimensionIndices:t}=this.displayDimensions.value,n=e.map(c=>c.name.value),s=sv(n),r=this.displayDimensions.coordinateSpace.value,{names:o}=r,l=n.length;for(let c=0;c<l;++c){let u=s[c];const h=n[c];let g=-1;h.length===0?u=!0:(g=o.indexOf(h),g===-1&&(u=!1));const v=e[c];v.name.dataset.isValid=u.toString(),v.container.dataset.isModified=(g!==t[c]).toString()}}get displayDimensions(){return this.displayDimensionRenderInfo.displayDimensions}get relativeDisplayScales(){return this.displayDimensionRenderInfo.relativeDisplayScales}updateNames(){const e=this.dimensionElements.map(l=>l.name.value).filter(l=>l.length>0);if(!uh(e))return!1;const{displayDimensions:t}=this.displayDimensionRenderInfo;if(e.length===0)return t.reset(),!0;const n=new Int32Array(3);n.fill(-1);const s=t.coordinateSpace.value,{names:r}=s,o=e.length;for(let l=0;l<o;++l){const c=r.indexOf(e[l]);if(c===-1)return!1;n[l]=c}return De(n,t.value.displayDimensionIndices)||t.setDimensionIndices(o,n),!0}updateDefault(){this.displayDimensions.default=this.defaultCheckbox.checked}updateScaleFactors(){const{displayDimensions:e}=this,{relativeDisplayScales:t}=this,{displayDimensionIndices:n,displayRank:s}=e.value,{factors:r}=t.value,{dimensionElements:o}=this,l=new Float64Array(r);for(let c=0;c<s;++c){const u=o[c];if(!u.scaleFactorModified)continue;const h=Number(u.scaleFactor.value),g=n[c];!Number.isFinite(h)||h<=0||(l[g]=h)}return De(l,r)||t.setFactors(l),!0}updateView(){const{dimensionElements:e,displayDimensions:{default:t}}=this,{displayDimensionIndices:n,canonicalVoxelFactors:s,displayDimensionUnits:r,displayDimensionScales:o,globalDimensionNames:l}=this.displayDimensionRenderInfo.value,{factors:c}=this.relativeDisplayScales.value;this.defaultCheckbox.checked=t;const u=this.zoom.value,h=n[0];let g=!0;if(h!==-1){const v=r[0],y=c[h];for(let b=1;b<3;++b){const w=n[b];if(w!==-1&&(r[b]!==v||c[w]!==y)){g=!1;break}}}for(let v=0;v<3;++v){const y=n[v],b=e[v];if(b.name.dataset.isValid=void 0,b.container.dataset.isModified=(y===-1).toString(),y===-1)b.name.value="",b.scale.textContent="",b.scaleFactor.value="";else{b.name.value=l[y];const w=o[v]*u/s[v];if(v===0||!g){const C=qr(w,r[v],{precision:2,elide1:!1});b.scale.textContent=`${C}/${this.displayUnit}`}else b.scale.textContent="";b.scaleFactor.value=kH(c[y])}Dn(b.name),Dn(b.scaleFactor)}}disposed(){gt(this.element),super.disposed()}}const iD=new Map([["xy",void 0],["xz",CA(Cn(),Cn(),Math.PI/2)],["yz",xA(Cn(),Cn(),Math.PI/2)]]),sD="◻",Om=new Map([["4panel","◱"],["3d",sD]]);function PH(i,e){let t;return e===void 0?t=i.navigationState.addRef():t=new Da(new La(i.navigationState.pose.position.addRef(),i.navigationState.pose.displayDimensionRenderInfo.addRef(),ka.makeRelative(i.navigationState.pose.orientation,e)),i.navigationState.zoomFactor.addRef(),i.navigationState.depthRange.addRef()),new xu(i.chunkManager,i.layerManager,t,i.wireFrame)}function Gl(i,e){return PH(i,iD.get(e))}function AH(i){return new Map([["xy",Gl(i,"xy")],["xz",Gl(i,"xz")],["yz",Gl(i,"yz")]])}function rD(i){return{crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor,selectionDetailsState:i.selectionDetailsState,mouseState:i.mouseState,layerManager:i.layerManager,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,visibleLayerRoles:i.visibleLayerRoles,selectedLayer:i.selectedLayer,visibility:i.visibility,scaleBarOptions:i.scaleBarOptions}}function ky(i){const{viewer:e}=i;return{...rD(e),navigationState:e.perspectiveNavigationState,inputEventMap:e.inputEventBindings.perspectiveView,orthographicProjection:i.specification.orthographicProjection,showScaleBar:e.showScaleBar,rpc:e.chunkManager.rpc}}function Xu(i){return{...rD(i),navigationState:i.navigationState,inputEventMap:i.inputEventBindings.sliceView}}function Pa(i,e){const{navigationState:t}=e;e.element.appendChild(i.registerDisposer(new IH(t.pose.displayDimensionRenderInfo.addRef(),t.zoomFactor,t.depthRange.addRef(),e instanceof of?"px":"vh")).element)}function Aa(i,e,t){const n=document.createElement("div");n.className="neuroglancer-data-panel-layout-controls",i.registerDisposer(()=>gt(n));for(let s=0;s<2;++s){const r=t[Math.min(t.length-1,s)];i.registerDisposer(fe(e.element,s===0?"toggle-layout":"toggle-layout-alternative",o=>{i.container.name=r,o.stopPropagation()}))}for(const s of t){const r=document.createElement("button"),o=document.createElement("div");r.appendChild(o),o.textContent=Om.get(s),r.title=`Switch to ${s} layout.`,r.addEventListener("click",()=>{i.container.name=s}),n.appendChild(r)}e.element.appendChild(n)}function RH(i,e){const t=new xu(i.chunkManager,i.layerManager,e.navigationState.addRef(),i.wireFrame),n=()=>{const{width:{value:s},height:{value:r}}=e;t.projectionParameters.setViewport({width:s,height:r,logicalWidth:s,logicalHeight:r,visibleLeftFraction:0,visibleTopFraction:0,visibleWidthFraction:1,visibleHeightFraction:1})};return t.registerDisposer(e.width.changed.add(n)),t.registerDisposer(e.height.changed.add(n)),n(),t}function Ly(i,e,t){const n=new Map;(()=>{const r=new Set;for(const o of t.values()){if(r.add(o),n.has(o))continue;const l=RH(i,o);e.sliceViews.set(l,!0),n.set(o,l)}for(const[o,l]of n)r.has(o)||e.sliceViews.delete(l)})()}class NH extends K{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r=AH(n),{display:o}=n,l={...ky(e),showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},c={...Xu(n),showScaleBar:n.showScaleBar},u={...Xu(n),showScaleBar:new ut(!1,!1)},h=(v,y,b,w)=>{const C=this.registerDisposer(new of(o,y,r.get(v),b));return w&&Pa(this,C),Aa(this,C,[v,`${v}-3d`]),C},g=[jn(1,Wr("column",[jn(1,Wr("row",[jn(1,v=>{h("xy",v,c,!0)}),jn(1,v=>{h("xz",v,u,!1)})])),jn(1,Wr("row",[jn(1,v=>{const y=this.registerDisposer(new Ty(o,v,l));for(const b of r.values())y.sliceViews.set(b.addRef(),!1);Pa(this,y),Ly(n,y,s),Aa(this,y,["3d"])}),jn(1,v=>{h("yz",v,u,!1)})]))]))];Wr("row",g)(t)}disposed(){Fe(this.rootElement),super.disposed()}}class MH extends K{constructor(e,t,n,s,r,o){super(),this.container=e,this.rootElement=t,this.viewer=n,this.direction=s;const l=Gl(n,r),{display:c}=n,u={...ky(e),showSliceViews:n.showPerspectiveSliceViews,showSliceViewsCheckbox:!0},h={...Xu(n),showScaleBar:n.showScaleBar};jn(1,Wr(s,[jn(1,g=>{const v=this.registerDisposer(new of(c,g,l,h));Pa(this,v),Aa(this,v,[r,"4panel"])}),jn(1,g=>{const v=this.registerDisposer(new Ty(c,g,u));v.sliceViews.set(l.addRef(),!1),Ly(n,v,o),Pa(this,v),Aa(this,v,["3d","4panel"])})]))(t)}disposed(){Fe(this.rootElement),super.disposed()}}class OH extends K{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r=Gl(n,s),o={...Xu(n),showScaleBar:n.showScaleBar};Wr("row",[jn(1,l=>{const c=this.registerDisposer(new of(n.display,l,r,o));Pa(this,c),Aa(this,c,["4panel",`${s}-3d`])})])(t)}disposed(){Fe(this.rootElement),super.disposed()}}class _H extends K{constructor(e,t,n,s){super(),this.container=e,this.rootElement=t,this.viewer=n;const r={...ky(e),showSliceViews:new ut(!1,!1)};Wr("row",[jn(1,o=>{const l=this.registerDisposer(new Ty(n.display,o,r));Ly(n,l,s),Pa(this,l),Aa(this,l,["4panel"])})])(t)}disposed(){Fe(this.rootElement),super.disposed()}}const _m=new Map([["4panel",{factory:(i,e,t,n)=>new NH(i,e,t,n)}],["3d",{factory:(i,e,t,n)=>new _H(i,e,t,n)}]]);for(const i of iD.keys()){_m.set(i,{factory:(t,n,s)=>new OH(t,n,s,i)});const e=`${i}-3d`;Om.set(i,sD),Om.set(e,"◫"),_m.set(e,{factory:(t,n,s,r)=>new MH(t,n,s,"row",i,r)})}function oD(i){const e=_m.get(i);if(e===void 0)throw new Error(`Invalid layout name: ${JSON.stringify(i)}.`);return e}function VH(i){return oD(i),i}class BH extends K{constructor(e){super(),this.width=new bt(1e3,ht),this.height=new bt(1e3,ht),this.changed=new ue,this.position=new wE(e.position.addRef()),this.position.changed.add(this.changed.dispatch),this.orientation=new Ig(e.pose.orientation.addRef()),this.orientation.changed.add(this.changed.dispatch),this.width.changed.add(this.changed.dispatch),this.height.changed.add(this.changed.dispatch),this.scale=new Pg(e.zoomFactor.addRef(),e.zoomFactor.displayDimensionRenderInfo.addRef()),this.scale.changed.add(this.changed.dispatch),this.navigationState=this.registerDisposer(new Da(new La(this.position.value,e.pose.displayDimensionRenderInfo.addRef(),this.orientation.value),this.scale.value,e.depthRange.addRef()))}restoreState(e){ee(e),ln(e,"width",this.width),ln(e,"height",this.height),ln(e,"position",ec(this.position)),ln(e,"orientation",this.orientation),ln(e,"scale",this.scale),ln(e,"zoom",ec(this.scale))}reset(){this.width.reset(),this.height.reset(),this.position.reset(),this.orientation.reset(),this.scale.reset()}toJSON(){return{width:this.width.toJSON(),height:this.height.toJSON(),position:this.position.toJSON(),orientation:this.orientation.toJSON(),scale:this.scale.toJSON()}}}class FH extends cv{constructor(e){super((t,n)=>t.registerDisposer(t.registerDisposer(n).changed.add(this.changed.dispatch))),this.parentNavigationState=e,this.registerDisposer(e)}restoreState(e){ee(e);for(const t of Object.keys(e)){const n=new BH(this.parentNavigationState);try{this.set(t,n.addRef()),n.restoreState(e[t])}finally{n.dispose()}}}reset(){this.clear()}toJSON(){if(this.size===0)return;const e={};for(const[t,n]of this)e[t]=n.toJSON();return e}}class UH extends K{constructor(e,t){super(),this.changed=new ue,this.orthographicProjection=new ut(!1),this.type=new bt(t,VH),this.type.changed.add(this.changed.dispatch),this.crossSections=this.registerDisposer(new FH(e.addRef())),this.crossSections.changed.add(this.changed.dispatch),this.orthographicProjection.changed.add(this.changed.dispatch),this.registerDisposer(e)}reset(){this.crossSections.clear(),this.orthographicProjection.reset(),this.type.reset()}restoreState(e){this.crossSections.clear(),this.orthographicProjection.reset(),typeof e=="string"?this.type.restoreState(e):(ee(e),z(e,"type",t=>this.type.restoreState(t)),z(e,"orthographicProjection",t=>this.orthographicProjection.restoreState(t)),z(e,"crossSections",t=>t!==void 0&&this.crossSections.restoreState(t)))}toJSON(){const{type:e,crossSections:t,orthographicProjection:n}=this,s=n.toJSON();return t.size===0&&s===void 0?e.value:{type:e.value,crossSections:t.toJSON(),orthographicProjection:s}}}class zH extends K{constructor(e,t){super(),this.viewer=e,this.element=document.createElement("div"),this.specification=this.registerDisposer(new UH(this.viewer.navigationState.addRef(),t)),this.element.style.flex="1";const n=this.registerCancellable(ze(()=>this.updateLayout(),0));this.specification.type.changed.add(n),fe(this.element,"toggle-orthographic-projection",()=>this.specification.orthographicProjection.toggle()),this.registerDisposer(this.viewer.display.updateStarted.add(()=>n.flush())),n()}get name(){return this.specification.type.value}set name(e){this.specification.type.value=e}get changed(){return this.specification.changed}toJSON(){return this.specification.toJSON()}restoreState(e){this.specification.restoreState(e)}reset(){this.specification.reset()}disposeLayout(){const{layout:e}=this;e!==void 0&&(e.dispose(),this.layout=void 0)}updateLayout(){this.disposeLayout(),this.layout=oD(this.name).factory(this,this.element,this.viewer,this.specification.crossSections)}disposed(){this.disposeLayout(),super.disposed()}}const GH=typeof STATE_SERVERS<"u"&&Object.keys(STATE_SERVERS).length>0;class $H extends K{constructor(e){if(super(),this.element=document.createElement("div"),this.button=$e({text:"Share",title:"Share State"}),typeof STATE_SERVERS>"u")throw new Error("Cannot construct StateSare without defining STATE_SERVERS");if(Object.keys(STATE_SERVERS).length>1){const t=document.createElement("select");t.style.marginRight="5px",this.registerDisposer(e.selectedStateServer.changed.add(()=>{const n=e.selectedStateServer.value;Object.values(STATE_SERVERS).map(s=>s.url).includes(n)&&(t.value=n)})),this.registerEventListener(t,"change",()=>{e.selectedStateServer.value=t.value});for(const[n,s]of Object.entries(STATE_SERVERS)){const r=document.createElement("option");r.textContent=n,r.value=s.url,r.selected=!!s.default,t.appendChild(r)}this.element.appendChild(t),this.selectStateServerElement=t}this.element.appendChild(this.button),this.registerEventListener(this.button,"click",()=>{const t=this.selectStateServerElement?this.selectStateServerElement.value:Object.values(STATE_SERVERS)[0].url,n=new URL(t).protocol,{url:s,credentialsProvider:r}=Ai(t,Rs);Pe.forPromise(ei(r,s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.state.toJSON())},tn).then(o=>{const l=new URL(o).protocol,c=o.substring(l.length),u=`${window.location.origin}/#!${n}${c}`;navigator.clipboard.writeText(u).then(()=>{Pe.showTemporaryMessage("Share link copied to clipboard")})}).catch(()=>{Pe.showTemporaryMessage("Could not access state server.",4e3)}),{initialMessage:`Posting state to ${t}.`,delay:!0,errorPrefix:""})})}disposed(){this.element.remove(),super.disposed()}}function WH(i){return i.startsWith("key")?i.substring(3):i.startsWith("digit")||i.startsWith("arrow")?i.substring(5):i}function HH(i){return i.split("+").map(WH).join("+")}const JH={...ao,side:"left",row:1};class jH{constructor(){this.location=new wr(JH)}get changed(){return this.location.changed}toJSON(){return Oa(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class YH extends ho{constructor(e,t,n,s,r){super(e,t.location),this.bindings=n,this.toolBinder=r,this.scroll=document.createElement("div"),this.addTitleBar({title:"Help"});const o=document.createElement("div");o.classList.add("neuroglancer-help-body");const{scroll:l}=this;l.classList.add("neuroglancer-help-scroll-container"),o.appendChild(l),this.addBody(o);const c=this.registerCancellable(et(()=>this.updateView()));this.registerDisposer(r.changed.add(c)),this.registerDisposer(s.layersChanged.add(c)),this.updateView()}updateView(){const{scroll:e,bindings:t,toolBinder:n}=this;if(Fe(e),typeof NEUROGLANCER_BUILD_INFO<"u"){const h=document.createElement("h2");h.textContent="Build info";const g=document.createElement("div");g.classList.add("neuroglancer-build-info");const v=document.createElement("a"),{tag:y,url:b,timestamp:w}=NEUROGLANCER_BUILD_INFO;if(v.textContent=y,v.target="_blank",b!==void 0&&(v.href=b),e.appendChild(h),g.appendChild(v),w!==void 0){const C=document.createElement("div");C.classList.add("neuroglancer-build-timestamp");const E=Intl.DateTimeFormat("en",{hour12:!1,dateStyle:"medium",timeStyle:"long"}).format(new Date(w));C.textContent=`Built at ${E}`,g.append(C)}e.appendChild(g)}const s=new Map;function r(h,g){for(const v of h.parents)v.label!==void 0?o(v.label,v):r(v,g);for(const[v,y]of h.bindings.entries()){const b=v.indexOf(":"),w=v.substring(b+1);g.set(w,y.action)}}function o(h,g){if(s.has(g))return;const v={label:h,entries:new Map};r(g,v.entries),s.set(g,v)}for(const[h,g]of t)o(h,g);const l=(h,g)=>{const v=document.createElement("h2");v.textContent=h,e.appendChild(v);for(const[y,b]of g){const w=document.createElement("div");w.className="dt",w.textContent=HH(y);const C=document.createElement("div");C.className="dd",C.textContent=b,e.appendChild(w),e.appendChild(C)}},c=new Map;for(const[h,g]of n.bindings)if(g.context instanceof Li){let v=c.get(g.context);v===void 0&&(v=[],c.set(g.context,v)),v.push([`shift+key${h.toLowerCase()}`,g.description])}const u=Array.from(c.entries());u.length>0&&(u[0][0].manager.root.layerManager.updateNonArchivedLayerIndices(),u.sort((h,g)=>h[0].managedLayer.nonArchivedLayerIndex-g[0].managedLayer.nonArchivedLayerIndex));for(const[h,g]of u)g.sort(),l(`Tool bindings for layer ${h.managedLayer.nonArchivedLayerIndex+1}: ${h.managedLayer.name}`,g);for(const h of s.values())l(h.label,h.entries)}}function qH(i,e){i.style.display="block";const{offsetWidth:t,offsetHeight:n}=i,s=document.documentElement.clientWidth,r=document.documentElement.clientHeight,o=document.documentElement.scrollLeft+Math.min(s-t,e.clientX),l=document.documentElement.scrollTop+Math.min(r-n,e.clientY);i.style.left=o+"px",i.style.top=l+"px"}class KH extends K{constructor(e){super(),this.element=document.createElement("div"),this.parentDisposers=new Map,this.disabledValue=!1,this.opened=new ue,this.closed=new ue;const{element:t}=this;t.className="neuroglancer-context-menu",t.style.display="none",t.tabIndex=-1,document.body.appendChild(t),e!==void 0&&this.registerParent(e)}get disabled(){return this.disabledValue}set disabled(e){this.disabledValue!==e&&(this.disabledValue=e,e&&this.hide())}get open(){return this.menuDisposer!==void 0}registerParent(e){const{parentDisposers:t}=this;t.has(e)||t.set(e,ti(e,"contextmenu",n=>{this.show(n),n.stopPropagation(),n.preventDefault()}))}show(e){if(this.disabledValue)return;this.hide();const{element:t}=this,n=ti(document,"mousedown",o=>{o.target instanceof Node&&!t.contains(o.target)&&this.hide()},!0),s=ti(document,"keydown",o=>{o.code==="Escape"&&this.hide()},!0),r=()=>{s(),n(),t.style.display="none"};this.opened.dispatch(),qH(t,e),this.menuDisposer=r}unregisterParent(e){const{parentDisposers:t}=this,n=t.get(e);n!==void 0&&(n(),t.delete(e))}disposed(){const{parentDisposers:e}=this;for(const t of e.values())t();e.clear(),gt(this.element)}hide(){this.menuDisposer!==void 0&&(this.menuDisposer(),this.menuDisposer=void 0,this.closed.dispatch())}}function XH(i){return OA(new TextEncoder().encode(i))}function QH(i){return new TextDecoder().decode(_A(i))}function ZH(i,e){if(i.startsWith(e))try{const t=QH(i.substring(e.length));return JSON.parse(t)}catch{return}}function e6(i,e){return i+XH(JSON.stringify(e))}function t6(i,e){for(const t of i){const n=ZH(t,e);if(n!==void 0)return{parameters:n,dragType:t}}}let aD;function Dy(i,e){return i.dataTransfer.dropEffect=e,aD=e,e}function Vm(){return aD}function n6(i){return i.draggable=!0,ti(i,"dragstart",e=>{e.stopPropagation(),e.preventDefault()})}const lD="neuroglancer-layer\0";let Xn;function cD(i,e){i.dataTransfer.setData(e6(lD,e.layers.map(s=>({name:s.name,visible:s.visible}))),JSON.stringify({layers:e.layers.map(s=>s.toJSON()),layout:e.layoutSpec})),Xn!==void 0&&Xn.disposer();let t;const n=()=>{e.manager.unregisterDisposer(n);for(const s of e.layers)s.dispose();e.manager.dispose(),Xn===t&&(Xn=void 0)};Xn=t={manager:e.manager.addRef(),layers:e.layers.map(s=>s.addRef()),layoutSpec:e.layoutSpec,isLayerListPanel:e.isLayerListPanel??!1,disposer:n}}function af(i="none"){if(Xn!==void 0){if(i==="move"){const e=new Set(Xn.layers);Xn.manager.layerManager.filter(t=>!e.has(t))}Xn.disposer()}}function Qu(i){return t6(i.dataTransfer.types,lD)}function dD(i){if(Xn!==void 0&&Xn.manager.rootLayers===i.rootLayers)return Xn}class nx{initializeExternalLayers(e){const{dragType:t}=this;if(t!==void 0)try{const{layers:n,layout:s}=JSON.parse(e.dataTransfer.getData(t));if(!Array.isArray(n)||this.numSourceLayers!==n.length)throw new Error("Invalid layer drop data");this.layoutSpec=s;for(const[r,o]of this.layers)DO(r,n[o])}catch{return!1}return!0}updateArchiveStates(e){const{targetIsLayerListPanel:t}=this,n=e.dataTransfer.dropEffect;for(const s of this.layers.keys()){let r=t;t&&!s.archived&&n!=="copy"&&this.sourceIsLayerListPanel&&(r=!1),(s.archived!==r||r&&s.visible)&&(s.archived=r,r&&(s.visible=!1),s.layerChanged.dispatch())}}get method(){return this.sourceManager!==void 0?this.manager===this.sourceManager&&this.sourceIsLayerListPanel===this.targetIsLayerListPanel?"move":"link":"copy"}compatibleWithMethod(e){return this.method===e?!0:this.forceCopy&&e!=="copy"?!1:!this.moveSupported&&e==="move"}}function uD(i,e,t){let n;i.shiftKey?n="copy":i.ctrlKey&&t?n="move":n=e;let s="";const r=o=>{s!==""&&(s+=", "),s+=o};return e!=="none"&&n!==e&&(i.shiftKey?r(`release SHIFT to ${e}`):r(`release CONTROL to ${e}`)),n!=="copy"&&r("hold SHIFT to copy"),n!=="move"&&t&&e!=="move"&&r("hold CONTROL to move"),{dropEffect:n,dropEffectMessage:s}}function hD(i,e,t,n){const s=dD(e);let r=!1,o;return s===void 0?o="copy":n?(s.isLayerListPanel||(r=!0),o="link"):s.manager===e&&s.isLayerListPanel===t?(o="move",r=!0):t?o="none":(s.isLayerListPanel||(r=!0),o="link"),uD(i,o,r)}function i6(i,e,t,n){const s=hD(i,e,t,n);return Dy(i,s.dropEffect),s}function Bm(i,e,t){const{forceCopy:n,newTarget:s,isLayerListPanel:r=!1}=t,o=dD(e);if(!n&&o!==void 0){const c=!s&&o.manager===e&&(o.isLayerListPanel===r||o.isLayerListPanel),u=new nx;return u.manager=e,u.numSourceLayers=o.layers.length,u.sourceManager=o.manager,u.targetIsLayerListPanel=r,u.sourceIsLayerListPanel=o.isLayerListPanel,u.moveSupported=c,u.layers=new Map,u.forceCopy=!1,u.layoutSpec=o.layoutSpec,c?o.layers.forEach((h,g)=>{u.layers.set(h,g)}):o.layers.forEach((h,g)=>{(s||!e.layerManager.has(h))&&u.layers.set(h.addRef(),g)}),u}const l=Qu(i);if(l!==void 0)try{const c=Ee(l.parameters,(h,g)=>{const v=z(h,"name",ie);let y=z(h,"visible",Ss);const b=new Iv(v,e);return r&&(y=!1),b.visible=y,b.archived=r,[b,g]}),u=new nx;return u.numSourceLayers=c.length,u.targetIsLayerListPanel=r,u.sourceIsLayerListPanel=!1,u.sourceManager=void 0,u.moveSupported=!1,u.forceCopy=o!==void 0,u.manager=e,u.dragType=l.dragType,u.layers=new Map(c),u}catch{}}function Fm(i,e){return i.moveSupported?!1:(i.manager.layerManager.filter(t=>!i.layers.has(t)),e!==void 0&&i.layers.has(e))}function lf(i,e,t,n=!1){function s(r,o){let l=i.dropLayers;const{dropEffect:c,dropEffectMessage:u}=o?hD(r,i.manager,n,!1):{dropEffect:Vm(),dropEffectMessage:""};if(c===void 0)return;Dy(r,c);let h=!0;if(!(l!==void 0&&!l.compatibleWithMethod(c)&&(i.dropLayers=void 0,Fm(l,t)))){if(l===void 0){if(l=i.dropLayers=Bm(r,i.manager,{forceCopy:c==="copy",newTarget:!1,isLayerListPanel:n}),l===void 0)return;h=l.method==="move"}if(t!==void 0&&l.layers.has(t))return{dropLayers:l,dropEffect:c,dropEffectMessage:u};if(h){const{layerManager:g}=i.manager,v=new Set;let y=Number.POSITIVE_INFINITY;const b=g.managedLayers=g.managedLayers.filter((C,E)=>l.layers.has(C)?(y===Number.POSITIVE_INFINITY&&(y=E),v.add(C),!1):!0);let w;t!==void 0?(w=b.indexOf(t),y<=w&&++w):w=b.length;for(const C of l.layers.keys())v.has(C)||l.layers.delete(C);b.splice(w,0,...l.layers.keys()),g.layersChanged.dispatch()}else{let g;t!==void 0&&(g=i.manager.layerManager.managedLayers.indexOf(t));for(const v of l.layers.keys())i.manager.add(v,g)}return{dropLayers:l,dropEffect:c,dropEffectMessage:u}}}e.addEventListener("dragenter",r=>{s(r,!0)!==void 0?r.preventDefault():Zt(i.element,"drop")}),e.addEventListener("drop",r=>{var l;r.preventDefault(),i.dragEnterCount=0,Zt(i.element,"drop");const o=(l=s(r,!1))==null?void 0:l.dropLayers;if(i.dropLayers=void 0,o!==void 0){if(!o.initializeExternalLayers(r)){Fm(o);return}o.updateArchiveStates(r),af(o.method==="move"?void 0:r.dataTransfer.dropEffect)}}),e.addEventListener("dragover",r=>{const o=s(r,!0);if(o===void 0){Zt(i.element,"drop");return}const{dropLayers:l,dropEffect:c,dropEffectMessage:u}=o,h=l.layers.size;let g="";const v=l.numSourceLayers===1?"":"s",y=l.numSourceLayers;if(c==="none")g=`Cannot link dragged layer${v} here`;else{const b=y===h?`${y}`:`${h}/${y}`;g=`Drop to ${c} ${b} layer${v}`}u&&(g+=` (${u})`),Ei(i.element,"drop",g),r.preventDefault(),r.stopPropagation()})}function fD(i,e,t,n){e.draggable=!0,e.addEventListener("dragstart",s=>{Ei(e,"drag","Drag layer to another layer bar/panel (including in another Neuroglancer window), or to the left/top/right/bottom edge of a layer group"),cD(s,{manager:i.manager,layers:[t],layoutSpec:n.getLayoutSpec(),isLayerListPanel:n.isLayerListPanel}),s.stopPropagation()}),e.addEventListener("dragend",()=>{Zt(e,"drag"),af()})}function pD(i){i.element.addEventListener("dragenter",()=>{++i.dragEnterCount}),i.element.addEventListener("dragleave",()=>{if(--i.dragEnterCount!==0)return;Zt(i.element,"drop");const{dropLayers:e}=i;e!==void 0&&(Fm(e),i.manager.layerManager.layersChanged.dispatch(),i.dropLayers=void 0)})}class s6 extends K{constructor(e,t){super(),this.layer=e,this.panel=t,this.element=document.createElement("div"),this.layerNumberElement=document.createElement("div"),this.labelElement=document.createElement("div"),this.visibleProgress=document.createElement("div"),this.prefetchProgress=document.createElement("div"),this.labelElementText=document.createTextNode(""),this.valueElement=document.createElement("div"),this.maxLength=0,this.prevValueText="";const{element:n,labelElement:s,layerNumberElement:r,valueElement:o,visibleProgress:l,prefetchProgress:c,labelElementText:u}=this;n.className="neuroglancer-layer-item neuroglancer-noselect",n.appendChild(l),n.appendChild(c),s.className="neuroglancer-layer-item-label",s.appendChild(u),l.className="neuroglancer-layer-item-visible-progress",c.className="neuroglancer-layer-item-prefetch-progress",r.className="neuroglancer-layer-item-number",o.className="neuroglancer-layer-item-value";const h=document.createElement("div");h.className="neuroglancer-layer-item-value-container";const g=document.createElement("div");g.className="neuroglancer-layer-item-button-container";const v=_v();v.title="Remove layer from this layer group",v.addEventListener("click",w=>{this.panel.layerManager===this.panel.manager.rootLayers?this.layer.setArchived(!0):this.layer.containers.size>2?this.panel.layerManager.removeManagedLayer(this.layer):this.layer.setArchived(!0),w.stopPropagation()});const y=vs();y.title="Delete this layer",y.addEventListener("click",w=>{Fa(this.layer),w.stopPropagation()}),n.appendChild(r),h.appendChild(o),h.appendChild(g),g.appendChild(v),g.appendChild(y),n.appendChild(s),n.appendChild(h);const b=this.registerDisposer(new Hc(e.localPosition,e.localCoordinateSpaceCombiner,{copyButton:!1,velocity:e.localVelocity,getToolBinder:()=>{var w;return(w=e.layer)==null?void 0:w.toolBinder}}));n.appendChild(b.element),b.element.addEventListener("click",w=>{w.stopPropagation()}),b.element.addEventListener("dblclick",w=>{w.stopPropagation()}),n.addEventListener("click",w=>{w.ctrlKey?t.selectedLayer.toggle(e):w.altKey?e.pickEnabled=!e.pickEnabled:e.setVisible(!e.visible)}),n.addEventListener("contextmenu",w=>{t.selectedLayer.layer=e,t.selectedLayer.visible=!0,w.stopPropagation(),w.preventDefault()}),fD(t,n,e,{getLayoutSpec:()=>t.getLayoutSpecForDrag()}),lf(this.panel,n,this.layer)}update(){const{layer:e,element:t}=this;this.labelElementText.textContent=e.name,t.dataset.visible=e.visible.toString(),t.dataset.selected=(e===this.panel.selectedLayer.layer).toString(),t.dataset.pick=e.pickEnabled.toString();let n=`Click to ${e.visible?"hide":"show"}, control+click to show side panel`;e.supportsPickOption&&(n+=`, alt+click to ${e.pickEnabled?"disable":"enable"} spatial object selection`),n+=", drag to move, shift+drag to copy",t.title=n}disposed(){this.element.remove(),super.disposed()}}class r6 extends K{constructor(e,t,n){super(),this.layerGroupViewer=e,this.getLayoutSpecForDrag=t,this.showLayerHoverValues=n,this.layerWidgets=new Map,this.element=document.createElement("div"),this.layerUpdateNeeded=!0,this.valueUpdateNeeded=!1,this.layerWidgetInsertionPoint=document.createElement("div"),this.positionWidget=this.registerDisposer(new Hc(this.viewerNavigationState.position.value,this.manager.root.coordinateSpaceCombiner,{velocity:this.viewerNavigationState.velocity.velocity,getToolBinder:()=>this.layerGroupViewer.toolBinder})),this.dragEnterCount=0,this.scheduleUpdate=this.registerCancellable(et(()=>this.update()));const{element:s,manager:r,selectedLayer:o}=this;s.className="neuroglancer-layer-panel",this.registerDisposer(r.layerSelectedValues.changed.add(()=>{this.handleLayerValuesChanged()})),this.registerDisposer(r.layerManager.layersChanged.add(()=>{this.handleLayersChanged()})),this.registerDisposer(o.changed.add(()=>{this.handleLayersChanged()})),this.registerDisposer(n.changed.add(()=>{this.handleLayerItemValueChanged()})),this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString(),this.layerWidgetInsertionPoint.style.display="none",this.element.appendChild(this.layerWidgetInsertionPoint);const l=$e({svg:Fu,title:"Click to add layer, control+click/right click/⌘+click to add local annotation layer."});l.classList.add("neuroglancer-layer-add-button");const c=this.dropZone=document.createElement("div");c.className="neuroglancer-layer-panel-drop-zone";const u=g=>{if(g.ctrlKey||g.metaKey||g.type==="contextmenu"){const v=GE(this.manager,"annotation",{type:"annotation",source:"local://annotations"});this.manager.add(v),this.selectedLayer.layer=v,this.selectedLayer.visible=!0}else this.addLayerMenu()};this.registerEventListener(l,"click",u),this.registerEventListener(l,"contextmenu",u),s.appendChild(l),s.appendChild(c),this.registerDisposer(n6(l)),s.appendChild(this.positionWidget.element);const h=()=>{const g=this.viewerNavigationState.position.link.value;this.positionWidget.element.style.display=g===Ah.LINKED?"none":""};this.registerDisposer(this.viewerNavigationState.position.link.changed.add(h)),h(),this.update(),this.updateChunkStatistics(),pD(this),lf(this,c,void 0),this.registerDisposer(this.display.updateStarted.add(()=>this.updateLayers())),this.registerDisposer(r.chunkManager.layerChunkStatisticsUpdated.add(this.registerCancellable(et(()=>this.updateChunkStatistics()))))}get layerManager(){return this.manager.layerManager}get manager(){return this.layerGroupViewer.layerSpecification}get display(){return this.layerGroupViewer.display}get selectedLayer(){return this.layerGroupViewer.selectedLayer}get viewerNavigationState(){return this.layerGroupViewer.viewerNavigationState}disposed(){this.layerWidgets.forEach(e=>e.dispose()),this.layerWidgets=void 0,gt(this.element),super.disposed()}handleLayersChanged(){this.layerUpdateNeeded=!0,this.handleLayerValuesChanged()}handleLayerValuesChanged(){this.valueUpdateNeeded||(this.valueUpdateNeeded=!0,this.scheduleUpdate())}handleLayerItemValueChanged(){this.element.dataset.showHoverValues=this.showLayerHoverValues.value.toString()}update(){if(this.valueUpdateNeeded=!1,this.updateLayers(),this.showLayerHoverValues.value===!1)return;const e=this.manager.layerSelectedValues;for(const[t,n]of this.layerWidgets){const s=t.layer;let r="";if(s!==null){const o=e.get(s);if(o!==void 0){const{value:l}=o;l!==void 0&&(r=""+l)}}if(r!==n.prevValueText){if(n.prevValueText=r,r.length>n.maxLength){const o=n.maxLength=r.length;n.valueElement.style.width=`${o}ch`}n.valueElement.textContent=r}}}updateChunkStatistics(){for(const[e,t]of this.layerWidgets){let n=0,s=0,r=0,o=0;const l=e.layer;if(l!==null)for(const{layerChunkProgressInfo:c}of l.renderLayers)n+=c.numVisibleChunksNeeded,s+=c.numVisibleChunksAvailable,r+=c.numPrefetchChunksNeeded,o+=c.numPrefetchChunksAvailable;t.visibleProgress.style.width=`${s/Math.max(1,n)*100}%`,t.prefetchProgress.style.width=`${o/Math.max(1,r)*100}%`}}updateLayers(){var s;if(!this.layerUpdateNeeded)return;this.layerUpdateNeeded=!1;const e=this.element,t=new Set;let n=this.layerWidgetInsertionPoint.nextElementSibling;this.manager.rootLayers.updateNonArchivedLayerIndices();for(const r of this.manager.layerManager.managedLayers){if(r.archived&&!((s=this.dropLayers)!=null&&s.layers.has(r)))continue;t.add(r);let o=this.layerWidgets.get(r);const l=r.nonArchivedLayerIndex;o===void 0&&(o=new s6(r,this),this.layerWidgets.set(r,o)),o.layerNumberElement.textContent=""+(1+l),o.update();const{element:c}=o;c!==n&&e.insertBefore(o.element,n),n=c.nextElementSibling}for(const[r,o]of this.layerWidgets)t.has(r)||(this.layerWidgets.delete(r),o.dispose())}addLayerMenu(){qE(this.manager,this.selectedLayer)}}function gD(i,e){const t=ti(i,"drop",o=>{if(o.preventDefault(),o.dataTransfer.types.indexOf(Qd)!==-1){o.stopPropagation();const l=ee(JSON.parse(o.dataTransfer.getData(Qd))),c=z(l,"dimensions",rv),u=z(l,"position",y=>Ee(y,Xe));if(u.length!==c.length)throw new Error("length mismatch between position and dimensions");const h=u.length,{coordinateSpace:{value:{names:g}},value:v}=e;for(let y=0;y<h;++y){const b=g.indexOf(c[y]);b!==-1&&(v[b]=u[y])}e.changed.dispatch()}}),n=o=>{o.dataTransfer.types.indexOf(Qd)!==-1&&(o.dataTransfer.dropEffect="link",o.preventDefault(),o.stopPropagation())},s=ti(i,"dragenter",n),r=ti(i,"dragover",n);return()=>{s(),r(),t()}}const Iy="neuroglancer-layer-group-viewer";function ix(i){return i.dataTransfer.types.indexOf(Iy)!==-1}let zi;function o6(i){if(zi&&zi.viewer.layerSpecification.rootLayers===i.rootLayers)return zi.viewer}function a6(i,e){const t=o6(e);let n,s=!1;return t===void 0||t.layerSpecification===t.layerSpecification.root?n="copy":(s=!0,n="move"),uD(i,n,s)}class l6 extends K{constructor(e){super(),this.relativeDisplayScales=new W2(e.navigationState.pose.relativeDisplayScales.addRef()),this.displayDimensions=new J2(e.navigationState.pose.displayDimensions.addRef()),this.position=new wE(e.navigationState.position.addRef()),this.velocity=this.registerDisposer(new G2(e.velocity,this.position.link)),this.crossSectionOrientation=new Ig(e.navigationState.pose.orientation.addRef()),this.displayDimensionRenderInfo=this.registerDisposer(new xE(this.relativeDisplayScales.value,this.displayDimensions.value)),this.crossSectionScale=new Pg(e.navigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.crossSectionDepthRange=new Eb(e.navigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.projectionDepthRange=new Eb(e.perspectiveNavigationState.depthRange.addRef(),this.displayDimensionRenderInfo),this.navigationState=this.registerDisposer(new Da(new La(this.position.value,this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.value),this.crossSectionScale.value,this.crossSectionDepthRange.value)),this.projectionOrientation=new Ig(e.perspectiveNavigationState.pose.orientation.addRef()),this.projectionScale=new Pg(e.perspectiveNavigationState.zoomFactor.addRef(),this.displayDimensionRenderInfo.addRef()),this.projectionNavigationState=this.registerDisposer(new Da(new La(this.position.value.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.value),this.projectionScale.value,this.projectionDepthRange.value))}copyToParent(){for(const e of[this.relativeDisplayScales,this.displayDimensions,this.position,this.velocity,this.crossSectionOrientation,this.crossSectionScale,this.projectionOrientation,this.projectionScale])e.copyToPeer()}register(e){e.add("dimensionRenderScales",this.relativeDisplayScales),e.add("displayDimensions",this.displayDimensions),e.add("position",ec(this.position)),e.add("velocity",this.velocity),e.add("crossSectionOrientation",this.crossSectionOrientation),e.add("crossSectionScale",this.crossSectionScale),e.add("crossSectionDepth",this.crossSectionDepthRange),e.add("projectionOrientation",this.projectionOrientation),e.add("projectionScale",this.projectionScale),e.add("projectionDepth",this.projectionDepthRange)}}function c6(i,e){const t=new KH(i),n=t.element;n.classList.add("neuroglancer-layer-group-viewer-context-menu");const s=document.createElement("button");s.textContent="Remove layer group",n.appendChild(s),t.registerEventListener(s,"click",()=>{e.layerSpecification.layerManager.clear()});const{viewerNavigationState:r}=e;for(const[o,l]of[["Render scale factors",r.relativeDisplayScales.link],["Render dimensions",r.displayDimensions.link],["Position",r.position.link],["Cross-section orientation",r.crossSectionOrientation.link],["Cross-section zoom",r.crossSectionScale.link],["Cross-section depth range",r.crossSectionDepthRange.link],["3-D projection orientation",r.projectionOrientation.link],["3-D projection zoom",r.projectionScale.link],["3-D projection depth range",r.projectionDepthRange.link]]){const c=t.registerDisposer(new Mh(l)),u=document.createElement("label");u.style.display="flex",u.style.flexDirection="row",u.style.whiteSpace="nowrap",u.textContent=o,u.appendChild(c.element),n.appendChild(u)}return t}class hc extends K{constructor(e,t,n={}){super(),this.element=e,this.viewerState=t,this.state=new Ih,this.options={showLayerPanel:new ut(!0),showViewerMenu:!1,showLayerHoverValues:new ut(!0),...n},this.layerSpecification=this.registerDisposer(t.layerSpecification),this.toolBinder=this.registerDisposer(new Lv(this,this.layerSpecification.root.toolBinder)),this.viewerNavigationState=this.registerDisposer(new l6(t)),this.viewerNavigationState.register(this.state),this.registerDisposer(Ti((s,r)=>{r===Ah.UNLINKED&&s.registerDisposer(new Tv(this.layerSpecification.root.display,this.viewerNavigationState.position.value,this.viewerNavigationState.velocity.velocity))},this.viewerNavigationState.position.link)),this.layerSpecification instanceof WE?this.state.add("layers",this.layerSpecification):this.state.add("layers",{changed:this.layerSpecification.changed,toJSON:()=>this.layerSpecification.layerManager.managedLayers.map(s=>s.name),reset:()=>{throw new Error("not implemented")},restoreState:()=>{throw new Error("not implemented")}}),e.classList.add("neuroglancer-layer-group-viewer"),this.registerDisposer(new Jh(e)),this.layout=this.registerDisposer(new zH(this,"xy")),this.state.add("layout",this.layout),this.state.add("toolBindings",this.toolBinder),this.registerActionBindings(),this.registerDisposer(this.layerManager.useDirectly()),this.registerDisposer(gD(e,this.navigationState.position)),this.registerDisposer(this.options.showLayerPanel.changed.add(this.registerCancellable(ze(()=>this.updateUI(),0)))),this.makeUI()}get perspectiveNavigationState(){return this.viewerNavigationState.projectionNavigationState}get navigationState(){return this.viewerNavigationState.navigationState}get selectionDetailsState(){return this.layerSpecification.root.selectionState}get display(){return this.viewerState.display}get selectedLayer(){return this.viewerState.selectedLayer}get layerManager(){return this.layerSpecification.layerManager}get chunkManager(){return this.layerSpecification.chunkManager}get mouseState(){return this.viewerState.mouseState}get showAxisLines(){return this.viewerState.showAxisLines}get wireFrame(){return this.viewerState.wireFrame}get showScaleBar(){return this.viewerState.showScaleBar}get showPerspectiveSliceViews(){return this.viewerState.showPerspectiveSliceViews}get inputEventBindings(){return this.viewerState.inputEventBindings}get visibility(){return this.viewerState.visibility}get visibleLayerRoles(){return this.viewerState.visibleLayerRoles}get crossSectionBackgroundColor(){return this.viewerState.crossSectionBackgroundColor}get perspectiveViewBackgroundColor(){return this.viewerState.perspectiveViewBackgroundColor}get scaleBarOptions(){return this.viewerState.scaleBarOptions}get changed(){return this.state.changed}bindAction(e,t){this.registerDisposer(fe(this.element,e,t))}registerActionBindings(){this.bindAction("add-layer",()=>{this.layerPanel&&this.layerPanel.addLayerMenu()}),this.bindAction("t-",()=>{this.navigationState.pose.translateNonDisplayDimension(0,-1)}),this.bindAction("t+",()=>{this.navigationState.pose.translateNonDisplayDimension(0,1)})}toJSON(){return{type:"viewer",...this.state.toJSON()}}reset(){this.state.reset()}restoreState(e){this.state.restoreState(e),ln(e,"crossSectionZoom",ec(this.viewerNavigationState.crossSectionScale)),ln(e,"perspectiveZoom",ec(this.viewerNavigationState.projectionScale)),ln(e,"perspectiveOrientation",this.viewerNavigationState.projectionOrientation)}makeUI(){this.element.style.flex="1",this.element.style.display="flex",this.element.style.flexDirection="column",this.element.appendChild(this.layout.element),this.updateUI()}updateUI(){const{options:e}=this,t=e.showLayerPanel.value;if(this.layerPanel!==void 0&&!t){this.layerPanel.dispose(),this.layerPanel=void 0;return}if(t&&this.layerPanel===void 0){const n=this.layerPanel=new r6(this,()=>this.layout.toJSON(),this.options.showLayerHoverValues);if(e.showViewerMenu?(n.registerDisposer(c6(n.element,this)),n.element.title="Right click for options, drag to move/copy layer group."):n.element.title="Drag to move/copy layer group.",typeof NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS<"u"&&NEUROGLANCER_SHOW_LAYER_BAR_EXTRA_BUTTONS===!0){{const r=document.createElement("button");r.textContent="Clear segments",r.title='De-select all objects ("x")',r.addEventListener("click",o=>{DE(o,o,{action:"clear-segments"})}),n.element.appendChild(r)}for(const r of["3d","xy","xz","yz"]){const o=document.createElement("button");o.textContent=r,o.title=`Switch to ${r} layout`,o.addEventListener("click",()=>{let l;this.layout.name===r?r!=="3d"?l=`${r}-3d`:l="4panel":l=r,this.layout.name=l}),n.element.appendChild(o)}}n.element.draggable=!0;const s=n.element;s.addEventListener("dragstart",r=>{Ei(n.element,"drag","Drag layer group to the left/top/right/bottom edge of a layer group, or to another layer bar/panel (including in another Neuroglancer window)"),cD(r,{manager:this.layerSpecification,layers:this.layerManager.managedLayers,layoutSpec:this.layout.toJSON()});const o=()=>{zi&&zi.viewer===this&&(zi=void 0),this.unregisterDisposer(o)};zi={viewer:this,disposer:o},this.registerDisposer(o);const l=this.toJSON();l.layers=void 0,r.dataTransfer.setData(Iy,JSON.stringify(l)),n.element.style.backgroundColor="black",setTimeout(()=>{n.element.style.backgroundColor=""},0)}),n.element.addEventListener("dragend",()=>{Zt(s,"drag"),af(),zi!==void 0&&zi.viewer===this&&zi.disposer()}),this.element.insertBefore(s,this.element.firstChild)}}disposed(){Fe(this.element);const{layerPanel:e}=this;e!==void 0&&(e.dispose(),this.layerPanel=void 0),super.disposed()}}const sx=Symbol("layoutComponentContainer");class Xo extends K{constructor(e,t,n){super(),this.viewer=e,this.parent=n,this.changed=new ue,this.flex=new bt(1,wt),this.element=document.createElement("div");const{element:s}=this;s.style.display="flex",s.style.flex="1",s.style.position="relative",s.style.alignItems="stretch",s[sx]=this,this.flex.changed.add(()=>{s.style.flexGrow=""+this.flex.value,this.changed.dispatch()}),this.setSpecification(t);const r=[],o=c=>{const u=document.createElement("div");u.className="neuroglancer-layout-split-drop-zone";let h;switch(u.style[c]="0",c){case"left":case"right":h="row",u.style.width="10px",u.style.height="100%";break;case"top":case"bottom":h="column",u.style.height="10px",u.style.width="100%";break}u.style.display="none",r.push({element:u,direction:h,orientation:c}),s.appendChild(u),vD(u,this.viewer.layerSpecification,()=>this.split(c).newContainer.component,h==="row"?"column":"row")};o("left"),o("right"),o("top"),o("bottom");let l=!1;s.addEventListener("dragenter",c=>{if(!l&&Qu(c)!==void 0){l=!0;for(const{element:u,direction:h,orientation:g}of r){if(n!==void 0&&h===n.direction&&((g==="left"||g==="top")&&n.get(0)!==this||(g==="bottom"||g==="right")&&n.get(n.length-1)!==this))continue;const{component:v}=this;v instanceof nu&&v.direction===h||(u.style.display="block")}}},!0),s.addEventListener("drop",c=>{if(l){l=!1;for(const{element:u}of r)u.style.display="none"}},!0),s.addEventListener("dragleave",c=>{const{relatedTarget:u}=c;if(l&&!(u instanceof HTMLElement&&this.element.contains(u))){l=!1;for(const{element:h}of r)h.style.display="none"}},!0)}unsetComponent(){const e=this.componentValue;e!==void 0&&(e.changed.remove(this.changed.dispatch),this.element.removeChild(e.element),e.dispose())}get component(){return this.componentValue}setComponent(e){if(this.unsetComponent(),this.componentValue=e,e.changed.add(this.changed.dispatch),this.element.appendChild(e.element),e instanceof hc){const{layerManager:t}=e,n=e.registerCancellable(ze(()=>{t.managedLayers.length===0&&this.dispose()},0));e.registerDisposer(t.layersChanged.add(()=>{t.managedLayers.length===0&&n()})),n()}else if(e instanceof nu){const t=e.registerCancellable(ze(()=>{const{length:n}=e;if(n===0&&this.parent!==void 0)this.dispose();else if(n===1){const s=e.get(0).component;let r;if(this.parent===void 0&&s instanceof hc){r=s.layout.specification.toJSON(),s.viewerNavigationState.copyToParent();const o=s.layerManager.managedLayers,l=new Set(o),{layerSpecification:c}=s;c.rootLayers.filter(g=>l.has(g)||g.archived);const u=[],{managedLayers:h}=c.rootLayers;for(let g=0,v=h.length;g<v;++g)l.has(h[g])&&u.push(g);for(let g=0,v=o.length;g<v;++g)h[u[g]]=o[g];c.rootLayers.layersChanged.dispatch()}else r=s.toJSON();this.setSpecification(r)}},0));e.registerDisposer(e.changed.add(()=>{e.length<2&&t()})),t()}this.changed.dispatch()}toJSON(){const e=this.component.toJSON();return this.parent instanceof nu&&(e.flex=this.flex.toJSON()),e}setSpecification(e){this.setComponent(d6(this,e)),this.flex.value=oe(e,"flex",wt,1)}static getFromElement(e){return e[sx]}disposed(){this.unsetComponent(),this.componentValue=void 0,super.disposed()}split(e){const t={type:"viewer"},{parent:n}=this;if(n!==void 0){if(e==="left"&&n.direction==="row"||e==="top"&&n.direction==="column")return{newContainer:n.insertChild(t,this),existingContainer:this};if(e==="right"&&n.direction==="row"||e==="bottom"&&n.direction==="column")return{newContainer:n.insertChild(t),existingContainer:this}}let s;const r=this.component;r instanceof Um?s=r.layerGroupViewer.toJSON():s=r.toJSON();let o,l;const c=e==="left"||e==="right"?"row":"column";switch(e){case"left":case"top":o={type:c,children:[t,s]},l=0;break;case"right":case"bottom":o={type:c,children:[s,t]},l=1;break}this.setSpecification(o);const u=this.component;return{newContainer:u.get(l),existingContainer:u.get(1-l)}}}function mD(i){return{mouseState:i.mouseState,showAxisLines:i.showAxisLines,wireFrame:i.wireFrame,showScaleBar:i.showScaleBar,scaleBarOptions:i.scaleBarOptions,showPerspectiveSliceViews:i.showPerspectiveSliceViews,inputEventBindings:i.inputEventBindings,visibility:i.visibility,selectedLayer:i.selectedLayer,visibleLayerRoles:i.visibleLayerRoles,navigationState:i.navigationState.addRef(),perspectiveNavigationState:i.perspectiveNavigationState.addRef(),velocity:i.velocity.addRef(),crossSectionBackgroundColor:i.crossSectionBackgroundColor,perspectiveViewBackgroundColor:i.perspectiveViewBackgroundColor}}class Um extends K{constructor(e,t,n){super(),this.element=e,this.layerGroupViewer=this.registerDisposer(new hc(e,{display:n.display,layerSpecification:n.layerSpecification.addRef(),...mD(n)},{showLayerPanel:n.uiControlVisibility.showLayerPanel,showViewerMenu:!1,showLayerHoverValues:n.uiControlVisibility.showLayerHoverValues})),this.layerGroupViewer.layout.restoreState(t)}toJSON(){return this.layerGroupViewer.layout.specification.toJSON()}get changed(){return this.layerGroupViewer.layout.changed}}function vD(i,e,t,n){i.addEventListener("dragenter",s=>{Qu(s)!==void 0&&i.classList.add("neuroglancer-drag-over")}),i.addEventListener("dragleave",()=>{Zt(i,"drop"),i.classList.remove("neuroglancer-drag-over")}),i.addEventListener("dragover",s=>{const r=(o,l)=>{o.dropEffectMessage&&(l+=` (${o.dropEffectMessage})`),Ei(i,"drop",l),s.stopPropagation(),s.preventDefault()};if(ix(s)){const o=a6(s,e);Dy(s,o.dropEffect),r(o,`Drop to ${o.dropEffect} layer group as new ${n}`);return}if(Qu(s)!==void 0){const o=i6(s,e,!1,!0);r(o,`Drop to ${o.dropEffect} layer as new ${n}`);return}}),i.addEventListener("drop",s=>{i.classList.remove("neuroglancer-drag-over"),Zt(i,"drop");let r,o;if(ix(s)){s.stopPropagation();try{o=JSON.parse(s.dataTransfer.getData(Iy))}catch{return}if(r=Bm(s,e,{forceCopy:!1,newTarget:!0}),r===void 0)return}else{if(r=Bm(s,e,{forceCopy:Vm()==="copy",newTarget:!0}),r===void 0)return;o=r.layoutSpec}if(!r.initializeExternalLayers(s)){if(!r.moveSupported)for(const u of r.layers.keys())u.dispose();return}s.preventDefault();const l=s.dataTransfer.dropEffect=Vm();af(l);const c=t();r.updateArchiveStates(s);for(const u of r.layers.keys())c.layerSpecification.add(u);try{c.restoreState(o)}catch{c.layout.reset()}})}class nu extends K{constructor(e,t,n,s){super(),this.element=e,this.direction=t,this.container=s,this.changed=new ue,e.classList.add("neuroglancer-stack-layout"),e.classList.add(`neuroglancer-stack-layout-${t}`),e.style.display="flex",e.style.flexDirection=t,e.appendChild(this.makeDropPlaceholder(this));for(const r of n)this.insertChild(r)}get length(){return(this.element.childElementCount-1)/2}makeDropPlaceholder(e){const t=document.createElement("div");return t.className="neuroglancer-stack-layout-drop-placeholder",vD(t,this.viewer.layerSpecification,()=>{const n=t.nextElementSibling;let s;return n!==null&&(s=Xo.getFromElement(n)),this.insertChild({type:"viewer",layers:[]},s).component},this.direction==="row"?"column":"row"),e.registerDisposer(()=>{gt(t)}),t.addEventListener("pointerdown",n=>{if("button"in n&&n.button!==0)return;const s=t.nextElementSibling;if(s===null)return;const r=Xo.getFromElement(s),o=t.previousElementSibling;if(o===null)return;const l=Xo.getFromElement(o);n.preventDefault();const c=()=>{Ei(t,"drag",`Drag to resize, current ${zr[this.direction]} ratio is ${l.flex.value} : ${r.flex.value}`)};c(),oi(n,u=>{const h=l.element.getBoundingClientRect(),g=r.element.getBoundingClientRect(),v=Math.max(.1,Math.min(.9,this.direction==="column"?(u.clientY-h.top)/(g.bottom-h.top):(u.clientX-h.left)/(g.right-h.left))),y=Number(l.flex.value)+Number(r.flex.value);l.flex.value=Math.round(v*y*100)/100,r.flex.value=Math.round((1-v)*y*100)/100,c()},()=>{Zt(t,"drag")})}),t}get viewer(){return this.container.viewer}get(e){return Xo.getFromElement(this.element.children[e*2+1])}insertChild(e,t){const n=new Xo(this.viewer,e,this),s=this.makeDropPlaceholder(n);n.element.classList.add("neuroglancer-stack-layout-child"),n.registerDisposer(n.changed.add(this.changed.dispatch)),n.registerDisposer(()=>{this.element.removeChild(n.element),this.changed.dispatch()});const r=t!==void 0?t.element:null;return this.element.insertBefore(n.element,r),this.element.insertBefore(s,r),this.changed.dispatch(),n}disposed(){this.clear(),super.disposed()}clear(){for(;this.length!==0;)this.get(0).dispose()}*[Symbol.iterator](){const{length:e}=this;for(let t=0;t<e;++t)yield this.get(t)}toJSON(){return{type:this.direction,children:Array.from(this).map(e=>e.toJSON())}}}function d6(i,e){const t=document.createElement("div");if(t.style.flex="1",t.style.width="0px",typeof e=="string"){if(i.parent!==void 0)throw new Error(`Invalid layout component specification: ${JSON.stringify(e)}`);return new Um(t,e,i.viewer)}ee(e);const n=z(e,"type",ie);switch(n){case"row":case"column":return new nu(t,n,z(e,"children",s=>{const r=Ee(s,o=>o);if(i.parent===void 0&&r.length===0)throw new Error("Stack layout requires at least one child.");return r}),i);case"viewer":{const s=i.viewer,r=new WE(s.layerSpecification.addRef()),o=new hc(t,{display:s.display,layerSpecification:r,...mD(s)},{showLayerPanel:s.uiControlVisibility.showLayerPanel,showViewerMenu:!0,showLayerHoverValues:s.uiControlVisibility.showLayerHoverValues});try{o.restoreState(e)}catch(l){throw o.dispose(),l}return o}default:return new Um(t,e,i.viewer)}}class u6 extends K{constructor(e,t){super(),this.viewer=e,this.defaultSpecification=t,this.container=this.registerDisposer(new Xo(this.viewer,this.defaultSpecification,void 0))}get changed(){return this.container.changed}get element(){return this.container.element}reset(){this.container.setSpecification(this.defaultSpecification)}restoreState(e){this.container.setSpecification(e)}disposed(){super.disposed()}toJSON(){return this.container.toJSON()}}const h6=`<svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-labelledby="eyeIconTitle">
	<title id="eyeIconTitle">Visible (eye)</title>
	<path d="M22 12C22 12 19 18 12 18C5 18 2 12 2 12C2 12 5 6 12 6C19 6 22 12 22 12Z"/>
	<circle cx="12" cy="12" r="3"/>
</svg>`,f6=`<svg role="img" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" aria-labelledby="cursorIconTitle">
    <title id="cursorIconTitle">Cursor</title>    
    <polygon points="7 20 7 4 19 16 12 16 7 21"/>
</svg>`,p6=He.fromObject({escape:{action:"cancel"}});class yD extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("input");const{element:t}=this;t.classList.add("neuroglancer-layer-side-panel-name"),t.spellcheck=!1,t.autocomplete="off";const n=this.registerDisposer(new Pi(t,p6));n.allShortcutsAreGlobal=!0,fe(t,"cancel",s=>{this.updateView(),t.blur(),s.stopPropagation(),s.preventDefault()}),t.title="Rename layer",this.registerDisposer(e.layerChanged.add(()=>this.updateView())),t.addEventListener("change",()=>this.updateModel()),t.addEventListener("blur",()=>this.updateModel()),this.updateView()}updateView(){this.element.value=this.layer.name}updateModel(){jE(this.layer,this.element.value)}}class g6 extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("select"),this.measureElement=document.createElement("div");const{element:t,measureElement:n}=this;t.classList.add("neuroglancer-layer-side-panel-type"),n.classList.add("neuroglancer-layer-side-panel-type-measure"),t.title="Change layer type",document.body.appendChild(n);for(const[s,r]of ku){if(r.type!==s)continue;const o=document.createElement("option");o.textContent=r.typeAbbreviation,o.value=s,t.appendChild(o)}t.addEventListener("change",()=>{const s=t.value,r=ku.get(s);Av(this.layer.managedLayer,r)}),this.updateView()}updateView(){const e=this.layer.type,{element:t,measureElement:n}=this;n.textContent=this.layer.constructor.typeAbbreviation,t.value=e,t.style.width=`${n.offsetWidth}px`}disposed(){this.measureElement.remove()}}class Zu extends ho{constructor(e,t){super(e,t.location),this.panelState=t;const n=this.layer=t.layer,{element:s}=this,{titleBar:r}=this.addTitleBar({});r.classList.add("neuroglancer-layer-side-panel-title"),r.appendChild(this.registerDisposer(new g6(n)).element),r.appendChild(this.registerDisposer(new yD(n.managedLayer)).element),this.registerDisposer(ys(c=>{s.dataset.neuroglancerLayerVisible=c.toString()},{get value(){return n.managedLayer.visible},changed:n.managedLayer.layerChanged}));const o=this.registerDisposer(new Kn({get value(){return n.managedLayer.pickEnabled},set value(c){n.managedLayer.pickEnabled=c},changed:n.managedLayer.layerChanged},{svg:f6,enableTitle:"Spatial object selection: disabled",disableTitle:"Spatial object selection: enabled"}));this.registerDisposer(new Wn({get value(){return n.managedLayer.supportsPickOption},changed:n.managedLayer.layerChanged},o.element)),r.appendChild(o.element);const l={get value(){return t!==n.panels.panels[0]},set value(c){c?t.pin():t.unpin()},changed:n.manager.root.layerManager.layersChanged};r.appendChild(this.registerDisposer(new Kn(l,{text:"📌︎",enableTitle:"Pin panel to this layer",disableTitle:"Unpin panel to this layer"})).element),this.registerDisposer(ys(c=>{s.dataset.neuroglancerLayerPanelPinned=c.toString()},l)),r.appendChild(vs({title:"Delete layer",onClick:()=>{Fa(this.layer.managedLayer)}})),this.tabView=new gO({makeTab:c=>n.tabs.options.get(c).getter(),selectedTab:t.selectedTab,tabs:this.registerDisposer(new fx({get value(){return t.tabs.map(c=>{const{label:u,hidden:h}=n.tabs.options.get(c);return{id:c,label:u,hidden:(h==null?void 0:h.value)||!1}})},changed:t.tabsChanged})),handleTabElement:(c,u)=>{u.draggable=!0,u.addEventListener("dragstart",h=>{h.stopPropagation(),h.dataTransfer.setData("neuroglancer-side-panel","");let g="Drag tab to dock as new panel to the left/right/top/bottom of another panel";t.panels.panels.find(y=>y!==t&&y.location.visible)&&(g+=`, or move tab to other ${JSON.stringify(n.managedLayer.name)} panel`),Ei(u,"drag",g),this.sidePanelManager.startDrag({dropAsNewPanel:y=>{this.panelState.splitOffTab(c,{...kE,...y})},canDropAsTabs:y=>y instanceof Zu&&y.layer===this.layer&&y!==this?1:0,dropAsTab:y=>{this.panelState.moveTabTo(c,y.panelState)}},h)}),u.addEventListener("dragend",h=>{Zt(u,"drag"),this.sidePanelManager.endDrag()})}},this.visibility),this.tabView.element.style.flex="1",this.tabView.element.classList.add("neuroglancer-layer-side-panel-tab-view"),this.tabView.element.style.position="relative",this.tabView.element.appendChild(this.makeTabDropZone()),this.addBody(this.tabView.element),this.registerDisposer(t.tabsChanged.add(()=>{t.tabs.length===0&&(this.location.visible=!1)}))}makeDragSource(){return{...super.makeDragSource(),canDropAsTabs:e=>e instanceof Zu&&e.layer===this.layer&&e!==this?this.panelState.tabs.length:0,dropAsTab:e=>{this.panelState.mergeInto(e.panelState)}}}makeTabDropZone(){const e=document.createElement("div");return e.className="neuroglancer-side-panel-drop-zone",e.style.position="absolute",e.style.left="20px",e.style.right="20px",e.style.bottom="20px",e.style.top="20px",e.addEventListener("dragenter",t=>{var r;const{dragSource:n}=this.sidePanelManager,s=(r=n==null?void 0:n.canDropAsTabs)==null?void 0:r.call(n,this);s&&(e.classList.add(ra),Ei(e,"drop",`Move ${s} ${s===1?"tab":"tabs"} to this panel`),t.preventDefault())}),e.addEventListener("dragleave",()=>{Zt(e,"drop"),e.classList.remove(ra)}),e.addEventListener("dragover",t=>{var s;const{dragSource:n}=this.sidePanelManager;(s=n==null?void 0:n.canDropAsTabs)!=null&&s.call(n,this)&&t.preventDefault()}),e.addEventListener("drop",t=>{var s;Zt(e,"drop");const{dragSource:n}=this.sidePanelManager;(s=n==null?void 0:n.canDropAsTabs)!=null&&s.call(n,this)&&(e.classList.remove(ra),n.dropAsTab(this),t.preventDefault(),t.stopPropagation())}),e}}class m6 extends K{constructor(e,t){super(),this.sidePanelManager=e,this.selectedLayerState=t,this.layerSidePanels=new Map,this.generation=0,this.layersNeedUpdate=!0;const n=()=>{this.layersNeedUpdate=!0,this.sidePanelManager.display.scheduleRedraw()};this.registerDisposer(t.changed.add(n)),this.registerDisposer(t.layerManager.layersChanged.add(n)),this.registerDisposer(e.beforeRender.add(()=>this.update()))}getSelectedUserLayer(){var e;return((e=this.selectedLayerState.layer)==null?void 0:e.layer)??void 0}update(){var r;if(!this.layersNeedUpdate)return;const{layerManager:e}=this.selectedLayerState,t=++this.generation;this.layersNeedUpdate=!1;const{layerSidePanels:n}=this,s=o=>{let l=n.get(o);l===void 0?(l={generation:t,unregister:this.sidePanelManager.registerPanel({location:o.location,makePanel:()=>new Zu(this.sidePanelManager,o)})},n.set(o,l)):l.generation=t};{const o=this.getSelectedUserLayer(),{location:l}=this.selectedLayerState;if(o===void 0||!l.visible)this.placeholderSelectedLayerPanel===void 0&&(this.placeholderSelectedLayerPanel=this.sidePanelManager.registerPanel({location:l,makePanel:()=>new ho(this.sidePanelManager,l)}));else{(r=this.placeholderSelectedLayerPanel)==null||r.call(this),this.placeholderSelectedLayerPanel=void 0;const c=o.panels.panels[0];c.location.value=l.value,s(c)}}for(const o of e.managedLayers){const l=o.layer;if(l===null)continue;const{panels:c}=l.panels;for(let u=1,h=c.length;u<h;++u)s(c[u])}for(const[o,l]of n)l.generation!==t&&(l.unregister(),n.delete(o))}disposed(){var e;(e=this.placeholderSelectedLayerPanel)==null||e.call(this);for(const{unregister:t}of this.layerSidePanels.values())t()}}const v6={...ao,side:"left",row:0};class y6{constructor(){this.location=new wr(v6)}get changed(){return this.location.changed}restoreState(e){e!==void 0&&this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Oa(this.location.toJSON())}}class S6 extends K{constructor(e){super(),this.layer=e,this.element=document.createElement("div");const{element:t}=this,n=$e({svg:h6,title:"Hide layer",onClick:()=>{this.layer.setVisible(!1)}}),s=$e({svg:yT,title:"Show layer",onClick:()=>{this.layer.setVisible(!0)}});t.appendChild(s),t.appendChild(n);const r=()=>{const o=this.layer.visible;n.style.display=o?"":"none",s.style.display=o?"none":""};r(),this.registerDisposer(e.layerChanged.add(r))}}function b6(i){const{selectedLayer:e}=i.manager.root,t=new Kn({get value(){return e.layer===i&&e.visible},set value(n){n?(e.layer=i,e.visible=!0):e.visible=!1},changed:e.changed},{backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel",svg:qL});return t.element.classList.add("neuroglancer-layer-list-panel-item-controls"),t}class w6 extends K{constructor(e,t){super(),this.panel=e,this.layer=t,this.element=document.createElement("div"),this.numberElement=document.createElement("div"),this.generation=-1;const{element:n,numberElement:s}=this;n.classList.add("neuroglancer-layer-list-panel-item"),s.classList.add("neuroglancer-layer-list-panel-item-number"),n.appendChild(this.registerDisposer(new Es({get value(){return!t.archived},set value(o){t.setArchived(!o)},changed:t.layerChanged},{enableTitle:"Archive layer (disable and remove from layer groups)",disableTitle:"Unarchive layer (enable and add to all layer groups)"})).element),n.appendChild(s),n.appendChild(this.registerDisposer(new S6(t)).element),n.appendChild(this.registerDisposer(new yD(t)).element),n.appendChild(this.registerDisposer(b6(t)).element);const r=vs({title:"Delete layer",onClick:()=>{Fa(this.layer)}});r.classList.add("neuroglancer-layer-list-panel-item-delete"),n.appendChild(r),fD(e,n,t,{isLayerListPanel:!0,getLayoutSpec:()=>{}}),lf(e,n,t,!0),n.addEventListener("click",o=>{o.ctrlKey?(e.selectedLayer.toggle(t),o.preventDefault()):o.altKey&&(t.pickEnabled=!t.pickEnabled,o.preventDefault())}),n.addEventListener("contextmenu",o=>{e.selectedLayer.toggle(t),o.stopPropagation(),o.preventDefault()})}}class C6 extends ho{constructor(e,t,n){super(e,n.location),this.manager=t,this.state=n,this.items=new Map,this.itemContainer=document.createElement("div"),this.layerDropZone=document.createElement("div"),this.dragEnterCount=0,this.generation=-1;const{itemContainer:s,layerDropZone:r}=this,{titleElement:o}=this.addTitleBar({title:""});this.titleElement=o,s.classList.add("neuroglancer-layer-list-panel-items"),this.addBody(s),r.style.flex="1";const l=this.registerCancellable(et(()=>this.render()));this.visibility.changed.add(l),this.registerDisposer(this.layerManager.layersChanged.add(l)),this.registerDisposer(this.selectedLayer.changed.add(l)),pD(this),lf(this,r,void 0,!0),this.render()}get layerManager(){return this.manager.layerManager}get selectedLayer(){return this.manager.selectedLayer}render(){const e=this,t=this.selectedLayer.layer,n=++this.generation;let s=0,r=0,o=0;this.layerManager.updateNonArchivedLayerIndices();function*l(){const{items:u}=e;let h=0;for(const v of e.layerManager.managedLayers)v.archived||++h;const g=`${(h+1).toString().length}ch`;for(const v of e.layerManager.managedLayers){v.visible?++s:v.archived?++o:++r;let y=u.get(v);y===void 0&&(y=e.registerDisposer(new w6(e,v)),u.set(v,y)),y.generation=n;const{nonArchivedLayerIndex:b}=v;y.numberElement.style.width=g,b===-1?y.numberElement.style.visibility="hidden":(y.numberElement.style.visibility="",y.numberElement.textContent=`${b+1}`),y.element.dataset.selected=(v===t).toString(),y.element.dataset.archived=v.archived.toString(),yield y.element}for(const[v,y]of u)n!==y.generation&&(u.delete(v),e.unregisterDisposer(y),y.dispose());yield e.layerDropZone}si(this.itemContainer,l());let c="Layers";if(s||r||o){c+=" (";let u="";s+r&&(c+=`${s}/${r+s} visible`,u=", "),o&&(c+=`${u}${o} archived`),c+=")"}this.titleElement.textContent=c}}class x6 extends K{constructor(e){super(),this.layerManager=e,this.element=document.createElement("div");const t=this.registerCancellable(et(()=>this.render()));this.registerDisposer(e.layersChanged.add(t)),this.render()}render(){let e=0;const{managedLayers:t}=this.layerManager;for(const s of t)s.archived&&++e;const{element:n}=this;if(e!==0){const s=t.length;n.textContent=`${s-e}/${s}`}else n.textContent=""}}(function(i,e){(function(t){t($a())})(function(t){t.defineMode("javascript",function(n,s){var r=n.indentUnit,o=s.statementIndent,l=s.jsonld,c=s.json||l,u=s.trackScope!==!1,h=s.typescript,g=s.wordCharacters||/[\w$\xa1-\uffff]/,v=function(){function M(Ot){return{type:Ot,style:"keyword"}}var G=M("keyword a"),te=M("keyword b"),ae=M("keyword c"),Q=M("keyword d"),he=M("operator"),Ye={type:"atom",style:"atom"};return{if:M("if"),while:G,with:G,else:te,do:te,try:te,finally:te,return:Q,break:Q,continue:Q,new:M("new"),delete:ae,void:ae,throw:ae,debugger:M("debugger"),var:M("var"),const:M("var"),let:M("var"),function:M("function"),catch:M("catch"),for:M("for"),switch:M("switch"),case:M("case"),default:M("default"),in:he,typeof:he,instanceof:he,true:Ye,false:Ye,null:Ye,undefined:Ye,NaN:Ye,Infinity:Ye,this:M("this"),class:M("class"),super:M("atom"),yield:ae,export:M("export"),import:M("import"),extends:ae,await:ae}}(),y=/[+\-*&%=<>!?|~^@]/,b=/^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;function w(M){for(var G=!1,te,ae=!1;(te=M.next())!=null;){if(!G){if(te=="/"&&!ae)return;te=="["?ae=!0:ae&&te=="]"&&(ae=!1)}G=!G&&te=="\\"}}var C,E;function k(M,G,te){return C=M,E=te,G}function D(M,G){var te=M.next();if(te=='"'||te=="'")return G.tokenize=A(te),G.tokenize(M,G);if(te=="."&&M.match(/^\d[\d_]*(?:[eE][+\-]?[\d_]+)?/))return k("number","number");if(te=="."&&M.match(".."))return k("spread","meta");if(/[\[\]{}\(\),;\:\.]/.test(te))return k(te);if(te=="="&&M.eat(">"))return k("=>","operator");if(te=="0"&&M.match(/^(?:x[\dA-Fa-f_]+|o[0-7_]+|b[01_]+)n?/))return k("number","number");if(/\d/.test(te))return M.match(/^[\d_]*(?:n|(?:\.[\d_]*)?(?:[eE][+\-]?[\d_]+)?)?/),k("number","number");if(te=="/")return M.eat("*")?(G.tokenize=N,N(M,G)):M.eat("/")?(M.skipToEnd(),k("comment","comment")):Rn(M,G,1)?(w(M),M.match(/^\b(([gimyus])(?![gimyus]*\2))+\b/),k("regexp","string-2")):(M.eat("="),k("operator","operator",M.current()));if(te=="`")return G.tokenize=I,I(M,G);if(te=="#"&&M.peek()=="!")return M.skipToEnd(),k("meta","meta");if(te=="#"&&M.eatWhile(g))return k("variable","property");if(te=="<"&&M.match("!--")||te=="-"&&M.match("->")&&!/\S/.test(M.string.slice(0,M.start)))return M.skipToEnd(),k("comment","comment");if(y.test(te))return(te!=">"||!G.lexical||G.lexical.type!=">")&&(M.eat("=")?(te=="!"||te=="=")&&M.eat("="):/[<>*+\-|&?]/.test(te)&&(M.eat(te),te==">"&&M.eat(te))),te=="?"&&M.eat(".")?k("."):k("operator","operator",M.current());if(g.test(te)){M.eatWhile(g);var ae=M.current();if(G.lastType!="."){if(v.propertyIsEnumerable(ae)){var Q=v[ae];return k(Q.type,Q.style,ae)}if(ae=="async"&&M.match(/^(\s|\/\*([^*]|\*(?!\/))*?\*\/)*[\[\(\w]/,!1))return k("async","keyword",ae)}return k("variable","variable",ae)}}function A(M){return function(G,te){var ae=!1,Q;if(l&&G.peek()=="@"&&G.match(b))return te.tokenize=D,k("jsonld-keyword","meta");for(;(Q=G.next())!=null&&!(Q==M&&!ae);)ae=!ae&&Q=="\\";return ae||(te.tokenize=D),k("string","string")}}function N(M,G){for(var te=!1,ae;ae=M.next();){if(ae=="/"&&te){G.tokenize=D;break}te=ae=="*"}return k("comment","comment")}function I(M,G){for(var te=!1,ae;(ae=M.next())!=null;){if(!te&&(ae=="`"||ae=="$"&&M.eat("{"))){G.tokenize=D;break}te=!te&&ae=="\\"}return k("quasi","string-2",M.current())}var P="([{}])";function O(M,G){G.fatArrowAt&&(G.fatArrowAt=null);var te=M.string.indexOf("=>",M.start);if(!(te<0)){if(h){var ae=/:\s*(?:\w+(?:<[^>]*>|\[\])?|\{[^}]*\})\s*$/.exec(M.string.slice(M.start,te));ae&&(te=ae.index)}for(var Q=0,he=!1,Ye=te-1;Ye>=0;--Ye){var Ot=M.string.charAt(Ye),gn=P.indexOf(Ot);if(gn>=0&&gn<3){if(!Q){++Ye;break}if(--Q==0){Ot=="("&&(he=!0);break}}else if(gn>=3&&gn<6)++Q;else if(g.test(Ot))he=!0;else if(/["'\/`]/.test(Ot))for(;;--Ye){if(Ye==0)return;var Eo=M.string.charAt(Ye-1);if(Eo==Ot&&M.string.charAt(Ye-2)!="\\"){Ye--;break}}else if(he&&!Q){++Ye;break}}he&&!Q&&(G.fatArrowAt=Ye)}}var _={atom:!0,number:!0,variable:!0,string:!0,regexp:!0,this:!0,import:!0,"jsonld-keyword":!0};function W(M,G,te,ae,Q,he){this.indented=M,this.column=G,this.type=te,this.prev=Q,this.info=he,ae!=null&&(this.align=ae)}function U(M,G){if(!u)return!1;for(var te=M.localVars;te;te=te.next)if(te.name==G)return!0;for(var ae=M.context;ae;ae=ae.prev)for(var te=ae.vars;te;te=te.next)if(te.name==G)return!0}function j(M,G,te,ae,Q){var he=M.cc;for(B.state=M,B.stream=Q,B.marked=null,B.cc=he,B.style=G,M.lexical.hasOwnProperty("align")||(M.lexical.align=!0);;){var Ye=he.length?he.pop():c?Ae:Ce;if(Ye(te,ae)){for(;he.length&&he[he.length-1].lex;)he.pop()();return B.marked?B.marked:te=="variable"&&U(M,ae)?"variable-2":G}}}var B={state:null,column:null,marked:null,cc:null};function H(){for(var M=arguments.length-1;M>=0;M--)B.cc.push(arguments[M])}function V(){return H.apply(null,arguments),!0}function re(M,G){for(var te=G;te;te=te.next)if(te.name==M)return!0;return!1}function se(M){var G=B.state;if(B.marked="def",!!u){if(G.context){if(G.lexical.info=="var"&&G.context&&G.context.block){var te=ve(M,G.context);if(te!=null){G.context=te;return}}else if(!re(M,G.localVars)){G.localVars=new We(M,G.localVars);return}}s.globalVars&&!re(M,G.globalVars)&&(G.globalVars=new We(M,G.globalVars))}}function ve(M,G){if(G)if(G.block){var te=ve(M,G.prev);return te?te==G.prev?G:new Ie(te,G.vars,!0):null}else return re(M,G.vars)?G:new Ie(G.prev,new We(M,G.vars),!1);else return null}function me(M){return M=="public"||M=="private"||M=="protected"||M=="abstract"||M=="readonly"}function Ie(M,G,te){this.prev=M,this.vars=G,this.block=te}function We(M,G){this.name=M,this.next=G}var tt=new We("this",new We("arguments",null));function rt(){B.state.context=new Ie(B.state.context,B.state.localVars,!1),B.state.localVars=tt}function nt(){B.state.context=new Ie(B.state.context,B.state.localVars,!0),B.state.localVars=null}rt.lex=nt.lex=!0;function Ge(){B.state.localVars=B.state.context.vars,B.state.context=B.state.context.prev}Ge.lex=!0;function Te(M,G){var te=function(){var ae=B.state,Q=ae.indented;if(ae.lexical.type=="stat")Q=ae.lexical.indented;else for(var he=ae.lexical;he&&he.type==")"&&he.align;he=he.prev)Q=he.indented;ae.lexical=new W(Q,B.stream.column(),M,null,ae.lexical,G)};return te.lex=!0,te}function Se(){var M=B.state;M.lexical.prev&&(M.lexical.type==")"&&(M.indented=M.lexical.indented),M.lexical=M.lexical.prev)}Se.lex=!0;function ge(M){function G(te){return te==M?V():M==";"||te=="}"||te==")"||te=="]"?H():V(G)}return G}function Ce(M,G){return M=="var"?V(Te("vardef",G),vo,ge(";"),Se):M=="keyword a"?V(Te("form"),Ri,Ce,Se):M=="keyword b"?V(Te("form"),Ce,Se):M=="keyword d"?B.stream.match(/^\s*$/,!1)?V():V(Te("stat"),Fn,ge(";"),Se):M=="debugger"?V(ge(";")):M=="{"?V(Te("}"),nt,Mi,Se,Ge):M==";"?V():M=="if"?(B.state.lexical.info=="else"&&B.state.cc[B.state.cc.length-1]==Se&&B.state.cc.pop()(),V(Te("form"),Ri,Ce,Se,yo)):M=="function"?V(Gn):M=="for"?V(Te("form"),nt,Qc,Ce,Ge,Se):M=="class"||h&&G=="interface"?(B.marked="keyword",V(Te("form",M=="class"?M:G),So,Se)):M=="variable"?h&&G=="declare"?(B.marked="keyword",V(Ce)):h&&(G=="module"||G=="enum"||G=="type")&&B.stream.match(/^\s*\w/,!1)?(B.marked="keyword",G=="enum"?V(be):G=="type"?V(Zc,ge("operator"),Be,ge(";")):V(Te("form"),pn,ge("{"),Te("}"),Mi,Se,Se)):h&&G=="namespace"?(B.marked="keyword",V(Te("form"),Ae,Ce,Se)):h&&G=="abstract"?(B.marked="keyword",V(Ce)):V(Te("stat"),Ni):M=="switch"?V(Te("form"),Ri,ge("{"),Te("}","switch"),nt,Mi,Se,Se,Ge):M=="case"?V(Ae,ge(":")):M=="default"?V(ge(":")):M=="catch"?V(Te("form"),rt,ot,Ce,Se,Ge):M=="export"?V(Te("stat"),bo,Se):M=="import"?V(Te("stat"),Gs,Se):M=="async"?V(Ce):G=="@"?V(Ae,Ce):H(Te("stat"),Ae,ge(";"),Se)}function ot(M){if(M=="(")return V(gi,ge(")"))}function Ae(M,G){return hn(M,G,!1)}function Nt(M,G){return hn(M,G,!0)}function Ri(M){return M!="("?H():V(Te(")"),Fn,ge(")"),Se)}function hn(M,G,te){if(B.state.fatArrowAt==B.stream.start){var ae=te?Un:Oe;if(M=="(")return V(rt,Te(")"),Lt(gi,")"),Se,ge("=>"),ae,Ge);if(M=="variable")return H(rt,pn,ge("=>"),ae,Ge)}var Q=te?sn:nn;return _.hasOwnProperty(M)?V(Q):M=="function"?V(Gn,Q):M=="class"||h&&G=="interface"?(B.marked="keyword",V(Te("form"),uf,Se)):M=="keyword c"||M=="async"?V(te?Nt:Ae):M=="("?V(Te(")"),Fn,ge(")"),Se,Q):M=="operator"||M=="spread"?V(te?Nt:Ae):M=="["?V(Te("]"),yt,Se,Q):M=="{"?_s(hi,"}",null,Q):M=="quasi"?H(fn,Q):M=="new"?V(Ns(te)):V()}function Fn(M){return M.match(/[;\}\)\],]/)?H():H(Ae)}function nn(M,G){return M==","?V(Fn):sn(M,G,!1)}function sn(M,G,te){var ae=te==!1?nn:sn,Q=te==!1?Ae:Nt;if(M=="=>")return V(rt,te?Un:Oe,Ge);if(M=="operator")return/\+\+|--/.test(G)||h&&G=="!"?V(ae):h&&G=="<"&&B.stream.match(/^([^<>]|<[^<>]*>)*>\s*\(/,!1)?V(Te(">"),Lt(Be,">"),Se,ae):G=="?"?V(Ae,ge(":"),Q):V(Q);if(M=="quasi")return H(fn,ae);if(M!=";"){if(M=="(")return _s(Nt,")","call",ae);if(M==".")return V(Cr,ae);if(M=="[")return V(Te("]"),Fn,ge("]"),Se,ae);if(h&&G=="as")return B.marked="keyword",V(Be,ae);if(M=="regexp")return B.state.lastType=B.marked="operator",B.stream.backUp(B.stream.pos-B.stream.start-1),V(Q)}}function fn(M,G){return M!="quasi"?H():G.slice(G.length-2)!="${"?V(fn):V(Fn,ui)}function ui(M){if(M=="}")return B.marked="string-2",B.state.tokenize=I,V(fn)}function Oe(M){return O(B.stream,B.state),H(M=="{"?Ce:Ae)}function Un(M){return O(B.stream,B.state),H(M=="{"?Ce:Nt)}function Ns(M){return function(G){return G=="."?V(M?Ms:ja):G=="variable"&&h?V(Tn,M?sn:nn):H(M?Nt:Ae)}}function ja(M,G){if(G=="target")return B.marked="keyword",V(nn)}function Ms(M,G){if(G=="target")return B.marked="keyword",V(sn)}function Ni(M){return M==":"?V(Se,Ce):H(nn,ge(";"),Se)}function Cr(M){if(M=="variable")return B.marked="property",V()}function hi(M,G){if(M=="async")return B.marked="property",V(hi);if(M=="variable"||B.style=="keyword"){if(B.marked="property",G=="get"||G=="set")return V(Os);var te;return h&&B.state.fatArrowAt==B.stream.start&&(te=B.stream.match(/^\s*:\s*/,!1))&&(B.state.fatArrowAt=B.stream.pos+te[0].length),V(Xi)}else{if(M=="number"||M=="string")return B.marked=l?"property":B.style+" property",V(Xi);if(M=="jsonld-keyword")return V(Xi);if(h&&me(G))return B.marked="keyword",V(hi);if(M=="[")return V(Ae,Vs,ge("]"),Xi);if(M=="spread")return V(Nt,Xi);if(G=="*")return B.marked="keyword",V(hi);if(M==":")return H(Xi)}}function Os(M){return M!="variable"?H(Xi):(B.marked="property",V(Gn))}function Xi(M){if(M==":")return V(Nt);if(M=="(")return H(Gn)}function Lt(M,G,te){function ae(Q,he){if(te?te.indexOf(Q)>-1:Q==","){var Ye=B.state.lexical;return Ye.info=="call"&&(Ye.pos=(Ye.pos||0)+1),V(function(Ot,gn){return Ot==G||gn==G?H():H(M)},ae)}return Q==G||he==G?V():te&&te.indexOf(";")>-1?H(M):V(ge(G))}return function(Q,he){return Q==G||he==G?V():H(M,ae)}}function _s(M,G,te){for(var ae=3;ae<arguments.length;ae++)B.cc.push(arguments[ae]);return V(Te(G,te),Lt(M,G),Se)}function Mi(M){return M=="}"?V():H(Ce,Mi)}function Vs(M,G){if(h){if(M==":")return V(Be);if(G=="?")return V(Vs)}}function xr(M,G){if(h&&(M==":"||G=="in"))return V(Be)}function Bs(M){if(h&&M==":")return B.stream.match(/^\s*\w+\s+is\b/,!1)?V(Ae,cf,Be):V(Be)}function cf(M,G){if(G=="is")return B.marked="keyword",V()}function Be(M,G){if(G=="keyof"||G=="typeof"||G=="infer"||G=="readonly")return B.marked="keyword",V(G=="typeof"?Nt:Be);if(M=="variable"||G=="void")return B.marked="type",V(zn);if(G=="|"||G=="&")return V(Be);if(M=="string"||M=="number"||M=="atom")return V(zn);if(M=="[")return V(Te("]"),Lt(Be,"]",","),Se,zn);if(M=="{")return V(Te("}"),ke,Se,zn);if(M=="(")return V(Lt(vt,")"),Xc,zn);if(M=="<")return V(Lt(Be,">"),Be);if(M=="quasi")return H(Yt,zn)}function Xc(M){if(M=="=>")return V(Be)}function ke(M){return M.match(/[\}\)\]]/)?V():M==","||M==";"?V(ke):H(Qi,ke)}function Qi(M,G){if(M=="variable"||B.style=="keyword")return B.marked="property",V(Qi);if(G=="?"||M=="number"||M=="string")return V(Qi);if(M==":")return V(Be);if(M=="[")return V(ge("variable"),xr,ge("]"),Qi);if(M=="(")return H(zs,Qi);if(!M.match(/[;\}\)\],]/))return V()}function Yt(M,G){return M!="quasi"?H():G.slice(G.length-2)!="${"?V(Yt):V(Be,mt)}function mt(M){if(M=="}")return B.marked="string-2",B.state.tokenize=I,V(Yt)}function vt(M,G){return M=="variable"&&B.stream.match(/^\s*[?:]/,!1)||G=="?"?V(vt):M==":"?V(Be):M=="spread"?V(vt):H(Be)}function zn(M,G){if(G=="<")return V(Te(">"),Lt(Be,">"),Se,zn);if(G=="|"||M=="."||G=="&")return V(Be);if(M=="[")return V(Be,ge("]"),zn);if(G=="extends"||G=="implements")return B.marked="keyword",V(Be);if(G=="?")return V(Be,ge(":"),Be)}function Tn(M,G){if(G=="<")return V(Te(">"),Lt(Be,">"),Se,zn)}function fi(){return H(Be,qt)}function qt(M,G){if(G=="=")return V(Be)}function vo(M,G){return G=="enum"?(B.marked="keyword",V(be)):H(pn,Vs,pi,df)}function pn(M,G){if(h&&me(G))return B.marked="keyword",V(pn);if(M=="variable")return se(G),V();if(M=="spread")return V(pn);if(M=="[")return _s(Ya,"]");if(M=="{")return _s(Fs,"}")}function Fs(M,G){return M=="variable"&&!B.stream.match(/^\s*:/,!1)?(se(G),V(pi)):(M=="variable"&&(B.marked="property"),M=="spread"?V(pn):M=="}"?H():M=="["?V(Ae,ge("]"),ge(":"),Fs):V(ge(":"),pn,pi))}function Ya(){return H(pn,pi)}function pi(M,G){if(G=="=")return V(Nt)}function df(M){if(M==",")return V(vo)}function yo(M,G){if(M=="keyword b"&&G=="else")return V(Te("form","else"),Ce,Se)}function Qc(M,G){if(G=="await")return V(Qc);if(M=="(")return V(Te(")"),qa,Se)}function qa(M){return M=="var"?V(vo,Us):M=="variable"?V(Us):H(Us)}function Us(M,G){return M==")"?V():M==";"?V(Us):G=="in"||G=="of"?(B.marked="keyword",V(Ae,Us)):H(Ae,Us)}function Gn(M,G){if(G=="*")return B.marked="keyword",V(Gn);if(M=="variable")return se(G),V(Gn);if(M=="(")return V(rt,Te(")"),Lt(gi,")"),Se,Bs,Ce,Ge);if(h&&G=="<")return V(Te(">"),Lt(fi,">"),Se,Gn)}function zs(M,G){if(G=="*")return B.marked="keyword",V(zs);if(M=="variable")return se(G),V(zs);if(M=="(")return V(rt,Te(")"),Lt(gi,")"),Se,Bs,Ge);if(h&&G=="<")return V(Te(">"),Lt(fi,">"),Se,zs)}function Zc(M,G){if(M=="keyword"||M=="variable")return B.marked="type",V(Zc);if(G=="<")return V(Te(">"),Lt(fi,">"),Se)}function gi(M,G){return G=="@"&&V(Ae,gi),M=="spread"?V(gi):h&&me(G)?(B.marked="keyword",V(gi)):h&&M=="this"?V(Vs,pi):H(pn,Vs,pi)}function uf(M,G){return M=="variable"?So(M,G):mi(M,G)}function So(M,G){if(M=="variable")return se(G),V(mi)}function mi(M,G){if(G=="<")return V(Te(">"),Lt(fi,">"),Se,mi);if(G=="extends"||G=="implements"||h&&M==",")return G=="implements"&&(B.marked="keyword"),V(h?Be:Ae,mi);if(M=="{")return V(Te("}"),vi,Se)}function vi(M,G){if(M=="async"||M=="variable"&&(G=="static"||G=="get"||G=="set"||h&&me(G))&&B.stream.match(/^\s+#?[\w$\xa1-\uffff]/,!1))return B.marked="keyword",V(vi);if(M=="variable"||B.style=="keyword")return B.marked="property",V(Er,vi);if(M=="number"||M=="string")return V(Er,vi);if(M=="[")return V(Ae,Vs,ge("]"),Er,vi);if(G=="*")return B.marked="keyword",V(vi);if(h&&M=="(")return H(zs,vi);if(M==";"||M==",")return V(vi);if(M=="}")return V();if(G=="@")return V(Ae,vi)}function Er(M,G){if(G=="!"||G=="?")return V(Er);if(M==":")return V(Be,pi);if(G=="=")return V(Nt);var te=B.state.lexical.prev,ae=te&&te.info=="interface";return H(ae?zs:Gn)}function bo(M,G){return G=="*"?(B.marked="keyword",V(xo,ge(";"))):G=="default"?(B.marked="keyword",V(Ae,ge(";"))):M=="{"?V(Lt(wo,"}"),xo,ge(";")):H(Ce)}function wo(M,G){if(G=="as")return B.marked="keyword",V(ge("variable"));if(M=="variable")return H(Nt,wo)}function Gs(M){return M=="string"?V():M=="("?H(Ae):M=="."?H(nn):H(Co,Oi,xo)}function Co(M,G){return M=="{"?_s(Co,"}"):(M=="variable"&&se(G),G=="*"&&(B.marked="keyword"),V(Ka))}function Oi(M){if(M==",")return V(Co,Oi)}function Ka(M,G){if(G=="as")return B.marked="keyword",V(Co)}function xo(M,G){if(G=="from")return B.marked="keyword",V(Ae)}function yt(M){return M=="]"?V():H(Lt(Nt,"]"))}function be(){return H(Te("form"),pn,ge("{"),Te("}"),Lt(Zi,"}"),Se,Se)}function Zi(){return H(pn,pi)}function Xa(M,G){return M.lastType=="operator"||M.lastType==","||y.test(G.charAt(0))||/[,.]/.test(G.charAt(0))}function Rn(M,G,te){return G.tokenize==D&&/^(?:operator|sof|keyword [bcd]|case|new|export|default|spread|[\[{}\(,;:]|=>)$/.test(G.lastType)||G.lastType=="quasi"&&/\{\s*$/.test(M.string.slice(0,M.pos-(te||0)))}return{startState:function(M){var G={tokenize:D,lastType:"sof",cc:[],lexical:new W((M||0)-r,0,"block",!1),localVars:s.localVars,context:s.localVars&&new Ie(null,null,!1),indented:M||0};return s.globalVars&&typeof s.globalVars=="object"&&(G.globalVars=s.globalVars),G},token:function(M,G){if(M.sol()&&(G.lexical.hasOwnProperty("align")||(G.lexical.align=!1),G.indented=M.indentation(),O(M,G)),G.tokenize!=N&&M.eatSpace())return null;var te=G.tokenize(M,G);return C=="comment"?te:(G.lastType=C=="operator"&&(E=="++"||E=="--")?"incdec":C,j(G,te,C,E,M))},indent:function(M,G){if(M.tokenize==N||M.tokenize==I)return t.Pass;if(M.tokenize!=D)return 0;var te=G&&G.charAt(0),ae=M.lexical,Q;if(!/^\s*else\b/.test(G))for(var he=M.cc.length-1;he>=0;--he){var Ye=M.cc[he];if(Ye==Se)ae=ae.prev;else if(Ye!=yo&&Ye!=Ge)break}for(;(ae.type=="stat"||ae.type=="form")&&(te=="}"||(Q=M.cc[M.cc.length-1])&&(Q==nn||Q==sn)&&!/^[,\.=+\-*:?[\(]/.test(G));)ae=ae.prev;o&&ae.type==")"&&ae.prev.type=="stat"&&(ae=ae.prev);var Ot=ae.type,gn=te==Ot;return Ot=="vardef"?ae.indented+(M.lastType=="operator"||M.lastType==","?ae.info.length+1:0):Ot=="form"&&te=="{"?ae.indented:Ot=="form"?ae.indented+r:Ot=="stat"?ae.indented+(Xa(M,G)?o||r:0):ae.info=="switch"&&!gn&&s.doubleIndentSwitch!=!1?ae.indented+(/^(?:case|default)\b/.test(G)?r:2*r):ae.align?ae.column+(gn?0:1):ae.indented+(gn?0:r)},electricInput:/^\s*(?:case .*?:|default:|\{|\})$/,blockCommentStart:c?null:"/*",blockCommentEnd:c?null:"*/",blockCommentContinue:c?null:" * ",lineComment:c?null:"//",fold:"brace",closeBrackets:"()[]{}''\"\"``",helperType:c?"json":"javascript",jsonldMode:l,jsonMode:c,expressionAllowed:Rn,skipExpression:function(M){j(M,"atom","atom","true",new t.StringStream("",2,null))}}}),t.registerHelper("wordChars","javascript",/[\w$]/),t.defineMIME("text/javascript","javascript"),t.defineMIME("text/ecmascript","javascript"),t.defineMIME("application/javascript","javascript"),t.defineMIME("application/x-javascript","javascript"),t.defineMIME("application/ecmascript","javascript"),t.defineMIME("application/json",{name:"javascript",json:!0}),t.defineMIME("application/x-json",{name:"javascript",json:!0}),t.defineMIME("application/manifest+json",{name:"javascript",json:!0}),t.defineMIME("application/ld+json",{name:"javascript",jsonld:!0}),t.defineMIME("text/typescript",{name:"javascript",typescript:!0}),t.defineMIME("application/typescript",{name:"javascript",typescript:!0})})})();var E6={exports:{}};(function(i,e){(function(t){t($a())})(function(t){function n(l,c,u,h){if(u&&u.call){var g=u;u=null}else var g=o(l,u,"rangeFinder");typeof c=="number"&&(c=t.Pos(c,0));var v=o(l,u,"minFoldSize");function y(E){var k=g(l,c);if(!k||k.to.line-k.from.line<v)return null;if(h==="fold")return k;for(var D=l.findMarksAt(k.from),A=0;A<D.length;++A)if(D[A].__isFold){if(!E)return null;k.cleared=!0,D[A].clear()}return k}var b=y(!0);if(o(l,u,"scanUp"))for(;!b&&c.line>l.firstLine();)c=t.Pos(c.line-1,0),b=y(!1);if(!(!b||b.cleared||h==="unfold")){var w=s(l,u,b);t.on(w,"mousedown",function(E){C.clear(),t.e_preventDefault(E)});var C=l.markText(b.from,b.to,{replacedWith:w,clearOnEnter:o(l,u,"clearOnEnter"),__isFold:!0});C.on("clear",function(E,k){t.signal(l,"unfold",l,E,k)}),t.signal(l,"fold",l,b.from,b.to)}}function s(l,c,u){var h=o(l,c,"widget");if(typeof h=="function"&&(h=h(u.from,u.to)),typeof h=="string"){var g=document.createTextNode(h);h=document.createElement("span"),h.appendChild(g),h.className="CodeMirror-foldmarker"}else h&&(h=h.cloneNode(!0));return h}t.newFoldFunction=function(l,c){return function(u,h){n(u,h,{rangeFinder:l,widget:c})}},t.defineExtension("foldCode",function(l,c,u){n(this,l,c,u)}),t.defineExtension("isFolded",function(l){for(var c=this.findMarksAt(l),u=0;u<c.length;++u)if(c[u].__isFold)return!0}),t.commands.toggleFold=function(l){l.foldCode(l.getCursor())},t.commands.fold=function(l){l.foldCode(l.getCursor(),null,"fold")},t.commands.unfold=function(l){l.foldCode(l.getCursor(),{scanUp:!1},"unfold")},t.commands.foldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"fold")})},t.commands.unfoldAll=function(l){l.operation(function(){for(var c=l.firstLine(),u=l.lastLine();c<=u;c++)l.foldCode(t.Pos(c,0),{scanUp:!1},"unfold")})},t.registerHelper("fold","combine",function(){var l=Array.prototype.slice.call(arguments,0);return function(c,u){for(var h=0;h<l.length;++h){var g=l[h](c,u);if(g)return g}}}),t.registerHelper("fold","auto",function(l,c){for(var u=l.getHelpers(c,"fold"),h=0;h<u.length;h++){var g=u[h](l,c);if(g)return g}});var r={rangeFinder:t.fold.auto,widget:"↔",minFoldSize:0,scanUp:!1,clearOnEnter:!0};t.defineOption("foldOptions",null);function o(l,c,u){if(c&&c[u]!==void 0)return c[u];var h=l.options.foldOptions;return h&&h[u]!==void 0?h[u]:r[u]}t.defineExtension("foldOption",function(l,c){return o(this,l,c)})})})();var T6=E6.exports;(function(i,e){(function(t){t($a(),T6)})(function(t){t.defineOption("foldGutter",!1,function(C,E,k){k&&k!=t.Init&&(C.clearGutter(C.state.foldGutter.options.gutter),C.state.foldGutter=null,C.off("gutterClick",g),C.off("changes",y),C.off("viewportChange",b),C.off("fold",w),C.off("unfold",w),C.off("swapDoc",y),C.off("optionChange",v)),E&&(C.state.foldGutter=new s(r(E)),h(C),C.on("gutterClick",g),C.on("changes",y),C.on("viewportChange",b),C.on("fold",w),C.on("unfold",w),C.on("swapDoc",y),C.on("optionChange",v))});var n=t.Pos;function s(C){this.options=C,this.from=this.to=0}function r(C){return C===!0&&(C={}),C.gutter==null&&(C.gutter="CodeMirror-foldgutter"),C.indicatorOpen==null&&(C.indicatorOpen="CodeMirror-foldgutter-open"),C.indicatorFolded==null&&(C.indicatorFolded="CodeMirror-foldgutter-folded"),C}function o(C,E){for(var k=C.findMarks(n(E,0),n(E+1,0)),D=0;D<k.length;++D)if(k[D].__isFold){var A=k[D].find(-1);if(A&&A.line===E)return k[D]}}function l(C){if(typeof C=="string"){var E=document.createElement("div");return E.className=C+" CodeMirror-guttermarker-subtle",E}else return C.cloneNode(!0)}function c(C,E,k){var D=C.state.foldGutter.options,A=E-1,N=C.foldOption(D,"minFoldSize"),I=C.foldOption(D,"rangeFinder"),P=typeof D.indicatorFolded=="string"&&u(D.indicatorFolded),O=typeof D.indicatorOpen=="string"&&u(D.indicatorOpen);C.eachLine(E,k,function(_){++A;var W=null,U=_.gutterMarkers;if(U&&(U=U[D.gutter]),o(C,A)){if(P&&U&&P.test(U.className))return;W=l(D.indicatorFolded)}else{var j=n(A,0),B=I&&I(C,j);if(B&&B.to.line-B.from.line>=N){if(O&&U&&O.test(U.className))return;W=l(D.indicatorOpen)}}!W&&!U||C.setGutterMarker(_,D.gutter,W)})}function u(C){return new RegExp("(^|\\s)"+C+"(?:$|\\s)\\s*")}function h(C){var E=C.getViewport(),k=C.state.foldGutter;k&&(C.operation(function(){c(C,E.from,E.to)}),k.from=E.from,k.to=E.to)}function g(C,E,k){var D=C.state.foldGutter;if(D){var A=D.options;if(k==A.gutter){var N=o(C,E);N?N.clear():C.foldCode(n(E,0),A)}}}function v(C,E){E=="mode"&&y(C)}function y(C){var E=C.state.foldGutter;if(E){var k=E.options;E.from=E.to=0,clearTimeout(E.changeUpdate),E.changeUpdate=setTimeout(function(){h(C)},k.foldOnChangeTimeSpan||600)}}function b(C){var E=C.state.foldGutter;if(E){var k=E.options;clearTimeout(E.changeUpdate),E.changeUpdate=setTimeout(function(){var D=C.getViewport();E.from==E.to||D.from-E.to>20||E.from-D.to>20?h(C):C.operation(function(){D.from<E.from&&(c(C,D.from,E.from),E.from=D.from),D.to>E.to&&(c(C,E.to,D.to),E.to=D.to)})},k.updateViewportTimeSpan||400)}}function w(C,E){var k=C.state.foldGutter;if(k){var D=E.line;D>=k.from&&D<k.to&&c(C,D,D+1)}}})})();(function(i,e){(function(t){t($a())})(function(t){function n(s){return function(r,o){var l=o.line,c=r.getLine(l);function u(w){for(var C,E=o.ch,k=0;;){var D=E<=0?-1:c.lastIndexOf(w[0],E-1);if(D==-1){if(k==1)break;k=1,E=c.length;continue}if(k==1&&D<o.ch)break;if(C=r.getTokenTypeAt(t.Pos(l,D+1)),!/^(comment|string)/.test(C))return{ch:D+1,tokenType:C,pair:w};E=D-1}}function h(w){var C=1,E=r.lastLine(),k,D=w.ch,A;e:for(var N=l;N<=E;++N)for(var I=r.getLine(N),P=N==l?D:0;;){var O=I.indexOf(w.pair[0],P),_=I.indexOf(w.pair[1],P);if(O<0&&(O=I.length),_<0&&(_=I.length),P=Math.min(O,_),P==I.length)break;if(r.getTokenTypeAt(t.Pos(N,P+1))==w.tokenType){if(P==O)++C;else if(!--C){k=N,A=P;break e}}++P}return k==null||l==k?null:{from:t.Pos(l,D),to:t.Pos(k,A)}}for(var g=[],v=0;v<s.length;v++){var y=u(s[v]);y&&g.push(y)}g.sort(function(w,C){return w.ch-C.ch});for(var v=0;v<g.length;v++){var b=h(g[v]);if(b)return b}return null}}t.registerHelper("fold","brace",n([["{","}"],["[","]"]])),t.registerHelper("fold","brace-paren",n([["{","}"],["[","]"],["(",")"]])),t.registerHelper("fold","import",function(s,r){function o(v){if(v<s.firstLine()||v>s.lastLine())return null;var y=s.getTokenAt(t.Pos(v,1));if(/\S/.test(y.string)||(y=s.getTokenAt(t.Pos(v,y.end+1))),y.type!="keyword"||y.string!="import")return null;for(var b=v,w=Math.min(s.lastLine(),v+10);b<=w;++b){var C=s.getLine(b),E=C.indexOf(";");if(E!=-1)return{startCh:y.end,end:t.Pos(b,E)}}}var l=r.line,c=o(l),u;if(!c||o(l-1)||(u=o(l-2))&&u.end.line==l-1)return null;for(var h=c.end;;){var g=o(h.line+1);if(g==null)break;h=g.end}return{from:s.clipPos(t.Pos(l,c.startCh+1)),to:h}}),t.registerHelper("fold","include",function(s,r){function o(g){if(g<s.firstLine()||g>s.lastLine())return null;var v=s.getTokenAt(t.Pos(g,1));if(/\S/.test(v.string)||(v=s.getTokenAt(t.Pos(g,v.end+1))),v.type=="meta"&&v.string.slice(0,8)=="#include")return v.start+8}var l=r.line,c=o(l);if(c==null||o(l-1)!=null)return null;for(var u=l;;){var h=o(u+1);if(h==null)break;++u}return{from:t.Pos(l,c+1),to:s.clipPos(t.Pos(u))}})})})();const k6=100;class L6 extends Wc{constructor(e){super(),this.viewer=e,this.parsedValue=null,this.debouncedValueUpdater=ze(()=>{const r=this.textEditor.getValue();try{const o=JSON.parse(r);this.parsedValue=o,this.applyButton.disabled=!1,this.textEditor.setOption("lint",void 0)}catch(o){this.parsedValue=null,this.applyButton.disabled=!0;let l=0,c=0,u="Unknown parse error";if(o instanceof Error){const h=o.message.match(/^((?:.|\n)*) in JSON at position ([0-9]+)$/);if(h!==null){u=h[1];const g=parseInt(h[2],10),y=r.substring(0,g).split(`
`);l=y.length-1,c=y[y.length-1].length}else u=o.message}this.textEditor.setOption("lint",{getAnnotations:()=>[{message:u,severity:"error",from:or.Pos(l,c)}]})}},k6),this.content.classList.add("neuroglancer-state-editor");const t=this.applyButton=document.createElement("button");t.textContent="Apply changes",this.content.appendChild(t),t.addEventListener("click",()=>this.applyChanges()),t.disabled=!0;const n=this.closeButton=document.createElement("button");n.classList.add("close-button"),n.textContent="Close",this.content.appendChild(n),n.addEventListener("click",()=>this.dispose());const s=this.downloadButton=document.createElement("button");s.textContent="Download",s.title="Download state as a JSON file",this.content.appendChild(s),s.addEventListener("click",()=>this.downloadState()),this.textEditor=or(r=>{},{value:"",mode:{name:"javascript",json:!0},foldGutter:!0,gutters:["CodeMirror-lint-markers","CodeMirror-foldgutter"]}),this.updateView(),this.textEditor.on("change",()=>{this.debouncedValueUpdater()}),this.content.appendChild(this.textEditor.getWrapperElement()),this.textEditor.refresh()}downloadState(){const e=document.createElement("a"),t=new Blob([this.getJson()],{type:"text/json"}),n=URL.createObjectURL(t);e.href=n,e.download="state.json",e.click(),document.body.removeChild(e)}applyChanges(){this.parsedValue!==null&&(this.viewer.state.reset(),this.viewer.state.restoreState(this.parsedValue)),this.applyButton.disabled=!0}updateView(){this.textEditor.setValue(this.getJson()),this.textEditor.execCommand("foldAll"),this.textEditor.execCommand("unfold")}getJson(){return JSON.stringify(Ph(this.viewer.state).value,null,"  ")}}const D6={side:"bottom",size:100,minSize:50,row:0,col:0,flex:1,visible:!1};class I6{constructor(){this.location=new wr(D6)}get changed(){return this.location.changed}restoreState(e){this.location.restoreState(e)}reset(){this.location.reset()}toJSON(){return Oa(this.location.toJSON())}}function P6(i){const e=new Map;function t(n,s){if(n==null||typeof n!="object"){e.set(s,""+n);return}for(const r of Object.keys(n))t(n[r],s+"."+r)}return t(i,""),e}function A6(i){const e=new Set;e.add(".type");const t=new Set;function n(s,r){for(const o of e)if(i[s].get(o)!==i[r].get(o))return!0;return!1}for(let s=0,r=i.length;s<r;++s){for(const l of i[s].keys())t.add(l);let o=[];for(let l=0;l<s;++l)n(s,l)||o.push(l);for(;o.length>0;){let l=o,c;for(const u of t){if(e.has(u))continue;const h=[];for(const g of o)i[g].get(u)===i[s].get(u)&&h.push(g);if(h.length<l.length&&(l=h,c=u),h.length===0)break}if(c===void 0)break;o=l,e.add(c)}}return Array.from(e)}function R6(i,e){const t={};for(const n of e){const s=i.get(n);if(s!==void 0){if(n==="")return s;t[n]=s}}return JSON.stringify(t)}function N6(i){return Object.assign({type:i.RPC_TYPE_ID},i.key||{})}function M6(i){const e=i.map(P6),t=A6(e);return e.map(n=>R6(n,t))}const O6=1e3,Yp=[{label:"Visible chunks/T",key:"visibleChunksTotal",getter:i=>{let e=0;for(let t=0;t<c1;++t)e+=i[Or(t,tr.VISIBLE)*ir+nr.numChunks];return e}},{label:"Visible chunks/D",key:"visibleChunksDownloading",getter:i=>i[Or(je.DOWNLOADING,tr.VISIBLE)*ir+nr.numChunks]},{label:"Visible chunks/M",key:"visibleChunksSystemMemory",getter:i=>i[Or(je.SYSTEM_MEMORY,tr.VISIBLE)*ir+nr.numChunks]+i[Or(je.SYSTEM_MEMORY_WORKER,tr.VISIBLE)*ir+nr.numChunks]},{label:"Visible chunks/G",key:"visibleChunksGpuMemory",getter:i=>i[Or(je.GPU_MEMORY,tr.VISIBLE)*ir+nr.numChunks]},{label:"Visible chunks/F",key:"visibleChunksFailed",getter:i=>i[Or(je.FAILED,tr.VISIBLE)*ir+nr.numChunks]},{label:"Visible memory",key:"visibleGpuMemory",getter:i=>i[Or(je.GPU_MEMORY,tr.VISIBLE)*ir+nr.gpuMemoryBytes]},{label:"Download latency",key:"downloadLatency",getter:i=>i[rb(bg.totalTime)]/i[rb(bg.totalChunks)]}];class _6 extends ho{constructor(e,t,n){super(e,n.location),this.chunkQueueManager=t,this.displayState=n,this.data=void 0,this.requestDataTimerId=-1,this.dataRequested=!1,this.body=document.createElement("div"),this.debouncedUpdateView=this.registerCancellable(ze(()=>this.updateView(),0));const{body:s}=this;s.classList.add("neuroglancer-statistics-panel-body"),this.addTitleBar({title:"Chunk statistics"}),this.addBody(s),this.requestData()}disposed(){window.clearTimeout(this.requestDataTimerId),super.disposed()}requestData(){if(this.dataRequested)return;const{chunkQueueManager:e}=this;this.dataRequested=!0,e.getStatistics().then(t=>{this.dataRequested=!1,this.data=t,this.debouncedUpdateView(),this.requestDataTimerId=window.setTimeout(()=>{this.requestDataTimerId=-1,this.requestData()},O6)})}updateView(){const{data:e}=this;if(e===void 0)return;const t=document.createElement("table"),n=[];for(const[l,c]of e){const u=[l];for(const{getter:h}of Yp)u.push(h(c));n.push(u)}const s=M6(n.map(l=>N6(l[0]))),r=new Map;s.forEach((l,c)=>{r.set(n[c][0],l)});{const l=document.createElement("thead");let c=document.createElement("tr");l.appendChild(c);const u=g=>{const v=document.createElement("td");v.textContent=g,c.appendChild(v)};u("Name");let h;for(const{label:g}of Yp){const v=g.indexOf("/");let y=g;if(v!==-1){if(y=g.substring(0,v),y===h){++c.lastElementChild.colSpan;continue}h=y}u(y)}c=document.createElement("tr"),l.appendChild(c);{const g=document.createElement("td");c.appendChild(g)}for(const{label:g}of Yp){const v=g.indexOf("/");let y="";v!==-1&&(y=g.substring(v+1));const b=document.createElement("td");b.textContent=y,c.appendChild(b)}t.appendChild(l)}const o=document.createElement("tbody");for(const[l,...c]of n){const u=document.createElement("tr"),h=g=>{const v=document.createElement("td");v.textContent=g,u.appendChild(v)};h(r.get(l));for(const g of c)h(""+g);o.appendChild(u)}t.appendChild(o),Fe(this.body),this.body.appendChild(t)}}const V6={...ao,side:"left",row:2};class B6{constructor(){this.location=new wr(V6)}get changed(){return this.location.changed}toJSON(){return Oa(this.location.toJSON())}reset(){this.location.reset()}restoreState(e){this.location.restoreState(e)}}class F6 extends ho{constructor(e,t,n){super(e,t.location),this.addTitleBar({title:"Settings"});const s=document.createElement("div");s.classList.add("neuroglancer-settings-body");const r=document.createElement("div");r.classList.add("neuroglancer-settings-scroll-container"),s.appendChild(r),this.addBody(s);{const u=this.registerDisposer(new iT(n.title));u.element.placeholder="Title",u.element.classList.add("neuroglancer-settings-title"),r.appendChild(u.element)}const o=(u,h)=>{const g=this.registerDisposer(new ny(h,{label:u}));g.element.classList.add("neuroglancer-settings-limit-widget"),r.appendChild(g.element)};o("GPU memory limit",n.chunkQueueManager.capacities.gpuMemory.sizeLimit),o("System memory limit",n.chunkQueueManager.capacities.systemMemory.sizeLimit),o("Concurrent chunk requests",n.chunkQueueManager.capacities.download.itemLimit);const l=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new Es(h));g.appendChild(v.element),r.appendChild(g)};l("Show axis lines",n.showAxisLines),l("Show scale bar",n.showScaleBar),l("Show cross sections in 3-d",n.showPerspectiveSliceViews),l("Show default annotations",n.showDefaultAnnotations),l("Show chunk statistics",n.statisticsDisplayState.location.watchableVisible),l("Wire frame rendering",n.wireFrame),l("Enable prefetching",n.chunkQueueManager.enablePrefetch);const c=(u,h)=>{const g=document.createElement("label");g.textContent=u;const v=this.registerDisposer(new Nv(h));g.appendChild(v.element),r.appendChild(g)};c("Cross-section background",n.crossSectionBackgroundColor),c("Projection background",n.perspectiveViewBackgroundColor)}}class U6 extends K{constructor(e,t){super(),this.selectedLayer=e,this.toolBinder=t,this.element=document.createElement("div"),this.viewContext=void 0,this.updateView=this.registerCancellable(et(()=>{let{viewContext:s}=this;s!==void 0&&(this.unregisterDisposer(s),s.dispose()),this.viewContext=s=this.registerDisposer(new K),Fe(this.element);const{selectedTool:r}=this;r!==void 0&&this.element.appendChild(this.makeWidget(s,r));const o=Array.from(this.toolBinder.bindings);o.sort(([l],[c])=>Fc(l,c));for(const[,l]of o)this.element.appendChild(this.makeWidget(s,l))}));const{element:n}=this;n.className="neuroglancer-annotation-tool-status",this.registerDisposer(e.changed.add(()=>this.selectedLayerChanged())),this.registerDisposer(t.changed.add(this.updateView)),this.registerDisposer(this.selectedLayer.layerManager.layersChanged.add(this.updateView)),this.selectedLayerChanged()}get selectedTool(){const e=this.selectedLayer.layer;if(e===void 0)return;const t=e.layer;if(t!==null)return t.tool.value}selectedLayerChanged(){const{unbindPreviousLayer:e}=this;e!==void 0&&e();const t=this.selectedLayer.layer;t!==void 0&&(this.unbindPreviousLayer=t.specificationChanged.add(()=>{this.updateView()})),this.updateView()}disposed(){const{unbindPreviousLayer:e}=this;e!==void 0&&e(),this.unbindPreviousLayer=void 0}makeWidget(e,t){const n=document.createElement("div");n.title="dblclick → unbind",t instanceof Tu&&(n.title+=", click → bind key"),n.className="neuroglancer-annotation-tool-status-widget";const s=document.createElement("div");s.className="neuroglancer-annotation-tool-status-widget-layer-number";const r=document.createElement("div");if(r.className="neuroglancer-annotation-tool-status-widget-description",r.textContent=t.description,n.addEventListener("dblclick",()=>{t instanceof AE?t.layer.tool.value=void 0:this.toolBinder.set(t.keyBinding,void 0)}),t instanceof Tu){const l=document.createElement("div");l.className="neuroglancer-annotation-tool-status-widget-key",l.textContent=t.keyBinding,n.appendChild(l),ME(e,n,c=>t.localBinder.set(c,t.addRef()))}const o=t.context;if(o instanceof Li){const{managedLayer:l}=o;l.manager.rootLayers.updateNonArchivedLayerIndices();const c=l.nonArchivedLayerIndex;s.textContent=(c+1).toString(),n.appendChild(s)}return n.appendChild(r),n}}class z6 extends K{constructor(e,t){super(),this.gl=e,this.frameNumberCounter=t,this.worker=new Worker(new URL(""+new URL("chunk_worker.bundle-MRSH5_2P.js",import.meta.url).href,import.meta.url),{type:"module"}),this.chunkQueueManager=this.registerDisposer(new xg(new xN(this.worker),this.gl,this.frameNumberCounter,{gpuMemory:new Rd({defaultItemLimit:1e6,defaultSizeLimit:1e9}),systemMemory:new Rd({defaultItemLimit:1e7,defaultSizeLimit:2e9}),download:new Rd({defaultItemLimit:100,defaultSizeLimit:Number.POSITIVE_INFINITY}),compute:new Rd({defaultItemLimit:128,defaultSizeLimit:5e8})})),this.chunkQueueManager.registerDisposer(()=>this.worker.terminate()),this.chunkManager=this.registerDisposer(new Eg(this.chunkQueueManager))}get rpc(){return this.chunkQueueManager.rpc}}const SD=["showHelpButton","showSettingsButton","showEditStateButton","showLayerListPanelButton","showSelectionPanelButton","showLayerSidePanelButton","showLocation","showAnnotationToolStatus"],bD=[...SD,"showLayerPanel","showLayerHoverValues"],wD=[...bD,"showUIControls","showPanelBorders"];function G6(){return Object.fromEntries(wD.map(i=>[i,new ut(!0)]))}function $6(i,e){for(const t of wD){const n=e[t];n!==void 0&&(i[t].value=n)}}const W6=typeof NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS<"u"?NEUROGLANCER_OVERRIDE_DEFAULT_VIEWER_OPTIONS:{showLayerDialog:!0,resetStateWhenEmpty:!0};class H6 extends Ih{constructor(e){super(),this.viewer=e,this.add("title",e.title),this.add("dimensions",e.coordinateSpace),this.add("relativeDisplayScales",e.relativeDisplayScales),this.add("displayDimensions",e.displayDimensions),this.add("position",e.position),this.add("velocity",e.velocity),this.add("crossSectionOrientation",e.crossSectionOrientation),this.add("crossSectionScale",e.crossSectionScale),this.add("crossSectionDepth",e.crossSectionDepthRange),this.add("projectionOrientation",e.projectionOrientation),this.add("projectionScale",e.projectionScale),this.add("projectionDepth",e.projectionDepthRange),this.add("layers",e.layerSpecification),this.add("showAxisLines",e.showAxisLines),this.add("wireFrame",e.wireFrame),this.add("showScaleBar",e.showScaleBar),this.add("showDefaultAnnotations",e.showDefaultAnnotations),this.add("showSlices",e.showPerspectiveSliceViews),this.add("gpuMemoryLimit",e.dataContext.chunkQueueManager.capacities.gpuMemory.sizeLimit),this.add("prefetch",e.dataContext.chunkQueueManager.enablePrefetch),this.add("systemMemoryLimit",e.dataContext.chunkQueueManager.capacities.systemMemory.sizeLimit),this.add("concurrentDownloads",e.dataContext.chunkQueueManager.capacities.download.itemLimit),this.add("selectedLayer",e.selectedLayer),this.add("crossSectionBackgroundColor",e.crossSectionBackgroundColor),this.add("projectionBackgroundColor",e.perspectiveViewBackgroundColor),this.add("layout",e.layout),this.add("statistics",e.statisticsDisplayState),this.add("helpPanel",e.helpPanelState),this.add("settingsPanel",e.settingsPanelState),this.add("selection",e.selectionDetailsState),this.add("layerListPanel",e.layerListPanelState),this.add("partialViewport",e.partialViewport),this.add("selectedStateServer",e.selectedStateServer),this.add("toolBindings",e.toolBinder)}restoreState(e){const{viewer:t}=this;super.restoreState(e),oe(e,"navigation",n=>{ee(n),oe(n,"pose",s=>{ee(s),oe(s,"position",r=>{ee(r),ln(r,"voxelCoordinates",t.position),oe(r,"voxelSize",o=>{const l=_e(new Float64Array(3),o,wt);for(let c=0;c<3;++c)l[c]*=1e-9;t.coordinateSpace.value=Ue({valid:!1,names:["x","y","z"],units:["m","m","m"],scales:l})})}),ln(s,"orientation",t.crossSectionOrientation)}),ln(n,"zoomFactor",t.crossSectionScale.legacyJsonView)}),ln(e,"perspectiveOrientation",t.projectionOrientation),ln(e,"perspectiveZoom",t.projectionScale.legacyJsonView),ln(e,"perspectiveViewBackgroundColor",t.perspectiveViewBackgroundColor)}}class CD extends K{constructor(e,t={}){super(),this.display=e,this.title=new bt(void 0,ie),this.coordinateSpace=new nv,this.position=this.registerDisposer(new $r(this.coordinateSpace)),this.velocity=this.registerDisposer(new Ev(this.coordinateSpace)),this.relativeDisplayScales=this.registerDisposer(new CE(this.coordinateSpace)),this.displayDimensions=this.registerDisposer(new EE(this.coordinateSpace)),this.displayDimensionRenderInfo=this.registerDisposer(new xE(this.relativeDisplayScales.addRef(),this.displayDimensions.addRef())),this.crossSectionOrientation=this.registerDisposer(new ka),this.crossSectionScale=this.registerDisposer(new j2(this.displayDimensionRenderInfo.addRef())),this.projectionOrientation=this.registerDisposer(new ka),this.crossSectionDepthRange=this.registerDisposer(new Ag(-10,this.displayDimensionRenderInfo)),this.projectionDepthRange=this.registerDisposer(new Ag(-50,this.displayDimensionRenderInfo)),this.projectionScale=this.registerDisposer(new Y2(this.displayDimensionRenderInfo.addRef())),this.navigationState=this.registerDisposer(new Da(new La(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.crossSectionOrientation.addRef()),this.crossSectionScale.addRef(),this.crossSectionDepthRange.addRef())),this.perspectiveNavigationState=this.registerDisposer(new Da(new La(this.position.addRef(),this.displayDimensionRenderInfo.addRef(),this.projectionOrientation.addRef()),this.projectionScale.addRef(),this.projectionDepthRange.addRef())),this.mouseState=new SO,this.layerManager=this.registerDisposer(new VE),this.selectedLayer=this.registerDisposer(new kO(this.layerManager.addRef())),this.showAxisLines=new ut(!0,!0),this.wireFrame=new ut(!1,!1),this.showScaleBar=new ut(!0,!0),this.showPerspectiveSliceViews=new ut(!0,!0),this.visibleLayerRoles=AN(),this.showDefaultAnnotations=new ut(!0,!0),this.crossSectionBackgroundColor=new cu(Et(.5,.5,.5)),this.perspectiveViewBackgroundColor=new cu(Et(0,0,0)),this.scaleBarOptions=new hH,this.partialViewport=new dN,this.statisticsDisplayState=new I6,this.helpPanelState=new jH,this.settingsPanelState=new B6,this.layerSelectedValues=this.registerDisposer(new bO(this.layerManager,this.mouseState)),this.selectionDetailsState=this.registerDisposer(new wO(this.coordinateSpace,this.layerSelectedValues)),this.selectedStateServer=new bt("",ie),this.layerListPanelState=new y6,this.resetInitiated=new ue,this.uiControlVisibility={},this.visible=!0,this.toolInputEventMapBinder=(y,b)=>{b.registerDisposer(this.inputEventBindings.sliceView.addParent(y,Number.POSITIVE_INFINITY)),b.registerDisposer(this.inputEventBindings.perspectiveView.addParent(y,Number.POSITIVE_INFINITY))},this.globalToolBinder=this.registerDisposer(new aO(this.toolInputEventMapBinder)),this.toolBinder=this.registerDisposer(new Lv(this,this.globalToolBinder));const{dataContext:n=new z6(e.gl,e),visibility:s=new Pt(Pt.VISIBLE),inputEventBindings:r={global:new He,sliceView:new He,perspectiveView:new He},element:o=e.makeCanvasOverlayElement(),dataSourceProvider:l=G3({credentialsManager:Rs}),uiConfiguration:c=G6()}=t;this.visibility=s,this.inputEventBindings=r,this.element=o,this.dataSourceProvider=l,this.uiConfiguration=c,this.registerDisposer(ys(y=>{this.display.applyWindowedViewportToElement(o,y)},this.partialViewport)),this.registerDisposer(()=>gt(this.element)),this.dataContext=this.registerDisposer(n),$6(c,t);const u={...W6,...t},{resetStateWhenEmpty:h,showLayerDialog:g}=u;for(const y of bD)this.uiControlVisibility[y]=this.makeUiControlVisibilityState(y);this.registerDisposer(this.uiConfiguration.showPanelBorders.changed.add(()=>{this.updateShowBorders()})),this.showLayerDialog=g,this.resetStateWhenEmpty=h,this.layerSpecification=new IO(this.display,this.dataSourceProvider,this.layerManager,this.chunkManager,this.selectionDetailsState,this.selectedLayer,this.navigationState.coordinateSpace,this.navigationState.pose.position,this.globalToolBinder),this.registerDisposer(e.updateStarted.add(()=>{this.onUpdateDisplay()})),this.showDefaultAnnotations.changed.add(()=>{this.showDefaultAnnotations.value?this.visibleLayerRoles.add(fr.DEFAULT_ANNOTATION):this.visibleLayerRoles.delete(fr.DEFAULT_ANNOTATION)}),this.registerDisposer(this.navigationState.changed.add(()=>{this.handleNavigationStateChanged()}));const v=this.registerCancellable(ze(()=>{!this.wasDisposed&&this.layerManager.managedLayers.length===0&&this.resetStateWhenEmpty&&(this.navigationState.reset(),this.perspectiveNavigationState.pose.orientation.reset(),this.perspectiveNavigationState.zoomFactor.reset(),this.resetInitiated.dispatch(),!am&&this.showLayerDialog&&this.visibility.visible&&qE(this.layerSpecification,this.selectedLayer))}));this.layerManager.layersChanged.add(v),v(),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.layerSelectedValues.handleLayerChange()})),this.registerDisposer(this.dataContext.chunkQueueManager.visibleChunksChanged.add(()=>{this.visible&&e.scheduleRedraw()})),this.makeUI(),this.updateShowBorders(),this.registerActionListeners(),this.registerEventActionBindings(),this.registerDisposer(gD(o,this.navigationState.position)),this.state=new H6(this),this.registerDisposer(new Tv(this.display,this.position,this.velocity))}get chunkManager(){return this.dataContext.chunkManager}get chunkQueueManager(){return this.dataContext.chunkQueueManager}makeUiControlVisibilityState(e){const t=this.uiConfiguration.showUIControls,n=this.uiConfiguration[e];return this.registerDisposer(J0((s,r)=>s&&r,t,n))}get inputEventMap(){return this.inputEventBindings.global}updateShowBorders(){const{element:e}=this,t="neuroglancer-show-panel-borders";this.uiConfiguration.showPanelBorders.value?e.classList.add(t):e.classList.remove(t)}makeUI(){const e=this.element;e.classList.add("neuroglancer-viewer"),e.classList.add("neuroglancer-noselect"),e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.classList.add("neuroglancer-viewer-top-row"),t.style.display="flex",t.style.flexDirection="row",t.style.alignItems="stretch";const n=this.registerDisposer(new Hc(this.navigationState.position,this.layerSpecification.coordinateSpaceCombiner,{velocity:this.velocity,getToolBinder:()=>this.toolBinder}));this.registerDisposer(new Wn(this.uiControlVisibility.showLocation,n.element)),t.appendChild(n.element);const s=this.registerDisposer(new NF(document.createElement("div"),this.mouseState,this.navigationState.coordinateSpace));if(s.element.style.flex="1",s.element.style.alignSelf="center",this.registerDisposer(new Wn(this.uiControlVisibility.showLocation,s.element)),t.appendChild(s.element),typeof NEUROGLANCER_CREDIT_LINK<"u"){let l=NEUROGLANCER_CREDIT_LINK;Array.isArray(l)||(l=[l]);for(const{url:c,text:u}of l){const h=document.createElement("a");h.style.marginRight="5px",h.href=c,h.textContent=u,h.style.fontFamily="sans-serif",h.style.color="yellow",h.target="_blank",t.appendChild(h)}}const r=this.registerDisposer(new U6(this.selectedLayer,this.globalToolBinder));if(t.appendChild(r.element),this.registerDisposer(new Wn(this.uiControlVisibility.showAnnotationToolStatus,r.element)),GH){const l=this.registerDisposer(new $H(this));t.appendChild(l.element)}{const{layerListPanelState:l}=this,c=this.registerDisposer(new Kn(l.location.watchableVisible,{svg:JW,backgroundScheme:"dark",enableTitle:"Show layer list panel",disableTitle:"Hide layer list panel"}));c.element.insertAdjacentElement("afterbegin",this.registerDisposer(new x6(this.layerManager)).element),this.registerDisposer(new Wn(this.uiControlVisibility.showLayerListPanelButton,c.element)),t.appendChild(c.element)}{const{selectionDetailsState:l}=this,c=this.registerDisposer(new Kn(l.location.watchableVisible,{svg:jW,backgroundScheme:"dark",enableTitle:"Show selection details panel",disableTitle:"Hide selection details panel"}));this.registerDisposer(new Wn(this.uiControlVisibility.showSelectionPanelButton,c.element)),t.appendChild(c.element)}{const{selectedLayer:l}=this,c=this.registerDisposer(new Kn({get value(){return l.visible},set value(u){l.visible=u},changed:l.location.locationChanged},{svg:qL,backgroundScheme:"dark",enableTitle:"Show layer side panel",disableTitle:"Hide layer side panel"}));this.registerDisposer(new Wn(this.uiControlVisibility.showLayerSidePanelButton,c.element)),t.appendChild(c.element)}{const l=$e({text:"{}",title:"Edit JSON state"});this.registerEventListener(l,"click",()=>{this.editJsonState()}),this.registerDisposer(new Wn(this.uiControlVisibility.showEditStateButton,l)),t.appendChild(l)}{const{helpPanelState:l}=this,c=this.registerDisposer(new Kn(l.location.watchableVisible,{text:"?",backgroundScheme:"dark",enableTitle:"Show help panel",disableTitle:"Hide help panel"}));this.registerDisposer(new Wn(this.uiControlVisibility.showHelpButton,c.element)),t.appendChild(c.element)}{const{settingsPanelState:l}=this,c=this.registerDisposer(new Kn(l.location.watchableVisible,{svg:YW,backgroundScheme:"dark",enableTitle:"Show settings panel",disableTitle:"Hide settings panel"}));this.registerDisposer(new Wn(this.uiControlVisibility.showSettingsButton,c.element)),t.appendChild(c.element)}this.registerDisposer(new Wn(J0((...l)=>l.reduce((c,u)=>c||u,!1),...SD.map(l=>this.uiControlVisibility[l])),t)),e.appendChild(t),this.layout=this.registerDisposer(new u6(this,"4panel")),this.sidePanelManager=this.registerDisposer(new D_(this.display,this.layout.element,this.visibility)),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.layerListPanelState.location,makePanel:()=>new C6(this.sidePanelManager,this.layerSpecification,this.layerListPanelState)})),this.registerDisposer(new m6(this.sidePanelManager,this.selectedLayer.addRef())),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.selectionDetailsState.location,makePanel:()=>new P_(this.sidePanelManager,this.selectionDetailsState,this.layerSpecification,this.selectedLayer)})),e.appendChild(this.sidePanelManager.element),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.statisticsDisplayState.location,makePanel:()=>new _6(this.sidePanelManager,this.chunkQueueManager,this.statisticsDisplayState)})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.helpPanelState.location,makePanel:()=>{const{inputEventBindings:l}=this;return new YH(this.sidePanelManager,this.helpPanelState,[["Global",l.global],["Cross section view",l.sliceView],["3-D projection view",l.perspectiveView]],this.layerManager,this.globalToolBinder)}})),this.registerDisposer(this.sidePanelManager.registerPanel({location:this.settingsPanelState.location,makePanel:()=>new F6(this.sidePanelManager,this.settingsPanelState,this)}));const o=()=>{const l=this.visibility.visible;l!==this.visible&&(e.style.visibility=l?"inherit":"hidden",this.visible=l)};o(),this.registerDisposer(this.visibility.changed.add(o))}registerEventActionBindings(){const{element:e}=this;this.registerDisposer(new Pi(e,this.inputEventMap)),this.registerDisposer(new Jh(e))}bindAction(e,t){this.registerDisposer(fe(this.element,e,t))}registerActionListeners(){for(const e of["recolor","clear-segments"])this.bindAction(e,()=>{this.layerManager.invokeAction(e)});for(const e of["select","star"])this.bindAction(e,()=>{this.mouseState.updateUnconditionally(),this.layerManager.invokeAction(e)});this.bindAction("help",()=>this.toggleHelpPanel());for(let e=1;e<=9;++e)this.bindAction(`toggle-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&t.setVisible(!t.visible)}),this.bindAction(`toggle-pick-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(t.pickEnabled=!t.pickEnabled)}),this.bindAction(`select-layer-${e}`,()=>{const t=this.layerManager.getLayerByNonArchivedIndex(e-1);t!==void 0&&(this.selectedLayer.layer=t,this.selectedLayer.visible=!0)});for(let e=0;e<26;++e){const t=String.fromCharCode(65+e);this.bindAction(`tool-${t}`,()=>{this.activateTool(t)})}this.bindAction("annotate",()=>{const e=this.selectedLayer.layer;if(e===void 0){Pe.showTemporaryMessage("The annotate command requires a layer to be selected.");return}const t=e.layer;if(t===null||t.tool.value===void 0){Pe.showTemporaryMessage(`The selected layer (${JSON.stringify(e.name)}) does not have an active annotation tool.`);return}t.tool.value.trigger(this.mouseState)}),this.bindAction("toggle-axis-lines",()=>this.showAxisLines.toggle()),this.bindAction("toggle-scale-bar",()=>this.showScaleBar.toggle()),this.bindAction("toggle-default-annotations",()=>this.showDefaultAnnotations.toggle()),this.bindAction("toggle-show-slices",()=>this.showPerspectiveSliceViews.toggle()),this.bindAction("toggle-show-statistics",()=>this.showStatistics())}toggleHelpPanel(){this.helpPanelState.location.visible=!this.helpPanelState.location.visible}activateTool(e){this.globalToolBinder.activate(e)}editJsonState(){new L6(this)}showStatistics(e=void 0){e===void 0&&(e=!this.statisticsDisplayState.location.visible),this.statisticsDisplayState.location.visible=e}get gl(){return this.display.gl}onUpdateDisplay(){this.visible&&(this.dataContext.chunkQueueManager.chunkUpdateDeadline=null)}handleNavigationStateChanged(){if(this.visible){const{chunkQueueManager:e}=this.dataContext;e.chunkUpdateDeadline===null&&(e.chunkUpdateDeadline=Date.now()+10)}}isReady(){if(this.chunkQueueManager.flushPendingChunkUpdates(),!this.display.isReady())return!1;for(const e of this.layerManager.managedLayers)if(!e.isReady())return!1;return!0}}_F(CD);BF(hc);VF(Li);function J6(i={}){try{let{target:e=document.getElementById("neuroglancer-container")}=i;e===null&&(e=document.createElement("div"),e.id="neuroglancer-container",document.body.appendChild(e));const t=new uN(e);return new CD(t,i)}catch(e){throw Pe.showMessage(`Error: ${e.message}`),e}}function j6(i){return vW(),yW(),J6(i)}function Y6(i){const e=et(()=>{var s;const n=(s=i.value)==null?void 0:s.trim();n?document.title=`${n} - neuroglancer`:document.title="neuroglancer"}),t=i.changed.add(e);return e(),e.flush(),()=>{t(),e.cancel()}}function q6(i){return encodeURI(i).replace(/[!'()*;,]/g,e=>"%"+e.charCodeAt(0).toString(16).toUpperCase())}class K6 extends K{constructor(e,t,n={}){super(),this.root=e,this.credentialsManager=t,this.parseError=new Ne(void 0);const{updateDelayMilliseconds:s=200,defaultFragment:r="{}"}=n;this.registerEventListener(window,"hashchange",()=>this.updateFromUrlHash());const o=ze(()=>this.setUrlHash(),s);this.registerDisposer(e.changed.add(o)),this.registerDisposer(()=>o.cancel()),this.defaultFragment=r}setUrlHash(){const e=Ph(this.root),{generation:t}=e;if(t!==this.prevStateGeneration){this.prevStateGeneration=e.generation;const n=q6(JSON.stringify(e.value));n!==this.prevStateString&&(this.prevStateString=n,decodeURIComponent(n)==="{}"?history.replaceState(null,"","#"):history.replaceState(null,"","#!"+n))}}updateFromUrlHash(){try{let e=location.href.replace(/^[^#]+/,"");if((e===""||e==="#"||e==="#!")&&(e="#!"+this.defaultFragment),e.match(/^#!([a-z][a-z\d+-.]*):\/\//)){const t=e.substring(2),{url:n,credentialsProvider:s}=Ai(t,this.credentialsManager);Pe.forPromise(ei(s,n,{},tn).then(r=>{ee(r),this.root.reset(),this.root.restoreState(r)}),{initialMessage:`Loading state from ${t}`,errorPrefix:"Error loading state:"})}else if(e.startsWith("#!+")){e=e.slice(3),e=decodeURIComponent(e);const t=og(e);ee(t),this.root.restoreState(t),this.prevStateString=void 0}else if(e.startsWith("#!")){if(e=e.slice(2),e=decodeURIComponent(e),e===this.prevStateString)return;this.prevStateString=e,this.root.reset();const t=og(e);ee(t),this.root.restoreState(t)}else throw new Error('URL hash is expected to be of the form "#!{...}" or "#!+{...}".');this.parseError.value=void 0}catch(e){this.parseError.value=e}}}function X6(i){const e=window.viewer=j6(i);C_(e.inputEventBindings);const t=e.registerDisposer(new K6(e.state,e.dataSourceProvider.credentialsManager,{defaultFragment:typeof NEUROGLANCER_DEFAULT_STATE_FRAGMENT<"u"?NEUROGLANCER_DEFAULT_STATE_FRAGMENT:void 0}));return e.registerDisposer(t.parseError.changed.add(()=>{const{value:n}=t.parseError;n!==void 0&&(new Pe().setErrorMessage(`Error parsing state: ${n.message}`),console.log("Error parsing state",n)),t.parseError})),t.updateFromUrlHash(),e.registerDisposer(Y6(e.title)),pW(e),mW(e),e}if(typeof NEUROGLANCER_GOOGLE_TAG_MANAGER<"u"){const i="dataLayer",e=NEUROGLANCER_GOOGLE_TAG_MANAGER;window[i]=window[i]||[],window[i].push({"gtm.start":new Date().getTime(),event:"gtm.js"});const t=document.createElement("script");t.async=!0,t.src=`https://www.googletagmanager.com/gtm.js?id=${e}`,document.head.appendChild(t)}X6();
